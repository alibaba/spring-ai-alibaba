<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NL2SQL 自然语言转SQL演示</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Markdown 解析器 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 代码高亮 - 使用深色主题 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary-color: #1890ff;
            --secondary-color: #52c41a;
            --background-color: #f5f8fa;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-color: #e8e8e8;
            --code-bg: #282c34;
            --code-color: #abb2bf;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 0;
            margin: 0;
            min-height: 100vh;
        }

        .header {
            background-color: var(--card-bg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .subtitle {
            font-size: 1rem;
            color: #666;
            margin-bottom: 1.5rem;
        }

        .search-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            transition: all 0.3s;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .search-button {
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-button:hover {
            background-color: #40a9ff;
        }

        .search-button:active {
            background-color: #096dd9;
        }

        .result-container {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .result-header {
            padding: 1rem 1.5rem;
            background-color: #fafafa;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .result-content {
            padding: 1.5rem;
            min-height: 200px;
            max-height: 600px;
            overflow-y: auto;
            line-height: 1.7;
        }

        .result-section {
            margin-bottom: 1.5rem;
            animation: fadeIn 0.5s ease-in-out;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #555;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-content {
            background-color: #f9f9f9;
            border-radius: var(--radius);
            padding: 1rem;
            border: 1px solid var(--border-color);
        }

        pre {
            background-color: var(--code-bg);
            color: var(--code-color);
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        code {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        }

        .sql-keyword {
            color: #c678dd;
        }

        .sql-function {
            color: #61afef;
        }

        .sql-string {
            color: #98c379;
        }

        .sql-number {
            color: #d19a66;
        }

        .sql-operator {
            color: #56b6c2;
        }

        .sql-comment {
            color: #5c6370;
            font-style: italic;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            font-style: italic;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 20px;
            background-color: #e6f7ff;
            color: var(--primary-color);
            margin-left: 0.5rem;
        }

        .badge-success {
            background-color: #f6ffed;
            color: var(--secondary-color);
        }

        .badge-warning {
            background-color: #fffbe6;
            color: #faad14;
        }

        .badge-error {
            background-color: #fff2f0;
            color: #ff4d4f;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            color: #999;
            text-align: center;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #ccc;
        }

        .empty-text {
            font-size: 1rem;
            max-width: 400px;
        }

        .example-queries {
            margin-top: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .example-query {
            padding: 0.5rem 1rem;
            background-color: #f0f5ff;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #d6e4ff;
        }

        .example-query:hover {
            background-color: #d6e4ff;
        }

        .copy-button {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .copy-button:hover {
            color: var(--primary-color);
            background-color: rgba(0, 0, 0, 0.05);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .table th,
        .table td {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        .table th {
            background-color: #fafafa;
            font-weight: 500;
        }

        .table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* 打字机效果相关样式 */
        .typewriter-text {
            display: inline-block;
            overflow: hidden;
            border-right: 0.15em solid var(--primary-color);
            white-space: nowrap;
            margin: 0;
            letter-spacing: 0.05em;
            animation: typing 3.5s steps(40, end), blink-caret 0.75s step-end infinite;
        }

        @keyframes typing {
            from {
                width: 0
            }

            to {
                width: 100%
            }
        }

        @keyframes blink-caret {

            from,
            to {
                border-color: transparent
            }

            50% {
                border-color: var(--primary-color)
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .search-container {
                flex-direction: column;
            }

            .search-button {
                width: 100%;
                justify-content: center;
            }
        }

        /* Markdown 样式 */
        .markdown-content {
            line-height: 1.6;
            color: #333;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            line-height: 1.25;
            color: #2c3e50;
        }

        .markdown-content h1 {
            font-size: 1.8rem;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.5rem;
        }

        .markdown-content h2 {
            font-size: 1.5rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.3rem;
        }

        .markdown-content h3 {
            font-size: 1.3rem;
        }

        .markdown-content h4 {
            font-size: 1.1rem;
        }

        .markdown-content p {
            margin-bottom: 1rem;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }

        .markdown-content li {
            margin-bottom: 0.25rem;
        }

        .markdown-content blockquote {
            margin: 1rem 0;
            padding: 0.5rem 1rem;
            border-left: 4px solid var(--primary-color);
            background-color: #f8f9fa;
            font-style: italic;
        }

        .markdown-content code {
            background-color: #f1f3f4;
            border-radius: 3px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.9em;
            padding: 0.2em 0.4em;
        }

        .markdown-content pre {
            background-color: var(--code-bg);
            color: var(--code-color);
            border-radius: 6px;
            overflow-x: auto;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid #444;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .markdown-content pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .markdown-content table {
            border-collapse: collapse;
            margin: 1rem 0;
            width: 100%;
        }

        .markdown-content table th,
        .markdown-content table td {
            border: 1px solid #ddd;
            padding: 0.5rem 0.75rem;
            text-align: left;
        }

        .markdown-content table th {
            background-color: #f5f5f5;
            font-weight: 600;
        }

        .markdown-content table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .markdown-content a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .markdown-content a:hover {
            text-decoration: underline;
        }

        .markdown-content strong {
            font-weight: 600;
        }

        .markdown-content em {
            font-style: italic;
        }

        .markdown-content hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 2rem 0;
        }

        /* 解释内容的打字机效果 */
        .typing-effect {
            overflow: hidden;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .typing-cursor {
            display: inline-block;
            width: 0.5em;
            height: 1em;
            background-color: var(--primary-color);
            animation: blink 1s infinite;
            vertical-align: middle;
            margin-left: 2px;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="container">
            <div class="title">
                <i class="bi bi-database"></i> NL2SQL 自然语言转SQL演示
            </div>
            <div class="subtitle">输入自然语言问题，系统将自动转换为SQL查询语句</div>
        </div>
    </div>

    <div class="container">
        <div class="search-container">
            <input type="text" id="query" class="search-input" placeholder="例如：查询销售额前10的产品..." autofocus>
            <button id="search" class="search-button">
                <i class="bi bi-search"></i> 查询
            </button>
        </div>

        <div class="result-container">
            <div class="result-header">
                <div class="result-title">
                    <i class="bi bi-file-earmark-text"></i> 查询结果
                </div>
                <div id="status"></div>
            </div>
            <div class="result-content" id="results">
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="bi bi-chat-square-text"></i>
                    </div>
                    <div class="empty-text">
                        输入自然语言问题，查看系统如何将其转换为SQL查询语句
                    </div>
                    <div class="example-queries">
                        <div class="example-query">查询销售额最高的5个产品</div>
                        <div class="example-query">统计各部门员工数量</div>
                        <div class="example-query">查找去年订单金额超过1万的客户</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const queryInput = document.getElementById('query');
        const searchButton = document.getElementById('search');
        const resultsDiv = document.getElementById('results');
        const statusDiv = document.getElementById('status');
        const exampleQueries = document.querySelectorAll('.example-query');

        let eventSource;
        let streamState = {};
        let currentType = null; // 记录当前的type
        let typeCounters = {}; // 记录每个type出现的次数
        let sectionCounter = 0; // 全局section计数器

        // --- Helper Functions ---

        function isMarkdown(text) {
            if (!text || typeof text !== 'string') return false;
            
            // 检测常见的Markdown语法
            const markdownPatterns = [
                /^#{1,6}\s+.+/m,           // 标题 # ## ###
                /\*\*[^*]+\*\*/,           // 粗体 **text**
                /\*[^*]+\*/,               // 斜体 *text*
                /`[^`]+`/,                 // 行内代码 `code`
                /```[\s\S]*?```/,          // 代码块 ```code```
                /^\s*[-*+]\s+/m,           // 无序列表 - * +
                /^\s*\d+\.\s+/m,           // 有序列表 1. 2.
                /^\s*>\s+/m,               // 引用 >
                /\[.+\]\(.+\)/,            // 链接 [text](url)
                /^\s*\|.+\|/m,             // 表格 |col1|col2|
                /^---+$/m                  // 分隔线 ---
            ];
            
            return markdownPatterns.some(pattern => pattern.test(text));
        }

        function renderMarkdown(text) {
            if (!window.marked) {
                console.warn('Marked library not loaded, falling back to plain text');
                return text.replace(/\n/g, '<br>');
            }
            
            try {
                // 配置marked选项
                marked.setOptions({
                    breaks: true,           // 支持GFM换行
                    gfm: true,             // GitHub风格Markdown
                    tables: true,          // 支持表格
                    sanitize: false,       // 不清理HTML（根据需要调整）
                    highlight: function(code, lang) {
                        // 如果有highlight.js库，使用它来高亮代码
                        if (window.hljs && lang) {
                            try {
                                return hljs.highlight(code, { language: lang }).value;
                            } catch (e) {
                                return hljs.highlightAuto(code).value;
                            }
                        } else if (window.hljs) {
                            return hljs.highlightAuto(code).value;
                        }
                        return code;
                    }
                });
                
                const html = marked.parse(text);
                
                // 创建临时div来处理HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // 为所有代码块应用高亮（如果highlight.js可用）
                if (window.hljs) {
                    tempDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                }
                
                return `<div class="markdown-content">${tempDiv.innerHTML}</div>`;
            } catch (e) {
                console.error('Error rendering markdown:', e);
                return text.replace(/\n/g, '<br>');
            }
        }

        function highlightSQL(sql) {
            if (!sql) return '';
            return sql
                .replace(/\b(SELECT|FROM|WHERE|GROUP BY|ORDER BY|HAVING|JOIN|LEFT|RIGHT|INNER|OUTER|UNION|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP|AS|ON|AND|OR|NOT|IN|BETWEEN|LIKE|IS NULL|IS NOT NULL|ASC|DESC|DISTINCT|LIMIT)\b/gi, match => `<span class="sql-keyword">${match}</span>`)
                .replace(/\b(COUNT|SUM|AVG|MIN|MAX|COALESCE|CASE|WHEN|THEN|ELSE|END)\b/gi, match => `<span class="sql-function">${match}</span>`)
                .replace(/'([^']*)'/g, match => `<span class="sql-string">${match}</span>`)
                .replace(/\b(\d+)\b/g, match => `<span class="sql-number">${match}</span>`)
                .replace(/(\(\|\)|\+|-|\*|\/|=|<|>|<=|>=)/g, match => `<span class="sql-operator">${match}</span>`)
                .replace(/--.*$/gm, match => `<span class="sql-comment">${match}</span>`);
        }

        function convertJsonToHTMLTable(jsonString) {
            try {
                const data = JSON.parse(jsonString);
                if (!data || !data.columns || !data.data) {
                    return `<pre>${jsonString}</pre>`; // Not a valid table JSON, show raw
                }

                let html = '<table class="table"><thead><tr>';
                data.columns.forEach(header => {
                    html += `<th>${header}</th>`;
                });
                html += '</tr></thead><tbody>';

                data.data.forEach(row => {
                    html += '<tr>';
                    // Ensure we handle rows that might not have the same number of cells as headers
                    for (let i = 0; i < data.columns.length; i++) {
                         html += `<td>${row[i] || ''}</td>`;
                    }
                    html += '</tr>';
                });

                html += '</tbody></table>';
                return html;
            } catch (e) {
                // This will happen frequently with incomplete streams, so we just show the raw text.
                return `<pre>${jsonString}</pre>`;
            }
        }

        function convertMarkdownTableToHTML(markdownTable) {
            if (!markdownTable) return '';
            const lines = markdownTable.trim().split('\n');
            if (lines.length < 2 || !lines[1].includes('---')) return markdownTable;

            const headers = lines[0].split('|').map(h => h.trim()).filter(Boolean);
            let html = '<table class="table"><thead><tr>';
            headers.forEach(header => { html += `<th>${header}</th>`; });
            html += '</tr></thead><tbody>';

            for (let i = 2; i < lines.length; i++) {
                const rowCells = lines[i].split('|').map(c => c.trim()).filter(Boolean);
                if (rowCells.length > 0) {
                    html += '<tr>';
                    for (let j = 0; j < headers.length; j++) {
                        html += `<td>${rowCells[j] || ''}</td>`;
                    }
                    html += '</tr>';
                }
            }
            html += '</tbody></table>';
            return html;
        }

        function copyToClipboard(button) {
            const content = button.getAttribute('data-content');
            navigator.clipboard.writeText(content).then(() => {
                const originalIcon = button.innerHTML;
                button.innerHTML = '<i class="bi bi-check2"></i>';
                setTimeout(() => { button.innerHTML = originalIcon; }, 2000);
            });
        }

        // --- UI Initialization and Update Functions ---

        function initUI() {
            resultsDiv.innerHTML = `<div id="result-sections-container"></div>`;
            // 重置所有计数器
            currentType = null;
            typeCounters = {};
            sectionCounter = 0;
            streamState = {};
        }

        // 动态创建新的section
        function createNewSection(type, data) {
            sectionCounter++;

            // 增加type计数器
            if (!typeCounters[type]) {
                typeCounters[type] = 0;
            }
            typeCounters[type]++;

            const sectionId = `${type}-${typeCounters[type]}-section`;
            const contentId = `${type}-${typeCounters[type]}-content`;

            // 获取type的显示名称和图标
            const typeInfo = getTypeInfo(type);

            // 创建新的section HTML
            const sectionHTML = `
                <div id="${sectionId}" class="result-section">
                    <div class="section-title">
                        <i class="${typeInfo.icon}"></i> ${typeInfo.title} (${typeCounters[type]})
                        ${type === 'sql' ? `<button class="copy-button" id="copy-${sectionId}-button" style="display: none;"><i class="bi bi-clipboard"></i></button>` : ''}
                    </div>
                    <div class="section-content" id="${contentId}"></div>
                </div>
            `;

            // 添加到容器
            const container = document.getElementById('result-sections-container');
            container.insertAdjacentHTML('beforeend', sectionHTML);

            console.log(`Created new section: ${sectionId}`);

            // 立即更新内容
            updateNewSection(type, sectionId, contentId, data);

            return { sectionId, contentId };
        }

        // 获取type对应的显示信息
        function getTypeInfo(type) {
            const typeMapping = {
                'status': { title: '当前状态', icon: 'bi bi-activity' },
                'rewrite': { title: '需求理解', icon: 'bi bi-pencil-square' },
                'keyword_extract': { title: '关键词提取', icon: 'bi bi-key' },
                'plan_generation': { title: '计划生成', icon: 'bi bi-diagram-3' },
                'schema_recall': { title: 'Schema初步召回', icon: 'bi bi-database-gear' },
                'schema_deep_recall': { title: 'Schema深度召回', icon: 'bi bi-database-fill-gear' },
                'sql': { title: '生成的SQL', icon: 'bi bi-code-square' },
                'execute_sql': { title: '执行SQL', icon: 'bi bi-play-circle' },
                'python_analysis': { title: 'Python分析执行', icon: 'bi bi-code-slash' },
                'validation': { title: '校验', icon: 'bi bi-check-circle' },
                'output_report': { title: '输出报告', icon: 'bi bi-file-earmark-text' },
                'explanation': { title: '解释说明', icon: 'bi bi-info-circle' },
                'result': { title: '查询结果', icon: 'bi bi-table' }
            };

            return typeMapping[type] || { title: type, icon: 'bi bi-file-text' };
        }

        // 更新新创建的section
        function updateNewSection(type, sectionId, contentId, data) {
            const section = document.getElementById(sectionId);
            const content = document.getElementById(contentId);

            if (!section || !content) {
                console.error(`Element not found: section=${sectionId}, content=${contentId}`);
                return;
            }

            section.style.display = 'block';

            // 根据类型格式化内容
            let formattedContent;
            if (type === 'sql') {
                const copyButton = document.getElementById(`copy-${sectionId}-button`);
                if (copyButton) {
                    copyButton.style.display = 'inline-block';
                    copyButton.setAttribute('data-content', data);
                    copyButton.onclick = () => copyToClipboard(copyButton);
                }
                formattedContent = `<pre>${highlightSQL(data)}</pre>`;
            } else if (type === 'result') {
                let tableHtml = convertJsonToHTMLTable(data);
                if (tableHtml.startsWith('<pre>')) {
                    tableHtml = convertMarkdownTableToHTML(data);
                    if (tableHtml === data) {
                        tableHtml = `<pre>${data}</pre>`;
                    }
                }
                formattedContent = tableHtml;
            } else {
                // 检查数据是否包含多个JSON对象连接在一起
                let processedData = data;
                if (typeof data === 'string') {
                    // 先尝试按JSON对象分割
                    const jsonPattern = /\{"[^"]+":"[^"]*"[^}]*\}/g;
                    const jsonMatches = data.match(jsonPattern);
                    
                    if (jsonMatches && jsonMatches.length > 1) {
                        // 多个JSON对象，分别解析并提取data字段
                        let extractedContent = [];
                        jsonMatches.forEach(jsonStr => {
                            try {
                                const jsonObj = JSON.parse(jsonStr);
                                if (jsonObj.data) {
                                    extractedContent.push(jsonObj.data.replace(/\\n/g, '\n'));
                                }
                            } catch (e) {
                                extractedContent.push(jsonStr);
                            }
                        });
                        processedData = extractedContent.join('');
                    } else {
                        // 单个JSON对象或普通文本
                        try {
                            const jsonData = JSON.parse(data);
                            if (jsonData && typeof jsonData === 'object') {
                                if (jsonData.data) {
                                    processedData = jsonData.data;
                                } else {
                                    processedData = JSON.stringify(jsonData, null, 2);
                                }
                            }
                        } catch (e) {
                            // 不是JSON，保持原始数据
                            processedData = data;
                        }
                    }
                }
                
                // 检查是否是Markdown格式，如果是则渲染为HTML
                if (isMarkdown(processedData)) {
                    formattedContent = renderMarkdown(processedData);
                } else {
                    formattedContent = processedData.toString().replace(/\n/g, '<br>');
                }
            }

            content.innerHTML = formattedContent;
            console.log(`Updated section ${sectionId} with content:`, formattedContent);
        }

        // --- Main Search Logic ---

        const performSearch = () => {
            const query = queryInput.value;
            if (!query) {
                alert('请输入查询内容');
                return;
            }

            if (eventSource) {
                eventSource.close();
            }

            initUI();
            streamState = { status: '', rewrite: '', sql: '', explanation: '', result: '', keyword_extract: '', plan_generation: '' };
            statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div> 正在处理...</div>';

            eventSource = new EventSource(`/nl2sql/stream/search?query=${encodeURIComponent(query)}`);

            eventSource.onopen = () => {
                console.log('Stream connection established.');
            };

            eventSource.onmessage = (event) => {
                console.log('Received raw data:', event.data);
                statusDiv.innerHTML = ''; // Clear "正在处理..."

                let chunk;
                let actualType;
                let actualData;
                
                try {
                    console.log('Raw event.data type:', typeof event.data);
                    console.log('Raw event.data value:', event.data);
                    
                    // 尝试解析JSON
                    let parsedData = JSON.parse(event.data);
                    console.log('First parse result type:', typeof parsedData);
                    console.log('First parse result:', parsedData);
                    
                    // 如果第一次解析结果还是字符串，再解析一次
                    if (typeof parsedData === 'string') {
                        console.log('Need second parse');
                        chunk = JSON.parse(parsedData);
                        console.log('Second parse result type:', typeof chunk);
                        console.log('Second parse result:', chunk);
                    } else {
                        chunk = parsedData;
                    }
                    
                    console.log('Final chunk type:', typeof chunk);
                    console.log('Final chunk:', chunk);
                    console.log('Final chunk keys:', Object.keys(chunk || {}));

                    // 直接提取type和data，使用方括号语法
                    actualType = chunk['type'];
                    actualData = chunk['data'];
                    
                    console.log('Extracted - Type:', actualType, 'Data:', actualData);

                    // 处理嵌套JSON的情况
                    if (actualType === 'explanation' && typeof actualData === 'string') {
                        try {
                            const innerChunk = JSON.parse(actualData);
                            if (innerChunk.type && innerChunk.data !== undefined) {
                                actualType = innerChunk.type;
                                actualData = innerChunk.data;
                                console.log('After nested parsing - Type:', actualType, 'Data:', actualData);
                            }
                        } catch (e) {
                            // 如果内层解析失败，保持原来的值
                            console.log('Inner JSON parse failed, keeping original values');
                        }
                    }

                } catch (e) {
                    console.warn("JSON parse failed, treating as plain text:", event.data);
                    return;
                }

                console.log('Final values - Type:', actualType, 'Data:', actualData);

                if (actualType && actualData !== undefined && actualData !== null) {
                    // 检查是否需要创建新的section
                    if (currentType !== actualType) {
                        // type切换了，创建新的section
                        console.log(`Type changed from ${currentType} to ${actualType}, creating new section`);
                        currentType = actualType;

                        // 创建新的section
                        createNewSection(actualType, actualData);
                        
                        // 同时将第一条数据添加到streamState中
                        const currentCount = typeCounters[actualType];
                        const currentSectionKey = `${actualType}_${currentCount}`;
                        streamState[currentSectionKey] = actualData;
                        
                        console.log(`Initialized ${currentSectionKey} with:`, actualData);
                    } else {
                        // 同一个type，继续累积数据到当前section
                        const currentCount = typeCounters[actualType];
                        const currentSectionKey = `${actualType}_${currentCount}`;

                        // 累积数据
                        if (!streamState[currentSectionKey]) {
                            streamState[currentSectionKey] = '';
                        }
                        streamState[currentSectionKey] += actualData;

                        // 更新当前section的内容
                        const sectionId = `${actualType}-${currentCount}-section`;
                        const contentId = `${actualType}-${currentCount}-content`;
                        updateNewSection(actualType, sectionId, contentId, streamState[currentSectionKey]);

                        console.log(`Appended to ${currentSectionKey}:`, streamState[currentSectionKey]);
                    }

                    // 自动滚动到底部
                    resultsDiv.scrollTop = resultsDiv.scrollHeight;
                } else {
                    console.warn('Missing type or data:', {
                        type: actualType,
                        data: actualData,
                        originalChunk: chunk
                    });
                }
            };

            eventSource.onerror = (err) => {
                console.error('EventSource error:', err);
                statusDiv.innerHTML = '<span class="badge badge-error">连接错误</span>';
                eventSource.close();
            };

            eventSource.addEventListener('complete', function (e) {
                statusDiv.innerHTML = '<span class="badge badge-success">查询完成</span>';
                const typingCursor = document.getElementById('typing-cursor');
                if (typingCursor) typingCursor.style.display = 'none';
                eventSource.close();
            });
        };

        // --- Event Listeners ---

        searchButton.addEventListener('click', performSearch);
        queryInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') performSearch();
        });
        exampleQueries.forEach(example => {
            example.addEventListener('click', () => {
                queryInput.value = example.textContent;
                performSearch();
            });
        });

        // 初始化highlight.js（如果可用）
        if (window.hljs) {
            hljs.highlightAll();
        }
    </script>
</body>

</html>
