<!-- 
 * Copyright 2025 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
-->
<template>
  <div class="config-panel">
    <div class="config-header">
      <div class="header-left">
        <h2>Âü∫Á°ÄÈÖçÁΩÆ</h2>
        <div class="config-stats">
          <span class="stat-item">
            <span class="stat-label">ÊÄªÈÖçÁΩÆÈ°π:</span>
            <span class="stat-value">{{ configStats.total }}</span>
          </span>
          <span class="stat-item" v-if="configStats.modified > 0">
            <span class="stat-label">Â∑≤‰øÆÊîπ:</span>
            <span class="stat-value modified">{{ configStats.modified }}</span>
          </span>
        </div>
      </div>
      <div class="header-right">
        <div class="import-export-actions">
          <button @click="exportConfigs" class="action-btn" title="ÂØºÂá∫ÈÖçÁΩÆ">
            üì§
          </button>
          <label class="action-btn" title="ÂØºÂÖ•ÈÖçÁΩÆ">
            üì•
            <input 
              type="file" 
              accept=".json"
              @change="importConfigs"
              style="display: none;"
            />
          </label>
        </div>
        <div class="search-box">
          <input 
            v-model="searchQuery"
            type="text" 
            placeholder="ÊêúÁ¥¢ÈÖçÁΩÆÈ°π..."
            class="search-input"
          />
          <span class="search-icon">üîç</span>
        </div>
      </div>
    </div>

    <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
    <div v-if="initialLoading" class="loading-container">
      <div class="loading-spinner"></div>
      <p>Ê≠£Âú®Âä†ËΩΩÈÖçÁΩÆ...</p>
    </div>

    <!-- ÈÖçÁΩÆÁªÑ -->
    <div v-else-if="filteredConfigGroups.length > 0" class="config-groups">
      <div 
        v-for="group in filteredConfigGroups" 
        :key="group.name" 
        class="config-group"
      >
        <div class="group-header">
          <div class="group-info">
            <span class="group-icon">{{ GROUP_ICONS[group.name] || '‚öôÔ∏è' }}</span>
          </div>
          <div class="group-actions">
            <button 
              @click="resetGroupConfigs(group.name)"
              class="reset-btn"
              :disabled="loading"
              title="ÈáçÁΩÆËØ•ÁªÑÊâÄÊúâÈÖçÁΩÆ‰∏∫ÈªòËÆ§ÂÄº"
            >
              ÈáçÁΩÆ
            </button>
          </div>
          <div class="group-divider"></div>
        </div>
        
        <!-- Â≠êÁªÑ -->
        <div class="sub-groups">
          <div 
            v-for="subGroup in group.subGroups" 
            :key="subGroup.name" 
            class="sub-group"
          >
            <div 
              class="sub-group-header"
              @click="toggleSubGroup(group.name, subGroup.name)"
            >
              <div class="sub-group-info">
                <span class="sub-group-icon">üìÅ</span>
                <h4 class="sub-group-title">{{ subGroup.displayName }}</h4>
                <span class="item-count">({{ subGroup.items.length }})</span>
              </div>
              <span 
                class="collapse-icon"
                :class="{ 'collapsed': isSubGroupCollapsed(group.name, subGroup.name) }"
              >
                ‚ñº
              </span>
            </div>
            
            <div 
              class="config-items" 
              v-show="!isSubGroupCollapsed(group.name, subGroup.name)"
            >
              <div 
                v-for="item in subGroup.items" 
                :key="item.id" 
                class="config-item"
                :class="{ 
                  'modified': originalConfigValues.get(item.id) !== item.configValue 
                }"
              >
                <!-- Â∏ÉÂ∞îÁ±ªÂûãÈÖçÁΩÆÈ°π (CHECKBOX/BOOLEAN) -->
                <template v-if="item.inputType === 'BOOLEAN' || item.inputType === 'CHECKBOX'">
                  <div class="config-item-content vertical-layout">
                    <div class="config-item-info">
                      <div class="config-item-header">
                        <label class="config-label">
                          {{ item.description || item.displayName }}
                          <span class="type-badge boolean">{{ item.inputType === 'CHECKBOX' ? 'ÈÄâÊã©' : 'Â∏ÉÂ∞î' }}</span>
                          <span v-if="originalConfigValues.get(item.id) !== item.configValue" class="modified-badge">Â∑≤‰øÆÊîπ</span>
                        </label>
                        <span class="config-key" :title="item.configKey">{{ item.configKey }}</span>
                      </div>
                    </div>
                    <div class="config-control">
                      <!-- Â¶ÇÊûúÊúâÂÆö‰πâ optionsÔºåÊòæÁ§∫‰∏∫ÈÄâÊã©Ê°Ü -->
                      <template v-if="item.options && item.options.length > 0">
                        <select 
                          class="config-input select-input"
                          :value="item.configValue"
                          @change="updateConfigValue(item, ($event.target as HTMLSelectElement)?.value || '')"
                        >
                          <option 
                            v-for="option in item.options" 
                            :key="getOptionValue(option)" 
                            :value="getOptionValue(option)"
                          >
                            {{ getOptionLabel(option) }}
                          </option>
                        </select>
                      </template>
                      <!-- Âê¶ÂàôÊòæÁ§∫‰∏∫ÂºÄÂÖ≥ -->
                      <template v-else>
                        <Switch 
                          :enabled="getBooleanValue(item.configValue)"
                          label=""
                          @update:switchValue="updateConfigValue(item, $event)"
                        />
                      </template>
                    </div>
                  </div>
                </template>

                <!-- ÈÄâÊã©Á±ªÂûãÈÖçÁΩÆÈ°π -->
                <template v-else-if="item.inputType === 'SELECT'">
                  <div class="config-item-content vertical-layout">
                    <div class="config-item-info">
                      <div class="config-item-header">
                        <label class="config-label">
                          {{ item.description || item.displayName }}
                          <span class="type-badge select">ÈÄâÊã©</span>
                          <span v-if="originalConfigValues.get(item.id) !== item.configValue" class="modified-badge">Â∑≤‰øÆÊîπ</span>
                        </label>
                        <span class="config-key" :title="item.configKey">{{ item.configKey }}</span>
                      </div>
                    </div>
                    <div class="config-control">
                      <select 
                        class="config-input select-input"
                        :value="item.configValue"
                        @change="updateConfigValue(item, ($event.target as HTMLSelectElement)?.value || '')"
                      >
                        <option 
                          v-for="option in item.options || []" 
                          :key="getOptionValue(option)" 
                          :value="getOptionValue(option)"
                        >
                          {{ getOptionLabel(option) }}
                        </option>
                      </select>
                    </div>
                  </div>
                </template>

                <!-- Â§öË°åÊñáÊú¨Á±ªÂûãÈÖçÁΩÆÈ°π -->
                <template v-else-if="item.inputType === 'TEXTAREA'">
                  <div class="config-item-content vertical-layout">
                    <div class="config-item-info">
                      <div class="config-item-header">
                        <label class="config-label">
                          {{ item.description || item.displayName }}
                          <span class="type-badge textarea">Â§öË°å</span>
                          <span v-if="originalConfigValues.get(item.id) !== item.configValue" class="modified-badge">Â∑≤‰øÆÊîπ</span>
                        </label>
                        <span class="config-key" :title="item.configKey">{{ item.configKey }}</span>
                      </div>
                    </div>
                    <div class="config-control">
                      <textarea 
                        class="config-input textarea-input"
                        :value="item.configValue"
                        @input="updateConfigValue(item, ($event.target as HTMLTextAreaElement)?.value || '')"
                        @blur="debouncedSave"
                        rows="3"
                      />
                    </div>
                  </div>
                </template>

                <!-- Êï∞ÂÄºÁ±ªÂûãÈÖçÁΩÆÈ°π -->
                <template v-else-if="item.inputType === 'NUMBER'">
                  <div class="config-item-content vertical-layout">
                    <div class="config-item-info">
                      <div class="config-item-header">
                        <label class="config-label">
                          {{ item.description || item.displayName }}
                          <span class="type-badge number">Êï∞ÂÄº</span>
                          <span v-if="originalConfigValues.get(item.id) !== item.configValue" class="modified-badge">Â∑≤‰øÆÊîπ</span>
                        </label>
                        <span class="config-key" :title="item.configKey">{{ item.configKey }}</span>
                        <div class="config-meta" v-if="item.min || item.max">
                          <span class="range-info">
                            ËåÉÂõ¥: {{ item.min || 0 }} - {{ item.max || '‚àû' }}
                          </span>
                        </div>
                      </div>
                    </div>
                    <div class="config-control">
                      <input 
                        type="number" 
                        class="config-input number-input"
                        :value="getNumberValue(item.configValue)"
                        @input="updateConfigValue(item, ($event.target as HTMLInputElement)?.value || '')"
                        @blur="debouncedSave"
                        :min="item.min || 1"
                        :max="item.max || 10000"
                      />
                    </div>
                  </div>
                </template>

                <!-- Â≠óÁ¨¶‰∏≤Á±ªÂûãÈÖçÁΩÆÈ°π (STRING/TEXT) -->
                <template v-else>
                  <div class="config-item-content vertical-layout">
                    <div class="config-item-info">
                      <div class="config-item-header">
                        <label class="config-label">
                          {{ item.description || item.displayName }}
                          <span class="type-badge string">{{ item.inputType === 'TEXT' ? 'ÊñáÊú¨' : 'Â≠óÁ¨¶‰∏≤' }}</span>
                          <span v-if="originalConfigValues.get(item.id) !== item.configValue" class="modified-badge">Â∑≤‰øÆÊîπ</span>
                        </label>
                        <span class="config-key" :title="item.configKey">{{ item.configKey }}</span>
                      </div>
                    </div>
                    <div class="config-control">
                      <input 
                        type="text" 
                        class="config-input text-input"
                        :value="item.configValue"
                        @input="updateConfigValue(item, ($event.target as HTMLInputElement)?.value || '')"
                        @blur="debouncedSave"
                      />
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Á©∫Áä∂ÊÄÅ -->
    <div v-else class="empty-state">
      <p>Êú™ÊâæÂà∞ÈÖçÁΩÆÈ°π</p>
    </div>

    <!-- Ê∂àÊÅØÊèêÁ§∫ -->
    <transition name="message-fade">
      <div v-if="message.show" :class="['message-toast', message.type]">
        {{ message.text }}
      </div>
    </transition>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted, computed } from 'vue'
import Switch from '@/components/switch/index.vue'
import Flex from '@/components/flex/index.vue'
import { AdminApiService, type ConfigItem } from '@/api/admin-api-service'

// ÂÆö‰πâÊâ©Â±ïÁöÑÈÖçÁΩÆÈ°πÊé•Âè£
interface ExtendedConfigItem extends ConfigItem {
  displayName: string
  min?: number
  max?: number
}

// ÂÆö‰πâÈÖçÁΩÆÂ≠êÁªÑÊé•Âè£
interface ConfigSubGroup {
  name: string
  displayName: string
  items: ExtendedConfigItem[]
}

// ÂÆö‰πâÈÖçÁΩÆÁªÑÊé•Âè£
interface ConfigGroup {
  name: string
  displayName: string
  subGroups: ConfigSubGroup[]
}

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const initialLoading = ref(true)
const loading = ref(false)
const configGroups = ref<ConfigGroup[]>([])
const originalConfigValues = ref<Map<number, string>>(new Map())

// Â≠êÁªÑÊäòÂè†Áä∂ÊÄÅ
const collapsedSubGroups = ref<Set<string>>(new Set())

// Ê∂àÊÅØÊèêÁ§∫
const message = reactive({
  show: false,
  text: '',
  type: 'success' as 'success' | 'error'
})

// ÊêúÁ¥¢ËøáÊª§Áä∂ÊÄÅ
const searchQuery = ref('')



// ÈÖçÁΩÆÈ°πÊòæÁ§∫ÂêçÁß∞Êò†Â∞Ñ
const CONFIG_DISPLAY_NAMES: Record<string, string> = {
  // Êô∫ËÉΩ‰ΩìËÆæÁΩÆ
  'maxSteps': 'Êô∫ËÉΩ‰ΩìÊâßË°åÊúÄÂ§ßÊ≠•Êï∞',
  'resetAllAgents': 'ÈáçÁΩÆÊâÄÊúâagent',
  
  // ÊµèËßàÂô®ËÆæÁΩÆ
  'headlessBrowser': 'ÊòØÂê¶‰ΩøÁî®Êó†Â§¥ÊµèËßàÂô®Ê®°Âºè',
  'browserTimeout': 'ÊµèËßàÂô®ËØ∑Ê±ÇË∂ÖÊó∂Êó∂Èó¥(Áßí)',
  'browserDebug': 'ÊµèËßàÂô®debugÊ®°Âºè',
  
  // ‰∫§‰∫íËÆæÁΩÆ
  'autoOpenBrowser': 'ÂêØÂä®Êó∂Ëá™Âä®ÊâìÂºÄÊµèËßàÂô®',
  'consoleInteractive': 'ÂêØÁî®ÊéßÂà∂Âè∞‰∫§‰∫íÊ®°Âºè',
  
  // Á≥ªÁªüËÆæÁΩÆ
  'systemName': 'Á≥ªÁªüÂêçÁß∞',
  'language': 'ÈªòËÆ§ËØ≠Ë®Ä',
  'maxThreads': 'ÊúÄÂ§ßÁ∫øÁ®ãÊï∞',
  'timeoutSeconds': 'ËØ∑Ê±ÇË∂ÖÊó∂Êó∂Èó¥(Áßí)'
}

// ÁªÑÊòæÁ§∫ÂêçÁß∞Êò†Â∞Ñ
const GROUP_DISPLAY_NAMES: Record<string, string> = {
  'manus': 'Êô∫ËÉΩ‰ΩìËÆæÁΩÆ',
  'browser': 'ÊµèËßàÂô®ËÆæÁΩÆ', 
  'interaction': '‰∫§‰∫íËÆæÁΩÆ',
  'system': 'Á≥ªÁªüËÆæÁΩÆ',
  'performance': 'ÊÄßËÉΩËÆæÁΩÆ'
}

// ÁªÑÂõæÊ†áÊò†Â∞Ñ
const GROUP_ICONS: Record<string, string> = {
  'manus': 'ü§ñ',
  'browser': 'üåê',
  'interaction': 'üñ•Ô∏è',
  'system': '‚öôÔ∏è',
  'performance': '‚ö°'
}

// Â≠êÁªÑÊòæÁ§∫ÂêçÁß∞Êò†Â∞Ñ
const SUB_GROUP_DISPLAY_NAMES: Record<string, string> = {
  'agent': 'Êô∫ËÉΩ‰ΩìËÆæÁΩÆ',
  'browser': 'ÊµèËßàÂô®ËÆæÁΩÆ',
  'interaction': '‰∫§‰∫íËÆæÁΩÆ',
  'system': 'Á≥ªÁªüËÆæÁΩÆ',
  'performance': 'ÊÄßËÉΩËÆæÁΩÆ',
  'general': 'Â∏∏ËßÑËÆæÁΩÆ'
}

// ËÆ°ÁÆóÂ±ûÊÄßÔºöÊòØÂê¶Êúâ‰øÆÊîπ
const hasChanges = computed(() => {
  return configGroups.value.some(group => 
    group.subGroups.some(subGroup =>
      subGroup.items.some(item => 
        originalConfigValues.value.get(item.id) !== item.configValue
      )
    )
  )
})

// Â∑•ÂÖ∑ÂáΩÊï∞ÔºöËé∑ÂèñÂ∏ÉÂ∞îÂÄº
const getBooleanValue = (value: string): boolean => {
  return value === 'true'
}

// Â∑•ÂÖ∑ÂáΩÊï∞ÔºöËé∑ÂèñÊï∞ÂÄº
const getNumberValue = (value: string): number => {
  return parseFloat(value) || 0
}

// Â∑•ÂÖ∑ÂáΩÊï∞ÔºöËé∑ÂèñÈÖçÁΩÆÈ°πÁöÑÊúÄÂ∞èÂÄº
const getConfigMin = (configKey: string): number => {
  const minValues: Record<string, number> = {
    'maxSteps': 1,
    'browserTimeout': 1,
    'maxThreads': 1,
    'timeoutSeconds': 5
  }
  return minValues[configKey] || 1
}

// Â∑•ÂÖ∑ÂáΩÊï∞ÔºöËé∑ÂèñÈÖçÁΩÆÈ°πÁöÑÊúÄÂ§ßÂÄº  
const getConfigMax = (configKey: string): number => {
  const maxValues: Record<string, number> = {
    'maxSteps': 100,
    'browserTimeout': 600,
    'maxThreads': 32,
    'timeoutSeconds': 300
  }
  return maxValues[configKey] || 10000
}

// Â∑•ÂÖ∑ÂáΩÊï∞ÔºöËé∑ÂèñÈÄâÈ°πÂÄº
const getOptionValue = (option: string | { value: string; label: string }): string => {
  return typeof option === 'string' ? option : option.value
}

// Â∑•ÂÖ∑ÂáΩÊï∞ÔºöËé∑ÂèñÈÄâÈ°πÊ†áÁ≠æ
const getOptionLabel = (option: string | { value: string; label: string }): string => {
  return typeof option === 'string' ? option : option.label
}

// Â∑•ÂÖ∑ÂáΩÊï∞ÔºöÂ§ÑÁêÜÂ∏ÉÂ∞îÂÄºÊõ¥Êñ∞ÔºàÊîØÊåÅÈÄâÈ°πÊò†Â∞ÑÔºâ
const handleBooleanUpdate = (item: ExtendedConfigItem, newValue: string | boolean): string => {
  // Â¶ÇÊûúÊòØÁõ¥Êé•ÁöÑÂ∏ÉÂ∞îÂÄºÔºàÊù•Ëá™ÂºÄÂÖ≥Ôºâ
  if (typeof newValue === 'boolean') {
    return newValue.toString()
  }
  
  // Â¶ÇÊûúÊòØÂ≠óÁ¨¶‰∏≤ÔºàÊù•Ëá™ÈÄâÊã©Ê°ÜÔºâ
  if (typeof newValue === 'string') {
    // Â§ÑÁêÜÂèØËÉΩÁöÑÈÄâÈ°πÊò†Â∞ÑÔºà‰æãÂ¶Ç "ÊòØ" -> "true", "Âê¶" -> "false"Ôºâ
    if (item.options && item.options.length > 0) {
      // Êü•ÊâæÂåπÈÖçÁöÑÈÄâÈ°π
      const matchedOption = item.options.find(option => 
        (typeof option === 'string' ? option : option.label) === newValue ||
        (typeof option === 'string' ? option : option.value) === newValue
      )
      if (matchedOption) {
        return typeof matchedOption === 'string' ? matchedOption : matchedOption.value
      }
    }
    return newValue
  }
  
  // fallback Â§ÑÁêÜ
  return String(newValue)
}

// Êõ¥Êñ∞ÈÖçÁΩÆÂÄº
const updateConfigValue = (item: ExtendedConfigItem, value: any) => {
  let stringValue: string
  
  // Ê†πÊçÆËæìÂÖ•Á±ªÂûãÂ§ÑÁêÜÂÄº
  if (item.inputType === 'BOOLEAN' || item.inputType === 'CHECKBOX') {
    stringValue = handleBooleanUpdate(item, value)
  } else {
    stringValue = String(value)
  }
  
  if (item.configValue !== stringValue) {
    item.configValue = stringValue
    item._modified = true
  }
}

// Èò≤Êäñ‰øùÂ≠ò
let saveTimeout: number | null = null
const debouncedSave = () => {
  if (saveTimeout) {
    clearTimeout(saveTimeout)
  }
  saveTimeout = window.setTimeout(() => {
    saveAllConfigs()
  }, 500)
}

// ÊòæÁ§∫Ê∂àÊÅØ
const showMessage = (text: string, type: 'success' | 'error' = 'success') => {
  message.text = text
  message.type = type
  message.show = true
  
  setTimeout(() => {
    message.show = false
  }, 3000)
}

// Âä†ËΩΩÊâÄÊúâÈÖçÁΩÆÁªÑ
const loadAllConfigs = async () => {
  try {
    initialLoading.value = true
    
    // ÂÆö‰πâÂ∑≤Áü•ÁöÑÈÖçÁΩÆÁªÑÔºàÈÅøÂÖç‰æùËµñÂêéÁ´ØÁöÑ getAllGroups Êé•Âè£Ôºâ
    const knownGroups = ['manus', 'browser', 'interaction', 'system', 'performance']
    
    // Âä†ËΩΩÊØè‰∏™ÁªÑÁöÑÈÖçÁΩÆ
    const groupPromises = knownGroups.map(async (groupName: string) => {
      try {
        const items = await AdminApiService.getConfigsByGroup(groupName)
        
        // Â¶ÇÊûúËØ•ÁªÑÊ≤°ÊúâÈÖçÁΩÆÈ°πÔºåË∑≥Ëøá
        if (items.length === 0) {
          return null
        }
        
        // ‰∏∫ÊØè‰∏™ÈÖçÁΩÆÈ°πËÆæÁΩÆÊòæÁ§∫ÂêçÁß∞Ôºà‰ºòÂÖà‰ΩøÁî®descriptionÔºâ
        const processedItems: ExtendedConfigItem[] = items.map(item => ({
          ...item,
          displayName: item.description || CONFIG_DISPLAY_NAMES[item.configKey] || item.configKey,
          min: getConfigMin(item.configKey),
          max: getConfigMax(item.configKey)
        }))
        
        // ÁºìÂ≠òÂéüÂßãÂÄº
        processedItems.forEach(item => {
          originalConfigValues.value.set(item.id, item.configValue)
        })
        
        // ÊåâÂ≠êÁªÑÂàÜÁªÑ
        const subGroupsMap = new Map<string, ExtendedConfigItem[]>()
        
        processedItems.forEach(item => {
          const subGroupName = item.configSubGroup || 'general'
          if (!subGroupsMap.has(subGroupName)) {
            subGroupsMap.set(subGroupName, [])
          }
          subGroupsMap.get(subGroupName)!.push(item)
        })
        
        // ËΩ¨Êç¢‰∏∫Â≠êÁªÑÊï∞ÁªÑ
        const subGroups: ConfigSubGroup[] = Array.from(subGroupsMap.entries()).map(([name, items]) => ({
          name,
          displayName: SUB_GROUP_DISPLAY_NAMES[name] || name,
          items
        }))
        
        return {
          name: groupName,
          displayName: GROUP_DISPLAY_NAMES[groupName] || groupName,
          subGroups
        }
      } catch (error) {
        console.warn(`Âä†ËΩΩÈÖçÁΩÆÁªÑ ${groupName} Â§±Ë¥•ÔºåË∑≥Ëøá:`, error)
        return null
      }
    })
    
    const results = await Promise.all(groupPromises)
    
    // ËøáÊª§ÊéâÁ©∫ÁöÑÈÖçÁΩÆÁªÑ
    configGroups.value = results.filter(group => group !== null) as ConfigGroup[]
    
    console.log('ÈÖçÁΩÆÂä†ËΩΩÂÆåÊàê:', configGroups.value)
  } catch (error) {
    console.error('Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•:', error)
    showMessage('Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï', 'error')
  } finally {
    initialLoading.value = false
  }
}

// ‰øùÂ≠òÊâÄÊúâÈÖçÁΩÆ
const saveAllConfigs = async () => {
  if (loading.value || !hasChanges.value) return
  
  try {
    loading.value = true
    
    // Êî∂ÈõÜÊâÄÊúâ‰øÆÊîπÁöÑÈÖçÁΩÆÈ°π
    const allModifiedConfigs: ConfigItem[] = []
    
    configGroups.value.forEach(group => {
      group.subGroups.forEach(subGroup => {
        const modifiedItems = subGroup.items.filter(item => item._modified)
        allModifiedConfigs.push(...modifiedItems)
      })
    })
    
    if (allModifiedConfigs.length === 0) {
      showMessage('Ê≤°ÊúâÈúÄË¶Å‰øùÂ≠òÁöÑ‰øÆÊîπ')
      return
    }
    
    // ÊâπÈáè‰øùÂ≠ò
    const result = await AdminApiService.batchUpdateConfigs(allModifiedConfigs)
    
    if (result.success) {
      // Êõ¥Êñ∞ÂéüÂßãÂÄºÁºìÂ≠ò
      allModifiedConfigs.forEach(item => {
        originalConfigValues.value.set(item.id, item.configValue)
        item._modified = false
      })
      
      showMessage('ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäü')
    } else {
      showMessage(result.message || '‰øùÂ≠òÂ§±Ë¥•', 'error')
    }
  } catch (error) {
    console.error('‰øùÂ≠òÈÖçÁΩÆÂ§±Ë¥•:', error)
    showMessage('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error')
  } finally {
    loading.value = false
  }
}

// ÈáçÁΩÆÁªÑÈÖçÁΩÆ
const resetGroupConfigs = async (groupName: string) => {
  const confirmed = confirm(`Á°ÆÂÆöË¶ÅÈáçÁΩÆ "${GROUP_DISPLAY_NAMES[groupName] || groupName}" ÁªÑÁöÑÊâÄÊúâÈÖçÁΩÆÂêóÔºü`)
  if (!confirmed) return
  
  try {
    loading.value = true
    
    // ÊâæÂà∞ÁõÆÊ†áÁªÑ
    const targetGroup = configGroups.value.find(g => g.name === groupName)
    if (!targetGroup) return
    
    // Êî∂ÈõÜËØ•ÁªÑÁöÑÊâÄÊúâÈÖçÁΩÆÈ°π
    const groupConfigs: ConfigItem[] = []
    targetGroup.subGroups.forEach(subGroup => {
      subGroup.items.forEach(item => {
        // ËøôÈáåÂ∫îËØ•Ë∞ÉÁî®APIËé∑ÂèñÈªòËÆ§ÂÄºÔºåÁé∞Âú®ÂÖàÁÆÄÂçïÂ§ÑÁêÜ
        const defaultValue = getDefaultValueForKey(item.configKey)
        if (defaultValue !== item.configValue) {
          groupConfigs.push({
            ...item,
            configValue: defaultValue
          })
        }
      })
    })
    
    if (groupConfigs.length === 0) {
      showMessage('ËØ•ÁªÑÈÖçÁΩÆÂ∑≤ÊòØÈªòËÆ§ÂÄº')
      return
    }
    
    // ÊâπÈáèÊõ¥Êñ∞
    const result = await AdminApiService.batchUpdateConfigs(groupConfigs)
    
    if (result.success) {
      // ÈáçÊñ∞Âä†ËΩΩÈÖçÁΩÆ
      await loadAllConfigs()
      showMessage(`ÊàêÂäüÈáçÁΩÆ ${groupConfigs.length} È°πÈÖçÁΩÆ`)
    } else {
      showMessage(result.message || 'ÈáçÁΩÆÂ§±Ë¥•', 'error')
    }
  } catch (error) {
    console.error('ÈáçÁΩÆÁªÑÈÖçÁΩÆÂ§±Ë¥•:', error)
    showMessage('ÈáçÁΩÆÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error')
  } finally {
    loading.value = false
  }
}

// Ëé∑ÂèñÈÖçÁΩÆÈ°πÁöÑÈªòËÆ§ÂÄº
const getDefaultValueForKey = (configKey: string): string => {
  // ËøôÈáåÂ∫îËØ•Êúâ‰∏Ä‰∏™ÈªòËÆ§ÂÄºÊò†Â∞ÑË°®ÔºåÁé∞Âú®ÂÖàËøîÂõûÂü∫Êú¨ÈªòËÆ§ÂÄº
  const defaults: Record<string, string> = {
    'systemName': 'JTaskPilot',
    'language': 'zh-CN',
    'maxThreads': '8',
    'timeoutSeconds': '60',
    'autoOpenBrowser': 'false',
    'headlessBrowser': 'true',
    // ÂèØ‰ª•Ê†πÊçÆÈúÄË¶ÅÊ∑ªÂä†Êõ¥Â§öÈªòËÆ§ÂÄº
  }
  
  return defaults[configKey] || ''
}

// Â≠êÁªÑÊäòÂè†ÂàáÊç¢
const toggleSubGroup = (groupName: string, subGroupName: string) => {
  const key = `${groupName}-${subGroupName}`
  if (collapsedSubGroups.value.has(key)) {
    collapsedSubGroups.value.delete(key)
  } else {
    collapsedSubGroups.value.add(key)
  }
}

// Ê£ÄÊü•Â≠êÁªÑÊòØÂê¶ÊäòÂè†
const isSubGroupCollapsed = (groupName: string, subGroupName: string): boolean => {
  return collapsedSubGroups.value.has(`${groupName}-${subGroupName}`)
}

// ËÆ°ÁÆóÈÖçÁΩÆÁªüËÆ°
const configStats = computed(() => {
  const total = configGroups.value.reduce((sum, group) => 
    sum + group.subGroups.reduce((subSum, subGroup) => 
      subSum + subGroup.items.length, 0), 0)
  
  const modified = configGroups.value.reduce((sum, group) => 
    sum + group.subGroups.reduce((subSum, subGroup) => 
      subSum + subGroup.items.filter(item => 
        originalConfigValues.value.get(item.id) !== item.configValue).length, 0), 0)
  
  return { total, modified }
})

// ËøáÊª§ÈÖçÁΩÆÁªÑ
const filteredConfigGroups = computed(() => {
  if (!searchQuery.value.trim()) {
    return configGroups.value
  }
  
  const query = searchQuery.value.toLowerCase()
  
  return configGroups.value.map(group => ({
    ...group,
    subGroups: group.subGroups.map(subGroup => ({
      ...subGroup,
      items: subGroup.items.filter(item => 
        item.displayName.toLowerCase().includes(query) ||
        item.configKey.toLowerCase().includes(query) ||
        (item.description && item.description.toLowerCase().includes(query))
      )
    })).filter(subGroup => subGroup.items.length > 0)
  })).filter(group => group.subGroups.length > 0)
})



// ÂØºÂá∫ÈÖçÁΩÆ
const exportConfigs = () => {
  try {
    const exportData = {
      timestamp: new Date().toISOString(),
      version: '1.0',
      configs: configGroups.value.reduce((acc, group) => {
        group.subGroups.forEach(subGroup => {
          subGroup.items.forEach(item => {
            acc[item.configKey] = item.configValue
          })
        })
        return acc
      }, {} as Record<string, string>)
    }
    
    const dataStr = JSON.stringify(exportData, null, 2)
    const dataBlob = new Blob([dataStr], { type: 'application/json' })
    
    const link = document.createElement('a')
    link.href = URL.createObjectURL(dataBlob)
    link.download = `config-export-${new Date().toISOString().split('T')[0]}.json`
    link.click()
    
    showMessage('ÈÖçÁΩÆÂØºÂá∫ÊàêÂäü')
  } catch (error) {
    console.error('ÂØºÂá∫ÈÖçÁΩÆÂ§±Ë¥•:', error)
    showMessage('ÂØºÂá∫Â§±Ë¥•', 'error')
  }
}

// ÂØºÂÖ•ÈÖçÁΩÆ
const importConfigs = (event: Event) => {
  const input = event.target as HTMLInputElement
  const file = input.files?.[0]
  
  if (!file) return
  
  const reader = new FileReader()
  reader.onload = async (e) => {
    try {
      const importData = JSON.parse(e.target?.result as string)
      
      if (!importData.configs) {
        throw new Error('Êó†ÊïàÁöÑÈÖçÁΩÆÊñá‰ª∂Ê†ºÂºè')
      }
      
      const confirmed = confirm(`Á°ÆÂÆöË¶ÅÂØºÂÖ•ÈÖçÁΩÆÂêóÔºüËøôÂ∞ÜË¶ÜÁõñÂΩìÂâçÈÖçÁΩÆ„ÄÇ`)
      if (!confirmed) return
      
      loading.value = true
      
      // ÂáÜÂ§áË¶ÅÊõ¥Êñ∞ÁöÑÈÖçÁΩÆÈ°π
      const configsToUpdate: ConfigItem[] = []
      
      configGroups.value.forEach(group => {
        group.subGroups.forEach(subGroup => {
          subGroup.items.forEach(item => {
            if (importData.configs.hasOwnProperty(item.configKey)) {
              configsToUpdate.push({
                ...item,
                configValue: importData.configs[item.configKey]
              })
            }
          })
        })
      })
      
      if (configsToUpdate.length === 0) {
        showMessage('Ê≤°ÊúâÊâæÂà∞ÂèØÂØºÂÖ•ÁöÑÈÖçÁΩÆÈ°π')
        return
      }
      
      // ÊâπÈáèÊõ¥Êñ∞
      const result = await AdminApiService.batchUpdateConfigs(configsToUpdate)
      
      if (result.success) {
        await loadAllConfigs()
        showMessage(`ÊàêÂäüÂØºÂÖ• ${configsToUpdate.length} È°πÈÖçÁΩÆ`)
      } else {
        showMessage(result.message || 'ÂØºÂÖ•Â§±Ë¥•', 'error')
      }
    } catch (error) {
      console.error('ÂØºÂÖ•ÈÖçÁΩÆÂ§±Ë¥•:', error)
      showMessage('ÂØºÂÖ•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂Ê†ºÂºè', 'error')
    } finally {
      loading.value = false
      // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
      input.value = ''
    }
  }
  
  reader.readAsText(file)
}

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂Âä†ËΩΩÈÖçÁΩÆ
onMounted(() => {
  loadAllConfigs()
})
</script>

<style scoped>
.config-panel {
  position: relative;
}

.config-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.config-header h2 {
  margin: 0;
  font-size: 20px;
  font-weight: 500;
}

.config-actions {
  display: flex;
  gap: 12px;
}

.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  color: rgba(255, 255, 255, 0.7);
}

.loading-spinner {
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top: 2px solid #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 16px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.config-groups {
  display: flex;
  flex-direction: column;
  gap: 32px;
}

.config-group {
  background: rgba(255, 255, 255, 0.03);
  border-radius: 12px;
  padding: 24px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
}

.config-group:hover {
  background: rgba(255, 255, 255, 0.05);
  border-color: rgba(255, 255, 255, 0.15);
}

.group-header {
  display: flex;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.group-icon {
  font-size: 20px;
  margin-right: 12px;
  opacity: 0.8;
}

.group-divider {
  flex: 1;
  height: 1px;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
  margin-left: 16px;
}

.config-items {
  display: flex;
  flex-direction: column;
  gap: 20px;
  padding: 16px;
}

.config-item {
  position: relative;
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 8px;
  margin-bottom: 16px;
  transition: all 0.3s ease;
}

.config-item:hover {
  border-color: rgba(255, 255, 255, 0.15);
  background: rgba(255, 255, 255, 0.02);
}

.config-item.modified {
  border-left: 3px solid #f9a825;
}

.config-item-content {
  padding: 14px 16px;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 16px;
}

/* ÂûÇÁõ¥Â∏ÉÂ±ÄÊ†∑Âºè */
.config-item-content.vertical-layout {
  flex-direction: column;
  align-items: stretch;
  gap: 12px;
}

.config-item-content.vertical-layout .config-item-info {
  width: 100%;
}

.config-item-content.vertical-layout .config-control {
  width: 100%;
  min-width: auto;
}

.config-item-header {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.config-item-info {
  flex: 1;
  min-width: 0;
}

.config-label {
  font-weight: 500;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
}

/* ÂûÇÁõ¥Â∏ÉÂ±Ä‰∏≠ÁöÑÊ†áÁ≠æÊ†∑Âºè */
.vertical-layout .config-label {
  margin-bottom: 0;
  font-size: 14px;
  line-height: 1.4;
}

.config-key {
  display: block;
  font-size: 12px;
  color: rgba(255, 255, 255, 0.5);
  margin-bottom: 6px;
  font-family: monospace;
  background: rgba(255, 255, 255, 0.05);
  padding: 2px 6px;
  border-radius: 4px;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* ÂûÇÁõ¥Â∏ÉÂ±Ä‰∏≠ÁöÑÈÖçÁΩÆÈîÆÊ†∑Âºè */
.vertical-layout .config-key {
  margin-bottom: 0;
  display: inline-block;
  max-width: fit-content;
}

.config-description {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.7);
  margin: 6px 0;
  line-height: 1.4;
}

.type-badge {
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 3px;
  color: rgba(255, 255, 255, 0.9);
  font-weight: normal;
}

.type-badge.boolean {
  background: rgba(33, 150, 243, 0.2);
  color: #90caf9;
}

.type-badge.number {
  background: rgba(76, 175, 80, 0.2);
  color: #a5d6a7;
}

.type-badge.string {
  background: rgba(156, 39, 176, 0.2);
  color: #ce93d8;
}

.type-badge.select {
  background: rgba(255, 152, 0, 0.2);
  color: #ffcc80;
}

.modified-badge {
  background: rgba(249, 168, 37, 0.2);
  color: #ffcc80;
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 3px;
  font-weight: normal;
}

.range-info {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
  background: rgba(255, 255, 255, 0.05);
  padding: 3px 8px;
  border-radius: 4px;
  display: inline-block;
  margin-top: 6px;
  font-family: monospace;
}

.config-control {
  min-width: 160px;
}

/* ÂûÇÁõ¥Â∏ÉÂ±Ä‰∏≠ÁöÑËæìÂÖ•Êéß‰ª∂Ê†∑ÂºèË∞ÉÊï¥ */
.vertical-layout .config-control {
  min-width: auto;
  max-width: 400px; /* ÈôêÂà∂ÊúÄÂ§ßÂÆΩÂ∫¶ÔºåÈÅøÂÖçËæìÂÖ•Ê°ÜËøáÂÆΩ */
}

/* ËæìÂÖ•Ê°ÜÊ†∑ÂºèÂ¢ûÂº∫ */
.config-input {
  width: 100%;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  padding: 8px 12px;
  color: rgba(255, 255, 255, 0.9);
  transition: all 0.3s;
}

.config-input:focus {
  outline: none;
  border-color: rgba(102, 126, 234, 0.5);
  background: rgba(255, 255, 255, 0.08);
}

.config-input::placeholder {
  color: rgba(255, 255, 255, 0.4);
}

.config-input.number-input {
  font-family: monospace;
  text-align: right;
}

.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  color: rgba(255, 255, 255, 0.5);
}

.message-toast {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 12px 20px;
  border-radius: 8px;
  color: white;
  font-weight: 500;
  z-index: 1000;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  transform: translateX(100%);
  animation: slide-in 0.3s ease-out forwards;
}

.message-toast.success {
  background: #10b981;
}

.message-toast.error {
  background: #ef4444;
}

.message-fade-enter-active,
.message-fade-leave-active {
  transition: all 0.3s ease;
}

.message-fade-enter-from {
  transform: translateX(100%);
  opacity: 0;
}

.message-fade-leave-to {
  transform: translateX(100%);
  opacity: 0;
}

@keyframes slide-in {
  from {
    transform: translateX(100%);
  }
  to {
    transform: translateX(0);
  }
}

/* Â≠êÁªÑÊ†∑Âºè */
.sub-group {
  margin-bottom: 24px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  overflow: hidden;
  background: rgba(255, 255, 255, 0.02);
}

.sub-group-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: rgba(255, 255, 255, 0.05);
  cursor: pointer;
  user-select: none;
  transition: all 0.3s ease;
}

.sub-group-header:hover {
  background: rgba(255, 255, 255, 0.08);
}

.sub-group-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

.sub-group-icon {
  font-size: 14px;
}

.sub-group-title {
  margin: 0;
  font-size: 14px;
  font-weight: 500;
  color: rgba(255, 255, 255, 0.9);
}

.item-count {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
  background: rgba(255, 255, 255, 0.1);
  padding: 2px 6px;
  border-radius: 10px;
}

.collapse-icon {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
  transition: transform 0.3s ease;
}

.collapse-icon.collapsed {
  transform: rotate(-90deg);
}

.config-stats {
  margin-top: 24px;
  color: rgba(255, 255, 255, 0.6);
}

/* Â§¥ÈÉ®Ê†∑ÂºèÂ¢ûÂº∫ */
.header-left,
.header-right {
  display: flex;
  align-items: center;
}

.config-stats {
  display: flex;
  margin-left: 16px;
  gap: 12px;
}

.stat-item {
  display: flex;
  align-items: center;
  background: rgba(255, 255, 255, 0.05);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
}

.stat-label {
  color: rgba(255, 255, 255, 0.6);
  margin-right: 4px;
}

.stat-value {
  color: rgba(255, 255, 255, 0.9);
  font-weight: 500;
}

.stat-value.modified {
  color: #f9a825;
}

.search-box {
  position: relative;
  margin-right: 16px;
}

.search-input {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  padding: 6px 12px 6px 32px;
  color: rgba(255, 255, 255, 0.9);
  width: 220px;
  font-size: 14px;
  transition: all 0.3s;
}

.search-input:focus {
  outline: none;
  border-color: rgba(102, 126, 234, 0.5);
  background: rgba(255, 255, 255, 0.08);
  width: 260px;
}

.search-input::placeholder {
  color: rgba(255, 255, 255, 0.4);
}

.search-icon {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 14px;
  opacity: 0.6;
}

.toggle-btn {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 4px;
  color: rgba(255, 255, 255, 0.7);
  padding: 6px 12px;
  margin-right: 12px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s;
}

.toggle-btn:hover {
  background: rgba(255, 255, 255, 0.15);
  color: rgba(255, 255, 255, 0.9);
}

.toggle-btn.active {
  background: rgba(102, 126, 234, 0.2);
  border-color: rgba(102, 126, 234, 0.5);
  color: #667eea;
}

/* ÁªÑÊìç‰ΩúÊ†∑Âºè */
.group-info {
  display: flex;
  align-items: center;
}

.group-actions {
  display: flex;
  gap: 8px;
  margin-left: auto;
  margin-right: 16px;
}

.reset-btn {
  background: rgba(244, 67, 54, 0.1);
  border: 1px solid rgba(244, 67, 54, 0.3);
  border-radius: 4px;
  color: #ef5350;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s;
}

.reset-btn:hover:not(:disabled) {
  background: rgba(244, 67, 54, 0.2);
  border-color: rgba(244, 67, 54, 0.5);
}

.reset-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ÂØºÂÖ•/ÂØºÂá∫Âä®‰ΩúÊ†∑Âºè */
.import-export-actions {
  display: flex;
  gap: 8px;
  margin-right: 16px;
}

.action-btn {
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 4px;
  color: rgba(255, 255, 255, 0.8);
  padding: 6px 10px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.action-btn:hover {
  background: rgba(255, 255, 255, 0.12);
  color: rgba(255, 255, 255, 0.95);
  border-color: rgba(255, 255, 255, 0.25);
}
</style>
