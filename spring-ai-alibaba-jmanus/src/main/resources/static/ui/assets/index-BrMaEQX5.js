var bt=Object.defineProperty;var yt=(A,o,t)=>o in A?bt(A,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):A[o]=t;var fe=(A,o,t)=>yt(A,typeof o!="symbol"?o+"":o,t);import{d as Ie,u as Me,c as ke,r as C,A as He,B as Ce,o as De,a as h,b as c,F as ge,g as f,f as N,p as Re,h as le,i as n,t as s,z as _e,e,n as ie,w as ce,m as pe,C as mt,q as Se,l as me,y as Ve,j as he,T as Be,D as je,E as Ae,G as $t,H as vt,I as _t,x as gt,J as kt}from"./index-BAePm6u3.js";import{I as $,_ as xe}from"./_plugin-vue_export-helper-CpPPc995.js";import{s as E,P as We,u as ft}from"./sidebar-DPVIarL7.js";import{M as St,u as wt,a as Ct}from"./useMessage--3bfoyAq.js";import{L as Pt}from"./llm-check-BVkAKrj3.js";import{L as Tt}from"./index-CGyn0fAQ.js";class Pe{static async getCoordinatorToolConfig(){try{const o=await fetch(`${this.BASE_URL}/config`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!o.ok)throw new Error(`Failed to get coordinator tool config: ${o.status}`);return await o.json()}catch(o){return console.error("获取CoordinatorTool配置失败:",o),{enabled:!0,success:!1,message:o.message}}}static async getAllEndpoints(){try{const o=await fetch(`${this.BASE_URL}/endpoints`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!o.ok)throw new Error(`Failed to get endpoints: ${o.status}`);return await o.json()}catch(o){throw console.error("获取endpoints失败:",o),new Error("获取endpoints失败: "+o.message)}}static async getOrNewCoordinatorToolsByTemplate(o){console.log("[CoordinatorToolApiService] 开始获取或创建协调器工具，planTemplateId:",o),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/get-or-new-by-template/${o}`);try{const t=await fetch(`${this.BASE_URL}/get-or-new-by-template/${o}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(console.log("[CoordinatorToolApiService] 响应状态:",t.status),console.log("[CoordinatorToolApiService] 响应状态文本:",t.statusText),!t.ok){const m=await t.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",m),new Error(`Failed to get coordinator tools: ${t.status} - ${m}`)}const l=await t.json();return console.log("[CoordinatorToolApiService] 获取协调器工具成功，结果:",l),l}catch(t){throw console.error("[CoordinatorToolApiService] 获取协调器工具失败:",t),new Error("获取协调器工具失败: "+t.message)}}static async createCoordinatorTool(o){console.log("[CoordinatorToolApiService] 开始创建协调器工具"),console.log("[CoordinatorToolApiService] 原始数据:",JSON.stringify(o,null,2)),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}`);const t={id:o.id,toolName:o.toolName,toolDescription:o.toolDescription,inputSchema:o.inputSchema,mcpSchema:o.mcpSchema,planTemplateId:o.planTemplateId,endpoint:o.endpoint,publishStatus:o.publishStatus};console.log("[CoordinatorToolApiService] 清理后的发送数据:",JSON.stringify(t,null,2));try{const l=await fetch(`${this.BASE_URL}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(console.log("[CoordinatorToolApiService] 响应状态:",l.status),console.log("[CoordinatorToolApiService] 响应状态文本:",l.statusText),!l.ok){const _=await l.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",_),new Error(`Failed to create coordinator tool: ${l.status} - ${_}`)}const m=await l.json();return console.log("[CoordinatorToolApiService] 创建成功，结果:",m),m}catch(l){throw console.error("[CoordinatorToolApiService] 创建协调器工具失败:",l),new Error("创建协调器工具失败: "+l.message)}}static async updateCoordinatorTool(o,t){console.log("[CoordinatorToolApiService] 开始更新协调器工具，ID:",o),console.log("[CoordinatorToolApiService] 发送的数据:",t),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/${o}`);const l={id:t.id,toolName:t.toolName,toolDescription:t.toolDescription,inputSchema:t.inputSchema,mcpSchema:t.mcpSchema,planTemplateId:t.planTemplateId,endpoint:t.endpoint,publishStatus:t.publishStatus};console.log("[CoordinatorToolApiService] 清理后的发送数据:",l);try{const m=await fetch(`${this.BASE_URL}/${o}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(console.log("[CoordinatorToolApiService] 响应状态:",m.status),console.log("[CoordinatorToolApiService] 响应状态文本:",m.statusText),!m.ok){const u=await m.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",u),new Error(`Failed to update coordinator tool: ${m.status} - ${u}`)}const _=await m.json();return console.log("[CoordinatorToolApiService] 更新成功，结果:",_),_}catch(m){throw console.error("[CoordinatorToolApiService] 更新协调器工具失败:",m),new Error("更新协调器工具失败: "+m.message)}}static async publishCoordinatorTool(o){console.log("[CoordinatorToolApiService] 开始发布协调器工具，ID:",o),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/${o}/publish`);try{const t=await fetch(`${this.BASE_URL}/${o}/publish`,{method:"POST",headers:{"Content-Type":"application/json"}});if(console.log("[CoordinatorToolApiService] 响应状态:",t.status),console.log("[CoordinatorToolApiService] 响应状态文本:",t.statusText),!t.ok){const m=await t.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",m),new Error(`Failed to publish coordinator tool: ${t.status} - ${m}`)}const l=await t.json();return console.log("[CoordinatorToolApiService] 发布成功，结果:",l),l}catch(t){throw console.error("[CoordinatorToolApiService] 发布协调器工具失败:",t),new Error("发布协调器工具失败: "+t.message)}}static async deleteCoordinatorTool(o){console.log("[CoordinatorToolApiService] 开始删除协调器工具，ID:",o),console.log("[CoordinatorToolApiService] 请求URL:",`${this.BASE_URL}/${o}`);try{const t=await fetch(`${this.BASE_URL}/${o}`,{method:"DELETE",headers:{"Content-Type":"application/json"}});if(console.log("[CoordinatorToolApiService] 响应状态:",t.status),console.log("[CoordinatorToolApiService] 响应状态文本:",t.statusText),!t.ok){const m=await t.text();throw console.error("[CoordinatorToolApiService] 响应错误内容:",m),new Error(`Failed to delete coordinator tool: ${t.status} - ${m}`)}const l=await t.json();return console.log("[CoordinatorToolApiService] 删除成功，结果:",l),l}catch(t){throw console.error("[CoordinatorToolApiService] 删除协调器工具失败:",t),new Error("删除协调器工具失败: "+t.message)}}}fe(Pe,"BASE_URL","/api/coordinator-tools");const Et={class:"modal-form"},It={class:"form-section"},xt={class:"form-item endpoint-item"},Dt={class:"endpoint-container"},Rt={class:"endpoint-row"},Mt={class:"custom-select"},At={class:"select-input-container"},Ut={class:"input-content"},Nt=["placeholder"],Ft={class:"dropdown-header"},Lt={class:"select-options"},qt=["onClick"],Bt={class:"option-name"},Vt={class:"manual-input-section"},jt={class:"manual-input-container"},Ot=["placeholder"],Wt={key:0,class:"form-item url-item"},zt={class:"url-container"},Ht=["title"],Jt={class:"url-text"},Gt={class:"form-section"},Kt={class:"form-item"},Xt=["placeholder"],Qt={class:"form-section"},Yt={class:"form-item"},Zt=["placeholder"],eo={class:"form-section"},to={class:"section-title"},oo={class:"parameter-table"},no=["onUpdate:modelValue","placeholder"],so=["onUpdate:modelValue","placeholder"],ao={class:"button-container"},lo=["disabled"],io=["disabled"],ro={key:1,class:"publish-toggle-container"},co=Ie({__name:"index",props:{modelValue:{type:Boolean,default:!1},planTemplateId:{default:""},planTitle:{default:""},planDescription:{default:""}},emits:["update:modelValue","published"],setup(A,{emit:o}){const{t}=Me(),l=A,m=o,_=ke({get:()=>l.modelValue,set:a=>m("update:modelValue",a)}),u=C(""),x=C(""),V=C(!1),w=C(!1),F=C(!1),G=C([]),O=C(""),g=C(""),M=C(!1),Q=C("bottom"),Z=C(""),b=C(null),U=C(!1),d=C(!1),I=C(null),D=ke(()=>({})),T=He({serviceName:"",userRequest:"",endpoint:"",parameters:[]}),L=ke(()=>{const a=b.value&&b.value.id;return t(a?"mcpService.updateService":"mcpService.createService")}),R=()=>{T.serviceName="",T.userRequest=l.planDescription||"",T.endpoint="",T.parameters=[],b.value=null,O.value="",g.value="",U.value=!1,d.value=!1},z=async()=>{try{G.value=await Pe.getAllEndpoints()}catch(a){console.error("加载endpoints失败:",a),k(t("mcpService.loadEndpointsFailed")+": "+a.message,"error")}},j=()=>{M.value||se(),M.value=!M.value},se=()=>{const a=document.querySelector(".custom-select");if(!a)return;const p=a.getBoundingClientRect(),S=window.innerHeight;p.bottom+200>S?Q.value="top":Q.value="bottom"},be=a=>{T.endpoint=a,M.value=!1,Z.value=""},P=()=>{if(Z.value.trim()){const a=Z.value.trim().replace(/[^a-zA-Z0-9_/]/g,"");a&&(T.endpoint=a,G.value.includes(a)||G.value.push(a),M.value=!1,Z.value="")}},B=()=>{setTimeout(()=>{Z.value.trim()&&P()},200)},ee=()=>{G.value.includes(T.endpoint)&&be(T.endpoint)},Y=()=>{G.value.includes(T.endpoint)&&be(T.endpoint)},q=()=>{G.value.includes(T.endpoint)&&be(T.endpoint)},K=async()=>{if(g.value)try{await navigator.clipboard.writeText(g.value),k(t("common.copy")+" "+t("common.success"),"success")}catch(a){console.error("复制失败:",a),k(t("common.copy")+" "+t("common.error"),"error")}},k=(a,p)=>{p==="success"?(x.value=a,setTimeout(()=>{x.value=""},3e3)):p==="error"&&(u.value=a,setTimeout(()=>{u.value=""},5e3))},v=()=>T.serviceName.trim()?T.userRequest.trim()?T.endpoint.trim()?!0:(k(t("mcpService.endpointRequiredError"),"error"),!1):(k(t("mcpService.toolDescriptionRequiredError"),"error"),!1):(k(t("mcpService.toolNameRequiredError"),"error"),!1),y=async()=>{if(console.log("[PublishModal] 开始处理保存请求"),console.log("[PublishModal] 表单数据:",T),console.log("[PublishModal] 当前工具:",b.value),!v()){console.log("[PublishModal] 表单验证失败");return}w.value=!0;try{if(!b.value){console.log("[PublishModal] 没有当前工具数据，先获取或创建");const S=await Pe.getOrNewCoordinatorToolsByTemplate(l.planTemplateId);if(!S.success)throw new Error(S.message);Array.isArray(S.data)?b.value=S.data[0]:b.value=S.data}console.log("[PublishModal] 更新工具信息"),b.value.toolName=T.serviceName.trim(),b.value.toolDescription=T.userRequest.trim(),b.value.endpoint=T.endpoint.trim(),b.value.planTemplateId=l.planTemplateId;const a=T.parameters.filter(S=>S.name.trim()&&S.description.trim()).map(S=>({name:S.name.trim(),description:S.description.trim(),type:"string"}));b.value.inputSchema=JSON.stringify(a),console.log("[PublishModal] 更新后的工具信息:",b.value);let p;b.value.id?(console.log("[PublishModal] 更新现有工具，ID:",b.value.id),p=await Pe.updateCoordinatorTool(b.value.id,b.value)):(console.log("[PublishModal] 创建新工具"),p=await Pe.createCoordinatorTool(b.value),b.value=p),console.log("[PublishModal] 保存成功:",p),k(t("mcpService.saveSuccess"),"success"),U.value=!0}catch(a){console.error("[PublishModal] 保存MCP服务失败:",a),k(t("mcpService.saveFailed")+": "+a.message,"error")}finally{w.value=!1}},X=async()=>{if(console.log("[PublishModal] 开始处理发布请求"),console.log("[PublishModal] 表单数据:",T),console.log("[PublishModal] 当前工具:",b.value),!v()){console.log("[PublishModal] 表单验证失败");return}V.value=!0;try{if(!b.value){console.log("[PublishModal] 没有当前工具数据，先获取或创建");const S=await Pe.getOrNewCoordinatorToolsByTemplate(l.planTemplateId);if(!S.success)throw new Error(S.message);Array.isArray(S.data)?b.value=S.data[0]:b.value=S.data}console.log("[PublishModal] 更新工具信息"),b.value.toolName=T.serviceName.trim(),b.value.toolDescription=T.userRequest.trim(),b.value.endpoint=T.endpoint.trim(),b.value.planTemplateId=l.planTemplateId;const a=T.parameters.filter(S=>S.name.trim()&&S.description.trim()).map(S=>({name:S.name.trim(),description:S.description.trim(),type:"string"}));if(b.value.inputSchema=JSON.stringify(a),console.log("[PublishModal] 更新后的工具信息:",b.value),b.value.id)console.log("[PublishModal] 更新现有工具，ID:",b.value.id),await Pe.updateCoordinatorTool(b.value.id,b.value);else{console.log("[PublishModal] 创建新工具");const S=await Pe.createCoordinatorTool(b.value);b.value=S}console.log("[PublishModal] 步骤5: 发布工具，ID:",b.value.id);const p=await Pe.publishCoordinatorTool(b.value.id);if(console.log("[PublishModal] 发布结果:",p),p.success){if(console.log("[PublishModal] 发布成功"),O.value=p.publishStatus||"PUBLISHED",p.endpointUrl)g.value=p.endpointUrl;else if(b.value.endpoint){const S=window.location.origin;g.value=`${S}/mcp${b.value.endpoint}`}else g.value="";console.log("[PublishModal] 设置状态 - publishStatus:",O.value,"endpointUrl:",g.value),k(t("mcpService.publishSuccess"),"success"),m("published",b.value)}else throw new Error(p.message)}catch(a){console.error("[PublishModal] 发布MCP服务失败:",a),k(t("mcpService.publishFailed")+": "+a.message,"error")}finally{V.value=!1}},ue=async()=>{if(!V.value){V.value=!0;try{d.value?(console.log("[PublishModal] 取消发布MCP服务"),b.value&&(b.value.publishStatus="UNPUBLISHED",await Pe.updateCoordinatorTool(b.value.id,b.value),d.value=!1,g.value="",k(t("mcpService.unpublishSuccess"),"success"))):(console.log("[PublishModal] 发布MCP服务"),await X(),d.value=!0)}catch(a){console.error("[PublishModal] 发布开关操作失败:",a),k(t("mcpService.unpublishFailed")+": "+a.message,"error")}finally{V.value=!1}}},ye=async()=>{if(!F.value&&confirm(t("mcpService.deleteConfirmMessage"))){if(!b.value||!b.value.id){k(t("mcpService.deleteFailed")+": "+t("mcpService.selectPlanTemplateFirst"),"error");return}F.value=!0;try{console.log("[PublishModal] 开始删除MCP服务，ID:",b.value.id);const a=await Pe.deleteCoordinatorTool(b.value.id);if(a.success)console.log("[PublishModal] 删除成功"),k(t("mcpService.deleteSuccess"),"success"),_.value=!1,m("published",null);else throw new Error(a.message)}catch(a){console.error("[PublishModal] 删除MCP服务失败:",a),k(t("mcpService.deleteFailed")+": "+a.message,"error")}finally{F.value=!1}}},$e=async()=>{_.value&&(console.log("[PublishModal] 模态框打开，开始初始化数据"),R(),await z(),await r(),i())},r=async()=>{if(!l.planTemplateId){console.log("[PublishModal] "+t("mcpService.noPlanTemplateId"));return}try{console.log("[PublishModal] 开始加载协调器工具数据，planTemplateId:",l.planTemplateId);const a=await Pe.getOrNewCoordinatorToolsByTemplate(l.planTemplateId);if(console.log("[PublishModal] 获取协调器工具数据结果:",a),a.success&&a.data){let p;if(Array.isArray(a.data)?(p=a.data[0],console.log("[PublishModal] 使用已存在的工具:",p)):(p=a.data,console.log("[PublishModal] 使用新创建的工具:",p)),b.value=p,O.value=p.publishStatus||"",d.value=p.publishStatus==="PUBLISHED",U.value=!!p.id,p.publishStatus==="PUBLISHED")if(a.endpointUrl)g.value=a.endpointUrl;else if(p.endpoint){const S=window.location.origin;g.value=`${S}/mcp${p.endpoint}`}else g.value="";else g.value="";console.log("[PublishModal] 加载工具数据 - publishStatus:",O.value,"endpointUrl:",g.value),T.serviceName=p.toolName||"",T.userRequest=p.toolDescription||l.planDescription||"",T.endpoint=p.endpoint||"";try{if(p.inputSchema){const S=JSON.parse(p.inputSchema);Array.isArray(S)&&(T.parameters=S.map(W=>({name:W.name||"",description:W.description||""})))}}catch(S){console.warn("[PublishModal] "+t("mcpService.parseInputSchemaFailed")+":",S),T.parameters=[]}console.log("[PublishModal] 表单数据已填充:",T)}else console.log("[PublishModal] 获取协调器工具数据失败:",a.message)}catch(a){console.error("[PublishModal] "+t("mcpService.loadToolDataFailed")+":",a)}};Ce(()=>l.modelValue,$e);const i=()=>{_e(()=>{if(!I.value)return;const a=I.value,p=a.parentElement;if(!p)return;const S=p.getBoundingClientRect(),W=p.querySelector(".toggle-thumb"),re=W?W.getBoundingClientRect():null,oe=re?re.width:32,te=S.width-oe-4,H=a.scrollWidth;if(H<=te){const ne=(te-H)/2;d.value?(a.style.position="absolute",a.style.left=`${8+ne}px`,a.style.right="auto",a.style.transform="none"):(a.style.position="absolute",a.style.right=`${8+ne}px`,a.style.left="auto",a.style.transform="none")}else d.value?(a.style.position="absolute",a.style.left="8px",a.style.right="50px",a.style.transform="none"):(a.style.position="absolute",a.style.left="50px",a.style.right="8px",a.style.transform="none")})};return Ce(()=>d.value,i),Ce(()=>t("mcpService.published"),i),Ce(()=>t("mcpService.unpublished"),i),De(async()=>{_.value&&(console.log("[PublishModal] 组件挂载时初始化"),R(),await z(),await r(),i())}),(a,p)=>(c(),h(ge,null,[f(St,{modelValue:_.value,"onUpdate:modelValue":p[7]||(p[7]=S=>_.value=S),title:L.value,"endpoint-url":g.value,onConfirm:X,class:"wide-modal"},{footer:Re(()=>{var S,W;return[e("div",ao,[U.value&&((S=b.value)!=null&&S.id)?(c(),h("button",{key:0,class:"action-btn danger",onClick:ye,disabled:F.value},[F.value?(c(),me(n($),{key:0,icon:"carbon:loading",class:"loading-icon"})):(c(),me(n($),{key:1,icon:"carbon:trash-can"})),le(" "+s(F.value?n(t)("mcpService.deleting"):n(t)("mcpService.delete")),1)],8,lo)):N("",!0),e("button",{class:"action-btn primary",onClick:y,disabled:w.value},[w.value?(c(),me(n($),{key:0,icon:"carbon:loading",class:"loading-icon"})):(c(),me(n($),{key:1,icon:"carbon:save"})),le(" "+s(w.value?n(t)("mcpService.saving"):n(t)("mcpService.save")),1)],8,io),U.value&&((W=b.value)!=null&&W.id)?(c(),h("div",ro,[e("div",{class:"publish-toggle",onClick:ue},[e("div",{class:ie(["toggle-track",{"toggle-on":d.value,"toggle-off":!d.value}])},[e("div",{class:ie(["toggle-thumb",{"thumb-on":d.value,"thumb-off":!d.value}])},null,2),e("span",{ref_key:"toggleLabelRef",ref:I,class:ie(["toggle-label",{"label-on":d.value,"label-off":!d.value}]),style:Ve(D.value)},s(d.value?n(t)("mcpService.published"):n(t)("mcpService.unpublished")),7)],2)])])):N("",!0)])]}),default:Re(()=>[e("div",Et,[e("div",It,[e("div",{class:ie(["endpoint-url-row",{"single-item":!d.value}])},[e("div",xt,[e("label",null,s(n(t)("mcpService.endpointRequired")),1),e("div",Dt,[e("div",Rt,[e("div",Mt,[e("div",At,[e("div",Ut,[f(n($),{icon:"carbon:application",width:"16",class:"input-icon"}),ce(e("input",{type:"text","onUpdate:modelValue":p[0]||(p[0]=S=>T.endpoint=S),placeholder:n(t)("mcpService.endpointPlaceholder"),class:"select-input",onFocus:p[1]||(p[1]=S=>M.value=!0),onInput:ee,onKeydown:mt(Y,["enter"]),onBlur:q},null,40,Nt),[[pe,T.endpoint]])]),e("button",{class:"select-arrow-btn",onClick:j,title:"展开选项"},[f(n($),{icon:M.value?"carbon:chevron-up":"carbon:chevron-down",width:"14",class:"chevron"},null,8,["icon"])])]),M.value?(c(),h("div",{key:0,class:ie(["select-dropdown",{"dropdown-top":Q.value==="top"}])},[e("div",Ft,[e("span",null,s(n(t)("mcpService.selectEndpoint")),1),e("button",{class:"close-btn",onClick:p[2]||(p[2]=S=>M.value=!1)},[f(n($),{icon:"carbon:close",width:"12"})])]),e("div",Lt,[(c(!0),h(ge,null,Se(G.value,S=>(c(),h("button",{key:S,class:ie(["select-option",{active:T.endpoint===S}]),onClick:W=>be(S)},[e("span",Bt,s(S),1),T.endpoint===S?(c(),me(n($),{key:0,icon:"carbon:checkmark",width:"14",class:"check-icon"})):N("",!0)],10,qt))),128))]),e("div",Vt,[e("div",jt,[ce(e("input",{type:"text","onUpdate:modelValue":p[3]||(p[3]=S=>Z.value=S),placeholder:n(t)("mcpService.manualInput"),class:"manual-input",onKeydown:mt(P,["enter"]),onBlur:B},null,40,Ot),[[pe,Z.value]]),e("button",{class:"add-manual-btn",onClick:P},[f(n($),{icon:"carbon:add",width:"14"})])])])],2)):N("",!0),M.value?(c(),h("div",{key:1,class:"backdrop",onClick:p[4]||(p[4]=S=>M.value=!1)})):N("",!0)])])])]),d.value?(c(),h("div",Wt,[e("label",null,s(n(t)("mcpService.mcpStreamableUrl")),1),e("div",zt,[e("div",{class:"url-display",onDblclick:K,title:n(t)("mcpService.copyUrl")+": "+g.value},[e("span",Jt,s(g.value||n(t)("mcpService.mcpStreamableUrlPlaceholder")),1),f(n($),{icon:"carbon:copy",width:"16",class:"copy-icon"})],40,Ht)])])):N("",!0)],2)]),e("div",Gt,[e("div",Kt,[e("label",null,s(n(t)("mcpService.toolNameRequired")),1),ce(e("input",{type:"text","onUpdate:modelValue":p[5]||(p[5]=S=>T.serviceName=S),placeholder:n(t)("mcpService.toolNamePlaceholder"),required:"",readonly:"",class:"readonly-input"},null,8,Xt),[[pe,T.serviceName]])])]),e("div",Qt,[e("div",Yt,[e("label",null,s(n(t)("mcpService.toolDescriptionRequired")),1),ce(e("textarea",{"onUpdate:modelValue":p[6]||(p[6]=S=>T.userRequest=S),placeholder:n(t)("mcpService.toolDescriptionPlaceholder"),class:"description-field",rows:"3",required:""},null,8,Zt),[[pe,T.userRequest]])])]),e("div",eo,[e("div",to,s(n(t)("mcpService.parameterConfig")),1),e("div",oo,[e("table",null,[e("thead",null,[e("tr",null,[e("th",null,s(n(t)("mcpService.parameterName")),1),e("th",null,s(n(t)("mcpService.parameterDescription")),1)])]),e("tbody",null,[(c(!0),h(ge,null,Se(T.parameters,(S,W)=>(c(),h("tr",{key:W},[e("td",null,[ce(e("input",{type:"text","onUpdate:modelValue":re=>S.name=re,placeholder:n(t)("mcpService.parameterName"),class:"parameter-input"},null,8,no),[[pe,S.name]])]),e("td",null,[ce(e("input",{type:"text","onUpdate:modelValue":re=>S.description=re,placeholder:n(t)("mcpService.parameterDescription"),class:"parameter-input"},null,8,so),[[pe,S.description]])])]))),128))])])])])])]),_:1},8,["modelValue","title","endpoint-url"]),u.value?(c(),h("div",{key:0,class:"error-toast",onClick:p[8]||(p[8]=S=>u.value="")},[f(n($),{icon:"carbon:error"}),le(" "+s(u.value),1)])):N("",!0),x.value?(c(),h("div",{key:1,class:"success-toast",onClick:p[9]||(p[9]=S=>x.value="")},[f(n($),{icon:"carbon:checkmark"}),le(" "+s(x.value),1)])):N("",!0)],64))}}),uo=xe(co,[["__scopeId","data-v-d94c5d19"]]),po={class:"sidebar-content"},ho={class:"sidebar-content-header"},mo={class:"sidebar-content-title"},vo={class:"tab-switcher"},go=["disabled"],fo={key:0,class:"tab-content"},bo={class:"new-task-section"},yo={class:"sidebar-content-list"},$o={key:0,class:"loading-state"},_o={key:1,class:"error-state"},ko={key:2,class:"empty-state"},So=["onClick"],wo={class:"task-icon"},Co={class:"task-details"},Po={class:"task-title"},To={class:"task-preview"},Eo={class:"task-time"},Io={class:"task-actions"},xo=["title","onClick"],Do={key:1,class:"tab-content config-tab"},Ro={key:0,class:"config-container"},Mo={class:"template-info-header"},Ao={class:"template-info"},Uo={class:"template-id"},No={class:"config-section"},Fo={class:"section-header"},Lo={class:"generator-content"},qo=["placeholder"],Bo={class:"generator-actions"},Vo=["disabled"],jo=["disabled"],Oo={class:"config-section"},Wo={class:"section-header"},zo={class:"section-actions"},Ho=["disabled","title"],Jo=["disabled","title"],Go=["disabled"],Ko=["placeholder"],Xo={class:"config-section"},Qo={class:"section-header"},Yo={class:"execution-content"},Zo={class:"params-input-group"},en={class:"params-help-text"},tn={class:"params-input-container"},on=["placeholder"],nn=["title"],sn={class:"api-url-display"},an={class:"api-url-label"},ln={class:"api-url"},rn={class:"api-url-display"},cn={class:"api-url-label"},dn=["disabled"],un=["disabled"],pn=Ie({__name:"index",emits:["planExecutionRequested"],setup(A,{expose:o,emit:t}){const{t:l}=Me(),m=["currentPlanId","userRequest","rootPlanId"],_=C({enabled:!0,success:!0}),u=ke(()=>_.value.enabled),x=async()=>{try{const d=await Pe.getCoordinatorToolConfig();_.value=d}catch(d){console.error("加载CoordinatorTool配置失败:",d),_.value={enabled:!0,success:!1,message:d instanceof Error?d.message:"Unknown error"}}},V=ke({get(){try{if(!E.jsonContent)return"";const I={...JSON.parse(E.jsonContent)};return m.forEach(D=>{delete I[D]}),JSON.stringify(I,null,2)}catch{return E.jsonContent}},set(d){try{if(!d.trim()){E.jsonContent="";return}const I=JSON.parse(d);let D={};try{D=JSON.parse(E.jsonContent||"{}")}catch{}const T={...I};m.forEach(L=>{D[L]!==void 0&&(T[L]=D[L])}),E.jsonContent=JSON.stringify(T)}catch{E.jsonContent=d}}}),w=t,F=async()=>{try{const d=await E.saveTemplate();d!=null&&d.duplicate?alert(l("sidebar.saveCompleted",{message:d.message,versionCount:d.versionCount})):d!=null&&d.saved?alert(l("sidebar.saveSuccess",{message:d.message,versionCount:d.versionCount})):d!=null&&d.message&&alert(l("sidebar.saveStatus",{message:d.message}))}catch(d){console.error("Failed to save plan modifications:",d),alert(d.message||l("sidebar.saveFailed"))}},G=async()=>{var d;try{await E.generatePlan(),alert(l("sidebar.generateSuccess",{templateId:((d=E.selectedTemplate)==null?void 0:d.id)??l("sidebar.unknown")}))}catch(I){console.error("Failed to generate plan:",I),alert(l("sidebar.generateFailed")+": "+I.message)}},O=async()=>{try{await E.updatePlan(),alert(l("sidebar.updateSuccess"))}catch(d){console.error("Failed to update plan:",d),alert(l("sidebar.updateFailed")+": "+d.message)}},g=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const d=E.preparePlanExecution();if(!d){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] Triggering plan execution request:",d),console.log("[Sidebar] Emitting planExecutionRequested event"),w("planExecutionRequested",d),console.log("[Sidebar] Event emitted")}catch(d){console.error("Error executing plan:",d),alert(l("sidebar.executeFailed")+": "+d.message)}finally{E.finishPlanExecution()}},M=C(!1),Q=()=>{if(console.log("[Sidebar] 发布MCP服务按钮被点击"),console.log("[Sidebar] currentPlanTemplateId:",E.currentPlanTemplateId),!E.currentPlanTemplateId){console.log("[Sidebar] 没有选择计划模板，显示警告"),alert(l("mcpService.selectPlanTemplateFirst"));return}console.log("[Sidebar] 打开发布MCP服务模态框"),M.value=!0},Z=d=>{d===null?console.log("MCP服务删除成功"):console.log("MCP服务发布成功:",d)},b=d=>{if(isNaN(d.getTime()))return console.warn("Invalid date received:",d),l("time.unknown");const D=new Date().getTime()-d.getTime(),T=Math.floor(D/6e4),L=Math.floor(D/36e5),R=Math.floor(D/864e5);return T<1?l("time.now"):T<60?l("time.minuteAgo",{count:T}):L<24?l("time.hourAgo",{count:L}):R<30?l("time.dayAgo",{count:R}):d.toLocaleDateString("zh-CN")},U=(d,I)=>!d||d.length<=I?d:d.substring(0,I)+"...";return De(()=>{E.loadPlanTemplateList(),x()}),o({loadPlanTemplateList:E.loadPlanTemplateList,toggleSidebar:E.toggleSidebar,currentPlanTemplateId:E.currentPlanTemplateId}),(d,I)=>{var D,T;return c(),h(ge,null,[e("div",{class:ie(["sidebar-wrapper",{"sidebar-wrapper-collapsed":n(E).isCollapsed}])},[e("div",po,[e("div",ho,[e("div",mo,s(d.$t("sidebar.title")),1)]),e("div",vo,[e("button",{class:ie(["tab-button",{active:n(E).currentTab==="list"}]),onClick:I[0]||(I[0]=L=>n(E).switchToTab("list"))},[f(n($),{icon:"carbon:list",width:"16"}),le(" "+s(d.$t("sidebar.templateList")),1)],2),e("button",{class:ie(["tab-button",{active:n(E).currentTab==="config"}]),onClick:I[1]||(I[1]=L=>n(E).switchToTab("config")),disabled:!n(E).selectedTemplate},[f(n($),{icon:"carbon:settings",width:"16"}),le(" "+s(d.$t("sidebar.configuration")),1)],10,go)]),n(E).currentTab==="list"?(c(),h("div",fo,[e("div",bo,[e("button",{class:"new-task-btn",onClick:I[2]||(I[2]=L=>n(E).createNewTemplate())},[f(n($),{icon:"carbon:add",width:"16"}),le(" "+s(d.$t("sidebar.newPlan"))+" ",1),I[12]||(I[12]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",yo,[n(E).isLoading?(c(),h("div",$o,[f(n($),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,s(d.$t("sidebar.loading")),1)])):n(E).errorMessage?(c(),h("div",_o,[f(n($),{icon:"carbon:warning",width:"20"}),e("span",null,s(n(E).errorMessage),1),e("button",{onClick:I[3]||(I[3]=(...L)=>n(E).loadPlanTemplateList&&n(E).loadPlanTemplateList(...L)),class:"retry-btn"},s(d.$t("sidebar.retry")),1)])):n(E).planTemplateList.length===0?(c(),h("div",ko,[f(n($),{icon:"carbon:document",width:"32"}),e("span",null,s(d.$t("sidebar.noTemplates")),1)])):(c(!0),h(ge,{key:3},Se(n(E).sortedTemplates,L=>(c(),h("div",{key:L.id,class:ie(["sidebar-content-list-item",{"sidebar-content-list-item-active":L.id===n(E).currentPlanTemplateId}]),onClick:R=>n(E).selectTemplate(L)},[e("div",wo,[f(n($),{icon:"carbon:document",width:"20"})]),e("div",Co,[e("div",Po,s(L.title||d.$t("sidebar.unnamedPlan")),1),e("div",To,s(U(L.description||d.$t("sidebar.noDescription"),40)),1)]),e("div",Eo,s(b(n(E).parseDateTime(L.updateTime||L.createTime))),1),e("div",Io,[e("button",{class:"delete-task-btn",title:d.$t("sidebar.deleteTemplate"),onClick:he(R=>n(E).deleteTemplate(L),["stop"])},[f(n($),{icon:"carbon:close",width:"16"})],8,xo)])],10,So))),128))])])):n(E).currentTab==="config"?(c(),h("div",Do,[n(E).selectedTemplate?(c(),h("div",Ro,[e("div",Mo,[e("div",Ao,[e("h3",null,s(n(E).selectedTemplate.title||d.$t("sidebar.unnamedPlan")),1),e("span",Uo,"ID: "+s(n(E).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:I[4]||(I[4]=L=>n(E).switchToTab("list"))},[f(n($),{icon:"carbon:arrow-left",width:"16"})])]),e("div",No,[e("div",Fo,[f(n($),{icon:"carbon:generate",width:"16"}),e("span",null,s(d.$t("sidebar.planGenerator")),1)]),e("div",Lo,[ce(e("textarea",{"onUpdate:modelValue":I[5]||(I[5]=L=>n(E).generatorPrompt=L),class:"prompt-input",placeholder:d.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,qo),[[pe,n(E).generatorPrompt]]),e("div",Bo,[e("button",{class:"btn btn-primary btn-sm",onClick:G,disabled:n(E).isGenerating||!n(E).generatorPrompt.trim()},[f(n($),{icon:n(E).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:ie({spinning:n(E).isGenerating})},null,8,["icon","class"]),le(" "+s(n(E).isGenerating?d.$t("sidebar.generating"):d.$t("sidebar.generatePlan")),1)],8,Vo),e("button",{class:"btn btn-secondary btn-sm",onClick:O,disabled:n(E).isGenerating||!n(E).generatorPrompt.trim()||!n(E).jsonContent.trim()},[f(n($),{icon:"carbon:edit",width:"14"}),le(" "+s(d.$t("sidebar.updatePlan")),1)],8,jo)])])]),e("div",Oo,[e("div",Wo,[f(n($),{icon:"carbon:code",width:"16"}),e("span",null,s(d.$t("sidebar.jsonTemplate")),1),e("div",zo,[e("button",{class:"btn btn-sm",onClick:I[6]||(I[6]=(...L)=>n(E).rollbackVersion&&n(E).rollbackVersion(...L)),disabled:!n(E).canRollback,title:d.$t("sidebar.rollback")},[f(n($),{icon:"carbon:undo",width:"14"})],8,Ho),e("button",{class:"btn btn-sm",onClick:I[7]||(I[7]=(...L)=>n(E).restoreVersion&&n(E).restoreVersion(...L)),disabled:!n(E).canRestore,title:d.$t("sidebar.restore")},[f(n($),{icon:"carbon:redo",width:"14"})],8,Jo),e("button",{class:"btn btn-primary btn-sm",onClick:F,disabled:n(E).isGenerating||n(E).isExecuting},[f(n($),{icon:"carbon:save",width:"14"})],8,Go)])]),ce(e("textarea",{"onUpdate:modelValue":I[8]||(I[8]=L=>V.value=L),class:"json-editor",placeholder:d.$t("sidebar.jsonPlaceholder"),rows:"12"},null,8,Ko),[[pe,V.value]])]),e("div",Xo,[e("div",Qo,[f(n($),{icon:"carbon:play",width:"16"}),e("span",null,s(d.$t("sidebar.executionController")),1)]),e("div",Yo,[e("div",Zo,[e("label",null,s(d.$t("sidebar.executionParams")),1),e("div",en,s(d.$t("sidebar.executionParamsHelp")),1),e("div",tn,[ce(e("input",{"onUpdate:modelValue":I[9]||(I[9]=L=>n(E).executionParams=L),class:"params-input",placeholder:d.$t("sidebar.executionParamsPlaceholder")},null,8,on),[[pe,n(E).executionParams]]),e("button",{class:"clear-params-btn",onClick:I[10]||(I[10]=(...L)=>n(E).clearExecutionParams&&n(E).clearExecutionParams(...L)),title:d.$t("sidebar.clearParams")},[f(n($),{icon:"carbon:close",width:"12"})],8,nn)])]),e("div",sn,[e("span",an,s(d.$t("sidebar.apiUrl"))+":",1),e("code",ln,s(n(E).computedApiUrl),1)]),e("div",rn,[e("span",cn,s(d.$t("sidebar.statusApiUrl"))+":",1),I[13]||(I[13]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:g,disabled:n(E).isExecuting||n(E).isGenerating},[f(n($),{icon:n(E).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:ie({spinning:n(E).isExecuting})},null,8,["icon","class"]),le(" "+s(n(E).isExecuting?d.$t("sidebar.executing"):d.$t("sidebar.executePlan")),1)],8,dn),u.value?(c(),h("button",{key:0,class:"btn publish-mcp-btn",onClick:Q,disabled:!n(E).currentPlanTemplateId},[f(n($),{icon:"carbon:application",width:"16"}),le(" "+s(n(l)("sidebar.publishMcpService")),1)],8,un)):N("",!0)])])])):N("",!0)])):N("",!0)])],2),f(uo,{modelValue:M.value,"onUpdate:modelValue":I[11]||(I[11]=L=>M.value=L),"plan-template-id":n(E).currentPlanTemplateId||"","plan-title":((D=n(E).selectedTemplate)==null?void 0:D.title)||"","plan-description":((T=n(E).selectedTemplate)==null?void 0:T.description)||"",onPublished:Z},null,8,["modelValue","plan-template-id","plan-title","plan-description"])],64)}}}),hn=xe(pn,[["__scopeId","data-v-f0b3ab7a"]]);class Oe{static async handleResponse(o){if(!o.ok)try{const t=await o.json();throw new Error(t.message||`API request failed: ${o.status}`)}catch{throw new Error(`API request failed: ${o.status} ${o.statusText}`)}return o}static async getMemories(){try{const o=await fetch(`${this.BASE_URL}`);return await(await this.handleResponse(o)).json()}catch(o){throw console.error("Failed to get memory list:",o),o}}static async getMemory(o){try{const t=await fetch(`${this.BASE_URL}/single?memoryId=${o}`);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get memory :",t),t}}static async update(o,t){try{const l=await fetch(`${this.BASE_URL}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({memoryId:o,memoryName:t})});return await(await this.handleResponse(l)).json()}catch(l){throw console.error("Failed to update memory:",l),l}}static async delete(o){try{const t=await fetch(`${this.BASE_URL}/delete?memoryId=${o}`);await this.handleResponse(t)}catch(t){throw console.error("Failed to update memory:",t),t}}}fe(Oe,"BASE_URL","/api/memories");class mn{constructor(){fe(this,"isCollapsed",!1);fe(this,"selectMemoryId","");fe(this,"loadMessages",()=>{});fe(this,"intervalId")}toggleSidebar(){this.isCollapsed=!this.isCollapsed,this.isCollapsed?(this.loadMessages(),this.intervalId=window.setInterval(()=>{this.loadMessages()},3e3)):clearInterval(this.intervalId)}selectMemory(o){this.toggleSidebar(),this.selectMemoryId=o}setMemory(o){this.selectMemoryId=o}defaultMemoryId(){this.selectMemoryId=this.generateRandomId()}clearMemoryId(){this.selectMemoryId=""}generateRandomId(){return Math.random().toString(36).substring(2,10)}setLoadMessages(o){this.loadMessages=o}}const Ee=He(new mn),vn={key:0,class:"app-container"},gn={class:"app-content"},fn={class:"header"},bn={class:"relative"},yn={class:"title-edit-group"},$n={id:"main-title",class:"main-title"},_n={key:0,id:"title-edit-container",class:"title-edit-container"},kn={class:"search-bar"},Sn={class:"search-container"},wn=["placeholder"],Cn={class:"message-list",id:"message-list"},Pn={class:"message-header"},Tn={class:"message-content"},En={class:"sender-info"},In=["onClick"],xn={class:"sender-name"},Dn=["onClick"],Rn={class:"action-buttons"},Mn=["onClick"],An={class:"action-buttons"},Un=["onClick"],Nn={class:"message-preview"},Fn={class:"preview-line"},Ln={key:0,class:"preview-line",style:{opacity:"0.8"}},qn={class:"message-meta"},Bn={class:"message-id"},Vn={class:"meta-right"},jn={key:0,class:"unread-count"},On={class:"message-time"},Wn=["id"],zn={style:{display:"flex","flex-direction":"column",gap:"0.75rem"}},Hn={class:"bubble-avatar"},Jn={class:"bubble-content"},Gn={class:"bubble-text"},Kn={key:0,class:"empty-state"},Xn={class:"modal-content"},Qn={class:"modal-header"},Yn={class:"modal-title"},Zn=["placeholder"],es={id:"name-char-count",class:"char-count",style:{"text-align":"right",display:"block","margin-top":"0.25rem"}},ts={class:"modal-footer"},os={class:"modal-content"},ns={class:"modal-header"},ss={class:"modal-title"},as={class:"state-text",id:"delete-message"},ls={class:"modal-footer"},is=Ie({__name:"index",emits:["memory-selected"],setup(A,{emit:o}){const t=C(!1),l=C(""),m=C([]),_=C([]),u=C(!1),x=C(null),V=C(""),w=C(!1),F=C(null),G=new Map,O=o;De(()=>{Ee.setLoadMessages(g)});const g=async()=>{try{const R=await Oe.getMemories();m.value?m.value=R.map(z=>({...z,expanded:G.has(z.memoryId)?G.get(z.memoryId):!1})):m.value=R.map(z=>({...z,expanded:!1})),_.value=[...m.value],Z()}catch(R){console.error("error:",R),m.value=[],_.value=[]}},M=R=>{Ee.selectMemory(R),O("memory-selected")},Q=R=>{const z=typeof R=="string"?parseInt(R,10):R;return isNaN(z)||z<=0?"unknow time":new Date(z.toString().length===13?z:z*1e3).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(","," ")},Z=()=>{const R=l.value.toLowerCase().trim();if(!R){_.value=[...m.value];return}_.value=m.value.filter(z=>{const j=z.memoryName.toLowerCase().includes(R),se=z.memoryId.toLowerCase().includes(R),be=z.messages.some(P=>P.text.toLowerCase().includes(R));return j||se||be})},b=(R,z)=>{x.value=R,V.value=z,u.value=!0},U=()=>{u.value=!1,x.value=null},d=async()=>{if(!x.value)return;const R=V.value.trim()||"unknow name",z=m.value.findIndex(j=>j.memoryId===x.value);if(z!==-1){const j=m.value[z];try{const se=await Oe.update(j.memoryId,R);se.messages||(se.messages=[]),m.value[z]={...se,expanded:j.expanded},Z(),u.value=!1}catch(se){console.error("error:",se)}}},I=R=>{const z=m.value.find(j=>j.memoryId===R);if(z){z.expanded=!z.expanded,G.set(R,z.expanded);const j=_.value.findIndex(se=>se.memoryId===R);j!==-1&&(_.value[j]={...z})}},D=R=>{F.value=R,w.value=!0},T=()=>{w.value=!1,F.value=null},L=async()=>{if(F.value)try{await Oe.delete(F.value),m.value=m.value.filter(R=>R.memoryId!==F.value),Z(),m.value.length===0&&Ee.clearMemoryId(),w.value=!1,F.value=null}catch(R){console.error("error:",R)}};return(R,z)=>(c(),me(je,{to:"body"},[f(Be,{name:"modal"},{default:Re(()=>[n(Ee).isCollapsed?(c(),h("div",vn,[e("div",gn,[e("div",fn,[e("div",bn,[e("div",yn,[e("h1",$n,[e("span",null,s(R.$t("memory.title")),1)])]),t.value?(c(),h("div",_n)):N("",!0)]),e("button",{class:"close-btn",onClick:z[0]||(z[0]=j=>n(Ee).toggleSidebar())},[f(n($),{icon:"carbon:close"})])]),e("div",kn,[e("div",Sn,[f(n($),{class:"search-container-icon",icon:"carbon:search"}),ce(e("input",{type:"text",placeholder:R.$t("memory.searchPlaceholder"),class:"search-input","onUpdate:modelValue":z[1]||(z[1]=j=>l.value=j),onInput:Z},null,40,wn),[[pe,l.value]])])]),e("div",Cn,[e("div",null,[(c(!0),h(ge,null,Se(_.value,j=>(c(),h("div",{class:ie(["message-item",{expanded:j.expanded}]),key:j.memoryId},[e("div",Pn,[e("div",Tn,[e("div",En,[e("div",{class:"sender-div",onClick:he(se=>M(j.memoryId),["stop"])},[e("h3",xn,s(j.memoryName),1)],8,In),e("div",{class:"toggle-container",onClick:he(se=>b(j.memoryId,j.memoryName),["stop"])},[f(n($),{icon:"carbon:edit",class:"edit-btn"})],8,Dn),e("div",Rn,[e("button",{class:"delete-btn",onClick:he(se=>I(j.memoryId),["stop"])},[f(n($),{id:"toggle-"+j.memoryId,icon:"carbon:chevron-down",class:"down-btn"},null,8,["id"])],8,Mn)]),e("div",An,[e("button",{class:"delete-btn",onClick:he(se=>D(j.memoryId),["stop"])},[f(n($),{icon:"carbon:delete"})],8,Un)])]),e("div",Nn,[e("p",Fn,s(j.messages.length>0?j.messages[0].text:"none message"),1),j.messages.length>1?(c(),h("p",Ln,s(j.messages[1].text),1)):N("",!0)]),e("div",qn,[e("span",Bn,"ID: "+s(j.memoryId),1),e("div",Vn,[j.messages.length>0?(c(),h("span",jn,s(j.messages.length)+" "+s(R.$t("memory.size")),1)):N("",!0),e("span",On,s(Q(j.createTime)),1)])])])]),j.expanded?(c(),h("div",{key:0,id:"content-"+j.memoryId,class:"expanded-content"},[e("div",zn,[(c(!0),h(ge,null,Se(j.messages,(se,be)=>(c(),h("div",{class:"message-bubble",key:be},[e("div",Hn,s(se.messageType),1),e("div",Jn,[e("p",Gn,s(se.text),1)])]))),128))])],8,Wn)):N("",!0)],2))),128))]),_.value.length===0&&l.value?(c(),h("div",Kn,z[3]||(z[3]=[e("p",{class:"state-text"},"none message",-1)]))):N("",!0)]),u.value?(c(),h("div",{key:0,id:"name-edit-modal",class:"modal-overlay",onClick:he(U,["self"])},[e("div",Xn,[e("div",Qn,[e("h3",Yn,s(R.$t("memory.changeName")),1),ce(e("input",{type:"text","onUpdate:modelValue":z[2]||(z[2]=j=>V.value=j),class:"edit-input",placeholder:R.$t("memory.newNamePlaceholder")},null,8,Zn),[[pe,V.value]]),e("span",es,s(V.value.length),1)]),e("div",ts,[e("button",{id:"cancel-name",class:"modal-btn cancel-btn",onClick:U},s(R.$t("memory.cancel")),1),e("button",{id:"save-name",class:"modal-btn confirm-btn",onClick:d},s(R.$t("memory.save")),1)])])])):N("",!0),w.value?(c(),h("div",{key:1,id:"delete-modal",class:"modal-overlay",onClick:he(T,["self"])},[e("div",os,[e("div",ns,[e("h3",ss,s(R.$t("memory.deleteHint")),1),e("p",as,s(R.$t("memory.deleteHintPrefix"))+" "+s(F.value)+" "+s(R.$t("memory.deleteHintSuffix")),1)]),e("div",ls,[e("button",{id:"cancel-delete",class:"modal-btn cancel-btn",onClick:T},s(R.$t("memory.cancel")),1),e("button",{id:"confirm-delete",class:"modal-btn delete-btn-confirm",onClick:L},s(R.$t("memory.delete")),1)])])])):N("",!0)])])):N("",!0)]),_:1})]))}}),rs=xe(is,[["__scopeId","data-v-ab7beb02"]]);class Ge{static async sendMessage(o){return Pt.withLlmCheck(async()=>{const t=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!t.ok)throw new Error(`API request failed: ${t.status}`);return await t.json()})}}fe(Ge,"BASE_URL","/api/executor");class Ke{static async getDetails(o){try{const t=await fetch(`${this.BASE_URL}/details/${o}`);if(t.status===404)return null;if(!t.ok){const _=await t.text();throw new Error(`Failed to get detailed information: ${t.status} - ${_}`)}const l=await t.text(),m=JSON.parse(l);return m&&typeof m=="object"&&!m.currentPlanId&&(m.currentPlanId=o),m}catch(t){return console.error("[CommonApiService] Failed to get plan details:",t),{currentPlanId:o,status:"failed",message:t instanceof Error?t.message:"Failed to save, please retry"}}}static async submitFormInput(o,t){const l=await fetch(`${this.BASE_URL}/submit-input/${o}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!l.ok){let _;try{_=await l.json()}catch{_={message:`Failed to submit form input: ${l.status}`}}throw new Error(_.message||`Failed to submit form input: ${l.status}`)}const m=l.headers.get("content-type");return m&&m.indexOf("application/json")!==-1?await l.json():{success:!0}}static async getAllPrompts(){try{const o=await fetch(this.BASE_URL);return await(await this.handleResponse(o)).json()}catch(o){throw console.error("Failed to get Prompt list:",o),o}}static async handleResponse(o){if(!o.ok)try{const t=await o.json();throw new Error(t.message||`API request failed: ${o.status}`)}catch{throw new Error(`API request failed: ${o.status} ${o.statusText}`)}return o}}fe(Ke,"BASE_URL","/api/executor");const Ne=class Ne{constructor(){fe(this,"POLL_INTERVAL",5e3);fe(this,"state",He({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));fe(this,"callbacks",{});fe(this,"planExecutionCache",new Map);fe(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(o){return this.planExecutionCache.get(o)}getCachedUIState(o){return this.uiStateCache.get(o)}setCachedUIState(o,t){this.uiStateCache.set(o,t),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${o}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(o){return this.planExecutionCache.has(o)}setCachedPlanRecord(o,t){this.planExecutionCache.set(o,t),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${o}`)}clearCachedPlanRecord(o){const t=this.planExecutionCache.delete(o);return t&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${o}`),t}clearAllCachedRecords(){const o=this.planExecutionCache.size,t=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${o}, UI States: ${t}`)}static getInstance(){return Ne.instance||(Ne.instance=new Ne),Ne.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(o){this.callbacks={...this.callbacks,...o},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(o))}async handleUserMessageSendRequested(o){if(this.validateAndPrepareUIForNewRequest(o))try{if(await this.sendUserMessageAndSetPlanId(o),this.state.activePlanId)this.initiatePlanExecutionSequence(o,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(t){console.error("[PlanExecutionManager] Failed to send user message:",t);const l=this.state.activePlanId??"error";this.setCachedUIState(l,{enabled:!0}),this.emitChatInputUpdateState(l),this.state.activePlanId=null}}handlePlanExecutionRequested(o,t){console.log("[PlanExecutionManager] Received plan execution request:",{planId:o,query:t}),o?(this.state.activePlanId=o,this.initiatePlanExecutionSequence(t??"Execute Plan",o)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(o,t){const l=this.getCachedPlanRecord(o);return l!=null&&l.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${o}`),this.handlePlanExecutionRequested(l.currentPlanId,t),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${o}`),!1)}validateAndPrepareUIForNewRequest(o){if(!o)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const t=this.state.activePlanId??"ui-state";return this.setCachedUIState(t,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(t),!0}async sendUserMessageAndSetPlanId(o){try{const t=await Ge.sendMessage({input:o});if(t!=null&&t.planId)return this.state.activePlanId=t.planId,t;if(t!=null&&t.planTemplateId)return this.state.activePlanId=t.planTemplateId,{...t,planId:t.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",t),new Error("Failed to get valid planId from API response")}catch(t){throw console.error("[PlanExecutionManager] API call failed:",t),t}}initiatePlanExecutionSequence(o,t){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${o}", planId: ${t}`);const l=t;this.emitDialogRoundStart(l),this.startPolling()}handlePlanCompletion(o){this.emitPlanCompleted(o.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await We.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}},5e3)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}o.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(o.rootPlanId??""))}handlePlanError(o){this.emitPlanError(o.message??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await We.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}},5e3)}catch(t){console.log(`Delete plan execution record failed: ${t.message}`)}}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const o=await this.getPlanDetails(this.state.activePlanId);if(!o){console.warn("[PlanExecutionManager] No details received from API");return}if(o.status&&o.status==="failed"){this.handlePlanError(o);return}if(o.rootPlanId&&this.setCachedPlanRecord(o.rootPlanId,o),!o.steps||o.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(o.rootPlanId??""),this.handlePlanCompletion(o);return}this.emitPlanUpdate(o.rootPlanId??""),o.completed&&this.handlePlanCompletion(o)}catch(o){console.error("[PlanExecutionManager] Failed to poll plan status:",o)}finally{this.state.isPolling=!1}}}async getPlanDetails(o){try{const t=await Ke.getDetails(o);return t!=null&&t.rootPlanId&&(this.planExecutionCache.set(t.rootPlanId,t),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${t.rootPlanId}`)),t}catch(t){return console.error("[PlanExecutionManager] Failed to get plan details:",t),{currentPlanId:o,status:"failed",message:t instanceof Error?t.message:"Failed to get plan"}}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(o){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(o)}emitDialogRoundStart(o){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(o)}emitPlanUpdate(o){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(o)}emitPlanCompleted(o){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(o)}emitPlanError(o){this.callbacks.onPlanError&&this.callbacks.onPlanError(o)}};fe(Ne,"instance",null);let Je=Ne;const we=Je.getInstance();class Ue{static async handleResponse(o){if(!o.ok)try{const t=await o.json();throw new Error(t.message||`API request failed: ${o.status}`)}catch{throw new Error(`API request failed: ${o.status} ${o.statusText}`)}return o}static async getFileTree(o){try{const t=await fetch(`${this.BASE_URL}/tree/${o}`),m=await(await this.handleResponse(t)).json();if(!m.success)throw new Error(m.message||"Failed to get file tree");return m.data}catch(t){throw console.error("Failed to get file tree:",t),t}}static async getFileContent(o,t){try{const l=await fetch(`${this.BASE_URL}/content/${o}?path=${encodeURIComponent(t)}`),_=await(await this.handleResponse(l)).json();if(!_.success)throw new Error(_.message||"Failed to get file content");return _.data}catch(l){throw console.error("Failed to get file content:",l),l}}static async downloadFile(o,t,l){try{const m=await fetch(`${this.BASE_URL}/download/${o}?path=${encodeURIComponent(t)}`);await this.handleResponse(m);const _=await m.blob(),u=window.URL.createObjectURL(_),x=document.createElement("a");x.href=u,x.download=l||t.split("/").pop()||"download",document.body.appendChild(x),x.click(),window.URL.revokeObjectURL(u),document.body.removeChild(x)}catch(m){throw console.error("Failed to download file:",m),m}}static isTextFile(o,t){const l=["text/","application/json","application/xml","application/javascript","application/typescript"],m=[".txt",".md",".json",".xml",".html",".css",".js",".ts",".vue",".jsx",".tsx",".py",".java",".cpp",".c",".h",".sh",".bat",".yml",".yaml",".properties",".conf",".cfg"];if(l.some(u=>o.startsWith(u)))return!0;const _=t.toLowerCase();return m.some(u=>_.endsWith(u))}static getFileIcon(o){if(o.type==="directory")return"carbon:folder";const t=o.name.toLowerCase();return t.endsWith(".js")?"vscode-icons:file-type-js":t.endsWith(".ts")?"vscode-icons:file-type-typescript":t.endsWith(".vue")?"vscode-icons:file-type-vue":t.endsWith(".java")?"vscode-icons:file-type-java":t.endsWith(".py")?"vscode-icons:file-type-python":t.endsWith(".json")?"vscode-icons:file-type-json":t.endsWith(".xml")?"vscode-icons:file-type-xml":t.endsWith(".html")?"vscode-icons:file-type-html":t.endsWith(".css")?"vscode-icons:file-type-css":t.endsWith(".md")?"vscode-icons:file-type-markdown":t.endsWith(".yml")||t.endsWith(".yaml")?"vscode-icons:file-type-yaml":t.endsWith(".pdf")?"vscode-icons:file-type-pdf2":t.endsWith(".doc")||t.endsWith(".docx")?"vscode-icons:file-type-word":t.endsWith(".xls")||t.endsWith(".xlsx")?"vscode-icons:file-type-excel":t.endsWith(".ppt")||t.endsWith(".pptx")?"vscode-icons:file-type-powerpoint":t.match(/\.(jpg|jpeg|png|gif|bmp|svg)$/)?"carbon:image":t.match(/\.(zip|rar|7z|tar|gz)$/)?"carbon:archive":"carbon:document"}}fe(Ue,"BASE_URL","/api/file-browser");const cs={class:"file-tree-node"},ds={class:"node-icon"},us={class:"node-name"},ps={key:1,class:"file-size"},hs={key:2,class:"node-actions"},ms={key:0,class:"children"},vs=Ie({__name:"FileTreeNode",props:{node:{},level:{}},emits:["file-selected","download-file"],setup(A,{emit:o}){const t=A,l=o,m=C(t.level===0),_=C(!1),u=C(!1),x=C({}),V=()=>{t.node.type==="directory"&&(m.value=!m.value)},w=()=>{t.node.type==="directory"?V():F()},F=()=>{t.node.type==="file"&&l("file-selected",t.node),g()},G=()=>{l("download-file",t.node),g()},O=b=>{b.preventDefault(),u.value=!0,x.value={position:"fixed",top:`${b.clientY}px`,left:`${b.clientX}px`,zIndex:1e3},setTimeout(()=>{document.addEventListener("click",g)},0)},g=()=>{u.value=!1,document.removeEventListener("click",g)},M=async()=>{try{await navigator.clipboard.writeText(t.node.path)}catch(b){console.error("Failed to copy path:",b)}g()},Q=()=>t.node.type==="directory"?m.value?"carbon:folder-open":"carbon:folder":Ue.getFileIcon(t.node),Z=b=>{if(b===0)return"0 B";const U=1024,d=["B","KB","MB","GB"],I=Math.floor(Math.log(b)/Math.log(U));return parseFloat((b/Math.pow(U,I)).toFixed(1))+" "+d[I]};return Ae(()=>{document.removeEventListener("click",g)}),(b,U)=>{const d=$t("FileTreeNode",!0);return c(),h("div",cs,[e("div",{class:ie(["node-content",{"is-directory":b.node.type==="directory","is-file":b.node.type==="file","is-expanded":m.value}]),style:Ve({paddingLeft:`${b.level*16+12}px`}),onClick:w,onContextmenu:he(O,["prevent"])},[b.node.type==="directory"?(c(),h("div",{key:0,class:"expand-icon",onClick:he(V,["stop"])},[f(n($),{icon:m.value?"carbon:chevron-down":"carbon:chevron-right",class:"chevron-icon"},null,8,["icon"])])):N("",!0),e("div",ds,[f(n($),{icon:Q()},null,8,["icon"])]),e("span",us,s(b.node.name),1),b.node.type==="file"?(c(),h("span",ps,s(Z(b.node.size)),1)):N("",!0),_.value?(c(),h("div",hs,[b.node.type==="file"?(c(),h("button",{key:0,onClick:U[0]||(U[0]=he(I=>b.$emit("download-file",b.node),["stop"])),class:"action-btn download-btn",title:"Download"},[f(n($),{icon:"carbon:download"})])):N("",!0)])):N("",!0)],38),b.node.type==="directory"&&m.value&&b.node.children?(c(),h("div",ms,[(c(!0),h(ge,null,Se(b.node.children,I=>(c(),me(d,{key:I.path,node:I,level:b.level+1,onFileSelected:U[1]||(U[1]=D=>b.$emit("file-selected",D)),onDownloadFile:U[2]||(U[2]=D=>b.$emit("download-file",D))},null,8,["node","level"]))),128))])):N("",!0),u.value?(c(),h("div",{key:1,class:"context-menu",style:Ve(x.value),onClick:U[3]||(U[3]=he(()=>{},["stop"]))},[e("div",{class:"context-menu-item",onClick:F},[f(n($),{icon:"carbon:view"}),U[4]||(U[4]=e("span",null,"Open",-1))]),b.node.type==="file"?(c(),h("div",{key:0,class:"context-menu-item",onClick:G},[f(n($),{icon:"carbon:download"}),U[5]||(U[5]=e("span",null,"Download",-1))])):N("",!0),U[7]||(U[7]=e("div",{class:"context-menu-divider"},null,-1)),e("div",{class:"context-menu-item",onClick:M},[f(n($),{icon:"carbon:copy"}),U[6]||(U[6]=e("span",null,"Copy Path",-1))])],4)):N("",!0)])}}}),gs=xe(vs,[["__scopeId","data-v-e4a376d5"]]),fs={class:"file-browser"},bs={class:"file-browser-header"},ys={class:"header-actions"},$s=["disabled","title"],_s={class:"file-browser-content"},ks={class:"file-tree-panel"},Ss={key:0,class:"loading-state"},ws={key:1,class:"error-state"},Cs={key:0,class:"waiting-for-files"},Ps={class:"message-content"},Ts={class:"tips"},Es=["disabled"],Is={key:1,class:"actual-error"},xs={key:2,class:"empty-state"},Ds={key:3,class:"file-tree"},Rs={key:0,class:"file-content-panel"},Ms={class:"file-content-header"},As={class:"file-info"},Us={class:"file-name"},Ns={class:"file-size"},Fs={class:"file-actions"},Ls=["title"],qs=["title"],Bs={class:"file-content-body"},Vs={key:0,class:"loading-content"},js={key:1,class:"content-error"},Os={key:2,class:"file-content"},Ws={key:0,class:"text-content"},zs={key:1,class:"binary-content"},Hs=Ie({__name:"index",props:{planId:{}},setup(A){const o=A,{t}=Me(),l=C(!1),m=C(null),_=C(null),u=C(null),x=C(null),V=C(!1),w=C(null),F=C(null),G=ke(()=>!x.value||!u.value?!1:Ue.isTextFile(x.value.mimeType,u.value.name)),O=ke(()=>m.value&&(m.value.includes("Plan directory not found")||m.value.includes("not found"))),g=()=>{F.value&&(clearTimeout(F.value),F.value=null)},M=()=>{g(),F.value=window.setTimeout(()=>{O.value&&Q()},5e3)},Q=async()=>{if(o.planId){l.value=!0,m.value=null,g();try{_.value=await Ue.getFileTree(o.planId)}catch(D){m.value=D instanceof Error?D.message:t("fileBrowser.loadError"),console.error("Failed to load file tree:",D);const T=D instanceof Error?D.message:"";(T.includes("Plan directory not found")||T.includes("not found"))&&M()}finally{l.value=!1}}},Z=async D=>{if(D.type!=="directory"){u.value=D,x.value=null,V.value=!0,w.value=null;try{x.value=await Ue.getFileContent(o.planId,D.path)}catch(T){w.value=T instanceof Error?T.message:t("fileBrowser.contentLoadError"),console.error("Failed to load file content:",T)}finally{V.value=!1}}},b=async D=>{try{await Ue.downloadFile(o.planId,D.path,D.name)}catch(T){console.error("Failed to download file:",T)}},U=()=>{u.value=null,x.value=null,w.value=null},d=D=>Ue.getFileIcon(D),I=D=>{if(D===0)return"0 B";const T=1024,L=["B","KB","MB","GB"],R=Math.floor(Math.log(D)/Math.log(T));return parseFloat((D/Math.pow(T,R)).toFixed(1))+" "+L[R]};return Ce(()=>o.planId,D=>{D&&(u.value=null,x.value=null,Q())},{immediate:!0}),De(()=>{o.planId&&Q()}),Ae(()=>{g()}),(D,T)=>(c(),h("div",fs,[e("div",bs,[e("h3",null,s(D.$t("fileBrowser.title")),1),e("div",ys,[e("button",{class:"refresh-btn",onClick:Q,disabled:l.value,title:D.$t("fileBrowser.refresh")},[f(n($),{icon:"carbon:refresh",class:ie({rotating:l.value}),style:{color:"#ffffff",fontSize:"18px",width:"18px",height:"18px"}},null,8,["class"])],8,$s)])]),e("div",_s,[e("div",ks,[l.value?(c(),h("div",Ss,[f(n($),{icon:"carbon:loading",class:"rotating"}),e("span",null,s(D.$t("fileBrowser.loading")),1)])):m.value?(c(),h("div",ws,[O.value?(c(),h("div",Cs,[f(n($),{icon:"carbon:time",class:"rotating"}),e("div",Ps,[e("h3",null,s(D.$t("fileBrowser.waitingForGeneration")),1),e("p",null,s(D.$t("fileBrowser.planExecuting")),1),e("div",Ts,[f(n($),{icon:"carbon:information"}),e("span",null,s(D.$t("fileBrowser.filesTip")),1)])]),e("button",{onClick:Q,class:"retry-btn",disabled:l.value},[f(n($),{icon:"carbon:refresh",class:ie({rotating:l.value})},null,8,["class"]),le(" "+s(l.value?D.$t("fileBrowser.checking"):D.$t("fileBrowser.checkNow")),1)],8,Es)])):(c(),h("div",Is,[f(n($),{icon:"carbon:warning"}),e("span",null,s(m.value),1),e("button",{onClick:Q,class:"retry-btn"},s(D.$t("fileBrowser.retry")),1)]))])):_.value?(c(),h("div",Ds,[f(gs,{node:_.value,level:0,onFileSelected:Z,onDownloadFile:b},null,8,["node"])])):(c(),h("div",xs,[f(n($),{icon:"carbon:folder-off"}),e("span",null,s(D.$t("fileBrowser.noFiles")),1)]))]),u.value?(c(),h("div",Rs,[e("div",Ms,[e("div",As,[f(n($),{icon:d(u.value)},null,8,["icon"]),e("span",Us,s(u.value.name),1),e("span",Ns,"("+s(I(u.value.size))+")",1)]),e("div",Fs,[e("button",{onClick:T[0]||(T[0]=L=>b(u.value)),class:"download-btn",title:D.$t("fileBrowser.download")},[f(n($),{icon:"carbon:download"})],8,Ls),e("button",{onClick:U,class:"close-btn",title:D.$t("common.close")},[f(n($),{icon:"carbon:close"})],8,qs)])]),e("div",Bs,[V.value?(c(),h("div",Vs,[f(n($),{icon:"carbon:loading",class:"rotating"}),e("span",null,s(D.$t("fileBrowser.loadingContent")),1)])):w.value?(c(),h("div",js,[f(n($),{icon:"carbon:warning"}),e("span",null,s(w.value),1)])):x.value?(c(),h("div",Os,[G.value?(c(),h("div",Ws,[e("pre",null,[e("code",null,s(x.value.content),1)])])):(c(),h("div",zs,[f(n($),{icon:"carbon:document-unknown"}),e("p",null,s(D.$t("fileBrowser.binaryFile")),1),e("button",{onClick:T[1]||(T[1]=L=>b(u.value)),class:"download-btn-large"},[f(n($),{icon:"carbon:download"}),le(" "+s(D.$t("fileBrowser.downloadToView")),1)])]))])):N("",!0)])])):N("",!0)])]))}}),Js=xe(Hs,[["__scopeId","data-v-e7c74fe4"]]),Gs={class:"right-panel"},Ks={class:"preview-header"},Xs={class:"preview-tabs"},Qs={class:"preview-content"},Ys={key:0,class:"step-details"},Zs={key:0,class:"step-info-fixed"},ea={key:0,class:"agent-info"},ta={class:"info-item"},oa={class:"label"},na={class:"value"},sa={class:"info-item"},aa={class:"label"},la={class:"value"},ia={class:"info-item"},ra={class:"label"},ca={class:"value"},da={class:"info-item"},ua={class:"label"},pa={class:"value"},ha={class:"info-item"},ma={class:"label"},va={class:"execution-status"},ga={class:"status-item"},fa={class:"status-text"},ba={key:0},ya={key:0,class:"think-act-steps"},$a={class:"steps-container"},_a={class:"step-header"},ka={class:"step-number"},Sa={class:"think-section"},wa={class:"think-content"},Ca={class:"input"},Pa={class:"label"},Ta={class:"output"},Ea={class:"label"},Ia={key:0,class:"action-section"},xa={class:"action-content"},Da={class:"tool-info"},Ra={class:"label"},Ma={class:"value"},Aa={class:"input"},Ua={class:"label"},Na={class:"output"},Fa={class:"label"},La={key:0,class:"sub-plan-section"},qa={class:"sub-plan-content"},Ba={class:"sub-plan-header"},Va={class:"sub-plan-info"},ja={class:"label"},Oa={class:"value"},Wa={key:0,class:"sub-plan-info"},za={class:"label"},Ha={class:"value"},Ja={class:"sub-plan-status"},Ga={class:"status-text"},Ka={key:0,class:"no-steps-message"},Xa={key:1,class:"no-execution-message"},Qa={class:"step-basic-info"},Ya={class:"info-item"},Za={class:"label"},el={class:"value"},tl={key:0,class:"info-item"},ol={class:"label"},nl={class:"value"},sl={class:"info-item"},al={class:"label"},ll={class:"no-execution-hint"},il={key:2,class:"execution-indicator"},rl={class:"execution-text"},cl={key:1,class:"no-selection"},dl=["title"],ul={key:1,class:"file-browser-container"},pl={key:1,class:"no-plan-message"},hl={class:"message-content"},ml={class:"tips"},vl=Ie({__name:"index",props:{currentRootPlanId:{}},setup(A,{expose:o}){const t=A,{t:l}=Me(),m=C(),_=C(),u=C(),x=C("details"),V=C(localStorage.getItem("jmanus-last-plan-id")),w=C(localStorage.getItem("jmanus-has-executed-plan")==="true"),F=C(null),G=C(!1),O=C(!0),g=C(!0),M=ke(()=>u.value?u.value.completed?l("rightPanel.status.completed"):u.value.current?l("rightPanel.status.executing"):l("rightPanel.status.waiting"):""),Q=ke(()=>t.currentRootPlanId?t.currentRootPlanId:V.value),Z=ke(()=>!Q.value&&!w.value),b=P=>{var ee;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${P}`),u.value&&F.value){const Y=F.value.rootPlanId??_.value;if(Y&&Y!==P){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${Y}, Requested: ${P}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${P}`);const B=we.getCachedPlanRecord(P);if(!B){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${P}`);return}if(B.steps&&B.steps.length>0){const Y=B.steps.length,q=(B.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${q} / ${Y}`)}if(u.value&&_.value&&(_.value===P||((ee=F.value)==null?void 0:ee.rootPlanId)===P)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${P}`),F.value)){const q=F.value,K=d(q.planId,q.rootPlanId,q.subPlanId);K?(I(K,q.stepIndex,q.planId,q.isSubPlan),z()):console.warn("[RightPanel] Could not find plan record for refresh:",q)}},U=(P,B,ee,Y,q)=>{console.log("[RightPanel] Step selected:",{planId:P,stepIndex:B,rootPlanId:ee,subPlanId:Y,subStepIndex:q});const K=!!(ee&&Y&&q!==void 0);F.value={planId:P,stepIndex:B,isSubPlan:K,...K&&{rootPlanId:ee,subPlanId:Y,subStepIndex:q}};const k=d(P,ee,Y);if(!k){console.warn("[RightPanel] Plan data not found:",{planId:P,rootPlanId:ee,subPlanId:Y}),u.value=null,F.value=null;return}I(k,B,P,K)},d=(P,B,ee)=>{var K;if(!B||!ee)return we.getCachedPlanRecord(P)??null;const Y=we.getCachedPlanRecord(P);if(Y)return Y;const q=we.getCachedPlanRecord(B);if(!(q!=null&&q.agentExecutionSequence))return null;for(const k of q.agentExecutionSequence)if(k.thinkActSteps){for(const v of k.thinkActSteps)if(((K=v.subPlanExecutionRecord)==null?void 0:K.currentPlanId)===ee)return v.subPlanExecutionRecord}return null},I=(P,B,ee,Y)=>{var X,ue,ye,$e,r;if(!P.steps||B>=P.steps.length){u.value=null,F.value=null,console.warn("[RightPanel] Invalid step data:",{planId:ee,stepIndex:B,hasSteps:!!P.steps,stepsLength:(X=P.steps)==null?void 0:X.length,message:"Invalid step index"});return}_.value=ee;const q=P.steps[B],K=(ue=P.agentExecutionSequence)==null?void 0:ue[B];console.log("[RightPanel] Step data details:",{planId:ee,stepIndex:B,step:q,hasAgentExecutionSequence:!!P.agentExecutionSequence,agentExecutionSequenceLength:(ye=P.agentExecutionSequence)==null?void 0:ye.length,agentExecution:K,hasThinkActSteps:!!(K!=null&&K.thinkActSteps),thinkActStepsLength:($e=K==null?void 0:K.thinkActSteps)==null?void 0:$e.length,isSubPlan:Y});const k=(K==null?void 0:K.status)==="FINISHED",v=!k&&B===P.currentStepIndex&&!P.completed,y={planId:ee,index:B,title:typeof q=="string"?q:q.title||q.description||q.name||`${Y?"Sub ":""}Step ${B+1}`,description:typeof q=="string"?q:q.description||q,completed:k,current:v};K&&(y.agentExecution=K),u.value=y,console.log("[RightPanel] Step details updated:",{planId:ee,stepIndex:B,stepTitle:u.value.title,hasAgentExecution:!!K,hasThinkActSteps:(((r=K==null?void 0:K.thinkActSteps)==null?void 0:r.length)??0)>0,completed:k,current:v,planCurrentStep:P.currentStepIndex,planCompleted:P.completed,isSubPlan:Y}),K!=null&&K.thinkActSteps&&K.thinkActSteps.forEach((i,a)=>{i.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${a}:`,i.subPlanExecutionRecord)}),setTimeout(()=>{L()},100),z()},D=(P,B,ee,Y)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:P,subPlanId:B,stepIndex:ee,subStepIndex:Y}),U(B,Y,P,B,Y)},T=P=>{m.value=P??void 0},L=()=>{if(!m.value)return;const{scrollTop:P,scrollHeight:B,clientHeight:ee}=m.value,Y=B-P-ee<50,q=B>ee;O.value=Y,G.value=q&&!Y,Y?g.value=!0:B-P-ee>100&&(g.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:P,scrollHeight:B,clientHeight:ee,isAtBottom:Y,hasScrollableContent:q,showButton:G.value,shouldAutoScroll:g.value})},R=()=>{m.value&&(m.value.scrollTo({top:m.value.scrollHeight,behavior:"smooth"}),_e(()=>{g.value=!0,L()}))},z=()=>{!g.value||!m.value||_e(()=>{m.value&&(m.value.scrollTop=m.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},j=P=>{if(P===null||typeof P>"u"||P==="")return"N/A";try{const B=typeof P=="object"?P:JSON.parse(P);return JSON.stringify(B,null,2)}catch{return String(P)}},se=()=>{u.value=null,_.value=void 0,g.value=!0,m.value&&m.value.removeEventListener("scroll",L)},be=()=>{const P=()=>{const B=m.value;return B?(T(B),B.addEventListener("scroll",L),g.value=!0,L(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};_e(()=>{P()||setTimeout(()=>{P()},100)})};return Ce(()=>t.currentRootPlanId,(P,B)=>{P&&P!==B?(V.value=P,w.value=!0,localStorage.setItem("jmanus-last-plan-id",P),localStorage.setItem("jmanus-has-executed-plan","true"),console.log("[RightPanel] New plan started:",P)):!P&&B&&console.log("[RightPanel] Plan execution finished, keeping last plan:",V.value)},{immediate:!0}),De(()=>{console.log("[RightPanel] Component mounted"),_e(()=>{be()})}),Ae(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),F.value=null,se()}),o({updateDisplayedPlanProgress:b,handleStepSelected:U,handleSubPlanStepSelected:D}),(P,B)=>{var ee,Y;return c(),h("div",Gs,[e("div",Ks,[e("div",Xs,[e("div",{class:ie(["tab-item",{active:x.value==="details"}]),onClick:B[0]||(B[0]=q=>x.value="details")},[f(n($),{icon:"carbon:events"}),e("span",null,s(n(l)("rightPanel.stepExecutionDetails")),1)],2),e("div",{class:ie(["tab-item",{active:x.value==="files"}]),onClick:B[1]||(B[1]=q=>x.value="files")},[f(n($),{icon:"carbon:folder"}),e("span",null,s(n(l)("fileBrowser.title")),1)],2)])]),e("div",Qs,[x.value==="details"?(c(),h("div",Ys,[u.value?(c(),h("div",Zs,[e("h3",null,s(u.value.title||u.value.description||n(l)("rightPanel.defaultStepTitle",{number:u.value.index+1})),1),u.value.agentExecution?(c(),h("div",ea,[e("div",ta,[e("span",oa,s(n(l)("rightPanel.executingAgent"))+":",1),e("span",na,s(u.value.agentExecution.agentName),1)]),e("div",sa,[e("span",aa,s(n(l)("rightPanel.description"))+":",1),e("span",la,s(u.value.agentExecution.agentDescription||""),1)]),e("div",ia,[e("span",ra,s(n(l)("rightPanel.callingModel"))+":",1),e("span",ca,s(u.value.agentExecution.modelName),1)]),e("div",da,[e("span",ua,s(n(l)("rightPanel.request"))+":",1),e("span",pa,s(u.value.agentExecution.agentRequest||""),1)]),e("div",ha,[e("span",ma,s(n(l)("rightPanel.executionResult"))+":",1),e("span",{class:ie(["value",{success:u.value.agentExecution.status==="FINISHED"}])},s(u.value.agentExecution.status||n(l)("rightPanel.executing")),3)])])):N("",!0),e("div",va,[e("div",ga,[u.value.completed?(c(),me(n($),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):u.value.current?(c(),me(n($),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(c(),me(n($),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",fa,s(M.value),1)])])])):N("",!0),e("div",{ref_key:"scrollContainer",ref:m,class:"step-details-scroll-container",onScroll:L},[u.value?(c(),h("div",ba,[(ee=u.value.agentExecution)!=null&&ee.thinkActSteps&&u.value.agentExecution.thinkActSteps.length>0?(c(),h("div",ya,[e("h4",null,s(n(l)("rightPanel.thinkAndActionSteps")),1),e("div",$a,[(c(!0),h(ge,null,Se(u.value.agentExecution.thinkActSteps,(q,K)=>(c(),h("div",{key:K,class:"think-act-step"},[e("div",_a,[e("span",ka,"#"+s(K+1),1),e("span",{class:ie(["step-status",q.status])},s(q.status||n(l)("rightPanel.executing")),3)]),e("div",Sa,[e("h5",null,[f(n($),{icon:"carbon:thinking"}),le(" "+s(n(l)("rightPanel.thinking")),1)]),e("div",wa,[e("div",Ca,[e("span",Pa,s(n(l)("rightPanel.input"))+":",1),e("pre",null,s(j(q.thinkInput)),1)]),e("div",Ta,[e("span",Ea,s(n(l)("rightPanel.output"))+":",1),e("pre",null,s(j(q.thinkOutput)),1)])])]),q.actionNeeded?(c(),h("div",Ia,[e("h5",null,[f(n($),{icon:"carbon:play"}),le(" "+s(n(l)("rightPanel.action")),1)]),e("div",xa,[(c(!0),h(ge,null,Se(q.actToolInfoList,(k,v)=>(c(),h("div",{key:v},[e("div",Da,[e("span",Ra,s(n(l)("rightPanel.tool"))+":",1),e("span",Ma,s(k.name||""),1)]),e("div",Aa,[e("span",Ua,s(n(l)("rightPanel.toolParameters"))+":",1),e("pre",null,s(j(k.parameters)),1)]),e("div",Na,[e("span",Fa,s(n(l)("rightPanel.executionResult"))+":",1),e("pre",null,s(j(k.result)),1)])]))),128))]),q.subPlanExecutionRecord?(c(),h("div",La,[e("h5",null,[f(n($),{icon:"carbon:tree-view"}),le(" "+s(n(l)("rightPanel.subPlan")),1)]),e("div",qa,[e("div",Ba,[e("div",Va,[e("span",ja,s(P.$t("rightPanel.subPlanId"))+":",1),e("span",Oa,s(q.subPlanExecutionRecord.currentPlanId),1)]),q.subPlanExecutionRecord.title?(c(),h("div",Wa,[e("span",za,s(P.$t("rightPanel.title"))+":",1),e("span",Ha,s(q.subPlanExecutionRecord.title),1)])):N("",!0),e("div",Ja,[q.subPlanExecutionRecord.completed?(c(),me(n($),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(c(),me(n($),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",Ga,s(q.subPlanExecutionRecord.completed?P.$t("rightPanel.status.completed"):P.$t("rightPanel.status.executing")),1)])])])])):N("",!0)])):N("",!0)]))),128))]),u.value.agentExecution&&!((Y=u.value.agentExecution.thinkActSteps)!=null&&Y.length)?(c(),h("div",Ka,[e("p",null,s(n(l)("rightPanel.noStepDetails")),1)])):u.value.agentExecution?N("",!0):(c(),h("div",Xa,[f(n($),{icon:"carbon:information",class:"info-icon"}),e("h4",null,s(n(l)("rightPanel.stepInfo")),1),e("div",Qa,[e("div",Ya,[e("span",Za,s(n(l)("rightPanel.stepName"))+":",1),e("span",el,s(u.value.title||u.value.description||P.$t("rightPanel.stepNumber",{number:u.value.index+1})),1)]),u.value.description?(c(),h("div",tl,[e("span",ol,s(P.$t("rightPanel.description"))+":",1),e("span",nl,s(u.value.description),1)])):N("",!0),e("div",sl,[e("span",al,s(P.$t("rightPanel.status.label"))+":",1),e("span",{class:ie(["value",{"status-completed":u.value.completed,"status-current":u.value.current,"status-pending":!u.value.completed&&!u.value.current}])},s(u.value.completed?P.$t("rightPanel.status.completed"):u.value.current?P.$t("rightPanel.status.executing"):P.$t("rightPanel.status.pending")),3)])]),e("p",ll,s(n(l)("rightPanel.noExecutionInfo")),1)])),u.value.current&&!u.value.completed?(c(),h("div",il,[B[2]||(B[2]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",rl,[f(n($),{icon:"carbon:in-progress",class:"rotating-icon"}),le(" "+s(n(l)("rightPanel.stepExecuting")),1)])])):N("",!0)])):(c(),h("div",cl,[f(n($),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,s(n(l)("rightPanel.noStepSelected")),1),e("p",null,s(n(l)("rightPanel.selectStepHint")),1)]))])):N("",!0),f(Be,{name:"scroll-button"},{default:Re(()=>[G.value?(c(),h("button",{key:0,onClick:R,class:"scroll-to-bottom-btn",title:n(l)("rightPanel.scrollToBottom")},[f(n($),{icon:"carbon:chevron-down"})],8,dl)):N("",!0)]),_:1})],544)])):N("",!0),x.value==="files"?(c(),h("div",ul,[Q.value?(c(),me(Js,{key:0,"plan-id":Q.value},null,8,["plan-id"])):Z.value?(c(),h("div",pl,[f(n($),{icon:"carbon:folder-off"}),e("div",hl,[e("h3",null,s(n(l)("fileBrowser.noFilesYet")),1),e("p",null,s(n(l)("fileBrowser.noPlanExecuting")),1),e("div",ml,[f(n($),{icon:"carbon:information"}),e("span",null,s(n(l)("fileBrowser.startTaskTip")),1)])])])):N("",!0)])):N("",!0)])])}}}),gl=xe(vl,[["__scopeId","data-v-d7e4058f"]]);function fl(){const A=we,o=ke(()=>A.getActivePlanId()),t=ke(()=>A.getState()),l=ke(()=>t.value.isPolling),m=ke(()=>!!o.value),_=(w,F)=>{A.initiatePlanExecutionSequence(w,F)},u=()=>{A.stopPolling()},x=()=>{A.startPolling()},V=()=>{A.cleanup()};return Ae(()=>{V()}),{activePlanId:o,state:t,isPolling:l,hasActivePlan:m,startExecution:_,stopPolling:u,startPolling:x,cleanup:V}}const bl={class:"chat-container"},yl={class:"message-content"},$l={key:0,class:"user-message"},_l={key:1,class:"assistant-message"},kl={key:0,class:"thinking-section"},Sl={class:"thinking-header"},wl={class:"thinking-avatar"},Cl={class:"thinking-label"},Pl={class:"thinking-content"},Tl={key:0,class:"thinking"},El={key:1,class:"progress"},Il={class:"progress-bar"},xl={class:"progress-text"},Dl={key:2,class:"steps-container"},Rl={class:"steps-title"},Ml=["onClick"],Al={class:"section-header"},Ul={class:"step-icon"},Nl={class:"step-title"},Fl={key:0,class:"step-status current"},Ll={key:1,class:"step-status completed"},ql={key:2,class:"step-status pending"},Bl={key:0,class:"action-info"},Vl={class:"action-description"},jl={class:"action-icon"},Ol={key:0,class:"tool-params"},Wl={class:"param-label"},zl={class:"param-content"},Hl={key:1,class:"think-details"},Jl={class:"think-header"},Gl={class:"think-label"},Kl={class:"think-output"},Xl={class:"think-content"},Ql={key:1,class:"sub-plan-steps"},Yl={class:"sub-plan-header"},Zl={class:"sub-plan-title"},ei={class:"sub-plan-step-list"},ti=["onClick"],oi={class:"sub-step-indicator"},ni={class:"sub-step-icon"},si={class:"sub-step-number"},ai={class:"sub-step-content"},li={class:"sub-step-title"},ii={class:"sub-step-badge"},ri={key:2,class:"user-input-form-container"},ci={class:"user-input-message"},di={key:0,class:"form-description"},ui=["onSubmit"],pi={key:0,class:"form-grid"},hi=["for"],mi=["id","name","placeholder","required","onUpdate:modelValue"],vi=["id","name","placeholder","required","onUpdate:modelValue"],gi=["id","name","placeholder","required","onUpdate:modelValue"],fi=["id","name","placeholder","required","onUpdate:modelValue"],bi=["id","name","placeholder","required","onUpdate:modelValue"],yi=["id","name","required","onUpdate:modelValue"],$i={value:""},_i=["value"],ki=["id","name","placeholder","required","onUpdate:modelValue"],Si={key:1,class:"form-group"},wi={for:"form-input-genericInput"},Ci=["onUpdate:modelValue"],Pi={type:"submit",class:"submit-user-input-btn"},Ti={key:3,class:"default-processing"},Ei={class:"processing-indicator"},Ii={class:"response-section"},xi={class:"response-header"},Di={class:"response-avatar"},Ri={class:"response-name"},Mi={class:"response-content"},Ai={key:0,class:"final-response"},Ui=["innerHTML"],Ni={key:1,class:"response-placeholder"},Fi={class:"typing-indicator"},Li={class:"typing-text"},qi={key:0,class:"message assistant"},Bi={class:"message-content"},Vi={class:"assistant-message"},ji={class:"thinking-section"},Oi={class:"thinking-header"},Wi={class:"thinking-avatar"},zi={class:"thinking-label"},Hi={class:"thinking-content"},Ji={class:"default-processing"},Gi={class:"processing-indicator"},Ki={class:"response-section"},Xi={class:"response-header"},Qi={class:"response-avatar"},Yi={class:"response-name"},Zi={class:"response-content"},er={class:"response-placeholder"},tr={class:"typing-indicator"},or={class:"typing-text"},nr=["title"],sr=Ie({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(A,{expose:o,emit:t}){const l=A,m=t,{t:_}=Me(),u=fl(),x=C(),V=C(!1),w=C([]),F=C(),G=C(!1),O=He({}),g=(r,i,a)=>{const p={id:Date.now().toString(),type:r,content:i,timestamp:new Date,...a};return r==="assistant"&&!p.thinking&&!p.content&&(p.thinking=_("chat.thinking")),w.value.push(p),p},M=r=>{const i=w.value[w.value.length-1];i.type==="assistant"&&Object.assign(i,r)},Q=async r=>{try{V.value=!0;const i=g("assistant","",{thinking:_("chat.thinkingProcessing")}),a=await Ge.sendMessage(r);if(a.planId)console.log("[ChatComponent] Received planId from direct execution:",a.planId),a.memoryId&&Ee.setMemory(a.memoryId),i.planExecution||(i.planExecution={}),i.planExecution.currentPlanId=a.planId,we.handlePlanExecutionRequested(a.planId,r.input),delete i.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete i.thinking;const p=Z(a,r.input);i.content=p}}catch(i){console.error("Direct mode error:",i),M({content:b(i)})}finally{V.value=!1}},Z=(r,i)=>r.result??r.message??r.content??"",b=r=>{const i=(r==null?void 0:r.message)??(r==null?void 0:r.toString())??_("chat.unknownError");return i.includes("network")||i.includes("timeout")?_("chat.networkError"):i.includes("auth")||i.includes("unauthorized")?_("chat.authError"):i.includes("invalid")||i.includes("format")||i.includes("parameter")?_("chat.formatError"):`${_("chat.unknownError")} (${i})`},U=(r=!1)=>{_e(()=>{if(x.value){const i=x.value;(r||i.scrollHeight-i.scrollTop-i.clientHeight<150)&&i.scrollTo({top:i.scrollHeight,behavior:r?"auto":"smooth"})}})},d=()=>{U(!0),G.value=!1},I=()=>{if(x.value){const r=x.value,i=r.scrollHeight-r.scrollTop-r.clientHeight<150;G.value=!i&&w.value.length>0}},D=()=>{x.value&&x.value.addEventListener("scroll",I)},T=()=>{x.value&&x.value.removeEventListener("scroll",I)},L=r=>{g("user",r.input),l.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",r.input):Q(r)},R=(r,i)=>{var S;const a=((S=r.planExecution)==null?void 0:S.agentExecutionSequence)??[];return i<0||i>=a.length?"IDLE":a[i].status??"IDLE"},z=(r,i)=>{var a,p;if(!((a=r.planExecution)!=null&&a.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:r.planExecution.currentPlanId,stepIndex:i,stepTitle:(p=r.planExecution.steps)==null?void 0:p[i]}),m("step-selected",r.planExecution.currentPlanId,i)},j=(r,i)=>{var a;try{const p=(a=r.planExecution)==null?void 0:a.agentExecutionSequence;if(!(p!=null&&p.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const S=p[i];if(!S)return console.log(`[ChatComponent] No agentExecution found for step ${i}`),[];if(!S.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${i}`),[];for(const W of S.thinkActSteps)if(W.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${i}:`,W.subPlanExecutionRecord),(W.subPlanExecutionRecord.steps??[]).map(oe=>typeof oe=="string"?oe:typeof oe=="object"&&oe!==null&&(oe.title||oe.description)||_("rightPanel.subStep"));return[]}catch(p){return console.warn("[ChatComponent] Error getting sub-plan steps:",p),[]}},se=(r,i,a)=>{var p;try{const S=(p=r.planExecution)==null?void 0:p.agentExecutionSequence;if(!(S!=null&&S.length))return"pending";const W=S[i];if(!W||!W.thinkActSteps)return"pending";let re=null;for(const te of W.thinkActSteps)if(te.subPlanExecutionRecord){re=te.subPlanExecutionRecord;break}if(!re)return"pending";const oe=re.currentStepIndex;return re.completed?"completed":oe==null?a===0?"current":"pending":a<oe?"completed":a===oe?"current":"pending"}catch(S){return console.warn("[ChatComponent] Error getting sub-plan step status:",S),"pending"}},be=(r,i,a)=>{var p,S;try{const W=(p=r.planExecution)==null?void 0:p.agentExecutionSequence;if(!(W!=null&&W.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const re=W[i];if(!re){console.warn("[ChatComponent] No agentExecution found for step",i);return}if(!re.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",i);return}let oe=null;for(const te of re.thinkActSteps)if(te.subPlanExecutionRecord){oe=te.subPlanExecutionRecord;break}if(!(oe!=null&&oe.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}m("sub-plan-step-selected",((S=r.planExecution)==null?void 0:S.currentPlanId)??"",oe.currentPlanId,i,a)}catch(W){console.error("[ChatComponent] Error handling sub-plan step click:",W)}},P=(r,i)=>{var p,S,W,re;if(!((p=r.planExecution)!=null&&p.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",r.planExecution.steps.length,"execution sequence:",((S=i.agentExecutionSequence)==null?void 0:S.length)??0);const a=new Array(r.planExecution.steps.length).fill(null);if((W=i.agentExecutionSequence)!=null&&W.length){const oe=Math.min(i.agentExecutionSequence.length,r.planExecution.steps.length);for(let te=0;te<oe;te++){const H=i.agentExecutionSequence[te];if((re=H.thinkActSteps)!=null&&re.length){const ne=H.thinkActSteps[H.thinkActSteps.length-1];ne.actionDescription&&ne.toolParameters?(a[te]={actionDescription:ne.actionDescription,toolParameters:typeof ne.toolParameters=="string"?ne.toolParameters:JSON.stringify(ne.toolParameters,null,2),thinkInput:ne.thinkInput??"",thinkOutput:ne.thinkOutput??"",status:i.currentStepIndex!==void 0&&te<i.currentStepIndex?"completed":i.currentStepIndex!==void 0&&te===i.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${te} action set: ${a[te].actionDescription}`)):(a[te]={actionDescription:_("chat.thinking"),toolParameters:_("chat.waitingDecision"),thinkInput:ne.thinkInput??"",thinkOutput:ne.thinkOutput??"",status:i.currentStepIndex!==void 0&&te===i.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${te} is thinking`))}else a[te]={actionDescription:i.currentStepIndex!==void 0&&te<i.currentStepIndex?_("chat.status.completed"):_("chat.status.pending"),toolParameters:_("chat.noToolParameters"),thinkInput:"",thinkOutput:"",status:i.currentStepIndex!==void 0&&te<i.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] Step ${te} has no execution details, status set to: ${a[te].status}`)}}else console.log("[ChatComponent] No execution sequence data");r.stepActions=[...a],console.log("[ChatComponent] Step actions update completed:",JSON.stringify(a.map(oe=>oe==null?void 0:oe.actionDescription))),_e(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},B=r=>{console.log("[ChatComponent] Starting dialog round with planId:",r),r&&(w.value.findIndex(a=>{var p;return((p=a.planExecution)==null?void 0:p.currentPlanId)===r&&a.type==="assistant"})===-1?(g("assistant","",{planExecution:{currentPlanId:r},thinking:_("chat.preparingExecution")}),console.log("[ChatComponent] Created new assistant message for planId:",r)):console.log("[ChatComponent] Found existing assistant message for planId:",r))},ee=r=>{var W,re,oe,te;console.log("[ChatComponent] Processing plan update with rootPlanId:",r);const i=we.getCachedPlanRecord(r);if(!i){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",r);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",i),console.log("[ChatComponent] Plan steps:",i.steps),console.log("[ChatComponent] Plan completed:",i.completed),!i.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const a=w.value.findIndex(H=>{var ne;return((ne=H.planExecution)==null?void 0:ne.currentPlanId)===i.currentPlanId&&H.type==="assistant"});let p;if(a!==-1)p=w.value[a],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",i.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",i.currentPlanId),console.log("[ChatComponent] Current messages:",w.value.map(ne=>{var Te;return{type:ne.type,planId:(Te=ne.planExecution)==null?void 0:Te.currentPlanId,content:ne.content.substring(0,50)}}));let H=-1;for(let ne=w.value.length-1;ne>=0;ne--)if(w.value[ne].type==="assistant"){H=ne;break}if(H!==-1)p=w.value[H],p.planExecution||(p.planExecution={}),p.planExecution.currentPlanId=i.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",i.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(p.planExecution||(p.planExecution={}),p.planExecution=JSON.parse(JSON.stringify(i)),!i.steps||i.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),i.completed){delete p.thinking;const H=i.summary??i.result??i.message??_("chat.executionCompleted");p.content=Y(H),console.log("[ChatComponent] Set simple response content:",p.content)}else i.title&&(p.thinking=`${_("chat.thinkingExecuting",{title:i.title})}`);return}delete p.thinking;const S=i.steps.map(H=>typeof H=="string"?H:typeof H=="object"&&H!==null&&(H.title||H.description)||_("chat.step"));if(p.planExecution&&(p.planExecution.steps=S),i.agentExecutionSequence&&i.agentExecutionSequence.length>0){console.log("[ChatComponent] Found execution sequence data, count:",i.agentExecutionSequence.length),P(p,i);const H=i.currentStepIndex??0;if(H>=0&&H<i.agentExecutionSequence.length){const Te=i.agentExecutionSequence[H].thinkActSteps;if(Te&&Te.length>0){const Fe=Te[Te.length-1];if(Fe.thinkOutput){const ze=Fe.thinkOutput.length>150?Fe.thinkOutput.substring(0,150)+"...":Fe.thinkOutput;p.thinking=`${_("chat.thinking")}: ${ze}`}}}}else if(p.planExecution){const H=p.planExecution.currentStepIndex??0,ne=(W=p.planExecution.steps)==null?void 0:W[H],Te=typeof ne=="string"?ne:"";p.thinking=`${_("chat.thinkingExecuting",{title:Te})}`}if(i.userInputWaitState&&p.planExecution?(console.log("[ChatComponent] User input required:",i.userInputWaitState),p.planExecution.userInputWaitState||(p.planExecution.userInputWaitState={}),p.planExecution.userInputWaitState={message:i.userInputWaitState.message??"",formDescription:i.userInputWaitState.formDescription??"",formInputs:((re=i.userInputWaitState.formInputs)==null?void 0:re.map(H=>({label:H.label,value:H.value||"",type:H.type||"text",required:H.required==="true"||H.required===!0,placeholder:H.placeholder||"",name:H.name||H.label,options:H.options||void 0})))??[]},O[oe=p.id]??(O[oe]={}),p.thinking=_("input.waiting")):(te=p.planExecution)!=null&&te.userInputWaitState&&delete p.planExecution.userInputWaitState,i.completed??i.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete p.thinking;let H="";i.summary?H=i.summary:i.result?H=i.result:H=_("chat.executionCompleted"),p.content=q(H),console.log("[ChatComponent] Updated completed message:",p.content)}_e(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},Y=r=>r?r.includes("I ")||r.includes("you")||r.includes("hello")||r.includes("can")||r.includes("I")||r.includes("you")||r.includes("can")?r:r.length<10?`${r}! ${_("chat.anythingElse")}`:r.length<50?`${_("chat.okayDone",{text:r})}. ${_("chat.ifOtherQuestions")}`:`${r}

${_("chat.hopeHelpful")} ${_("chat.anythingElse")}`:_("chat.defaultResponse"),q=r=>r?`${r}`:`${_("chat.executionCompleted")}! ${_("chat.anythingElse")}`,K=r=>{console.log("[ChatComponent] Plan completed with rootPlanId:",r);const i=we.getCachedPlanRecord(r);if(!i){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",r);return}if(console.log("[ChatComponent] Plan details:",i),i.rootPlanId){const a=w.value.findIndex(p=>{var S;return((S=p.planExecution)==null?void 0:S.currentPlanId)===i.rootPlanId});if(a!==-1){const p=w.value[a];delete p.thinking;let W=i.summary??i.result??_("chat.executionCompleted");!W.includes("I")&&!W.includes("you")&&(W.includes("success")||W.includes("complete")||W.includes("finished")?W=`${_("chat.great")}${W}. ${_("chat.ifOtherHelp")}`:W=`${_("chat.completedRequest",{result:W})}`),p.content=W,console.log("[ChatComponent] Updated completed message:",p.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",i.rootPlanId)}},k=r=>{V.value=!1,w.value[w.value.length-1]={id:Date.now().toString(),type:"assistant",content:r,timestamp:new Date}},v=r=>{if(!r)return"";let i=r.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return i=i.replace(/(<br><br>)/g,"</p><p>"),i.includes("</p><p>")&&(i=`<p>${i}</p>`),i},y=async r=>{var i;if(!((i=r.planExecution)!=null&&i.currentPlanId)||!r.planExecution.userInputWaitState){console.error("[ChatComponent] Missing planExecution.currentPlanId or userInputWaitState");return}try{const a={},p=r.planExecution.userInputWaitState.formInputs;p&&p.length>0?Object.entries(O[r.id]).forEach(([W,re])=>{var H;const oe=parseInt(W,10),te=((H=p[oe])==null?void 0:H.label)||`input_${W}`;a[te]=re}):a.genericInput=r.genericInput??"",console.log("[ChatComponent] Submitting user input:",a);const S=await Ke.submitFormInput(r.planExecution.currentPlanId,a);delete r.planExecution.userInputWaitState,delete r.genericInput,delete O[r.id],u.startPolling(),console.log("[ChatComponent] User input submitted successfully:",S)}catch(a){console.error("[ChatComponent] User input submission failed:",a),alert(`${_("common.submitFailed")}: ${(a==null?void 0:a.message)||_("common.unknownError")}`)}};Ce(()=>l.initialPrompt,(r,i)=>{console.log("[ChatComponent] initialPrompt changed from:",i,"to:",r),r&&typeof r=="string"&&r.trim()&&r!==i&&(console.log("[ChatComponent] Processing changed initial prompt:",r),_e(()=>{L({input:r})}))},{immediate:!1}),De(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),we.setEventCallbacks({onPlanUpdate:ee,onPlanCompleted:K,onDialogRoundStart:B,onChatInputUpdateState:r=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",r)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")},onPlanError:k}),_e(()=>{D()}),l.initialPrompt&&typeof l.initialPrompt=="string"&&l.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",l.initialPrompt),_e(()=>{L({input:l.initialPrompt})}))}),Ae(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),T(),F.value&&clearInterval(F.value),u.cleanup(),Object.keys(O).forEach(r=>delete O[r])});const X=async()=>{if(Ee.selectMemoryId){const r=await Oe.getMemory(Ee.selectMemoryId);w.value=[],r.messages.map(i=>{i.messageType.toLowerCase()==="user"&&g("user",i.text),i.messageType.toLowerCase()==="assistant"&&g("assistant",i.text)}),d()}},ue=()=>{w.value=[]},ye=r=>r?Array.isArray(r)?r:typeof r=="string"?r.split(",").map(i=>i.trim()).filter(i=>i.length>0):[]:[],$e=r=>typeof r=="boolean"?r:typeof r=="string"?r==="true":!1;return o({handleSendMessage:L,handlePlanUpdate:ee,handlePlanCompleted:K,handleDialogRoundStart:B,addMessage:g,handlePlanError:k,showMemory:X,newChat:ue}),(r,i)=>(c(),h("div",bl,[e("div",{class:"messages",ref_key:"messagesRef",ref:x},[(c(!0),h(ge,null,Se(w.value,a=>{var p,S,W,re,oe,te,H,ne,Te;return c(),h("div",{key:a.id,class:ie(["message",{user:a.type==="user",assistant:a.type==="assistant"}])},[e("div",yl,[a.type==="user"?(c(),h("div",$l,s(a.content),1)):(c(),h("div",_l,[a.thinking||((p=a.planExecution)==null?void 0:p.progress)!==void 0||(((W=(S=a.planExecution)==null?void 0:S.steps)==null?void 0:W.length)??0)>0?(c(),h("div",kl,[e("div",Sl,[e("div",wl,[f(n($),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Cl,s(r.$t("chat.thinkingLabel")),1)]),e("div",Pl,[a.thinking?(c(),h("div",Tl,[f(n($),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,s(a.thinking),1)])):N("",!0),((re=a.planExecution)==null?void 0:re.progress)!==void 0?(c(),h("div",El,[e("div",Il,[e("div",{class:"progress-fill",style:Ve({width:a.planExecution.progress+"%"})},null,4)]),e("span",xl,s(a.planExecution.progressText??r.$t("chat.processing")+"..."),1)])):N("",!0),(((te=(oe=a.planExecution)==null?void 0:oe.steps)==null?void 0:te.length)??0)>0?(c(),h("div",Dl,[e("h4",Rl,s(r.$t("chat.stepExecutionDetails")),1),(c(!0),h(ge,null,Se((H=a.planExecution)==null?void 0:H.steps,(Fe,ae)=>{var ze,Xe,Qe,Ye,Ze,et,tt,ot,nt,st,at,lt,it,rt,ct,dt,ut,pt,ht;return c(),h("div",{key:ae,class:ie(["ai-section",{running:R(a,ae)==="RUNNING",completed:R(a,ae)==="FINISHED",pending:R(a,ae)==="IDLE"}]),onClick:he(J=>z(a,ae),["stop"])},[e("div",Al,[e("span",Ul,s(R(a,ae)==="FINISHED"?"✓":R(a,ae)==="RUNNING"?"▶":"○"),1),e("span",Nl,s(Fe||`${r.$t("chat.step")} ${ae+1}`),1),R(a,ae)==="RUNNING"?(c(),h("span",Fl,s(r.$t("chat.status.executing")),1)):R(a,ae)==="FINISHED"?(c(),h("span",Ll,s(r.$t("chat.status.completed")),1)):(c(),h("span",ql,s(r.$t("chat.status.pending")),1))]),a.stepActions&&a.stepActions[ae]?(c(),h("div",Bl,[e("div",Vl,[e("span",jl,s(((ze=a.stepActions[ae])==null?void 0:ze.status)==="current"?"🔄":((Xe=a.stepActions[ae])==null?void 0:Xe.status)==="completed"?"✓":"⏳"),1),e("strong",null,s((Qe=a.stepActions[ae])==null?void 0:Qe.actionDescription),1)]),(Ye=a.stepActions[ae])!=null&&Ye.toolParameters?(c(),h("div",Ol,[i[0]||(i[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",Wl,s(r.$t("common.parameters"))+":",1),e("pre",zl,s((Ze=a.stepActions[ae])==null?void 0:Ze.toolParameters),1)])):N("",!0),(et=a.stepActions[ae])!=null&&et.thinkOutput?(c(),h("div",Hl,[e("div",Jl,[i[1]||(i[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",Gl,s(r.$t("chat.thinkingOutput"))+":",1)]),e("div",Kl,[e("pre",Xl,s((tt=a.stepActions[ae])==null?void 0:tt.thinkOutput),1)])])):N("",!0)])):N("",!0),((ot=j(a,ae))==null?void 0:ot.length)>0?(c(),h("div",Ql,[e("div",Yl,[f(n($),{icon:"carbon:tree-view",class:"sub-plan-icon"}),e("span",Zl,s(r.$t("rightPanel.subPlan")),1)]),e("div",ei,[(c(!0),h(ge,null,Se(j(a,ae),(J,de)=>(c(),h("div",{key:`sub-${ae}-${de}`,class:ie(["sub-plan-step-item",{completed:se(a,ae,de)==="completed",current:se(a,ae,de)==="current",pending:se(a,ae,de)==="pending"}]),onClick:he(ve=>be(a,ae,de),["stop"])},[e("div",oi,[e("span",ni,s(se(a,ae,de)==="completed"?"✓":se(a,ae,de)==="current"?"▶":"○"),1),e("span",si,s(de+1),1)]),e("div",ai,[e("span",li,s(J),1),e("span",ii,s(r.$t("rightPanel.subStep")),1)])],10,ti))),128))])])):N("",!0),(nt=a.planExecution)!=null&&nt.userInputWaitState&&R(a,ae)==="RUNNING"?(c(),h("div",ri,[e("p",ci,s(((at=(st=a.planExecution)==null?void 0:st.userInputWaitState)==null?void 0:at.message)??r.$t("chat.userInput.message")),1),(it=(lt=a.planExecution)==null?void 0:lt.userInputWaitState)!=null&&it.formDescription?(c(),h("p",di,s((ct=(rt=a.planExecution)==null?void 0:rt.userInputWaitState)==null?void 0:ct.formDescription),1)):N("",!0),e("form",{onSubmit:he(J=>y(a),["prevent"]),class:"user-input-form"},[(ut=(dt=a.planExecution)==null?void 0:dt.userInputWaitState)!=null&&ut.formInputs&&a.planExecution.userInputWaitState.formInputs.length>0?(c(),h("div",pi,[(c(!0),h(ge,null,Se((ht=(pt=a.planExecution)==null?void 0:pt.userInputWaitState)==null?void 0:ht.formInputs,(J,de)=>(c(),h("div",{key:de,class:"form-group"},[e("label",{for:`form-input-${J.label.replace(/\W+/g,"_")}`},s(J.label)+s($e(J.required)?" *":"")+": ",9,hi),!J.type||J.type==="text"?ce((c(),h("input",{key:0,type:"text",id:`form-input-${J.label.replace(/\W+/g,"_")}`,name:J.label,placeholder:J.placeholder||"",required:$e(J.required),"onUpdate:modelValue":ve=>O[a.id][de]=ve,class:"form-input"},null,8,mi)),[[pe,O[a.id][de]]]):J.type==="email"?ce((c(),h("input",{key:1,type:"email",id:`form-input-${J.label.replace(/\W+/g,"_")}`,name:J.label,placeholder:J.placeholder||"",required:$e(J.required),"onUpdate:modelValue":ve=>O[a.id][de]=ve,class:"form-input"},null,8,vi)),[[pe,O[a.id][de]]]):J.type==="number"?ce((c(),h("input",{key:2,type:"number",id:`form-input-${J.label.replace(/\W+/g,"_")}`,name:J.label,placeholder:J.placeholder||"",required:$e(J.required),"onUpdate:modelValue":ve=>O[a.id][de]=ve,class:"form-input"},null,8,gi)),[[pe,O[a.id][de]]]):J.type==="password"?ce((c(),h("input",{key:3,type:"password",id:`form-input-${J.label.replace(/\W+/g,"_")}`,name:J.label,placeholder:J.placeholder||"",required:$e(J.required),"onUpdate:modelValue":ve=>O[a.id][de]=ve,class:"form-input"},null,8,fi)),[[pe,O[a.id][de]]]):J.type==="textarea"?ce((c(),h("textarea",{key:4,id:`form-input-${J.label.replace(/\W+/g,"_")}`,name:J.label,placeholder:J.placeholder||"",required:$e(J.required),"onUpdate:modelValue":ve=>O[a.id][de]=ve,class:"form-input form-textarea",rows:"3"},null,8,bi)),[[pe,O[a.id][de]]]):J.type==="select"&&J.options?ce((c(),h("select",{key:5,id:`form-input-${J.label.replace(/\W+/g,"_")}`,name:J.label,required:$e(J.required),"onUpdate:modelValue":ve=>O[a.id][de]=ve,class:"form-input form-select"},[e("option",$i,s(r.$t("selectCommon.pleaseSelect")),1),(c(!0),h(ge,null,Se(ye(J.options),ve=>(c(),h("option",{key:ve,value:ve},s(ve),9,_i))),128))],8,yi)),[[vt,O[a.id][de]]]):ce((c(),h("input",{key:6,type:"text",id:`form-input-${J.label.replace(/\W+/g,"_")}`,name:J.label,placeholder:J.placeholder||"",required:$e(J.required),"onUpdate:modelValue":ve=>O[a.id][de]=ve,class:"form-input"},null,8,ki)),[[pe,O[a.id][de]]])]))),128))])):(c(),h("div",Si,[e("label",wi,s(r.$t("common.input"))+":",1),ce(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":J=>a.genericInput=J,class:"form-input"},null,8,Ci),[[pe,a.genericInput]])])),e("button",Pi,s(r.$t("chat.userInput.submit")),1)],40,ui)])):N("",!0)],10,Ml)}),128))])):!a.content&&(a.thinking||((ne=a.planExecution)==null?void 0:ne.progress)!==void 0&&(((Te=a.planExecution)==null?void 0:Te.progress)??0)<100)?(c(),h("div",Ti,[e("div",Ei,[i[2]||(i[2]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,s(a.thinking??r.$t("chat.thinkingProcessing")),1)])])):N("",!0)])])):N("",!0),e("div",Ii,[e("div",xi,[e("div",Di,[f(n($),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Ri,s(r.$t("chat.botName")),1)]),e("div",Mi,[a.content?(c(),h("div",Ai,[e("div",{class:"response-text",innerHTML:v(a.content)},null,8,Ui)])):(c(),h("div",Ni,[e("div",Fi,[i[3]||(i[3]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Li,s(r.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),V.value?(c(),h("div",qi,[e("div",Bi,[e("div",Vi,[e("div",ji,[e("div",Oi,[e("div",Wi,[f(n($),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",zi,s(r.$t("chat.thinkingLabel")),1)]),e("div",Hi,[e("div",Ji,[e("div",Gi,[i[4]||(i[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,s(r.$t("chat.thinking")),1)])])])]),e("div",Ki,[e("div",Xi,[e("div",Qi,[f(n($),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Yi,s(r.$t("chat.botName")),1)]),e("div",Zi,[e("div",er,[e("div",tr,[i[5]||(i[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",or,s(r.$t("chat.thinkingResponse")),1)])])])])])])])):N("",!0)],512),G.value?(c(),h("div",{key:0,class:"scroll-to-bottom-btn",onClick:d,title:r.$t("chat.scrollToBottom")},[f(n($),{icon:"carbon:chevron-down"})],8,nr)):N("",!0)]))}}),ar=xe(sr,[["__scopeId","data-v-1a74d5ba"]]),lr={class:"input-area"},ir={class:"input-container"},rr=["title"],cr=["placeholder","disabled"],dr=["title"],ur=["disabled","title"],pr=Ie({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1},initialValue:{default:""}},emits:["send","clear","update-state","plan-mode-clicked"],setup(A,{expose:o,emit:t}){const{t:l}=Me(),m=A,_=t,u=C(),x=C(""),V=ke(()=>m.placeholder||l("input.placeholder")),w=C(V.value),F=ke(()=>!!m.disabled),G=()=>{_e(()=>{u.value&&(u.value.style.height="auto",u.value.style.height=Math.min(u.value.scrollHeight,120)+"px")})},O=d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),g())},g=()=>{if(!x.value.trim()||F.value)return;const d={input:x.value.trim(),memoryId:Ee.selectMemoryId};_("send",d),Q()},M=()=>{_("plan-mode-clicked")},Q=()=>{x.value="",G(),_("clear")},Z=(d,I)=>{I&&(w.value=d?I:l("input.waiting")),_("update-state",d,I)},b=d=>{x.value=d,G()},U=()=>x.value.trim();return Ce(()=>m.initialValue,d=>{d&&d.trim()&&(x.value=d,G())},{immediate:!0}),o({clearInput:Q,updateState:Z,setInputValue:b,getQuery:U,focus:()=>{var d;return(d=u.value)==null?void 0:d.focus()}}),De(()=>{}),Ae(()=>{}),(d,I)=>(c(),h("div",lr,[e("div",ir,[e("button",{class:"attach-btn",title:d.$t("input.attachFile")},[f(n($),{icon:"carbon:attachment"})],8,rr),ce(e("textarea",{"onUpdate:modelValue":I[0]||(I[0]=D=>x.value=D),ref_key:"inputRef",ref:u,class:"chat-input",placeholder:w.value,disabled:F.value,onKeydown:O,onInput:G},null,40,cr),[[pe,x.value]]),e("button",{class:"plan-mode-btn",title:d.$t("input.planMode"),onClick:M},[f(n($),{icon:"carbon:document"}),le(" "+s(d.$t("input.planMode")),1)],8,dr),e("button",{class:"send-button",disabled:!x.value.trim()||F.value,onClick:g,title:d.$t("input.send")},[f(n($),{icon:"carbon:send-alt"}),le(" "+s(d.$t("input.send")),1)],8,ur)])]))}}),hr=xe(pr,[["__scopeId","data-v-a71ca865"]]);class Le{static async getAllCronTasks(){try{const o=await fetch(this.BASE_URL);return await(await this.handleResponse(o)).json()}catch(o){throw console.error("Failed to get cron tasks:",o),o}}static async getCronTaskById(o){try{const t=await fetch(`${this.BASE_URL}/${o}`);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get cron task by id:",t),t}}static async createCronTask(o){try{const t=await fetch(this.BASE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to create cron task:",t),t}}static async updateCronTask(o,t){try{const l=await fetch(`${this.BASE_URL}/${o}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return await(await this.handleResponse(l)).json()}catch(l){throw console.error("Failed to update cron task:",l),l}}static async updateTaskStatus(o,t){try{const l=await fetch(`${this.BASE_URL}/${o}/status?status=${t}`,{method:"PUT"});await this.handleResponse(l)}catch(l){throw console.error("Failed to update task status:",l),l}}static async deleteCronTask(o){try{const t=await fetch(`${this.BASE_URL}/${o}`,{method:"DELETE"});await this.handleResponse(t)}catch(t){throw console.error("Failed to delete cron task:",t),t}}static async handleResponse(o){if(!o.ok)try{const t=await o.json();throw new Error(t.message||`API request failed: ${o.status}`)}catch{throw new Error(`API request failed: ${o.status} ${o.statusText}`)}return o}}fe(Le,"BASE_URL","/api/cron-tasks");const qe={validateCronExpression(A){const o=A.trim().split(/\s+/);return o.length>=5&&o.length<=6},formatTime(A){return new Date(A).toLocaleString()},async saveTask(A){try{let o;return A.id?o=await Le.updateCronTask(Number(A.id),A):o=await Le.createCronTask(A),o}catch(o){throw console.error("Failed to save cron task:",o),o}},async deleteTask(A){try{await Le.deleteCronTask(String(A))}catch(o){throw console.error("Failed to delete cron task:",o),o}},async toggleTaskStatus(A){if(!A.id)throw new Error("Task ID is required");const o=A.status===0?1:0;return await Le.updateCronTask(Number(A.id),{...A,status:o})},prepareTaskExecution(A){return A.planTemplateId?{useTemplate:!0,planData:{title:A.cronName||"Scheduled Task Execution",planData:{id:A.planTemplateId,planTemplateId:A.planTemplateId,planId:A.planTemplateId},params:A.executionParams||void 0}}:{useTemplate:!1,taskContent:A.planDesc||A.cronName||""}}},mr={class:"modal-header"},vr={class:"header-actions"},gr={class:"status-switch"},fr={class:"status-label"},br={class:"toggle-switch"},yr=["checked"],$r={class:"modal-content"},_r={class:"form-group"},kr={class:"form-label"},Sr=["placeholder"],wr={class:"form-group"},Cr={class:"form-label"},Pr=["placeholder"],Tr={class:"form-help"},Er={class:"form-group"},Ir={class:"form-label"},xr=["placeholder"],Dr={class:"form-group"},Rr={class:"form-label"},Mr={class:"template-toggle"},Ar={key:0,class:"template-selector"},Ur={value:""},Nr=["value"],Fr={class:"form-help"},Lr={key:0,class:"form-group"},qr={class:"time-info"},Br={class:"time-label"},Vr={class:"time-value"},jr={key:1,class:"form-group"},Or={class:"time-info"},Wr={class:"time-label"},zr={class:"time-value"},Hr={class:"modal-footer"},Jr=["disabled"],Gr=Ie({__name:"TaskDetailModal",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","save"],setup(A,{emit:o}){const t=A,l=o,m=C(!1),_=C([]),u=C({cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""});De(async()=>{try{const g=await We.getAllPlanTemplates();g&&g.templates&&(_.value=g.templates.map(M=>({id:M.id,name:M.title||"Unnamed Template"})))}catch(g){console.error("Failed to get template list:",g)}});const V=g=>{g.target===g.currentTarget&&l("update:modelValue",!1)},w=()=>{u.value.linkTemplate=!1,u.value.templateId="",u.value.planTemplateId=""},F=()=>u.value.cronName.trim()?u.value.cronTime.trim()?qe.validateCronExpression(u.value.cronTime)?u.value.planDesc.trim()?u.value.linkTemplate&&!u.value.templateId?(alert("Please select a plan template"),!1):!0:(alert("Task description cannot be empty"),!1):(alert("Invalid Cron expression format, should be 5-6 parts separated by spaces"),!1):(alert("Cron expression cannot be empty"),!1):(alert("Task name cannot be empty"),!1),G=g=>qe.formatTime(g),O=async()=>{var g;if(F()){m.value=!0;try{const M={...u.value,...((g=t.task)==null?void 0:g.id)!==void 0&&{id:t.task.id},cronName:u.value.cronName.trim(),cronTime:u.value.cronTime.trim(),planDesc:u.value.planDesc.trim(),status:u.value.status,planTemplateId:u.value.linkTemplate&&u.value.templateId||""};l("save",M)}finally{m.value=!1}}};return Ce(()=>t.task,g=>{if(g){const M=g.templateId||g.planTemplateId||"";u.value={cronName:g.cronName||"",cronTime:g.cronTime||"",planDesc:g.planDesc||"",status:g.status??1,linkTemplate:!!M,templateId:M,planTemplateId:M}}else u.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""}},{immediate:!0}),Ce(()=>t.modelValue,g=>{g||(u.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""})}),(g,M)=>(c(),me(je,{to:"body"},[f(Be,{name:"modal"},{default:Re(()=>{var Q,Z,b;return[g.modelValue?(c(),h("div",{key:0,class:"modal-overlay",onClick:V},[e("div",{class:"modal-container",onClick:M[8]||(M[8]=he(()=>{},["stop"]))},[e("div",mr,[e("h3",null,s(g.$t("cronTask.taskDetail")),1),e("div",vr,[e("div",gr,[e("span",fr,s(g.$t("cronTask.taskStatus")),1),e("label",br,[e("input",{type:"checkbox",checked:u.value.status===0,onChange:M[0]||(M[0]=U=>u.value.status=u.value.status===0?1:0)},null,40,yr),M[9]||(M[9]=e("span",{class:"toggle-slider"},null,-1))])]),e("button",{class:"close-btn",onClick:M[1]||(M[1]=U=>g.$emit("update:modelValue",!1))},[f(n($),{icon:"carbon:close"})])])]),e("div",$r,[e("form",{onSubmit:he(O,["prevent"]),class:"task-form"},[e("div",_r,[e("label",kr,s(g.$t("cronTask.taskName")),1),ce(e("input",{"onUpdate:modelValue":M[2]||(M[2]=U=>u.value.cronName=U),type:"text",class:"form-input",placeholder:g.$t("cronTask.taskNamePlaceholder"),required:""},null,8,Sr),[[pe,u.value.cronName]])]),e("div",wr,[e("label",Cr,s(g.$t("cronTask.cronExpression")),1),ce(e("input",{"onUpdate:modelValue":M[3]||(M[3]=U=>u.value.cronTime=U),type:"text",class:"form-input",placeholder:g.$t("cronTask.cronExpressionPlaceholder"),required:""},null,8,Pr),[[pe,u.value.cronTime]]),e("div",Tr,s(g.$t("cronTask.cronExpressionHelp")),1)]),e("div",Er,[e("label",Ir,s(g.$t("cronTask.taskDescription")),1),ce(e("textarea",{"onUpdate:modelValue":M[4]||(M[4]=U=>u.value.planDesc=U),class:"form-textarea",placeholder:g.$t("cronTask.taskDescriptionPlaceholder"),rows:"4",required:""},null,8,xr),[[pe,u.value.planDesc]])]),e("div",Dr,[e("label",Rr,s(g.$t("cronTask.planTemplate")),1),e("div",Mr,[e("button",{type:"button",class:ie(["template-btn",u.value.linkTemplate?"active":""]),onClick:M[5]||(M[5]=U=>u.value.linkTemplate=!0)},[f(n($),{icon:"carbon:checkmark"}),le(" "+s(g.$t("cronTask.linkTemplate")),1)],2),e("button",{type:"button",class:ie(["template-btn",u.value.linkTemplate?"":"active"]),onClick:w},[f(n($),{icon:"carbon:close"}),le(" "+s(g.$t("cronTask.noTemplate")),1)],2)]),u.value.linkTemplate?(c(),h("div",Ar,[ce(e("select",{"onUpdate:modelValue":M[6]||(M[6]=U=>u.value.templateId=U),class:"form-select"},[e("option",Ur,s(g.$t("cronTask.selectTemplate")),1),(c(!0),h(ge,null,Se(_.value,U=>(c(),h("option",{key:U.id,value:U.id},s(U.name),9,Nr))),128))],512),[[vt,u.value.templateId]]),e("div",Fr,s(g.$t("cronTask.templateHelpText")),1)])):N("",!0)]),(Q=g.task)!=null&&Q.createTime?(c(),h("div",Lr,[e("div",qr,[e("span",Br,s(g.$t("cronTask.createTime"))+":",1),e("span",Vr,s(G(g.task.createTime)),1)])])):N("",!0),(Z=g.task)!=null&&Z.updateTime?(c(),h("div",jr,[e("div",Or,[e("span",Wr,s(g.$t("cronTask.updateTime"))+":",1),e("span",zr,s(G(g.task.updateTime)),1)])])):N("",!0)],32)]),e("div",Hr,[e("button",{type:"button",class:"cancel-btn",onClick:M[7]||(M[7]=U=>g.$emit("update:modelValue",!1))},s(g.$t("common.cancel")),1),e("button",{type:"button",class:"save-btn",onClick:O,disabled:m.value},[m.value?(c(),me(n($),{key:0,icon:"carbon:loading",class:"loading-icon"})):N("",!0),le(" "+s((b=t.task)!=null&&b.id?g.$t("common.save"):g.$t("common.create")),1)],8,Jr)])])])):N("",!0)]}),_:1})]))}}),Kr=xe(Gr,[["__scopeId","data-v-5b32448e"]]),Xr={class:"modal-header"},Qr={class:"header-actions"},Yr={class:"modal-content"},Zr={key:0,class:"loading-container"},ec={key:1,class:"empty-container"},tc={key:2,class:"task-list"},oc=["onClick"],nc={class:"task-main"},sc={class:"task-info"},ac={class:"task-header"},lc={class:"task-name"},ic={class:"task-description"},rc={class:"task-time"},cc=["onClick"],dc=["onClick","disabled","title"],uc=["onClick","title"],pc={class:"dropdown-menu"},hc=["onClick"],mc=["onClick","disabled"],vc=["onClick","disabled"],gc={class:"confirm-header"},fc={class:"confirm-content"},bc={class:"confirm-actions"},yc=["disabled"],$c={class:"confirm-header"},_c={class:"confirm-content"},kc={class:"create-options"},Sc={class:"option-content"},wc={class:"option-title"},Cc={class:"option-desc"},Pc={class:"option-content"},Tc={class:"option-title"},Ec={class:"option-desc"},Ic={class:"confirm-actions"},xc=Ie({__name:"index",props:{modelValue:{type:Boolean,required:!0}},emits:["update:modelValue"],setup(A,{emit:o}){const t=gt(),l=ft(),m=wt(),{t:_}=Me(),u=A,x=o,V=C([]),w=C(!1),F=C(null),G=C(null),O=C(null),g=C(null),M=C(!1),Q=C(null),Z=C(!1),b=C(null),U=C(!1),d=k=>{k.target===k.currentTarget&&x("update:modelValue",!1)},I=async()=>{w.value=!0;try{V.value=await Le.getAllCronTasks()}catch(k){console.error("Failed to load cron tasks:",k),m.error(`Failed to load tasks: ${k instanceof Error?k.message:String(k)}`)}finally{w.value=!1}},D=async k=>{F.value=k;try{const v=V.value.find(ue=>ue.id===k);if(!v){console.error("Task not found:",k);return}x("update:modelValue",!1);const y=Date.now().toString();await t.push({name:"direct",params:{id:y}}),await new Promise(ue=>setTimeout(ue,100));const X=qe.prepareTaskExecution(v);X.useTemplate&&X.planData?l.emitPlanExecutionRequested(X.planData):X.taskContent&&l.setTask(X.taskContent)}catch(v){console.error("Failed to execute task:",v),m.error(`Execution failed: ${v instanceof Error?v.message:String(v)}`)}finally{F.value=null}},T=k=>{Q.value={...k},M.value=!0,g.value=null},L=async k=>{try{await qe.saveTask(k),await I(),M.value=!1,m.success("Task saved successfully")}catch(v){console.error("Failed to save task:",v),m.error(`Save failed: ${v instanceof Error?v.message:String(v)}`)}},R=k=>{b.value=k,Z.value=!0},z=async()=>{var k;if((k=b.value)!=null&&k.id){G.value=b.value.id;try{await qe.deleteTask(b.value.id),await I(),Z.value=!1,b.value=null,m.success("Task deleted successfully")}catch(v){console.error("Failed to delete task:",v),m.error(`Delete failed: ${v instanceof Error?v.message:String(v)}`)}finally{G.value=null}}},j=()=>{Z.value=!1,b.value=null},se=k=>{g.value=g.value===k?null:k},be=async k=>{if(k.id){O.value=k.id;try{await qe.toggleTaskStatus(k),await I(),g.value=null,m.success(`Task ${k.status===0?"disabled":"enabled"} successfully`)}catch(v){console.error("Failed to toggle task status:",v),m.error(`Status toggle failed: ${v instanceof Error?v.message:String(v)}`)}finally{O.value=null}}},P=async k=>{try{await navigator.clipboard.writeText(k),m.success("Cron expression copied successfully")}catch(v){m.error(`Copy failed: ${v instanceof Error?v.message:String(v)}`)}},B=()=>{U.value=!0},ee=()=>{U.value=!1;try{x("update:modelValue",!1);const k=_("cronTask.template");l.setTaskToInput(k);const v=Date.now().toString();t.push({name:"direct",params:{id:v}})}catch(k){console.error("Error in createWithJmanus:",k),m.error(`Creation failed: ${k instanceof Error?k.message:String(k)}`)}},Y=()=>{U.value=!1,Q.value={cronName:"",cronTime:"",planDesc:"",status:0,planTemplateId:""},M.value=!0},q=()=>{U.value=!1},K=k=>{const v=k.target;!v.closest(".action-dropdown")&&!v.closest(".dropdown-menu")&&(g.value=null)};return De(()=>{document.addEventListener("click",K,!0)}),Ae(()=>{document.removeEventListener("click",K,!0)}),Ce(()=>u.modelValue,k=>{k&&I()}),(k,v)=>(c(),h(ge,null,[(c(),me(je,{to:"body"},[f(Be,{name:"modal"},{default:Re(()=>[A.modelValue?(c(),h("div",{key:0,class:"modal-overlay",onClick:d},[e("div",{class:"modal-container",onClick:v[3]||(v[3]=he(()=>{},["stop"]))},[e("div",Xr,[e("h3",null,s(k.$t("cronTask.title")),1),e("div",Qr,[e("button",{class:"add-task-btn",onClick:[B,v[0]||(v[0]=he(()=>{},["stop"]))]},[f(n($),{icon:"carbon:add"}),le(" "+s(k.$t("cronTask.addTask")),1)]),e("button",{class:"close-btn",onClick:v[1]||(v[1]=y=>k.$emit("update:modelValue",!1))},[f(n($),{icon:"carbon:close"})])])]),e("div",Yr,[w.value?(c(),h("div",Zr,[f(n($),{icon:"carbon:loading",class:"loading-icon"}),e("span",null,s(k.$t("common.loading")),1)])):V.value.length===0?(c(),h("div",ec,[f(n($),{icon:"carbon:time",class:"empty-icon"}),e("span",null,s(k.$t("cronTask.noTasks")),1)])):(c(),h("div",tc,[(c(!0),h(ge,null,Se(V.value,y=>(c(),h("div",{key:y.id||"",class:"task-item",onClick:X=>T(y)},[e("div",nc,[e("div",sc,[e("div",ac,[e("div",lc,s(y.cronName),1),e("div",{class:ie(["task-status-badge",y.status===0?"active":"inactive"])},[f(n($),{icon:y.status===0?"carbon:checkmark-filled":"carbon:pause-filled"},null,8,["icon"]),e("span",null,s(y.status===0?k.$t("cronTask.active"):k.$t("cronTask.inactive")),1)],2)]),e("div",ic,s(y.planDesc),1),e("div",rc,[f(n($),{icon:"carbon:time"}),e("span",{class:"cron-readable",style:{cursor:"pointer"},onClick:he(X=>P(y.cronTime),["stop"])},s(y.cronTime),9,cc)])])]),e("div",{class:"task-actions",onClick:v[2]||(v[2]=he(()=>{},["stop"]))},[e("button",{class:"action-btn execute-btn",onClick:X=>D(y.id),disabled:F.value===y.id,title:k.$t("cronTask.executeOnce")},[f(n($),{icon:F.value===y.id?"carbon:loading":"carbon:play-filled"},null,8,["icon"]),le(" "+s(k.$t("cronTask.executeOnce")),1)],8,dc),e("div",{class:ie(["action-dropdown",{active:g.value===y.id}])},[e("button",{class:"action-btn dropdown-btn",onClick:X=>se(y.id),title:k.$t("cronTask.operations")},[f(n($),{icon:"carbon:overflow-menu-horizontal"}),le(" "+s(k.$t("cronTask.operations")),1)],8,uc),ce(e("div",pc,[e("button",{class:"dropdown-item edit-btn",onClick:X=>T(y)},[f(n($),{icon:"carbon:edit"}),le(" "+s(k.$t("cronTask.edit")),1)],8,hc),e("button",{class:"dropdown-item toggle-btn",onClick:X=>be(y),disabled:O.value===y.id},[f(n($),{icon:O.value===y.id?"carbon:loading":y.status===0?"carbon:pause-filled":"carbon:play-filled"},null,8,["icon"]),le(" "+s(y.status===0?k.$t("cronTask.disable"):k.$t("cronTask.enable")),1)],8,mc),e("button",{class:"dropdown-item delete-btn",onClick:X=>R(y),disabled:G.value===y.id},[f(n($),{icon:G.value===y.id?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),le(" "+s(k.$t("cronTask.delete")),1)],8,vc)],512),[[_t,g.value===y.id]])],2)])],8,oc))),128))]))])])])):N("",!0)]),_:1})])),f(Kr,{modelValue:M.value,"onUpdate:modelValue":v[4]||(v[4]=y=>M.value=y),task:Q.value,onSave:L},null,8,["modelValue","task"]),(c(),me(je,{to:"body"},[f(Be,{name:"modal"},{default:Re(()=>{var y,X,ue,ye;return[Z.value?(c(),h("div",{key:0,class:"modal-overlay",onClick:j},[e("div",{class:"confirm-modal",onClick:v[5]||(v[5]=he(()=>{},["stop"]))},[e("div",gc,[f(n($),{icon:"carbon:warning",class:"warning-icon"}),e("h3",null,s(k.$t("cronTask.deleteConfirm")),1)]),e("div",fc,[e("p",null,s(k.$t("cronTask.deleteConfirmMessage",{taskName:((y=b.value)==null?void 0:y.cronName)||((X=b.value)==null?void 0:X.planDesc)||""})),1)]),e("div",bc,[e("button",{class:"confirm-btn cancel-btn",onClick:j},s(k.$t("common.cancel")),1),e("button",{class:"confirm-btn delete-btn",onClick:z,disabled:G.value===((ue=b.value)==null?void 0:ue.id)},[f(n($),{icon:G.value===((ye=b.value)==null?void 0:ye.id)?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),le(" "+s(k.$t("cronTask.delete")),1)],8,yc)])])])):N("",!0)]}),_:1})])),(c(),me(je,{to:"body"},[f(Be,{name:"modal"},{default:Re(()=>[U.value?(c(),h("div",{key:0,class:"modal-overlay",onClick:q},[e("div",{class:"confirm-modal create-options-modal",onClick:v[6]||(v[6]=he(()=>{},["stop"]))},[e("div",$c,[f(n($),{icon:"carbon:time",class:"create-icon"}),e("h3",null,s(k.$t("cronTask.createTask")),1)]),e("div",_c,[e("p",null,s(k.$t("cronTask.selectCreateMethod")),1),e("div",kc,[e("button",{class:"create-option-btn jmanus-btn",onClick:ee},[f(n($),{icon:"carbon:ai-status"}),e("div",Sc,[e("span",wc,s(k.$t("cronTask.createWithJmanus")),1),e("span",Cc,s(k.$t("cronTask.createWithJmanusDesc")),1)])]),e("button",{class:"create-option-btn manual-btn",onClick:Y},[f(n($),{icon:"carbon:edit"}),e("div",Pc,[e("span",Tc,s(k.$t("cronTask.createManually")),1),e("span",Ec,s(k.$t("cronTask.createManuallyDesc")),1)])])])]),e("div",Ic,[e("button",{class:"confirm-btn cancel-btn",onClick:q},s(k.$t("common.cancel")),1)])])])):N("",!0)]),_:1})]))],64))}}),Dc=xe(xc,[["__scopeId","data-v-837947df"]]),Rc={class:"direct-page"},Mc={class:"direct-chat"},Ac={class:"chat-header"},Uc={class:"header-actions"},Nc=["title"],Fc=["title"],Lc=["title"],qc=["title"],Bc={class:"chat-content"},Vc=["title"],jc={class:"message-content"},Oc=Ie({__name:"index",setup(A){const o=kt(),t=gt(),l=ft(),{t:m}=Me(),{message:_}=Ct(),u=C(""),x=C(""),V=C(),w=C(),F=C(),G=C(!1),O=C(!1),g=C(null),M=C(!1),Q=C(50),Z=C(!1),b=C(0),U=C(0);De(()=>{if(console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",l.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",l.hasUnprocessedTask()),we.setEventCallbacks({onPlanUpdate:y=>{console.log("[Direct] Plan update event received for rootPlanId:",y),L(y)&&(console.log("[Direct] Processing plan update for current rootPlanId:",y),w.value&&typeof w.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",y),w.value.handlePlanUpdate(y)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),V.value&&typeof V.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",y),V.value.updateDisplayedPlanProgress(y)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:y=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",y),!!L(y)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",y),w.value&&typeof w.value.handlePlanCompleted=="function"){const X=we.getCachedPlanRecord(y);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",X),w.value.handlePlanCompleted(X??{planId:y})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");g.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:y=>{console.log("[Direct] Dialog round start event received for rootPlanId:",y),g.value=y,console.log("[Direct] Set currentRootPlanId to:",y),w.value&&typeof w.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",y),w.value.handleDialogRoundStart(y)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),z()},onChatInputUpdateState:y=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",y),!L(y,!0))return;const X=we.getCachedUIState(y);X&&se(X.enabled,X.placeholder)},onPlanError:y=>{w.value.handlePlanError(y)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),E.loadPlanTemplateList(),l.hasUnprocessedTask()&&l.currentTask){const y=l.currentTask.prompt;console.log("[Direct] Found unprocessed task from store:",y),l.markTaskAsProcessed(),_e(()=>{w.value&&typeof w.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing task via chatRef.handleSendMessage:",y),w.value.handleSendMessage({input:y})):(console.warn("[Direct] chatRef.handleSendMessage method not available, falling back to prompt"),u.value=y)})}else{const y=l.getAndClearTaskToInput();y?(x.value=y,console.log("[Direct] Setting inputOnlyContent for input only:",x.value)):(u.value=o.query.prompt||"",console.log("[Direct] Received task from URL:",u.value),console.log("[Direct] No unprocessed task in store"))}const v=localStorage.getItem("directPanelWidth");v&&(Q.value=parseFloat(v)),console.log("[Direct] Final prompt value:",u.value),x.value&&_e(()=>{F.value&&typeof F.value.setInputValue=="function"&&(F.value.setInputValue(x.value),console.log("[Direct] Set input value:",x.value),x.value="")}),window.addEventListener("plan-execution-requested",y=>{console.log("[DirectView] Received plan-execution-requested event:",y.detail),q(y.detail)})}),Ce(()=>l.currentTask,v=>{if(console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",v),v&&!v.processed){const y=v.prompt;l.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",y),_e(()=>{w.value&&typeof w.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing new task via chatRef.handleSendMessage:",y),w.value.handleSendMessage(y)):console.warn("[Direct] chatRef.handleSendMessage method not available for new task")})}else console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),Ce(()=>u.value,(v,y)=>{console.log("[Direct] prompt value changed from:",y,"to:",v)},{immediate:!1}),Ce(()=>l.taskToInput,v=>{console.log("[Direct] Watch taskStore.taskToInput triggered, newTaskToInput:",v),v&&v.trim()&&(console.log("[Direct] Setting input value from taskToInput:",v),_e(()=>{F.value&&typeof F.value.setInputValue=="function"&&(F.value.setInputValue(v.trim()),console.log("[Direct] Input value set from taskToInput watch:",v.trim()),l.getAndClearTaskToInput())}))},{immediate:!1}),Ae(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),g.value=null,we.cleanup(),document.removeEventListener("mousemove",I),document.removeEventListener("mouseup",D),window.removeEventListener("plan-execution-requested",v=>{q(v.detail)})});const d=v=>{Z.value=!0,b.value=v.clientX,U.value=Q.value,document.addEventListener("mousemove",I),document.addEventListener("mouseup",D),document.body.style.cursor="col-resize",document.body.style.userSelect="none",v.preventDefault()},I=v=>{if(!Z.value)return;const y=window.innerWidth,ue=(v.clientX-b.value)/y*100;let ye=U.value+ue;ye=Math.max(20,Math.min(80,ye)),Q.value=ye},D=()=>{Z.value=!1,document.removeEventListener("mousemove",I),document.removeEventListener("mouseup",D),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",Q.value.toString())},T=()=>{Q.value=50,localStorage.setItem("directPanelWidth","50")},L=(v,y=!1)=>!g.value||v===g.value||y&&(v==="ui-state"||v==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",v,"current:",g.value),!1),R=v=>{console.log("[DirectView] Send message from input:",JSON.stringify(v)),w.value&&typeof w.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",JSON.stringify(v)),w.value.handleSendMessage(v)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},z=()=>{console.log("[DirectView] Input cleared"),F.value&&typeof F.value.clear=="function"&&F.value.clear()},j=()=>{console.log("[DirectView] Input focused")},se=(v,y)=>{console.log("[DirectView] Input state updated:",v,y),O.value=!v},be=(v,y)=>{console.log("[DirectView] Step selected:",v,y),V.value&&typeof V.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",v,y),V.value.handleStepSelected(v,y)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},P=(v,y,X,ue)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:v,subPlanId:y,stepIndex:X,subStepIndex:ue}),V.value&&typeof V.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:v,subPlanId:y,stepIndex:X,subStepIndex:ue}),V.value.handleSubPlanStepSelected(v,y,X,ue)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},B=()=>{console.log("[DirectView] Plan mode button clicked"),E.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",E.isCollapsed)},ee=()=>{t.push("/home")},Y=()=>{t.push("/configs")},q=async v=>{var X,ue,ye,$e;if(console.log("[DirectView] Plan execution requested:",v),G.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}G.value=!0;let y=!1;w.value&&typeof w.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",v.title),w.value.addMessage("user",v.title),y=!0):console.warn("[DirectView] chatRef.addMessage method not available");try{const r=((X=v.planData)==null?void 0:X.planTemplateId)||((ue=v.planData)==null?void 0:ue.id)||((ye=v.planData)==null?void 0:ye.planId);if(!r)throw new Error(m("direct.planTemplateIdNotFound"));console.log("[Direct] Executing plan with templateId:",r,"params:",v.params),console.log("[Direct] About to call PlanActApiService.executePlan");let i;if(($e=v.params)!=null&&$e.trim()?(console.log("[Direct] Calling executePlan with params:",v.params.trim()),i=await We.executePlan(r,v.params.trim())):(console.log("[Direct] Calling executePlan without params"),i=await We.executePlan(r)),console.log("[Direct] Plan execution API response:",i),i.planId)console.log("[Direct] Got planId from response:",i.planId,"starting plan execution"),g.value=i.planId,console.log("[Direct] Set currentRootPlanId to:",i.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),we.handlePlanExecutionRequested(i.planId,v.title);else throw console.error("[Direct] No planId in response:",i),new Error(m("direct.executionFailedNoPlanId"))}catch(r){console.error("[Direct] Plan execution failed:",r),console.error("[Direct] Error details:",{message:r.message,stack:r.stack}),g.value=null,w.value&&typeof w.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),y||w.value.addMessage("user",v.title),w.value.addMessage("assistant",`${m("direct.executionFailed")}: ${r.message||m("common.unknownError")}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`${m("direct.executionFailed")}: ${r.message||m("common.unknownError")}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),G.value=!1}},K=()=>{w.value.showMemory()},k=()=>{Ee.clearMemoryId(),w.value.newChat()};return(v,y)=>(c(),h("div",Rc,[e("div",Mc,[f(hn,{onPlanExecutionRequested:q}),e("div",{class:"left-panel",style:Ve({width:Q.value+"%"})},[e("div",Ac,[e("button",{class:"back-button",onClick:ee},[f(n($),{icon:"carbon:arrow-left"})]),e("h2",null,s(v.$t("conversation")),1),e("div",Uc,[f(Tt),e("button",{class:"config-button",onClick:k,title:v.$t("memory.newChat")},[f(n($),{icon:"carbon:add",width:"20"})],8,Nc),e("button",{class:"config-button",onClick:Y,title:v.$t("direct.configuration")},[f(n($),{icon:"carbon:settings-adjust",width:"20"})],8,Fc),e("button",{class:"cron-task-btn",onClick:y[0]||(y[0]=X=>M.value=!0),title:v.$t("cronTask.title")},[f(n($),{icon:"carbon:alarm",width:"20"})],8,Lc),e("button",{class:"cron-task-btn",onClick:y[1]||(y[1]=X=>n(Ee).toggleSidebar()),title:v.$t("memory.selectMemory")},[f(n($),{icon:"carbon:calendar",width:"20"})],8,qc)])]),e("div",Bc,[f(ar,{ref_key:"chatRef",ref:w,mode:"direct","initial-prompt":u.value||"",onStepSelected:be,onSubPlanStepSelected:P},null,8,["initial-prompt"])]),(c(),me(hr,{key:v.$i18n.locale,ref_key:"inputRef",ref:F,disabled:O.value,placeholder:O.value?n(m)("input.waiting"):n(m)("input.placeholder"),"initial-value":u.value,onSend:R,onClear:z,onFocus:j,onUpdateState:se,onPlanModeClicked:B},null,8,["disabled","placeholder","initial-value"]))],4),e("div",{class:"panel-resizer",onMousedown:d,onDblclick:T,title:v.$t("direct.panelResizeHint")},y[3]||(y[3]=[e("div",{class:"resizer-line"},null,-1)]),40,Vc),f(gl,{ref_key:"rightPanelRef",ref:V,style:Ve({width:100-Q.value+"%"}),"current-root-plan-id":g.value},null,8,["style","current-root-plan-id"])]),f(Dc,{modelValue:M.value,"onUpdate:modelValue":y[2]||(y[2]=X=>M.value=X)},null,8,["modelValue"]),f(rs,{onMemorySelected:K}),n(_).show?(c(),h("div",{key:0,class:ie(["message-toast",n(_).type])},[e("div",jc,[e("span",null,s(n(_).text),1)])],2)):N("",!0)]))}}),Qc=xe(Oc,[["__scopeId","data-v-93705768"]]);export{Qc as default};
