var tt=Object.defineProperty;var nt=(B,t,n)=>t in B?tt(B,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):B[t]=n;var F=(B,t,n)=>nt(B,typeof t!="symbol"?t+"":t,n);import{m as Ae,p as Ie,d as Se,f as Ce,g as de,h as ke,c as m,o as h,q as ie,u as a,e,b as J,t as l,i as $,s as ne,F as he,j as ge,x as xe,w as Pe,v as _e,r as q,k as le,y as $e,a as ve,T as st,z as ot,A as Te,n as Re,B as at,l as it}from"./index-BVtxQ7hh.js";import{I as E,_ as Ee}from"./_plugin-vue_export-helper-DZwTQR-U.js";import{L as lt}from"./index-nKWQuIMN.js";import{u as ct}from"./task-CcWs8Qrj.js";class re{static async generatePlan(t,n){const c={query:t};n&&(c.existingJson=n);const b=await fetch(`${this.PLAN_TEMPLATE_URL}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!b.ok)throw new Error(`Failed to generate plan: ${b.status}`);const u=await b.json();if(u.planJson)try{u.plan=JSON.parse(u.planJson)}catch{u.plan={error:"Unable to parse plan data"}}return u}static async executePlan(t,n){console.log("[PlanActApiService] executePlan called with:",{planTemplateId:t,rawParam:n});const c={planTemplateId:t};n&&(c.rawParam=n),console.log("[PlanActApiService] Making request to:",`${this.PLAN_TEMPLATE_URL}/executePlanByTemplateId`),console.log("[PlanActApiService] Request body:",c);const b=await fetch(`${this.PLAN_TEMPLATE_URL}/executePlanByTemplateId`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(console.log("[PlanActApiService] Response status:",b.status,b.ok),!b.ok){const y=await b.text();throw console.error("[PlanActApiService] Request failed:",y),new Error(`Failed to execute plan: ${b.status}`)}const u=await b.json();return console.log("[PlanActApiService] executePlan response:",u),u}static async savePlanTemplate(t,n){const c=await fetch(`${this.PLAN_TEMPLATE_URL}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t,planJson:n})});if(!c.ok)throw new Error(`Failed to save plan: ${c.status}`);return await c.json()}static async getPlanVersions(t){const n=await fetch(`${this.PLAN_TEMPLATE_URL}/versions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t})});if(!n.ok)throw new Error(`Failed to get plan versions: ${n.status}`);return await n.json()}static async getVersionPlan(t,n){const c=await fetch(`${this.PLAN_TEMPLATE_URL}/get-version`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t,versionIndex:n.toString()})});if(!c.ok)throw new Error(`Failed to get specific version plan: ${c.status}`);return await c.json()}static async getAllPlanTemplates(){const t=await fetch(`${this.PLAN_TEMPLATE_URL}/list`);if(!t.ok)throw new Error(`Failed to get plan template list: ${t.status}`);return await t.json()}static async updatePlanTemplate(t,n,c){const b={planId:t,query:n};c&&(b.existingJson=c);const u=await fetch(`${this.PLAN_TEMPLATE_URL}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});if(!u.ok)throw new Error(`Failed to update plan template: ${u.status}`);const y=await u.json();if(y.planJson)try{y.plan=JSON.parse(y.planJson)}catch{y.plan={error:"Unable to parse plan data"}}return y}static async deletePlanTemplate(t){const n=await fetch(`${this.PLAN_TEMPLATE_URL}/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t})});if(!n.ok)throw new Error(`Failed to delete plan template: ${n.status}`);return await n.json()}}F(re,"PLAN_TEMPLATE_URL","/api/plan-template");class rt{constructor(){F(this,"isCollapsed",!0);F(this,"currentTab","list");F(this,"currentPlanTemplateId",null);F(this,"planTemplateList",[]);F(this,"selectedTemplate",null);F(this,"isLoading",!1);F(this,"errorMessage","");F(this,"jsonContent","");F(this,"generatorPrompt","");F(this,"executionParams","");F(this,"isGenerating",!1);F(this,"isExecuting",!1);F(this,"planVersions",[]);F(this,"currentVersionIndex",-1)}get sortedTemplates(){return[...this.planTemplateList].sort((t,n)=>{const c=new Date(t.updateTime??t.createTime);return new Date(n.updateTime??n.createTime).getTime()-c.getTime()})}get canRollback(){return this.planVersions.length>1&&this.currentVersionIndex>0}get canRestore(){return this.planVersions.length>1&&this.currentVersionIndex<this.planVersions.length-1}get computedApiUrl(){if(!this.selectedTemplate)return"";const t=`/api/plan-template/execute/${this.selectedTemplate.id}`,n=this.executionParams.trim();return n?`${t}?allParams=${encodeURIComponent(n)}`:t}toggleSidebar(){this.isCollapsed=!this.isCollapsed}switchToTab(t){this.currentTab=t}async loadPlanTemplateList(){this.isLoading=!0,this.errorMessage="";try{console.log("[SidebarStore] Starting to load plan template list...");const t=await re.getAllPlanTemplates();t!=null&&t.templates&&Array.isArray(t.templates)?(this.planTemplateList=t.templates,console.log(`[SidebarStore] Successfully loaded ${t.templates.length} plan templates`)):(this.planTemplateList=[],console.warn("[SidebarStore] API returned abnormal data format, using empty list",t))}catch(t){console.error("[SidebarStore] Failed to load plan template list:",t),this.planTemplateList=[],this.errorMessage=`Load failed: ${t.message}`}finally{this.isLoading=!1}}async selectTemplate(t){this.currentPlanTemplateId=t.id,this.selectedTemplate=t,this.currentTab="config",await this.loadTemplateData(t),console.log(`[SidebarStore] Selected plan template: ${t.id}`)}async loadTemplateData(t){try{const n=await re.getPlanVersions(t.id);if(this.planVersions=n.versions||[],this.planVersions.length>0){const c=this.planVersions[this.planVersions.length-1];this.jsonContent=c,this.currentVersionIndex=this.planVersions.length-1;try{const b=JSON.parse(c);b.prompt&&(this.generatorPrompt=b.prompt),b.params&&(this.executionParams=b.params)}catch{console.warn("Unable to parse JSON content to get prompt information")}}else this.jsonContent="",this.generatorPrompt="",this.executionParams=""}catch(n){throw console.error("Failed to load template data:",n),n}}createNewTemplate(){const t={id:`new-${Date.now()}`,title:Ie.global.t("sidebar.newTemplateName"),description:Ie.global.t("sidebar.newTemplateDescription"),createTime:new Date().toISOString(),updateTime:new Date().toISOString()};this.selectedTemplate=t,this.currentPlanTemplateId=null,this.jsonContent="",this.generatorPrompt="",this.executionParams="",this.planVersions=[],this.currentVersionIndex=-1,this.currentTab="config",console.log("[SidebarStore] Created new empty plan template, switching to config tab")}async deleteTemplate(t){if(!t.id){console.warn("[SidebarStore] deleteTemplate: Invalid template object or ID");return}try{await re.deletePlanTemplate(t.id),this.currentPlanTemplateId===t.id&&this.clearSelection(),await this.loadPlanTemplateList(),console.log(`[SidebarStore] Plan template ${t.id} has been deleted`)}catch(n){throw console.error("Failed to delete plan template:",n),await this.loadPlanTemplateList(),n}}clearSelection(){this.currentPlanTemplateId=null,this.selectedTemplate=null,this.jsonContent="",this.generatorPrompt="",this.executionParams="",this.planVersions=[],this.currentVersionIndex=-1,this.currentTab="list"}clearExecutionParams(){this.executionParams=""}rollbackVersion(){this.canRollback&&(this.currentVersionIndex--,this.jsonContent=this.planVersions[this.currentVersionIndex])}restoreVersion(){this.canRestore&&(this.currentVersionIndex++,this.jsonContent=this.planVersions[this.currentVersionIndex])}async saveTemplate(){if(!this.selectedTemplate)return;const t=this.jsonContent.trim();if(!t)throw new Error("Content cannot be empty");try{JSON.parse(t)}catch(n){throw new Error(`Invalid format, please correct and save.
Error: `+n.message)}try{const n=await re.savePlanTemplate(this.selectedTemplate.id,t);return this.currentVersionIndex<this.planVersions.length-1&&(this.planVersions=this.planVersions.slice(0,this.currentVersionIndex+1)),this.planVersions.push(t),this.currentVersionIndex=this.planVersions.length-1,n}catch(n){throw console.error("Failed to save plan template:",n),n}}async generatePlan(){if(this.generatorPrompt.trim()){this.isGenerating=!0;try{const t=await re.generatePlan(this.generatorPrompt);if(this.jsonContent=t.planJson||"",this.selectedTemplate&&this.selectedTemplate.id.startsWith("new-")){let n="New Plan Template";try{n=JSON.parse(t.planJson||"{}").title||n}catch{console.warn("Unable to parse plan JSON to get title")}this.selectedTemplate={id:t.planTemplateId,title:n,description:Ie.global.t("sidebar.generatedTemplateDescription"),createTime:new Date().toISOString(),updateTime:new Date().toISOString(),planJson:t.planJson},this.currentPlanTemplateId=t.planTemplateId,await this.loadPlanTemplateList()}return this.currentVersionIndex<this.planVersions.length-1&&(this.planVersions=this.planVersions.slice(0,this.currentVersionIndex+1)),this.planVersions.push(this.jsonContent),this.currentVersionIndex=this.planVersions.length-1,t}catch(t){throw console.error("Failed to generate plan:",t),t}finally{this.isGenerating=!1}}}async updatePlan(){if(!(!this.generatorPrompt.trim()||!this.jsonContent.trim())&&this.selectedTemplate){this.isGenerating=!0;try{const t=await re.updatePlanTemplate(this.selectedTemplate.id,this.generatorPrompt,this.jsonContent);return this.jsonContent=t.planJson||"",this.currentVersionIndex<this.planVersions.length-1&&(this.planVersions=this.planVersions.slice(0,this.currentVersionIndex+1)),this.planVersions.push(this.jsonContent),this.currentVersionIndex=this.planVersions.length-1,t}catch(t){throw console.error("Failed to update plan:",t),t}finally{this.isGenerating=!1}}}preparePlanExecution(){if(!this.selectedTemplate)return null;this.isExecuting=!0;try{let t;try{t=JSON.parse(this.jsonContent),t.planTemplateId=this.selectedTemplate.id}catch{t={planTemplateId:this.selectedTemplate.id,planId:this.selectedTemplate.id,title:this.selectedTemplate.title??Ie.global.t("sidebar.defaultExecutionPlanTitle"),steps:[{stepRequirement:"[BROWSER_AGENT] 访问百度搜索阿里巴巴的最新股价"},{stepRequirement:"[DEFAULT_AGENT] 提取和整理搜索结果中的股价信息"},{stepRequirement:"[TEXT_FILE_AGENT] 创建一个文本文件记录查询结果"},{stepRequirement:"[DEFAULT_AGENT] 向用户报告查询结果"}]}}return{title:this.selectedTemplate.title??t.title??"Execution Plan",planData:t,params:this.executionParams.trim()||void 0}}catch(t){throw console.error("Failed to prepare plan execution:",t),this.isExecuting=!1,t}}finishPlanExecution(){this.isExecuting=!1}}const p=Ae(new rt),ut={class:"sidebar-content"},dt={class:"sidebar-content-header"},pt={class:"sidebar-content-title"},ht={class:"tab-switcher"},gt=["disabled"],mt={key:0,class:"tab-content"},ft={class:"new-task-section"},vt={class:"sidebar-content-list"},Pt={key:0,class:"loading-state"},_t={key:1,class:"error-state"},bt={key:2,class:"empty-state"},St=["onClick"],Ct={class:"task-icon"},kt={class:"task-details"},$t={class:"task-title"},Et={class:"task-preview"},yt={class:"task-time"},wt={class:"task-actions"},It=["title","onClick"],xt={key:1,class:"tab-content config-tab"},Tt={key:0,class:"config-container"},Rt={class:"template-info-header"},Dt={class:"template-info"},At={class:"template-id"},Lt={class:"config-section"},Nt={class:"section-header"},Mt={class:"generator-content"},Ut=["placeholder"],Vt={class:"generator-actions"},Ot=["disabled"],qt=["disabled"],jt={class:"config-section"},Ft={class:"section-header"},Jt={class:"section-actions"},Bt=["disabled","title"],Wt=["disabled","title"],Gt=["disabled"],Ht=["placeholder"],zt={class:"config-section"},Xt={class:"section-header"},Kt={class:"execution-content"},Qt={class:"params-input-group"},Yt={class:"params-help-text"},Zt={class:"params-input-container"},en=["placeholder"],tn=["title"],nn={class:"api-url-display"},sn={class:"api-url-label"},on={class:"api-url"},an={class:"api-url-display"},ln={class:"api-url-label"},cn=["disabled"],rn=Se({__name:"index",emits:["planExecutionRequested"],setup(B,{expose:t,emit:n}){const{t:c}=Ce(),b=["currentPlanId","userRequest","rootPlanId"],u=de({get(){try{if(!p.jsonContent)return"";const S={...JSON.parse(p.jsonContent)};return b.forEach(k=>{delete S[k]}),JSON.stringify(S,null,2)}catch{return p.jsonContent}},set(r){try{if(!r.trim()){p.jsonContent="";return}const S=JSON.parse(r);let k={};try{k=JSON.parse(p.jsonContent||"{}")}catch{}const Y={...S};b.forEach(G=>{k[G]!==void 0&&(Y[G]=k[G])}),p.jsonContent=JSON.stringify(Y)}catch{p.jsonContent=r}}}),y=n,C=async()=>{try{const r=await p.saveTemplate();r!=null&&r.duplicate?alert(c("sidebar.saveCompleted",{message:r.message,versionCount:r.versionCount})):r!=null&&r.saved?alert(c("sidebar.saveSuccess",{message:r.message,versionCount:r.versionCount})):r!=null&&r.message&&alert(c("sidebar.saveStatus",{message:r.message}))}catch(r){console.error("保存计划修改失败:",r),alert(r.message||c("sidebar.saveFailed"))}},X=async()=>{var r;try{await p.generatePlan(),alert(c("sidebar.generateSuccess",{templateId:((r=p.selectedTemplate)==null?void 0:r.id)??c("sidebar.unknown")}))}catch(S){console.error("生成计划失败:",S),alert(c("sidebar.generateFailed")+": "+S.message)}},R=async()=>{try{await p.updatePlan(),alert(c("sidebar.updateSuccess"))}catch(r){console.error("更新计划失败:",r),alert(c("sidebar.updateFailed")+": "+r.message)}},Q=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const r=p.preparePlanExecution();if(!r){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] 触发计划执行请求:",r),console.log("[Sidebar] Emitting planExecutionRequested event"),y("planExecutionRequested",r),console.log("[Sidebar] Event emitted")}catch(r){console.error("执行计划出错:",r),alert(c("sidebar.executeFailed")+": "+r.message)}finally{p.finishPlanExecution()}},z=r=>{const k=new Date().getTime()-r.getTime(),Y=Math.floor(k/6e4),G=Math.floor(k/36e5),V=Math.floor(k/864e5);return Y<1?"刚刚":Y<60?`${Y}分钟前`:G<24?`${G}小时前`:V<30?`${V}天前`:r.toLocaleDateString("zh-CN")},j=(r,S)=>!r||r.length<=S?r:r.substring(0,S)+"...";return ke(()=>{p.loadPlanTemplateList()}),t({loadPlanTemplateList:p.loadPlanTemplateList,toggleSidebar:p.toggleSidebar,currentPlanTemplateId:p.currentPlanTemplateId}),(r,S)=>(h(),m("div",{class:ie(["sidebar-wrapper",{"sidebar-wrapper-collapsed":a(p).isCollapsed}])},[e("div",ut,[e("div",dt,[e("div",pt,l(r.$t("sidebar.title")),1)]),e("div",ht,[e("button",{class:ie(["tab-button",{active:a(p).currentTab==="list"}]),onClick:S[0]||(S[0]=k=>a(p).switchToTab("list"))},[$(a(E),{icon:"carbon:list",width:"16"}),ne(" "+l(r.$t("sidebar.templateList")),1)],2),e("button",{class:ie(["tab-button",{active:a(p).currentTab==="config"}]),onClick:S[1]||(S[1]=k=>a(p).switchToTab("config")),disabled:!a(p).selectedTemplate},[$(a(E),{icon:"carbon:settings",width:"16"}),ne(" "+l(r.$t("sidebar.configuration")),1)],10,gt)]),a(p).currentTab==="list"?(h(),m("div",mt,[e("div",ft,[e("button",{class:"new-task-btn",onClick:S[2]||(S[2]=k=>a(p).createNewTemplate())},[$(a(E),{icon:"carbon:add",width:"16"}),ne(" "+l(r.$t("sidebar.newPlan"))+" ",1),S[11]||(S[11]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",vt,[a(p).isLoading?(h(),m("div",Pt,[$(a(E),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,l(r.$t("sidebar.loading")),1)])):a(p).errorMessage?(h(),m("div",_t,[$(a(E),{icon:"carbon:warning",width:"20"}),e("span",null,l(a(p).errorMessage),1),e("button",{onClick:S[3]||(S[3]=(...k)=>a(p).loadPlanTemplateList&&a(p).loadPlanTemplateList(...k)),class:"retry-btn"},l(r.$t("sidebar.retry")),1)])):a(p).planTemplateList.length===0?(h(),m("div",bt,[$(a(E),{icon:"carbon:document",width:"32"}),e("span",null,l(r.$t("sidebar.noTemplates")),1)])):(h(!0),m(he,{key:3},ge(a(p).sortedTemplates,k=>(h(),m("div",{key:k.id,class:ie(["sidebar-content-list-item",{"sidebar-content-list-item-active":k.id===a(p).currentPlanTemplateId}]),onClick:Y=>a(p).selectTemplate(k)},[e("div",Ct,[$(a(E),{icon:"carbon:document",width:"20"})]),e("div",kt,[e("div",$t,l(k.title||r.$t("sidebar.unnamedPlan")),1),e("div",Et,l(j(k.description||r.$t("sidebar.noDescription"),40)),1)]),e("div",yt,l(z(new Date(k.updateTime||k.createTime))),1),e("div",wt,[e("button",{class:"delete-task-btn",title:r.$t("sidebar.deleteTemplate"),onClick:xe(Y=>a(p).deleteTemplate(k),["stop"])},[$(a(E),{icon:"carbon:close",width:"16"})],8,It)])],10,St))),128))])])):a(p).currentTab==="config"?(h(),m("div",xt,[a(p).selectedTemplate?(h(),m("div",Tt,[e("div",Rt,[e("div",Dt,[e("h3",null,l(a(p).selectedTemplate.title||r.$t("sidebar.unnamedPlan")),1),e("span",At,"ID: "+l(a(p).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:S[4]||(S[4]=k=>a(p).switchToTab("list"))},[$(a(E),{icon:"carbon:arrow-left",width:"16"})])]),e("div",Lt,[e("div",Nt,[$(a(E),{icon:"carbon:generate",width:"16"}),e("span",null,l(r.$t("sidebar.planGenerator")),1)]),e("div",Mt,[Pe(e("textarea",{"onUpdate:modelValue":S[5]||(S[5]=k=>a(p).generatorPrompt=k),class:"prompt-input",placeholder:r.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,Ut),[[_e,a(p).generatorPrompt]]),e("div",Vt,[e("button",{class:"btn btn-primary btn-sm",onClick:X,disabled:a(p).isGenerating||!a(p).generatorPrompt.trim()},[$(a(E),{icon:a(p).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:ie({spinning:a(p).isGenerating})},null,8,["icon","class"]),ne(" "+l(a(p).isGenerating?r.$t("sidebar.generating"):r.$t("sidebar.generatePlan")),1)],8,Ot),e("button",{class:"btn btn-secondary btn-sm",onClick:R,disabled:a(p).isGenerating||!a(p).generatorPrompt.trim()||!a(p).jsonContent.trim()},[$(a(E),{icon:"carbon:edit",width:"14"}),ne(" "+l(r.$t("sidebar.updatePlan")),1)],8,qt)])])]),e("div",jt,[e("div",Ft,[$(a(E),{icon:"carbon:code",width:"16"}),e("span",null,l(r.$t("sidebar.jsonTemplate")),1),e("div",Jt,[e("button",{class:"btn btn-sm",onClick:S[6]||(S[6]=(...k)=>a(p).rollbackVersion&&a(p).rollbackVersion(...k)),disabled:!a(p).canRollback,title:r.$t("sidebar.rollback")},[$(a(E),{icon:"carbon:undo",width:"14"})],8,Bt),e("button",{class:"btn btn-sm",onClick:S[7]||(S[7]=(...k)=>a(p).restoreVersion&&a(p).restoreVersion(...k)),disabled:!a(p).canRestore,title:r.$t("sidebar.restore")},[$(a(E),{icon:"carbon:redo",width:"14"})],8,Wt),e("button",{class:"btn btn-primary btn-sm",onClick:C,disabled:a(p).isGenerating||a(p).isExecuting},[$(a(E),{icon:"carbon:save",width:"14"})],8,Gt)])]),Pe(e("textarea",{"onUpdate:modelValue":S[8]||(S[8]=k=>u.value=k),class:"json-editor",placeholder:r.$t("sidebar.jsonPlaceholder"),rows:"12"},null,8,Ht),[[_e,u.value]])]),e("div",zt,[e("div",Xt,[$(a(E),{icon:"carbon:play",width:"16"}),e("span",null,l(r.$t("sidebar.executionController")),1)]),e("div",Kt,[e("div",Qt,[e("label",null,l(r.$t("sidebar.executionParams")),1),e("div",Yt,l(r.$t("sidebar.executionParamsHelp")),1),e("div",Zt,[Pe(e("input",{"onUpdate:modelValue":S[9]||(S[9]=k=>a(p).executionParams=k),class:"params-input",placeholder:r.$t("sidebar.executionParamsPlaceholder")},null,8,en),[[_e,a(p).executionParams]]),e("button",{class:"clear-params-btn",onClick:S[10]||(S[10]=(...k)=>a(p).clearExecutionParams&&a(p).clearExecutionParams(...k)),title:r.$t("sidebar.clearParams")},[$(a(E),{icon:"carbon:close",width:"12"})],8,tn)])]),e("div",nn,[e("span",sn,l(r.$t("sidebar.apiUrl"))+":",1),e("code",on,l(a(p).computedApiUrl),1)]),e("div",an,[e("span",ln,l(r.$t("sidebar.statusApiUrl"))+":",1),S[12]||(S[12]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:Q,disabled:a(p).isExecuting||a(p).isGenerating},[$(a(E),{icon:a(p).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:ie({spinning:a(p).isExecuting})},null,8,["icon","class"]),ne(" "+l(a(p).isExecuting?r.$t("sidebar.executing"):r.$t("sidebar.executePlan")),1)],8,cn)])])])):J("",!0)])):J("",!0)])],2))}}),un=Ee(rn,[["__scopeId","data-v-8a36100e"]]);class Le{static async sendMessage(t){const n=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t})});if(!n.ok)throw new Error(`API request failed: ${n.status}`);return await n.json()}}F(Le,"BASE_URL","/api/executor");class Ne{static async getDetails(t){try{const n=await fetch(`${this.BASE_URL}/details/${t}`);if(n.status===404)return null;if(!n.ok)throw new Error(`Failed to get detailed information: ${n.status}`);const c=await n.text(),b=JSON.parse(c);return b&&typeof b=="object"&&!b.currentPlanId&&(b.currentPlanId=t),b}catch(n){return console.error("[CommonApiService] Failed to get plan details:",n),null}}static async submitFormInput(t,n){const c=await fetch(`${this.BASE_URL}/submit-input/${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!c.ok){let u;try{u=await c.json()}catch{u={message:`Failed to submit form input: ${c.status}`}}throw new Error(u.message||`Failed to submit form input: ${c.status}`)}const b=c.headers.get("content-type");return b&&b.indexOf("application/json")!==-1?await c.json():{success:!0}}static async getAllPrompts(){try{const t=await fetch(this.BASE_URL);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get Prompt list:",t),t}}static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}}F(Ne,"BASE_URL","/api/executor");const pe=class pe{constructor(){F(this,"POLL_INTERVAL",5e3);F(this,"state",Ae({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));F(this,"callbacks",{});F(this,"planExecutionCache",new Map);F(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(t){return this.planExecutionCache.get(t)}getCachedUIState(t){return this.uiStateCache.get(t)}setCachedUIState(t,n){this.uiStateCache.set(t,n),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${t}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(t){return this.planExecutionCache.has(t)}setCachedPlanRecord(t,n){this.planExecutionCache.set(t,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${t}`)}clearCachedPlanRecord(t){const n=this.planExecutionCache.delete(t);return n&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${t}`),n}clearAllCachedRecords(){const t=this.planExecutionCache.size,n=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${t}, UI States: ${n}`)}static getInstance(){return pe.instance||(pe.instance=new pe),pe.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(t){this.callbacks={...this.callbacks,...t},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(t))}async handleUserMessageSendRequested(t){if(this.validateAndPrepareUIForNewRequest(t))try{if(await this.sendUserMessageAndSetPlanId(t),this.state.activePlanId)this.initiatePlanExecutionSequence(t,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(n){console.error("[PlanExecutionManager] Failed to send user message:",n);const c=this.state.activePlanId??"error";this.setCachedUIState(c,{enabled:!0}),this.emitChatInputUpdateState(c),this.state.activePlanId=null}}handlePlanExecutionRequested(t,n){console.log("[PlanExecutionManager] Received plan execution request:",{planId:t,query:n}),t?(this.state.activePlanId=t,this.initiatePlanExecutionSequence(n??"执行计划",t)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(t,n){const c=this.getCachedPlanRecord(t);return c!=null&&c.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${t}`),this.handlePlanExecutionRequested(c.currentPlanId,n),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${t}`),!1)}validateAndPrepareUIForNewRequest(t){if(!t)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const n=this.state.activePlanId??"ui-state";return this.setCachedUIState(n,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(n),!0}async sendUserMessageAndSetPlanId(t){try{const n=await Le.sendMessage(t);if(n!=null&&n.planId)return this.state.activePlanId=n.planId,n;if(n!=null&&n.planTemplateId)return this.state.activePlanId=n.planTemplateId,{...n,planId:n.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",n),new Error("Failed to get valid planId from API response")}catch(n){throw console.error("[PlanExecutionManager] API call failed:",n),n}}initiatePlanExecutionSequence(t,n){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${t}", planId: ${n}`);const c=n;this.emitDialogRoundStart(c),this.startPolling()}handlePlanCompletion(t){this.emitPlanCompleted(t.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await re.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}},5e3)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}t.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(t.rootPlanId??""))}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const t=await this.getPlanDetails(this.state.activePlanId);if(!t){console.warn("[PlanExecutionManager] No details received from API");return}if(t.rootPlanId&&this.setCachedPlanRecord(t.rootPlanId,t),!t.steps||t.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(t.rootPlanId??""),this.handlePlanCompletion(t);return}this.emitPlanUpdate(t.rootPlanId??""),t.completed&&this.handlePlanCompletion(t)}catch(t){console.error("[PlanExecutionManager] Failed to poll plan status:",t)}finally{this.state.isPolling=!1}}}async getPlanDetails(t){try{const n=await Ne.getDetails(t);return n!=null&&n.rootPlanId&&(this.planExecutionCache.set(n.rootPlanId,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${n.rootPlanId}`)),n}catch(n){return console.error("[PlanExecutionManager] Failed to get plan details:",n),null}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(t){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(t)}emitDialogRoundStart(t){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(t)}emitPlanUpdate(t){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(t)}emitPlanCompleted(t){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(t)}};F(pe,"instance",null);let De=pe;const Z=De.getInstance(),dn={class:"right-panel"},pn={class:"preview-header"},hn={class:"preview-tabs"},gn={class:"tab-button active"},mn={class:"preview-content"},fn={class:"step-details"},vn={key:0,class:"step-info-fixed"},Pn={key:0,class:"agent-info"},_n={class:"info-item"},bn={class:"label"},Sn={class:"value"},Cn={class:"info-item"},kn={class:"label"},$n={class:"value"},En={class:"info-item"},yn={class:"label"},wn={class:"value"},In={class:"info-item"},xn={class:"label"},Tn={class:"value"},Rn={class:"info-item"},Dn={class:"label"},An={class:"execution-status"},Ln={class:"status-item"},Nn={class:"status-text"},Mn={key:0},Un={key:0,class:"think-act-steps"},Vn={class:"steps-container"},On={class:"step-header"},qn={class:"step-number"},jn={class:"think-section"},Fn={class:"think-content"},Jn={class:"input"},Bn={class:"label"},Wn={class:"output"},Gn={class:"label"},Hn={key:0,class:"action-section"},zn={class:"action-content"},Xn={class:"tool-info"},Kn={class:"label"},Qn={class:"value"},Yn={class:"input"},Zn={class:"label"},es={class:"output"},ts={class:"label"},ns={key:0,class:"sub-plan-section"},ss={class:"sub-plan-content"},os={class:"sub-plan-header"},as={class:"sub-plan-info"},is={class:"value"},ls={key:0,class:"sub-plan-info"},cs={class:"value"},rs={class:"sub-plan-status"},us={class:"status-text"},ds={key:0,class:"no-steps-message"},ps={key:1,class:"no-execution-message"},hs={class:"step-basic-info"},gs={class:"info-item"},ms={class:"label"},fs={class:"value"},vs={key:0,class:"info-item"},Ps={class:"value"},_s={class:"info-item"},bs={class:"no-execution-hint"},Ss={key:2,class:"execution-indicator"},Cs={class:"execution-text"},ks={key:1,class:"no-selection"},$s=["title"],Es=Se({__name:"index",setup(B,{expose:t}){const{t:n}=Ce(),c=q(),b=q(),u=q(),y=q(null),C=q(!1),X=q(!0),R=q(!0),Q=de(()=>u.value?u.value.completed?n("rightPanel.status.completed"):u.value.current?n("rightPanel.status.executing"):n("rightPanel.status.waiting"):""),z=f=>{var D;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${f}`),u.value&&y.value){const x=y.value.rootPlanId??b.value;if(x&&x!==f){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${x}, Requested: ${f}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${f}`);const g=Z.getCachedPlanRecord(f);if(!g){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${f}`);return}if(g.steps&&g.steps.length>0){const x=g.steps.length,P=(g.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${P} / ${x}`)}if(u.value&&b.value&&(b.value===f||((D=y.value)==null?void 0:D.rootPlanId)===f)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${f}`),y.value)){const P=y.value,I=r(P.planId,P.rootPlanId,P.subPlanId);I?(S(I,P.stepIndex,P.planId,P.isSubPlan),ee()):console.warn("[RightPanel] Could not find plan record for refresh:",P)}},j=(f,g,D,x,P)=>{console.log("[RightPanel] Step selected:",{planId:f,stepIndex:g,rootPlanId:D,subPlanId:x,subStepIndex:P});const I=!!(D&&x&&P!==void 0);y.value={planId:f,stepIndex:g,isSubPlan:I,...I&&{rootPlanId:D,subPlanId:x,subStepIndex:P}};const K=r(f,D,x);if(!K){console.warn("[RightPanel] Plan data not found:",{planId:f,rootPlanId:D,subPlanId:x}),u.value=null,y.value=null;return}S(K,g,f,I)},r=(f,g,D)=>{var I;if(!g||!D)return Z.getCachedPlanRecord(f)??null;const x=Z.getCachedPlanRecord(f);if(x)return x;const P=Z.getCachedPlanRecord(g);if(!(P!=null&&P.agentExecutionSequence))return null;for(const K of P.agentExecutionSequence)if(K.thinkActSteps){for(const se of K.thinkActSteps)if(((I=se.subPlanExecutionRecord)==null?void 0:I.currentPlanId)===D)return se.subPlanExecutionRecord}return null},S=(f,g,D,x)=>{var _,O,W,ue,ye;if(!f.steps||g>=f.steps.length){u.value=null,y.value=null,console.warn("[RightPanel] Invalid step data:",{planId:D,stepIndex:g,hasSteps:!!f.steps,stepsLength:(_=f.steps)==null?void 0:_.length,message:"Invalid step index"});return}b.value=D;const P=f.steps[g],I=(O=f.agentExecutionSequence)==null?void 0:O[g];console.log("[RightPanel] Step data details:",{planId:D,stepIndex:g,step:P,hasAgentExecutionSequence:!!f.agentExecutionSequence,agentExecutionSequenceLength:(W=f.agentExecutionSequence)==null?void 0:W.length,agentExecution:I,hasThinkActSteps:!!(I!=null&&I.thinkActSteps),thinkActStepsLength:(ue=I==null?void 0:I.thinkActSteps)==null?void 0:ue.length,isSubPlan:x});const K=(I==null?void 0:I.status)==="FINISHED",se=!K&&g===f.currentStepIndex&&!f.completed,v={planId:D,index:g,title:typeof P=="string"?P:P.title||P.description||P.name||`${x?"子":""}步骤 ${g+1}`,description:typeof P=="string"?P:P.description||P,completed:K,current:se};I&&(v.agentExecution=I),u.value=v,console.log("[RightPanel] Step details updated:",{planId:D,stepIndex:g,stepTitle:u.value.title,hasAgentExecution:!!I,hasThinkActSteps:(((ye=I==null?void 0:I.thinkActSteps)==null?void 0:ye.length)??0)>0,completed:K,current:se,planCurrentStep:f.currentStepIndex,planCompleted:f.completed,isSubPlan:x}),I!=null&&I.thinkActSteps&&I.thinkActSteps.forEach((o,s)=>{o.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${s}:`,o.subPlanExecutionRecord)}),setTimeout(()=>{G()},100),ee()},k=(f,g,D,x)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:f,subPlanId:g,stepIndex:D,subStepIndex:x}),j(g,x,f,g,x)},Y=f=>{c.value=f??void 0},G=()=>{if(!c.value)return;const{scrollTop:f,scrollHeight:g,clientHeight:D}=c.value,x=g-f-D<50,P=g>D;X.value=x,C.value=P&&!x,x?R.value=!0:g-f-D>100&&(R.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:f,scrollHeight:g,clientHeight:D,isAtBottom:x,hasScrollableContent:P,showButton:C.value,shouldAutoScroll:R.value})},V=()=>{c.value&&(c.value.scrollTo({top:c.value.scrollHeight,behavior:"smooth"}),le(()=>{R.value=!0,G()}))},ee=()=>{!R.value||!c.value||le(()=>{c.value&&(c.value.scrollTop=c.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},te=f=>{if(f===null||typeof f>"u"||f==="")return"N/A";try{const g=typeof f=="object"?f:JSON.parse(f);return JSON.stringify(g,null,2)}catch{return String(f)}},be=()=>{u.value=null,b.value=void 0,R.value=!0,c.value&&c.value.removeEventListener("scroll",G)},me=()=>{const f=()=>{const g=c.value;return g?(Y(g),g.addEventListener("scroll",G),R.value=!0,G(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};le(()=>{f()||setTimeout(()=>{f()},100)})};return ke(()=>{console.log("[RightPanel] Component mounted"),le(()=>{me()})}),$e(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),y.value=null,be()}),t({updateDisplayedPlanProgress:z,handleStepSelected:j,handleSubPlanStepSelected:k}),(f,g)=>{var D,x;return h(),m("div",dn,[e("div",pn,[e("div",hn,[e("button",gn,[$(a(E),{icon:"carbon:events"}),ne(" "+l(a(n)("rightPanel.stepExecutionDetails")),1)])])]),e("div",mn,[e("div",fn,[u.value?(h(),m("div",vn,[e("h3",null,l(u.value.title||u.value.description||a(n)("rightPanel.defaultStepTitle",{number:u.value.index+1})),1),u.value.agentExecution?(h(),m("div",Pn,[e("div",_n,[e("span",bn,l(a(n)("rightPanel.executingAgent"))+":",1),e("span",Sn,l(u.value.agentExecution.agentName),1)]),e("div",Cn,[e("span",kn,l(a(n)("rightPanel.description"))+":",1),e("span",$n,l(u.value.agentExecution.agentDescription||""),1)]),e("div",En,[e("span",yn,l(a(n)("rightPanel.callingModel"))+":",1),e("span",wn,l(u.value.agentExecution.modelName),1)]),e("div",In,[e("span",xn,l(a(n)("rightPanel.request"))+":",1),e("span",Tn,l(u.value.agentExecution.agentRequest||""),1)]),e("div",Rn,[e("span",Dn,l(a(n)("rightPanel.executionResult"))+":",1),e("span",{class:ie(["value",{success:u.value.agentExecution.status==="FINISHED"}])},l(u.value.agentExecution.status||a(n)("rightPanel.executing")),3)])])):J("",!0),e("div",An,[e("div",Ln,[u.value.completed?(h(),ve(a(E),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):u.value.current?(h(),ve(a(E),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(h(),ve(a(E),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",Nn,l(Q.value),1)])])])):J("",!0),e("div",{ref_key:"scrollContainer",ref:c,class:"step-details-scroll-container",onScroll:G},[u.value?(h(),m("div",Mn,[(D=u.value.agentExecution)!=null&&D.thinkActSteps&&u.value.agentExecution.thinkActSteps.length>0?(h(),m("div",Un,[e("h4",null,l(a(n)("rightPanel.thinkAndActionSteps")),1),e("div",Vn,[(h(!0),m(he,null,ge(u.value.agentExecution.thinkActSteps,(P,I)=>(h(),m("div",{key:I,class:"think-act-step"},[e("div",On,[e("span",qn,"#"+l(I+1),1),e("span",{class:ie(["step-status",P.status])},l(P.status||a(n)("rightPanel.executing")),3)]),e("div",jn,[e("h5",null,[$(a(E),{icon:"carbon:thinking"}),ne(" "+l(a(n)("rightPanel.thinking")),1)]),e("div",Fn,[e("div",Jn,[e("span",Bn,l(a(n)("rightPanel.input"))+":",1),e("pre",null,l(te(P.thinkInput)),1)]),e("div",Wn,[e("span",Gn,l(a(n)("rightPanel.output"))+":",1),e("pre",null,l(te(P.thinkOutput)),1)])])]),P.actionNeeded?(h(),m("div",Hn,[e("h5",null,[$(a(E),{icon:"carbon:play"}),ne(" "+l(a(n)("rightPanel.action")),1)]),e("div",zn,[(h(!0),m(he,null,ge(P.actToolInfoList,(K,se)=>(h(),m("div",{key:se},[e("div",Xn,[e("span",Kn,l(a(n)("rightPanel.tool"))+":",1),e("span",Qn,l(K.name||""),1)]),e("div",Yn,[e("span",Zn,l(a(n)("rightPanel.toolParameters"))+":",1),e("pre",null,l(te(K.parameters)),1)]),e("div",es,[e("span",ts,l(a(n)("rightPanel.executionResult"))+":",1),e("pre",null,l(te(K.result)),1)])]))),128))]),P.subPlanExecutionRecord?(h(),m("div",ns,[e("h5",null,[$(a(E),{icon:"carbon:tree-view"}),ne(" "+l(a(n)("rightPanel.subPlan")),1)]),e("div",ss,[e("div",os,[e("div",as,[g[0]||(g[0]=e("span",{class:"label"},"子计划ID:",-1)),e("span",is,l(P.subPlanExecutionRecord.currentPlanId),1)]),P.subPlanExecutionRecord.title?(h(),m("div",ls,[g[1]||(g[1]=e("span",{class:"label"},"标题:",-1)),e("span",cs,l(P.subPlanExecutionRecord.title),1)])):J("",!0),e("div",rs,[P.subPlanExecutionRecord.completed?(h(),ve(a(E),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(h(),ve(a(E),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",us,l(P.subPlanExecutionRecord.completed?"已完成":"执行中"),1)])])])])):J("",!0)])):J("",!0)]))),128))]),u.value.agentExecution&&!((x=u.value.agentExecution.thinkActSteps)!=null&&x.length)?(h(),m("div",ds,[e("p",null,l(a(n)("rightPanel.noStepDetails")),1)])):u.value.agentExecution?J("",!0):(h(),m("div",ps,[$(a(E),{icon:"carbon:information",class:"info-icon"}),e("h4",null,l(a(n)("rightPanel.stepInfo")),1),e("div",hs,[e("div",gs,[e("span",ms,l(a(n)("rightPanel.stepName"))+":",1),e("span",fs,l(u.value.title||u.value.description||`步骤 ${u.value.index+1}`),1)]),u.value.description?(h(),m("div",vs,[g[2]||(g[2]=e("span",{class:"label"},"描述:",-1)),e("span",Ps,l(u.value.description),1)])):J("",!0),e("div",_s,[g[3]||(g[3]=e("span",{class:"label"},"状态:",-1)),e("span",{class:ie(["value",{"status-completed":u.value.completed,"status-current":u.value.current,"status-pending":!u.value.completed&&!u.value.current}])},l(u.value.completed?"已完成":u.value.current?"执行中":"待执行"),3)])]),e("p",bs,l(a(n)("rightPanel.noExecutionInfo")),1)])),u.value.current&&!u.value.completed?(h(),m("div",Ss,[g[4]||(g[4]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",Cs,[$(a(E),{icon:"carbon:in-progress",class:"rotating-icon"}),ne(" "+l(a(n)("rightPanel.stepExecuting")),1)])])):J("",!0)])):(h(),m("div",ks,[$(a(E),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,l(a(n)("rightPanel.noStepSelected")),1),e("p",null,l(a(n)("rightPanel.selectStepHint")),1)]))])):J("",!0),$(st,{name:"scroll-button"},{default:ot(()=>[C.value?(h(),m("button",{key:0,onClick:V,class:"scroll-to-bottom-btn",title:a(n)("rightPanel.scrollToBottom")},[$(a(E),{icon:"carbon:chevron-down"})],8,$s)):J("",!0)]),_:1})],544)])])])}}}),ys=Ee(Es,[["__scopeId","data-v-e90596ce"]]);function ws(){const B=Z,t=de(()=>B.getActivePlanId()),n=de(()=>B.getState()),c=de(()=>n.value.isPolling),b=de(()=>!!t.value),u=(R,Q)=>{B.initiatePlanExecutionSequence(R,Q)},y=()=>{B.stopPolling()},C=()=>{B.startPolling()},X=()=>{B.cleanup()};return $e(()=>{X()}),{activePlanId:t,state:n,isPolling:c,hasActivePlan:b,startExecution:u,stopPolling:y,startPolling:C,cleanup:X}}const Is={class:"chat-container"},xs={class:"message-content"},Ts={key:0,class:"user-message"},Rs={key:1,class:"assistant-message"},Ds={key:0,class:"thinking-section"},As={class:"thinking-header"},Ls={class:"thinking-avatar"},Ns={class:"thinking-label"},Ms={class:"thinking-content"},Us={key:0,class:"thinking"},Vs={key:1,class:"progress"},Os={class:"progress-bar"},qs={class:"progress-text"},js={key:2,class:"steps-container"},Fs={class:"steps-title"},Js=["onClick"],Bs={class:"section-header"},Ws={class:"step-icon"},Gs={class:"step-title"},Hs={key:0,class:"step-status current"},zs={key:1,class:"step-status completed"},Xs={key:2,class:"step-status pending"},Ks={key:0,class:"action-info"},Qs={class:"action-description"},Ys={class:"action-icon"},Zs={key:0,class:"tool-params"},eo={class:"param-label"},to={class:"param-content"},no={key:1,class:"think-details"},so={class:"think-header"},oo={class:"think-label"},ao={class:"think-output"},io={class:"think-content"},lo={key:1,class:"sub-plan-steps"},co={class:"sub-plan-header"},ro={class:"sub-plan-step-list"},uo=["onClick"],po={class:"sub-step-indicator"},ho={class:"sub-step-icon"},go={class:"sub-step-number"},mo={class:"sub-step-content"},fo={class:"sub-step-title"},vo={key:2,class:"user-input-form-container"},Po={class:"user-input-message"},_o={key:0,class:"form-description"},bo=["onSubmit"],So=["for"],Co=["id","name","onUpdate:modelValue"],ko={key:1,class:"form-group"},$o={for:"form-input-genericInput"},Eo=["onUpdate:modelValue"],yo={type:"submit",class:"submit-user-input-btn"},wo={key:3,class:"default-processing"},Io={class:"processing-indicator"},xo={class:"response-section"},To={class:"response-header"},Ro={class:"response-avatar"},Do={class:"response-name"},Ao={class:"response-content"},Lo={key:0,class:"final-response"},No=["innerHTML"],Mo={key:1,class:"response-placeholder"},Uo={class:"typing-indicator"},Vo={class:"typing-text"},Oo={key:0,class:"message assistant"},qo={class:"message-content"},jo={class:"assistant-message"},Fo={class:"thinking-section"},Jo={class:"thinking-header"},Bo={class:"thinking-avatar"},Wo={class:"thinking-label"},Go={class:"thinking-content"},Ho={class:"default-processing"},zo={class:"processing-indicator"},Xo={class:"response-section"},Ko={class:"response-header"},Qo={class:"response-avatar"},Yo={class:"response-name"},Zo={class:"response-content"},ea={class:"response-placeholder"},ta={class:"typing-indicator"},na={class:"typing-text"},sa=["title"],oa=Se({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(B,{expose:t,emit:n}){const c=B,b=n,{t:u}=Ce(),y=ws(),C=q(),X=q(!1),R=q([]),Q=q(),z=q(!1),j=Ae({}),r=(o,s,i)=>{const d={id:Date.now().toString(),type:o,content:s,timestamp:new Date,...i};return o==="assistant"&&!d.thinking&&!d.content&&(d.thinking=u("chat.thinking")),R.value.push(d),d},S=o=>{const s=R.value[R.value.length-1];s.type==="assistant"&&Object.assign(s,o)},k=async o=>{try{X.value=!0;const s=r("assistant","",{thinking:"正在理解您的请求并准备回复..."}),i=await Le.sendMessage(o);if(i.planId)console.log("[ChatComponent] Received planId from direct execution:",i.planId),s.planExecution||(s.planExecution={}),s.planExecution.currentPlanId=i.planId,Z.handlePlanExecutionRequested(i.planId,o),delete s.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete s.thinking;const d=Y(i,o);s.content=d}}catch(s){console.error("Direct mode error:",s),S({content:G(s)})}finally{X.value=!1}},Y=(o,s)=>o.result??o.message??o.content??"",G=o=>{const s=(o==null?void 0:o.message)??(o==null?void 0:o.toString())??"未知错误";return s.includes("网络")||s.includes("network")||s.includes("timeout")?"抱歉，似乎网络连接有些问题。请检查您的网络连接后再试一次，或者稍等几分钟再重新提问。":s.includes("认证")||s.includes("权限")||s.includes("auth")?"抱歉，访问权限出现了问题。这可能是系统配置的问题，请联系管理员或稍后再试。":s.includes("格式")||s.includes("参数")||s.includes("invalid")?"抱歉，您的请求格式可能有些问题。能否请您重新表述一下您的需求？我会尽力理解并帮助您。":`抱歉，处理您的请求时遇到了一些问题（${s}）。请稍后再试，或者换个方式表达您的需求，我会尽力帮助您的。`},V=(o=!1)=>{le(()=>{if(C.value){const s=C.value;(o||s.scrollHeight-s.scrollTop-s.clientHeight<150)&&s.scrollTo({top:s.scrollHeight,behavior:o?"auto":"smooth"})}})},ee=()=>{V(!0),z.value=!1},te=()=>{if(C.value){const o=C.value,s=o.scrollHeight-o.scrollTop-o.clientHeight<150;z.value=!s&&R.value.length>0}},be=()=>{C.value&&C.value.addEventListener("scroll",te)},me=()=>{C.value&&C.value.removeEventListener("scroll",te)},f=o=>{r("user",o),c.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",o):k(o)},g=(o,s)=>{var A;const i=((A=o.planExecution)==null?void 0:A.agentExecutionSequence)??[];return s<0||s>=i.length?"IDLE":i[s].status??"IDLE"},D=(o,s)=>{var i,d;if(!((i=o.planExecution)!=null&&i.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:o.planExecution.currentPlanId,stepIndex:s,stepTitle:(d=o.planExecution.steps)==null?void 0:d[s]}),b("step-selected",o.planExecution.currentPlanId,s)},x=(o,s)=>{var i;try{const d=(i=o.planExecution)==null?void 0:i.agentExecutionSequence;if(!(d!=null&&d.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const A=d[s];if(!A)return console.log(`[ChatComponent] No agentExecution found for step ${s}`),[];if(!A.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${s}`),[];for(const T of A.thinkActSteps)if(T.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${s}:`,T.subPlanExecutionRecord),(T.subPlanExecutionRecord.steps??[]).map(L=>typeof L=="string"?L:typeof L=="object"&&L!==null&&(L.title||L.description)||"子步骤");return[]}catch(d){return console.warn("[ChatComponent] Error getting sub-plan steps:",d),[]}},P=(o,s,i)=>{var d;try{const A=(d=o.planExecution)==null?void 0:d.agentExecutionSequence;if(!(A!=null&&A.length))return"pending";const T=A[s];if(!T||!T.thinkActSteps)return"pending";let H=null;for(const N of T.thinkActSteps)if(N.subPlanExecutionRecord){H=N.subPlanExecutionRecord;break}if(!H)return"pending";const L=H.currentStepIndex;return H.completed?"completed":L==null?i===0?"current":"pending":i<L?"completed":i===L?"current":"pending"}catch(A){return console.warn("[ChatComponent] Error getting sub-plan step status:",A),"pending"}},I=(o,s,i)=>{var d,A;try{const T=(d=o.planExecution)==null?void 0:d.agentExecutionSequence;if(!(T!=null&&T.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const H=T[s];if(!H){console.warn("[ChatComponent] No agentExecution found for step",s);return}if(!H.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",s);return}let L=null;for(const N of H.thinkActSteps)if(N.subPlanExecutionRecord){L=N.subPlanExecutionRecord;break}if(!(L!=null&&L.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}b("sub-plan-step-selected",((A=o.planExecution)==null?void 0:A.currentPlanId)??"",L.currentPlanId,s,i)}catch(T){console.error("[ChatComponent] Error handling sub-plan step click:",T)}},K=(o,s)=>{var d,A,T,H;if(!((d=o.planExecution)!=null&&d.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",o.planExecution.steps.length,"execution sequence:",((A=s.agentExecutionSequence)==null?void 0:A.length)??0);const i=new Array(o.planExecution.steps.length).fill(null);if((T=s.agentExecutionSequence)!=null&&T.length){const L=Math.min(s.agentExecutionSequence.length,o.planExecution.steps.length);for(let N=0;N<L;N++){const w=s.agentExecutionSequence[N];if((H=w.thinkActSteps)!=null&&H.length){const M=w.thinkActSteps[w.thinkActSteps.length-1];M.actionDescription&&M.toolParameters?(i[N]={actionDescription:M.actionDescription,toolParameters:typeof M.toolParameters=="string"?M.toolParameters:JSON.stringify(M.toolParameters,null,2),thinkInput:M.thinkInput??"",thinkOutput:M.thinkOutput??"",status:s.currentStepIndex!==void 0&&N<s.currentStepIndex?"completed":s.currentStepIndex!==void 0&&N===s.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${N} action set: ${i[N].actionDescription}`)):(i[N]={actionDescription:"思考中",toolParameters:"等待决策",thinkInput:M.thinkInput??"",thinkOutput:M.thinkOutput??"",status:s.currentStepIndex!==void 0&&N===s.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${N} is thinking`))}else i[N]={actionDescription:s.currentStepIndex!==void 0&&N<s.currentStepIndex?"已完成":"等待中",toolParameters:"无工具参数",thinkInput:"",thinkOutput:"",status:s.currentStepIndex!==void 0&&N<s.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] 步骤 ${N} 无执行细节, 状态设为: ${i[N].status}`)}}else console.log("[ChatComponent] 没有执行序列数据");o.stepActions=[...i],console.log("[ChatComponent] 步骤动作更新完成:",JSON.stringify(i.map(L=>L==null?void 0:L.actionDescription))),le(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},se=o=>{console.log("[ChatComponent] Starting dialog round with planId:",o),o&&(R.value.findIndex(i=>{var d;return((d=i.planExecution)==null?void 0:d.currentPlanId)===o&&i.type==="assistant"})===-1?(r("assistant","",{planExecution:{currentPlanId:o},thinking:"正在准备执行计划..."}),console.log("[ChatComponent] Created new assistant message for planId:",o)):console.log("[ChatComponent] Found existing assistant message for planId:",o))},v=o=>{var T,H,L,N;console.log("[ChatComponent] Processing plan update with rootPlanId:",o);const s=Z.getCachedPlanRecord(o);if(!s){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",o);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",s),console.log("[ChatComponent] Plan steps:",s.steps),console.log("[ChatComponent] Plan completed:",s.completed),!s.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const i=R.value.findIndex(w=>{var M;return((M=w.planExecution)==null?void 0:M.currentPlanId)===s.currentPlanId&&w.type==="assistant"});let d;if(i!==-1)d=R.value[i],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",s.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",s.currentPlanId),console.log("[ChatComponent] Current messages:",R.value.map(M=>{var oe;return{type:M.type,planId:(oe=M.planExecution)==null?void 0:oe.currentPlanId,content:M.content.substring(0,50)}}));let w=-1;for(let M=R.value.length-1;M>=0;M--)if(R.value[M].type==="assistant"){w=M;break}if(w!==-1)d=R.value[w],d.planExecution||(d.planExecution={}),d.planExecution.currentPlanId=s.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",s.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(d.planExecution||(d.planExecution={}),d.planExecution=JSON.parse(JSON.stringify(s)),!s.steps||s.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),s.completed){delete d.thinking;const w=s.summary??s.result??s.message??"处理完成";d.content=_(w),console.log("[ChatComponent] Set simple response content:",d.content)}else s.title&&(d.thinking=`正在执行: ${s.title}`);return}delete d.thinking;const A=s.steps.map(w=>typeof w=="string"?w:typeof w=="object"&&w!==null&&(w.title||w.description)||"步骤");if(d.planExecution&&(d.planExecution.steps=A),s.agentExecutionSequence&&s.agentExecutionSequence.length>0){console.log("[ChatComponent] 发现执行序列数据，数量:",s.agentExecutionSequence.length),K(d,s);const w=s.currentStepIndex??0;if(w>=0&&w<s.agentExecutionSequence.length){const oe=s.agentExecutionSequence[w].thinkActSteps;if(oe&&oe.length>0){const fe=oe[oe.length-1];if(fe.thinkOutput){const we=fe.thinkOutput.length>150?fe.thinkOutput.substring(0,150)+"...":fe.thinkOutput;d.thinking=`正在思考: ${we}`}}}}else if(d.planExecution){const w=d.planExecution.currentStepIndex??0,M=(T=d.planExecution.steps)==null?void 0:T[w],oe=typeof M=="string"?M:"";d.thinking=`正在执行: ${oe}`}if(s.userInputWaitState&&d.planExecution?(console.log("[ChatComponent] 需要用户输入:",s.userInputWaitState),d.planExecution.userInputWaitState||(d.planExecution.userInputWaitState={}),d.planExecution.userInputWaitState={message:s.userInputWaitState.message??"",formDescription:s.userInputWaitState.formDescription??"",formInputs:((H=s.userInputWaitState.formInputs)==null?void 0:H.map(w=>({label:w.label,value:w.value||""})))??[]},j[L=d.id]??(j[L]={}),d.thinking="等待用户输入..."):(N=d.planExecution)!=null&&N.userInputWaitState&&delete d.planExecution.userInputWaitState,s.completed??s.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete d.thinking;let w="";s.summary?w=s.summary:s.result?w=s.result:w="任务已完成",d.content=O(w),console.log("[ChatComponent] Updated completed message:",d.content)}le(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},_=o=>o?o.includes("我")||o.includes("您")||o.includes("您好")||o.includes("可以")?o:o.length<10?`${o}！还有什么需要我帮助的吗？`:o.length<50?`好的，${o}。如果您还有其他问题，请随时告诉我。`:`${o}

希望这个回答对您有帮助！还有什么我可以为您做的吗？`:"我明白了，还有什么我可以帮您的吗？",O=o=>o?`${o}`:"任务已完成！还有什么我可以帮您的吗？",W=o=>{console.log("[ChatComponent] Plan completed with rootPlanId:",o);const s=Z.getCachedPlanRecord(o);if(!s){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",o);return}if(console.log("[ChatComponent] Plan details:",s),s.rootPlanId){const i=R.value.findIndex(d=>{var A;return((A=d.planExecution)==null?void 0:A.currentPlanId)===s.rootPlanId});if(i!==-1){const d=R.value[i];delete d.thinking;let T=s.summary??s.result??"任务已完成";!T.includes("我")&&!T.includes("您")&&(T.includes("成功")||T.includes("完成")?T=`很好！${T}。如果您还有其他需要帮助的地方，请随时告诉我。`:T=`我已经完成了您的请求：${T}`),d.content=T,console.log("[ChatComponent] Updated completed message:",d.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",s.rootPlanId)}},ue=o=>{if(!o)return"";let s=o.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return s=s.replace(/(<br><br>)/g,"</p><p>"),s.includes("</p><p>")&&(s=`<p>${s}</p>`),s},ye=async o=>{var s;if(!((s=o.planExecution)!=null&&s.currentPlanId)||!o.planExecution.userInputWaitState){console.error("[ChatComponent] 缺少planExecution.currentPlanId或userInputWaitState");return}try{const i={},d=o.planExecution.userInputWaitState.formInputs;d&&d.length>0?Object.entries(j[o.id]).forEach(([T,H])=>{var w;const L=parseInt(T,10),N=((w=d[L])==null?void 0:w.label)||`input_${T}`;i[N]=H}):i.genericInput=o.genericInput??"",console.log("[ChatComponent] 提交用户输入:",i);const A=await Ne.submitFormInput(o.planExecution.currentPlanId,i);delete o.planExecution.userInputWaitState,delete o.genericInput,delete j[o.id],y.startPolling(),console.log("[ChatComponent] 用户输入提交成功:",A)}catch(i){console.error("[ChatComponent] 用户输入提交失败:",i),alert(`提交失败: ${(i==null?void 0:i.message)||"未知错误"}`)}};return Te(()=>c.initialPrompt,(o,s)=>{console.log("[ChatComponent] initialPrompt changed from:",s,"to:",o),o&&typeof o=="string"&&o.trim()&&o!==s&&(console.log("[ChatComponent] Processing changed initial prompt:",o),le(()=>{f(o)}))},{immediate:!1}),ke(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),Z.setEventCallbacks({onPlanUpdate:v,onPlanCompleted:W,onDialogRoundStart:se,onChatInputUpdateState:o=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",o)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")}}),le(()=>{be()}),c.initialPrompt&&typeof c.initialPrompt=="string"&&c.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",c.initialPrompt),le(()=>{f(c.initialPrompt)}))}),$e(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),me(),Q.value&&clearInterval(Q.value),y.cleanup(),Object.keys(j).forEach(o=>delete j[o])}),t({handleSendMessage:f,handlePlanUpdate:v,handlePlanCompleted:W,handleDialogRoundStart:se,addMessage:r}),(o,s)=>(h(),m("div",Is,[e("div",{class:"messages",ref_key:"messagesRef",ref:C},[(h(!0),m(he,null,ge(R.value,i=>{var d,A,T,H,L,N,w,M,oe;return h(),m("div",{key:i.id,class:ie(["message",{user:i.type==="user",assistant:i.type==="assistant"}])},[e("div",xs,[i.type==="user"?(h(),m("div",Ts,l(i.content),1)):(h(),m("div",Rs,[i.thinking||((d=i.planExecution)==null?void 0:d.progress)!==void 0||(((T=(A=i.planExecution)==null?void 0:A.steps)==null?void 0:T.length)??0)>0?(h(),m("div",Ds,[e("div",As,[e("div",Ls,[$(a(E),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Ns,l(o.$t("chat.thinkingLabel")),1)]),e("div",Ms,[i.thinking?(h(),m("div",Us,[$(a(E),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,l(i.thinking),1)])):J("",!0),((H=i.planExecution)==null?void 0:H.progress)!==void 0?(h(),m("div",Vs,[e("div",Os,[e("div",{class:"progress-fill",style:Re({width:i.planExecution.progress+"%"})},null,4)]),e("span",qs,l(i.planExecution.progressText??o.$t("chat.processing")+"..."),1)])):J("",!0),(((N=(L=i.planExecution)==null?void 0:L.steps)==null?void 0:N.length)??0)>0?(h(),m("div",js,[e("h4",Fs,l(o.$t("chat.stepExecutionDetails")),1),(h(!0),m(he,null,ge((w=i.planExecution)==null?void 0:w.steps,(fe,U)=>{var we,Me,Ue,Ve,Oe,qe,je,Fe,Je,Be,We,Ge,He,ze,Xe,Ke,Qe,Ye,Ze;return h(),m("div",{key:U,class:ie(["ai-section",{running:g(i,U)==="RUNNING",completed:g(i,U)==="FINISHED",pending:g(i,U)==="IDLE"}]),onClick:xe(ce=>D(i,U),["stop"])},[e("div",Bs,[e("span",Ws,l(g(i,U)==="FINISHED"?"✓":g(i,U)==="RUNNING"?"▶":"○"),1),e("span",Gs,l(fe||`${o.$t("chat.step")} ${U+1}`),1),g(i,U)==="RUNNING"?(h(),m("span",Hs,l(o.$t("chat.status.executing")),1)):g(i,U)==="FINISHED"?(h(),m("span",zs,l(o.$t("chat.status.completed")),1)):(h(),m("span",Xs,l(o.$t("chat.status.pending")),1))]),i.stepActions&&i.stepActions[U]?(h(),m("div",Ks,[e("div",Qs,[e("span",Ys,l(((we=i.stepActions[U])==null?void 0:we.status)==="current"?"🔄":((Me=i.stepActions[U])==null?void 0:Me.status)==="completed"?"✓":"⏳"),1),e("strong",null,l((Ue=i.stepActions[U])==null?void 0:Ue.actionDescription),1)]),(Ve=i.stepActions[U])!=null&&Ve.toolParameters?(h(),m("div",Zs,[s[0]||(s[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",eo,l(o.$t("common.parameters"))+":",1),e("pre",to,l((Oe=i.stepActions[U])==null?void 0:Oe.toolParameters),1)])):J("",!0),(qe=i.stepActions[U])!=null&&qe.thinkOutput?(h(),m("div",no,[e("div",so,[s[1]||(s[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",oo,l(o.$t("chat.thinkingOutput"))+":",1)]),e("div",ao,[e("pre",io,l((je=i.stepActions[U])==null?void 0:je.thinkOutput),1)])])):J("",!0)])):J("",!0),((Fe=x(i,U))==null?void 0:Fe.length)>0?(h(),m("div",lo,[e("div",co,[$(a(E),{icon:"carbon:tree-view",class:"sub-plan-icon"}),s[2]||(s[2]=e("span",{class:"sub-plan-title"},"子执行计划",-1))]),e("div",ro,[(h(!0),m(he,null,ge(x(i,U),(ce,ae)=>(h(),m("div",{key:`sub-${U}-${ae}`,class:ie(["sub-plan-step-item",{completed:P(i,U,ae)==="completed",current:P(i,U,ae)==="current",pending:P(i,U,ae)==="pending"}]),onClick:xe(et=>I(i,U,ae),["stop"])},[e("div",po,[e("span",ho,l(P(i,U,ae)==="completed"?"✓":P(i,U,ae)==="current"?"▶":"○"),1),e("span",go,l(ae+1),1)]),e("div",mo,[e("span",fo,l(ce),1),s[3]||(s[3]=e("span",{class:"sub-step-badge"},"子步骤",-1))])],10,uo))),128))])])):J("",!0),(Je=i.planExecution)!=null&&Je.userInputWaitState&&g(i,U)==="RUNNING"?(h(),m("div",vo,[e("p",Po,l(((We=(Be=i.planExecution)==null?void 0:Be.userInputWaitState)==null?void 0:We.message)??o.$t("chat.userInput.message")),1),(He=(Ge=i.planExecution)==null?void 0:Ge.userInputWaitState)!=null&&He.formDescription?(h(),m("p",_o,l((Xe=(ze=i.planExecution)==null?void 0:ze.userInputWaitState)==null?void 0:Xe.formDescription),1)):J("",!0),e("form",{onSubmit:xe(ce=>ye(i),["prevent"]),class:"user-input-form"},[(Qe=(Ke=i.planExecution)==null?void 0:Ke.userInputWaitState)!=null&&Qe.formInputs&&i.planExecution.userInputWaitState.formInputs.length>0?(h(!0),m(he,{key:0},ge((Ze=(Ye=i.planExecution)==null?void 0:Ye.userInputWaitState)==null?void 0:Ze.formInputs,(ce,ae)=>(h(),m("div",{key:ae,class:"form-group"},[e("label",{for:`form-input-${ce.label.replace(/\W+/g,"_")}`},l(ce.label)+": ",9,So),Pe(e("input",{type:"text",id:`form-input-${ce.label.replace(/\W+/g,"_")}`,name:ce.label,"onUpdate:modelValue":et=>j[i.id][ae]=et,class:"form-input"},null,8,Co),[[_e,j[i.id][ae]]])]))),128)):(h(),m("div",ko,[e("label",$o,l(o.$t("common.input"))+":",1),Pe(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":ce=>i.genericInput=ce,class:"form-input"},null,8,Eo),[[_e,i.genericInput]])])),e("button",yo,l(o.$t("chat.userInput.submit")),1)],40,bo)])):J("",!0)],10,Js)}),128))])):!i.content&&(i.thinking||((M=i.planExecution)==null?void 0:M.progress)!==void 0&&(((oe=i.planExecution)==null?void 0:oe.progress)??0)<100)?(h(),m("div",wo,[e("div",Io,[s[4]||(s[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,l(i.thinking??o.$t("chat.thinkingProcessing")),1)])])):J("",!0)])])):J("",!0),e("div",xo,[e("div",To,[e("div",Ro,[$(a(E),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Do,l(o.$t("chat.botName")),1)]),e("div",Ao,[i.content?(h(),m("div",Lo,[e("div",{class:"response-text",innerHTML:ue(i.content)},null,8,No)])):(h(),m("div",Mo,[e("div",Uo,[s[5]||(s[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Vo,l(o.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),X.value?(h(),m("div",Oo,[e("div",qo,[e("div",jo,[e("div",Fo,[e("div",Jo,[e("div",Bo,[$(a(E),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Wo,l(o.$t("chat.thinkingLabel")),1)]),e("div",Go,[e("div",Ho,[e("div",zo,[s[6]||(s[6]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,l(o.$t("chat.thinking")),1)])])])]),e("div",Xo,[e("div",Ko,[e("div",Qo,[$(a(E),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Yo,l(o.$t("chat.botName")),1)]),e("div",Zo,[e("div",ea,[e("div",ta,[s[7]||(s[7]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",na,l(o.$t("chat.thinkingResponse")),1)])])])])])])])):J("",!0)],512),z.value?(h(),m("div",{key:0,class:"scroll-to-bottom-btn",onClick:ee,title:o.$t("chat.scrollToBottom")},[$(a(E),{icon:"carbon:chevron-down"})],8,sa)):J("",!0)]))}}),aa=Ee(oa,[["__scopeId","data-v-d1fb4f30"]]),ia={class:"input-area"},la={class:"input-container"},ca={class:"attach-btn",title:"附加文件"},ra=["placeholder","disabled"],ua=["title"],da=["disabled","title"],pa=Se({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1}},emits:["send","clear","update-state","plan-mode-clicked"],setup(B,{expose:t,emit:n}){const{t:c}=Ce(),b=B,u=n,y=q(),C=q(""),X=de(()=>b.placeholder||c("input.placeholder")),R=q(X.value),Q=de(()=>!!b.disabled),z=()=>{le(()=>{y.value&&(y.value.style.height="auto",y.value.style.height=Math.min(y.value.scrollHeight,120)+"px")})},j=V=>{V.key==="Enter"&&!V.shiftKey&&(V.preventDefault(),r())},r=()=>{if(!C.value.trim()||Q.value)return;const V=C.value.trim();u("send",V),k()},S=()=>{u("plan-mode-clicked")},k=()=>{C.value="",z(),u("clear")};return t({clearInput:k,updateState:(V,ee)=>{ee&&(R.value=V?ee:c("input.waiting")),u("update-state",V,ee)},getQuery:()=>C.value.trim(),focus:()=>{var V;return(V=y.value)==null?void 0:V.focus()}}),ke(()=>{}),$e(()=>{}),(V,ee)=>(h(),m("div",ia,[e("div",la,[e("button",ca,[$(a(E),{icon:"carbon:attachment"})]),Pe(e("textarea",{"onUpdate:modelValue":ee[0]||(ee[0]=te=>C.value=te),ref_key:"inputRef",ref:y,class:"chat-input",placeholder:R.value,disabled:Q.value,onKeydown:j,onInput:z},null,40,ra),[[_e,C.value]]),e("button",{class:"plan-mode-btn",title:V.$t("input.planMode"),onClick:S},[$(a(E),{icon:"carbon:document"}),ne(" "+l(V.$t("input.planMode")),1)],8,ua),e("button",{class:"send-button",disabled:!C.value.trim()||Q.value,onClick:r,title:V.$t("input.send")},[$(a(E),{icon:"carbon:send-alt"}),ne(" "+l(V.$t("input.send")),1)],8,da)])]))}}),ha=Ee(pa,[["__scopeId","data-v-c8e17afe"]]),ga={class:"direct-page"},ma={class:"direct-chat"},fa={class:"chat-header"},va={class:"header-actions"},Pa=["title"],_a={class:"chat-content"},ba=["title"],Sa=Se({__name:"index",setup(B){const t=at(),n=it(),c=ct(),{t:b}=Ce(),u=q(""),y=q(),C=q(),X=q(),R=q(!1),Q=q(!1),z=q(null),j=q(50),r=q(!1),S=q(0),k=q(0);ke(()=>{console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",c.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",c.hasUnprocessedTask()),Z.setEventCallbacks({onPlanUpdate:_=>{console.log("[Direct] Plan update event received for rootPlanId:",_),te(_)&&(console.log("[Direct] Processing plan update for current rootPlanId:",_),C.value&&typeof C.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",_),C.value.handlePlanUpdate(_)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),y.value&&typeof y.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",_),y.value.updateDisplayedPlanProgress(_)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:_=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",_),!!te(_)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",_),C.value&&typeof C.value.handlePlanCompleted=="function"){const O=Z.getCachedPlanRecord(_);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",O),C.value.handlePlanCompleted(O??{planId:_})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");z.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:_=>{console.log("[Direct] Dialog round start event received for rootPlanId:",_),z.value=_,console.log("[Direct] Set currentRootPlanId to:",_),C.value&&typeof C.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",_),C.value.handleDialogRoundStart(_)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),me()},onChatInputUpdateState:_=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",_),!te(_,!0))return;const O=Z.getCachedUIState(_);O&&g(O.enabled,O.placeholder)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),p.loadPlanTemplateList(),c.hasUnprocessedTask()&&c.currentTask?(u.value=c.currentTask.prompt,console.log("[Direct] Setting prompt from store:",u.value),c.markTaskAsProcessed(),console.log("[Direct] Received task from store:",u.value)):(u.value=t.query.prompt||"",console.log("[Direct] Received task from URL:",u.value),console.log("[Direct] No unprocessed task in store"));const v=localStorage.getItem("directPanelWidth");v&&(j.value=parseFloat(v)),console.log("[Direct] Final prompt value:",u.value)}),Te(()=>c.currentTask,v=>{console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",v),v&&!v.processed?(u.value=v.prompt,c.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",u.value)):console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),Te(()=>u.value,(v,_)=>{console.log("[Direct] prompt value changed from:",_,"to:",v)},{immediate:!1}),$e(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),z.value=null,Z.cleanup(),document.removeEventListener("mousemove",G),document.removeEventListener("mouseup",V)});const Y=v=>{r.value=!0,S.value=v.clientX,k.value=j.value,document.addEventListener("mousemove",G),document.addEventListener("mouseup",V),document.body.style.cursor="col-resize",document.body.style.userSelect="none",v.preventDefault()},G=v=>{if(!r.value)return;const _=window.innerWidth,W=(v.clientX-S.value)/_*100;let ue=k.value+W;ue=Math.max(20,Math.min(80,ue)),j.value=ue},V=()=>{r.value=!1,document.removeEventListener("mousemove",G),document.removeEventListener("mouseup",V),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",j.value.toString())},ee=()=>{j.value=50,localStorage.setItem("directPanelWidth","50")},te=(v,_=!1)=>!z.value||v===z.value||_&&(v==="ui-state"||v==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",v,"current:",z.value),!1),be=v=>{console.log("[DirectView] Send message from input:",v),C.value&&typeof C.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",v),C.value.handleSendMessage(v)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},me=()=>{console.log("[DirectView] Input cleared"),X.value&&typeof X.value.clear=="function"&&X.value.clear()},f=()=>{console.log("[DirectView] Input focused")},g=(v,_)=>{console.log("[DirectView] Input state updated:",v,_),Q.value=!v},D=(v,_)=>{console.log("[DirectView] Step selected:",v,_),y.value&&typeof y.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",v,_),y.value.handleStepSelected(v,_)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},x=(v,_,O,W)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:v,subPlanId:_,stepIndex:O,subStepIndex:W}),y.value&&typeof y.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:v,subPlanId:_,stepIndex:O,subStepIndex:W}),y.value.handleSubPlanStepSelected(v,_,O,W)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},P=()=>{console.log("[DirectView] Plan mode button clicked"),p.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",p.isCollapsed)},I=()=>{n.push("/home")},K=()=>{n.push("/configs")},se=async v=>{var _;if(console.log("[DirectView] Plan execution requested:",v),R.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}R.value=!0,C.value&&typeof C.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",v.title),C.value.addMessage("user",v.title)):console.warn("[DirectView] chatRef.addMessage method not available");try{const O=v.planData.planTemplateId||v.planData.planId;if(!O)throw new Error("没有找到计划模板ID");console.log("[Direct] Executing plan with templateId:",O,"params:",v.params),console.log("[Direct] About to call PlanActApiService.executePlan");let W;if((_=v.params)!=null&&_.trim()?(console.log("[Direct] Calling executePlan with params:",v.params.trim()),W=await re.executePlan(O,v.params.trim())):(console.log("[Direct] Calling executePlan without params"),W=await re.executePlan(O)),console.log("[Direct] Plan execution API response:",W),W.planId)console.log("[Direct] Got planId from response:",W.planId,"starting plan execution"),z.value=W.planId,console.log("[Direct] Set currentRootPlanId to:",W.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),Z.handlePlanExecutionRequested(W.planId,v.title);else throw console.error("[Direct] No planId in response:",W),new Error("执行计划失败：未返回有效的计划ID")}catch(O){console.error("[Direct] Plan execution failed:",O),console.error("[Direct] Error details:",{message:O.message,stack:O.stack}),z.value=null,C.value&&typeof C.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),C.value.addMessage("user",v.title),C.value.addMessage("assistant",`执行计划失败: ${O.message||"未知错误"}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`执行计划失败: ${O.message||"未知错误"}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),R.value=!1}};return(v,_)=>(h(),m("div",ga,[e("div",ma,[$(un,{onPlanExecutionRequested:se}),e("div",{class:"left-panel",style:Re({width:j.value+"%"})},[e("div",fa,[e("button",{class:"back-button",onClick:I},[$(a(E),{icon:"carbon:arrow-left"})]),e("h2",null,l(v.$t("conversation")),1),e("div",va,[$(lt),e("button",{class:"config-button",onClick:K,title:v.$t("direct.configuration")},[$(a(E),{icon:"carbon:settings-adjust",width:"20"})],8,Pa)])]),e("div",_a,[$(aa,{ref_key:"chatRef",ref:C,mode:"direct","initial-prompt":u.value||"",onStepSelected:D,onSubPlanStepSelected:x},null,8,["initial-prompt"])]),(h(),ve(ha,{key:v.$i18n.locale,ref_key:"inputRef",ref:X,disabled:Q.value,placeholder:Q.value?a(b)("input.waiting"):a(b)("input.placeholder"),onSend:be,onClear:me,onFocus:f,onUpdateState:g,onPlanModeClicked:P},null,8,["disabled","placeholder"]))],4),e("div",{class:"panel-resizer",onMousedown:Y,onDblclick:ee,title:v.$t("direct.panelResizeHint")},_[0]||(_[0]=[e("div",{class:"resizer-line"},null,-1)]),40,ba),$(ys,{ref_key:"rightPanelRef",ref:y,style:Re({width:100-j.value+"%"})},null,8,["style"])])]))}}),wa=Ee(Sa,[["__scopeId","data-v-e22ae6d7"]]);export{wa as default};
