var bt=Object.defineProperty;var _t=(T,t,n)=>t in T?bt(T,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):T[t]=n;var me=(T,t,n)=>_t(T,typeof t!="symbol"?t+"":t,n);import{d as Ie,u as Fe,c as Pe,o as De,a as p,b as r,n as ie,i as s,e,f as A,t as o,g,h as le,F as fe,q as ye,j as ce,w as pe,m as ve,A as Ge,r as E,l as _e,T as Le,p as qe,B as Be,C as xe,y as je,D as yt,E as Ee,z as ge,G as gt,H as kt,x as ft,I as wt}from"./index-BAsjVs3v.js";import{I as $,_ as Te}from"./_plugin-vue_export-helper-DyQRJVd8.js";import{s as S,P as We,u as $t}from"./sidebar-NbxLGp_e.js";import{L as Ct}from"./llm-check-BVkAKrj3.js";import{L as Pt}from"./index-R30Cp9Ys.js";import{u as St,a as Et}from"./useMessage-CDxWNfKt.js";const It={class:"sidebar-content"},Tt={class:"sidebar-content-header"},xt={class:"sidebar-content-title"},Dt={class:"tab-switcher"},Rt=["disabled"],Mt={key:0,class:"tab-content"},Ft={class:"new-task-section"},At={class:"sidebar-content-list"},Ut={key:0,class:"loading-state"},Nt={key:1,class:"error-state"},Lt={key:2,class:"empty-state"},qt=["onClick"],Bt={class:"task-icon"},Vt={class:"task-details"},jt={class:"task-title"},Wt={class:"task-preview"},Ot={class:"task-time"},zt={class:"task-actions"},Ht=["title","onClick"],Jt={key:1,class:"tab-content config-tab"},Gt={key:0,class:"config-container"},Kt={class:"template-info-header"},Xt={class:"template-info"},Qt={class:"template-id"},Yt={class:"config-section"},Zt={class:"section-header"},en={class:"generator-content"},tn=["placeholder"],nn={class:"generator-actions"},on=["disabled"],sn=["disabled"],an={class:"config-section"},ln={class:"section-header"},cn={class:"section-actions"},rn=["disabled","title"],dn=["disabled","title"],un=["disabled"],pn=["placeholder"],hn={class:"config-section"},mn={class:"section-header"},vn={class:"execution-content"},gn={class:"params-input-group"},fn={class:"params-help-text"},$n={class:"params-input-container"},bn=["placeholder"],_n=["title"],yn={class:"api-url-display"},kn={class:"api-url-label"},wn={class:"api-url"},Cn={class:"api-url-display"},Pn={class:"api-url-label"},Sn=["disabled"],En=Ie({__name:"index",emits:["planExecutionRequested"],setup(T,{expose:t,emit:n}){const{t:l}=Fe(),v=["currentPlanId","userRequest","rootPlanId"],b=Pe({get(){try{if(!S.jsonContent)return"";const y={...JSON.parse(S.jsonContent)};return v.forEach(P=>{delete y[P]}),JSON.stringify(y,null,2)}catch{return S.jsonContent}},set(a){try{if(!a.trim()){S.jsonContent="";return}const y=JSON.parse(a);let P={};try{P=JSON.parse(S.jsonContent||"{}")}catch{}const G={...y};v.forEach(x=>{P[x]!==void 0&&(G[x]=P[x])}),S.jsonContent=JSON.stringify(G)}catch{S.jsonContent=a}}}),u=n,M=async()=>{try{const a=await S.saveTemplate();a!=null&&a.duplicate?alert(l("sidebar.saveCompleted",{message:a.message,versionCount:a.versionCount})):a!=null&&a.saved?alert(l("sidebar.saveSuccess",{message:a.message,versionCount:a.versionCount})):a!=null&&a.message&&alert(l("sidebar.saveStatus",{message:a.message}))}catch(a){console.error("Failed to save plan modifications:",a),alert(a.message||l("sidebar.saveFailed"))}},U=async()=>{var a;try{await S.generatePlan(),alert(l("sidebar.generateSuccess",{templateId:((a=S.selectedTemplate)==null?void 0:a.id)??l("sidebar.unknown")}))}catch(y){console.error("Failed to generate plan:",y),alert(l("sidebar.generateFailed")+": "+y.message)}},w=async()=>{try{await S.updatePlan(),alert(l("sidebar.updateSuccess"))}catch(a){console.error("Failed to update plan:",a),alert(l("sidebar.updateFailed")+": "+a.message)}},F=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const a=S.preparePlanExecution();if(!a){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] Triggering plan execution request:",a),console.log("[Sidebar] Emitting planExecutionRequested event"),u("planExecutionRequested",a),console.log("[Sidebar] Event emitted")}catch(a){console.error("Error executing plan:",a),alert(l("sidebar.executeFailed")+": "+a.message)}finally{S.finishPlanExecution()}},L=a=>{if(isNaN(a.getTime()))return console.warn("Invalid date received:",a),l("time.unknown");const P=new Date().getTime()-a.getTime(),G=Math.floor(P/6e4),x=Math.floor(P/36e5),R=Math.floor(P/864e5);return G<1?l("time.now"):G<60?l("time.minuteAgo",{count:G}):x<24?l("time.hourAgo",{count:x}):R<30?l("time.dayAgo",{count:R}):a.toLocaleDateString("zh-CN")},W=(a,y)=>!a||a.length<=y?a:a.substring(0,y)+"...";return De(()=>{S.loadPlanTemplateList()}),t({loadPlanTemplateList:S.loadPlanTemplateList,toggleSidebar:S.toggleSidebar,currentPlanTemplateId:S.currentPlanTemplateId}),(a,y)=>(r(),p("div",{class:ie(["sidebar-wrapper",{"sidebar-wrapper-collapsed":s(S).isCollapsed}])},[e("div",It,[e("div",Tt,[e("div",xt,o(a.$t("sidebar.title")),1)]),e("div",Dt,[e("button",{class:ie(["tab-button",{active:s(S).currentTab==="list"}]),onClick:y[0]||(y[0]=P=>s(S).switchToTab("list"))},[g(s($),{icon:"carbon:list",width:"16"}),le(" "+o(a.$t("sidebar.templateList")),1)],2),e("button",{class:ie(["tab-button",{active:s(S).currentTab==="config"}]),onClick:y[1]||(y[1]=P=>s(S).switchToTab("config")),disabled:!s(S).selectedTemplate},[g(s($),{icon:"carbon:settings",width:"16"}),le(" "+o(a.$t("sidebar.configuration")),1)],10,Rt)]),s(S).currentTab==="list"?(r(),p("div",Mt,[e("div",Ft,[e("button",{class:"new-task-btn",onClick:y[2]||(y[2]=P=>s(S).createNewTemplate())},[g(s($),{icon:"carbon:add",width:"16"}),le(" "+o(a.$t("sidebar.newPlan"))+" ",1),y[11]||(y[11]=e("span",{class:"shortcut"},"âŒ˜ K",-1))])]),e("div",At,[s(S).isLoading?(r(),p("div",Ut,[g(s($),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,o(a.$t("sidebar.loading")),1)])):s(S).errorMessage?(r(),p("div",Nt,[g(s($),{icon:"carbon:warning",width:"20"}),e("span",null,o(s(S).errorMessage),1),e("button",{onClick:y[3]||(y[3]=(...P)=>s(S).loadPlanTemplateList&&s(S).loadPlanTemplateList(...P)),class:"retry-btn"},o(a.$t("sidebar.retry")),1)])):s(S).planTemplateList.length===0?(r(),p("div",Lt,[g(s($),{icon:"carbon:document",width:"32"}),e("span",null,o(a.$t("sidebar.noTemplates")),1)])):(r(!0),p(fe,{key:3},ye(s(S).sortedTemplates,P=>(r(),p("div",{key:P.id,class:ie(["sidebar-content-list-item",{"sidebar-content-list-item-active":P.id===s(S).currentPlanTemplateId}]),onClick:G=>s(S).selectTemplate(P)},[e("div",Bt,[g(s($),{icon:"carbon:document",width:"20"})]),e("div",Vt,[e("div",jt,o(P.title||a.$t("sidebar.unnamedPlan")),1),e("div",Wt,o(W(P.description||a.$t("sidebar.noDescription"),40)),1)]),e("div",Ot,o(L(s(S).parseDateTime(P.updateTime||P.createTime))),1),e("div",zt,[e("button",{class:"delete-task-btn",title:a.$t("sidebar.deleteTemplate"),onClick:ce(G=>s(S).deleteTemplate(P),["stop"])},[g(s($),{icon:"carbon:close",width:"16"})],8,Ht)])],10,qt))),128))])])):s(S).currentTab==="config"?(r(),p("div",Jt,[s(S).selectedTemplate?(r(),p("div",Gt,[e("div",Kt,[e("div",Xt,[e("h3",null,o(s(S).selectedTemplate.title||a.$t("sidebar.unnamedPlan")),1),e("span",Qt,"ID: "+o(s(S).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:y[4]||(y[4]=P=>s(S).switchToTab("list"))},[g(s($),{icon:"carbon:arrow-left",width:"16"})])]),e("div",Yt,[e("div",Zt,[g(s($),{icon:"carbon:generate",width:"16"}),e("span",null,o(a.$t("sidebar.planGenerator")),1)]),e("div",en,[pe(e("textarea",{"onUpdate:modelValue":y[5]||(y[5]=P=>s(S).generatorPrompt=P),class:"prompt-input",placeholder:a.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,tn),[[ve,s(S).generatorPrompt]]),e("div",nn,[e("button",{class:"btn btn-primary btn-sm",onClick:U,disabled:s(S).isGenerating||!s(S).generatorPrompt.trim()},[g(s($),{icon:s(S).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:ie({spinning:s(S).isGenerating})},null,8,["icon","class"]),le(" "+o(s(S).isGenerating?a.$t("sidebar.generating"):a.$t("sidebar.generatePlan")),1)],8,on),e("button",{class:"btn btn-secondary btn-sm",onClick:w,disabled:s(S).isGenerating||!s(S).generatorPrompt.trim()||!s(S).jsonContent.trim()},[g(s($),{icon:"carbon:edit",width:"14"}),le(" "+o(a.$t("sidebar.updatePlan")),1)],8,sn)])])]),e("div",an,[e("div",ln,[g(s($),{icon:"carbon:code",width:"16"}),e("span",null,o(a.$t("sidebar.jsonTemplate")),1),e("div",cn,[e("button",{class:"btn btn-sm",onClick:y[6]||(y[6]=(...P)=>s(S).rollbackVersion&&s(S).rollbackVersion(...P)),disabled:!s(S).canRollback,title:a.$t("sidebar.rollback")},[g(s($),{icon:"carbon:undo",width:"14"})],8,rn),e("button",{class:"btn btn-sm",onClick:y[7]||(y[7]=(...P)=>s(S).restoreVersion&&s(S).restoreVersion(...P)),disabled:!s(S).canRestore,title:a.$t("sidebar.restore")},[g(s($),{icon:"carbon:redo",width:"14"})],8,dn),e("button",{class:"btn btn-primary btn-sm",onClick:M,disabled:s(S).isGenerating||s(S).isExecuting},[g(s($),{icon:"carbon:save",width:"14"})],8,un)])]),pe(e("textarea",{"onUpdate:modelValue":y[8]||(y[8]=P=>b.value=P),class:"json-editor",placeholder:a.$t("sidebar.jsonPlaceholder"),rows:"12"},null,8,pn),[[ve,b.value]])]),e("div",hn,[e("div",mn,[g(s($),{icon:"carbon:play",width:"16"}),e("span",null,o(a.$t("sidebar.executionController")),1)]),e("div",vn,[e("div",gn,[e("label",null,o(a.$t("sidebar.executionParams")),1),e("div",fn,o(a.$t("sidebar.executionParamsHelp")),1),e("div",$n,[pe(e("input",{"onUpdate:modelValue":y[9]||(y[9]=P=>s(S).executionParams=P),class:"params-input",placeholder:a.$t("sidebar.executionParamsPlaceholder")},null,8,bn),[[ve,s(S).executionParams]]),e("button",{class:"clear-params-btn",onClick:y[10]||(y[10]=(...P)=>s(S).clearExecutionParams&&s(S).clearExecutionParams(...P)),title:a.$t("sidebar.clearParams")},[g(s($),{icon:"carbon:close",width:"12"})],8,_n)])]),e("div",yn,[e("span",kn,o(a.$t("sidebar.apiUrl"))+":",1),e("code",wn,o(s(S).computedApiUrl),1)]),e("div",Cn,[e("span",Pn,o(a.$t("sidebar.statusApiUrl"))+":",1),y[12]||(y[12]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:F,disabled:s(S).isExecuting||s(S).isGenerating},[g(s($),{icon:s(S).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:ie({spinning:s(S).isExecuting})},null,8,["icon","class"]),le(" "+o(s(S).isExecuting?a.$t("sidebar.executing"):a.$t("sidebar.executePlan")),1)],8,Sn)])])])):A("",!0)])):A("",!0)])],2))}}),In=Te(En,[["__scopeId","data-v-b3ed0b42"]]);class Ve{static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}static async getMemories(){try{const t=await fetch(`${this.BASE_URL}`);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get memory list:",t),t}}static async getMemory(t){try{const n=await fetch(`${this.BASE_URL}/single?memoryId=${t}`);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get memory :",n),n}}static async update(t,n){try{const l=await fetch(`${this.BASE_URL}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({memoryId:t,memoryName:n})});return await(await this.handleResponse(l)).json()}catch(l){throw console.error("Failed to update memory:",l),l}}static async delete(t){try{const n=await fetch(`${this.BASE_URL}/delete?memoryId=${t}`);await this.handleResponse(n)}catch(n){throw console.error("Failed to update memory:",n),n}}}me(Ve,"BASE_URL","/api/memories");class Tn{constructor(){me(this,"isCollapsed",!1);me(this,"selectMemoryId","");me(this,"loadMessages",()=>{});me(this,"intervalId")}toggleSidebar(){this.isCollapsed=!this.isCollapsed,this.isCollapsed?(this.loadMessages(),this.intervalId=window.setInterval(()=>{this.loadMessages()},3e3)):clearInterval(this.intervalId)}selectMemory(t){this.toggleSidebar(),this.selectMemoryId=t}setMemory(t){this.selectMemoryId=t}defaultMemoryId(){this.selectMemoryId=this.generateRandomId()}clearMemoryId(){this.selectMemoryId=""}generateRandomId(){return Math.random().toString(36).substring(2,10)}setLoadMessages(t){this.loadMessages=t}}const Se=Ge(new Tn),xn={key:0,class:"app-container"},Dn={class:"app-content"},Rn={class:"header"},Mn={class:"relative"},Fn={class:"title-edit-group"},An={id:"main-title",class:"main-title"},Un={key:0,id:"title-edit-container",class:"title-edit-container"},Nn={class:"search-bar"},Ln={class:"search-container"},qn=["placeholder"],Bn={class:"message-list",id:"message-list"},Vn={class:"message-header"},jn={class:"message-content"},Wn={class:"sender-info"},On=["onClick"],zn={class:"sender-name"},Hn=["onClick"],Jn={class:"action-buttons"},Gn=["onClick"],Kn={class:"action-buttons"},Xn=["onClick"],Qn={class:"message-preview"},Yn={class:"preview-line"},Zn={key:0,class:"preview-line",style:{opacity:"0.8"}},eo={class:"message-meta"},to={class:"message-id"},no={class:"meta-right"},oo={key:0,class:"unread-count"},so={class:"message-time"},ao=["id"],lo={style:{display:"flex","flex-direction":"column",gap:"0.75rem"}},io={class:"bubble-avatar"},co={class:"bubble-content"},ro={class:"bubble-text"},uo={key:0,class:"empty-state"},po={class:"modal-content"},ho={class:"modal-header"},mo={class:"modal-title"},vo=["placeholder"],go={id:"name-char-count",class:"char-count",style:{"text-align":"right",display:"block","margin-top":"0.25rem"}},fo={class:"modal-footer"},$o={class:"modal-content"},bo={class:"modal-header"},_o={class:"modal-title"},yo={class:"state-text",id:"delete-message"},ko={class:"modal-footer"},wo=Ie({__name:"index",emits:["memory-selected"],setup(T,{emit:t}){const n=E(!1),l=E(""),v=E([]),b=E([]),u=E(!1),M=E(null),U=E(""),w=E(!1),F=E(null),L=new Map,W=t;De(()=>{Se.setLoadMessages(a)});const a=async()=>{try{const D=await Ve.getMemories();v.value?v.value=D.map(j=>({...j,expanded:L.has(j.memoryId)?L.get(j.memoryId):!1})):v.value=D.map(j=>({...j,expanded:!1})),b.value=[...v.value],G()}catch(D){console.error("error:",D),v.value=[],b.value=[]}},y=D=>{Se.selectMemory(D),W("memory-selected")},P=D=>{const j=typeof D=="string"?parseInt(D,10):D;return isNaN(j)||j<=0?"unknow time":new Date(j.toString().length===13?j:j*1e3).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(","," ")},G=()=>{const D=l.value.toLowerCase().trim();if(!D){b.value=[...v.value];return}b.value=v.value.filter(j=>{const q=j.memoryName.toLowerCase().includes(D),X=j.memoryId.toLowerCase().includes(D),we=j.messages.some(m=>m.text.toLowerCase().includes(D));return q||X||we})},x=(D,j)=>{M.value=D,U.value=j,u.value=!0},R=()=>{u.value=!1,M.value=null},ue=async()=>{if(!M.value)return;const D=U.value.trim()||"unknow name",j=v.value.findIndex(q=>q.memoryId===M.value);if(j!==-1){const q=v.value[j];try{const X=await Ve.update(q.memoryId,D);X.messages||(X.messages=[]),v.value[j]={...X,expanded:q.expanded},G(),u.value=!1}catch(X){console.error("error:",X)}}},oe=D=>{const j=v.value.find(q=>q.memoryId===D);if(j){j.expanded=!j.expanded,L.set(D,j.expanded);const q=b.value.findIndex(X=>X.memoryId===D);q!==-1&&(b.value[q]={...j})}},N=D=>{F.value=D,w.value=!0},Q=()=>{w.value=!1,F.value=null},se=async()=>{if(F.value)try{await Ve.delete(F.value),v.value=v.value.filter(D=>D.memoryId!==F.value),G(),v.value.length===0&&Se.clearMemoryId(),w.value=!1,F.value=null}catch(D){console.error("error:",D)}};return(D,j)=>(r(),_e(Be,{to:"body"},[g(Le,{name:"modal"},{default:qe(()=>[s(Se).isCollapsed?(r(),p("div",xn,[e("div",Dn,[e("div",Rn,[e("div",Mn,[e("div",Fn,[e("h1",An,[e("span",null,o(D.$t("memory.title")),1)])]),n.value?(r(),p("div",Un)):A("",!0)]),e("button",{class:"close-btn",onClick:j[0]||(j[0]=q=>s(Se).toggleSidebar())},[g(s($),{icon:"carbon:close"})])]),e("div",Nn,[e("div",Ln,[g(s($),{class:"search-container-icon",icon:"carbon:search"}),pe(e("input",{type:"text",placeholder:D.$t("memory.searchPlaceholder"),class:"search-input","onUpdate:modelValue":j[1]||(j[1]=q=>l.value=q),onInput:G},null,40,qn),[[ve,l.value]])])]),e("div",Bn,[e("div",null,[(r(!0),p(fe,null,ye(b.value,q=>(r(),p("div",{class:ie(["message-item",{expanded:q.expanded}]),key:q.memoryId},[e("div",Vn,[e("div",jn,[e("div",Wn,[e("div",{class:"sender-div",onClick:ce(X=>y(q.memoryId),["stop"])},[e("h3",zn,o(q.memoryName),1)],8,On),e("div",{class:"toggle-container",onClick:ce(X=>x(q.memoryId,q.memoryName),["stop"])},[g(s($),{icon:"carbon:edit",class:"edit-btn"})],8,Hn),e("div",Jn,[e("button",{class:"delete-btn",onClick:ce(X=>oe(q.memoryId),["stop"])},[g(s($),{id:"toggle-"+q.memoryId,icon:"carbon:chevron-down",class:"down-btn"},null,8,["id"])],8,Gn)]),e("div",Kn,[e("button",{class:"delete-btn",onClick:ce(X=>N(q.memoryId),["stop"])},[g(s($),{icon:"carbon:delete"})],8,Xn)])]),e("div",Qn,[e("p",Yn,o(q.messages.length>0?q.messages[0].text:"none message"),1),q.messages.length>1?(r(),p("p",Zn,o(q.messages[1].text),1)):A("",!0)]),e("div",eo,[e("span",to,"ID: "+o(q.memoryId),1),e("div",no,[q.messages.length>0?(r(),p("span",oo,o(q.messages.length)+" "+o(D.$t("memory.size")),1)):A("",!0),e("span",so,o(P(q.createTime)),1)])])])]),q.expanded?(r(),p("div",{key:0,id:"content-"+q.memoryId,class:"expanded-content"},[e("div",lo,[(r(!0),p(fe,null,ye(q.messages,(X,we)=>(r(),p("div",{class:"message-bubble",key:we},[e("div",io,o(X.messageType),1),e("div",co,[e("p",ro,o(X.text),1)])]))),128))])],8,ao)):A("",!0)],2))),128))]),b.value.length===0&&l.value?(r(),p("div",uo,j[3]||(j[3]=[e("p",{class:"state-text"},"none message",-1)]))):A("",!0)]),u.value?(r(),p("div",{key:0,id:"name-edit-modal",class:"modal-overlay",onClick:ce(R,["self"])},[e("div",po,[e("div",ho,[e("h3",mo,o(D.$t("memory.changeName")),1),pe(e("input",{type:"text","onUpdate:modelValue":j[2]||(j[2]=q=>U.value=q),class:"edit-input",placeholder:D.$t("memory.newNamePlaceholder")},null,8,vo),[[ve,U.value]]),e("span",go,o(U.value.length),1)]),e("div",fo,[e("button",{id:"cancel-name",class:"modal-btn cancel-btn",onClick:R},o(D.$t("memory.cancel")),1),e("button",{id:"save-name",class:"modal-btn confirm-btn",onClick:ue},o(D.$t("memory.save")),1)])])])):A("",!0),w.value?(r(),p("div",{key:1,id:"delete-modal",class:"modal-overlay",onClick:ce(Q,["self"])},[e("div",$o,[e("div",bo,[e("h3",_o,o(D.$t("memory.deleteHint")),1),e("p",yo,o(D.$t("memory.deleteHintPrefix"))+" "+o(F.value)+" "+o(D.$t("memory.deleteHintSuffix")),1)]),e("div",ko,[e("button",{id:"cancel-delete",class:"modal-btn cancel-btn",onClick:Q},o(D.$t("memory.cancel")),1),e("button",{id:"confirm-delete",class:"modal-btn delete-btn-confirm",onClick:se},o(D.$t("memory.delete")),1)])])])):A("",!0)])])):A("",!0)]),_:1})]))}}),Co=Te(wo,[["__scopeId","data-v-51743a89"]]);class Ke{static async sendMessage(t){return Ct.withLlmCheck(async()=>{const n=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`API request failed: ${n.status}`);return await n.json()})}}me(Ke,"BASE_URL","/api/executor");class Xe{static async getDetails(t){try{const n=await fetch(`${this.BASE_URL}/details/${t}`);if(n.status===404)return null;if(!n.ok){const b=await n.text();throw new Error(`Failed to get detailed information: ${n.status} - ${b}`)}const l=await n.text(),v=JSON.parse(l);return v&&typeof v=="object"&&!v.currentPlanId&&(v.currentPlanId=t),v}catch(n){return console.error("[CommonApiService] Failed to get plan details:",n),{currentPlanId:t,status:"failed",message:n instanceof Error?n.message:"Failed to save, please retry"}}}static async submitFormInput(t,n){const l=await fetch(`${this.BASE_URL}/submit-input/${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!l.ok){let b;try{b=await l.json()}catch{b={message:`Failed to submit form input: ${l.status}`}}throw new Error(b.message||`Failed to submit form input: ${l.status}`)}const v=l.headers.get("content-type");return v&&v.indexOf("application/json")!==-1?await l.json():{success:!0}}static async getAllPrompts(){try{const t=await fetch(this.BASE_URL);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get Prompt list:",t),t}}static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}}me(Xe,"BASE_URL","/api/executor");const Me=class Me{constructor(){me(this,"POLL_INTERVAL",5e3);me(this,"state",Ge({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));me(this,"callbacks",{});me(this,"planExecutionCache",new Map);me(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(t){return this.planExecutionCache.get(t)}getCachedUIState(t){return this.uiStateCache.get(t)}setCachedUIState(t,n){this.uiStateCache.set(t,n),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${t}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(t){return this.planExecutionCache.has(t)}setCachedPlanRecord(t,n){this.planExecutionCache.set(t,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${t}`)}clearCachedPlanRecord(t){const n=this.planExecutionCache.delete(t);return n&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${t}`),n}clearAllCachedRecords(){const t=this.planExecutionCache.size,n=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${t}, UI States: ${n}`)}static getInstance(){return Me.instance||(Me.instance=new Me),Me.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(t){this.callbacks={...this.callbacks,...t},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(t))}async handleUserMessageSendRequested(t){if(this.validateAndPrepareUIForNewRequest(t))try{if(await this.sendUserMessageAndSetPlanId(t),this.state.activePlanId)this.initiatePlanExecutionSequence(t,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(n){console.error("[PlanExecutionManager] Failed to send user message:",n);const l=this.state.activePlanId??"error";this.setCachedUIState(l,{enabled:!0}),this.emitChatInputUpdateState(l),this.state.activePlanId=null}}handlePlanExecutionRequested(t,n){console.log("[PlanExecutionManager] Received plan execution request:",{planId:t,query:n}),t?(this.state.activePlanId=t,this.initiatePlanExecutionSequence(n??"Execute Plan",t)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(t,n){const l=this.getCachedPlanRecord(t);return l!=null&&l.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${t}`),this.handlePlanExecutionRequested(l.currentPlanId,n),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${t}`),!1)}validateAndPrepareUIForNewRequest(t){if(!t)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const n=this.state.activePlanId??"ui-state";return this.setCachedUIState(n,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(n),!0}async sendUserMessageAndSetPlanId(t){try{const n=await Ke.sendMessage({input:t});if(n!=null&&n.planId)return this.state.activePlanId=n.planId,n;if(n!=null&&n.planTemplateId)return this.state.activePlanId=n.planTemplateId,{...n,planId:n.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",n),new Error("Failed to get valid planId from API response")}catch(n){throw console.error("[PlanExecutionManager] API call failed:",n),n}}initiatePlanExecutionSequence(t,n){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${t}", planId: ${n}`);const l=n;this.emitDialogRoundStart(l),this.startPolling()}handlePlanCompletion(t){this.emitPlanCompleted(t.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await We.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}},5e3)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}t.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(t.rootPlanId??""))}handlePlanError(t){this.emitPlanError(t.message??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await We.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}},5e3)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const t=await this.getPlanDetails(this.state.activePlanId);if(!t){console.warn("[PlanExecutionManager] No details received from API");return}if(t.status&&t.status==="failed"){this.handlePlanError(t);return}if(t.rootPlanId&&this.setCachedPlanRecord(t.rootPlanId,t),!t.steps||t.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(t.rootPlanId??""),this.handlePlanCompletion(t);return}this.emitPlanUpdate(t.rootPlanId??""),t.completed&&this.handlePlanCompletion(t)}catch(t){console.error("[PlanExecutionManager] Failed to poll plan status:",t)}finally{this.state.isPolling=!1}}}async getPlanDetails(t){try{const n=await Xe.getDetails(t);return n!=null&&n.rootPlanId&&(this.planExecutionCache.set(n.rootPlanId,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${n.rootPlanId}`)),n}catch(n){return console.error("[PlanExecutionManager] Failed to get plan details:",n),{currentPlanId:t,status:"failed",message:n instanceof Error?n.message:"Failed to get plan"}}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(t){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(t)}emitDialogRoundStart(t){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(t)}emitPlanUpdate(t){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(t)}emitPlanCompleted(t){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(t)}emitPlanError(t){this.callbacks.onPlanError&&this.callbacks.onPlanError(t)}};me(Me,"instance",null);let Je=Me;const ke=Je.getInstance();class Re{static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}static async getFileTree(t){try{const n=await fetch(`${this.BASE_URL}/tree/${t}`),v=await(await this.handleResponse(n)).json();if(!v.success)throw new Error(v.message||"Failed to get file tree");return v.data}catch(n){throw console.error("Failed to get file tree:",n),n}}static async getFileContent(t,n){try{const l=await fetch(`${this.BASE_URL}/content/${t}?path=${encodeURIComponent(n)}`),b=await(await this.handleResponse(l)).json();if(!b.success)throw new Error(b.message||"Failed to get file content");return b.data}catch(l){throw console.error("Failed to get file content:",l),l}}static async downloadFile(t,n,l){try{const v=await fetch(`${this.BASE_URL}/download/${t}?path=${encodeURIComponent(n)}`);await this.handleResponse(v);const b=await v.blob(),u=window.URL.createObjectURL(b),M=document.createElement("a");M.href=u,M.download=l||n.split("/").pop()||"download",document.body.appendChild(M),M.click(),window.URL.revokeObjectURL(u),document.body.removeChild(M)}catch(v){throw console.error("Failed to download file:",v),v}}static isTextFile(t,n){const l=["text/","application/json","application/xml","application/javascript","application/typescript"],v=[".txt",".md",".json",".xml",".html",".css",".js",".ts",".vue",".jsx",".tsx",".py",".java",".cpp",".c",".h",".sh",".bat",".yml",".yaml",".properties",".conf",".cfg"];if(l.some(u=>t.startsWith(u)))return!0;const b=n.toLowerCase();return v.some(u=>b.endsWith(u))}static getFileIcon(t){if(t.type==="directory")return"carbon:folder";const n=t.name.toLowerCase();return n.endsWith(".js")?"vscode-icons:file-type-js":n.endsWith(".ts")?"vscode-icons:file-type-typescript":n.endsWith(".vue")?"vscode-icons:file-type-vue":n.endsWith(".java")?"vscode-icons:file-type-java":n.endsWith(".py")?"vscode-icons:file-type-python":n.endsWith(".json")?"vscode-icons:file-type-json":n.endsWith(".xml")?"vscode-icons:file-type-xml":n.endsWith(".html")?"vscode-icons:file-type-html":n.endsWith(".css")?"vscode-icons:file-type-css":n.endsWith(".md")?"vscode-icons:file-type-markdown":n.endsWith(".yml")||n.endsWith(".yaml")?"vscode-icons:file-type-yaml":n.endsWith(".pdf")?"vscode-icons:file-type-pdf2":n.endsWith(".doc")||n.endsWith(".docx")?"vscode-icons:file-type-word":n.endsWith(".xls")||n.endsWith(".xlsx")?"vscode-icons:file-type-excel":n.endsWith(".ppt")||n.endsWith(".pptx")?"vscode-icons:file-type-powerpoint":n.match(/\.(jpg|jpeg|png|gif|bmp|svg)$/)?"carbon:image":n.match(/\.(zip|rar|7z|tar|gz)$/)?"carbon:archive":"carbon:document"}}me(Re,"BASE_URL","/api/file-browser");const Po={class:"file-tree-node"},So={class:"node-icon"},Eo={class:"node-name"},Io={key:1,class:"file-size"},To={key:2,class:"node-actions"},xo={key:0,class:"children"},Do=Ie({__name:"FileTreeNode",props:{node:{},level:{}},emits:["file-selected","download-file"],setup(T,{emit:t}){const n=T,l=t,v=E(n.level===0),b=E(!1),u=E(!1),M=E({}),U=()=>{n.node.type==="directory"&&(v.value=!v.value)},w=()=>{n.node.type==="directory"?U():F()},F=()=>{n.node.type==="file"&&l("file-selected",n.node),a()},L=()=>{l("download-file",n.node),a()},W=x=>{x.preventDefault(),u.value=!0,M.value={position:"fixed",top:`${x.clientY}px`,left:`${x.clientX}px`,zIndex:1e3},setTimeout(()=>{document.addEventListener("click",a)},0)},a=()=>{u.value=!1,document.removeEventListener("click",a)},y=async()=>{try{await navigator.clipboard.writeText(n.node.path)}catch(x){console.error("Failed to copy path:",x)}a()},P=()=>n.node.type==="directory"?v.value?"carbon:folder-open":"carbon:folder":Re.getFileIcon(n.node),G=x=>{if(x===0)return"0 B";const R=1024,ue=["B","KB","MB","GB"],oe=Math.floor(Math.log(x)/Math.log(R));return parseFloat((x/Math.pow(R,oe)).toFixed(1))+" "+ue[oe]};return xe(()=>{document.removeEventListener("click",a)}),(x,R)=>{const ue=yt("FileTreeNode",!0);return r(),p("div",Po,[e("div",{class:ie(["node-content",{"is-directory":x.node.type==="directory","is-file":x.node.type==="file","is-expanded":v.value}]),style:je({paddingLeft:`${x.level*16+12}px`}),onClick:w,onContextmenu:ce(W,["prevent"])},[x.node.type==="directory"?(r(),p("div",{key:0,class:"expand-icon",onClick:ce(U,["stop"])},[g(s($),{icon:v.value?"carbon:chevron-down":"carbon:chevron-right",class:"chevron-icon"},null,8,["icon"])])):A("",!0),e("div",So,[g(s($),{icon:P()},null,8,["icon"])]),e("span",Eo,o(x.node.name),1),x.node.type==="file"?(r(),p("span",Io,o(G(x.node.size)),1)):A("",!0),b.value?(r(),p("div",To,[x.node.type==="file"?(r(),p("button",{key:0,onClick:R[0]||(R[0]=ce(oe=>x.$emit("download-file",x.node),["stop"])),class:"action-btn download-btn",title:"Download"},[g(s($),{icon:"carbon:download"})])):A("",!0)])):A("",!0)],38),x.node.type==="directory"&&v.value&&x.node.children?(r(),p("div",xo,[(r(!0),p(fe,null,ye(x.node.children,oe=>(r(),_e(ue,{key:oe.path,node:oe,level:x.level+1,onFileSelected:R[1]||(R[1]=N=>x.$emit("file-selected",N)),onDownloadFile:R[2]||(R[2]=N=>x.$emit("download-file",N))},null,8,["node","level"]))),128))])):A("",!0),u.value?(r(),p("div",{key:1,class:"context-menu",style:je(M.value),onClick:R[3]||(R[3]=ce(()=>{},["stop"]))},[e("div",{class:"context-menu-item",onClick:F},[g(s($),{icon:"carbon:view"}),R[4]||(R[4]=e("span",null,"Open",-1))]),x.node.type==="file"?(r(),p("div",{key:0,class:"context-menu-item",onClick:L},[g(s($),{icon:"carbon:download"}),R[5]||(R[5]=e("span",null,"Download",-1))])):A("",!0),R[7]||(R[7]=e("div",{class:"context-menu-divider"},null,-1)),e("div",{class:"context-menu-item",onClick:y},[g(s($),{icon:"carbon:copy"}),R[6]||(R[6]=e("span",null,"Copy Path",-1))])],4)):A("",!0)])}}}),Ro=Te(Do,[["__scopeId","data-v-4c2c30c7"]]),Mo={class:"file-browser"},Fo={class:"file-browser-header"},Ao={class:"header-actions"},Uo=["disabled","title"],No={class:"file-browser-content"},Lo={class:"file-tree-panel"},qo={key:0,class:"loading-state"},Bo={key:1,class:"error-state"},Vo={key:0,class:"waiting-for-files"},jo={class:"message-content"},Wo={class:"tips"},Oo=["disabled"],zo={key:1,class:"actual-error"},Ho={key:2,class:"empty-state"},Jo={key:3,class:"file-tree"},Go={key:0,class:"file-content-panel"},Ko={class:"file-content-header"},Xo={class:"file-info"},Qo={class:"file-name"},Yo={class:"file-size"},Zo={class:"file-actions"},es=["title"],ts=["title"],ns={class:"file-content-body"},os={key:0,class:"loading-content"},ss={key:1,class:"content-error"},as={key:2,class:"file-content"},ls={key:0,class:"text-content"},is={key:1,class:"binary-content"},cs=Ie({__name:"index",props:{planId:{}},setup(T){const t=T,{t:n}=Fe(),l=E(!1),v=E(null),b=E(null),u=E(null),M=E(null),U=E(!1),w=E(null),F=E(null),L=Pe(()=>!M.value||!u.value?!1:Re.isTextFile(M.value.mimeType,u.value.name)),W=Pe(()=>v.value&&(v.value.includes("Plan directory not found")||v.value.includes("not found"))),a=()=>{F.value&&(clearTimeout(F.value),F.value=null)},y=()=>{a(),F.value=window.setTimeout(()=>{W.value&&P()},5e3)},P=async()=>{if(t.planId){l.value=!0,v.value=null,a();try{b.value=await Re.getFileTree(t.planId)}catch(N){v.value=N instanceof Error?N.message:n("fileBrowser.loadError"),console.error("Failed to load file tree:",N);const Q=N instanceof Error?N.message:"";(Q.includes("Plan directory not found")||Q.includes("not found"))&&y()}finally{l.value=!1}}},G=async N=>{if(N.type!=="directory"){u.value=N,M.value=null,U.value=!0,w.value=null;try{M.value=await Re.getFileContent(t.planId,N.path)}catch(Q){w.value=Q instanceof Error?Q.message:n("fileBrowser.contentLoadError"),console.error("Failed to load file content:",Q)}finally{U.value=!1}}},x=async N=>{try{await Re.downloadFile(t.planId,N.path,N.name)}catch(Q){console.error("Failed to download file:",Q)}},R=()=>{u.value=null,M.value=null,w.value=null},ue=N=>Re.getFileIcon(N),oe=N=>{if(N===0)return"0 B";const Q=1024,se=["B","KB","MB","GB"],D=Math.floor(Math.log(N)/Math.log(Q));return parseFloat((N/Math.pow(Q,D)).toFixed(1))+" "+se[D]};return Ee(()=>t.planId,N=>{N&&(u.value=null,M.value=null,P())},{immediate:!0}),De(()=>{t.planId&&P()}),xe(()=>{a()}),(N,Q)=>(r(),p("div",Mo,[e("div",Fo,[e("h3",null,o(N.$t("fileBrowser.title")),1),e("div",Ao,[e("button",{class:"refresh-btn",onClick:P,disabled:l.value,title:N.$t("fileBrowser.refresh")},[g(s($),{icon:"carbon:refresh",class:ie({rotating:l.value}),style:{color:"#ffffff",fontSize:"18px",width:"18px",height:"18px"}},null,8,["class"])],8,Uo)])]),e("div",No,[e("div",Lo,[l.value?(r(),p("div",qo,[g(s($),{icon:"carbon:loading",class:"rotating"}),e("span",null,o(N.$t("fileBrowser.loading")),1)])):v.value?(r(),p("div",Bo,[W.value?(r(),p("div",Vo,[g(s($),{icon:"carbon:time",class:"rotating"}),e("div",jo,[e("h3",null,o(N.$t("fileBrowser.waitingForGeneration")),1),e("p",null,o(N.$t("fileBrowser.planExecuting")),1),e("div",Wo,[g(s($),{icon:"carbon:information"}),e("span",null,o(N.$t("fileBrowser.filesTip")),1)])]),e("button",{onClick:P,class:"retry-btn",disabled:l.value},[g(s($),{icon:"carbon:refresh",class:ie({rotating:l.value})},null,8,["class"]),le(" "+o(l.value?N.$t("fileBrowser.checking"):N.$t("fileBrowser.checkNow")),1)],8,Oo)])):(r(),p("div",zo,[g(s($),{icon:"carbon:warning"}),e("span",null,o(v.value),1),e("button",{onClick:P,class:"retry-btn"},o(N.$t("fileBrowser.retry")),1)]))])):b.value?(r(),p("div",Jo,[g(Ro,{node:b.value,level:0,onFileSelected:G,onDownloadFile:x},null,8,["node"])])):(r(),p("div",Ho,[g(s($),{icon:"carbon:folder-off"}),e("span",null,o(N.$t("fileBrowser.noFiles")),1)]))]),u.value?(r(),p("div",Go,[e("div",Ko,[e("div",Xo,[g(s($),{icon:ue(u.value)},null,8,["icon"]),e("span",Qo,o(u.value.name),1),e("span",Yo,"("+o(oe(u.value.size))+")",1)]),e("div",Zo,[e("button",{onClick:Q[0]||(Q[0]=se=>x(u.value)),class:"download-btn",title:N.$t("fileBrowser.download")},[g(s($),{icon:"carbon:download"})],8,es),e("button",{onClick:R,class:"close-btn",title:N.$t("common.close")},[g(s($),{icon:"carbon:close"})],8,ts)])]),e("div",ns,[U.value?(r(),p("div",os,[g(s($),{icon:"carbon:loading",class:"rotating"}),e("span",null,o(N.$t("fileBrowser.loadingContent")),1)])):w.value?(r(),p("div",ss,[g(s($),{icon:"carbon:warning"}),e("span",null,o(w.value),1)])):M.value?(r(),p("div",as,[L.value?(r(),p("div",ls,[e("pre",null,[e("code",null,o(M.value.content),1)])])):(r(),p("div",is,[g(s($),{icon:"carbon:document-unknown"}),e("p",null,o(N.$t("fileBrowser.binaryFile")),1),e("button",{onClick:Q[1]||(Q[1]=se=>x(u.value)),class:"download-btn-large"},[g(s($),{icon:"carbon:download"}),le(" "+o(N.$t("fileBrowser.downloadToView")),1)])]))])):A("",!0)])])):A("",!0)])]))}}),rs=Te(cs,[["__scopeId","data-v-2a488cd0"]]),ds={class:"right-panel"},us={class:"preview-header"},ps={class:"preview-tabs"},hs={class:"preview-content"},ms={key:0,class:"step-details"},vs={key:0,class:"step-info-fixed"},gs={key:0,class:"agent-info"},fs={class:"info-item"},$s={class:"label"},bs={class:"value"},_s={class:"info-item"},ys={class:"label"},ks={class:"value"},ws={class:"info-item"},Cs={class:"label"},Ps={class:"value"},Ss={class:"info-item"},Es={class:"label"},Is={class:"value"},Ts={class:"info-item"},xs={class:"label"},Ds={class:"execution-status"},Rs={class:"status-item"},Ms={class:"status-text"},Fs={key:0},As={key:0,class:"think-act-steps"},Us={class:"steps-container"},Ns={class:"step-header"},Ls={class:"step-number"},qs={class:"think-section"},Bs={class:"think-content"},Vs={class:"input"},js={class:"label"},Ws={class:"output"},Os={class:"label"},zs={key:0,class:"action-section"},Hs={class:"action-content"},Js={class:"tool-info"},Gs={class:"label"},Ks={class:"value"},Xs={class:"input"},Qs={class:"label"},Ys={class:"output"},Zs={class:"label"},ea={key:0,class:"sub-plan-section"},ta={class:"sub-plan-content"},na={class:"sub-plan-header"},oa={class:"sub-plan-info"},sa={class:"label"},aa={class:"value"},la={key:0,class:"sub-plan-info"},ia={class:"label"},ca={class:"value"},ra={class:"sub-plan-status"},da={class:"status-text"},ua={key:0,class:"no-steps-message"},pa={key:1,class:"no-execution-message"},ha={class:"step-basic-info"},ma={class:"info-item"},va={class:"label"},ga={class:"value"},fa={key:0,class:"info-item"},$a={class:"label"},ba={class:"value"},_a={class:"info-item"},ya={class:"label"},ka={class:"no-execution-hint"},wa={key:2,class:"execution-indicator"},Ca={class:"execution-text"},Pa={key:1,class:"no-selection"},Sa=["title"],Ea={key:1,class:"file-browser-container"},Ia={key:1,class:"no-plan-message"},Ta={class:"message-content"},xa={class:"tips"},Da=Ie({__name:"index",props:{currentRootPlanId:{}},setup(T,{expose:t}){const n=T,{t:l}=Fe(),v=E(),b=E(),u=E(),M=E("details"),U=E(localStorage.getItem("jmanus-last-plan-id")),w=E(localStorage.getItem("jmanus-has-executed-plan")==="true"),F=E(null),L=E(!1),W=E(!0),a=E(!0),y=Pe(()=>u.value?u.value.completed?l("rightPanel.status.completed"):u.value.current?l("rightPanel.status.executing"):l("rightPanel.status.waiting"):""),P=Pe(()=>n.currentRootPlanId?n.currentRootPlanId:U.value),G=Pe(()=>!P.value&&!w.value),x=m=>{var B;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${m}`),u.value&&F.value){const V=F.value.rootPlanId??b.value;if(V&&V!==m){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${V}, Requested: ${m}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${m}`);const k=ke.getCachedPlanRecord(m);if(!k){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${m}`);return}if(k.steps&&k.steps.length>0){const V=k.steps.length,I=(k.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${I} / ${V}`)}if(u.value&&b.value&&(b.value===m||((B=F.value)==null?void 0:B.rootPlanId)===m)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${m}`),F.value)){const I=F.value,O=ue(I.planId,I.rootPlanId,I.subPlanId);O?(oe(O,I.stepIndex,I.planId,I.isSubPlan),j()):console.warn("[RightPanel] Could not find plan record for refresh:",I)}},R=(m,k,B,V,I)=>{console.log("[RightPanel] Step selected:",{planId:m,stepIndex:k,rootPlanId:B,subPlanId:V,subStepIndex:I});const O=!!(B&&V&&I!==void 0);F.value={planId:m,stepIndex:k,isSubPlan:O,...O&&{rootPlanId:B,subPlanId:V,subStepIndex:I}};const _=ue(m,B,V);if(!_){console.warn("[RightPanel] Plan data not found:",{planId:m,rootPlanId:B,subPlanId:V}),u.value=null,F.value=null;return}oe(_,k,m,O)},ue=(m,k,B)=>{var O;if(!k||!B)return ke.getCachedPlanRecord(m)??null;const V=ke.getCachedPlanRecord(m);if(V)return V;const I=ke.getCachedPlanRecord(k);if(!(I!=null&&I.agentExecutionSequence))return null;for(const _ of I.agentExecutionSequence)if(_.thinkActSteps){for(const h of _.thinkActSteps)if(((O=h.subPlanExecutionRecord)==null?void 0:O.currentPlanId)===B)return h.subPlanExecutionRecord}return null},oe=(m,k,B,V)=>{var J,re,$e,be,i;if(!m.steps||k>=m.steps.length){u.value=null,F.value=null,console.warn("[RightPanel] Invalid step data:",{planId:B,stepIndex:k,hasSteps:!!m.steps,stepsLength:(J=m.steps)==null?void 0:J.length,message:"Invalid step index"});return}b.value=B;const I=m.steps[k],O=(re=m.agentExecutionSequence)==null?void 0:re[k];console.log("[RightPanel] Step data details:",{planId:B,stepIndex:k,step:I,hasAgentExecutionSequence:!!m.agentExecutionSequence,agentExecutionSequenceLength:($e=m.agentExecutionSequence)==null?void 0:$e.length,agentExecution:O,hasThinkActSteps:!!(O!=null&&O.thinkActSteps),thinkActStepsLength:(be=O==null?void 0:O.thinkActSteps)==null?void 0:be.length,isSubPlan:V});const _=(O==null?void 0:O.status)==="FINISHED",h=!_&&k===m.currentStepIndex&&!m.completed,f={planId:B,index:k,title:typeof I=="string"?I:I.title||I.description||I.name||`${V?"Sub ":""}Step ${k+1}`,description:typeof I=="string"?I:I.description||I,completed:_,current:h};O&&(f.agentExecution=O),u.value=f,console.log("[RightPanel] Step details updated:",{planId:B,stepIndex:k,stepTitle:u.value.title,hasAgentExecution:!!O,hasThinkActSteps:(((i=O==null?void 0:O.thinkActSteps)==null?void 0:i.length)??0)>0,completed:_,current:h,planCurrentStep:m.currentStepIndex,planCompleted:m.completed,isSubPlan:V}),O!=null&&O.thinkActSteps&&O.thinkActSteps.forEach((c,d)=>{c.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${d}:`,c.subPlanExecutionRecord)}),setTimeout(()=>{se()},100),j()},N=(m,k,B,V)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:m,subPlanId:k,stepIndex:B,subStepIndex:V}),R(k,V,m,k,V)},Q=m=>{v.value=m??void 0},se=()=>{if(!v.value)return;const{scrollTop:m,scrollHeight:k,clientHeight:B}=v.value,V=k-m-B<50,I=k>B;W.value=V,L.value=I&&!V,V?a.value=!0:k-m-B>100&&(a.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:m,scrollHeight:k,clientHeight:B,isAtBottom:V,hasScrollableContent:I,showButton:L.value,shouldAutoScroll:a.value})},D=()=>{v.value&&(v.value.scrollTo({top:v.value.scrollHeight,behavior:"smooth"}),ge(()=>{a.value=!0,se()}))},j=()=>{!a.value||!v.value||ge(()=>{v.value&&(v.value.scrollTop=v.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},q=m=>{if(m===null||typeof m>"u"||m==="")return"N/A";try{const k=typeof m=="object"?m:JSON.parse(m);return JSON.stringify(k,null,2)}catch{return String(m)}},X=()=>{u.value=null,b.value=void 0,a.value=!0,v.value&&v.value.removeEventListener("scroll",se)},we=()=>{const m=()=>{const k=v.value;return k?(Q(k),k.addEventListener("scroll",se),a.value=!0,se(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};ge(()=>{m()||setTimeout(()=>{m()},100)})};return Ee(()=>n.currentRootPlanId,(m,k)=>{m&&m!==k?(U.value=m,w.value=!0,localStorage.setItem("jmanus-last-plan-id",m),localStorage.setItem("jmanus-has-executed-plan","true"),console.log("[RightPanel] New plan started:",m)):!m&&k&&console.log("[RightPanel] Plan execution finished, keeping last plan:",U.value)},{immediate:!0}),De(()=>{console.log("[RightPanel] Component mounted"),ge(()=>{we()})}),xe(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),F.value=null,X()}),t({updateDisplayedPlanProgress:x,handleStepSelected:R,handleSubPlanStepSelected:N}),(m,k)=>{var B,V;return r(),p("div",ds,[e("div",us,[e("div",ps,[e("div",{class:ie(["tab-item",{active:M.value==="details"}]),onClick:k[0]||(k[0]=I=>M.value="details")},[g(s($),{icon:"carbon:events"}),e("span",null,o(s(l)("rightPanel.stepExecutionDetails")),1)],2),e("div",{class:ie(["tab-item",{active:M.value==="files"}]),onClick:k[1]||(k[1]=I=>M.value="files")},[g(s($),{icon:"carbon:folder"}),e("span",null,o(s(l)("fileBrowser.title")),1)],2)])]),e("div",hs,[M.value==="details"?(r(),p("div",ms,[u.value?(r(),p("div",vs,[e("h3",null,o(u.value.title||u.value.description||s(l)("rightPanel.defaultStepTitle",{number:u.value.index+1})),1),u.value.agentExecution?(r(),p("div",gs,[e("div",fs,[e("span",$s,o(s(l)("rightPanel.executingAgent"))+":",1),e("span",bs,o(u.value.agentExecution.agentName),1)]),e("div",_s,[e("span",ys,o(s(l)("rightPanel.description"))+":",1),e("span",ks,o(u.value.agentExecution.agentDescription||""),1)]),e("div",ws,[e("span",Cs,o(s(l)("rightPanel.callingModel"))+":",1),e("span",Ps,o(u.value.agentExecution.modelName),1)]),e("div",Ss,[e("span",Es,o(s(l)("rightPanel.request"))+":",1),e("span",Is,o(u.value.agentExecution.agentRequest||""),1)]),e("div",Ts,[e("span",xs,o(s(l)("rightPanel.executionResult"))+":",1),e("span",{class:ie(["value",{success:u.value.agentExecution.status==="FINISHED"}])},o(u.value.agentExecution.status||s(l)("rightPanel.executing")),3)])])):A("",!0),e("div",Ds,[e("div",Rs,[u.value.completed?(r(),_e(s($),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):u.value.current?(r(),_e(s($),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(r(),_e(s($),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",Ms,o(y.value),1)])])])):A("",!0),e("div",{ref_key:"scrollContainer",ref:v,class:"step-details-scroll-container",onScroll:se},[u.value?(r(),p("div",Fs,[(B=u.value.agentExecution)!=null&&B.thinkActSteps&&u.value.agentExecution.thinkActSteps.length>0?(r(),p("div",As,[e("h4",null,o(s(l)("rightPanel.thinkAndActionSteps")),1),e("div",Us,[(r(!0),p(fe,null,ye(u.value.agentExecution.thinkActSteps,(I,O)=>(r(),p("div",{key:O,class:"think-act-step"},[e("div",Ns,[e("span",Ls,"#"+o(O+1),1),e("span",{class:ie(["step-status",I.status])},o(I.status||s(l)("rightPanel.executing")),3)]),e("div",qs,[e("h5",null,[g(s($),{icon:"carbon:thinking"}),le(" "+o(s(l)("rightPanel.thinking")),1)]),e("div",Bs,[e("div",Vs,[e("span",js,o(s(l)("rightPanel.input"))+":",1),e("pre",null,o(q(I.thinkInput)),1)]),e("div",Ws,[e("span",Os,o(s(l)("rightPanel.output"))+":",1),e("pre",null,o(q(I.thinkOutput)),1)])])]),I.actionNeeded?(r(),p("div",zs,[e("h5",null,[g(s($),{icon:"carbon:play"}),le(" "+o(s(l)("rightPanel.action")),1)]),e("div",Hs,[(r(!0),p(fe,null,ye(I.actToolInfoList,(_,h)=>(r(),p("div",{key:h},[e("div",Js,[e("span",Gs,o(s(l)("rightPanel.tool"))+":",1),e("span",Ks,o(_.name||""),1)]),e("div",Xs,[e("span",Qs,o(s(l)("rightPanel.toolParameters"))+":",1),e("pre",null,o(q(_.parameters)),1)]),e("div",Ys,[e("span",Zs,o(s(l)("rightPanel.executionResult"))+":",1),e("pre",null,o(q(_.result)),1)])]))),128))]),I.subPlanExecutionRecord?(r(),p("div",ea,[e("h5",null,[g(s($),{icon:"carbon:tree-view"}),le(" "+o(s(l)("rightPanel.subPlan")),1)]),e("div",ta,[e("div",na,[e("div",oa,[e("span",sa,o(m.$t("rightPanel.subPlanId"))+":",1),e("span",aa,o(I.subPlanExecutionRecord.currentPlanId),1)]),I.subPlanExecutionRecord.title?(r(),p("div",la,[e("span",ia,o(m.$t("rightPanel.title"))+":",1),e("span",ca,o(I.subPlanExecutionRecord.title),1)])):A("",!0),e("div",ra,[I.subPlanExecutionRecord.completed?(r(),_e(s($),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(r(),_e(s($),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",da,o(I.subPlanExecutionRecord.completed?m.$t("rightPanel.status.completed"):m.$t("rightPanel.status.executing")),1)])])])])):A("",!0)])):A("",!0)]))),128))]),u.value.agentExecution&&!((V=u.value.agentExecution.thinkActSteps)!=null&&V.length)?(r(),p("div",ua,[e("p",null,o(s(l)("rightPanel.noStepDetails")),1)])):u.value.agentExecution?A("",!0):(r(),p("div",pa,[g(s($),{icon:"carbon:information",class:"info-icon"}),e("h4",null,o(s(l)("rightPanel.stepInfo")),1),e("div",ha,[e("div",ma,[e("span",va,o(s(l)("rightPanel.stepName"))+":",1),e("span",ga,o(u.value.title||u.value.description||m.$t("rightPanel.stepNumber",{number:u.value.index+1})),1)]),u.value.description?(r(),p("div",fa,[e("span",$a,o(m.$t("rightPanel.description"))+":",1),e("span",ba,o(u.value.description),1)])):A("",!0),e("div",_a,[e("span",ya,o(m.$t("rightPanel.status.label"))+":",1),e("span",{class:ie(["value",{"status-completed":u.value.completed,"status-current":u.value.current,"status-pending":!u.value.completed&&!u.value.current}])},o(u.value.completed?m.$t("rightPanel.status.completed"):u.value.current?m.$t("rightPanel.status.executing"):m.$t("rightPanel.status.pending")),3)])]),e("p",ka,o(s(l)("rightPanel.noExecutionInfo")),1)])),u.value.current&&!u.value.completed?(r(),p("div",wa,[k[2]||(k[2]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",Ca,[g(s($),{icon:"carbon:in-progress",class:"rotating-icon"}),le(" "+o(s(l)("rightPanel.stepExecuting")),1)])])):A("",!0)])):(r(),p("div",Pa,[g(s($),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,o(s(l)("rightPanel.noStepSelected")),1),e("p",null,o(s(l)("rightPanel.selectStepHint")),1)]))])):A("",!0),g(Le,{name:"scroll-button"},{default:qe(()=>[L.value?(r(),p("button",{key:0,onClick:D,class:"scroll-to-bottom-btn",title:s(l)("rightPanel.scrollToBottom")},[g(s($),{icon:"carbon:chevron-down"})],8,Sa)):A("",!0)]),_:1})],544)])):A("",!0),M.value==="files"?(r(),p("div",Ea,[P.value?(r(),_e(rs,{key:0,"plan-id":P.value},null,8,["plan-id"])):G.value?(r(),p("div",Ia,[g(s($),{icon:"carbon:folder-off"}),e("div",Ta,[e("h3",null,o(s(l)("fileBrowser.noFilesYet")),1),e("p",null,o(s(l)("fileBrowser.noPlanExecuting")),1),e("div",xa,[g(s($),{icon:"carbon:information"}),e("span",null,o(s(l)("fileBrowser.startTaskTip")),1)])])])):A("",!0)])):A("",!0)])])}}}),Ra=Te(Da,[["__scopeId","data-v-1f1365f7"]]);function Ma(){const T=ke,t=Pe(()=>T.getActivePlanId()),n=Pe(()=>T.getState()),l=Pe(()=>n.value.isPolling),v=Pe(()=>!!t.value),b=(w,F)=>{T.initiatePlanExecutionSequence(w,F)},u=()=>{T.stopPolling()},M=()=>{T.startPolling()},U=()=>{T.cleanup()};return xe(()=>{U()}),{activePlanId:t,state:n,isPolling:l,hasActivePlan:v,startExecution:b,stopPolling:u,startPolling:M,cleanup:U}}const Fa={class:"chat-container"},Aa={class:"message-content"},Ua={key:0,class:"user-message"},Na={key:1,class:"assistant-message"},La={key:0,class:"thinking-section"},qa={class:"thinking-header"},Ba={class:"thinking-avatar"},Va={class:"thinking-label"},ja={class:"thinking-content"},Wa={key:0,class:"thinking"},Oa={key:1,class:"progress"},za={class:"progress-bar"},Ha={class:"progress-text"},Ja={key:2,class:"steps-container"},Ga={class:"steps-title"},Ka=["onClick"],Xa={class:"section-header"},Qa={class:"step-icon"},Ya={class:"step-title"},Za={key:0,class:"step-status current"},el={key:1,class:"step-status completed"},tl={key:2,class:"step-status pending"},nl={key:0,class:"action-info"},ol={class:"action-description"},sl={class:"action-icon"},al={key:0,class:"tool-params"},ll={class:"param-label"},il={class:"param-content"},cl={key:1,class:"think-details"},rl={class:"think-header"},dl={class:"think-label"},ul={class:"think-output"},pl={class:"think-content"},hl={key:1,class:"sub-plan-steps"},ml={class:"sub-plan-header"},vl={class:"sub-plan-title"},gl={class:"sub-plan-step-list"},fl=["onClick"],$l={class:"sub-step-indicator"},bl={class:"sub-step-icon"},_l={class:"sub-step-number"},yl={class:"sub-step-content"},kl={class:"sub-step-title"},wl={class:"sub-step-badge"},Cl={key:2,class:"user-input-form-container"},Pl={class:"user-input-message"},Sl={key:0,class:"form-description"},El=["onSubmit"],Il={key:0,class:"form-grid"},Tl=["for"],xl=["id","name","placeholder","required","onUpdate:modelValue"],Dl=["id","name","placeholder","required","onUpdate:modelValue"],Rl=["id","name","placeholder","required","onUpdate:modelValue"],Ml=["id","name","placeholder","required","onUpdate:modelValue"],Fl=["id","name","placeholder","required","onUpdate:modelValue"],Al=["id","name","required","onUpdate:modelValue"],Ul={value:""},Nl=["value"],Ll=["id","name","placeholder","required","onUpdate:modelValue"],ql={key:1,class:"form-group"},Bl={for:"form-input-genericInput"},Vl=["onUpdate:modelValue"],jl={type:"submit",class:"submit-user-input-btn"},Wl={key:3,class:"default-processing"},Ol={class:"processing-indicator"},zl={class:"response-section"},Hl={class:"response-header"},Jl={class:"response-avatar"},Gl={class:"response-name"},Kl={class:"response-content"},Xl={key:0,class:"final-response"},Ql=["innerHTML"],Yl={key:1,class:"response-placeholder"},Zl={class:"typing-indicator"},ei={class:"typing-text"},ti={key:0,class:"message assistant"},ni={class:"message-content"},oi={class:"assistant-message"},si={class:"thinking-section"},ai={class:"thinking-header"},li={class:"thinking-avatar"},ii={class:"thinking-label"},ci={class:"thinking-content"},ri={class:"default-processing"},di={class:"processing-indicator"},ui={class:"response-section"},pi={class:"response-header"},hi={class:"response-avatar"},mi={class:"response-name"},vi={class:"response-content"},gi={class:"response-placeholder"},fi={class:"typing-indicator"},$i={class:"typing-text"},bi=["title"],_i=Ie({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(T,{expose:t,emit:n}){const l=T,v=n,{t:b}=Fe(),u=Ma(),M=E(),U=E(!1),w=E([]),F=E(),L=E(!1),W=Ge({}),a=(i,c,d)=>{const C={id:Date.now().toString(),type:i,content:c,timestamp:new Date,...d};return i==="assistant"&&!C.thinking&&!C.content&&(C.thinking=b("chat.thinking")),w.value.push(C),C},y=i=>{const c=w.value[w.value.length-1];c.type==="assistant"&&Object.assign(c,i)},P=async i=>{try{U.value=!0;const c=a("assistant","",{thinking:b("chat.thinkingProcessing")}),d=await Ke.sendMessage(i);if(d.planId)console.log("[ChatComponent] Received planId from direct execution:",d.planId),d.memoryId&&Se.setMemory(d.memoryId),c.planExecution||(c.planExecution={}),c.planExecution.currentPlanId=d.planId,ke.handlePlanExecutionRequested(d.planId,i.input),delete c.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete c.thinking;const C=G(d,i.input);c.content=C}}catch(c){console.error("Direct mode error:",c),y({content:x(c)})}finally{U.value=!1}},G=(i,c)=>i.result??i.message??i.content??"",x=i=>{const c=(i==null?void 0:i.message)??(i==null?void 0:i.toString())??b("chat.unknownError");return c.includes("network")||c.includes("timeout")?b("chat.networkError"):c.includes("auth")||c.includes("unauthorized")?b("chat.authError"):c.includes("invalid")||c.includes("format")||c.includes("parameter")?b("chat.formatError"):`${b("chat.unknownError")} (${c})`},R=(i=!1)=>{ge(()=>{if(M.value){const c=M.value;(i||c.scrollHeight-c.scrollTop-c.clientHeight<150)&&c.scrollTo({top:c.scrollHeight,behavior:i?"auto":"smooth"})}})},ue=()=>{R(!0),L.value=!1},oe=()=>{if(M.value){const i=M.value,c=i.scrollHeight-i.scrollTop-i.clientHeight<150;L.value=!c&&w.value.length>0}},N=()=>{M.value&&M.value.addEventListener("scroll",oe)},Q=()=>{M.value&&M.value.removeEventListener("scroll",oe)},se=i=>{a("user",i.input),l.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",i.input):P(i)},D=(i,c)=>{var Y;const d=((Y=i.planExecution)==null?void 0:Y.agentExecutionSequence)??[];return c<0||c>=d.length?"IDLE":d[c].status??"IDLE"},j=(i,c)=>{var d,C;if(!((d=i.planExecution)!=null&&d.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:i.planExecution.currentPlanId,stepIndex:c,stepTitle:(C=i.planExecution.steps)==null?void 0:C[c]}),v("step-selected",i.planExecution.currentPlanId,c)},q=(i,c)=>{var d;try{const C=(d=i.planExecution)==null?void 0:d.agentExecutionSequence;if(!(C!=null&&C.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const Y=C[c];if(!Y)return console.log(`[ChatComponent] No agentExecution found for step ${c}`),[];if(!Y.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${c}`),[];for(const K of Y.thinkActSteps)if(K.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${c}:`,K.subPlanExecutionRecord),(K.subPlanExecutionRecord.steps??[]).map(Z=>typeof Z=="string"?Z:typeof Z=="object"&&Z!==null&&(Z.title||Z.description)||b("rightPanel.subStep"));return[]}catch(C){return console.warn("[ChatComponent] Error getting sub-plan steps:",C),[]}},X=(i,c,d)=>{var C;try{const Y=(C=i.planExecution)==null?void 0:C.agentExecutionSequence;if(!(Y!=null&&Y.length))return"pending";const K=Y[c];if(!K||!K.thinkActSteps)return"pending";let de=null;for(const ee of K.thinkActSteps)if(ee.subPlanExecutionRecord){de=ee.subPlanExecutionRecord;break}if(!de)return"pending";const Z=de.currentStepIndex;return de.completed?"completed":Z==null?d===0?"current":"pending":d<Z?"completed":d===Z?"current":"pending"}catch(Y){return console.warn("[ChatComponent] Error getting sub-plan step status:",Y),"pending"}},we=(i,c,d)=>{var C,Y;try{const K=(C=i.planExecution)==null?void 0:C.agentExecutionSequence;if(!(K!=null&&K.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const de=K[c];if(!de){console.warn("[ChatComponent] No agentExecution found for step",c);return}if(!de.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",c);return}let Z=null;for(const ee of de.thinkActSteps)if(ee.subPlanExecutionRecord){Z=ee.subPlanExecutionRecord;break}if(!(Z!=null&&Z.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}v("sub-plan-step-selected",((Y=i.planExecution)==null?void 0:Y.currentPlanId)??"",Z.currentPlanId,c,d)}catch(K){console.error("[ChatComponent] Error handling sub-plan step click:",K)}},m=(i,c)=>{var C,Y,K,de;if(!((C=i.planExecution)!=null&&C.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",i.planExecution.steps.length,"execution sequence:",((Y=c.agentExecutionSequence)==null?void 0:Y.length)??0);const d=new Array(i.planExecution.steps.length).fill(null);if((K=c.agentExecutionSequence)!=null&&K.length){const Z=Math.min(c.agentExecutionSequence.length,i.planExecution.steps.length);for(let ee=0;ee<Z;ee++){const z=c.agentExecutionSequence[ee];if((de=z.thinkActSteps)!=null&&de.length){const te=z.thinkActSteps[z.thinkActSteps.length-1];te.actionDescription&&te.toolParameters?(d[ee]={actionDescription:te.actionDescription,toolParameters:typeof te.toolParameters=="string"?te.toolParameters:JSON.stringify(te.toolParameters,null,2),thinkInput:te.thinkInput??"",thinkOutput:te.thinkOutput??"",status:c.currentStepIndex!==void 0&&ee<c.currentStepIndex?"completed":c.currentStepIndex!==void 0&&ee===c.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${ee} action set: ${d[ee].actionDescription}`)):(d[ee]={actionDescription:b("chat.thinking"),toolParameters:b("chat.waitingDecision"),thinkInput:te.thinkInput??"",thinkOutput:te.thinkOutput??"",status:c.currentStepIndex!==void 0&&ee===c.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${ee} is thinking`))}else d[ee]={actionDescription:c.currentStepIndex!==void 0&&ee<c.currentStepIndex?b("chat.status.completed"):b("chat.status.pending"),toolParameters:b("chat.noToolParameters"),thinkInput:"",thinkOutput:"",status:c.currentStepIndex!==void 0&&ee<c.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] Step ${ee} has no execution details, status set to: ${d[ee].status}`)}}else console.log("[ChatComponent] No execution sequence data");i.stepActions=[...d],console.log("[ChatComponent] Step actions update completed:",JSON.stringify(d.map(Z=>Z==null?void 0:Z.actionDescription))),ge(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},k=i=>{console.log("[ChatComponent] Starting dialog round with planId:",i),i&&(w.value.findIndex(d=>{var C;return((C=d.planExecution)==null?void 0:C.currentPlanId)===i&&d.type==="assistant"})===-1?(a("assistant","",{planExecution:{currentPlanId:i},thinking:b("chat.preparingExecution")}),console.log("[ChatComponent] Created new assistant message for planId:",i)):console.log("[ChatComponent] Found existing assistant message for planId:",i))},B=i=>{var K,de,Z,ee;console.log("[ChatComponent] Processing plan update with rootPlanId:",i);const c=ke.getCachedPlanRecord(i);if(!c){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",i);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",c),console.log("[ChatComponent] Plan steps:",c.steps),console.log("[ChatComponent] Plan completed:",c.completed),!c.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const d=w.value.findIndex(z=>{var te;return((te=z.planExecution)==null?void 0:te.currentPlanId)===c.currentPlanId&&z.type==="assistant"});let C;if(d!==-1)C=w.value[d],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",c.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",c.currentPlanId),console.log("[ChatComponent] Current messages:",w.value.map(te=>{var Ce;return{type:te.type,planId:(Ce=te.planExecution)==null?void 0:Ce.currentPlanId,content:te.content.substring(0,50)}}));let z=-1;for(let te=w.value.length-1;te>=0;te--)if(w.value[te].type==="assistant"){z=te;break}if(z!==-1)C=w.value[z],C.planExecution||(C.planExecution={}),C.planExecution.currentPlanId=c.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",c.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(C.planExecution||(C.planExecution={}),C.planExecution=JSON.parse(JSON.stringify(c)),!c.steps||c.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),c.completed){delete C.thinking;const z=c.summary??c.result??c.message??b("chat.executionCompleted");C.content=V(z),console.log("[ChatComponent] Set simple response content:",C.content)}else c.title&&(C.thinking=`${b("chat.thinkingExecuting",{title:c.title})}`);return}delete C.thinking;const Y=c.steps.map(z=>typeof z=="string"?z:typeof z=="object"&&z!==null&&(z.title||z.description)||b("chat.step"));if(C.planExecution&&(C.planExecution.steps=Y),c.agentExecutionSequence&&c.agentExecutionSequence.length>0){console.log("[ChatComponent] Found execution sequence data, count:",c.agentExecutionSequence.length),m(C,c);const z=c.currentStepIndex??0;if(z>=0&&z<c.agentExecutionSequence.length){const Ce=c.agentExecutionSequence[z].thinkActSteps;if(Ce&&Ce.length>0){const Ae=Ce[Ce.length-1];if(Ae.thinkOutput){const Oe=Ae.thinkOutput.length>150?Ae.thinkOutput.substring(0,150)+"...":Ae.thinkOutput;C.thinking=`${b("chat.thinking")}: ${Oe}`}}}}else if(C.planExecution){const z=C.planExecution.currentStepIndex??0,te=(K=C.planExecution.steps)==null?void 0:K[z],Ce=typeof te=="string"?te:"";C.thinking=`${b("chat.thinkingExecuting",{title:Ce})}`}if(c.userInputWaitState&&C.planExecution?(console.log("[ChatComponent] User input required:",c.userInputWaitState),C.planExecution.userInputWaitState||(C.planExecution.userInputWaitState={}),C.planExecution.userInputWaitState={message:c.userInputWaitState.message??"",formDescription:c.userInputWaitState.formDescription??"",formInputs:((de=c.userInputWaitState.formInputs)==null?void 0:de.map(z=>({label:z.label,value:z.value||"",type:z.type||"text",required:z.required==="true"||z.required===!0,placeholder:z.placeholder||"",name:z.name||z.label,options:z.options||void 0})))??[]},W[Z=C.id]??(W[Z]={}),C.thinking=b("input.waiting")):(ee=C.planExecution)!=null&&ee.userInputWaitState&&delete C.planExecution.userInputWaitState,c.completed??c.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete C.thinking;let z="";c.summary?z=c.summary:c.result?z=c.result:z=b("chat.executionCompleted"),C.content=I(z),console.log("[ChatComponent] Updated completed message:",C.content)}ge(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},V=i=>i?i.includes("I ")||i.includes("you")||i.includes("hello")||i.includes("can")||i.includes("I")||i.includes("you")||i.includes("can")?i:i.length<10?`${i}! ${b("chat.anythingElse")}`:i.length<50?`${b("chat.okayDone",{text:i})}. ${b("chat.ifOtherQuestions")}`:`${i}

${b("chat.hopeHelpful")} ${b("chat.anythingElse")}`:b("chat.defaultResponse"),I=i=>i?`${i}`:`${b("chat.executionCompleted")}! ${b("chat.anythingElse")}`,O=i=>{console.log("[ChatComponent] Plan completed with rootPlanId:",i);const c=ke.getCachedPlanRecord(i);if(!c){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",i);return}if(console.log("[ChatComponent] Plan details:",c),c.rootPlanId){const d=w.value.findIndex(C=>{var Y;return((Y=C.planExecution)==null?void 0:Y.currentPlanId)===c.rootPlanId});if(d!==-1){const C=w.value[d];delete C.thinking;let K=c.summary??c.result??b("chat.executionCompleted");!K.includes("I")&&!K.includes("you")&&(K.includes("success")||K.includes("complete")||K.includes("finished")?K=`${b("chat.great")}${K}. ${b("chat.ifOtherHelp")}`:K=`${b("chat.completedRequest",{result:K})}`),C.content=K,console.log("[ChatComponent] Updated completed message:",C.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",c.rootPlanId)}},_=i=>{U.value=!1,w.value[w.value.length-1]={id:Date.now().toString(),type:"assistant",content:i,timestamp:new Date}},h=i=>{if(!i)return"";let c=i.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return c=c.replace(/(<br><br>)/g,"</p><p>"),c.includes("</p><p>")&&(c=`<p>${c}</p>`),c},f=async i=>{var c;if(!((c=i.planExecution)!=null&&c.currentPlanId)||!i.planExecution.userInputWaitState){console.error("[ChatComponent] Missing planExecution.currentPlanId or userInputWaitState");return}try{const d={},C=i.planExecution.userInputWaitState.formInputs;C&&C.length>0?Object.entries(W[i.id]).forEach(([K,de])=>{var z;const Z=parseInt(K,10),ee=((z=C[Z])==null?void 0:z.label)||`input_${K}`;d[ee]=de}):d.genericInput=i.genericInput??"",console.log("[ChatComponent] Submitting user input:",d);const Y=await Xe.submitFormInput(i.planExecution.currentPlanId,d);delete i.planExecution.userInputWaitState,delete i.genericInput,delete W[i.id],u.startPolling(),console.log("[ChatComponent] User input submitted successfully:",Y)}catch(d){console.error("[ChatComponent] User input submission failed:",d),alert(`${b("common.submitFailed")}: ${(d==null?void 0:d.message)||b("common.unknownError")}`)}};Ee(()=>l.initialPrompt,(i,c)=>{console.log("[ChatComponent] initialPrompt changed from:",c,"to:",i),i&&typeof i=="string"&&i.trim()&&i!==c&&(console.log("[ChatComponent] Processing changed initial prompt:",i),ge(()=>{se({input:i})}))},{immediate:!1}),De(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),ke.setEventCallbacks({onPlanUpdate:B,onPlanCompleted:O,onDialogRoundStart:k,onChatInputUpdateState:i=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",i)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")},onPlanError:_}),ge(()=>{N()}),l.initialPrompt&&typeof l.initialPrompt=="string"&&l.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",l.initialPrompt),ge(()=>{se({input:l.initialPrompt})}))}),xe(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),Q(),F.value&&clearInterval(F.value),u.cleanup(),Object.keys(W).forEach(i=>delete W[i])});const J=async()=>{if(Se.selectMemoryId){const i=await Ve.getMemory(Se.selectMemoryId);w.value=[],i.messages.map(c=>{c.messageType.toLowerCase()==="user"&&a("user",c.text),c.messageType.toLowerCase()==="assistant"&&a("assistant",c.text)}),ue()}},re=()=>{w.value=[]},$e=i=>i?Array.isArray(i)?i:typeof i=="string"?i.split(",").map(c=>c.trim()).filter(c=>c.length>0):[]:[],be=i=>typeof i=="boolean"?i:typeof i=="string"?i==="true":!1;return t({handleSendMessage:se,handlePlanUpdate:B,handlePlanCompleted:O,handleDialogRoundStart:k,addMessage:a,handlePlanError:_,showMemory:J,newChat:re}),(i,c)=>(r(),p("div",Fa,[e("div",{class:"messages",ref_key:"messagesRef",ref:M},[(r(!0),p(fe,null,ye(w.value,d=>{var C,Y,K,de,Z,ee,z,te,Ce;return r(),p("div",{key:d.id,class:ie(["message",{user:d.type==="user",assistant:d.type==="assistant"}])},[e("div",Aa,[d.type==="user"?(r(),p("div",Ua,o(d.content),1)):(r(),p("div",Na,[d.thinking||((C=d.planExecution)==null?void 0:C.progress)!==void 0||(((K=(Y=d.planExecution)==null?void 0:Y.steps)==null?void 0:K.length)??0)>0?(r(),p("div",La,[e("div",qa,[e("div",Ba,[g(s($),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Va,o(i.$t("chat.thinkingLabel")),1)]),e("div",ja,[d.thinking?(r(),p("div",Wa,[g(s($),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,o(d.thinking),1)])):A("",!0),((de=d.planExecution)==null?void 0:de.progress)!==void 0?(r(),p("div",Oa,[e("div",za,[e("div",{class:"progress-fill",style:je({width:d.planExecution.progress+"%"})},null,4)]),e("span",Ha,o(d.planExecution.progressText??i.$t("chat.processing")+"..."),1)])):A("",!0),(((ee=(Z=d.planExecution)==null?void 0:Z.steps)==null?void 0:ee.length)??0)>0?(r(),p("div",Ja,[e("h4",Ga,o(i.$t("chat.stepExecutionDetails")),1),(r(!0),p(fe,null,ye((z=d.planExecution)==null?void 0:z.steps,(Ae,ne)=>{var Oe,Qe,Ye,Ze,et,tt,nt,ot,st,at,lt,it,ct,rt,dt,ut,pt,ht,mt;return r(),p("div",{key:ne,class:ie(["ai-section",{running:D(d,ne)==="RUNNING",completed:D(d,ne)==="FINISHED",pending:D(d,ne)==="IDLE"}]),onClick:ce(H=>j(d,ne),["stop"])},[e("div",Xa,[e("span",Qa,o(D(d,ne)==="FINISHED"?"âœ“":D(d,ne)==="RUNNING"?"â–¶":"â—‹"),1),e("span",Ya,o(Ae||`${i.$t("chat.step")} ${ne+1}`),1),D(d,ne)==="RUNNING"?(r(),p("span",Za,o(i.$t("chat.status.executing")),1)):D(d,ne)==="FINISHED"?(r(),p("span",el,o(i.$t("chat.status.completed")),1)):(r(),p("span",tl,o(i.$t("chat.status.pending")),1))]),d.stepActions&&d.stepActions[ne]?(r(),p("div",nl,[e("div",ol,[e("span",sl,o(((Oe=d.stepActions[ne])==null?void 0:Oe.status)==="current"?"ðŸ”„":((Qe=d.stepActions[ne])==null?void 0:Qe.status)==="completed"?"âœ“":"â³"),1),e("strong",null,o((Ye=d.stepActions[ne])==null?void 0:Ye.actionDescription),1)]),(Ze=d.stepActions[ne])!=null&&Ze.toolParameters?(r(),p("div",al,[c[0]||(c[0]=e("span",{class:"tool-icon"},"âš™ï¸",-1)),e("span",ll,o(i.$t("common.parameters"))+":",1),e("pre",il,o((et=d.stepActions[ne])==null?void 0:et.toolParameters),1)])):A("",!0),(tt=d.stepActions[ne])!=null&&tt.thinkOutput?(r(),p("div",cl,[e("div",rl,[c[1]||(c[1]=e("span",{class:"think-icon"},"ðŸ’­",-1)),e("span",dl,o(i.$t("chat.thinkingOutput"))+":",1)]),e("div",ul,[e("pre",pl,o((nt=d.stepActions[ne])==null?void 0:nt.thinkOutput),1)])])):A("",!0)])):A("",!0),((ot=q(d,ne))==null?void 0:ot.length)>0?(r(),p("div",hl,[e("div",ml,[g(s($),{icon:"carbon:tree-view",class:"sub-plan-icon"}),e("span",vl,o(i.$t("rightPanel.subPlan")),1)]),e("div",gl,[(r(!0),p(fe,null,ye(q(d,ne),(H,ae)=>(r(),p("div",{key:`sub-${ne}-${ae}`,class:ie(["sub-plan-step-item",{completed:X(d,ne,ae)==="completed",current:X(d,ne,ae)==="current",pending:X(d,ne,ae)==="pending"}]),onClick:ce(he=>we(d,ne,ae),["stop"])},[e("div",$l,[e("span",bl,o(X(d,ne,ae)==="completed"?"âœ“":X(d,ne,ae)==="current"?"â–¶":"â—‹"),1),e("span",_l,o(ae+1),1)]),e("div",yl,[e("span",kl,o(H),1),e("span",wl,o(i.$t("rightPanel.subStep")),1)])],10,fl))),128))])])):A("",!0),(st=d.planExecution)!=null&&st.userInputWaitState&&D(d,ne)==="RUNNING"?(r(),p("div",Cl,[e("p",Pl,o(((lt=(at=d.planExecution)==null?void 0:at.userInputWaitState)==null?void 0:lt.message)??i.$t("chat.userInput.message")),1),(ct=(it=d.planExecution)==null?void 0:it.userInputWaitState)!=null&&ct.formDescription?(r(),p("p",Sl,o((dt=(rt=d.planExecution)==null?void 0:rt.userInputWaitState)==null?void 0:dt.formDescription),1)):A("",!0),e("form",{onSubmit:ce(H=>f(d),["prevent"]),class:"user-input-form"},[(pt=(ut=d.planExecution)==null?void 0:ut.userInputWaitState)!=null&&pt.formInputs&&d.planExecution.userInputWaitState.formInputs.length>0?(r(),p("div",Il,[(r(!0),p(fe,null,ye((mt=(ht=d.planExecution)==null?void 0:ht.userInputWaitState)==null?void 0:mt.formInputs,(H,ae)=>(r(),p("div",{key:ae,class:"form-group"},[e("label",{for:`form-input-${H.label.replace(/\W+/g,"_")}`},o(H.label)+o(be(H.required)?" *":"")+": ",9,Tl),!H.type||H.type==="text"?pe((r(),p("input",{key:0,type:"text",id:`form-input-${H.label.replace(/\W+/g,"_")}`,name:H.label,placeholder:H.placeholder||"",required:be(H.required),"onUpdate:modelValue":he=>W[d.id][ae]=he,class:"form-input"},null,8,xl)),[[ve,W[d.id][ae]]]):H.type==="email"?pe((r(),p("input",{key:1,type:"email",id:`form-input-${H.label.replace(/\W+/g,"_")}`,name:H.label,placeholder:H.placeholder||"",required:be(H.required),"onUpdate:modelValue":he=>W[d.id][ae]=he,class:"form-input"},null,8,Dl)),[[ve,W[d.id][ae]]]):H.type==="number"?pe((r(),p("input",{key:2,type:"number",id:`form-input-${H.label.replace(/\W+/g,"_")}`,name:H.label,placeholder:H.placeholder||"",required:be(H.required),"onUpdate:modelValue":he=>W[d.id][ae]=he,class:"form-input"},null,8,Rl)),[[ve,W[d.id][ae]]]):H.type==="password"?pe((r(),p("input",{key:3,type:"password",id:`form-input-${H.label.replace(/\W+/g,"_")}`,name:H.label,placeholder:H.placeholder||"",required:be(H.required),"onUpdate:modelValue":he=>W[d.id][ae]=he,class:"form-input"},null,8,Ml)),[[ve,W[d.id][ae]]]):H.type==="textarea"?pe((r(),p("textarea",{key:4,id:`form-input-${H.label.replace(/\W+/g,"_")}`,name:H.label,placeholder:H.placeholder||"",required:be(H.required),"onUpdate:modelValue":he=>W[d.id][ae]=he,class:"form-input form-textarea",rows:"3"},null,8,Fl)),[[ve,W[d.id][ae]]]):H.type==="select"&&H.options?pe((r(),p("select",{key:5,id:`form-input-${H.label.replace(/\W+/g,"_")}`,name:H.label,required:be(H.required),"onUpdate:modelValue":he=>W[d.id][ae]=he,class:"form-input form-select"},[e("option",Ul,o(i.$t("selectCommon.pleaseSelect")),1),(r(!0),p(fe,null,ye($e(H.options),he=>(r(),p("option",{key:he,value:he},o(he),9,Nl))),128))],8,Al)),[[gt,W[d.id][ae]]]):pe((r(),p("input",{key:6,type:"text",id:`form-input-${H.label.replace(/\W+/g,"_")}`,name:H.label,placeholder:H.placeholder||"",required:be(H.required),"onUpdate:modelValue":he=>W[d.id][ae]=he,class:"form-input"},null,8,Ll)),[[ve,W[d.id][ae]]])]))),128))])):(r(),p("div",ql,[e("label",Bl,o(i.$t("common.input"))+":",1),pe(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":H=>d.genericInput=H,class:"form-input"},null,8,Vl),[[ve,d.genericInput]])])),e("button",jl,o(i.$t("chat.userInput.submit")),1)],40,El)])):A("",!0)],10,Ka)}),128))])):!d.content&&(d.thinking||((te=d.planExecution)==null?void 0:te.progress)!==void 0&&(((Ce=d.planExecution)==null?void 0:Ce.progress)??0)<100)?(r(),p("div",Wl,[e("div",Ol,[c[2]||(c[2]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,o(d.thinking??i.$t("chat.thinkingProcessing")),1)])])):A("",!0)])])):A("",!0),e("div",zl,[e("div",Hl,[e("div",Jl,[g(s($),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Gl,o(i.$t("chat.botName")),1)]),e("div",Kl,[d.content?(r(),p("div",Xl,[e("div",{class:"response-text",innerHTML:h(d.content)},null,8,Ql)])):(r(),p("div",Yl,[e("div",Zl,[c[3]||(c[3]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",ei,o(i.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),U.value?(r(),p("div",ti,[e("div",ni,[e("div",oi,[e("div",si,[e("div",ai,[e("div",li,[g(s($),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",ii,o(i.$t("chat.thinkingLabel")),1)]),e("div",ci,[e("div",ri,[e("div",di,[c[4]||(c[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,o(i.$t("chat.thinking")),1)])])])]),e("div",ui,[e("div",pi,[e("div",hi,[g(s($),{icon:"carbon:bot",class:"bot-icon"})]),e("div",mi,o(i.$t("chat.botName")),1)]),e("div",vi,[e("div",gi,[e("div",fi,[c[5]||(c[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",$i,o(i.$t("chat.thinkingResponse")),1)])])])])])])])):A("",!0)],512),L.value?(r(),p("div",{key:0,class:"scroll-to-bottom-btn",onClick:ue,title:i.$t("chat.scrollToBottom")},[g(s($),{icon:"carbon:chevron-down"})],8,bi)):A("",!0)]))}}),yi=Te(_i,[["__scopeId","data-v-717d6d4e"]]),ze=E([]),vt=T=>{ze.value=[...T]},He=()=>{ze.value=[]},ki=()=>ze.value,wi=()=>ze.value.length>0;class Ci{static async deleteFile(t,n){try{console.log("[FileUploadApiService] Deleting file:",n,"from plan:",t);const l=await fetch(`/api/file-upload/files/${t}/${encodeURIComponent(n)}`,{method:"DELETE",headers:{"Content-Type":"application/json"}});if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const v=await l.json();return console.log("[FileUploadApiService] File deleted successfully:",v),v}catch(l){throw console.error("[FileUploadApiService] Error deleting file:",l),l}}static async getUploadedFiles(t){try{console.log("[FileUploadApiService] Getting uploaded files for plan:",t);const n=await fetch(`/api/file-upload/files/${t}`);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json();return console.log("[FileUploadApiService] Got uploaded files:",l.totalCount),l}catch(n){throw console.error("[FileUploadApiService] Error getting uploaded files:",n),n}}}const Pi={class:"input-area"},Si={class:"input-container"},Ei=["title"],Ii=["placeholder","disabled"],Ti=["title"],xi=["disabled","title"],Di={key:0,class:"uploaded-files"},Ri={class:"files-header"},Mi={class:"files-list"},Fi={class:"file-name"},Ai={class:"file-size"},Ui=["onClick","title"],Ni={key:1,class:"upload-progress"},Li=Ie({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1},initialValue:{default:""}},emits:["send","clear","update-state","plan-mode-clicked","files-uploaded"],setup(T,{expose:t,emit:n}){const{t:l}=Fe(),v=T,b=n,u=E(),M=E(),U=E(""),w=Pe(()=>v.placeholder||l("input.placeholder")),F=E(w.value),L=E([]),W=E(!1),a=E(null),y=()=>{a.value=null,L.value=[],He()};xe(()=>{y()}),Ee(()=>L.value.length,(m,k)=>{});const P=Pe(()=>!!v.disabled),G=()=>{ge(()=>{u.value&&(u.value.style.height="auto",u.value.style.height=Math.min(u.value.scrollHeight,120)+"px")})},x=m=>{m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),R())},R=()=>{if(!U.value.trim()||P.value)return;let m=U.value.trim();if(L.value.length>0){const B=L.value.map(V=>`${V.name} (${V.relativePath})`).join(", ");m+=`

[Uploaded files: ${B}]`}const k={input:m,memoryId:Se.selectMemoryId,uploadedFiles:L.value,sessionPlanId:a.value};b("send",k),j(),L.value=[],He()},ue=()=>{b("plan-mode-clicked")},oe=()=>{M.value&&M.value.click()},N=async m=>{const k=m.target,B=k.files;if(!B||B.length===0)return;const V=Array.from(B);console.log("[FileUpload] Selected files for upload:",V.map(I=>I.name)),await Q(V),k&&(k.value="")},Q=async m=>{if(m.length!==0){W.value=!0;try{const k=new FormData;m.forEach(O=>{k.append("files",O)});let B="/api/file-upload/upload";a.value?(B=`/api/file-upload/upload/${a.value}`,console.log("[FileUpload] Using existing sessionPlanId:",a.value)):console.log("[FileUpload] Creating new temporary planId");const V=await fetch(B,{method:"POST",body:k});if(!V.ok)throw new Error(`Upload failed: ${V.statusText}`);const I=await V.json();if(I.uploadedFiles){!a.value&&I.planId?(a.value=I.planId,console.log("[FileUpload] Set sessionPlanId:",a.value)):a.value&&console.log("[FileUpload] SessionPlanId already exists:",a.value);const O=I.uploadedFiles.map(_=>({name:_.originalName,size:_.size,type:_.extension,planId:I.planId,relativePath:_.relativePath}));L.value=[...L.value,...O],b("files-uploaded",O),vt(L.value),console.log("[Input] Updated global uploadedFiles state:",L.value),L.value.length>0&&(F.value=l("input.filesAttached",{count:L.value.length}))}console.log("Files uploaded successfully:",I)}catch(k){console.error("File upload error:",k)}finally{W.value=!1}}},se=async m=>{try{console.log("ðŸ—‘ï¸ Removing file:",m.name,"from plan:",m.planId),m.planId&&(await Ci.deleteFile(m.planId,m.name),console.log("âœ… File deleted from server successfully")),L.value=L.value.filter(k=>k.name!==m.name),L.value.length===0?(F.value=w.value,He()):(F.value=l("input.filesAttached",{count:L.value.length}),vt(L.value)),console.log("ðŸŽ‰ File removal completed, remaining files:",L.value.length)}catch(k){console.error("âŒ Error removing file:",k),alert(l("input.fileDeleteError")||"Failed to delete file")}},D=m=>{if(m===0)return"0 Bytes";const k=1024,B=["Bytes","KB","MB","GB"],V=Math.floor(Math.log(m)/Math.log(k));return parseFloat((m/Math.pow(k,V)).toFixed(2))+" "+B[V]},j=()=>{U.value="",G(),b("clear")},q=(m,k)=>{k&&(F.value=m?k:l("input.waiting")),b("update-state",m,k)},X=m=>{U.value=m,G()},we=()=>U.value.trim();return Ee(()=>v.initialValue,m=>{m&&m.trim()&&(U.value=m,G())},{immediate:!0}),t({clearInput:j,updateState:q,setInputValue:X,getQuery:we,resetSession:y,focus:()=>{var m;return(m=u.value)==null?void 0:m.focus()}}),De(()=>{}),xe(()=>{}),(m,k)=>(r(),p("div",Pi,[e("div",Si,[e("button",{class:"attach-btn",title:m.$t("input.attachFile"),onClick:oe},[g(s($),{icon:"carbon:attachment"})],8,Ei),e("input",{ref_key:"fileInputRef",ref:M,type:"file",multiple:"",style:{display:"none"},onChange:N,accept:".pdf,.txt,.md,.doc,.docx,.csv,.xlsx,.xls,.json,.xml,.html,.htm,.log,.java,.py,.js,.ts,.sql,.sh,.bat,.yaml,.yml,.properties,.conf,.ini"},null,544),pe(e("textarea",{"onUpdate:modelValue":k[0]||(k[0]=B=>U.value=B),ref_key:"inputRef",ref:u,class:"chat-input",placeholder:F.value,disabled:P.value,onKeydown:x,onInput:G},null,40,Ii),[[ve,U.value]]),e("button",{class:"plan-mode-btn",title:m.$t("input.planMode"),onClick:ue},[g(s($),{icon:"carbon:document"}),le(" "+o(m.$t("input.planMode")),1)],8,Ti),e("button",{class:"send-button",disabled:!U.value.trim()||P.value,onClick:R,title:m.$t("input.send")},[g(s($),{icon:"carbon:send-alt"}),le(" "+o(m.$t("input.send")),1)],8,xi)]),L.value.length>0?(r(),p("div",Di,[e("div",Ri,[g(s($),{icon:"carbon:document"}),e("span",null,o(s(l)("input.attachedFiles"))+" ("+o(L.value.length)+")",1)]),e("div",Mi,[(r(!0),p(fe,null,ye(L.value,B=>(r(),p("div",{key:B.name,class:"file-item"},[g(s($),{icon:"carbon:document",class:"file-icon"}),e("span",Fi,o(B.name),1),e("span",Ai,"("+o(D(B.size))+")",1),e("button",{onClick:V=>se(B),class:"remove-btn",title:s(l)("input.removeFile")},[g(s($),{icon:"carbon:close"})],8,Ui)]))),128))])])):A("",!0),W.value?(r(),p("div",Ni,[g(s($),{icon:"carbon:rotate--clockwise",class:"loading-icon"}),e("span",null,o(s(l)("input.uploading")),1)])):A("",!0)]))}}),qi=Te(Li,[["__scopeId","data-v-f72d2c64"]]);class Ue{static async getAllCronTasks(){try{const t=await fetch(this.BASE_URL);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get cron tasks:",t),t}}static async getCronTaskById(t){try{const n=await fetch(`${this.BASE_URL}/${t}`);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get cron task by id:",n),n}}static async createCronTask(t){try{const n=await fetch(this.BASE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to create cron task:",n),n}}static async updateCronTask(t,n){try{const l=await fetch(`${this.BASE_URL}/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});return await(await this.handleResponse(l)).json()}catch(l){throw console.error("Failed to update cron task:",l),l}}static async updateTaskStatus(t,n){try{const l=await fetch(`${this.BASE_URL}/${t}/status?status=${n}`,{method:"PUT"});await this.handleResponse(l)}catch(l){throw console.error("Failed to update task status:",l),l}}static async deleteCronTask(t){try{const n=await fetch(`${this.BASE_URL}/${t}`,{method:"DELETE"});await this.handleResponse(n)}catch(n){throw console.error("Failed to delete cron task:",n),n}}static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}}me(Ue,"BASE_URL","/api/cron-tasks");const Ne={validateCronExpression(T){const t=T.trim().split(/\s+/);return t.length>=5&&t.length<=6},formatTime(T){return new Date(T).toLocaleString()},async saveTask(T){try{let t;return T.id?t=await Ue.updateCronTask(Number(T.id),T):t=await Ue.createCronTask(T),t}catch(t){throw console.error("Failed to save cron task:",t),t}},async deleteTask(T){try{await Ue.deleteCronTask(String(T))}catch(t){throw console.error("Failed to delete cron task:",t),t}},async toggleTaskStatus(T){if(!T.id)throw new Error("Task ID is required");const t=T.status===0?1:0;return await Ue.updateCronTask(Number(T.id),{...T,status:t})},prepareTaskExecution(T){return T.planTemplateId?{useTemplate:!0,planData:{title:T.cronName||"Scheduled Task Execution",planData:{id:T.planTemplateId,planTemplateId:T.planTemplateId,planId:T.planTemplateId},params:T.executionParams||void 0}}:{useTemplate:!1,taskContent:T.planDesc||T.cronName||""}}},Bi={class:"modal-header"},Vi={class:"header-actions"},ji={class:"status-switch"},Wi={class:"status-label"},Oi={class:"toggle-switch"},zi=["checked"],Hi={class:"modal-content"},Ji={class:"form-group"},Gi={class:"form-label"},Ki=["placeholder"],Xi={class:"form-group"},Qi={class:"form-label"},Yi=["placeholder"],Zi={class:"form-help"},ec={class:"form-group"},tc={class:"form-label"},nc=["placeholder"],oc={class:"form-group"},sc={class:"form-label"},ac={class:"template-toggle"},lc={key:0,class:"template-selector"},ic={value:""},cc=["value"],rc={class:"form-help"},dc={key:0,class:"form-group"},uc={class:"time-info"},pc={class:"time-label"},hc={class:"time-value"},mc={key:1,class:"form-group"},vc={class:"time-info"},gc={class:"time-label"},fc={class:"time-value"},$c={class:"modal-footer"},bc=["disabled"],_c=Ie({__name:"TaskDetailModal",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","save"],setup(T,{emit:t}){const n=T,l=t,v=E(!1),b=E([]),u=E({cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""});De(async()=>{try{const a=await We.getAllPlanTemplates();a&&a.templates&&(b.value=a.templates.map(y=>({id:y.id,name:y.title||"Unnamed Template"})))}catch(a){console.error("Failed to get template list:",a)}});const U=a=>{a.target===a.currentTarget&&l("update:modelValue",!1)},w=()=>{u.value.linkTemplate=!1,u.value.templateId="",u.value.planTemplateId=""},F=()=>u.value.cronName.trim()?u.value.cronTime.trim()?Ne.validateCronExpression(u.value.cronTime)?u.value.planDesc.trim()?u.value.linkTemplate&&!u.value.templateId?(alert("Please select a plan template"),!1):!0:(alert("Task description cannot be empty"),!1):(alert("Invalid Cron expression format, should be 5-6 parts separated by spaces"),!1):(alert("Cron expression cannot be empty"),!1):(alert("Task name cannot be empty"),!1),L=a=>Ne.formatTime(a),W=async()=>{var a;if(F()){v.value=!0;try{const y={...u.value,...((a=n.task)==null?void 0:a.id)!==void 0&&{id:n.task.id},cronName:u.value.cronName.trim(),cronTime:u.value.cronTime.trim(),planDesc:u.value.planDesc.trim(),status:u.value.status,planTemplateId:u.value.linkTemplate&&u.value.templateId||""};l("save",y)}finally{v.value=!1}}};return Ee(()=>n.task,a=>{if(a){const y=a.templateId||a.planTemplateId||"";u.value={cronName:a.cronName||"",cronTime:a.cronTime||"",planDesc:a.planDesc||"",status:a.status??1,linkTemplate:!!y,templateId:y,planTemplateId:y}}else u.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""}},{immediate:!0}),Ee(()=>n.modelValue,a=>{a||(u.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""})}),(a,y)=>(r(),_e(Be,{to:"body"},[g(Le,{name:"modal"},{default:qe(()=>{var P,G,x;return[a.modelValue?(r(),p("div",{key:0,class:"modal-overlay",onClick:U},[e("div",{class:"modal-container",onClick:y[8]||(y[8]=ce(()=>{},["stop"]))},[e("div",Bi,[e("h3",null,o(a.$t("cronTask.taskDetail")),1),e("div",Vi,[e("div",ji,[e("span",Wi,o(a.$t("cronTask.taskStatus")),1),e("label",Oi,[e("input",{type:"checkbox",checked:u.value.status===0,onChange:y[0]||(y[0]=R=>u.value.status=u.value.status===0?1:0)},null,40,zi),y[9]||(y[9]=e("span",{class:"toggle-slider"},null,-1))])]),e("button",{class:"close-btn",onClick:y[1]||(y[1]=R=>a.$emit("update:modelValue",!1))},[g(s($),{icon:"carbon:close"})])])]),e("div",Hi,[e("form",{onSubmit:ce(W,["prevent"]),class:"task-form"},[e("div",Ji,[e("label",Gi,o(a.$t("cronTask.taskName")),1),pe(e("input",{"onUpdate:modelValue":y[2]||(y[2]=R=>u.value.cronName=R),type:"text",class:"form-input",placeholder:a.$t("cronTask.taskNamePlaceholder"),required:""},null,8,Ki),[[ve,u.value.cronName]])]),e("div",Xi,[e("label",Qi,o(a.$t("cronTask.cronExpression")),1),pe(e("input",{"onUpdate:modelValue":y[3]||(y[3]=R=>u.value.cronTime=R),type:"text",class:"form-input",placeholder:a.$t("cronTask.cronExpressionPlaceholder"),required:""},null,8,Yi),[[ve,u.value.cronTime]]),e("div",Zi,o(a.$t("cronTask.cronExpressionHelp")),1)]),e("div",ec,[e("label",tc,o(a.$t("cronTask.taskDescription")),1),pe(e("textarea",{"onUpdate:modelValue":y[4]||(y[4]=R=>u.value.planDesc=R),class:"form-textarea",placeholder:a.$t("cronTask.taskDescriptionPlaceholder"),rows:"4",required:""},null,8,nc),[[ve,u.value.planDesc]])]),e("div",oc,[e("label",sc,o(a.$t("cronTask.planTemplate")),1),e("div",ac,[e("button",{type:"button",class:ie(["template-btn",u.value.linkTemplate?"active":""]),onClick:y[5]||(y[5]=R=>u.value.linkTemplate=!0)},[g(s($),{icon:"carbon:checkmark"}),le(" "+o(a.$t("cronTask.linkTemplate")),1)],2),e("button",{type:"button",class:ie(["template-btn",u.value.linkTemplate?"":"active"]),onClick:w},[g(s($),{icon:"carbon:close"}),le(" "+o(a.$t("cronTask.noTemplate")),1)],2)]),u.value.linkTemplate?(r(),p("div",lc,[pe(e("select",{"onUpdate:modelValue":y[6]||(y[6]=R=>u.value.templateId=R),class:"form-select"},[e("option",ic,o(a.$t("cronTask.selectTemplate")),1),(r(!0),p(fe,null,ye(b.value,R=>(r(),p("option",{key:R.id,value:R.id},o(R.name),9,cc))),128))],512),[[gt,u.value.templateId]]),e("div",rc,o(a.$t("cronTask.templateHelpText")),1)])):A("",!0)]),(P=a.task)!=null&&P.createTime?(r(),p("div",dc,[e("div",uc,[e("span",pc,o(a.$t("cronTask.createTime"))+":",1),e("span",hc,o(L(a.task.createTime)),1)])])):A("",!0),(G=a.task)!=null&&G.updateTime?(r(),p("div",mc,[e("div",vc,[e("span",gc,o(a.$t("cronTask.updateTime"))+":",1),e("span",fc,o(L(a.task.updateTime)),1)])])):A("",!0)],32)]),e("div",$c,[e("button",{type:"button",class:"cancel-btn",onClick:y[7]||(y[7]=R=>a.$emit("update:modelValue",!1))},o(a.$t("common.cancel")),1),e("button",{type:"button",class:"save-btn",onClick:W,disabled:v.value},[v.value?(r(),_e(s($),{key:0,icon:"carbon:loading",class:"loading-icon"})):A("",!0),le(" "+o((x=n.task)!=null&&x.id?a.$t("common.save"):a.$t("common.create")),1)],8,bc)])])])):A("",!0)]}),_:1})]))}}),yc=Te(_c,[["__scopeId","data-v-1ac463d9"]]),kc={class:"modal-header"},wc={class:"header-actions"},Cc={class:"modal-content"},Pc={key:0,class:"loading-container"},Sc={key:1,class:"empty-container"},Ec={key:2,class:"task-list"},Ic=["onClick"],Tc={class:"task-main"},xc={class:"task-info"},Dc={class:"task-header"},Rc={class:"task-name"},Mc={class:"task-description"},Fc={class:"task-time"},Ac=["onClick"],Uc=["onClick","disabled","title"],Nc=["onClick","title"],Lc={class:"dropdown-menu"},qc=["onClick"],Bc=["onClick","disabled"],Vc=["onClick","disabled"],jc={class:"confirm-header"},Wc={class:"confirm-content"},Oc={class:"confirm-actions"},zc=["disabled"],Hc={class:"confirm-header"},Jc={class:"confirm-content"},Gc={class:"create-options"},Kc={class:"option-content"},Xc={class:"option-title"},Qc={class:"option-desc"},Yc={class:"option-content"},Zc={class:"option-title"},er={class:"option-desc"},tr={class:"confirm-actions"},nr=Ie({__name:"index",props:{modelValue:{type:Boolean,required:!0}},emits:["update:modelValue"],setup(T,{emit:t}){const n=ft(),l=$t(),v=St(),{t:b}=Fe(),u=T,M=t,U=E([]),w=E(!1),F=E(null),L=E(null),W=E(null),a=E(null),y=E(!1),P=E(null),G=E(!1),x=E(null),R=E(!1),ue=_=>{_.target===_.currentTarget&&M("update:modelValue",!1)},oe=async()=>{w.value=!0;try{U.value=await Ue.getAllCronTasks()}catch(_){console.error("Failed to load cron tasks:",_),v.error(`Failed to load tasks: ${_ instanceof Error?_.message:String(_)}`)}finally{w.value=!1}},N=async _=>{F.value=_;try{const h=U.value.find(re=>re.id===_);if(!h){console.error("Task not found:",_);return}M("update:modelValue",!1);const f=Date.now().toString();await n.push({name:"direct",params:{id:f}}),await new Promise(re=>setTimeout(re,100));const J=Ne.prepareTaskExecution(h);J.useTemplate&&J.planData?l.emitPlanExecutionRequested(J.planData):J.taskContent&&l.setTask(J.taskContent)}catch(h){console.error("Failed to execute task:",h),v.error(`Execution failed: ${h instanceof Error?h.message:String(h)}`)}finally{F.value=null}},Q=_=>{P.value={..._},y.value=!0,a.value=null},se=async _=>{try{await Ne.saveTask(_),await oe(),y.value=!1,v.success("Task saved successfully")}catch(h){console.error("Failed to save task:",h),v.error(`Save failed: ${h instanceof Error?h.message:String(h)}`)}},D=_=>{x.value=_,G.value=!0},j=async()=>{var _;if((_=x.value)!=null&&_.id){L.value=x.value.id;try{await Ne.deleteTask(x.value.id),await oe(),G.value=!1,x.value=null,v.success("Task deleted successfully")}catch(h){console.error("Failed to delete task:",h),v.error(`Delete failed: ${h instanceof Error?h.message:String(h)}`)}finally{L.value=null}}},q=()=>{G.value=!1,x.value=null},X=_=>{a.value=a.value===_?null:_},we=async _=>{if(_.id){W.value=_.id;try{await Ne.toggleTaskStatus(_),await oe(),a.value=null,v.success(`Task ${_.status===0?"disabled":"enabled"} successfully`)}catch(h){console.error("Failed to toggle task status:",h),v.error(`Status toggle failed: ${h instanceof Error?h.message:String(h)}`)}finally{W.value=null}}},m=async _=>{try{await navigator.clipboard.writeText(_),v.success("Cron expression copied successfully")}catch(h){v.error(`Copy failed: ${h instanceof Error?h.message:String(h)}`)}},k=()=>{R.value=!0},B=()=>{R.value=!1;try{M("update:modelValue",!1);const _=b("cronTask.template");l.setTaskToInput(_);const h=Date.now().toString();n.push({name:"direct",params:{id:h}})}catch(_){console.error("Error in createWithJmanus:",_),v.error(`Creation failed: ${_ instanceof Error?_.message:String(_)}`)}},V=()=>{R.value=!1,P.value={cronName:"",cronTime:"",planDesc:"",status:0,planTemplateId:""},y.value=!0},I=()=>{R.value=!1},O=_=>{const h=_.target;!h.closest(".action-dropdown")&&!h.closest(".dropdown-menu")&&(a.value=null)};return De(()=>{document.addEventListener("click",O,!0)}),xe(()=>{document.removeEventListener("click",O,!0)}),Ee(()=>u.modelValue,_=>{_&&oe()}),(_,h)=>(r(),p(fe,null,[(r(),_e(Be,{to:"body"},[g(Le,{name:"modal"},{default:qe(()=>[T.modelValue?(r(),p("div",{key:0,class:"modal-overlay",onClick:ue},[e("div",{class:"modal-container",onClick:h[3]||(h[3]=ce(()=>{},["stop"]))},[e("div",kc,[e("h3",null,o(_.$t("cronTask.title")),1),e("div",wc,[e("button",{class:"add-task-btn",onClick:[k,h[0]||(h[0]=ce(()=>{},["stop"]))]},[g(s($),{icon:"carbon:add"}),le(" "+o(_.$t("cronTask.addTask")),1)]),e("button",{class:"close-btn",onClick:h[1]||(h[1]=f=>_.$emit("update:modelValue",!1))},[g(s($),{icon:"carbon:close"})])])]),e("div",Cc,[w.value?(r(),p("div",Pc,[g(s($),{icon:"carbon:loading",class:"loading-icon"}),e("span",null,o(_.$t("common.loading")),1)])):U.value.length===0?(r(),p("div",Sc,[g(s($),{icon:"carbon:time",class:"empty-icon"}),e("span",null,o(_.$t("cronTask.noTasks")),1)])):(r(),p("div",Ec,[(r(!0),p(fe,null,ye(U.value,f=>(r(),p("div",{key:f.id||"",class:"task-item",onClick:J=>Q(f)},[e("div",Tc,[e("div",xc,[e("div",Dc,[e("div",Rc,o(f.cronName),1),e("div",{class:ie(["task-status-badge",f.status===0?"active":"inactive"])},[g(s($),{icon:f.status===0?"carbon:checkmark-filled":"carbon:pause-filled"},null,8,["icon"]),e("span",null,o(f.status===0?_.$t("cronTask.active"):_.$t("cronTask.inactive")),1)],2)]),e("div",Mc,o(f.planDesc),1),e("div",Fc,[g(s($),{icon:"carbon:time"}),e("span",{class:"cron-readable",style:{cursor:"pointer"},onClick:ce(J=>m(f.cronTime),["stop"])},o(f.cronTime),9,Ac)])])]),e("div",{class:"task-actions",onClick:h[2]||(h[2]=ce(()=>{},["stop"]))},[e("button",{class:"action-btn execute-btn",onClick:J=>N(f.id),disabled:F.value===f.id,title:_.$t("cronTask.executeOnce")},[g(s($),{icon:F.value===f.id?"carbon:loading":"carbon:play-filled"},null,8,["icon"]),le(" "+o(_.$t("cronTask.executeOnce")),1)],8,Uc),e("div",{class:ie(["action-dropdown",{active:a.value===f.id}])},[e("button",{class:"action-btn dropdown-btn",onClick:J=>X(f.id),title:_.$t("cronTask.operations")},[g(s($),{icon:"carbon:overflow-menu-horizontal"}),le(" "+o(_.$t("cronTask.operations")),1)],8,Nc),pe(e("div",Lc,[e("button",{class:"dropdown-item edit-btn",onClick:J=>Q(f)},[g(s($),{icon:"carbon:edit"}),le(" "+o(_.$t("cronTask.edit")),1)],8,qc),e("button",{class:"dropdown-item toggle-btn",onClick:J=>we(f),disabled:W.value===f.id},[g(s($),{icon:W.value===f.id?"carbon:loading":f.status===0?"carbon:pause-filled":"carbon:play-filled"},null,8,["icon"]),le(" "+o(f.status===0?_.$t("cronTask.disable"):_.$t("cronTask.enable")),1)],8,Bc),e("button",{class:"dropdown-item delete-btn",onClick:J=>D(f),disabled:L.value===f.id},[g(s($),{icon:L.value===f.id?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),le(" "+o(_.$t("cronTask.delete")),1)],8,Vc)],512),[[kt,a.value===f.id]])],2)])],8,Ic))),128))]))])])])):A("",!0)]),_:1})])),g(yc,{modelValue:y.value,"onUpdate:modelValue":h[4]||(h[4]=f=>y.value=f),task:P.value,onSave:se},null,8,["modelValue","task"]),(r(),_e(Be,{to:"body"},[g(Le,{name:"modal"},{default:qe(()=>{var f,J,re,$e;return[G.value?(r(),p("div",{key:0,class:"modal-overlay",onClick:q},[e("div",{class:"confirm-modal",onClick:h[5]||(h[5]=ce(()=>{},["stop"]))},[e("div",jc,[g(s($),{icon:"carbon:warning",class:"warning-icon"}),e("h3",null,o(_.$t("cronTask.deleteConfirm")),1)]),e("div",Wc,[e("p",null,o(_.$t("cronTask.deleteConfirmMessage",{taskName:((f=x.value)==null?void 0:f.cronName)||((J=x.value)==null?void 0:J.planDesc)||""})),1)]),e("div",Oc,[e("button",{class:"confirm-btn cancel-btn",onClick:q},o(_.$t("common.cancel")),1),e("button",{class:"confirm-btn delete-btn",onClick:j,disabled:L.value===((re=x.value)==null?void 0:re.id)},[g(s($),{icon:L.value===(($e=x.value)==null?void 0:$e.id)?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),le(" "+o(_.$t("cronTask.delete")),1)],8,zc)])])])):A("",!0)]}),_:1})])),(r(),_e(Be,{to:"body"},[g(Le,{name:"modal"},{default:qe(()=>[R.value?(r(),p("div",{key:0,class:"modal-overlay",onClick:I},[e("div",{class:"confirm-modal create-options-modal",onClick:h[6]||(h[6]=ce(()=>{},["stop"]))},[e("div",Hc,[g(s($),{icon:"carbon:time",class:"create-icon"}),e("h3",null,o(_.$t("cronTask.createTask")),1)]),e("div",Jc,[e("p",null,o(_.$t("cronTask.selectCreateMethod")),1),e("div",Gc,[e("button",{class:"create-option-btn jmanus-btn",onClick:B},[g(s($),{icon:"carbon:ai-status"}),e("div",Kc,[e("span",Xc,o(_.$t("cronTask.createWithJmanus")),1),e("span",Qc,o(_.$t("cronTask.createWithJmanusDesc")),1)])]),e("button",{class:"create-option-btn manual-btn",onClick:V},[g(s($),{icon:"carbon:edit"}),e("div",Yc,[e("span",Zc,o(_.$t("cronTask.createManually")),1),e("span",er,o(_.$t("cronTask.createManuallyDesc")),1)])])])]),e("div",tr,[e("button",{class:"confirm-btn cancel-btn",onClick:I},o(_.$t("common.cancel")),1)])])])):A("",!0)]),_:1})]))],64))}}),or=Te(nr,[["__scopeId","data-v-848c7703"]]),sr={class:"direct-page"},ar={class:"direct-chat"},lr={class:"chat-header"},ir={class:"header-actions"},cr=["title"],rr=["title"],dr=["title"],ur=["title"],pr={class:"chat-content"},hr=["title"],mr={class:"message-content"},vr=Ie({__name:"index",setup(T){const t=wt(),n=ft(),l=$t(),{t:v}=Fe(),{message:b}=Et(),u=E(""),M=E(""),U=E(),w=E(),F=E(),L=E(!1),W=E(!1),a=E(null),y=E(!1),P=E(50),G=E(!1),x=E(0),R=E(0);De(()=>{if(console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",l.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",l.hasUnprocessedTask()),ke.setEventCallbacks({onPlanUpdate:f=>{console.log("[Direct] Plan update event received for rootPlanId:",f),se(f)&&(console.log("[Direct] Processing plan update for current rootPlanId:",f),w.value&&typeof w.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",f),w.value.handlePlanUpdate(f)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),U.value&&typeof U.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",f),U.value.updateDisplayedPlanProgress(f)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:f=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",f),!!se(f)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",f),w.value&&typeof w.value.handlePlanCompleted=="function"){const J=ke.getCachedPlanRecord(f);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",J),w.value.handlePlanCompleted(J??{planId:f})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");a.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:f=>{console.log("[Direct] Dialog round start event received for rootPlanId:",f),a.value=f,console.log("[Direct] Set currentRootPlanId to:",f),w.value&&typeof w.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",f),w.value.handleDialogRoundStart(f)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),j()},onChatInputUpdateState:f=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",f),!se(f,!0))return;const J=ke.getCachedUIState(f);J&&X(J.enabled,J.placeholder)},onPlanError:f=>{w.value.handlePlanError(f)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),S.loadPlanTemplateList(),l.hasUnprocessedTask()&&l.currentTask){const f=l.currentTask.prompt;console.log("[Direct] Found unprocessed task from store:",f),l.markTaskAsProcessed(),ge(()=>{w.value&&typeof w.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing task via chatRef.handleSendMessage:",f),w.value.handleSendMessage({input:f})):(console.warn("[Direct] chatRef.handleSendMessage method not available, falling back to prompt"),u.value=f)})}else{const f=l.getAndClearTaskToInput();f?(M.value=f,console.log("[Direct] Setting inputOnlyContent for input only:",M.value)):(u.value=t.query.prompt||"",console.log("[Direct] Received task from URL:",u.value),console.log("[Direct] No unprocessed task in store"))}const h=localStorage.getItem("directPanelWidth");h&&(P.value=parseFloat(h)),console.log("[Direct] Final prompt value:",u.value),M.value&&ge(()=>{F.value&&typeof F.value.setInputValue=="function"&&(F.value.setInputValue(M.value),console.log("[Direct] Set input value:",M.value),M.value="")}),window.addEventListener("plan-execution-requested",f=>{console.log("[DirectView] Received plan-execution-requested event:",f.detail),I(f.detail)})}),Ee(()=>l.currentTask,h=>{if(console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",h),h&&!h.processed){const f=h.prompt;l.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",f),ge(()=>{w.value&&typeof w.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing new task via chatRef.handleSendMessage:",f),w.value.handleSendMessage(f)):console.warn("[Direct] chatRef.handleSendMessage method not available for new task")})}else console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),Ee(()=>u.value,(h,f)=>{console.log("[Direct] prompt value changed from:",f,"to:",h)},{immediate:!1}),Ee(()=>l.taskToInput,h=>{console.log("[Direct] Watch taskStore.taskToInput triggered, newTaskToInput:",h),h&&h.trim()&&(console.log("[Direct] Setting input value from taskToInput:",h),ge(()=>{F.value&&typeof F.value.setInputValue=="function"&&(F.value.setInputValue(h.trim()),console.log("[Direct] Input value set from taskToInput watch:",h.trim()),l.getAndClearTaskToInput())}))},{immediate:!1}),xe(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),a.value=null,ke.cleanup(),document.removeEventListener("mousemove",oe),document.removeEventListener("mouseup",N),window.removeEventListener("plan-execution-requested",h=>{I(h.detail)})});const ue=h=>{G.value=!0,x.value=h.clientX,R.value=P.value,document.addEventListener("mousemove",oe),document.addEventListener("mouseup",N),document.body.style.cursor="col-resize",document.body.style.userSelect="none",h.preventDefault()},oe=h=>{if(!G.value)return;const f=window.innerWidth,re=(h.clientX-x.value)/f*100;let $e=R.value+re;$e=Math.max(20,Math.min(80,$e)),P.value=$e},N=()=>{G.value=!1,document.removeEventListener("mousemove",oe),document.removeEventListener("mouseup",N),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",P.value.toString())},Q=()=>{P.value=50,localStorage.setItem("directPanelWidth","50")},se=(h,f=!1)=>!a.value||h===a.value||f&&(h==="ui-state"||h==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",h,"current:",a.value),!1),D=h=>{console.log("[DirectView] Send message from input:",JSON.stringify(h)),w.value&&typeof w.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",JSON.stringify(h)),w.value.handleSendMessage(h)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},j=()=>{console.log("[DirectView] Input cleared"),F.value&&typeof F.value.clear=="function"&&F.value.clear()},q=()=>{console.log("[DirectView] Input focused")},X=(h,f)=>{console.log("[DirectView] Input state updated:",h,f),W.value=!h},we=(h,f)=>{console.log("[DirectView] Step selected:",h,f),U.value&&typeof U.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",h,f),U.value.handleStepSelected(h,f)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},m=(h,f,J,re)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:h,subPlanId:f,stepIndex:J,subStepIndex:re}),U.value&&typeof U.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:h,subPlanId:f,stepIndex:J,subStepIndex:re}),U.value.handleSubPlanStepSelected(h,f,J,re)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},k=()=>{console.log("[DirectView] Plan mode button clicked"),S.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",S.isCollapsed)},B=()=>{n.push("/home")},V=()=>{n.push("/configs")},I=async h=>{var J,re,$e,be;if(console.log("[DirectView] Plan execution requested:",h),L.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}L.value=!0;let f=!1;w.value&&typeof w.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",h.title),w.value.addMessage("user",h.title),f=!0):console.warn("[DirectView] chatRef.addMessage method not available");try{const i=((J=h.planData)==null?void 0:J.planTemplateId)||((re=h.planData)==null?void 0:re.id)||(($e=h.planData)==null?void 0:$e.planId);if(!i)throw new Error(v("direct.planTemplateIdNotFound"));console.log("[Direct] Executing plan with templateId:",i,"params:",h.params),console.log("[Direct] About to call PlanActApiService.executePlan");const c=wi()?ki():void 0;console.log("[Direct] Executing with uploaded files:",(c==null?void 0:c.length)||0);let d;if((be=h.params)!=null&&be.trim()?(console.log("[Direct] Calling executePlan with params:",h.params.trim()),d=await We.executePlan(i,h.params.trim(),c)):(console.log("[Direct] Calling executePlan without params"),d=await We.executePlan(i,void 0,c)),console.log("[Direct] Plan execution API response:",d),d.planId)console.log("[Direct] Got planId from response:",d.planId,"starting plan execution"),a.value=d.planId,console.log("[Direct] Set currentRootPlanId to:",d.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),ke.handlePlanExecutionRequested(d.planId,h.title);else throw console.error("[Direct] No planId in response:",d),new Error(v("direct.executionFailedNoPlanId"))}catch(i){console.error("[Direct] Plan execution failed:",i),console.error("[Direct] Error details:",{message:i.message,stack:i.stack}),a.value=null,w.value&&typeof w.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),f||w.value.addMessage("user",h.title),w.value.addMessage("assistant",`${v("direct.executionFailed")}: ${i.message||v("common.unknownError")}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`${v("direct.executionFailed")}: ${i.message||v("common.unknownError")}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),L.value=!1}},O=()=>{w.value.showMemory()},_=()=>{Se.clearMemoryId(),w.value.newChat()};return(h,f)=>(r(),p("div",sr,[e("div",ar,[g(In,{onPlanExecutionRequested:I}),e("div",{class:"left-panel",style:je({width:P.value+"%"})},[e("div",lr,[e("button",{class:"back-button",onClick:B},[g(s($),{icon:"carbon:arrow-left"})]),e("h2",null,o(h.$t("conversation")),1),e("div",ir,[g(Pt),e("button",{class:"config-button",onClick:_,title:h.$t("memory.newChat")},[g(s($),{icon:"carbon:add",width:"20"})],8,cr),e("button",{class:"config-button",onClick:V,title:h.$t("direct.configuration")},[g(s($),{icon:"carbon:settings-adjust",width:"20"})],8,rr),e("button",{class:"cron-task-btn",onClick:f[0]||(f[0]=J=>y.value=!0),title:h.$t("cronTask.title")},[g(s($),{icon:"carbon:alarm",width:"20"})],8,dr),e("button",{class:"cron-task-btn",onClick:f[1]||(f[1]=J=>s(Se).toggleSidebar()),title:h.$t("memory.selectMemory")},[g(s($),{icon:"carbon:calendar",width:"20"})],8,ur)])]),e("div",pr,[g(yi,{ref_key:"chatRef",ref:w,mode:"direct","initial-prompt":u.value||"",onStepSelected:we,onSubPlanStepSelected:m},null,8,["initial-prompt"])]),(r(),_e(qi,{key:h.$i18n.locale,ref_key:"inputRef",ref:F,disabled:W.value,placeholder:W.value?s(v)("input.waiting"):s(v)("input.placeholder"),"initial-value":u.value,onSend:D,onClear:j,onFocus:q,onUpdateState:X,onPlanModeClicked:k},null,8,["disabled","placeholder","initial-value"]))],4),e("div",{class:"panel-resizer",onMousedown:ue,onDblclick:Q,title:h.$t("direct.panelResizeHint")},f[3]||(f[3]=[e("div",{class:"resizer-line"},null,-1)]),40,hr),g(Ra,{ref_key:"rightPanelRef",ref:U,style:je({width:100-P.value+"%"}),"current-root-plan-id":a.value},null,8,["style","current-root-plan-id"])]),g(or,{modelValue:y.value,"onUpdate:modelValue":f[2]||(f[2]=J=>y.value=J)},null,8,["modelValue"]),g(Co,{onMemorySelected:O}),s(b).show?(r(),p("div",{key:0,class:ie(["message-toast",s(b).type])},[e("div",mr,[e("span",null,o(s(b).text),1)])],2)):A("",!0)]))}}),wr=Te(vr,[["__scopeId","data-v-ece4ce3e"]]);export{wr as default};
