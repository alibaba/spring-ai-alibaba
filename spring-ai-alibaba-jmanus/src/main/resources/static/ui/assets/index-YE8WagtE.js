var rt=Object.defineProperty;var dt=(T,t,n)=>t in T?rt(T,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):T[t]=n;var he=(T,t,n)=>dt(T,typeof t!="symbol"?t+"":t,n);import{d as _e,u as Te,c as pe,o as Pe,a as v,b as p,n as te,i as s,e,f as N,t as a,g,h as Z,F as ve,q as fe,j as oe,w as ge,m as $e,A as lt,r as I,B as Ce,y as Me,l as ie,C as ut,D as be,z as ae,T as Re,p as Ae,E as Ue,G as pt,H as ht,x as it,I as vt}from"./index-dr9-rQHR.js";import{I as k,_ as ye}from"./_plugin-vue_export-helper--shhf_CY.js";import{s as P,P as Fe,u as ct}from"./sidebar-CbjfCXzt.js";import{L as gt}from"./llm-check-BVkAKrj3.js";import{L as mt}from"./index-CuLlRUzS.js";import{u as ft,a as bt}from"./useMessage-CpRVAwnw.js";const kt={class:"sidebar-content"},$t={class:"sidebar-content-header"},_t={class:"sidebar-content-title"},yt={class:"tab-switcher"},Pt=["disabled"],Ct={key:0,class:"tab-content"},St={class:"new-task-section"},wt={class:"sidebar-content-list"},Et={key:0,class:"loading-state"},Tt={key:1,class:"error-state"},It={key:2,class:"empty-state"},xt=["onClick"],Dt={class:"task-icon"},Rt={class:"task-details"},At={class:"task-title"},Mt={class:"task-preview"},Ft={class:"task-time"},Nt={class:"task-actions"},Ut=["title","onClick"],Lt={key:1,class:"tab-content config-tab"},Bt={key:0,class:"config-container"},qt={class:"template-info-header"},Vt={class:"template-info"},Wt={class:"template-id"},jt={class:"config-section"},Ot={class:"section-header"},zt={class:"generator-content"},Ht=["placeholder"],Jt={class:"generator-actions"},Gt=["disabled"],Kt=["disabled"],Xt={class:"config-section"},Qt={class:"section-header"},Yt={class:"section-actions"},Zt=["disabled","title"],en=["disabled","title"],tn=["disabled"],nn=["placeholder"],sn={class:"config-section"},on={class:"section-header"},an={class:"execution-content"},ln={class:"params-input-group"},cn={class:"params-help-text"},rn={class:"params-input-container"},dn=["placeholder"],un=["title"],pn={class:"api-url-display"},hn={class:"api-url-label"},vn={class:"api-url"},gn={class:"api-url-display"},mn={class:"api-url-label"},fn=["disabled"],bn=_e({__name:"index",emits:["planExecutionRequested"],setup(T,{expose:t,emit:n}){const{t:r}=Te(),m=["currentPlanId","userRequest","rootPlanId"],$=pe({get(){try{if(!P.jsonContent)return"";const b={...JSON.parse(P.jsonContent)};return m.forEach(C=>{delete b[C]}),JSON.stringify(b,null,2)}catch{return P.jsonContent}},set(o){try{if(!o.trim()){P.jsonContent="";return}const b=JSON.parse(o);let C={};try{C=JSON.parse(P.jsonContent||"{}")}catch{}const H={...b};m.forEach(w=>{C[w]!==void 0&&(H[w]=C[w])}),P.jsonContent=JSON.stringify(H)}catch{P.jsonContent=o}}}),u=n,E=async()=>{try{const o=await P.saveTemplate();o!=null&&o.duplicate?alert(r("sidebar.saveCompleted",{message:o.message,versionCount:o.versionCount})):o!=null&&o.saved?alert(r("sidebar.saveSuccess",{message:o.message,versionCount:o.versionCount})):o!=null&&o.message&&alert(r("sidebar.saveStatus",{message:o.message}))}catch(o){console.error("Failed to save plan modifications:",o),alert(o.message||r("sidebar.saveFailed"))}},U=async()=>{var o;try{await P.generatePlan(),alert(r("sidebar.generateSuccess",{templateId:((o=P.selectedTemplate)==null?void 0:o.id)??r("sidebar.unknown")}))}catch(b){console.error("Failed to generate plan:",b),alert(r("sidebar.generateFailed")+": "+b.message)}},S=async()=>{try{await P.updatePlan(),alert(r("sidebar.updateSuccess"))}catch(o){console.error("Failed to update plan:",o),alert(r("sidebar.updateFailed")+": "+o.message)}},M=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const o=P.preparePlanExecution();if(!o){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] Triggering plan execution request:",o),console.log("[Sidebar] Emitting planExecutionRequested event"),u("planExecutionRequested",o),console.log("[Sidebar] Event emitted")}catch(o){console.error("Error executing plan:",o),alert(r("sidebar.executeFailed")+": "+o.message)}finally{P.finishPlanExecution()}},O=o=>{if(isNaN(o.getTime()))return console.warn("Invalid date received:",o),r("time.unknown");const C=new Date().getTime()-o.getTime(),H=Math.floor(C/6e4),w=Math.floor(C/36e5),x=Math.floor(C/864e5);return H<1?r("time.now"):H<60?r("time.minuteAgo",{count:H}):w<24?r("time.hourAgo",{count:w}):x<30?r("time.dayAgo",{count:x}):o.toLocaleDateString("zh-CN")},z=(o,b)=>!o||o.length<=b?o:o.substring(0,b)+"...";return Pe(()=>{P.loadPlanTemplateList()}),t({loadPlanTemplateList:P.loadPlanTemplateList,toggleSidebar:P.toggleSidebar,currentPlanTemplateId:P.currentPlanTemplateId}),(o,b)=>(p(),v("div",{class:te(["sidebar-wrapper",{"sidebar-wrapper-collapsed":s(P).isCollapsed}])},[e("div",kt,[e("div",$t,[e("div",_t,a(o.$t("sidebar.title")),1)]),e("div",yt,[e("button",{class:te(["tab-button",{active:s(P).currentTab==="list"}]),onClick:b[0]||(b[0]=C=>s(P).switchToTab("list"))},[g(s(k),{icon:"carbon:list",width:"16"}),Z(" "+a(o.$t("sidebar.templateList")),1)],2),e("button",{class:te(["tab-button",{active:s(P).currentTab==="config"}]),onClick:b[1]||(b[1]=C=>s(P).switchToTab("config")),disabled:!s(P).selectedTemplate},[g(s(k),{icon:"carbon:settings",width:"16"}),Z(" "+a(o.$t("sidebar.configuration")),1)],10,Pt)]),s(P).currentTab==="list"?(p(),v("div",Ct,[e("div",St,[e("button",{class:"new-task-btn",onClick:b[2]||(b[2]=C=>s(P).createNewTemplate())},[g(s(k),{icon:"carbon:add",width:"16"}),Z(" "+a(o.$t("sidebar.newPlan"))+" ",1),b[11]||(b[11]=e("span",{class:"shortcut"},"âŒ˜ K",-1))])]),e("div",wt,[s(P).isLoading?(p(),v("div",Et,[g(s(k),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,a(o.$t("sidebar.loading")),1)])):s(P).errorMessage?(p(),v("div",Tt,[g(s(k),{icon:"carbon:warning",width:"20"}),e("span",null,a(s(P).errorMessage),1),e("button",{onClick:b[3]||(b[3]=(...C)=>s(P).loadPlanTemplateList&&s(P).loadPlanTemplateList(...C)),class:"retry-btn"},a(o.$t("sidebar.retry")),1)])):s(P).planTemplateList.length===0?(p(),v("div",It,[g(s(k),{icon:"carbon:document",width:"32"}),e("span",null,a(o.$t("sidebar.noTemplates")),1)])):(p(!0),v(ve,{key:3},fe(s(P).sortedTemplates,C=>(p(),v("div",{key:C.id,class:te(["sidebar-content-list-item",{"sidebar-content-list-item-active":C.id===s(P).currentPlanTemplateId}]),onClick:H=>s(P).selectTemplate(C)},[e("div",Dt,[g(s(k),{icon:"carbon:document",width:"20"})]),e("div",Rt,[e("div",At,a(C.title||o.$t("sidebar.unnamedPlan")),1),e("div",Mt,a(z(C.description||o.$t("sidebar.noDescription"),40)),1)]),e("div",Ft,a(O(s(P).parseDateTime(C.updateTime||C.createTime))),1),e("div",Nt,[e("button",{class:"delete-task-btn",title:o.$t("sidebar.deleteTemplate"),onClick:oe(H=>s(P).deleteTemplate(C),["stop"])},[g(s(k),{icon:"carbon:close",width:"16"})],8,Ut)])],10,xt))),128))])])):s(P).currentTab==="config"?(p(),v("div",Lt,[s(P).selectedTemplate?(p(),v("div",Bt,[e("div",qt,[e("div",Vt,[e("h3",null,a(s(P).selectedTemplate.title||o.$t("sidebar.unnamedPlan")),1),e("span",Wt,"ID: "+a(s(P).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:b[4]||(b[4]=C=>s(P).switchToTab("list"))},[g(s(k),{icon:"carbon:arrow-left",width:"16"})])]),e("div",jt,[e("div",Ot,[g(s(k),{icon:"carbon:generate",width:"16"}),e("span",null,a(o.$t("sidebar.planGenerator")),1)]),e("div",zt,[ge(e("textarea",{"onUpdate:modelValue":b[5]||(b[5]=C=>s(P).generatorPrompt=C),class:"prompt-input",placeholder:o.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,Ht),[[$e,s(P).generatorPrompt]]),e("div",Jt,[e("button",{class:"btn btn-primary btn-sm",onClick:U,disabled:s(P).isGenerating||!s(P).generatorPrompt.trim()},[g(s(k),{icon:s(P).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:te({spinning:s(P).isGenerating})},null,8,["icon","class"]),Z(" "+a(s(P).isGenerating?o.$t("sidebar.generating"):o.$t("sidebar.generatePlan")),1)],8,Gt),e("button",{class:"btn btn-secondary btn-sm",onClick:S,disabled:s(P).isGenerating||!s(P).generatorPrompt.trim()||!s(P).jsonContent.trim()},[g(s(k),{icon:"carbon:edit",width:"14"}),Z(" "+a(o.$t("sidebar.updatePlan")),1)],8,Kt)])])]),e("div",Xt,[e("div",Qt,[g(s(k),{icon:"carbon:code",width:"16"}),e("span",null,a(o.$t("sidebar.jsonTemplate")),1),e("div",Yt,[e("button",{class:"btn btn-sm",onClick:b[6]||(b[6]=(...C)=>s(P).rollbackVersion&&s(P).rollbackVersion(...C)),disabled:!s(P).canRollback,title:o.$t("sidebar.rollback")},[g(s(k),{icon:"carbon:undo",width:"14"})],8,Zt),e("button",{class:"btn btn-sm",onClick:b[7]||(b[7]=(...C)=>s(P).restoreVersion&&s(P).restoreVersion(...C)),disabled:!s(P).canRestore,title:o.$t("sidebar.restore")},[g(s(k),{icon:"carbon:redo",width:"14"})],8,en),e("button",{class:"btn btn-primary btn-sm",onClick:E,disabled:s(P).isGenerating||s(P).isExecuting},[g(s(k),{icon:"carbon:save",width:"14"})],8,tn)])]),ge(e("textarea",{"onUpdate:modelValue":b[8]||(b[8]=C=>$.value=C),class:"json-editor",placeholder:o.$t("sidebar.jsonPlaceholder"),rows:"12"},null,8,nn),[[$e,$.value]])]),e("div",sn,[e("div",on,[g(s(k),{icon:"carbon:play",width:"16"}),e("span",null,a(o.$t("sidebar.executionController")),1)]),e("div",an,[e("div",ln,[e("label",null,a(o.$t("sidebar.executionParams")),1),e("div",cn,a(o.$t("sidebar.executionParamsHelp")),1),e("div",rn,[ge(e("input",{"onUpdate:modelValue":b[9]||(b[9]=C=>s(P).executionParams=C),class:"params-input",placeholder:o.$t("sidebar.executionParamsPlaceholder")},null,8,dn),[[$e,s(P).executionParams]]),e("button",{class:"clear-params-btn",onClick:b[10]||(b[10]=(...C)=>s(P).clearExecutionParams&&s(P).clearExecutionParams(...C)),title:o.$t("sidebar.clearParams")},[g(s(k),{icon:"carbon:close",width:"12"})],8,un)])]),e("div",pn,[e("span",hn,a(o.$t("sidebar.apiUrl"))+":",1),e("code",vn,a(s(P).computedApiUrl),1)]),e("div",gn,[e("span",mn,a(o.$t("sidebar.statusApiUrl"))+":",1),b[12]||(b[12]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:M,disabled:s(P).isExecuting||s(P).isGenerating},[g(s(k),{icon:s(P).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:te({spinning:s(P).isExecuting})},null,8,["icon","class"]),Z(" "+a(s(P).isExecuting?o.$t("sidebar.executing"):o.$t("sidebar.executePlan")),1)],8,fn)])])])):N("",!0)])):N("",!0)])],2))}}),kn=ye(bn,[["__scopeId","data-v-3c0cf310"]]);class Be{static async sendMessage(t){return gt.withLlmCheck(async()=>{const n=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t})});if(!n.ok)throw new Error(`API request failed: ${n.status}`);return await n.json()})}}he(Be,"BASE_URL","/api/executor");class qe{static async getDetails(t){try{const n=await fetch(`${this.BASE_URL}/details/${t}`);if(n.status===404)return null;if(!n.ok){const $=await n.text();throw new Error(`Failed to get detailed information: ${n.status} - ${$}`)}const r=await n.text(),m=JSON.parse(r);return m&&typeof m=="object"&&!m.currentPlanId&&(m.currentPlanId=t),m}catch(n){return console.error("[CommonApiService] Failed to get plan details:",n),{currentPlanId:t,status:"failed",message:n instanceof Error?n.message:"Failed to save, please retry"}}}static async submitFormInput(t,n){const r=await fetch(`${this.BASE_URL}/submit-input/${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!r.ok){let $;try{$=await r.json()}catch{$={message:`Failed to submit form input: ${r.status}`}}throw new Error($.message||`Failed to submit form input: ${r.status}`)}const m=r.headers.get("content-type");return m&&m.indexOf("application/json")!==-1?await r.json():{success:!0}}static async getAllPrompts(){try{const t=await fetch(this.BASE_URL);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get Prompt list:",t),t}}static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}}he(qe,"BASE_URL","/api/executor");const Ee=class Ee{constructor(){he(this,"POLL_INTERVAL",5e3);he(this,"state",lt({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));he(this,"callbacks",{});he(this,"planExecutionCache",new Map);he(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(t){return this.planExecutionCache.get(t)}getCachedUIState(t){return this.uiStateCache.get(t)}setCachedUIState(t,n){this.uiStateCache.set(t,n),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${t}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(t){return this.planExecutionCache.has(t)}setCachedPlanRecord(t,n){this.planExecutionCache.set(t,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${t}`)}clearCachedPlanRecord(t){const n=this.planExecutionCache.delete(t);return n&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${t}`),n}clearAllCachedRecords(){const t=this.planExecutionCache.size,n=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${t}, UI States: ${n}`)}static getInstance(){return Ee.instance||(Ee.instance=new Ee),Ee.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(t){this.callbacks={...this.callbacks,...t},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(t))}async handleUserMessageSendRequested(t){if(this.validateAndPrepareUIForNewRequest(t))try{if(await this.sendUserMessageAndSetPlanId(t),this.state.activePlanId)this.initiatePlanExecutionSequence(t,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(n){console.error("[PlanExecutionManager] Failed to send user message:",n);const r=this.state.activePlanId??"error";this.setCachedUIState(r,{enabled:!0}),this.emitChatInputUpdateState(r),this.state.activePlanId=null}}handlePlanExecutionRequested(t,n){console.log("[PlanExecutionManager] Received plan execution request:",{planId:t,query:n}),t?(this.state.activePlanId=t,this.initiatePlanExecutionSequence(n??"Execute Plan",t)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(t,n){const r=this.getCachedPlanRecord(t);return r!=null&&r.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${t}`),this.handlePlanExecutionRequested(r.currentPlanId,n),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${t}`),!1)}validateAndPrepareUIForNewRequest(t){if(!t)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const n=this.state.activePlanId??"ui-state";return this.setCachedUIState(n,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(n),!0}async sendUserMessageAndSetPlanId(t){try{const n=await Be.sendMessage(t);if(n!=null&&n.planId)return this.state.activePlanId=n.planId,n;if(n!=null&&n.planTemplateId)return this.state.activePlanId=n.planTemplateId,{...n,planId:n.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",n),new Error("Failed to get valid planId from API response")}catch(n){throw console.error("[PlanExecutionManager] API call failed:",n),n}}initiatePlanExecutionSequence(t,n){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${t}", planId: ${n}`);const r=n;this.emitDialogRoundStart(r),this.startPolling()}handlePlanCompletion(t){this.emitPlanCompleted(t.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await Fe.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}},5e3)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}t.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(t.rootPlanId??""))}handlePlanError(t){this.emitPlanError(t.message??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await Fe.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}},5e3)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const t=await this.getPlanDetails(this.state.activePlanId);if(!t){console.warn("[PlanExecutionManager] No details received from API");return}if(t.status&&t.status==="failed"){this.handlePlanError(t);return}if(t.rootPlanId&&this.setCachedPlanRecord(t.rootPlanId,t),!t.steps||t.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(t.rootPlanId??""),this.handlePlanCompletion(t);return}this.emitPlanUpdate(t.rootPlanId??""),t.completed&&this.handlePlanCompletion(t)}catch(t){console.error("[PlanExecutionManager] Failed to poll plan status:",t)}finally{this.state.isPolling=!1}}}async getPlanDetails(t){try{const n=await qe.getDetails(t);return n!=null&&n.rootPlanId&&(this.planExecutionCache.set(n.rootPlanId,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${n.rootPlanId}`)),n}catch(n){return console.error("[PlanExecutionManager] Failed to get plan details:",n),{currentPlanId:t,status:"failed",message:n instanceof Error?n.message:"Failed to get plan"}}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(t){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(t)}emitDialogRoundStart(t){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(t)}emitPlanUpdate(t){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(t)}emitPlanCompleted(t){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(t)}emitPlanError(t){this.callbacks.onPlanError&&this.callbacks.onPlanError(t)}};he(Ee,"instance",null);let Le=Ee;const le=Le.getInstance();class we{static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}static async getFileTree(t){try{const n=await fetch(`${this.BASE_URL}/tree/${t}`),m=await(await this.handleResponse(n)).json();if(!m.success)throw new Error(m.message||"Failed to get file tree");return m.data}catch(n){throw console.error("Failed to get file tree:",n),n}}static async getFileContent(t,n){try{const r=await fetch(`${this.BASE_URL}/content/${t}?path=${encodeURIComponent(n)}`),$=await(await this.handleResponse(r)).json();if(!$.success)throw new Error($.message||"Failed to get file content");return $.data}catch(r){throw console.error("Failed to get file content:",r),r}}static async downloadFile(t,n,r){try{const m=await fetch(`${this.BASE_URL}/download/${t}?path=${encodeURIComponent(n)}`);await this.handleResponse(m);const $=await m.blob(),u=window.URL.createObjectURL($),E=document.createElement("a");E.href=u,E.download=r||n.split("/").pop()||"download",document.body.appendChild(E),E.click(),window.URL.revokeObjectURL(u),document.body.removeChild(E)}catch(m){throw console.error("Failed to download file:",m),m}}static isTextFile(t,n){const r=["text/","application/json","application/xml","application/javascript","application/typescript"],m=[".txt",".md",".json",".xml",".html",".css",".js",".ts",".vue",".jsx",".tsx",".py",".java",".cpp",".c",".h",".sh",".bat",".yml",".yaml",".properties",".conf",".cfg"];if(r.some(u=>t.startsWith(u)))return!0;const $=n.toLowerCase();return m.some(u=>$.endsWith(u))}static getFileIcon(t){if(t.type==="directory")return"carbon:folder";const n=t.name.toLowerCase();return n.endsWith(".js")?"vscode-icons:file-type-js":n.endsWith(".ts")?"vscode-icons:file-type-typescript":n.endsWith(".vue")?"vscode-icons:file-type-vue":n.endsWith(".java")?"vscode-icons:file-type-java":n.endsWith(".py")?"vscode-icons:file-type-python":n.endsWith(".json")?"vscode-icons:file-type-json":n.endsWith(".xml")?"vscode-icons:file-type-xml":n.endsWith(".html")?"vscode-icons:file-type-html":n.endsWith(".css")?"vscode-icons:file-type-css":n.endsWith(".md")?"vscode-icons:file-type-markdown":n.endsWith(".yml")||n.endsWith(".yaml")?"vscode-icons:file-type-yaml":n.endsWith(".pdf")?"vscode-icons:file-type-pdf2":n.endsWith(".doc")||n.endsWith(".docx")?"vscode-icons:file-type-word":n.endsWith(".xls")||n.endsWith(".xlsx")?"vscode-icons:file-type-excel":n.endsWith(".ppt")||n.endsWith(".pptx")?"vscode-icons:file-type-powerpoint":n.match(/\.(jpg|jpeg|png|gif|bmp|svg)$/)?"carbon:image":n.match(/\.(zip|rar|7z|tar|gz)$/)?"carbon:archive":"carbon:document"}}he(we,"BASE_URL","/api/file-browser");const $n={class:"file-tree-node"},_n={class:"node-icon"},yn={class:"node-name"},Pn={key:1,class:"file-size"},Cn={key:2,class:"node-actions"},Sn={key:0,class:"children"},wn=_e({__name:"FileTreeNode",props:{node:{},level:{}},emits:["file-selected","download-file"],setup(T,{emit:t}){const n=T,r=t,m=I(n.level===0),$=I(!1),u=I(!1),E=I({}),U=()=>{n.node.type==="directory"&&(m.value=!m.value)},S=()=>{n.node.type==="directory"?U():M()},M=()=>{n.node.type==="file"&&r("file-selected",n.node),o()},O=()=>{r("download-file",n.node),o()},z=w=>{w.preventDefault(),u.value=!0,E.value={position:"fixed",top:`${w.clientY}px`,left:`${w.clientX}px`,zIndex:1e3},setTimeout(()=>{document.addEventListener("click",o)},0)},o=()=>{u.value=!1,document.removeEventListener("click",o)},b=async()=>{try{await navigator.clipboard.writeText(n.node.path)}catch(w){console.error("Failed to copy path:",w)}o()},C=()=>n.node.type==="directory"?m.value?"carbon:folder-open":"carbon:folder":we.getFileIcon(n.node),H=w=>{if(w===0)return"0 B";const x=1024,q=["B","KB","MB","GB"],J=Math.floor(Math.log(w)/Math.log(x));return parseFloat((w/Math.pow(x,J)).toFixed(1))+" "+q[J]};return Ce(()=>{document.removeEventListener("click",o)}),(w,x)=>{const q=ut("FileTreeNode",!0);return p(),v("div",$n,[e("div",{class:te(["node-content",{"is-directory":w.node.type==="directory","is-file":w.node.type==="file","is-expanded":m.value}]),style:Me({paddingLeft:`${w.level*16+12}px`}),onClick:S,onContextmenu:oe(z,["prevent"])},[w.node.type==="directory"?(p(),v("div",{key:0,class:"expand-icon",onClick:oe(U,["stop"])},[g(s(k),{icon:m.value?"carbon:chevron-down":"carbon:chevron-right",class:"chevron-icon"},null,8,["icon"])])):N("",!0),e("div",_n,[g(s(k),{icon:C()},null,8,["icon"])]),e("span",yn,a(w.node.name),1),w.node.type==="file"?(p(),v("span",Pn,a(H(w.node.size)),1)):N("",!0),$.value?(p(),v("div",Cn,[w.node.type==="file"?(p(),v("button",{key:0,onClick:x[0]||(x[0]=oe(J=>w.$emit("download-file",w.node),["stop"])),class:"action-btn download-btn",title:"Download"},[g(s(k),{icon:"carbon:download"})])):N("",!0)])):N("",!0)],38),w.node.type==="directory"&&m.value&&w.node.children?(p(),v("div",Sn,[(p(!0),v(ve,null,fe(w.node.children,J=>(p(),ie(q,{key:J.path,node:J,level:w.level+1,onFileSelected:x[1]||(x[1]=A=>w.$emit("file-selected",A)),onDownloadFile:x[2]||(x[2]=A=>w.$emit("download-file",A))},null,8,["node","level"]))),128))])):N("",!0),u.value?(p(),v("div",{key:1,class:"context-menu",style:Me(E.value),onClick:x[3]||(x[3]=oe(()=>{},["stop"]))},[e("div",{class:"context-menu-item",onClick:M},[g(s(k),{icon:"carbon:view"}),x[4]||(x[4]=e("span",null,"Open",-1))]),w.node.type==="file"?(p(),v("div",{key:0,class:"context-menu-item",onClick:O},[g(s(k),{icon:"carbon:download"}),x[5]||(x[5]=e("span",null,"Download",-1))])):N("",!0),x[7]||(x[7]=e("div",{class:"context-menu-divider"},null,-1)),e("div",{class:"context-menu-item",onClick:b},[g(s(k),{icon:"carbon:copy"}),x[6]||(x[6]=e("span",null,"Copy Path",-1))])],4)):N("",!0)])}}}),En=ye(wn,[["__scopeId","data-v-e4a376d5"]]),Tn={class:"file-browser"},In={class:"file-browser-header"},xn={class:"header-actions"},Dn=["disabled","title"],Rn={class:"file-browser-content"},An={class:"file-tree-panel"},Mn={key:0,class:"loading-state"},Fn={key:1,class:"error-state"},Nn={key:0,class:"waiting-for-files"},Un={class:"message-content"},Ln={class:"tips"},Bn=["disabled"],qn={key:1,class:"actual-error"},Vn={key:2,class:"empty-state"},Wn={key:3,class:"file-tree"},jn={key:0,class:"file-content-panel"},On={class:"file-content-header"},zn={class:"file-info"},Hn={class:"file-name"},Jn={class:"file-size"},Gn={class:"file-actions"},Kn=["title"],Xn=["title"],Qn={class:"file-content-body"},Yn={key:0,class:"loading-content"},Zn={key:1,class:"content-error"},es={key:2,class:"file-content"},ts={key:0,class:"text-content"},ns={key:1,class:"binary-content"},ss=_e({__name:"index",props:{planId:{}},setup(T){const t=T,{t:n}=Te(),r=I(!1),m=I(null),$=I(null),u=I(null),E=I(null),U=I(!1),S=I(null),M=I(null),O=pe(()=>!E.value||!u.value?!1:we.isTextFile(E.value.mimeType,u.value.name)),z=pe(()=>m.value&&(m.value.includes("Plan directory not found")||m.value.includes("not found"))),o=()=>{M.value&&(clearTimeout(M.value),M.value=null)},b=()=>{o(),M.value=window.setTimeout(()=>{z.value&&C()},5e3)},C=async()=>{if(t.planId){r.value=!0,m.value=null,o();try{$.value=await we.getFileTree(t.planId)}catch(A){m.value=A instanceof Error?A.message:n("fileBrowser.loadError"),console.error("Failed to load file tree:",A);const Y=A instanceof Error?A.message:"";(Y.includes("Plan directory not found")||Y.includes("not found"))&&b()}finally{r.value=!1}}},H=async A=>{if(A.type!=="directory"){u.value=A,E.value=null,U.value=!0,S.value=null;try{E.value=await we.getFileContent(t.planId,A.path)}catch(Y){S.value=Y instanceof Error?Y.message:n("fileBrowser.contentLoadError"),console.error("Failed to load file content:",Y)}finally{U.value=!1}}},w=async A=>{try{await we.downloadFile(t.planId,A.path,A.name)}catch(Y){console.error("Failed to download file:",Y)}},x=()=>{u.value=null,E.value=null,S.value=null},q=A=>we.getFileIcon(A),J=A=>{if(A===0)return"0 B";const Y=1024,ne=["B","KB","MB","GB"],se=Math.floor(Math.log(A)/Math.log(Y));return parseFloat((A/Math.pow(Y,se)).toFixed(1))+" "+ne[se]};return be(()=>t.planId,A=>{A&&(u.value=null,E.value=null,C())},{immediate:!0}),Pe(()=>{t.planId&&C()}),Ce(()=>{o()}),(A,Y)=>(p(),v("div",Tn,[e("div",In,[e("h3",null,a(A.$t("fileBrowser.title")),1),e("div",xn,[e("button",{class:"refresh-btn",onClick:C,disabled:r.value,title:A.$t("fileBrowser.refresh")},[g(s(k),{icon:"carbon:refresh",class:te({rotating:r.value}),style:{color:"#ffffff",fontSize:"18px",width:"18px",height:"18px"}},null,8,["class"])],8,Dn)])]),e("div",Rn,[e("div",An,[r.value?(p(),v("div",Mn,[g(s(k),{icon:"carbon:loading",class:"rotating"}),e("span",null,a(A.$t("fileBrowser.loading")),1)])):m.value?(p(),v("div",Fn,[z.value?(p(),v("div",Nn,[g(s(k),{icon:"carbon:time",class:"rotating"}),e("div",Un,[e("h3",null,a(A.$t("fileBrowser.waitingForGeneration")),1),e("p",null,a(A.$t("fileBrowser.planExecuting")),1),e("div",Ln,[g(s(k),{icon:"carbon:information"}),e("span",null,a(A.$t("fileBrowser.filesTip")),1)])]),e("button",{onClick:C,class:"retry-btn",disabled:r.value},[g(s(k),{icon:"carbon:refresh",class:te({rotating:r.value})},null,8,["class"]),Z(" "+a(r.value?A.$t("fileBrowser.checking"):A.$t("fileBrowser.checkNow")),1)],8,Bn)])):(p(),v("div",qn,[g(s(k),{icon:"carbon:warning"}),e("span",null,a(m.value),1),e("button",{onClick:C,class:"retry-btn"},a(A.$t("fileBrowser.retry")),1)]))])):$.value?(p(),v("div",Wn,[g(En,{node:$.value,level:0,onFileSelected:H,onDownloadFile:w},null,8,["node"])])):(p(),v("div",Vn,[g(s(k),{icon:"carbon:folder-off"}),e("span",null,a(A.$t("fileBrowser.noFiles")),1)]))]),u.value?(p(),v("div",jn,[e("div",On,[e("div",zn,[g(s(k),{icon:q(u.value)},null,8,["icon"]),e("span",Hn,a(u.value.name),1),e("span",Jn,"("+a(J(u.value.size))+")",1)]),e("div",Gn,[e("button",{onClick:Y[0]||(Y[0]=ne=>w(u.value)),class:"download-btn",title:A.$t("fileBrowser.download")},[g(s(k),{icon:"carbon:download"})],8,Kn),e("button",{onClick:x,class:"close-btn",title:A.$t("common.close")},[g(s(k),{icon:"carbon:close"})],8,Xn)])]),e("div",Qn,[U.value?(p(),v("div",Yn,[g(s(k),{icon:"carbon:loading",class:"rotating"}),e("span",null,a(A.$t("fileBrowser.loadingContent")),1)])):S.value?(p(),v("div",Zn,[g(s(k),{icon:"carbon:warning"}),e("span",null,a(S.value),1)])):E.value?(p(),v("div",es,[O.value?(p(),v("div",ts,[e("pre",null,[e("code",null,a(E.value.content),1)])])):(p(),v("div",ns,[g(s(k),{icon:"carbon:document-unknown"}),e("p",null,a(A.$t("fileBrowser.binaryFile")),1),e("button",{onClick:Y[1]||(Y[1]=ne=>w(u.value)),class:"download-btn-large"},[g(s(k),{icon:"carbon:download"}),Z(" "+a(A.$t("fileBrowser.downloadToView")),1)])]))])):N("",!0)])])):N("",!0)])]))}}),os=ye(ss,[["__scopeId","data-v-e7c74fe4"]]),as={class:"right-panel"},ls={class:"preview-header"},is={class:"preview-tabs"},cs={class:"preview-content"},rs={key:0,class:"step-details"},ds={key:0,class:"step-info-fixed"},us={key:0,class:"agent-info"},ps={class:"info-item"},hs={class:"label"},vs={class:"value"},gs={class:"info-item"},ms={class:"label"},fs={class:"value"},bs={class:"info-item"},ks={class:"label"},$s={class:"value"},_s={class:"info-item"},ys={class:"label"},Ps={class:"value"},Cs={class:"info-item"},Ss={class:"label"},ws={class:"execution-status"},Es={class:"status-item"},Ts={class:"status-text"},Is={key:0},xs={key:0,class:"think-act-steps"},Ds={class:"steps-container"},Rs={class:"step-header"},As={class:"step-number"},Ms={class:"think-section"},Fs={class:"think-content"},Ns={class:"input"},Us={class:"label"},Ls={class:"output"},Bs={class:"label"},qs={key:0,class:"action-section"},Vs={class:"action-content"},Ws={class:"tool-info"},js={class:"label"},Os={class:"value"},zs={class:"input"},Hs={class:"label"},Js={class:"output"},Gs={class:"label"},Ks={key:0,class:"sub-plan-section"},Xs={class:"sub-plan-content"},Qs={class:"sub-plan-header"},Ys={class:"sub-plan-info"},Zs={class:"label"},eo={class:"value"},to={key:0,class:"sub-plan-info"},no={class:"label"},so={class:"value"},oo={class:"sub-plan-status"},ao={class:"status-text"},lo={key:0,class:"no-steps-message"},io={key:1,class:"no-execution-message"},co={class:"step-basic-info"},ro={class:"info-item"},uo={class:"label"},po={class:"value"},ho={key:0,class:"info-item"},vo={class:"label"},go={class:"value"},mo={class:"info-item"},fo={class:"label"},bo={class:"no-execution-hint"},ko={key:2,class:"execution-indicator"},$o={class:"execution-text"},_o={key:1,class:"no-selection"},yo=["title"],Po={key:1,class:"file-browser-container"},Co={key:1,class:"no-plan-message"},So={class:"message-content"},wo={class:"tips"},Eo=_e({__name:"index",props:{currentRootPlanId:{}},setup(T,{expose:t}){const n=T,{t:r}=Te(),m=I(),$=I(),u=I(),E=I("details"),U=I(localStorage.getItem("jmanus-last-plan-id")),S=I(localStorage.getItem("jmanus-has-executed-plan")==="true"),M=I(null),O=I(!1),z=I(!0),o=I(!0),b=pe(()=>u.value?u.value.completed?r("rightPanel.status.completed"):u.value.current?r("rightPanel.status.executing"):r("rightPanel.status.waiting"):""),C=pe(()=>n.currentRootPlanId?n.currentRootPlanId:U.value),H=pe(()=>!C.value&&!S.value),w=_=>{var W;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${_}`),u.value&&M.value){const V=M.value.rootPlanId??$.value;if(V&&V!==_){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${V}, Requested: ${_}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${_}`);const R=le.getCachedPlanRecord(_);if(!R){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${_}`);return}if(R.steps&&R.steps.length>0){const V=R.steps.length,D=(R.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${D} / ${V}`)}if(u.value&&$.value&&($.value===_||((W=M.value)==null?void 0:W.rootPlanId)===_)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${_}`),M.value)){const D=M.value,h=q(D.planId,D.rootPlanId,D.subPlanId);h?(J(h,D.stepIndex,D.planId,D.isSubPlan),ke()):console.warn("[RightPanel] Could not find plan record for refresh:",D)}},x=(_,R,W,V,D)=>{console.log("[RightPanel] Step selected:",{planId:_,stepIndex:R,rootPlanId:W,subPlanId:V,subStepIndex:D});const h=!!(W&&V&&D!==void 0);M.value={planId:_,stepIndex:R,isSubPlan:h,...h&&{rootPlanId:W,subPlanId:V,subStepIndex:D}};const c=q(_,W,V);if(!c){console.warn("[RightPanel] Plan data not found:",{planId:_,rootPlanId:W,subPlanId:V}),u.value=null,M.value=null;return}J(c,R,_,h)},q=(_,R,W)=>{var h;if(!R||!W)return le.getCachedPlanRecord(_)??null;const V=le.getCachedPlanRecord(_);if(V)return V;const D=le.getCachedPlanRecord(R);if(!(D!=null&&D.agentExecutionSequence))return null;for(const c of D.agentExecutionSequence)if(c.thinkActSteps){for(const y of c.thinkActSteps)if(((h=y.subPlanExecutionRecord)==null?void 0:h.currentPlanId)===W)return y.subPlanExecutionRecord}return null},J=(_,R,W,V)=>{var l,i,d,f,j;if(!_.steps||R>=_.steps.length){u.value=null,M.value=null,console.warn("[RightPanel] Invalid step data:",{planId:W,stepIndex:R,hasSteps:!!_.steps,stepsLength:(l=_.steps)==null?void 0:l.length,message:"Invalid step index"});return}$.value=W;const D=_.steps[R],h=(i=_.agentExecutionSequence)==null?void 0:i[R];console.log("[RightPanel] Step data details:",{planId:W,stepIndex:R,step:D,hasAgentExecutionSequence:!!_.agentExecutionSequence,agentExecutionSequenceLength:(d=_.agentExecutionSequence)==null?void 0:d.length,agentExecution:h,hasThinkActSteps:!!(h!=null&&h.thinkActSteps),thinkActStepsLength:(f=h==null?void 0:h.thinkActSteps)==null?void 0:f.length,isSubPlan:V});const c=(h==null?void 0:h.status)==="FINISHED",y=!c&&R===_.currentStepIndex&&!_.completed,F={planId:W,index:R,title:typeof D=="string"?D:D.title||D.description||D.name||`${V?"Sub ":""}Step ${R+1}`,description:typeof D=="string"?D:D.description||D,completed:c,current:y};h&&(F.agentExecution=h),u.value=F,console.log("[RightPanel] Step details updated:",{planId:W,stepIndex:R,stepTitle:u.value.title,hasAgentExecution:!!h,hasThinkActSteps:(((j=h==null?void 0:h.thinkActSteps)==null?void 0:j.length)??0)>0,completed:c,current:y,planCurrentStep:_.currentStepIndex,planCompleted:_.completed,isSubPlan:V}),h!=null&&h.thinkActSteps&&h.thinkActSteps.forEach((L,ee)=>{L.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${ee}:`,L.subPlanExecutionRecord)}),setTimeout(()=>{ne()},100),ke()},A=(_,R,W,V)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:_,subPlanId:R,stepIndex:W,subStepIndex:V}),x(R,V,_,R,V)},Y=_=>{m.value=_??void 0},ne=()=>{if(!m.value)return;const{scrollTop:_,scrollHeight:R,clientHeight:W}=m.value,V=R-_-W<50,D=R>W;z.value=V,O.value=D&&!V,V?o.value=!0:R-_-W>100&&(o.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:_,scrollHeight:R,clientHeight:W,isAtBottom:V,hasScrollableContent:D,showButton:O.value,shouldAutoScroll:o.value})},se=()=>{m.value&&(m.value.scrollTo({top:m.value.scrollHeight,behavior:"smooth"}),ae(()=>{o.value=!0,ne()}))},ke=()=>{!o.value||!m.value||ae(()=>{m.value&&(m.value.scrollTop=m.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},ce=_=>{if(_===null||typeof _>"u"||_==="")return"N/A";try{const R=typeof _=="object"?_:JSON.parse(_);return JSON.stringify(R,null,2)}catch{return String(_)}},re=()=>{u.value=null,$.value=void 0,o.value=!0,m.value&&m.value.removeEventListener("scroll",ne)},Se=()=>{const _=()=>{const R=m.value;return R?(Y(R),R.addEventListener("scroll",ne),o.value=!0,ne(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};ae(()=>{_()||setTimeout(()=>{_()},100)})};return be(()=>n.currentRootPlanId,(_,R)=>{_&&_!==R?(U.value=_,S.value=!0,localStorage.setItem("jmanus-last-plan-id",_),localStorage.setItem("jmanus-has-executed-plan","true"),console.log("[RightPanel] New plan started:",_)):!_&&R&&console.log("[RightPanel] Plan execution finished, keeping last plan:",U.value)},{immediate:!0}),Pe(()=>{console.log("[RightPanel] Component mounted"),ae(()=>{Se()})}),Ce(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),M.value=null,re()}),t({updateDisplayedPlanProgress:w,handleStepSelected:x,handleSubPlanStepSelected:A}),(_,R)=>{var W,V;return p(),v("div",as,[e("div",ls,[e("div",is,[e("div",{class:te(["tab-item",{active:E.value==="details"}]),onClick:R[0]||(R[0]=D=>E.value="details")},[g(s(k),{icon:"carbon:events"}),e("span",null,a(s(r)("rightPanel.stepExecutionDetails")),1)],2),e("div",{class:te(["tab-item",{active:E.value==="files"}]),onClick:R[1]||(R[1]=D=>E.value="files")},[g(s(k),{icon:"carbon:folder"}),e("span",null,a(s(r)("fileBrowser.title")),1)],2)])]),e("div",cs,[E.value==="details"?(p(),v("div",rs,[u.value?(p(),v("div",ds,[e("h3",null,a(u.value.title||u.value.description||s(r)("rightPanel.defaultStepTitle",{number:u.value.index+1})),1),u.value.agentExecution?(p(),v("div",us,[e("div",ps,[e("span",hs,a(s(r)("rightPanel.executingAgent"))+":",1),e("span",vs,a(u.value.agentExecution.agentName),1)]),e("div",gs,[e("span",ms,a(s(r)("rightPanel.description"))+":",1),e("span",fs,a(u.value.agentExecution.agentDescription||""),1)]),e("div",bs,[e("span",ks,a(s(r)("rightPanel.callingModel"))+":",1),e("span",$s,a(u.value.agentExecution.modelName),1)]),e("div",_s,[e("span",ys,a(s(r)("rightPanel.request"))+":",1),e("span",Ps,a(u.value.agentExecution.agentRequest||""),1)]),e("div",Cs,[e("span",Ss,a(s(r)("rightPanel.executionResult"))+":",1),e("span",{class:te(["value",{success:u.value.agentExecution.status==="FINISHED"}])},a(u.value.agentExecution.status||s(r)("rightPanel.executing")),3)])])):N("",!0),e("div",ws,[e("div",Es,[u.value.completed?(p(),ie(s(k),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):u.value.current?(p(),ie(s(k),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(p(),ie(s(k),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",Ts,a(b.value),1)])])])):N("",!0),e("div",{ref_key:"scrollContainer",ref:m,class:"step-details-scroll-container",onScroll:ne},[u.value?(p(),v("div",Is,[(W=u.value.agentExecution)!=null&&W.thinkActSteps&&u.value.agentExecution.thinkActSteps.length>0?(p(),v("div",xs,[e("h4",null,a(s(r)("rightPanel.thinkAndActionSteps")),1),e("div",Ds,[(p(!0),v(ve,null,fe(u.value.agentExecution.thinkActSteps,(D,h)=>(p(),v("div",{key:h,class:"think-act-step"},[e("div",Rs,[e("span",As,"#"+a(h+1),1),e("span",{class:te(["step-status",D.status])},a(D.status||s(r)("rightPanel.executing")),3)]),e("div",Ms,[e("h5",null,[g(s(k),{icon:"carbon:thinking"}),Z(" "+a(s(r)("rightPanel.thinking")),1)]),e("div",Fs,[e("div",Ns,[e("span",Us,a(s(r)("rightPanel.input"))+":",1),e("pre",null,a(ce(D.thinkInput)),1)]),e("div",Ls,[e("span",Bs,a(s(r)("rightPanel.output"))+":",1),e("pre",null,a(ce(D.thinkOutput)),1)])])]),D.actionNeeded?(p(),v("div",qs,[e("h5",null,[g(s(k),{icon:"carbon:play"}),Z(" "+a(s(r)("rightPanel.action")),1)]),e("div",Vs,[(p(!0),v(ve,null,fe(D.actToolInfoList,(c,y)=>(p(),v("div",{key:y},[e("div",Ws,[e("span",js,a(s(r)("rightPanel.tool"))+":",1),e("span",Os,a(c.name||""),1)]),e("div",zs,[e("span",Hs,a(s(r)("rightPanel.toolParameters"))+":",1),e("pre",null,a(ce(c.parameters)),1)]),e("div",Js,[e("span",Gs,a(s(r)("rightPanel.executionResult"))+":",1),e("pre",null,a(ce(c.result)),1)])]))),128))]),D.subPlanExecutionRecord?(p(),v("div",Ks,[e("h5",null,[g(s(k),{icon:"carbon:tree-view"}),Z(" "+a(s(r)("rightPanel.subPlan")),1)]),e("div",Xs,[e("div",Qs,[e("div",Ys,[e("span",Zs,a(_.$t("rightPanel.subPlanId"))+":",1),e("span",eo,a(D.subPlanExecutionRecord.currentPlanId),1)]),D.subPlanExecutionRecord.title?(p(),v("div",to,[e("span",no,a(_.$t("rightPanel.title"))+":",1),e("span",so,a(D.subPlanExecutionRecord.title),1)])):N("",!0),e("div",oo,[D.subPlanExecutionRecord.completed?(p(),ie(s(k),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(p(),ie(s(k),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",ao,a(D.subPlanExecutionRecord.completed?_.$t("rightPanel.status.completed"):_.$t("rightPanel.status.executing")),1)])])])])):N("",!0)])):N("",!0)]))),128))]),u.value.agentExecution&&!((V=u.value.agentExecution.thinkActSteps)!=null&&V.length)?(p(),v("div",lo,[e("p",null,a(s(r)("rightPanel.noStepDetails")),1)])):u.value.agentExecution?N("",!0):(p(),v("div",io,[g(s(k),{icon:"carbon:information",class:"info-icon"}),e("h4",null,a(s(r)("rightPanel.stepInfo")),1),e("div",co,[e("div",ro,[e("span",uo,a(s(r)("rightPanel.stepName"))+":",1),e("span",po,a(u.value.title||u.value.description||_.$t("rightPanel.stepNumber",{number:u.value.index+1})),1)]),u.value.description?(p(),v("div",ho,[e("span",vo,a(_.$t("rightPanel.description"))+":",1),e("span",go,a(u.value.description),1)])):N("",!0),e("div",mo,[e("span",fo,a(_.$t("rightPanel.status.label"))+":",1),e("span",{class:te(["value",{"status-completed":u.value.completed,"status-current":u.value.current,"status-pending":!u.value.completed&&!u.value.current}])},a(u.value.completed?_.$t("rightPanel.status.completed"):u.value.current?_.$t("rightPanel.status.executing"):_.$t("rightPanel.status.pending")),3)])]),e("p",bo,a(s(r)("rightPanel.noExecutionInfo")),1)])),u.value.current&&!u.value.completed?(p(),v("div",ko,[R[2]||(R[2]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",$o,[g(s(k),{icon:"carbon:in-progress",class:"rotating-icon"}),Z(" "+a(s(r)("rightPanel.stepExecuting")),1)])])):N("",!0)])):(p(),v("div",_o,[g(s(k),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,a(s(r)("rightPanel.noStepSelected")),1),e("p",null,a(s(r)("rightPanel.selectStepHint")),1)]))])):N("",!0),g(Re,{name:"scroll-button"},{default:Ae(()=>[O.value?(p(),v("button",{key:0,onClick:se,class:"scroll-to-bottom-btn",title:s(r)("rightPanel.scrollToBottom")},[g(s(k),{icon:"carbon:chevron-down"})],8,yo)):N("",!0)]),_:1})],544)])):N("",!0),E.value==="files"?(p(),v("div",Po,[C.value?(p(),ie(os,{key:0,"plan-id":C.value},null,8,["plan-id"])):H.value?(p(),v("div",Co,[g(s(k),{icon:"carbon:folder-off"}),e("div",So,[e("h3",null,a(s(r)("fileBrowser.noFilesYet")),1),e("p",null,a(s(r)("fileBrowser.noPlanExecuting")),1),e("div",wo,[g(s(k),{icon:"carbon:information"}),e("span",null,a(s(r)("fileBrowser.startTaskTip")),1)])])])):N("",!0)])):N("",!0)])])}}}),To=ye(Eo,[["__scopeId","data-v-d7e4058f"]]);function Io(){const T=le,t=pe(()=>T.getActivePlanId()),n=pe(()=>T.getState()),r=pe(()=>n.value.isPolling),m=pe(()=>!!t.value),$=(S,M)=>{T.initiatePlanExecutionSequence(S,M)},u=()=>{T.stopPolling()},E=()=>{T.startPolling()},U=()=>{T.cleanup()};return Ce(()=>{U()}),{activePlanId:t,state:n,isPolling:r,hasActivePlan:m,startExecution:$,stopPolling:u,startPolling:E,cleanup:U}}const xo={class:"chat-container"},Do={class:"message-content"},Ro={key:0,class:"user-message"},Ao={key:1,class:"assistant-message"},Mo={key:0,class:"thinking-section"},Fo={class:"thinking-header"},No={class:"thinking-avatar"},Uo={class:"thinking-label"},Lo={class:"thinking-content"},Bo={key:0,class:"thinking"},qo={key:1,class:"progress"},Vo={class:"progress-bar"},Wo={class:"progress-text"},jo={key:2,class:"steps-container"},Oo={class:"steps-title"},zo=["onClick"],Ho={class:"section-header"},Jo={class:"step-icon"},Go={class:"step-title"},Ko={key:0,class:"step-status current"},Xo={key:1,class:"step-status completed"},Qo={key:2,class:"step-status pending"},Yo={key:0,class:"action-info"},Zo={class:"action-description"},ea={class:"action-icon"},ta={key:0,class:"tool-params"},na={class:"param-label"},sa={class:"param-content"},oa={key:1,class:"think-details"},aa={class:"think-header"},la={class:"think-label"},ia={class:"think-output"},ca={class:"think-content"},ra={key:1,class:"sub-plan-steps"},da={class:"sub-plan-header"},ua={class:"sub-plan-title"},pa={class:"sub-plan-step-list"},ha=["onClick"],va={class:"sub-step-indicator"},ga={class:"sub-step-icon"},ma={class:"sub-step-number"},fa={class:"sub-step-content"},ba={class:"sub-step-title"},ka={class:"sub-step-badge"},$a={key:2,class:"user-input-form-container"},_a={class:"user-input-message"},ya={key:0,class:"form-description"},Pa=["onSubmit"],Ca=["for"],Sa=["id","name","onUpdate:modelValue"],wa={key:1,class:"form-group"},Ea={for:"form-input-genericInput"},Ta=["onUpdate:modelValue"],Ia={type:"submit",class:"submit-user-input-btn"},xa={key:3,class:"default-processing"},Da={class:"processing-indicator"},Ra={class:"response-section"},Aa={class:"response-header"},Ma={class:"response-avatar"},Fa={class:"response-name"},Na={class:"response-content"},Ua={key:0,class:"final-response"},La=["innerHTML"],Ba={key:1,class:"response-placeholder"},qa={class:"typing-indicator"},Va={class:"typing-text"},Wa={key:0,class:"message assistant"},ja={class:"message-content"},Oa={class:"assistant-message"},za={class:"thinking-section"},Ha={class:"thinking-header"},Ja={class:"thinking-avatar"},Ga={class:"thinking-label"},Ka={class:"thinking-content"},Xa={class:"default-processing"},Qa={class:"processing-indicator"},Ya={class:"response-section"},Za={class:"response-header"},el={class:"response-avatar"},tl={class:"response-name"},nl={class:"response-content"},sl={class:"response-placeholder"},ol={class:"typing-indicator"},al={class:"typing-text"},ll=["title"],il=_e({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(T,{expose:t,emit:n}){const r=T,m=n,{t:$}=Te(),u=Io(),E=I(),U=I(!1),S=I([]),M=I(),O=I(!1),z=lt({}),o=(l,i,d)=>{const f={id:Date.now().toString(),type:l,content:i,timestamp:new Date,...d};return l==="assistant"&&!f.thinking&&!f.content&&(f.thinking=$("chat.thinking")),S.value.push(f),f},b=l=>{const i=S.value[S.value.length-1];i.type==="assistant"&&Object.assign(i,l)},C=async l=>{try{U.value=!0;const i=o("assistant","",{thinking:$("chat.thinkingProcessing")}),d=await Be.sendMessage(l);if(d.planId)console.log("[ChatComponent] Received planId from direct execution:",d.planId),i.planExecution||(i.planExecution={}),i.planExecution.currentPlanId=d.planId,le.handlePlanExecutionRequested(d.planId,l),delete i.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete i.thinking;const f=H(d,l);i.content=f}}catch(i){console.error("Direct mode error:",i),b({content:w(i)})}finally{U.value=!1}},H=(l,i)=>l.result??l.message??l.content??"",w=l=>{const i=(l==null?void 0:l.message)??(l==null?void 0:l.toString())??$("chat.unknownError");return i.includes("network")||i.includes("timeout")?$("chat.networkError"):i.includes("auth")||i.includes("unauthorized")?$("chat.authError"):i.includes("invalid")||i.includes("format")||i.includes("parameter")?$("chat.formatError"):`${$("chat.unknownError")} (${i})`},x=(l=!1)=>{ae(()=>{if(E.value){const i=E.value;(l||i.scrollHeight-i.scrollTop-i.clientHeight<150)&&i.scrollTo({top:i.scrollHeight,behavior:l?"auto":"smooth"})}})},q=()=>{x(!0),O.value=!1},J=()=>{if(E.value){const l=E.value,i=l.scrollHeight-l.scrollTop-l.clientHeight<150;O.value=!i&&S.value.length>0}},A=()=>{E.value&&E.value.addEventListener("scroll",J)},Y=()=>{E.value&&E.value.removeEventListener("scroll",J)},ne=l=>{o("user",l),r.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",l):C(l)},se=(l,i)=>{var j;const d=((j=l.planExecution)==null?void 0:j.agentExecutionSequence)??[];return i<0||i>=d.length?"IDLE":d[i].status??"IDLE"},ke=(l,i)=>{var d,f;if(!((d=l.planExecution)!=null&&d.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:l.planExecution.currentPlanId,stepIndex:i,stepTitle:(f=l.planExecution.steps)==null?void 0:f[i]}),m("step-selected",l.planExecution.currentPlanId,i)},ce=(l,i)=>{var d;try{const f=(d=l.planExecution)==null?void 0:d.agentExecutionSequence;if(!(f!=null&&f.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const j=f[i];if(!j)return console.log(`[ChatComponent] No agentExecution found for step ${i}`),[];if(!j.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${i}`),[];for(const L of j.thinkActSteps)if(L.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${i}:`,L.subPlanExecutionRecord),(L.subPlanExecutionRecord.steps??[]).map(G=>typeof G=="string"?G:typeof G=="object"&&G!==null&&(G.title||G.description)||$("rightPanel.subStep"));return[]}catch(f){return console.warn("[ChatComponent] Error getting sub-plan steps:",f),[]}},re=(l,i,d)=>{var f;try{const j=(f=l.planExecution)==null?void 0:f.agentExecutionSequence;if(!(j!=null&&j.length))return"pending";const L=j[i];if(!L||!L.thinkActSteps)return"pending";let ee=null;for(const K of L.thinkActSteps)if(K.subPlanExecutionRecord){ee=K.subPlanExecutionRecord;break}if(!ee)return"pending";const G=ee.currentStepIndex;return ee.completed?"completed":G==null?d===0?"current":"pending":d<G?"completed":d===G?"current":"pending"}catch(j){return console.warn("[ChatComponent] Error getting sub-plan step status:",j),"pending"}},Se=(l,i,d)=>{var f,j;try{const L=(f=l.planExecution)==null?void 0:f.agentExecutionSequence;if(!(L!=null&&L.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const ee=L[i];if(!ee){console.warn("[ChatComponent] No agentExecution found for step",i);return}if(!ee.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",i);return}let G=null;for(const K of ee.thinkActSteps)if(K.subPlanExecutionRecord){G=K.subPlanExecutionRecord;break}if(!(G!=null&&G.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}m("sub-plan-step-selected",((j=l.planExecution)==null?void 0:j.currentPlanId)??"",G.currentPlanId,i,d)}catch(L){console.error("[ChatComponent] Error handling sub-plan step click:",L)}},_=(l,i)=>{var f,j,L,ee;if(!((f=l.planExecution)!=null&&f.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",l.planExecution.steps.length,"execution sequence:",((j=i.agentExecutionSequence)==null?void 0:j.length)??0);const d=new Array(l.planExecution.steps.length).fill(null);if((L=i.agentExecutionSequence)!=null&&L.length){const G=Math.min(i.agentExecutionSequence.length,l.planExecution.steps.length);for(let K=0;K<G;K++){const B=i.agentExecutionSequence[K];if((ee=B.thinkActSteps)!=null&&ee.length){const X=B.thinkActSteps[B.thinkActSteps.length-1];X.actionDescription&&X.toolParameters?(d[K]={actionDescription:X.actionDescription,toolParameters:typeof X.toolParameters=="string"?X.toolParameters:JSON.stringify(X.toolParameters,null,2),thinkInput:X.thinkInput??"",thinkOutput:X.thinkOutput??"",status:i.currentStepIndex!==void 0&&K<i.currentStepIndex?"completed":i.currentStepIndex!==void 0&&K===i.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${K} action set: ${d[K].actionDescription}`)):(d[K]={actionDescription:$("chat.thinking"),toolParameters:$("chat.waitingDecision"),thinkInput:X.thinkInput??"",thinkOutput:X.thinkOutput??"",status:i.currentStepIndex!==void 0&&K===i.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${K} is thinking`))}else d[K]={actionDescription:i.currentStepIndex!==void 0&&K<i.currentStepIndex?$("chat.status.completed"):$("chat.status.pending"),toolParameters:$("chat.noToolParameters"),thinkInput:"",thinkOutput:"",status:i.currentStepIndex!==void 0&&K<i.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] Step ${K} has no execution details, status set to: ${d[K].status}`)}}else console.log("[ChatComponent] No execution sequence data");l.stepActions=[...d],console.log("[ChatComponent] Step actions update completed:",JSON.stringify(d.map(G=>G==null?void 0:G.actionDescription))),ae(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},R=l=>{console.log("[ChatComponent] Starting dialog round with planId:",l),l&&(S.value.findIndex(d=>{var f;return((f=d.planExecution)==null?void 0:f.currentPlanId)===l&&d.type==="assistant"})===-1?(o("assistant","",{planExecution:{currentPlanId:l},thinking:$("chat.preparingExecution")}),console.log("[ChatComponent] Created new assistant message for planId:",l)):console.log("[ChatComponent] Found existing assistant message for planId:",l))},W=l=>{var L,ee,G,K;console.log("[ChatComponent] Processing plan update with rootPlanId:",l);const i=le.getCachedPlanRecord(l);if(!i){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",l);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",i),console.log("[ChatComponent] Plan steps:",i.steps),console.log("[ChatComponent] Plan completed:",i.completed),!i.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const d=S.value.findIndex(B=>{var X;return((X=B.planExecution)==null?void 0:X.currentPlanId)===i.currentPlanId&&B.type==="assistant"});let f;if(d!==-1)f=S.value[d],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",i.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",i.currentPlanId),console.log("[ChatComponent] Current messages:",S.value.map(X=>{var de;return{type:X.type,planId:(de=X.planExecution)==null?void 0:de.currentPlanId,content:X.content.substring(0,50)}}));let B=-1;for(let X=S.value.length-1;X>=0;X--)if(S.value[X].type==="assistant"){B=X;break}if(B!==-1)f=S.value[B],f.planExecution||(f.planExecution={}),f.planExecution.currentPlanId=i.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",i.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(f.planExecution||(f.planExecution={}),f.planExecution=JSON.parse(JSON.stringify(i)),!i.steps||i.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),i.completed){delete f.thinking;const B=i.summary??i.result??i.message??$("chat.executionCompleted");f.content=V(B),console.log("[ChatComponent] Set simple response content:",f.content)}else i.title&&(f.thinking=`${$("chat.thinkingExecuting",{title:i.title})}`);return}delete f.thinking;const j=i.steps.map(B=>typeof B=="string"?B:typeof B=="object"&&B!==null&&(B.title||B.description)||$("chat.step"));if(f.planExecution&&(f.planExecution.steps=j),i.agentExecutionSequence&&i.agentExecutionSequence.length>0){console.log("[ChatComponent] Found execution sequence data, count:",i.agentExecutionSequence.length),_(f,i);const B=i.currentStepIndex??0;if(B>=0&&B<i.agentExecutionSequence.length){const de=i.agentExecutionSequence[B].thinkActSteps;if(de&&de.length>0){const Ie=de[de.length-1];if(Ie.thinkOutput){const Ne=Ie.thinkOutput.length>150?Ie.thinkOutput.substring(0,150)+"...":Ie.thinkOutput;f.thinking=`${$("chat.thinking")}: ${Ne}`}}}}else if(f.planExecution){const B=f.planExecution.currentStepIndex??0,X=(L=f.planExecution.steps)==null?void 0:L[B],de=typeof X=="string"?X:"";f.thinking=`${$("chat.thinkingExecuting",{title:de})}`}if(i.userInputWaitState&&f.planExecution?(console.log("[ChatComponent] User input required:",i.userInputWaitState),f.planExecution.userInputWaitState||(f.planExecution.userInputWaitState={}),f.planExecution.userInputWaitState={message:i.userInputWaitState.message??"",formDescription:i.userInputWaitState.formDescription??"",formInputs:((ee=i.userInputWaitState.formInputs)==null?void 0:ee.map(B=>({label:B.label,value:B.value||""})))??[]},z[G=f.id]??(z[G]={}),f.thinking=$("input.waiting")):(K=f.planExecution)!=null&&K.userInputWaitState&&delete f.planExecution.userInputWaitState,i.completed??i.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete f.thinking;let B="";i.summary?B=i.summary:i.result?B=i.result:B=$("chat.executionCompleted"),f.content=D(B),console.log("[ChatComponent] Updated completed message:",f.content)}ae(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},V=l=>l?l.includes("I ")||l.includes("you")||l.includes("hello")||l.includes("can")||l.includes("I")||l.includes("you")||l.includes("can")?l:l.length<10?`${l}! ${$("chat.anythingElse")}`:l.length<50?`${$("chat.okayDone",{text:l})}. ${$("chat.ifOtherQuestions")}`:`${l}

${$("chat.hopeHelpful")} ${$("chat.anythingElse")}`:$("chat.defaultResponse"),D=l=>l?`${l}`:`${$("chat.executionCompleted")}! ${$("chat.anythingElse")}`,h=l=>{console.log("[ChatComponent] Plan completed with rootPlanId:",l);const i=le.getCachedPlanRecord(l);if(!i){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",l);return}if(console.log("[ChatComponent] Plan details:",i),i.rootPlanId){const d=S.value.findIndex(f=>{var j;return((j=f.planExecution)==null?void 0:j.currentPlanId)===i.rootPlanId});if(d!==-1){const f=S.value[d];delete f.thinking;let L=i.summary??i.result??$("chat.executionCompleted");!L.includes("I")&&!L.includes("you")&&(L.includes("success")||L.includes("complete")||L.includes("finished")?L=`${$("chat.great")}${L}. ${$("chat.ifOtherHelp")}`:L=`${$("chat.completedRequest",{result:L})}`),f.content=L,console.log("[ChatComponent] Updated completed message:",f.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",i.rootPlanId)}},c=l=>{U.value=!1,S.value[S.value.length-1]={id:Date.now().toString(),type:"assistant",content:l,timestamp:new Date}},y=l=>{if(!l)return"";let i=l.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return i=i.replace(/(<br><br>)/g,"</p><p>"),i.includes("</p><p>")&&(i=`<p>${i}</p>`),i},F=async l=>{var i;if(!((i=l.planExecution)!=null&&i.currentPlanId)||!l.planExecution.userInputWaitState){console.error("[ChatComponent] Missing planExecution.currentPlanId or userInputWaitState");return}try{const d={},f=l.planExecution.userInputWaitState.formInputs;f&&f.length>0?Object.entries(z[l.id]).forEach(([L,ee])=>{var B;const G=parseInt(L,10),K=((B=f[G])==null?void 0:B.label)||`input_${L}`;d[K]=ee}):d.genericInput=l.genericInput??"",console.log("[ChatComponent] Submitting user input:",d);const j=await qe.submitFormInput(l.planExecution.currentPlanId,d);delete l.planExecution.userInputWaitState,delete l.genericInput,delete z[l.id],u.startPolling(),console.log("[ChatComponent] User input submitted successfully:",j)}catch(d){console.error("[ChatComponent] User input submission failed:",d),alert(`${$("common.submitFailed")}: ${(d==null?void 0:d.message)||$("common.unknownError")}`)}};return be(()=>r.initialPrompt,(l,i)=>{console.log("[ChatComponent] initialPrompt changed from:",i,"to:",l),l&&typeof l=="string"&&l.trim()&&l!==i&&(console.log("[ChatComponent] Processing changed initial prompt:",l),ae(()=>{ne(l)}))},{immediate:!1}),Pe(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),le.setEventCallbacks({onPlanUpdate:W,onPlanCompleted:h,onDialogRoundStart:R,onChatInputUpdateState:l=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",l)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")},onPlanError:c}),ae(()=>{A()}),r.initialPrompt&&typeof r.initialPrompt=="string"&&r.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",r.initialPrompt),ae(()=>{ne(r.initialPrompt)}))}),Ce(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),Y(),M.value&&clearInterval(M.value),u.cleanup(),Object.keys(z).forEach(l=>delete z[l])}),t({handleSendMessage:ne,handlePlanUpdate:W,handlePlanCompleted:h,handleDialogRoundStart:R,addMessage:o,handlePlanError:c}),(l,i)=>(p(),v("div",xo,[e("div",{class:"messages",ref_key:"messagesRef",ref:E},[(p(!0),v(ve,null,fe(S.value,d=>{var f,j,L,ee,G,K,B,X,de;return p(),v("div",{key:d.id,class:te(["message",{user:d.type==="user",assistant:d.type==="assistant"}])},[e("div",Do,[d.type==="user"?(p(),v("div",Ro,a(d.content),1)):(p(),v("div",Ao,[d.thinking||((f=d.planExecution)==null?void 0:f.progress)!==void 0||(((L=(j=d.planExecution)==null?void 0:j.steps)==null?void 0:L.length)??0)>0?(p(),v("div",Mo,[e("div",Fo,[e("div",No,[g(s(k),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Uo,a(l.$t("chat.thinkingLabel")),1)]),e("div",Lo,[d.thinking?(p(),v("div",Bo,[g(s(k),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,a(d.thinking),1)])):N("",!0),((ee=d.planExecution)==null?void 0:ee.progress)!==void 0?(p(),v("div",qo,[e("div",Vo,[e("div",{class:"progress-fill",style:Me({width:d.planExecution.progress+"%"})},null,4)]),e("span",Wo,a(d.planExecution.progressText??l.$t("chat.processing")+"..."),1)])):N("",!0),(((K=(G=d.planExecution)==null?void 0:G.steps)==null?void 0:K.length)??0)>0?(p(),v("div",jo,[e("h4",Oo,a(l.$t("chat.stepExecutionDetails")),1),(p(!0),v(ve,null,fe((B=d.planExecution)==null?void 0:B.steps,(Ie,Q)=>{var Ne,Ve,We,je,Oe,ze,He,Je,Ge,Ke,Xe,Qe,Ye,Ze,et,tt,nt,st,ot;return p(),v("div",{key:Q,class:te(["ai-section",{running:se(d,Q)==="RUNNING",completed:se(d,Q)==="FINISHED",pending:se(d,Q)==="IDLE"}]),onClick:oe(me=>ke(d,Q),["stop"])},[e("div",Ho,[e("span",Jo,a(se(d,Q)==="FINISHED"?"âœ“":se(d,Q)==="RUNNING"?"â–¶":"â—‹"),1),e("span",Go,a(Ie||`${l.$t("chat.step")} ${Q+1}`),1),se(d,Q)==="RUNNING"?(p(),v("span",Ko,a(l.$t("chat.status.executing")),1)):se(d,Q)==="FINISHED"?(p(),v("span",Xo,a(l.$t("chat.status.completed")),1)):(p(),v("span",Qo,a(l.$t("chat.status.pending")),1))]),d.stepActions&&d.stepActions[Q]?(p(),v("div",Yo,[e("div",Zo,[e("span",ea,a(((Ne=d.stepActions[Q])==null?void 0:Ne.status)==="current"?"ðŸ”„":((Ve=d.stepActions[Q])==null?void 0:Ve.status)==="completed"?"âœ“":"â³"),1),e("strong",null,a((We=d.stepActions[Q])==null?void 0:We.actionDescription),1)]),(je=d.stepActions[Q])!=null&&je.toolParameters?(p(),v("div",ta,[i[0]||(i[0]=e("span",{class:"tool-icon"},"âš™ï¸",-1)),e("span",na,a(l.$t("common.parameters"))+":",1),e("pre",sa,a((Oe=d.stepActions[Q])==null?void 0:Oe.toolParameters),1)])):N("",!0),(ze=d.stepActions[Q])!=null&&ze.thinkOutput?(p(),v("div",oa,[e("div",aa,[i[1]||(i[1]=e("span",{class:"think-icon"},"ðŸ’­",-1)),e("span",la,a(l.$t("chat.thinkingOutput"))+":",1)]),e("div",ia,[e("pre",ca,a((He=d.stepActions[Q])==null?void 0:He.thinkOutput),1)])])):N("",!0)])):N("",!0),((Je=ce(d,Q))==null?void 0:Je.length)>0?(p(),v("div",ra,[e("div",da,[g(s(k),{icon:"carbon:tree-view",class:"sub-plan-icon"}),e("span",ua,a(l.$t("rightPanel.subPlan")),1)]),e("div",pa,[(p(!0),v(ve,null,fe(ce(d,Q),(me,ue)=>(p(),v("div",{key:`sub-${Q}-${ue}`,class:te(["sub-plan-step-item",{completed:re(d,Q,ue)==="completed",current:re(d,Q,ue)==="current",pending:re(d,Q,ue)==="pending"}]),onClick:oe(at=>Se(d,Q,ue),["stop"])},[e("div",va,[e("span",ga,a(re(d,Q,ue)==="completed"?"âœ“":re(d,Q,ue)==="current"?"â–¶":"â—‹"),1),e("span",ma,a(ue+1),1)]),e("div",fa,[e("span",ba,a(me),1),e("span",ka,a(l.$t("rightPanel.subStep")),1)])],10,ha))),128))])])):N("",!0),(Ge=d.planExecution)!=null&&Ge.userInputWaitState&&se(d,Q)==="RUNNING"?(p(),v("div",$a,[e("p",_a,a(((Xe=(Ke=d.planExecution)==null?void 0:Ke.userInputWaitState)==null?void 0:Xe.message)??l.$t("chat.userInput.message")),1),(Ye=(Qe=d.planExecution)==null?void 0:Qe.userInputWaitState)!=null&&Ye.formDescription?(p(),v("p",ya,a((et=(Ze=d.planExecution)==null?void 0:Ze.userInputWaitState)==null?void 0:et.formDescription),1)):N("",!0),e("form",{onSubmit:oe(me=>F(d),["prevent"]),class:"user-input-form"},[(nt=(tt=d.planExecution)==null?void 0:tt.userInputWaitState)!=null&&nt.formInputs&&d.planExecution.userInputWaitState.formInputs.length>0?(p(!0),v(ve,{key:0},fe((ot=(st=d.planExecution)==null?void 0:st.userInputWaitState)==null?void 0:ot.formInputs,(me,ue)=>(p(),v("div",{key:ue,class:"form-group"},[e("label",{for:`form-input-${me.label.replace(/\W+/g,"_")}`},a(me.label)+": ",9,Ca),ge(e("input",{type:"text",id:`form-input-${me.label.replace(/\W+/g,"_")}`,name:me.label,"onUpdate:modelValue":at=>z[d.id][ue]=at,class:"form-input"},null,8,Sa),[[$e,z[d.id][ue]]])]))),128)):(p(),v("div",wa,[e("label",Ea,a(l.$t("common.input"))+":",1),ge(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":me=>d.genericInput=me,class:"form-input"},null,8,Ta),[[$e,d.genericInput]])])),e("button",Ia,a(l.$t("chat.userInput.submit")),1)],40,Pa)])):N("",!0)],10,zo)}),128))])):!d.content&&(d.thinking||((X=d.planExecution)==null?void 0:X.progress)!==void 0&&(((de=d.planExecution)==null?void 0:de.progress)??0)<100)?(p(),v("div",xa,[e("div",Da,[i[2]||(i[2]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,a(d.thinking??l.$t("chat.thinkingProcessing")),1)])])):N("",!0)])])):N("",!0),e("div",Ra,[e("div",Aa,[e("div",Ma,[g(s(k),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Fa,a(l.$t("chat.botName")),1)]),e("div",Na,[d.content?(p(),v("div",Ua,[e("div",{class:"response-text",innerHTML:y(d.content)},null,8,La)])):(p(),v("div",Ba,[e("div",qa,[i[3]||(i[3]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Va,a(l.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),U.value?(p(),v("div",Wa,[e("div",ja,[e("div",Oa,[e("div",za,[e("div",Ha,[e("div",Ja,[g(s(k),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Ga,a(l.$t("chat.thinkingLabel")),1)]),e("div",Ka,[e("div",Xa,[e("div",Qa,[i[4]||(i[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,a(l.$t("chat.thinking")),1)])])])]),e("div",Ya,[e("div",Za,[e("div",el,[g(s(k),{icon:"carbon:bot",class:"bot-icon"})]),e("div",tl,a(l.$t("chat.botName")),1)]),e("div",nl,[e("div",sl,[e("div",ol,[i[5]||(i[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",al,a(l.$t("chat.thinkingResponse")),1)])])])])])])])):N("",!0)],512),O.value?(p(),v("div",{key:0,class:"scroll-to-bottom-btn",onClick:q,title:l.$t("chat.scrollToBottom")},[g(s(k),{icon:"carbon:chevron-down"})],8,ll)):N("",!0)]))}}),cl=ye(il,[["__scopeId","data-v-99c33eb1"]]),rl={class:"input-area"},dl={class:"input-container"},ul=["title"],pl=["placeholder","disabled"],hl=["title"],vl=["disabled","title"],gl=_e({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1},initialValue:{default:""}},emits:["send","clear","update-state","plan-mode-clicked"],setup(T,{expose:t,emit:n}){const{t:r}=Te(),m=T,$=n,u=I(),E=I(""),U=pe(()=>m.placeholder||r("input.placeholder")),S=I(U.value),M=pe(()=>!!m.disabled),O=()=>{ae(()=>{u.value&&(u.value.style.height="auto",u.value.style.height=Math.min(u.value.scrollHeight,120)+"px")})},z=q=>{q.key==="Enter"&&!q.shiftKey&&(q.preventDefault(),o())},o=()=>{if(!E.value.trim()||M.value)return;const q=E.value.trim();$("send",q),C()},b=()=>{$("plan-mode-clicked")},C=()=>{E.value="",O(),$("clear")},H=(q,J)=>{J&&(S.value=q?J:r("input.waiting")),$("update-state",q,J)},w=q=>{E.value=q,O()},x=()=>E.value.trim();return be(()=>m.initialValue,q=>{q&&q.trim()&&(E.value=q,O())},{immediate:!0}),t({clearInput:C,updateState:H,setInputValue:w,getQuery:x,focus:()=>{var q;return(q=u.value)==null?void 0:q.focus()}}),Pe(()=>{}),Ce(()=>{}),(q,J)=>(p(),v("div",rl,[e("div",dl,[e("button",{class:"attach-btn",title:q.$t("input.attachFile")},[g(s(k),{icon:"carbon:attachment"})],8,ul),ge(e("textarea",{"onUpdate:modelValue":J[0]||(J[0]=A=>E.value=A),ref_key:"inputRef",ref:u,class:"chat-input",placeholder:S.value,disabled:M.value,onKeydown:z,onInput:O},null,40,pl),[[$e,E.value]]),e("button",{class:"plan-mode-btn",title:q.$t("input.planMode"),onClick:b},[g(s(k),{icon:"carbon:document"}),Z(" "+a(q.$t("input.planMode")),1)],8,hl),e("button",{class:"send-button",disabled:!E.value.trim()||M.value,onClick:o,title:q.$t("input.send")},[g(s(k),{icon:"carbon:send-alt"}),Z(" "+a(q.$t("input.send")),1)],8,vl)])]))}}),ml=ye(gl,[["__scopeId","data-v-4b2cba42"]]);class xe{static async getAllCronTasks(){try{const t=await fetch(this.BASE_URL);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get cron tasks:",t),t}}static async getCronTaskById(t){try{const n=await fetch(`${this.BASE_URL}/${t}`);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get cron task by id:",n),n}}static async createCronTask(t){try{const n=await fetch(this.BASE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to create cron task:",n),n}}static async updateCronTask(t,n){try{const r=await fetch(`${this.BASE_URL}/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});return await(await this.handleResponse(r)).json()}catch(r){throw console.error("Failed to update cron task:",r),r}}static async updateTaskStatus(t,n){try{const r=await fetch(`${this.BASE_URL}/${t}/status?status=${n}`,{method:"PUT"});await this.handleResponse(r)}catch(r){throw console.error("Failed to update task status:",r),r}}static async deleteCronTask(t){try{const n=await fetch(`${this.BASE_URL}/${t}`,{method:"DELETE"});await this.handleResponse(n)}catch(n){throw console.error("Failed to delete cron task:",n),n}}static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}}he(xe,"BASE_URL","/api/cron-tasks");const De={validateCronExpression(T){const t=T.trim().split(/\s+/);return t.length>=5&&t.length<=6},formatTime(T){return new Date(T).toLocaleString()},async saveTask(T){try{let t;return T.id?t=await xe.updateCronTask(Number(T.id),T):t=await xe.createCronTask(T),t}catch(t){throw console.error("Failed to save cron task:",t),t}},async deleteTask(T){try{await xe.deleteCronTask(String(T))}catch(t){throw console.error("Failed to delete cron task:",t),t}},async toggleTaskStatus(T){if(!T.id)throw new Error("Task ID is required");const t=T.status===0?1:0;return await xe.updateCronTask(Number(T.id),{...T,status:t})},prepareTaskExecution(T){return T.planTemplateId?{useTemplate:!0,planData:{title:T.cronName||"Scheduled Task Execution",planData:{id:T.planTemplateId,planTemplateId:T.planTemplateId,planId:T.planTemplateId},params:T.executionParams||void 0}}:{useTemplate:!1,taskContent:T.planDesc||T.cronName||""}}},fl={class:"modal-header"},bl={class:"header-actions"},kl={class:"status-switch"},$l={class:"status-label"},_l={class:"toggle-switch"},yl=["checked"],Pl={class:"modal-content"},Cl={class:"form-group"},Sl={class:"form-label"},wl=["placeholder"],El={class:"form-group"},Tl={class:"form-label"},Il=["placeholder"],xl={class:"form-help"},Dl={class:"form-group"},Rl={class:"form-label"},Al=["placeholder"],Ml={class:"form-group"},Fl={class:"form-label"},Nl={class:"template-toggle"},Ul={key:0,class:"template-selector"},Ll={value:""},Bl=["value"],ql={class:"form-help"},Vl={key:0,class:"form-group"},Wl={class:"time-info"},jl={class:"time-label"},Ol={class:"time-value"},zl={key:1,class:"form-group"},Hl={class:"time-info"},Jl={class:"time-label"},Gl={class:"time-value"},Kl={class:"modal-footer"},Xl=["disabled"],Ql=_e({__name:"TaskDetailModal",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","save"],setup(T,{emit:t}){const n=T,r=t,m=I(!1),$=I([]),u=I({cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""});Pe(async()=>{try{const o=await Fe.getAllPlanTemplates();o&&o.templates&&($.value=o.templates.map(b=>({id:b.id,name:b.title||"Unnamed Template"})))}catch(o){console.error("Failed to get template list:",o)}});const U=o=>{o.target===o.currentTarget&&r("update:modelValue",!1)},S=()=>{u.value.linkTemplate=!1,u.value.templateId="",u.value.planTemplateId=""},M=()=>u.value.cronName.trim()?u.value.cronTime.trim()?De.validateCronExpression(u.value.cronTime)?u.value.planDesc.trim()?u.value.linkTemplate&&!u.value.templateId?(alert("Please select a plan template"),!1):!0:(alert("Task description cannot be empty"),!1):(alert("Invalid Cron expression format, should be 5-6 parts separated by spaces"),!1):(alert("Cron expression cannot be empty"),!1):(alert("Task name cannot be empty"),!1),O=o=>De.formatTime(o),z=async()=>{var o;if(M()){m.value=!0;try{const b={...u.value,...((o=n.task)==null?void 0:o.id)!==void 0&&{id:n.task.id},cronName:u.value.cronName.trim(),cronTime:u.value.cronTime.trim(),planDesc:u.value.planDesc.trim(),status:u.value.status,planTemplateId:u.value.linkTemplate&&u.value.templateId||""};r("save",b)}finally{m.value=!1}}};return be(()=>n.task,o=>{if(o){const b=o.templateId||o.planTemplateId||"";u.value={cronName:o.cronName||"",cronTime:o.cronTime||"",planDesc:o.planDesc||"",status:o.status??1,linkTemplate:!!b,templateId:b,planTemplateId:b}}else u.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""}},{immediate:!0}),be(()=>n.modelValue,o=>{o||(u.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""})}),(o,b)=>(p(),ie(Ue,{to:"body"},[g(Re,{name:"modal"},{default:Ae(()=>{var C,H,w;return[o.modelValue?(p(),v("div",{key:0,class:"modal-overlay",onClick:U},[e("div",{class:"modal-container",onClick:b[8]||(b[8]=oe(()=>{},["stop"]))},[e("div",fl,[e("h3",null,a(o.$t("cronTask.taskDetail")),1),e("div",bl,[e("div",kl,[e("span",$l,a(o.$t("cronTask.taskStatus")),1),e("label",_l,[e("input",{type:"checkbox",checked:u.value.status===0,onChange:b[0]||(b[0]=x=>u.value.status=u.value.status===0?1:0)},null,40,yl),b[9]||(b[9]=e("span",{class:"toggle-slider"},null,-1))])]),e("button",{class:"close-btn",onClick:b[1]||(b[1]=x=>o.$emit("update:modelValue",!1))},[g(s(k),{icon:"carbon:close"})])])]),e("div",Pl,[e("form",{onSubmit:oe(z,["prevent"]),class:"task-form"},[e("div",Cl,[e("label",Sl,a(o.$t("cronTask.taskName")),1),ge(e("input",{"onUpdate:modelValue":b[2]||(b[2]=x=>u.value.cronName=x),type:"text",class:"form-input",placeholder:o.$t("cronTask.taskNamePlaceholder"),required:""},null,8,wl),[[$e,u.value.cronName]])]),e("div",El,[e("label",Tl,a(o.$t("cronTask.cronExpression")),1),ge(e("input",{"onUpdate:modelValue":b[3]||(b[3]=x=>u.value.cronTime=x),type:"text",class:"form-input",placeholder:o.$t("cronTask.cronExpressionPlaceholder"),required:""},null,8,Il),[[$e,u.value.cronTime]]),e("div",xl,a(o.$t("cronTask.cronExpressionHelp")),1)]),e("div",Dl,[e("label",Rl,a(o.$t("cronTask.taskDescription")),1),ge(e("textarea",{"onUpdate:modelValue":b[4]||(b[4]=x=>u.value.planDesc=x),class:"form-textarea",placeholder:o.$t("cronTask.taskDescriptionPlaceholder"),rows:"4",required:""},null,8,Al),[[$e,u.value.planDesc]])]),e("div",Ml,[e("label",Fl,a(o.$t("cronTask.planTemplate")),1),e("div",Nl,[e("button",{type:"button",class:te(["template-btn",u.value.linkTemplate?"active":""]),onClick:b[5]||(b[5]=x=>u.value.linkTemplate=!0)},[g(s(k),{icon:"carbon:checkmark"}),Z(" "+a(o.$t("cronTask.linkTemplate")),1)],2),e("button",{type:"button",class:te(["template-btn",u.value.linkTemplate?"":"active"]),onClick:S},[g(s(k),{icon:"carbon:close"}),Z(" "+a(o.$t("cronTask.noTemplate")),1)],2)]),u.value.linkTemplate?(p(),v("div",Ul,[ge(e("select",{"onUpdate:modelValue":b[6]||(b[6]=x=>u.value.templateId=x),class:"form-select"},[e("option",Ll,a(o.$t("cronTask.selectTemplate")),1),(p(!0),v(ve,null,fe($.value,x=>(p(),v("option",{key:x.id,value:x.id},a(x.name),9,Bl))),128))],512),[[pt,u.value.templateId]]),e("div",ql,a(o.$t("cronTask.templateHelpText")),1)])):N("",!0)]),(C=o.task)!=null&&C.createTime?(p(),v("div",Vl,[e("div",Wl,[e("span",jl,a(o.$t("cronTask.createTime"))+":",1),e("span",Ol,a(O(o.task.createTime)),1)])])):N("",!0),(H=o.task)!=null&&H.updateTime?(p(),v("div",zl,[e("div",Hl,[e("span",Jl,a(o.$t("cronTask.updateTime"))+":",1),e("span",Gl,a(O(o.task.updateTime)),1)])])):N("",!0)],32)]),e("div",Kl,[e("button",{type:"button",class:"cancel-btn",onClick:b[7]||(b[7]=x=>o.$emit("update:modelValue",!1))},a(o.$t("common.cancel")),1),e("button",{type:"button",class:"save-btn",onClick:z,disabled:m.value},[m.value?(p(),ie(s(k),{key:0,icon:"carbon:loading",class:"loading-icon"})):N("",!0),Z(" "+a((w=n.task)!=null&&w.id?o.$t("common.save"):o.$t("common.create")),1)],8,Xl)])])])):N("",!0)]}),_:1})]))}}),Yl=ye(Ql,[["__scopeId","data-v-5b32448e"]]),Zl={class:"modal-header"},ei={class:"header-actions"},ti={class:"modal-content"},ni={key:0,class:"loading-container"},si={key:1,class:"empty-container"},oi={key:2,class:"task-list"},ai=["onClick"],li={class:"task-main"},ii={class:"task-info"},ci={class:"task-header"},ri={class:"task-name"},di={class:"task-description"},ui={class:"task-time"},pi=["onClick"],hi=["onClick","disabled","title"],vi=["onClick","title"],gi={class:"dropdown-menu"},mi=["onClick"],fi=["onClick","disabled"],bi=["onClick","disabled"],ki={class:"confirm-header"},$i={class:"confirm-content"},_i={class:"confirm-actions"},yi=["disabled"],Pi={class:"confirm-header"},Ci={class:"confirm-content"},Si={class:"create-options"},wi={class:"option-content"},Ei={class:"option-title"},Ti={class:"option-desc"},Ii={class:"option-content"},xi={class:"option-title"},Di={class:"option-desc"},Ri={class:"confirm-actions"},Ai=_e({__name:"index",props:{modelValue:{type:Boolean,required:!0}},emits:["update:modelValue"],setup(T,{emit:t}){const n=it(),r=ct(),m=ft(),{t:$}=Te(),u=T,E=t,U=I([]),S=I(!1),M=I(null),O=I(null),z=I(null),o=I(null),b=I(!1),C=I(null),H=I(!1),w=I(null),x=I(!1),q=c=>{c.target===c.currentTarget&&E("update:modelValue",!1)},J=async()=>{S.value=!0;try{U.value=await xe.getAllCronTasks()}catch(c){console.error("Failed to load cron tasks:",c),m.error(`Failed to load tasks: ${c instanceof Error?c.message:String(c)}`)}finally{S.value=!1}},A=async c=>{M.value=c;try{const y=U.value.find(i=>i.id===c);if(!y){console.error("Task not found:",c);return}E("update:modelValue",!1);const F=Date.now().toString();await n.push({name:"direct",params:{id:F}}),await new Promise(i=>setTimeout(i,100));const l=De.prepareTaskExecution(y);l.useTemplate&&l.planData?r.emitPlanExecutionRequested(l.planData):l.taskContent&&r.setTask(l.taskContent)}catch(y){console.error("Failed to execute task:",y),m.error(`Execution failed: ${y instanceof Error?y.message:String(y)}`)}finally{M.value=null}},Y=c=>{C.value={...c},b.value=!0,o.value=null},ne=async c=>{try{await De.saveTask(c),await J(),b.value=!1,m.success("Task saved successfully")}catch(y){console.error("Failed to save task:",y),m.error(`Save failed: ${y instanceof Error?y.message:String(y)}`)}},se=c=>{w.value=c,H.value=!0},ke=async()=>{var c;if((c=w.value)!=null&&c.id){O.value=w.value.id;try{await De.deleteTask(w.value.id),await J(),H.value=!1,w.value=null,m.success("Task deleted successfully")}catch(y){console.error("Failed to delete task:",y),m.error(`Delete failed: ${y instanceof Error?y.message:String(y)}`)}finally{O.value=null}}},ce=()=>{H.value=!1,w.value=null},re=c=>{o.value=o.value===c?null:c},Se=async c=>{if(c.id){z.value=c.id;try{await De.toggleTaskStatus(c),await J(),o.value=null,m.success(`Task ${c.status===0?"disabled":"enabled"} successfully`)}catch(y){console.error("Failed to toggle task status:",y),m.error(`Status toggle failed: ${y instanceof Error?y.message:String(y)}`)}finally{z.value=null}}},_=async c=>{try{await navigator.clipboard.writeText(c),m.success("Cron expression copied successfully")}catch(y){m.error(`Copy failed: ${y instanceof Error?y.message:String(y)}`)}},R=()=>{x.value=!0},W=()=>{x.value=!1;try{E("update:modelValue",!1);const c=$("cronTask.template");r.setTaskToInput(c);const y=Date.now().toString();n.push({name:"direct",params:{id:y}})}catch(c){console.error("Error in createWithJmanus:",c),m.error(`Creation failed: ${c instanceof Error?c.message:String(c)}`)}},V=()=>{x.value=!1,C.value={cronName:"",cronTime:"",planDesc:"",status:0,planTemplateId:""},b.value=!0},D=()=>{x.value=!1},h=c=>{const y=c.target;!y.closest(".action-dropdown")&&!y.closest(".dropdown-menu")&&(o.value=null)};return Pe(()=>{document.addEventListener("click",h,!0)}),Ce(()=>{document.removeEventListener("click",h,!0)}),be(()=>u.modelValue,c=>{c&&J()}),(c,y)=>(p(),v(ve,null,[(p(),ie(Ue,{to:"body"},[g(Re,{name:"modal"},{default:Ae(()=>[T.modelValue?(p(),v("div",{key:0,class:"modal-overlay",onClick:q},[e("div",{class:"modal-container",onClick:y[3]||(y[3]=oe(()=>{},["stop"]))},[e("div",Zl,[e("h3",null,a(c.$t("cronTask.title")),1),e("div",ei,[e("button",{class:"add-task-btn",onClick:[R,y[0]||(y[0]=oe(()=>{},["stop"]))]},[g(s(k),{icon:"carbon:add"}),Z(" "+a(c.$t("cronTask.addTask")),1)]),e("button",{class:"close-btn",onClick:y[1]||(y[1]=F=>c.$emit("update:modelValue",!1))},[g(s(k),{icon:"carbon:close"})])])]),e("div",ti,[S.value?(p(),v("div",ni,[g(s(k),{icon:"carbon:loading",class:"loading-icon"}),e("span",null,a(c.$t("common.loading")),1)])):U.value.length===0?(p(),v("div",si,[g(s(k),{icon:"carbon:time",class:"empty-icon"}),e("span",null,a(c.$t("cronTask.noTasks")),1)])):(p(),v("div",oi,[(p(!0),v(ve,null,fe(U.value,F=>(p(),v("div",{key:F.id||"",class:"task-item",onClick:l=>Y(F)},[e("div",li,[e("div",ii,[e("div",ci,[e("div",ri,a(F.cronName),1),e("div",{class:te(["task-status-badge",F.status===0?"active":"inactive"])},[g(s(k),{icon:F.status===0?"carbon:checkmark-filled":"carbon:pause-filled"},null,8,["icon"]),e("span",null,a(F.status===0?c.$t("cronTask.active"):c.$t("cronTask.inactive")),1)],2)]),e("div",di,a(F.planDesc),1),e("div",ui,[g(s(k),{icon:"carbon:time"}),e("span",{class:"cron-readable",style:{cursor:"pointer"},onClick:oe(l=>_(F.cronTime),["stop"])},a(F.cronTime),9,pi)])])]),e("div",{class:"task-actions",onClick:y[2]||(y[2]=oe(()=>{},["stop"]))},[e("button",{class:"action-btn execute-btn",onClick:l=>A(F.id),disabled:M.value===F.id,title:c.$t("cronTask.executeOnce")},[g(s(k),{icon:M.value===F.id?"carbon:loading":"carbon:play-filled"},null,8,["icon"]),Z(" "+a(c.$t("cronTask.executeOnce")),1)],8,hi),e("div",{class:te(["action-dropdown",{active:o.value===F.id}])},[e("button",{class:"action-btn dropdown-btn",onClick:l=>re(F.id),title:c.$t("cronTask.operations")},[g(s(k),{icon:"carbon:overflow-menu-horizontal"}),Z(" "+a(c.$t("cronTask.operations")),1)],8,vi),ge(e("div",gi,[e("button",{class:"dropdown-item edit-btn",onClick:l=>Y(F)},[g(s(k),{icon:"carbon:edit"}),Z(" "+a(c.$t("cronTask.edit")),1)],8,mi),e("button",{class:"dropdown-item toggle-btn",onClick:l=>Se(F),disabled:z.value===F.id},[g(s(k),{icon:z.value===F.id?"carbon:loading":F.status===0?"carbon:pause-filled":"carbon:play-filled"},null,8,["icon"]),Z(" "+a(F.status===0?c.$t("cronTask.disable"):c.$t("cronTask.enable")),1)],8,fi),e("button",{class:"dropdown-item delete-btn",onClick:l=>se(F),disabled:O.value===F.id},[g(s(k),{icon:O.value===F.id?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),Z(" "+a(c.$t("cronTask.delete")),1)],8,bi)],512),[[ht,o.value===F.id]])],2)])],8,ai))),128))]))])])])):N("",!0)]),_:1})])),g(Yl,{modelValue:b.value,"onUpdate:modelValue":y[4]||(y[4]=F=>b.value=F),task:C.value,onSave:ne},null,8,["modelValue","task"]),(p(),ie(Ue,{to:"body"},[g(Re,{name:"modal"},{default:Ae(()=>{var F,l,i,d;return[H.value?(p(),v("div",{key:0,class:"modal-overlay",onClick:ce},[e("div",{class:"confirm-modal",onClick:y[5]||(y[5]=oe(()=>{},["stop"]))},[e("div",ki,[g(s(k),{icon:"carbon:warning",class:"warning-icon"}),e("h3",null,a(c.$t("cronTask.deleteConfirm")),1)]),e("div",$i,[e("p",null,a(c.$t("cronTask.deleteConfirmMessage",{taskName:((F=w.value)==null?void 0:F.cronName)||((l=w.value)==null?void 0:l.planDesc)||""})),1)]),e("div",_i,[e("button",{class:"confirm-btn cancel-btn",onClick:ce},a(c.$t("common.cancel")),1),e("button",{class:"confirm-btn delete-btn",onClick:ke,disabled:O.value===((i=w.value)==null?void 0:i.id)},[g(s(k),{icon:O.value===((d=w.value)==null?void 0:d.id)?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),Z(" "+a(c.$t("cronTask.delete")),1)],8,yi)])])])):N("",!0)]}),_:1})])),(p(),ie(Ue,{to:"body"},[g(Re,{name:"modal"},{default:Ae(()=>[x.value?(p(),v("div",{key:0,class:"modal-overlay",onClick:D},[e("div",{class:"confirm-modal create-options-modal",onClick:y[6]||(y[6]=oe(()=>{},["stop"]))},[e("div",Pi,[g(s(k),{icon:"carbon:time",class:"create-icon"}),e("h3",null,a(c.$t("cronTask.createTask")),1)]),e("div",Ci,[e("p",null,a(c.$t("cronTask.selectCreateMethod")),1),e("div",Si,[e("button",{class:"create-option-btn jmanus-btn",onClick:W},[g(s(k),{icon:"carbon:ai-status"}),e("div",wi,[e("span",Ei,a(c.$t("cronTask.createWithJmanus")),1),e("span",Ti,a(c.$t("cronTask.createWithJmanusDesc")),1)])]),e("button",{class:"create-option-btn manual-btn",onClick:V},[g(s(k),{icon:"carbon:edit"}),e("div",Ii,[e("span",xi,a(c.$t("cronTask.createManually")),1),e("span",Di,a(c.$t("cronTask.createManuallyDesc")),1)])])])]),e("div",Ri,[e("button",{class:"confirm-btn cancel-btn",onClick:D},a(c.$t("common.cancel")),1)])])])):N("",!0)]),_:1})]))],64))}}),Mi=ye(Ai,[["__scopeId","data-v-837947df"]]),Fi={class:"direct-page"},Ni={class:"direct-chat"},Ui={class:"chat-header"},Li={class:"header-actions"},Bi=["title"],qi=["title"],Vi={class:"chat-content"},Wi=["title"],ji={class:"message-content"},Oi=_e({__name:"index",setup(T){const t=vt(),n=it(),r=ct(),{t:m}=Te(),{message:$}=bt(),u=I(""),E=I(""),U=I(),S=I(),M=I(),O=I(!1),z=I(!1),o=I(null),b=I(!1),C=I(50),H=I(!1),w=I(0),x=I(0);Pe(()=>{if(console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",r.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",r.hasUnprocessedTask()),le.setEventCallbacks({onPlanUpdate:c=>{console.log("[Direct] Plan update event received for rootPlanId:",c),ne(c)&&(console.log("[Direct] Processing plan update for current rootPlanId:",c),S.value&&typeof S.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",c),S.value.handlePlanUpdate(c)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),U.value&&typeof U.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",c),U.value.updateDisplayedPlanProgress(c)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:c=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",c),!!ne(c)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",c),S.value&&typeof S.value.handlePlanCompleted=="function"){const y=le.getCachedPlanRecord(c);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",y),S.value.handlePlanCompleted(y??{planId:c})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");o.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:c=>{console.log("[Direct] Dialog round start event received for rootPlanId:",c),o.value=c,console.log("[Direct] Set currentRootPlanId to:",c),S.value&&typeof S.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",c),S.value.handleDialogRoundStart(c)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),ke()},onChatInputUpdateState:c=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",c),!ne(c,!0))return;const y=le.getCachedUIState(c);y&&re(y.enabled,y.placeholder)},onPlanError:c=>{S.value.handlePlanError(c)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),P.loadPlanTemplateList(),r.hasUnprocessedTask()&&r.currentTask){const c=r.currentTask.prompt;console.log("[Direct] Found unprocessed task from store:",c),r.markTaskAsProcessed(),ae(()=>{S.value&&typeof S.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing task via chatRef.handleSendMessage:",c),S.value.handleSendMessage(c)):(console.warn("[Direct] chatRef.handleSendMessage method not available, falling back to prompt"),u.value=c)})}else{const c=r.getAndClearTaskToInput();c?(E.value=c,console.log("[Direct] Setting inputOnlyContent for input only:",E.value)):(u.value=t.query.prompt||"",console.log("[Direct] Received task from URL:",u.value),console.log("[Direct] No unprocessed task in store"))}const h=localStorage.getItem("directPanelWidth");h&&(C.value=parseFloat(h)),console.log("[Direct] Final prompt value:",u.value),E.value&&ae(()=>{M.value&&typeof M.value.setInputValue=="function"&&(M.value.setInputValue(E.value),console.log("[Direct] Set input value:",E.value),E.value="")}),window.addEventListener("plan-execution-requested",c=>{console.log("[DirectView] Received plan-execution-requested event:",c.detail),D(c.detail)})}),be(()=>r.currentTask,h=>{if(console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",h),h&&!h.processed){const c=h.prompt;r.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",c),ae(()=>{S.value&&typeof S.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing new task via chatRef.handleSendMessage:",c),S.value.handleSendMessage(c)):console.warn("[Direct] chatRef.handleSendMessage method not available for new task")})}else console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),be(()=>u.value,(h,c)=>{console.log("[Direct] prompt value changed from:",c,"to:",h)},{immediate:!1}),be(()=>r.taskToInput,h=>{console.log("[Direct] Watch taskStore.taskToInput triggered, newTaskToInput:",h),h&&h.trim()&&(console.log("[Direct] Setting input value from taskToInput:",h),ae(()=>{M.value&&typeof M.value.setInputValue=="function"&&(M.value.setInputValue(h.trim()),console.log("[Direct] Input value set from taskToInput watch:",h.trim()),r.getAndClearTaskToInput())}))},{immediate:!1}),Ce(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),o.value=null,le.cleanup(),document.removeEventListener("mousemove",J),document.removeEventListener("mouseup",A),window.removeEventListener("plan-execution-requested",h=>{D(h.detail)})});const q=h=>{H.value=!0,w.value=h.clientX,x.value=C.value,document.addEventListener("mousemove",J),document.addEventListener("mouseup",A),document.body.style.cursor="col-resize",document.body.style.userSelect="none",h.preventDefault()},J=h=>{if(!H.value)return;const c=window.innerWidth,F=(h.clientX-w.value)/c*100;let l=x.value+F;l=Math.max(20,Math.min(80,l)),C.value=l},A=()=>{H.value=!1,document.removeEventListener("mousemove",J),document.removeEventListener("mouseup",A),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",C.value.toString())},Y=()=>{C.value=50,localStorage.setItem("directPanelWidth","50")},ne=(h,c=!1)=>!o.value||h===o.value||c&&(h==="ui-state"||h==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",h,"current:",o.value),!1),se=h=>{console.log("[DirectView] Send message from input:",h),S.value&&typeof S.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",h),S.value.handleSendMessage(h)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},ke=()=>{console.log("[DirectView] Input cleared"),M.value&&typeof M.value.clear=="function"&&M.value.clear()},ce=()=>{console.log("[DirectView] Input focused")},re=(h,c)=>{console.log("[DirectView] Input state updated:",h,c),z.value=!h},Se=(h,c)=>{console.log("[DirectView] Step selected:",h,c),U.value&&typeof U.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",h,c),U.value.handleStepSelected(h,c)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},_=(h,c,y,F)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:h,subPlanId:c,stepIndex:y,subStepIndex:F}),U.value&&typeof U.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:h,subPlanId:c,stepIndex:y,subStepIndex:F}),U.value.handleSubPlanStepSelected(h,c,y,F)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},R=()=>{console.log("[DirectView] Plan mode button clicked"),P.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",P.isCollapsed)},W=()=>{n.push("/home")},V=()=>{n.push("/configs")},D=async h=>{var y,F,l,i;if(console.log("[DirectView] Plan execution requested:",h),O.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}O.value=!0;let c=!1;S.value&&typeof S.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",h.title),S.value.addMessage("user",h.title),c=!0):console.warn("[DirectView] chatRef.addMessage method not available");try{const d=((y=h.planData)==null?void 0:y.planTemplateId)||((F=h.planData)==null?void 0:F.id)||((l=h.planData)==null?void 0:l.planId);if(!d)throw new Error(m("direct.planTemplateIdNotFound"));console.log("[Direct] Executing plan with templateId:",d,"params:",h.params),console.log("[Direct] About to call PlanActApiService.executePlan");let f;if((i=h.params)!=null&&i.trim()?(console.log("[Direct] Calling executePlan with params:",h.params.trim()),f=await Fe.executePlan(d,h.params.trim())):(console.log("[Direct] Calling executePlan without params"),f=await Fe.executePlan(d)),console.log("[Direct] Plan execution API response:",f),f.planId)console.log("[Direct] Got planId from response:",f.planId,"starting plan execution"),o.value=f.planId,console.log("[Direct] Set currentRootPlanId to:",f.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),le.handlePlanExecutionRequested(f.planId,h.title);else throw console.error("[Direct] No planId in response:",f),new Error(m("direct.executionFailedNoPlanId"))}catch(d){console.error("[Direct] Plan execution failed:",d),console.error("[Direct] Error details:",{message:d.message,stack:d.stack}),o.value=null,S.value&&typeof S.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),c||S.value.addMessage("user",h.title),S.value.addMessage("assistant",`${m("direct.executionFailed")}: ${d.message||m("common.unknownError")}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`${m("direct.executionFailed")}: ${d.message||m("common.unknownError")}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),O.value=!1}};return(h,c)=>(p(),v("div",Fi,[e("div",Ni,[g(kn,{onPlanExecutionRequested:D}),e("div",{class:"left-panel",style:Me({width:C.value+"%"})},[e("div",Ui,[e("button",{class:"back-button",onClick:W},[g(s(k),{icon:"carbon:arrow-left"})]),e("h2",null,a(h.$t("conversation")),1),e("div",Li,[g(mt),e("button",{class:"config-button",onClick:V,title:h.$t("direct.configuration")},[g(s(k),{icon:"carbon:settings-adjust",width:"20"})],8,Bi),e("button",{class:"cron-task-btn",onClick:c[0]||(c[0]=y=>b.value=!0),title:h.$t("cronTask.title")},[g(s(k),{icon:"carbon:alarm",width:"20"})],8,qi)])]),e("div",Vi,[g(cl,{ref_key:"chatRef",ref:S,mode:"direct","initial-prompt":u.value||"",onStepSelected:Se,onSubPlanStepSelected:_},null,8,["initial-prompt"])]),(p(),ie(ml,{key:h.$i18n.locale,ref_key:"inputRef",ref:M,disabled:z.value,placeholder:z.value?s(m)("input.waiting"):s(m)("input.placeholder"),"initial-value":u.value,onSend:se,onClear:ke,onFocus:ce,onUpdateState:re,onPlanModeClicked:R},null,8,["disabled","placeholder","initial-value"]))],4),e("div",{class:"panel-resizer",onMousedown:q,onDblclick:Y,title:h.$t("direct.panelResizeHint")},c[2]||(c[2]=[e("div",{class:"resizer-line"},null,-1)]),40,Wi),g(To,{ref_key:"rightPanelRef",ref:U,style:Me({width:100-C.value+"%"}),"current-root-plan-id":o.value},null,8,["style","current-root-plan-id"])]),g(Mi,{modelValue:b.value,"onUpdate:modelValue":c[1]||(c[1]=y=>b.value=y)},null,8,["modelValue"]),s($).show?(p(),v("div",{key:0,class:te(["message-toast",s($).type])},[e("div",ji,[e("span",null,a(s($).text),1)])],2)):N("",!0)]))}}),Yi=ye(Oi,[["__scopeId","data-v-a8377d69"]]);export{Yi as default};
