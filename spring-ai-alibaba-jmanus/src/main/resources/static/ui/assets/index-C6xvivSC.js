var it=Object.defineProperty;var ct=(j,o,a)=>o in j?it(j,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):j[o]=a;var ie=(j,o,a)=>ct(j,typeof o!="symbol"?o+"":o,a);import{m as rt,r as M,g as oe,d as _e,f as Se,h as ke,c as P,o as m,p as ne,u as i,e,b as J,t as c,i as E,q as Z,F as ve,j as me,s as Ee,w as fe,v as Pe,x as at,k as ue,y as $e,a as be,T as ut,z as dt,n as we,A as pt,B as ot,l as ht}from"./index-TKwppHjL.js";import{I as w,_ as Ce}from"./_plugin-vue_export-helper-RAZI8S-g.js";import{L as gt}from"./index-DA3M1Mbf.js";import{u as vt}from"./task-NwUzWfbe.js";class ce{static async generatePlan(o,a){const u={query:o};a&&(u.existingJson=a);const s=await fetch(`${this.PLAN_TEMPLATE_URL}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)});if(!s.ok)throw new Error(`Failed to generate plan: ${s.status}`);const h=await s.json();if(h.planJson)try{h.plan=JSON.parse(h.planJson)}catch{h.plan={error:"Unable to parse plan data"}}return h}static async executePlan(o,a){console.log("[PlanActApiService] executePlan called with:",{planTemplateId:o,rawParam:a});const u={planTemplateId:o};a&&(u.rawParam=a),console.log("[PlanActApiService] Making request to:",`${this.PLAN_TEMPLATE_URL}/executePlanByTemplateId`),console.log("[PlanActApiService] Request body:",u);const s=await fetch(`${this.PLAN_TEMPLATE_URL}/executePlanByTemplateId`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)});if(console.log("[PlanActApiService] Response status:",s.status,s.ok),!s.ok){const $=await s.text();throw console.error("[PlanActApiService] Request failed:",$),new Error(`Failed to execute plan: ${s.status}`)}const h=await s.json();return console.log("[PlanActApiService] executePlan response:",h),h}static async savePlanTemplate(o,a){const u=await fetch(`${this.PLAN_TEMPLATE_URL}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:o,planJson:a})});if(!u.ok)throw new Error(`Failed to save plan: ${u.status}`);return await u.json()}static async getPlanVersions(o){const a=await fetch(`${this.PLAN_TEMPLATE_URL}/versions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:o})});if(!a.ok)throw new Error(`Failed to get plan versions: ${a.status}`);return await a.json()}static async getVersionPlan(o,a){const u=await fetch(`${this.PLAN_TEMPLATE_URL}/get-version`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:o,versionIndex:a.toString()})});if(!u.ok)throw new Error(`Failed to get specific version plan: ${u.status}`);return await u.json()}static async getAllPlanTemplates(){const o=await fetch(`${this.PLAN_TEMPLATE_URL}/list`);if(!o.ok)throw new Error(`Failed to get plan template list: ${o.status}`);return await o.json()}static async updatePlanTemplate(o,a,u){const s={planId:o,query:a};u&&(s.existingJson=u);const h=await fetch(`${this.PLAN_TEMPLATE_URL}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!h.ok)throw new Error(`Failed to update plan template: ${h.status}`);const $=await h.json();if($.planJson)try{$.plan=JSON.parse($.planJson)}catch{$.plan={error:"Unable to parse plan data"}}return $}static async deletePlanTemplate(o){const a=await fetch(`${this.PLAN_TEMPLATE_URL}/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:o})});if(!a.ok)throw new Error(`Failed to delete plan template: ${a.status}`);return await a.json()}}ie(ce,"PLAN_TEMPLATE_URL","/api/plan-template");const lt=rt("sidebar",()=>{const j=M(!0),o=M("list"),a=M(null),u=M([]),s=M(null),h=M(!1),$=M(""),_=M(""),I=M(""),T=M(""),z=M(!1),X=M(!1),b=M([]),D=M(-1),Q=oe(()=>[...u.value].sort((r,y)=>{const t=new Date(r.updateTime??r.createTime);return new Date(y.updateTime??y.createTime).getTime()-t.getTime()})),d=oe(()=>b.value.length>1&&D.value>0),C=oe(()=>b.value.length>1&&D.value<b.value.length-1),x=oe(()=>{if(!s.value)return"";const r=`/api/plan-template/executePlanByTemplateId/${s.value.id}`,y=T.value.trim();return y?`${r}?${encodeURIComponent(y)}`:r}),O=()=>{j.value=!j.value},H=r=>{o.value=r},K=async()=>{h.value=!0,$.value="";try{console.log("[SidebarStore] Starting to load plan template list...");const r=await ce.getAllPlanTemplates();r!=null&&r.templates&&Array.isArray(r.templates)?(u.value=r.templates,console.log(`[SidebarStore] Successfully loaded ${r.templates.length} plan templates`)):(u.value=[],console.warn("[SidebarStore] API returned abnormal data format, using empty list",r))}catch(r){console.error("[SidebarStore] Failed to load plan template list:",r),u.value=[],$.value=`Load failed: ${r.message}`}finally{h.value=!1}},re=async r=>{a.value=r.id,s.value=r,o.value="config",await de(r),console.log(`[SidebarStore] Selected plan template: ${r.id}`)},de=async r=>{try{const y=await ce.getPlanVersions(r.id);if(b.value=y.versions||[],b.value.length>0){const t=b.value[b.value.length-1];_.value=t,D.value=b.value.length-1;try{const n=JSON.parse(t);n.prompt&&(I.value=n.prompt),n.params&&(T.value=n.params)}catch{console.warn("Unable to parse JSON content to get prompt information")}}else _.value="",I.value="",T.value=""}catch(y){throw console.error("Failed to load template data:",y),y}},p=()=>{const r={id:`new-${Date.now()}`,title:"新建计划",description:"请使用计划生成器创建新的计划模板",createTime:new Date().toISOString(),updateTime:new Date().toISOString()};s.value=r,a.value=null,_.value="",I.value="",T.value="",b.value=[],D.value=-1,o.value="config",console.log("[SidebarStore] Created new empty plan template, switching to config tab")},v=async r=>{if(!r.id){console.warn("[SidebarStore] deleteTemplate: Invalid template object or ID");return}try{await ce.deletePlanTemplate(r.id),a.value===r.id&&U(),await K(),console.log(`[SidebarStore] Plan template ${r.id} has been deleted`)}catch(y){throw console.error("Failed to delete plan template:",y),await K(),y}},U=()=>{a.value=null,s.value=null,_.value="",I.value="",T.value="",b.value=[],D.value=-1,o.value="list"};return{isCollapsed:j,currentTab:o,currentPlanTemplateId:a,planTemplateList:u,selectedTemplate:s,isLoading:h,errorMessage:$,jsonContent:_,generatorPrompt:I,executionParams:T,isGenerating:z,isExecuting:X,planVersions:b,currentVersionIndex:D,sortedTemplates:Q,canRollback:d,canRestore:C,computedApiUrl:x,toggleSidebar:O,switchToTab:H,loadPlanTemplateList:K,selectTemplate:re,createNewTemplate:p,deleteTemplate:v,clearSelection:U,clearExecutionParams:()=>{T.value=""},rollbackVersion:()=>{d.value&&(D.value--,_.value=b.value[D.value])},restoreVersion:()=>{C.value&&(D.value++,_.value=b.value[D.value])},saveTemplate:async()=>{if(!s.value)return;const r=_.value.trim();if(!r)throw new Error("Content cannot be empty");try{JSON.parse(r)}catch(y){throw new Error(`Invalid format, please correct and save.
Error: `+y.message)}try{const y=await ce.savePlanTemplate(s.value.id,r);return D.value<b.value.length-1&&(b.value=b.value.slice(0,D.value+1)),b.value.push(r),D.value=b.value.length-1,y}catch(y){throw console.error("Failed to save plan template:",y),y}},generatePlan:async()=>{if(I.value.trim()){z.value=!0;try{const r=await ce.generatePlan(I.value);if(_.value=r.planJson||"",s.value&&s.value.id.startsWith("new-")){let y="New Plan Template";try{y=JSON.parse(r.planJson||"{}").title||y}catch{console.warn("Unable to parse plan JSON to get title")}s.value={id:r.planTemplateId,title:y,description:"通过生成器创建的计划模板",createTime:new Date().toISOString(),updateTime:new Date().toISOString(),planJson:r.planJson},a.value=r.planTemplateId,await K()}return D.value<b.value.length-1&&(b.value=b.value.slice(0,D.value+1)),b.value.push(_.value),D.value=b.value.length-1,r}catch(r){throw console.error("Failed to generate plan:",r),r}finally{z.value=!1}}},updatePlan:async()=>{if(!(!I.value.trim()||!_.value.trim())&&s.value){z.value=!0;try{const r=await ce.updatePlanTemplate(s.value.id,I.value,_.value);return _.value=r.planJson||"",D.value<b.value.length-1&&(b.value=b.value.slice(0,D.value+1)),b.value.push(_.value),D.value=b.value.length-1,r}catch(r){throw console.error("Failed to update plan:",r),r}finally{z.value=!1}}},preparePlanExecution:()=>{if(!s.value)return null;X.value=!0;try{let r;try{r=JSON.parse(_.value),r.planTemplateId=s.value.id}catch{r={planTemplateId:s.value.id,planId:s.value.id,title:s.value.title??"执行计划",steps:[{stepRequirement:"[BROWSER_AGENT] 访问百度搜索阿里巴巴的最新股价"},{stepRequirement:"[DEFAULT_AGENT] 提取和整理搜索结果中的股价信息"},{stepRequirement:"[TEXT_FILE_AGENT] 创建一个文本文件记录查询结果"},{stepRequirement:"[DEFAULT_AGENT] 向用户报告查询结果"}]}}return{title:s.value.title??r.title??"Execution Plan",planData:r,params:T.value.trim()||void 0}}catch(r){throw console.error("Failed to prepare plan execution:",r),X.value=!1,r}},finishPlanExecution:()=>{X.value=!1}}}),mt={class:"sidebar-content"},ft={class:"sidebar-content-header"},Pt={class:"sidebar-content-title"},bt={class:"tab-switcher"},_t=["disabled"],St={key:0,class:"tab-content"},kt={class:"new-task-section"},$t={class:"sidebar-content-list"},Ct={key:0,class:"loading-state"},yt={key:1,class:"error-state"},Et={key:2,class:"empty-state"},wt=["onClick"],It={class:"task-icon"},Tt={class:"task-details"},xt={class:"task-title"},Rt={class:"task-preview"},Dt={class:"task-time"},At={class:"task-actions"},Mt=["title","onClick"],Lt={key:1,class:"tab-content config-tab"},Ut={key:0,class:"config-container"},Nt={class:"template-info-header"},Ot={class:"template-info"},qt={class:"template-id"},Ft={class:"config-section"},Vt={class:"section-header"},Bt={class:"section-actions"},jt=["disabled","title"],Wt=["disabled","title"],Jt=["disabled"],zt=["placeholder"],Ht={class:"config-section"},Gt={class:"section-header"},Xt={class:"generator-content"},Kt=["placeholder"],Qt={class:"generator-actions"},Yt=["disabled"],Zt=["disabled"],en={class:"config-section"},tn={class:"section-header"},nn={class:"execution-content"},sn={class:"params-input-group"},on={class:"params-input-container"},an=["placeholder"],ln=["title"],cn={class:"api-url-display"},rn={class:"api-url-label"},un={class:"api-url"},dn=["disabled"],pn=_e({__name:"index",emits:["planExecutionRequested"],setup(j,{expose:o,emit:a}){const{t:u}=Se(),s=lt(),h=a,$=()=>{s.createNewTemplate(),console.log("[PlanTemplateSidebar] 创建新的空白计划模板，切换到配置标签页")},_=async d=>{try{await s.selectTemplate(d),console.log(`[PlanTemplateSidebar] 选择了计划模板: ${d.id}`)}catch(C){console.error("选择计划模板失败:",C),alert(u("sidebar.selectTemplateFailed")+": "+C.message)}},I=async d=>{if(confirm(u("sidebar.confirmDelete",{name:d.title??u("sidebar.unnamedPlan")})))try{await s.deleteTemplate(d),alert(u("sidebar.templateDeleted"))}catch(C){console.error("删除计划模板失败:",C),alert(u("sidebar.deleteTemplateFailed")+": "+C.message)}},T=async()=>{try{const d=await s.saveTemplate();d!=null&&d.duplicate?alert(u("sidebar.saveCompleted",{message:d.message,versionCount:d.versionCount})):d!=null&&d.saved?alert(u("sidebar.saveSuccess",{message:d.message,versionCount:d.versionCount})):d!=null&&d.message&&alert(u("sidebar.saveStatus",{message:d.message}))}catch(d){console.error("保存计划修改失败:",d),alert(d.message||u("sidebar.saveFailed"))}},z=async()=>{var d;try{await s.generatePlan(),alert(u("sidebar.generateSuccess",{templateId:((d=s.selectedTemplate)==null?void 0:d.id)??u("sidebar.unknown")}))}catch(C){console.error("生成计划失败:",C),alert(u("sidebar.generateFailed")+": "+C.message)}},X=async()=>{try{await s.updatePlan(),alert(u("sidebar.updateSuccess"))}catch(d){console.error("更新计划失败:",d),alert(u("sidebar.updateFailed")+": "+d.message)}},b=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const d=s.preparePlanExecution();if(!d){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] 触发计划执行请求:",d),console.log("[Sidebar] Emitting planExecutionRequested event"),h("planExecutionRequested",d),console.log("[Sidebar] Event emitted")}catch(d){console.error("执行计划出错:",d),alert(u("sidebar.executeFailed")+": "+d.message)}finally{s.finishPlanExecution()}},D=d=>{const x=new Date().getTime()-d.getTime(),O=Math.floor(x/6e4),H=Math.floor(x/36e5),K=Math.floor(x/864e5);return O<1?"刚刚":O<60?`${O}分钟前`:H<24?`${H}小时前`:K<30?`${K}天前`:d.toLocaleDateString("zh-CN")},Q=(d,C)=>!d||d.length<=C?d:d.substring(0,C)+"...";return ke(()=>{s.loadPlanTemplateList()}),o({loadPlanTemplateList:s.loadPlanTemplateList,toggleSidebar:s.toggleSidebar,currentPlanTemplateId:s.currentPlanTemplateId}),(d,C)=>(m(),P("div",{class:ne(["sidebar-wrapper",{"sidebar-wrapper-collapsed":i(s).isCollapsed}])},[e("div",mt,[e("div",ft,[e("div",Pt,c(d.$t("sidebar.title")),1)]),e("div",bt,[e("button",{class:ne(["tab-button",{active:i(s).currentTab==="list"}]),onClick:C[0]||(C[0]=x=>i(s).switchToTab("list"))},[E(i(w),{icon:"carbon:list",width:"16"}),Z(" "+c(d.$t("sidebar.templateList")),1)],2),e("button",{class:ne(["tab-button",{active:i(s).currentTab==="config"}]),onClick:C[1]||(C[1]=x=>i(s).switchToTab("config")),disabled:!i(s).selectedTemplate},[E(i(w),{icon:"carbon:settings",width:"16"}),Z(" "+c(d.$t("sidebar.configuration")),1)],10,_t)]),i(s).currentTab==="list"?(m(),P("div",St,[e("div",kt,[e("button",{class:"new-task-btn",onClick:$},[E(i(w),{icon:"carbon:add",width:"16"}),Z(" "+c(d.$t("sidebar.newPlan"))+" ",1),C[10]||(C[10]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",$t,[i(s).isLoading?(m(),P("div",Ct,[E(i(w),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,c(d.$t("sidebar.loading")),1)])):i(s).errorMessage?(m(),P("div",yt,[E(i(w),{icon:"carbon:warning",width:"20"}),e("span",null,c(i(s).errorMessage),1),e("button",{onClick:C[2]||(C[2]=(...x)=>i(s).loadPlanTemplateList&&i(s).loadPlanTemplateList(...x)),class:"retry-btn"},c(d.$t("sidebar.retry")),1)])):i(s).planTemplateList.length===0?(m(),P("div",Et,[E(i(w),{icon:"carbon:document",width:"32"}),e("span",null,c(d.$t("sidebar.noTemplates")),1)])):(m(!0),P(ve,{key:3},me(i(s).sortedTemplates,x=>(m(),P("div",{key:x.id,class:ne(["sidebar-content-list-item",{"sidebar-content-list-item-active":x.id===i(s).currentPlanTemplateId}]),onClick:O=>_(x)},[e("div",It,[E(i(w),{icon:"carbon:document",width:"20"})]),e("div",Tt,[e("div",xt,c(x.title||d.$t("sidebar.unnamedPlan")),1),e("div",Rt,c(Q(x.description||d.$t("sidebar.noDescription"),40)),1)]),e("div",Dt,c(D(new Date(x.updateTime||x.createTime))),1),e("div",At,[e("button",{class:"delete-task-btn",title:d.$t("sidebar.deleteTemplate"),onClick:Ee(O=>I(x),["stop"])},[E(i(w),{icon:"carbon:close",width:"16"})],8,Mt)])],10,wt))),128))])])):i(s).currentTab==="config"?(m(),P("div",Lt,[i(s).selectedTemplate?(m(),P("div",Ut,[e("div",Nt,[e("div",Ot,[e("h3",null,c(i(s).selectedTemplate.title||d.$t("sidebar.unnamedPlan")),1),e("span",qt,"ID: "+c(i(s).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:C[3]||(C[3]=x=>i(s).switchToTab("list"))},[E(i(w),{icon:"carbon:arrow-left",width:"16"})])]),e("div",Ft,[e("div",Vt,[E(i(w),{icon:"carbon:code",width:"16"}),e("span",null,c(d.$t("sidebar.jsonTemplate")),1),e("div",Bt,[e("button",{class:"btn btn-sm",onClick:C[4]||(C[4]=(...x)=>i(s).rollbackVersion&&i(s).rollbackVersion(...x)),disabled:!i(s).canRollback,title:d.$t("sidebar.rollback")},[E(i(w),{icon:"carbon:undo",width:"14"})],8,jt),e("button",{class:"btn btn-sm",onClick:C[5]||(C[5]=(...x)=>i(s).restoreVersion&&i(s).restoreVersion(...x)),disabled:!i(s).canRestore,title:d.$t("sidebar.restore")},[E(i(w),{icon:"carbon:redo",width:"14"})],8,Wt),e("button",{class:"btn btn-primary btn-sm",onClick:T,disabled:i(s).isGenerating||i(s).isExecuting},[E(i(w),{icon:"carbon:save",width:"14"})],8,Jt)])]),fe(e("textarea",{"onUpdate:modelValue":C[6]||(C[6]=x=>i(s).jsonContent=x),class:"json-editor",placeholder:d.$t("sidebar.jsonPlaceholder"),rows:"8"},null,8,zt),[[Pe,i(s).jsonContent]])]),e("div",Ht,[e("div",Gt,[E(i(w),{icon:"carbon:generate",width:"16"}),e("span",null,c(d.$t("sidebar.planGenerator")),1)]),e("div",Xt,[fe(e("textarea",{"onUpdate:modelValue":C[7]||(C[7]=x=>i(s).generatorPrompt=x),class:"prompt-input",placeholder:d.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,Kt),[[Pe,i(s).generatorPrompt]]),e("div",Qt,[e("button",{class:"btn btn-primary btn-sm",onClick:z,disabled:i(s).isGenerating||!i(s).generatorPrompt.trim()},[E(i(w),{icon:i(s).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:ne({spinning:i(s).isGenerating})},null,8,["icon","class"]),Z(" "+c(i(s).isGenerating?d.$t("sidebar.generating"):d.$t("sidebar.generatePlan")),1)],8,Yt),e("button",{class:"btn btn-secondary btn-sm",onClick:X,disabled:i(s).isGenerating||!i(s).generatorPrompt.trim()||!i(s).jsonContent.trim()},[E(i(w),{icon:"carbon:edit",width:"14"}),Z(" "+c(d.$t("sidebar.updatePlan")),1)],8,Zt)])])]),e("div",en,[e("div",tn,[E(i(w),{icon:"carbon:play",width:"16"}),e("span",null,c(d.$t("sidebar.executionController")),1)]),e("div",nn,[e("div",sn,[e("label",null,c(d.$t("sidebar.executionParams")),1),e("div",on,[fe(e("input",{"onUpdate:modelValue":C[8]||(C[8]=x=>i(s).executionParams=x),class:"params-input",placeholder:d.$t("sidebar.executionParamsPlaceholder")},null,8,an),[[Pe,i(s).executionParams]]),e("button",{class:"clear-params-btn",onClick:C[9]||(C[9]=(...x)=>i(s).clearExecutionParams&&i(s).clearExecutionParams(...x)),title:d.$t("sidebar.clearParams")},[E(i(w),{icon:"carbon:close",width:"12"})],8,ln)])]),e("div",cn,[e("span",rn,c(d.$t("sidebar.apiUrl"))+":",1),e("code",un,c(i(s).computedApiUrl),1)]),e("button",{class:"btn btn-primary execute-btn",onClick:b,disabled:i(s).isExecuting||i(s).isGenerating},[E(i(w),{icon:i(s).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:ne({spinning:i(s).isExecuting})},null,8,["icon","class"]),Z(" "+c(i(s).isExecuting?d.$t("sidebar.executing"):d.$t("sidebar.executePlan")),1)],8,dn)])])])):J("",!0)])):J("",!0)])],2))}}),hn=Ce(pn,[["__scopeId","data-v-44f5dac0"]]);class Te{static async sendMessage(o){const a=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:o})});if(!a.ok)throw new Error(`API request failed: ${a.status}`);return await a.json()}}ie(Te,"BASE_URL","/api/executor");class xe{static async getDetails(o){try{const a=await fetch(`${this.BASE_URL}/details/${o}`);if(a.status===404)return null;if(!a.ok)throw new Error(`Failed to get detailed information: ${a.status}`);const u=await a.text(),s=JSON.parse(u);return s&&typeof s=="object"&&!s.currentPlanId&&(s.currentPlanId=o),s}catch(a){return console.error("[CommonApiService] Failed to get plan details:",a),null}}static async submitFormInput(o,a){const u=await fetch(`${this.BASE_URL}/submit-input/${o}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!u.ok){let h;try{h=await u.json()}catch{h={message:`Failed to submit form input: ${u.status}`}}throw new Error(h.message||`Failed to submit form input: ${u.status}`)}const s=u.headers.get("content-type");return s&&s.indexOf("application/json")!==-1?await u.json():{success:!0}}}ie(xe,"BASE_URL","/api/executor");const he=class he{constructor(){ie(this,"POLL_INTERVAL",5e3);ie(this,"state",at({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));ie(this,"callbacks",{});ie(this,"planExecutionCache",new Map);ie(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(o){return this.planExecutionCache.get(o)}getCachedUIState(o){return this.uiStateCache.get(o)}setCachedUIState(o,a){this.uiStateCache.set(o,a),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${o}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(o){return this.planExecutionCache.has(o)}setCachedPlanRecord(o,a){this.planExecutionCache.set(o,a),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${o}`)}clearCachedPlanRecord(o){const a=this.planExecutionCache.delete(o);return a&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${o}`),a}clearAllCachedRecords(){const o=this.planExecutionCache.size,a=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${o}, UI States: ${a}`)}static getInstance(){return he.instance||(he.instance=new he),he.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(o){this.callbacks={...this.callbacks,...o},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(o))}async handleUserMessageSendRequested(o){if(this.validateAndPrepareUIForNewRequest(o))try{if(await this.sendUserMessageAndSetPlanId(o),this.state.activePlanId)this.initiatePlanExecutionSequence(o,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(a){console.error("[PlanExecutionManager] Failed to send user message:",a);const u=this.state.activePlanId??"error";this.setCachedUIState(u,{enabled:!0}),this.emitChatInputUpdateState(u),this.state.activePlanId=null}}handlePlanExecutionRequested(o,a){console.log("[PlanExecutionManager] Received plan execution request:",{planId:o,query:a}),o?(this.state.activePlanId=o,this.initiatePlanExecutionSequence(a??"执行计划",o)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(o,a){const u=this.getCachedPlanRecord(o);return u!=null&&u.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${o}`),this.handlePlanExecutionRequested(u.currentPlanId,a),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${o}`),!1)}validateAndPrepareUIForNewRequest(o){if(!o)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const a=this.state.activePlanId??"ui-state";return this.setCachedUIState(a,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(a),!0}async sendUserMessageAndSetPlanId(o){try{const a=await Te.sendMessage(o);if(a!=null&&a.planId)return this.state.activePlanId=a.planId,a;if(a!=null&&a.planTemplateId)return this.state.activePlanId=a.planTemplateId,{...a,planId:a.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",a),new Error("Failed to get valid planId from API response")}catch(a){throw console.error("[PlanExecutionManager] API call failed:",a),a}}initiatePlanExecutionSequence(o,a){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${o}", planId: ${a}`);const u=a;this.emitDialogRoundStart(u),this.startPolling()}handlePlanCompletion(o){this.emitPlanCompleted(o.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await ce.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(a){console.log(`Delete plan execution record failed: ${a.message}`)}},5e3)}catch(a){console.log(`Delete plan execution record failed: ${a.message}`)}o.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(o.rootPlanId??""))}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const o=await this.getPlanDetails(this.state.activePlanId);if(!o){console.warn("[PlanExecutionManager] No details received from API");return}if(o.rootPlanId&&this.setCachedPlanRecord(o.rootPlanId,o),!o.steps||o.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(o.rootPlanId??""),this.handlePlanCompletion(o);return}this.emitPlanUpdate(o.rootPlanId??""),o.completed&&this.handlePlanCompletion(o)}catch(o){console.error("[PlanExecutionManager] Failed to poll plan status:",o)}finally{this.state.isPolling=!1}}}async getPlanDetails(o){try{const a=await xe.getDetails(o);return a!=null&&a.rootPlanId&&(this.planExecutionCache.set(a.rootPlanId,a),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${a.rootPlanId}`)),a}catch(a){return console.error("[PlanExecutionManager] Failed to get plan details:",a),null}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(o){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(o)}emitDialogRoundStart(o){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(o)}emitPlanUpdate(o){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(o)}emitPlanCompleted(o){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(o)}};ie(he,"instance",null);let Ie=he;const se=Ie.getInstance(),gn={class:"right-panel"},vn={class:"preview-header"},mn={class:"preview-tabs"},fn={class:"tab-button active"},Pn={class:"preview-content"},bn={class:"step-details"},_n={key:0,class:"step-info-fixed"},Sn={key:0,class:"agent-info"},kn={class:"info-item"},$n={class:"label"},Cn={class:"value"},yn={class:"info-item"},En={class:"label"},wn={class:"value"},In={class:"info-item"},Tn={class:"label"},xn={class:"value"},Rn={class:"info-item"},Dn={class:"label"},An={class:"execution-status"},Mn={class:"status-item"},Ln={class:"status-text"},Un={key:0},Nn={key:0,class:"think-act-steps"},On={class:"steps-container"},qn={class:"step-header"},Fn={class:"step-number"},Vn={class:"think-section"},Bn={class:"think-content"},jn={class:"input"},Wn={class:"label"},Jn={class:"output"},zn={class:"label"},Hn={key:0,class:"action-section"},Gn={class:"action-content"},Xn={class:"tool-info"},Kn={class:"label"},Qn={class:"value"},Yn={class:"input"},Zn={class:"label"},es={class:"output"},ts={class:"label"},ns={key:1,class:"sub-plan-section"},ss={class:"sub-plan-content"},os={class:"sub-plan-header"},as={class:"sub-plan-info"},ls={class:"value"},is={key:0,class:"sub-plan-info"},cs={class:"value"},rs={class:"sub-plan-status"},us={class:"status-text"},ds={key:1,class:"no-steps-message"},ps={key:2,class:"no-execution-message"},hs={class:"step-basic-info"},gs={class:"info-item"},vs={class:"value"},ms={key:0,class:"info-item"},fs={class:"value"},Ps={class:"info-item"},bs={key:3,class:"execution-indicator"},_s={class:"execution-text"},Ss={key:1,class:"no-selection"},ks=["title"],$s=_e({__name:"index",setup(j,{expose:o}){const{t:a}=Se(),u=M(),s=M(),h=M(),$=M(null),_=M(!1),I=M(!0),T=M(!0),z=oe(()=>h.value?h.value.completed?"已完成":h.value.current?"执行中":"等待执行":""),X=p=>{var U;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${p}`),h.value&&$.value){const A=$.value.rootPlanId??s.value;if(A&&A!==p){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${A}, Requested: ${p}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${p}`);const v=se.getCachedPlanRecord(p);if(!v){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${p}`);return}if(v.steps&&v.steps.length>0){const A=v.steps.length,S=(v.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${S} / ${A}`)}if(h.value&&s.value&&(s.value===p||((U=$.value)==null?void 0:U.rootPlanId)===p)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${p}`),$.value)){const S=$.value,L=D(S.planId,S.rootPlanId,S.subPlanId);L?(Q(L,S.stepIndex,S.planId,S.isSubPlan),H()):console.warn("[RightPanel] Could not find plan record for refresh:",S)}},b=(p,v,U,A,S)=>{console.log("[RightPanel] Step selected:",{planId:p,stepIndex:v,rootPlanId:U,subPlanId:A,subStepIndex:S});const L=!!(U&&A&&S!==void 0);$.value={planId:p,stepIndex:v,isSubPlan:L,...L&&{rootPlanId:U,subPlanId:A,subStepIndex:S}};const Y=D(p,U,A);if(!Y){console.warn("[RightPanel] Plan data not found:",{planId:p,rootPlanId:U,subPlanId:A}),h.value=null,$.value=null;return}Q(Y,v,p,L)},D=(p,v,U)=>{var L;if(!v||!U)return se.getCachedPlanRecord(p)??null;const A=se.getCachedPlanRecord(p);if(A)return A;const S=se.getCachedPlanRecord(v);if(!(S!=null&&S.agentExecutionSequence))return null;for(const Y of S.agentExecutionSequence)if(Y.thinkActSteps){for(const ae of Y.thinkActSteps)if(((L=ae.subPlanExecutionRecord)==null?void 0:L.currentPlanId)===U)return ae.subPlanExecutionRecord}return null},Q=(p,v,U,A)=>{var f,k,r,y,t;if(!p.steps||v>=p.steps.length){h.value=null,$.value=null,console.warn("[RightPanel] Invalid step data:",{planId:U,stepIndex:v,hasSteps:!!p.steps,stepsLength:(f=p.steps)==null?void 0:f.length,message:"Invalid step index"});return}s.value=U;const S=p.steps[v],L=(k=p.agentExecutionSequence)==null?void 0:k[v];console.log("[RightPanel] Step data details:",{planId:U,stepIndex:v,step:S,hasAgentExecutionSequence:!!p.agentExecutionSequence,agentExecutionSequenceLength:(r=p.agentExecutionSequence)==null?void 0:r.length,agentExecution:L,hasThinkActSteps:!!(L!=null&&L.thinkActSteps),thinkActStepsLength:(y=L==null?void 0:L.thinkActSteps)==null?void 0:y.length,isSubPlan:A});const Y=(L==null?void 0:L.isCompleted)??p.completed??(p.currentStepIndex!==void 0&&v<p.currentStepIndex),ae=!Y&&v===p.currentStepIndex&&!p.completed,pe={planId:U,index:v,title:typeof S=="string"?S:S.title||S.description||S.name||`${A?"子":""}步骤 ${v+1}`,description:typeof S=="string"?S:S.description||S,completed:Y,current:ae};L&&(pe.agentExecution=L),h.value=pe,console.log("[RightPanel] Step details updated:",{planId:U,stepIndex:v,stepTitle:h.value.title,hasAgentExecution:!!L,hasThinkActSteps:(((t=L==null?void 0:L.thinkActSteps)==null?void 0:t.length)??0)>0,completed:Y,current:ae,planCurrentStep:p.currentStepIndex,planCompleted:p.completed,isSubPlan:A}),L!=null&&L.thinkActSteps&&L.thinkActSteps.forEach((n,l)=>{n.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${l}:`,n.subPlanExecutionRecord)}),setTimeout(()=>{x()},100),H()},d=(p,v,U,A)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:p,subPlanId:v,stepIndex:U,subStepIndex:A}),b(v,A,p,v,A)},C=p=>{u.value=p??void 0},x=()=>{if(!u.value)return;const{scrollTop:p,scrollHeight:v,clientHeight:U}=u.value,A=v-p-U<50,S=v>U;I.value=A,_.value=S&&!A,A?T.value=!0:v-p-U>100&&(T.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:p,scrollHeight:v,clientHeight:U,isAtBottom:A,hasScrollableContent:S,showButton:_.value,shouldAutoScroll:T.value})},O=()=>{u.value&&(u.value.scrollTo({top:u.value.scrollHeight,behavior:"smooth"}),ue(()=>{T.value=!0,x()}))},H=()=>{!T.value||!u.value||ue(()=>{u.value&&(u.value.scrollTop=u.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},K=p=>{if(p===null||typeof p>"u"||p==="")return"N/A";try{const v=typeof p=="object"?p:JSON.parse(p);return JSON.stringify(v,null,2)}catch{return String(p)}},re=()=>{h.value=null,s.value=void 0,T.value=!0,u.value&&u.value.removeEventListener("scroll",x)},de=()=>{const p=()=>{const v=u.value;return v?(C(v),v.addEventListener("scroll",x),T.value=!0,x(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};ue(()=>{p()||setTimeout(()=>{p()},100)})};return ke(()=>{console.log("[RightPanel] Component mounted"),ue(()=>{de()})}),$e(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),$.value=null,re()}),o({updateDisplayedPlanProgress:X,handleStepSelected:b,handleSubPlanStepSelected:d}),(p,v)=>{var U,A;return m(),P("div",gn,[e("div",vn,[e("div",mn,[e("button",fn,[E(i(w),{icon:"carbon:events"}),v[0]||(v[0]=Z(" 步骤执行详情 "))])])]),e("div",Pn,[e("div",bn,[h.value?(m(),P("div",_n,[e("h3",null,c(h.value.title||h.value.description||`步骤 ${h.value.index+1}`),1),h.value.agentExecution?(m(),P("div",Sn,[e("div",kn,[e("span",$n,c(p.$t("rightPanel.executingAgent"))+":",1),e("span",Cn,c(h.value.agentExecution.agentName),1)]),e("div",yn,[e("span",En,c(p.$t("rightPanel.description"))+":",1),e("span",wn,c(h.value.agentExecution.agentDescription||""),1)]),e("div",In,[e("span",Tn,c(p.$t("rightPanel.request"))+":",1),e("span",xn,c(h.value.agentExecution.agentRequest||""),1)]),e("div",Rn,[e("span",Dn,c(p.$t("rightPanel.executionResult"))+":",1),e("span",{class:ne(["value",{success:h.value.agentExecution.isCompleted}])},c(h.value.agentExecution.result||p.$t("rightPanel.executing")),3)])])):J("",!0),e("div",An,[e("div",Mn,[h.value.completed?(m(),be(i(w),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):h.value.current?(m(),be(i(w),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(m(),be(i(w),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",Ln,c(z.value),1)])])])):J("",!0),e("div",{ref_key:"scrollContainer",ref:u,class:"step-details-scroll-container",onScroll:x},[h.value?(m(),P("div",Un,[(U=h.value.agentExecution)!=null&&U.thinkActSteps&&h.value.agentExecution.thinkActSteps.length>0?(m(),P("div",Nn,[e("h4",null,c(p.$t("rightPanel.thinkAndActionSteps")),1),e("div",On,[(m(!0),P(ve,null,me(h.value.agentExecution.thinkActSteps,(S,L)=>(m(),P("div",{key:L,class:"think-act-step"},[e("div",qn,[e("span",Fn,"#"+c(L+1),1),e("span",{class:ne(["step-status",S.status])},c(S.status||p.$t("rightPanel.executing")),3)]),e("div",Vn,[e("h5",null,[E(i(w),{icon:"carbon:thinking"}),Z(" "+c(p.$t("rightPanel.thinking")),1)]),e("div",Bn,[e("div",jn,[e("span",Wn,c(p.$t("rightPanel.input"))+":",1),e("pre",null,c(K(S.thinkInput)),1)]),e("div",Jn,[e("span",zn,c(p.$t("rightPanel.output"))+":",1),e("pre",null,c(K(S.thinkOutput)),1)])])]),S.actionNeeded?(m(),P("div",Hn,[e("h5",null,[E(i(w),{icon:"carbon:play"}),Z(" "+c(p.$t("rightPanel.action")),1)]),e("div",Gn,[e("div",Xn,[e("span",Kn,c(p.$t("rightPanel.tool"))+":",1),e("span",Qn,c(S.toolName||""),1)]),e("div",Yn,[e("span",Zn,c(p.$t("rightPanel.toolParameters"))+":",1),e("pre",null,c(K(S.toolParameters)),1)]),e("div",es,[e("span",ts,c(p.$t("rightPanel.executionResult"))+":",1),e("pre",null,c(K(S.actionResult)),1)])])])):J("",!0),S.subPlanExecutionRecord?(m(),P("div",ns,[e("h5",null,[E(i(w),{icon:"carbon:tree-view"}),v[1]||(v[1]=Z(" 子执行计划"))]),e("div",ss,[e("div",os,[e("div",as,[v[2]||(v[2]=e("span",{class:"label"},"子计划ID:",-1)),e("span",ls,c(S.subPlanExecutionRecord.currentPlanId),1)]),S.subPlanExecutionRecord.title?(m(),P("div",is,[v[3]||(v[3]=e("span",{class:"label"},"标题:",-1)),e("span",cs,c(S.subPlanExecutionRecord.title),1)])):J("",!0),e("div",rs,[S.subPlanExecutionRecord.completed?(m(),be(i(w),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(m(),be(i(w),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",us,c(S.subPlanExecutionRecord.completed?"已完成":"执行中"),1)])])])])):J("",!0)]))),128))])])):h.value.agentExecution&&!((A=h.value.agentExecution.thinkActSteps)!=null&&A.length)?(m(),P("div",ds,[e("p",null,c(p.$t("rightPanel.noStepDetails")),1)])):h.value.agentExecution?J("",!0):(m(),P("div",ps,[E(i(w),{icon:"carbon:information",class:"info-icon"}),v[7]||(v[7]=e("h4",null,"步骤信息",-1)),e("div",hs,[e("div",gs,[v[4]||(v[4]=e("span",{class:"label"},"步骤名称:",-1)),e("span",vs,c(h.value.title||h.value.description||`步骤 ${h.value.index+1}`),1)]),h.value.description?(m(),P("div",ms,[v[5]||(v[5]=e("span",{class:"label"},"描述:",-1)),e("span",fs,c(h.value.description),1)])):J("",!0),e("div",Ps,[v[6]||(v[6]=e("span",{class:"label"},"状态:",-1)),e("span",{class:ne(["value",{"status-completed":h.value.completed,"status-current":h.value.current,"status-pending":!h.value.completed&&!h.value.current}])},c(h.value.completed?"已完成":h.value.current?"执行中":"待执行"),3)])]),v[8]||(v[8]=e("p",{class:"no-execution-hint"},"该步骤暂无详细执行信息",-1))])),h.value.current&&!h.value.completed?(m(),P("div",bs,[v[9]||(v[9]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",_s,[E(i(w),{icon:"carbon:in-progress",class:"rotating-icon"}),Z(" "+c(p.$t("rightPanel.stepExecuting")),1)])])):J("",!0)])):(m(),P("div",Ss,[E(i(w),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,c(i(a)("rightPanel.noStepSelected")),1),e("p",null,c(i(a)("rightPanel.selectStepHint")),1)]))],544),E(ut,{name:"scroll-button"},{default:dt(()=>[_.value?(m(),P("button",{key:0,onClick:O,class:"scroll-to-bottom-btn",title:p.$t("rightPanel.scrollToBottom")},[E(i(w),{icon:"carbon:chevron-down"})],8,ks)):J("",!0)]),_:1})])])])}}}),Cs=Ce($s,[["__scopeId","data-v-c6fb8dc2"]]);function ys(){const j=se,o=oe(()=>j.getActivePlanId()),a=oe(()=>j.getState()),u=oe(()=>a.value.isPolling),s=oe(()=>!!o.value),h=(T,z)=>{j.initiatePlanExecutionSequence(T,z)},$=()=>{j.stopPolling()},_=()=>{j.startPolling()},I=()=>{j.cleanup()};return $e(()=>{I()}),{activePlanId:o,state:a,isPolling:u,hasActivePlan:s,startExecution:h,stopPolling:$,startPolling:_,cleanup:I}}const Es={class:"chat-container"},ws={class:"message-content"},Is={key:0,class:"user-message"},Ts={key:1,class:"assistant-message"},xs={key:0,class:"thinking-section"},Rs={class:"thinking-header"},Ds={class:"thinking-avatar"},As={class:"thinking-label"},Ms={class:"thinking-content"},Ls={key:0,class:"thinking"},Us={key:1,class:"progress"},Ns={class:"progress-bar"},Os={class:"progress-text"},qs={key:2,class:"steps-container"},Fs={class:"steps-title"},Vs=["onClick"],Bs={class:"section-header"},js={class:"step-icon"},Ws={class:"step-title"},Js={key:0,class:"step-status current"},zs={key:1,class:"step-status completed"},Hs={key:2,class:"step-status pending"},Gs={key:0,class:"action-info"},Xs={class:"action-description"},Ks={class:"action-icon"},Qs={key:0,class:"tool-params"},Ys={class:"param-label"},Zs={class:"param-content"},eo={key:1,class:"think-details"},to={class:"think-header"},no={class:"think-label"},so={class:"think-output"},oo={class:"think-content"},ao={key:1,class:"sub-plan-steps"},lo={class:"sub-plan-header"},io={class:"sub-plan-step-list"},co=["onClick"],ro={class:"sub-step-indicator"},uo={class:"sub-step-icon"},po={class:"sub-step-number"},ho={class:"sub-step-content"},go={class:"sub-step-title"},vo={key:2,class:"user-input-form-container"},mo={class:"user-input-message"},fo={key:0,class:"form-description"},Po=["onSubmit"],bo=["for"],_o=["id","name","onUpdate:modelValue"],So={key:1,class:"form-group"},ko={for:"form-input-genericInput"},$o=["onUpdate:modelValue"],Co={type:"submit",class:"submit-user-input-btn"},yo={key:3,class:"default-processing"},Eo={class:"processing-indicator"},wo={class:"response-section"},Io={class:"response-header"},To={class:"response-avatar"},xo={class:"response-name"},Ro={class:"response-content"},Do={key:0,class:"final-response"},Ao=["innerHTML"],Mo={key:1,class:"response-placeholder"},Lo={class:"typing-indicator"},Uo={class:"typing-text"},No={key:0,class:"message assistant"},Oo={class:"message-content"},qo={class:"assistant-message"},Fo={class:"thinking-section"},Vo={class:"thinking-header"},Bo={class:"thinking-avatar"},jo={class:"thinking-label"},Wo={class:"thinking-content"},Jo={class:"default-processing"},zo={class:"processing-indicator"},Ho={class:"response-section"},Go={class:"response-header"},Xo={class:"response-avatar"},Ko={class:"response-name"},Qo={class:"response-content"},Yo={class:"response-placeholder"},Zo={class:"typing-indicator"},ea={class:"typing-text"},ta=["title"],na=_e({__name:"index",props:{mode:{default:"plan"}},emits:["step-selected","sub-plan-step-selected"],setup(j,{expose:o,emit:a}){const u=j,s=a,{t:h}=Se(),$=ys(),_=M(),I=M(!1),T=M([]),z=M(),X=M(!1),b=at({}),D=(t,n,l)=>{const g={id:Date.now().toString(),type:t,content:n,timestamp:new Date,...l};return t==="assistant"&&!g.thinking&&!g.content&&(g.thinking=h("chat.thinking")),T.value.push(g),g},Q=t=>{const n=T.value[T.value.length-1];n.type==="assistant"&&Object.assign(n,t)},d=async t=>{try{I.value=!0;const n=D("assistant","",{thinking:"正在理解您的请求并准备回复..."}),l=await Te.sendMessage(t);delete n.thinking;const g=C(l,t);n.content=g}catch(n){console.error("Direct mode error:",n),Q({content:x(n)})}finally{I.value=!1}},C=(t,n)=>t.result??t.message??t.content??"",x=t=>{const n=(t==null?void 0:t.message)??(t==null?void 0:t.toString())??"未知错误";return n.includes("网络")||n.includes("network")||n.includes("timeout")?"抱歉，似乎网络连接有些问题。请检查您的网络连接后再试一次，或者稍等几分钟再重新提问。":n.includes("认证")||n.includes("权限")||n.includes("auth")?"抱歉，访问权限出现了问题。这可能是系统配置的问题，请联系管理员或稍后再试。":n.includes("格式")||n.includes("参数")||n.includes("invalid")?"抱歉，您的请求格式可能有些问题。能否请您重新表述一下您的需求？我会尽力理解并帮助您。":`抱歉，处理您的请求时遇到了一些问题（${n}）。请稍后再试，或者换个方式表达您的需求，我会尽力帮助您的。`},O=(t=!1)=>{ue(()=>{if(_.value){const n=_.value;(t||n.scrollHeight-n.scrollTop-n.clientHeight<150)&&n.scrollTo({top:n.scrollHeight,behavior:t?"auto":"smooth"})}})},H=()=>{O(!0),X.value=!1},K=()=>{if(_.value){const t=_.value,n=t.scrollHeight-t.scrollTop-t.clientHeight<150;X.value=!n&&T.value.length>0}},re=()=>{_.value&&_.value.addEventListener("scroll",K)},de=()=>{_.value&&_.value.removeEventListener("scroll",K)},p=t=>{D("user",t),u.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",t):d(t)},v=(t,n)=>{var l,g;if(!((l=t.planExecution)!=null&&l.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:t.planExecution.currentPlanId,stepIndex:n,stepTitle:(g=t.planExecution.steps)==null?void 0:g[n]}),s("step-selected",t.planExecution.currentPlanId,n)},U=(t,n)=>{var l;try{const g=(l=t.planExecution)==null?void 0:l.agentExecutionSequence;if(!(g!=null&&g.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const q=g[n];if(!q)return console.log(`[ChatComponent] No agentExecution found for step ${n}`),[];if(!q.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${n}`),[];for(const W of q.thinkActSteps)if(W.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${n}:`,W.subPlanExecutionRecord),(W.subPlanExecutionRecord.steps??[]).map(V=>typeof V=="string"?V:typeof V=="object"&&V!==null&&(V.title||V.description)||"子步骤");return[]}catch(g){return console.warn("[ChatComponent] Error getting sub-plan steps:",g),[]}},A=(t,n,l)=>{var g;try{const q=(g=t.planExecution)==null?void 0:g.agentExecutionSequence;if(!(q!=null&&q.length))return"pending";const W=q[n];if(!W||!W.thinkActSteps)return"pending";let G=null;for(const F of W.thinkActSteps)if(F.subPlanExecutionRecord){G=F.subPlanExecutionRecord;break}if(!G)return"pending";const V=G.currentStepIndex;return G.completed?"completed":V==null?l===0?"current":"pending":l<V?"completed":l===V?"current":"pending"}catch(q){return console.warn("[ChatComponent] Error getting sub-plan step status:",q),"pending"}},S=(t,n,l)=>{var g,q;try{const W=(g=t.planExecution)==null?void 0:g.agentExecutionSequence;if(!(W!=null&&W.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const G=W[n];if(!G){console.warn("[ChatComponent] No agentExecution found for step",n);return}if(!G.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",n);return}let V=null;for(const F of G.thinkActSteps)if(F.subPlanExecutionRecord){V=F.subPlanExecutionRecord;break}if(!(V!=null&&V.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}s("sub-plan-step-selected",((q=t.planExecution)==null?void 0:q.currentPlanId)??"",V.currentPlanId,n,l)}catch(W){console.error("[ChatComponent] Error handling sub-plan step click:",W)}},L=(t,n)=>{var g,q,W,G;if(!((g=t.planExecution)!=null&&g.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",t.planExecution.steps.length,"execution sequence:",((q=n.agentExecutionSequence)==null?void 0:q.length)??0);const l=new Array(t.planExecution.steps.length).fill(null);if((W=n.agentExecutionSequence)!=null&&W.length){const V=Math.min(n.agentExecutionSequence.length,t.planExecution.steps.length);for(let F=0;F<V;F++){const R=n.agentExecutionSequence[F];if(((G=R==null?void 0:R.thinkActSteps)==null?void 0:G.length)>0){const N=R.thinkActSteps[R.thinkActSteps.length-1];N!=null&&N.actionDescription&&(N!=null&&N.toolParameters)?(l[F]={actionDescription:N.actionDescription,toolParameters:typeof N.toolParameters=="string"?N.toolParameters:JSON.stringify(N.toolParameters,null,2),thinkInput:N.thinkInput??"",thinkOutput:N.thinkOutput??"",status:F<n.currentStepIndex?"completed":F===n.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${F} action set: ${l[F].actionDescription}`)):N?(l[F]={actionDescription:"思考中",toolParameters:"等待决策",thinkInput:N.thinkInput??"",thinkOutput:N.thinkOutput??"",status:F===n.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${F} is thinking`)):(l[F]={actionDescription:"执行完成",toolParameters:"无工具",thinkInput:"",thinkOutput:"",status:"completed"},console.log(`[ChatComponent] Step ${F} execution completed`))}else l[F]={actionDescription:F<n.currentStepIndex?"已完成":"等待中",toolParameters:"无工具参数",thinkInput:"",thinkOutput:"",status:F<n.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] 步骤 ${F} 无执行细节, 状态设为: ${l[F].status}`)}}else console.log("[ChatComponent] 没有执行序列数据");t.stepActions=[...l],console.log("[ChatComponent] 步骤动作更新完成:",JSON.stringify(l.map(V=>V==null?void 0:V.actionDescription))),ue(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},Y=t=>{console.log("[ChatComponent] Starting dialog round with planId:",t),t&&(T.value.findIndex(l=>{var g;return((g=l.planExecution)==null?void 0:g.currentPlanId)===t&&l.type==="assistant"})===-1?(D("assistant","",{planExecution:{currentPlanId:t},thinking:"正在准备执行计划..."}),console.log("[ChatComponent] Created new assistant message for planId:",t)):console.log("[ChatComponent] Found existing assistant message for planId:",t))},ae=t=>{var W,G,V,F;console.log("[ChatComponent] Processing plan update with rootPlanId:",t);const n=se.getCachedPlanRecord(t);if(!n){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",t);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",n),console.log("[ChatComponent] Plan steps:",n.steps),console.log("[ChatComponent] Plan completed:",n.completed),!n.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const l=T.value.findIndex(R=>{var N;return((N=R.planExecution)==null?void 0:N.currentPlanId)===n.currentPlanId&&R.type==="assistant"});let g;if(l!==-1)g=T.value[l],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",n.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",n.currentPlanId),console.log("[ChatComponent] Current messages:",T.value.map(N=>{var ee;return{type:N.type,planId:(ee=N.planExecution)==null?void 0:ee.currentPlanId,content:N.content.substring(0,50)}}));let R=-1;for(let N=T.value.length-1;N>=0;N--)if(T.value[N].type==="assistant"){R=N;break}if(R!==-1)g=T.value[R],g.planExecution||(g.planExecution={}),g.planExecution.currentPlanId=n.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",n.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(g.planExecution||(g.planExecution={}),g.planExecution=JSON.parse(JSON.stringify(n)),!n.steps||n.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),n.completed){delete g.thinking;const R=n.summary??n.result??n.message??"处理完成";g.content=pe(R),console.log("[ChatComponent] Set simple response content:",g.content)}else n.title&&(g.thinking=`正在执行: ${n.title}`);return}delete g.thinking;const q=n.steps.map(R=>typeof R=="string"?R:typeof R=="object"&&R!==null&&(R.title||R.description)||"步骤");if(g.planExecution&&(g.planExecution.steps=q),n.agentExecutionSequence&&n.agentExecutionSequence.length>0){console.log("[ChatComponent] 发现执行序列数据，数量:",n.agentExecutionSequence.length),L(g,n);const R=n.currentStepIndex??0;if(R>=0&&R<n.agentExecutionSequence.length){const ee=n.agentExecutionSequence[R].thinkActSteps;if(ee&&ee.length>0){const ge=ee[ee.length-1];if(ge.thinkOutput){const ye=ge.thinkOutput.length>150?ge.thinkOutput.substring(0,150)+"...":ge.thinkOutput;g.thinking=`正在思考: ${ye}`}}}}else if(g.planExecution){const R=g.planExecution.currentStepIndex??0,N=(W=g.planExecution.steps)==null?void 0:W[R],ee=typeof N=="string"?N:"";g.thinking=`正在执行: ${ee}`}if(n.userInputWaitState&&g.planExecution?(console.log("[ChatComponent] 需要用户输入:",n.userInputWaitState),g.planExecution.userInputWaitState||(g.planExecution.userInputWaitState={}),g.planExecution.userInputWaitState={message:n.userInputWaitState.message??"",formDescription:n.userInputWaitState.formDescription??"",formInputs:((G=n.userInputWaitState.formInputs)==null?void 0:G.map(R=>({label:R.label,value:R.value||""})))??[]},b[V=g.id]??(b[V]={}),g.thinking="等待用户输入..."):(F=g.planExecution)!=null&&F.userInputWaitState&&delete g.planExecution.userInputWaitState,n.completed??n.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete g.thinking;let R="";n.summary?R=n.summary:n.result?R=n.result:R="任务已完成",g.content=f(R,n),console.log("[ChatComponent] Updated completed message:",g.content)}ue(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},pe=t=>t?t.includes("我")||t.includes("您")||t.includes("您好")||t.includes("可以")?t:t.length<10?`${t}！还有什么需要我帮助的吗？`:t.length<50?`好的，${t}。如果您还有其他问题，请随时告诉我。`:`${t}

希望这个回答对您有帮助！还有什么我可以为您做的吗？`:"我明白了，还有什么我可以帮您的吗？",f=(t,n)=>{var g;return t?t.includes("我")||t.includes("您")?!t.includes("?")&&!t.includes("？")&&!t.includes("。")&&!t.includes("！")?`${t}。还有其他需要帮助的地方吗？`:t:((g=n==null?void 0:n.steps)==null?void 0:g.length)>0?`很好！我已经完成了您的任务：${t}

所有步骤都已成功执行。还有什么我可以帮您处理的吗？`:`${t}

希望这个回答对您有帮助！如果还有其他问题，请随时告诉我。`:"任务已完成！还有什么我可以帮您的吗？"},k=t=>{if(console.log("[ChatComponent] Plan completed:",t),t!=null&&t.planId){const n=T.value.findIndex(l=>{var g;return((g=l.planExecution)==null?void 0:g.currentPlanId)===t.planId});if(n!==-1){const l=T.value[n];delete l.thinking;let q=t.summary??t.result??"任务已完成";!q.includes("我")&&!q.includes("您")&&(q.includes("成功")||q.includes("完成")?q=`很好！${q}。如果您还有其他需要帮助的地方，请随时告诉我。`:q=`我已经完成了您的请求：${q}`),l.content=q,console.log("[ChatComponent] Updated completed message:",l.content)}else console.warn("[ChatComponent] No message found for completed planId:",t.planId)}},r=t=>{if(!t)return"";let n=t.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return n=n.replace(/(<br><br>)/g,"</p><p>"),n.includes("</p><p>")&&(n=`<p>${n}</p>`),n},y=async t=>{var n;if(!((n=t.planExecution)!=null&&n.currentPlanId)||!t.planExecution.userInputWaitState){console.error("[ChatComponent] 缺少planExecution.currentPlanId或userInputWaitState");return}try{const l={},g=t.planExecution.userInputWaitState.formInputs;g&&g.length>0?Object.entries(b[t.id]).forEach(([W,G])=>{var R;const V=parseInt(W,10),F=((R=g[V])==null?void 0:R.label)||`input_${W}`;l[F]=G}):l.genericInput=t.genericInput??"",console.log("[ChatComponent] 提交用户输入:",l);const q=await xe.submitFormInput(t.planExecution.currentPlanId,l);delete t.planExecution.userInputWaitState,delete t.genericInput,delete b[t.id],$.startPolling(),console.log("[ChatComponent] 用户输入提交成功:",q)}catch(l){console.error("[ChatComponent] 用户输入提交失败:",l),alert(`提交失败: ${(l==null?void 0:l.message)||"未知错误"}`)}};return ke(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),ue(()=>{re()})}),$e(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),de(),z.value&&clearInterval(z.value),$.cleanup(),Object.keys(b).forEach(t=>delete b[t])}),o({handleSendMessage:p,handlePlanUpdate:ae,handlePlanCompleted:k,handleDialogRoundStart:Y,addMessage:D}),(t,n)=>(m(),P("div",Es,[e("div",{class:"messages",ref_key:"messagesRef",ref:_},[(m(!0),P(ve,null,me(T.value,l=>{var g,q,W,G,V,F,R,N,ee;return m(),P("div",{key:l.id,class:ne(["message",{user:l.type==="user",assistant:l.type==="assistant"}])},[e("div",ws,[l.type==="user"?(m(),P("div",Is,c(l.content),1)):(m(),P("div",Ts,[l.thinking||((g=l.planExecution)==null?void 0:g.progress)!==void 0||(((W=(q=l.planExecution)==null?void 0:q.steps)==null?void 0:W.length)??0)>0?(m(),P("div",xs,[e("div",Rs,[e("div",Ds,[E(i(w),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",As,c(t.$t("chat.thinkingLabel")),1)]),e("div",Ms,[l.thinking?(m(),P("div",Ls,[E(i(w),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,c(l.thinking),1)])):J("",!0),((G=l.planExecution)==null?void 0:G.progress)!==void 0?(m(),P("div",Us,[e("div",Ns,[e("div",{class:"progress-fill",style:we({width:l.planExecution.progress+"%"})},null,4)]),e("span",Os,c(l.planExecution.progressText??t.$t("chat.processing")+"..."),1)])):J("",!0),(((F=(V=l.planExecution)==null?void 0:V.steps)==null?void 0:F.length)??0)>0?(m(),P("div",qs,[e("h4",Fs,c(t.$t("chat.stepExecutionDetails")),1),(m(!0),P(ve,null,me((R=l.planExecution)==null?void 0:R.steps,(ge,B)=>{var ye,Re,De,Ae,Me,Le,Ue,Ne,Oe,qe,Fe,Ve,Be,je,We,Je,ze,He,Ge,Xe,Ke,Qe,Ye,Ze,et,tt,nt;return m(),P("div",{key:B,class:ne(["ai-section",{current:B===(((ye=l.planExecution)==null?void 0:ye.currentStepIndex)??-1),completed:B<(((Re=l.planExecution)==null?void 0:Re.currentStepIndex)??0),pending:B>(((De=l.planExecution)==null?void 0:De.currentStepIndex)??0)}]),onClick:Ee(le=>v(l,B),["stop"])},[e("div",Bs,[e("span",js,c(B<(((Ae=l.planExecution)==null?void 0:Ae.currentStepIndex)??0)?"✓":B===(((Me=l.planExecution)==null?void 0:Me.currentStepIndex)??-1)?"▶":"○"),1),e("span",Ws,c(ge||`${t.$t("chat.step")} ${B+1}`),1),B===(((Le=l.planExecution)==null?void 0:Le.currentStepIndex)??-1)?(m(),P("span",Js,c(t.$t("chat.status.executing")),1)):B<(((Ue=l.planExecution)==null?void 0:Ue.currentStepIndex)??0)?(m(),P("span",zs,c(t.$t("chat.status.completed")),1)):(m(),P("span",Hs,c(t.$t("chat.status.pending")),1))]),l.stepActions&&l.stepActions[B]?(m(),P("div",Gs,[e("div",Xs,[e("span",Ks,c(((Ne=l.stepActions[B])==null?void 0:Ne.status)==="current"?"🔄":((Oe=l.stepActions[B])==null?void 0:Oe.status)==="completed"?"✓":"⏳"),1),e("strong",null,c((qe=l.stepActions[B])==null?void 0:qe.actionDescription),1)]),(Fe=l.stepActions[B])!=null&&Fe.toolParameters?(m(),P("div",Qs,[n[0]||(n[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",Ys,c(t.$t("common.parameters"))+":",1),e("pre",Zs,c((Ve=l.stepActions[B])==null?void 0:Ve.toolParameters),1)])):J("",!0),(Be=l.stepActions[B])!=null&&Be.thinkOutput?(m(),P("div",eo,[e("div",to,[n[1]||(n[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",no,c(t.$t("chat.thinkingOutput"))+":",1)]),e("div",so,[e("pre",oo,c((je=l.stepActions[B])==null?void 0:je.thinkOutput),1)])])):J("",!0)])):J("",!0),((We=U(l,B))==null?void 0:We.length)>0?(m(),P("div",ao,[e("div",lo,[E(i(w),{icon:"carbon:tree-view",class:"sub-plan-icon"}),n[2]||(n[2]=e("span",{class:"sub-plan-title"},"子执行计划",-1))]),e("div",io,[(m(!0),P(ve,null,me(U(l,B),(le,te)=>(m(),P("div",{key:`sub-${B}-${te}`,class:ne(["sub-plan-step-item",{completed:A(l,B,te)==="completed",current:A(l,B,te)==="current",pending:A(l,B,te)==="pending"}]),onClick:Ee(st=>S(l,B,te),["stop"])},[e("div",ro,[e("span",uo,c(A(l,B,te)==="completed"?"✓":A(l,B,te)==="current"?"▶":"○"),1),e("span",po,c(te+1),1)]),e("div",ho,[e("span",go,c(le),1),n[3]||(n[3]=e("span",{class:"sub-step-badge"},"子步骤",-1))])],10,co))),128))])])):J("",!0),(Je=l.planExecution)!=null&&Je.userInputWaitState&&B===(((ze=l.planExecution)==null?void 0:ze.currentStepIndex)??-1)?(m(),P("div",vo,[e("p",mo,c(((Ge=(He=l.planExecution)==null?void 0:He.userInputWaitState)==null?void 0:Ge.message)??t.$t("chat.userInput.message")),1),(Ke=(Xe=l.planExecution)==null?void 0:Xe.userInputWaitState)!=null&&Ke.formDescription?(m(),P("p",fo,c((Ye=(Qe=l.planExecution)==null?void 0:Qe.userInputWaitState)==null?void 0:Ye.formDescription),1)):J("",!0),e("form",{onSubmit:Ee(le=>y(l),["prevent"]),class:"user-input-form"},[(et=(Ze=l.planExecution)==null?void 0:Ze.userInputWaitState)!=null&&et.formInputs&&l.planExecution.userInputWaitState.formInputs.length>0?(m(!0),P(ve,{key:0},me((nt=(tt=l.planExecution)==null?void 0:tt.userInputWaitState)==null?void 0:nt.formInputs,(le,te)=>(m(),P("div",{key:te,class:"form-group"},[e("label",{for:`form-input-${le.label.replace(/\W+/g,"_")}`},c(le.label)+": ",9,bo),fe(e("input",{type:"text",id:`form-input-${le.label.replace(/\W+/g,"_")}`,name:le.label,"onUpdate:modelValue":st=>b[l.id][te]=st,class:"form-input"},null,8,_o),[[Pe,b[l.id][te]]])]))),128)):(m(),P("div",So,[e("label",ko,c(t.$t("common.input"))+":",1),fe(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":le=>l.genericInput=le,class:"form-input"},null,8,$o),[[Pe,l.genericInput]])])),e("button",Co,c(t.$t("chat.userInput.submit")),1)],40,Po)])):J("",!0)],10,Vs)}),128))])):!l.content&&(l.thinking||((N=l.planExecution)==null?void 0:N.progress)!==void 0&&(((ee=l.planExecution)==null?void 0:ee.progress)??0)<100)?(m(),P("div",yo,[e("div",Eo,[n[4]||(n[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,c(l.thinking??t.$t("chat.thinkingProcessing")),1)])])):J("",!0)])])):J("",!0),e("div",wo,[e("div",Io,[e("div",To,[E(i(w),{icon:"carbon:bot",class:"bot-icon"})]),e("div",xo,c(t.$t("chat.botName")),1)]),e("div",Ro,[l.content?(m(),P("div",Do,[e("div",{class:"response-text",innerHTML:r(l.content)},null,8,Ao)])):(m(),P("div",Mo,[e("div",Lo,[n[5]||(n[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Uo,c(t.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),I.value?(m(),P("div",No,[e("div",Oo,[e("div",qo,[e("div",Fo,[e("div",Vo,[e("div",Bo,[E(i(w),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",jo,c(t.$t("chat.thinkingLabel")),1)]),e("div",Wo,[e("div",Jo,[e("div",zo,[n[6]||(n[6]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,c(t.$t("chat.thinking")),1)])])])]),e("div",Ho,[e("div",Go,[e("div",Xo,[E(i(w),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Ko,c(t.$t("chat.botName")),1)]),e("div",Qo,[e("div",Yo,[e("div",Zo,[n[7]||(n[7]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",ea,c(t.$t("chat.thinkingResponse")),1)])])])])])])])):J("",!0)],512),X.value?(m(),P("div",{key:0,class:"scroll-to-bottom-btn",onClick:H,title:t.$t("chat.scrollToBottom")},[E(i(w),{icon:"carbon:chevron-down"})],8,ta)):J("",!0)]))}}),sa=Ce(na,[["__scopeId","data-v-73e1ff5d"]]),oa={class:"input-area"},aa={class:"input-container"},la={class:"attach-btn",title:"附加文件"},ia=["placeholder","disabled"],ca=["title"],ra=["disabled","title"],ua=_e({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1}},emits:["send","clear","update-state","message-sent","plan-mode-clicked"],setup(j,{expose:o,emit:a}){const{t:u}=Se(),s=j,h=a,$=M(),_=M(""),I=oe(()=>s.placeholder||u("input.placeholder")),T=M(I.value),z=oe(()=>!!s.disabled),X=()=>{ue(()=>{$.value&&($.value.style.height="auto",$.value.style.height=Math.min($.value.scrollHeight,120)+"px")})},b=O=>{O.key==="Enter"&&!O.shiftKey&&(O.preventDefault(),D())},D=()=>{if(!_.value.trim()||z.value)return;const O=_.value.trim();h("send",O),d(),h("message-sent",O)},Q=()=>{h("plan-mode-clicked")},d=()=>{_.value="",X(),h("clear")};return o({clearInput:d,updateState:(O,H)=>{H&&(T.value=O?H:u("input.waiting")),h("update-state",O,H)},getQuery:()=>_.value.trim(),focus:()=>{var O;return(O=$.value)==null?void 0:O.focus()}}),ke(()=>{}),$e(()=>{}),(O,H)=>(m(),P("div",oa,[e("div",aa,[e("button",la,[E(i(w),{icon:"carbon:attachment"})]),fe(e("textarea",{"onUpdate:modelValue":H[0]||(H[0]=K=>_.value=K),ref_key:"inputRef",ref:$,class:"chat-input",placeholder:T.value,disabled:z.value,onKeydown:b,onInput:X},null,40,ia),[[Pe,_.value]]),e("button",{class:"plan-mode-btn",title:O.$t("input.planMode"),onClick:Q},[E(i(w),{icon:"carbon:document"}),Z(" "+c(O.$t("input.planMode")),1)],8,ca),e("button",{class:"send-button",disabled:!_.value.trim()||z.value,onClick:D,title:O.$t("input.send")},[E(i(w),{icon:"carbon:send-alt"}),Z(" "+c(O.$t("input.send")),1)],8,ra)])]))}}),da=Ce(ua,[["__scopeId","data-v-b31c7f01"]]),pa={class:"direct-page"},ha={class:"direct-chat"},ga={class:"chat-header"},va={class:"header-actions"},ma=["title"],fa={class:"chat-content"},Pa=["title"],ba=_e({__name:"index",setup(j){const o=pt(),a=ht(),u=vt(),s=lt(),{t:h}=Se(),$=M(""),_=M(),I=M(),T=M(),z=M(!1),X=M(!1),b=M(null),D=M(50),Q=M(!1),d=M(0),C=M(0);ke(()=>{console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",u.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",u.hasUnprocessedTask()),se.setEventCallbacks({onPlanUpdate:k=>{console.log("[Direct] Plan update event received for rootPlanId:",k),re(k)&&(console.log("[Direct] Processing plan update for current rootPlanId:",k),I.value&&typeof I.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",k),I.value.handlePlanUpdate(k)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),_.value&&typeof _.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",k),_.value.updateDisplayedPlanProgress(k)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:k=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",k),!!re(k)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",k),I.value&&typeof I.value.handlePlanCompleted=="function"){const r=se.getCachedPlanRecord(k);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",r),I.value.handlePlanCompleted(r??{planId:k})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");b.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:k=>{console.log("[Direct] Dialog round start event received for rootPlanId:",k),b.value=k,console.log("[Direct] Set currentRootPlanId to:",k),I.value&&typeof I.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",k),I.value.handleDialogRoundStart(k)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),p()},onChatInputUpdateState:k=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",k),!re(k,!0))return;const r=se.getCachedUIState(k);r&&U(r.enabled,r.placeholder)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),s.loadPlanTemplateList(),u.hasUnprocessedTask()&&u.currentTask?($.value=u.currentTask.prompt,console.log("[Direct] Setting prompt from store:",$.value),u.markTaskAsProcessed(),console.log("[Direct] Received task from store:",$.value)):($.value=o.query.prompt||"",console.log("[Direct] Received task from URL:",$.value),console.log("[Direct] No unprocessed task in store"));const f=localStorage.getItem("directPanelWidth");f&&(D.value=parseFloat(f)),console.log("[Direct] Final prompt value:",$.value)}),ot(()=>u.currentTask,f=>{console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",f),f&&!f.processed?($.value=f.prompt,u.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",$.value)):console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),ot(()=>$.value,(f,k)=>{console.log("[Direct] prompt value changed from:",k,"to:",f)},{immediate:!1}),$e(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),b.value=null,se.cleanup(),document.removeEventListener("mousemove",O),document.removeEventListener("mouseup",H)});const x=f=>{Q.value=!0,d.value=f.clientX,C.value=D.value,document.addEventListener("mousemove",O),document.addEventListener("mouseup",H),document.body.style.cursor="col-resize",document.body.style.userSelect="none",f.preventDefault()},O=f=>{if(!Q.value)return;const k=window.innerWidth,y=(f.clientX-d.value)/k*100;let t=C.value+y;t=Math.max(20,Math.min(80,t)),D.value=t},H=()=>{Q.value=!1,document.removeEventListener("mousemove",O),document.removeEventListener("mouseup",H),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",D.value.toString())},K=()=>{D.value=50,localStorage.setItem("directPanelWidth","50")},re=(f,k=!1)=>!b.value||f===b.value||k&&(f==="ui-state"||f==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",f,"current:",b.value),!1),de=f=>{console.log("[DirectView] Send message from input:",f),I.value&&typeof I.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",f),I.value.handleSendMessage(f)):console.warn("[DirectView] chatRef.handleSendMessage method not available"),console.log("[DirectView] Delegating message to planExecutionManager:",f),se.handleUserMessageSendRequested(f)},p=()=>{console.log("[DirectView] Input cleared"),T.value&&typeof T.value.clear=="function"&&T.value.clear()},v=()=>{console.log("[DirectView] Input focused")},U=(f,k)=>{console.log("[DirectView] Input state updated:",f,k),X.value=!f},A=(f,k)=>{console.log("[DirectView] Step selected:",f,k),_.value&&typeof _.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",f,k),_.value.handleStepSelected(f,k)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},S=(f,k,r,y)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:f,subPlanId:k,stepIndex:r,subStepIndex:y}),_.value&&typeof _.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:f,subPlanId:k,stepIndex:r,subStepIndex:y}),_.value.handleSubPlanStepSelected(f,k,r,y)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},L=()=>{console.log("[DirectView] Plan mode button clicked"),s.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",s.isCollapsed)},Y=()=>{a.push("/home")},ae=()=>{a.push("/configs")},pe=async f=>{var k;if(console.log("[DirectView] Plan execution requested:",f),z.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}z.value=!0,I.value&&typeof I.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",f.title),I.value.addMessage("user",f.title)):console.warn("[DirectView] chatRef.addMessage method not available");try{const r=f.planData.planTemplateId||f.planData.planId;if(!r)throw new Error("没有找到计划模板ID");console.log("[Direct] Executing plan with templateId:",r,"params:",f.params),console.log("[Direct] About to call PlanActApiService.executePlan");let y;if((k=f.params)!=null&&k.trim()?(console.log("[Direct] Calling executePlan with params:",f.params.trim()),y=await ce.executePlan(r,f.params.trim())):(console.log("[Direct] Calling executePlan without params"),y=await ce.executePlan(r)),console.log("[Direct] Plan execution API response:",y),y.planId)console.log("[Direct] Got planId from response:",y.planId,"starting plan execution"),b.value=y.planId,console.log("[Direct] Set currentRootPlanId to:",y.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),se.handlePlanExecutionRequested(y.planId,f.title);else throw console.error("[Direct] No planId in response:",y),new Error("执行计划失败：未返回有效的计划ID")}catch(r){console.error("[Direct] Plan execution failed:",r),console.error("[Direct] Error details:",{message:r.message,stack:r.stack}),b.value=null,I.value&&typeof I.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),I.value.addMessage("user",f.title),I.value.addMessage("assistant",`执行计划失败: ${r.message||"未知错误"}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`执行计划失败: ${r.message||"未知错误"}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),z.value=!1}};return(f,k)=>(m(),P("div",pa,[e("div",ha,[E(hn,{onPlanExecutionRequested:pe}),e("div",{class:"left-panel",style:we({width:D.value+"%"})},[e("div",ga,[e("button",{class:"back-button",onClick:Y},[E(i(w),{icon:"carbon:arrow-left"})]),e("h2",null,c(f.$t("conversation")),1),e("div",va,[E(gt),e("button",{class:"config-button",onClick:ae,title:f.$t("direct.configuration")},[E(i(w),{icon:"carbon:settings-adjust",width:"20"})],8,ma)])]),e("div",fa,[E(sa,{ref_key:"chatRef",ref:I,"initial-prompt":$.value||"",onStepSelected:A,onSubPlanStepSelected:S},null,8,["initial-prompt"])]),E(da,{ref_key:"inputRef",ref:T,disabled:X.value,placeholder:X.value?"等待任务完成...":i(h)("input.placeholder"),onSend:de,onClear:p,onFocus:v,onUpdateState:U,onPlanModeClicked:L},null,8,["disabled","placeholder"])],4),e("div",{class:"panel-resizer",onMousedown:x,onDblclick:K,title:f.$t("direct.panelResizeHint")},k[0]||(k[0]=[e("div",{class:"resizer-line"},null,-1)]),40,Pa),E(Cs,{ref_key:"rightPanelRef",ref:_,style:we({width:100-D.value+"%"})},null,8,["style"])])]))}}),ya=Ce(ba,[["__scopeId","data-v-37fcfc6e"]]);export{ya as default};
