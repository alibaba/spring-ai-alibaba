var it=Object.defineProperty;var ct=(w,s,a)=>s in w?it(w,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):w[s]=a;var he=(w,s,a)=>ct(w,typeof s!="symbol"?s+"":s,a);import{d as Pe,f as Te,g as ke,h as Ce,c as g,o as h,m as te,u as l,e,b as B,t as i,i as k,p as Y,F as ge,j as fe,q as ie,w as re,v as be,s as ot,r as R,l as ne,x as Ie,a as ce,T as De,y as xe,z as _e,n as Ne,A as Ae,B as rt,C as ut,k as at,D as dt}from"./index-DO2yvTzX.js";import{I as $,_ as Se}from"./_plugin-vue_export-helper-w9WVOjBt.js";import{s as f,P as Me,u as lt}from"./sidebar-CKAUYPfb.js";import{L as pt}from"./index-VlvMYK3B.js";import{u as ht}from"./useToast-Dk4yxrfJ.js";const gt={class:"sidebar-content"},mt={class:"sidebar-content-header"},vt={class:"sidebar-content-title"},ft={class:"tab-switcher"},bt=["disabled"],kt={key:0,class:"tab-content"},_t={class:"new-task-section"},$t={class:"sidebar-content-list"},Pt={key:0,class:"loading-state"},Ct={key:1,class:"error-state"},St={key:2,class:"empty-state"},yt=["onClick"],Et={class:"task-icon"},wt={class:"task-details"},Tt={class:"task-title"},It={class:"task-preview"},Dt={class:"task-time"},xt={class:"task-actions"},Rt=["title","onClick"],At={key:1,class:"tab-content config-tab"},Mt={key:0,class:"config-container"},Nt={class:"template-info-header"},Ut={class:"template-info"},Lt={class:"template-id"},Vt={class:"config-section"},qt={class:"section-header"},Ft={class:"generator-content"},Ot=["placeholder"],Bt={class:"generator-actions"},Wt=["disabled"],jt=["disabled"],Ht={class:"config-section"},Jt={class:"section-header"},zt={class:"section-actions"},Gt=["disabled","title"],Xt=["disabled","title"],Kt=["disabled"],Qt=["placeholder"],Yt={class:"config-section"},Zt={class:"section-header"},en={class:"execution-content"},tn={class:"params-input-group"},nn={class:"params-help-text"},sn={class:"params-input-container"},on=["placeholder"],an=["title"],ln={class:"api-url-display"},cn={class:"api-url-label"},rn={class:"api-url"},un={class:"api-url-display"},dn={class:"api-url-label"},pn=["disabled"],hn=Pe({__name:"index",emits:["planExecutionRequested"],setup(w,{expose:s,emit:a}){const{t:r}=Te(),T=["currentPlanId","userRequest","rootPlanId"],v=ke({get(){try{if(!f.jsonContent)return"";const d={...JSON.parse(f.jsonContent)};return T.forEach(E=>{delete d[E]}),JSON.stringify(d,null,2)}catch{return f.jsonContent}},set(o){try{if(!o.trim()){f.jsonContent="";return}const d=JSON.parse(o);let E={};try{E=JSON.parse(f.jsonContent||"{}")}catch{}const X={...d};T.forEach(L=>{E[L]!==void 0&&(X[L]=E[L])}),f.jsonContent=JSON.stringify(X)}catch{f.jsonContent=o}}}),_=a,x=async()=>{try{const o=await f.saveTemplate();o!=null&&o.duplicate?alert(r("sidebar.saveCompleted",{message:o.message,versionCount:o.versionCount})):o!=null&&o.saved?alert(r("sidebar.saveSuccess",{message:o.message,versionCount:o.versionCount})):o!=null&&o.message&&alert(r("sidebar.saveStatus",{message:o.message}))}catch(o){console.error("保存计划修改失败:",o),alert(o.message||r("sidebar.saveFailed"))}},I=async()=>{var o;try{await f.generatePlan(),alert(r("sidebar.generateSuccess",{templateId:((o=f.selectedTemplate)==null?void 0:o.id)??r("sidebar.unknown")}))}catch(d){console.error("生成计划失败:",d),alert(r("sidebar.generateFailed")+": "+d.message)}},D=async()=>{try{await f.updatePlan(),alert(r("sidebar.updateSuccess"))}catch(o){console.error("更新计划失败:",o),alert(r("sidebar.updateFailed")+": "+o.message)}},K=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const o=f.preparePlanExecution();if(!o){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] 触发计划执行请求:",o),console.log("[Sidebar] Emitting planExecutionRequested event"),_("planExecutionRequested",o),console.log("[Sidebar] Event emitted")}catch(o){console.error("执行计划出错:",o),alert(r("sidebar.executeFailed")+": "+o.message)}finally{f.finishPlanExecution()}},G=o=>{const E=new Date().getTime()-o.getTime(),X=Math.floor(E/6e4),L=Math.floor(E/36e5),O=Math.floor(E/864e5);return X<1?r("time.now"):X<60?r("time.minuteAgo",{count:X}):L<24?r("time.hourAgo",{count:L}):O<30?r("time.dayAgo",{count:O}):o.toLocaleDateString("zh-CN")},V=(o,d)=>!o||o.length<=d?o:o.substring(0,d)+"...";return Ce(()=>{f.loadPlanTemplateList()}),s({loadPlanTemplateList:f.loadPlanTemplateList,toggleSidebar:f.toggleSidebar,currentPlanTemplateId:f.currentPlanTemplateId}),(o,d)=>(h(),g("div",{class:te(["sidebar-wrapper",{"sidebar-wrapper-collapsed":l(f).isCollapsed}])},[e("div",gt,[e("div",mt,[e("div",vt,i(o.$t("sidebar.title")),1)]),e("div",ft,[e("button",{class:te(["tab-button",{active:l(f).currentTab==="list"}]),onClick:d[0]||(d[0]=E=>l(f).switchToTab("list"))},[k(l($),{icon:"carbon:list",width:"16"}),Y(" "+i(o.$t("sidebar.templateList")),1)],2),e("button",{class:te(["tab-button",{active:l(f).currentTab==="config"}]),onClick:d[1]||(d[1]=E=>l(f).switchToTab("config")),disabled:!l(f).selectedTemplate},[k(l($),{icon:"carbon:settings",width:"16"}),Y(" "+i(o.$t("sidebar.configuration")),1)],10,bt)]),l(f).currentTab==="list"?(h(),g("div",kt,[e("div",_t,[e("button",{class:"new-task-btn",onClick:d[2]||(d[2]=E=>l(f).createNewTemplate())},[k(l($),{icon:"carbon:add",width:"16"}),Y(" "+i(o.$t("sidebar.newPlan"))+" ",1),d[11]||(d[11]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",$t,[l(f).isLoading?(h(),g("div",Pt,[k(l($),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,i(o.$t("sidebar.loading")),1)])):l(f).errorMessage?(h(),g("div",Ct,[k(l($),{icon:"carbon:warning",width:"20"}),e("span",null,i(l(f).errorMessage),1),e("button",{onClick:d[3]||(d[3]=(...E)=>l(f).loadPlanTemplateList&&l(f).loadPlanTemplateList(...E)),class:"retry-btn"},i(o.$t("sidebar.retry")),1)])):l(f).planTemplateList.length===0?(h(),g("div",St,[k(l($),{icon:"carbon:document",width:"32"}),e("span",null,i(o.$t("sidebar.noTemplates")),1)])):(h(!0),g(ge,{key:3},fe(l(f).sortedTemplates,E=>(h(),g("div",{key:E.id,class:te(["sidebar-content-list-item",{"sidebar-content-list-item-active":E.id===l(f).currentPlanTemplateId}]),onClick:X=>l(f).selectTemplate(E)},[e("div",Et,[k(l($),{icon:"carbon:document",width:"20"})]),e("div",wt,[e("div",Tt,i(E.title||o.$t("sidebar.unnamedPlan")),1),e("div",It,i(V(E.description||o.$t("sidebar.noDescription"),40)),1)]),e("div",Dt,i(G(new Date(E.updateTime||E.createTime))),1),e("div",xt,[e("button",{class:"delete-task-btn",title:o.$t("sidebar.deleteTemplate"),onClick:ie(X=>l(f).deleteTemplate(E),["stop"])},[k(l($),{icon:"carbon:close",width:"16"})],8,Rt)])],10,yt))),128))])])):l(f).currentTab==="config"?(h(),g("div",At,[l(f).selectedTemplate?(h(),g("div",Mt,[e("div",Nt,[e("div",Ut,[e("h3",null,i(l(f).selectedTemplate.title||o.$t("sidebar.unnamedPlan")),1),e("span",Lt,"ID: "+i(l(f).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:d[4]||(d[4]=E=>l(f).switchToTab("list"))},[k(l($),{icon:"carbon:arrow-left",width:"16"})])]),e("div",Vt,[e("div",qt,[k(l($),{icon:"carbon:generate",width:"16"}),e("span",null,i(o.$t("sidebar.planGenerator")),1)]),e("div",Ft,[re(e("textarea",{"onUpdate:modelValue":d[5]||(d[5]=E=>l(f).generatorPrompt=E),class:"prompt-input",placeholder:o.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,Ot),[[be,l(f).generatorPrompt]]),e("div",Bt,[e("button",{class:"btn btn-primary btn-sm",onClick:I,disabled:l(f).isGenerating||!l(f).generatorPrompt.trim()},[k(l($),{icon:l(f).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:te({spinning:l(f).isGenerating})},null,8,["icon","class"]),Y(" "+i(l(f).isGenerating?o.$t("sidebar.generating"):o.$t("sidebar.generatePlan")),1)],8,Wt),e("button",{class:"btn btn-secondary btn-sm",onClick:D,disabled:l(f).isGenerating||!l(f).generatorPrompt.trim()||!l(f).jsonContent.trim()},[k(l($),{icon:"carbon:edit",width:"14"}),Y(" "+i(o.$t("sidebar.updatePlan")),1)],8,jt)])])]),e("div",Ht,[e("div",Jt,[k(l($),{icon:"carbon:code",width:"16"}),e("span",null,i(o.$t("sidebar.jsonTemplate")),1),e("div",zt,[e("button",{class:"btn btn-sm",onClick:d[6]||(d[6]=(...E)=>l(f).rollbackVersion&&l(f).rollbackVersion(...E)),disabled:!l(f).canRollback,title:o.$t("sidebar.rollback")},[k(l($),{icon:"carbon:undo",width:"14"})],8,Gt),e("button",{class:"btn btn-sm",onClick:d[7]||(d[7]=(...E)=>l(f).restoreVersion&&l(f).restoreVersion(...E)),disabled:!l(f).canRestore,title:o.$t("sidebar.restore")},[k(l($),{icon:"carbon:redo",width:"14"})],8,Xt),e("button",{class:"btn btn-primary btn-sm",onClick:x,disabled:l(f).isGenerating||l(f).isExecuting},[k(l($),{icon:"carbon:save",width:"14"})],8,Kt)])]),re(e("textarea",{"onUpdate:modelValue":d[8]||(d[8]=E=>v.value=E),class:"json-editor",placeholder:o.$t("sidebar.jsonPlaceholder"),rows:"12"},null,8,Qt),[[be,v.value]])]),e("div",Yt,[e("div",Zt,[k(l($),{icon:"carbon:play",width:"16"}),e("span",null,i(o.$t("sidebar.executionController")),1)]),e("div",en,[e("div",tn,[e("label",null,i(o.$t("sidebar.executionParams")),1),e("div",nn,i(o.$t("sidebar.executionParamsHelp")),1),e("div",sn,[re(e("input",{"onUpdate:modelValue":d[9]||(d[9]=E=>l(f).executionParams=E),class:"params-input",placeholder:o.$t("sidebar.executionParamsPlaceholder")},null,8,on),[[be,l(f).executionParams]]),e("button",{class:"clear-params-btn",onClick:d[10]||(d[10]=(...E)=>l(f).clearExecutionParams&&l(f).clearExecutionParams(...E)),title:o.$t("sidebar.clearParams")},[k(l($),{icon:"carbon:close",width:"12"})],8,an)])]),e("div",ln,[e("span",cn,i(o.$t("sidebar.apiUrl"))+":",1),e("code",rn,i(l(f).computedApiUrl),1)]),e("div",un,[e("span",dn,i(o.$t("sidebar.statusApiUrl"))+":",1),d[12]||(d[12]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:K,disabled:l(f).isExecuting||l(f).isGenerating},[k(l($),{icon:l(f).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:te({spinning:l(f).isExecuting})},null,8,["icon","class"]),Y(" "+i(l(f).isExecuting?o.$t("sidebar.executing"):o.$t("sidebar.executePlan")),1)],8,pn)])])])):B("",!0)])):B("",!0)])],2))}}),gn=Se(hn,[["__scopeId","data-v-f6e5726e"]]);class Le{static async sendMessage(s){const a=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:s})});if(!a.ok)throw new Error(`API request failed: ${a.status}`);return await a.json()}}he(Le,"BASE_URL","/api/executor");class Ve{static async getDetails(s){try{const a=await fetch(`${this.BASE_URL}/details/${s}`);if(a.status===404)return null;if(!a.ok)throw new Error(`Failed to get detailed information: ${a.status}`);const r=await a.text(),T=JSON.parse(r);return T&&typeof T=="object"&&!T.currentPlanId&&(T.currentPlanId=s),T}catch(a){return console.error("[CommonApiService] Failed to get plan details:",a),null}}static async submitFormInput(s,a){const r=await fetch(`${this.BASE_URL}/submit-input/${s}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!r.ok){let v;try{v=await r.json()}catch{v={message:`Failed to submit form input: ${r.status}`}}throw new Error(v.message||`Failed to submit form input: ${r.status}`)}const T=r.headers.get("content-type");return T&&T.indexOf("application/json")!==-1?await r.json():{success:!0}}static async getAllPrompts(){try{const s=await fetch(this.BASE_URL);return await(await this.handleResponse(s)).json()}catch(s){throw console.error("Failed to get Prompt list:",s),s}}static async handleResponse(s){if(!s.ok)try{const a=await s.json();throw new Error(a.message||`API request failed: ${s.status}`)}catch{throw new Error(`API request failed: ${s.status} ${s.statusText}`)}return s}}he(Ve,"BASE_URL","/api/executor");const $e=class $e{constructor(){he(this,"POLL_INTERVAL",5e3);he(this,"state",ot({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));he(this,"callbacks",{});he(this,"planExecutionCache",new Map);he(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(s){return this.planExecutionCache.get(s)}getCachedUIState(s){return this.uiStateCache.get(s)}setCachedUIState(s,a){this.uiStateCache.set(s,a),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${s}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(s){return this.planExecutionCache.has(s)}setCachedPlanRecord(s,a){this.planExecutionCache.set(s,a),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${s}`)}clearCachedPlanRecord(s){const a=this.planExecutionCache.delete(s);return a&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${s}`),a}clearAllCachedRecords(){const s=this.planExecutionCache.size,a=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${s}, UI States: ${a}`)}static getInstance(){return $e.instance||($e.instance=new $e),$e.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(s){this.callbacks={...this.callbacks,...s},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(s))}async handleUserMessageSendRequested(s){if(this.validateAndPrepareUIForNewRequest(s))try{if(await this.sendUserMessageAndSetPlanId(s),this.state.activePlanId)this.initiatePlanExecutionSequence(s,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(a){console.error("[PlanExecutionManager] Failed to send user message:",a);const r=this.state.activePlanId??"error";this.setCachedUIState(r,{enabled:!0}),this.emitChatInputUpdateState(r),this.state.activePlanId=null}}handlePlanExecutionRequested(s,a){console.log("[PlanExecutionManager] Received plan execution request:",{planId:s,query:a}),s?(this.state.activePlanId=s,this.initiatePlanExecutionSequence(a??"执行计划",s)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(s,a){const r=this.getCachedPlanRecord(s);return r!=null&&r.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${s}`),this.handlePlanExecutionRequested(r.currentPlanId,a),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${s}`),!1)}validateAndPrepareUIForNewRequest(s){if(!s)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const a=this.state.activePlanId??"ui-state";return this.setCachedUIState(a,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(a),!0}async sendUserMessageAndSetPlanId(s){try{const a=await Le.sendMessage(s);if(a!=null&&a.planId)return this.state.activePlanId=a.planId,a;if(a!=null&&a.planTemplateId)return this.state.activePlanId=a.planTemplateId,{...a,planId:a.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",a),new Error("Failed to get valid planId from API response")}catch(a){throw console.error("[PlanExecutionManager] API call failed:",a),a}}initiatePlanExecutionSequence(s,a){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${s}", planId: ${a}`);const r=a;this.emitDialogRoundStart(r),this.startPolling()}handlePlanCompletion(s){this.emitPlanCompleted(s.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await Me.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(a){console.log(`Delete plan execution record failed: ${a.message}`)}},5e3)}catch(a){console.log(`Delete plan execution record failed: ${a.message}`)}s.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(s.rootPlanId??""))}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const s=await this.getPlanDetails(this.state.activePlanId);if(!s){console.warn("[PlanExecutionManager] No details received from API");return}if(s.rootPlanId&&this.setCachedPlanRecord(s.rootPlanId,s),!s.steps||s.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(s.rootPlanId??""),this.handlePlanCompletion(s);return}this.emitPlanUpdate(s.rootPlanId??""),s.completed&&this.handlePlanCompletion(s)}catch(s){console.error("[PlanExecutionManager] Failed to poll plan status:",s)}finally{this.state.isPolling=!1}}}async getPlanDetails(s){try{const a=await Ve.getDetails(s);return a!=null&&a.rootPlanId&&(this.planExecutionCache.set(a.rootPlanId,a),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${a.rootPlanId}`)),a}catch(a){return console.error("[PlanExecutionManager] Failed to get plan details:",a),null}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(s){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(s)}emitDialogRoundStart(s){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(s)}emitPlanUpdate(s){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(s)}emitPlanCompleted(s){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(s)}};he($e,"instance",null);let Ue=$e;const oe=Ue.getInstance(),mn={class:"right-panel"},vn={class:"preview-header"},fn={class:"preview-tabs"},bn={class:"tab-button active"},kn={class:"preview-content"},_n={class:"step-details"},$n={key:0,class:"step-info-fixed"},Pn={key:0,class:"agent-info"},Cn={class:"info-item"},Sn={class:"label"},yn={class:"value"},En={class:"info-item"},wn={class:"label"},Tn={class:"value"},In={class:"info-item"},Dn={class:"label"},xn={class:"value"},Rn={class:"info-item"},An={class:"label"},Mn={class:"value"},Nn={class:"info-item"},Un={class:"label"},Ln={class:"execution-status"},Vn={class:"status-item"},qn={class:"status-text"},Fn={key:0},On={key:0,class:"think-act-steps"},Bn={class:"steps-container"},Wn={class:"step-header"},jn={class:"step-number"},Hn={class:"think-section"},Jn={class:"think-content"},zn={class:"input"},Gn={class:"label"},Xn={class:"output"},Kn={class:"label"},Qn={key:0,class:"action-section"},Yn={class:"action-content"},Zn={class:"tool-info"},es={class:"label"},ts={class:"value"},ns={class:"input"},ss={class:"label"},os={class:"output"},as={class:"label"},ls={key:0,class:"sub-plan-section"},is={class:"sub-plan-content"},cs={class:"sub-plan-header"},rs={class:"sub-plan-info"},us={class:"value"},ds={key:0,class:"sub-plan-info"},ps={class:"value"},hs={class:"sub-plan-status"},gs={class:"status-text"},ms={key:0,class:"no-steps-message"},vs={key:1,class:"no-execution-message"},fs={class:"step-basic-info"},bs={class:"info-item"},ks={class:"label"},_s={class:"value"},$s={key:0,class:"info-item"},Ps={class:"value"},Cs={class:"info-item"},Ss={class:"no-execution-hint"},ys={key:2,class:"execution-indicator"},Es={class:"execution-text"},ws={key:1,class:"no-selection"},Ts=["title"],Is=Pe({__name:"index",setup(w,{expose:s}){const{t:a}=Te(),r=R(),T=R(),v=R(),_=R(null),x=R(!1),I=R(!0),D=R(!0),K=ke(()=>v.value?v.value.completed?a("rightPanel.status.completed"):v.value.current?a("rightPanel.status.executing"):a("rightPanel.status.waiting"):""),G=C=>{var F;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${C}`),v.value&&_.value){const A=_.value.rootPlanId??T.value;if(A&&A!==C){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${A}, Requested: ${C}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${C}`);const P=oe.getCachedPlanRecord(C);if(!P){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${C}`);return}if(P.steps&&P.steps.length>0){const A=P.steps.length,y=(P.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${y} / ${A}`)}if(v.value&&T.value&&(T.value===C||((F=_.value)==null?void 0:F.rootPlanId)===C)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${C}`),_.value)){const y=_.value,M=o(y.planId,y.rootPlanId,y.subPlanId);M?(d(M,y.stepIndex,y.planId,y.isSubPlan),q()):console.warn("[RightPanel] Could not find plan record for refresh:",y)}},V=(C,P,F,A,y)=>{console.log("[RightPanel] Step selected:",{planId:C,stepIndex:P,rootPlanId:F,subPlanId:A,subStepIndex:y});const M=!!(F&&A&&y!==void 0);_.value={planId:C,stepIndex:P,isSubPlan:M,...M&&{rootPlanId:F,subPlanId:A,subStepIndex:y}};const ee=o(C,F,A);if(!ee){console.warn("[RightPanel] Plan data not found:",{planId:C,rootPlanId:F,subPlanId:A}),v.value=null,_.value=null;return}d(ee,P,C,M)},o=(C,P,F)=>{var M;if(!P||!F)return oe.getCachedPlanRecord(C)??null;const A=oe.getCachedPlanRecord(C);if(A)return A;const y=oe.getCachedPlanRecord(P);if(!(y!=null&&y.agentExecutionSequence))return null;for(const ee of y.agentExecutionSequence)if(ee.thinkActSteps){for(const se of ee.thinkActSteps)if(((M=se.subPlanExecutionRecord)==null?void 0:M.currentPlanId)===F)return se.subPlanExecutionRecord}return null},d=(C,P,F,A)=>{var de,b,m,u,S;if(!C.steps||P>=C.steps.length){v.value=null,_.value=null,console.warn("[RightPanel] Invalid step data:",{planId:F,stepIndex:P,hasSteps:!!C.steps,stepsLength:(de=C.steps)==null?void 0:de.length,message:"Invalid step index"});return}T.value=F;const y=C.steps[P],M=(b=C.agentExecutionSequence)==null?void 0:b[P];console.log("[RightPanel] Step data details:",{planId:F,stepIndex:P,step:y,hasAgentExecutionSequence:!!C.agentExecutionSequence,agentExecutionSequenceLength:(m=C.agentExecutionSequence)==null?void 0:m.length,agentExecution:M,hasThinkActSteps:!!(M!=null&&M.thinkActSteps),thinkActStepsLength:(u=M==null?void 0:M.thinkActSteps)==null?void 0:u.length,isSubPlan:A});const ee=(M==null?void 0:M.status)==="FINISHED",se=!ee&&P===C.currentStepIndex&&!C.completed,ve={planId:F,index:P,title:typeof y=="string"?y:y.title||y.description||y.name||`${A?"子":""}步骤 ${P+1}`,description:typeof y=="string"?y:y.description||y,completed:ee,current:se};M&&(ve.agentExecution=M),v.value=ve,console.log("[RightPanel] Step details updated:",{planId:F,stepIndex:P,stepTitle:v.value.title,hasAgentExecution:!!M,hasThinkActSteps:(((S=M==null?void 0:M.thinkActSteps)==null?void 0:S.length)??0)>0,completed:ee,current:se,planCurrentStep:C.currentStepIndex,planCompleted:C.completed,isSubPlan:A}),M!=null&&M.thinkActSteps&&M.thinkActSteps.forEach((t,n)=>{t.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${n}:`,t.subPlanExecutionRecord)}),setTimeout(()=>{L()},100),q()},E=(C,P,F,A)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:C,subPlanId:P,stepIndex:F,subStepIndex:A}),V(P,A,C,P,A)},X=C=>{r.value=C??void 0},L=()=>{if(!r.value)return;const{scrollTop:C,scrollHeight:P,clientHeight:F}=r.value,A=P-C-F<50,y=P>F;I.value=A,x.value=y&&!A,A?D.value=!0:P-C-F>100&&(D.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:C,scrollHeight:P,clientHeight:F,isAtBottom:A,hasScrollableContent:y,showButton:x.value,shouldAutoScroll:D.value})},O=()=>{r.value&&(r.value.scrollTo({top:r.value.scrollHeight,behavior:"smooth"}),ne(()=>{D.value=!0,L()}))},q=()=>{!D.value||!r.value||ne(()=>{r.value&&(r.value.scrollTop=r.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},Q=C=>{if(C===null||typeof C>"u"||C==="")return"N/A";try{const P=typeof C=="object"?C:JSON.parse(C);return JSON.stringify(P,null,2)}catch{return String(C)}},me=()=>{v.value=null,T.value=void 0,D.value=!0,r.value&&r.value.removeEventListener("scroll",L)},ue=()=>{const C=()=>{const P=r.value;return P?(X(P),P.addEventListener("scroll",L),D.value=!0,L(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};ne(()=>{C()||setTimeout(()=>{C()},100)})};return Ce(()=>{console.log("[RightPanel] Component mounted"),ne(()=>{ue()})}),Ie(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),_.value=null,me()}),s({updateDisplayedPlanProgress:G,handleStepSelected:V,handleSubPlanStepSelected:E}),(C,P)=>{var F,A;return h(),g("div",mn,[e("div",vn,[e("div",fn,[e("button",bn,[k(l($),{icon:"carbon:events"}),Y(" "+i(l(a)("rightPanel.stepExecutionDetails")),1)])])]),e("div",kn,[e("div",_n,[v.value?(h(),g("div",$n,[e("h3",null,i(v.value.title||v.value.description||l(a)("rightPanel.defaultStepTitle",{number:v.value.index+1})),1),v.value.agentExecution?(h(),g("div",Pn,[e("div",Cn,[e("span",Sn,i(l(a)("rightPanel.executingAgent"))+":",1),e("span",yn,i(v.value.agentExecution.agentName),1)]),e("div",En,[e("span",wn,i(l(a)("rightPanel.description"))+":",1),e("span",Tn,i(v.value.agentExecution.agentDescription||""),1)]),e("div",In,[e("span",Dn,i(l(a)("rightPanel.callingModel"))+":",1),e("span",xn,i(v.value.agentExecution.modelName),1)]),e("div",Rn,[e("span",An,i(l(a)("rightPanel.request"))+":",1),e("span",Mn,i(v.value.agentExecution.agentRequest||""),1)]),e("div",Nn,[e("span",Un,i(l(a)("rightPanel.executionResult"))+":",1),e("span",{class:te(["value",{success:v.value.agentExecution.status==="FINISHED"}])},i(v.value.agentExecution.status||l(a)("rightPanel.executing")),3)])])):B("",!0),e("div",Ln,[e("div",Vn,[v.value.completed?(h(),ce(l($),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):v.value.current?(h(),ce(l($),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(h(),ce(l($),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",qn,i(K.value),1)])])])):B("",!0),e("div",{ref_key:"scrollContainer",ref:r,class:"step-details-scroll-container",onScroll:L},[v.value?(h(),g("div",Fn,[(F=v.value.agentExecution)!=null&&F.thinkActSteps&&v.value.agentExecution.thinkActSteps.length>0?(h(),g("div",On,[e("h4",null,i(l(a)("rightPanel.thinkAndActionSteps")),1),e("div",Bn,[(h(!0),g(ge,null,fe(v.value.agentExecution.thinkActSteps,(y,M)=>(h(),g("div",{key:M,class:"think-act-step"},[e("div",Wn,[e("span",jn,"#"+i(M+1),1),e("span",{class:te(["step-status",y.status])},i(y.status||l(a)("rightPanel.executing")),3)]),e("div",Hn,[e("h5",null,[k(l($),{icon:"carbon:thinking"}),Y(" "+i(l(a)("rightPanel.thinking")),1)]),e("div",Jn,[e("div",zn,[e("span",Gn,i(l(a)("rightPanel.input"))+":",1),e("pre",null,i(Q(y.thinkInput)),1)]),e("div",Xn,[e("span",Kn,i(l(a)("rightPanel.output"))+":",1),e("pre",null,i(Q(y.thinkOutput)),1)])])]),y.actionNeeded?(h(),g("div",Qn,[e("h5",null,[k(l($),{icon:"carbon:play"}),Y(" "+i(l(a)("rightPanel.action")),1)]),e("div",Yn,[(h(!0),g(ge,null,fe(y.actToolInfoList,(ee,se)=>(h(),g("div",{key:se},[e("div",Zn,[e("span",es,i(l(a)("rightPanel.tool"))+":",1),e("span",ts,i(ee.name||""),1)]),e("div",ns,[e("span",ss,i(l(a)("rightPanel.toolParameters"))+":",1),e("pre",null,i(Q(ee.parameters)),1)]),e("div",os,[e("span",as,i(l(a)("rightPanel.executionResult"))+":",1),e("pre",null,i(Q(ee.result)),1)])]))),128))]),y.subPlanExecutionRecord?(h(),g("div",ls,[e("h5",null,[k(l($),{icon:"carbon:tree-view"}),Y(" "+i(l(a)("rightPanel.subPlan")),1)]),e("div",is,[e("div",cs,[e("div",rs,[P[0]||(P[0]=e("span",{class:"label"},"子计划ID:",-1)),e("span",us,i(y.subPlanExecutionRecord.currentPlanId),1)]),y.subPlanExecutionRecord.title?(h(),g("div",ds,[P[1]||(P[1]=e("span",{class:"label"},"标题:",-1)),e("span",ps,i(y.subPlanExecutionRecord.title),1)])):B("",!0),e("div",hs,[y.subPlanExecutionRecord.completed?(h(),ce(l($),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(h(),ce(l($),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",gs,i(y.subPlanExecutionRecord.completed?"已完成":"执行中"),1)])])])])):B("",!0)])):B("",!0)]))),128))]),v.value.agentExecution&&!((A=v.value.agentExecution.thinkActSteps)!=null&&A.length)?(h(),g("div",ms,[e("p",null,i(l(a)("rightPanel.noStepDetails")),1)])):v.value.agentExecution?B("",!0):(h(),g("div",vs,[k(l($),{icon:"carbon:information",class:"info-icon"}),e("h4",null,i(l(a)("rightPanel.stepInfo")),1),e("div",fs,[e("div",bs,[e("span",ks,i(l(a)("rightPanel.stepName"))+":",1),e("span",_s,i(v.value.title||v.value.description||`步骤 ${v.value.index+1}`),1)]),v.value.description?(h(),g("div",$s,[P[2]||(P[2]=e("span",{class:"label"},"描述:",-1)),e("span",Ps,i(v.value.description),1)])):B("",!0),e("div",Cs,[P[3]||(P[3]=e("span",{class:"label"},"状态:",-1)),e("span",{class:te(["value",{"status-completed":v.value.completed,"status-current":v.value.current,"status-pending":!v.value.completed&&!v.value.current}])},i(v.value.completed?"已完成":v.value.current?"执行中":"待执行"),3)])]),e("p",Ss,i(l(a)("rightPanel.noExecutionInfo")),1)])),v.value.current&&!v.value.completed?(h(),g("div",ys,[P[4]||(P[4]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",Es,[k(l($),{icon:"carbon:in-progress",class:"rotating-icon"}),Y(" "+i(l(a)("rightPanel.stepExecuting")),1)])])):B("",!0)])):(h(),g("div",ws,[k(l($),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,i(l(a)("rightPanel.noStepSelected")),1),e("p",null,i(l(a)("rightPanel.selectStepHint")),1)]))])):B("",!0),k(De,{name:"scroll-button"},{default:xe(()=>[x.value?(h(),g("button",{key:0,onClick:O,class:"scroll-to-bottom-btn",title:l(a)("rightPanel.scrollToBottom")},[k(l($),{icon:"carbon:chevron-down"})],8,Ts)):B("",!0)]),_:1})],544)])])])}}}),Ds=Se(Is,[["__scopeId","data-v-e90596ce"]]);function xs(){const w=oe,s=ke(()=>w.getActivePlanId()),a=ke(()=>w.getState()),r=ke(()=>a.value.isPolling),T=ke(()=>!!s.value),v=(D,K)=>{w.initiatePlanExecutionSequence(D,K)},_=()=>{w.stopPolling()},x=()=>{w.startPolling()},I=()=>{w.cleanup()};return Ie(()=>{I()}),{activePlanId:s,state:a,isPolling:r,hasActivePlan:T,startExecution:v,stopPolling:_,startPolling:x,cleanup:I}}const Rs={class:"chat-container"},As={class:"message-content"},Ms={key:0,class:"user-message"},Ns={key:1,class:"assistant-message"},Us={key:0,class:"thinking-section"},Ls={class:"thinking-header"},Vs={class:"thinking-avatar"},qs={class:"thinking-label"},Fs={class:"thinking-content"},Os={key:0,class:"thinking"},Bs={key:1,class:"progress"},Ws={class:"progress-bar"},js={class:"progress-text"},Hs={key:2,class:"steps-container"},Js={class:"steps-title"},zs=["onClick"],Gs={class:"section-header"},Xs={class:"step-icon"},Ks={class:"step-title"},Qs={key:0,class:"step-status current"},Ys={key:1,class:"step-status completed"},Zs={key:2,class:"step-status pending"},eo={key:0,class:"action-info"},to={class:"action-description"},no={class:"action-icon"},so={key:0,class:"tool-params"},oo={class:"param-label"},ao={class:"param-content"},lo={key:1,class:"think-details"},io={class:"think-header"},co={class:"think-label"},ro={class:"think-output"},uo={class:"think-content"},po={key:1,class:"sub-plan-steps"},ho={class:"sub-plan-header"},go={class:"sub-plan-step-list"},mo=["onClick"],vo={class:"sub-step-indicator"},fo={class:"sub-step-icon"},bo={class:"sub-step-number"},ko={class:"sub-step-content"},_o={class:"sub-step-title"},$o={key:2,class:"user-input-form-container"},Po={class:"user-input-message"},Co={key:0,class:"form-description"},So=["onSubmit"],yo=["for"],Eo=["id","name","onUpdate:modelValue"],wo={key:1,class:"form-group"},To={for:"form-input-genericInput"},Io=["onUpdate:modelValue"],Do={type:"submit",class:"submit-user-input-btn"},xo={key:3,class:"default-processing"},Ro={class:"processing-indicator"},Ao={class:"response-section"},Mo={class:"response-header"},No={class:"response-avatar"},Uo={class:"response-name"},Lo={class:"response-content"},Vo={key:0,class:"final-response"},qo=["innerHTML"],Fo={key:1,class:"response-placeholder"},Oo={class:"typing-indicator"},Bo={class:"typing-text"},Wo={key:0,class:"message assistant"},jo={class:"message-content"},Ho={class:"assistant-message"},Jo={class:"thinking-section"},zo={class:"thinking-header"},Go={class:"thinking-avatar"},Xo={class:"thinking-label"},Ko={class:"thinking-content"},Qo={class:"default-processing"},Yo={class:"processing-indicator"},Zo={class:"response-section"},ea={class:"response-header"},ta={class:"response-avatar"},na={class:"response-name"},sa={class:"response-content"},oa={class:"response-placeholder"},aa={class:"typing-indicator"},la={class:"typing-text"},ia=["title"],ca=Pe({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(w,{expose:s,emit:a}){const r=w,T=a,{t:v}=Te(),_=xs(),x=R(),I=R(!1),D=R([]),K=R(),G=R(!1),V=ot({}),o=(t,n,c)=>{const p={id:Date.now().toString(),type:t,content:n,timestamp:new Date,...c};return t==="assistant"&&!p.thinking&&!p.content&&(p.thinking=v("chat.thinking")),D.value.push(p),p},d=t=>{const n=D.value[D.value.length-1];n.type==="assistant"&&Object.assign(n,t)},E=async t=>{try{I.value=!0;const n=o("assistant","",{thinking:"正在理解您的请求并准备回复..."}),c=await Le.sendMessage(t);if(c.planId)console.log("[ChatComponent] Received planId from direct execution:",c.planId),n.planExecution||(n.planExecution={}),n.planExecution.currentPlanId=c.planId,oe.handlePlanExecutionRequested(c.planId,t),delete n.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete n.thinking;const p=X(c,t);n.content=p}}catch(n){console.error("Direct mode error:",n),d({content:L(n)})}finally{I.value=!1}},X=(t,n)=>t.result??t.message??t.content??"",L=t=>{const n=(t==null?void 0:t.message)??(t==null?void 0:t.toString())??"未知错误";return n.includes("网络")||n.includes("network")||n.includes("timeout")?"抱歉，似乎网络连接有些问题。请检查您的网络连接后再试一次，或者稍等几分钟再重新提问。":n.includes("认证")||n.includes("权限")||n.includes("auth")?"抱歉，访问权限出现了问题。这可能是系统配置的问题，请联系管理员或稍后再试。":n.includes("格式")||n.includes("参数")||n.includes("invalid")?"抱歉，您的请求格式可能有些问题。能否请您重新表述一下您的需求？我会尽力理解并帮助您。":`抱歉，处理您的请求时遇到了一些问题（${n}）。请稍后再试，或者换个方式表达您的需求，我会尽力帮助您的。`},O=(t=!1)=>{ne(()=>{if(x.value){const n=x.value;(t||n.scrollHeight-n.scrollTop-n.clientHeight<150)&&n.scrollTo({top:n.scrollHeight,behavior:t?"auto":"smooth"})}})},q=()=>{O(!0),G.value=!1},Q=()=>{if(x.value){const t=x.value,n=t.scrollHeight-t.scrollTop-t.clientHeight<150;G.value=!n&&D.value.length>0}},me=()=>{x.value&&x.value.addEventListener("scroll",Q)},ue=()=>{x.value&&x.value.removeEventListener("scroll",Q)},C=t=>{o("user",t),r.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",t):E(t)},P=(t,n)=>{var W;const c=((W=t.planExecution)==null?void 0:W.agentExecutionSequence)??[];return n<0||n>=c.length?"IDLE":c[n].status??"IDLE"},F=(t,n)=>{var c,p;if(!((c=t.planExecution)!=null&&c.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:t.planExecution.currentPlanId,stepIndex:n,stepTitle:(p=t.planExecution.steps)==null?void 0:p[n]}),T("step-selected",t.planExecution.currentPlanId,n)},A=(t,n)=>{var c;try{const p=(c=t.planExecution)==null?void 0:c.agentExecutionSequence;if(!(p!=null&&p.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const W=p[n];if(!W)return console.log(`[ChatComponent] No agentExecution found for step ${n}`),[];if(!W.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${n}`),[];for(const U of W.thinkActSteps)if(U.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${n}:`,U.subPlanExecutionRecord),(U.subPlanExecutionRecord.steps??[]).map(j=>typeof j=="string"?j:typeof j=="object"&&j!==null&&(j.title||j.description)||"子步骤");return[]}catch(p){return console.warn("[ChatComponent] Error getting sub-plan steps:",p),[]}},y=(t,n,c)=>{var p;try{const W=(p=t.planExecution)==null?void 0:p.agentExecutionSequence;if(!(W!=null&&W.length))return"pending";const U=W[n];if(!U||!U.thinkActSteps)return"pending";let Z=null;for(const H of U.thinkActSteps)if(H.subPlanExecutionRecord){Z=H.subPlanExecutionRecord;break}if(!Z)return"pending";const j=Z.currentStepIndex;return Z.completed?"completed":j==null?c===0?"current":"pending":c<j?"completed":c===j?"current":"pending"}catch(W){return console.warn("[ChatComponent] Error getting sub-plan step status:",W),"pending"}},M=(t,n,c)=>{var p,W;try{const U=(p=t.planExecution)==null?void 0:p.agentExecutionSequence;if(!(U!=null&&U.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const Z=U[n];if(!Z){console.warn("[ChatComponent] No agentExecution found for step",n);return}if(!Z.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",n);return}let j=null;for(const H of Z.thinkActSteps)if(H.subPlanExecutionRecord){j=H.subPlanExecutionRecord;break}if(!(j!=null&&j.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}T("sub-plan-step-selected",((W=t.planExecution)==null?void 0:W.currentPlanId)??"",j.currentPlanId,n,c)}catch(U){console.error("[ChatComponent] Error handling sub-plan step click:",U)}},ee=(t,n)=>{var p,W,U,Z;if(!((p=t.planExecution)!=null&&p.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",t.planExecution.steps.length,"execution sequence:",((W=n.agentExecutionSequence)==null?void 0:W.length)??0);const c=new Array(t.planExecution.steps.length).fill(null);if((U=n.agentExecutionSequence)!=null&&U.length){const j=Math.min(n.agentExecutionSequence.length,t.planExecution.steps.length);for(let H=0;H<j;H++){const N=n.agentExecutionSequence[H];if((Z=N.thinkActSteps)!=null&&Z.length){const J=N.thinkActSteps[N.thinkActSteps.length-1];J.actionDescription&&J.toolParameters?(c[H]={actionDescription:J.actionDescription,toolParameters:typeof J.toolParameters=="string"?J.toolParameters:JSON.stringify(J.toolParameters,null,2),thinkInput:J.thinkInput??"",thinkOutput:J.thinkOutput??"",status:n.currentStepIndex!==void 0&&H<n.currentStepIndex?"completed":n.currentStepIndex!==void 0&&H===n.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${H} action set: ${c[H].actionDescription}`)):(c[H]={actionDescription:"思考中",toolParameters:"等待决策",thinkInput:J.thinkInput??"",thinkOutput:J.thinkOutput??"",status:n.currentStepIndex!==void 0&&H===n.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${H} is thinking`))}else c[H]={actionDescription:n.currentStepIndex!==void 0&&H<n.currentStepIndex?"已完成":"等待中",toolParameters:"无工具参数",thinkInput:"",thinkOutput:"",status:n.currentStepIndex!==void 0&&H<n.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] 步骤 ${H} 无执行细节, 状态设为: ${c[H].status}`)}}else console.log("[ChatComponent] 没有执行序列数据");t.stepActions=[...c],console.log("[ChatComponent] 步骤动作更新完成:",JSON.stringify(c.map(j=>j==null?void 0:j.actionDescription))),ne(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},se=t=>{console.log("[ChatComponent] Starting dialog round with planId:",t),t&&(D.value.findIndex(c=>{var p;return((p=c.planExecution)==null?void 0:p.currentPlanId)===t&&c.type==="assistant"})===-1?(o("assistant","",{planExecution:{currentPlanId:t},thinking:"正在准备执行计划..."}),console.log("[ChatComponent] Created new assistant message for planId:",t)):console.log("[ChatComponent] Found existing assistant message for planId:",t))},ve=t=>{var U,Z,j,H;console.log("[ChatComponent] Processing plan update with rootPlanId:",t);const n=oe.getCachedPlanRecord(t);if(!n){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",t);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",n),console.log("[ChatComponent] Plan steps:",n.steps),console.log("[ChatComponent] Plan completed:",n.completed),!n.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const c=D.value.findIndex(N=>{var J;return((J=N.planExecution)==null?void 0:J.currentPlanId)===n.currentPlanId&&N.type==="assistant"});let p;if(c!==-1)p=D.value[c],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",n.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",n.currentPlanId),console.log("[ChatComponent] Current messages:",D.value.map(J=>{var ae;return{type:J.type,planId:(ae=J.planExecution)==null?void 0:ae.currentPlanId,content:J.content.substring(0,50)}}));let N=-1;for(let J=D.value.length-1;J>=0;J--)if(D.value[J].type==="assistant"){N=J;break}if(N!==-1)p=D.value[N],p.planExecution||(p.planExecution={}),p.planExecution.currentPlanId=n.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",n.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(p.planExecution||(p.planExecution={}),p.planExecution=JSON.parse(JSON.stringify(n)),!n.steps||n.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),n.completed){delete p.thinking;const N=n.summary??n.result??n.message??"处理完成";p.content=de(N),console.log("[ChatComponent] Set simple response content:",p.content)}else n.title&&(p.thinking=`正在执行: ${n.title}`);return}delete p.thinking;const W=n.steps.map(N=>typeof N=="string"?N:typeof N=="object"&&N!==null&&(N.title||N.description)||"步骤");if(p.planExecution&&(p.planExecution.steps=W),n.agentExecutionSequence&&n.agentExecutionSequence.length>0){console.log("[ChatComponent] 发现执行序列数据，数量:",n.agentExecutionSequence.length),ee(p,n);const N=n.currentStepIndex??0;if(N>=0&&N<n.agentExecutionSequence.length){const ae=n.agentExecutionSequence[N].thinkActSteps;if(ae&&ae.length>0){const ye=ae[ae.length-1];if(ye.thinkOutput){const Re=ye.thinkOutput.length>150?ye.thinkOutput.substring(0,150)+"...":ye.thinkOutput;p.thinking=`正在思考: ${Re}`}}}}else if(p.planExecution){const N=p.planExecution.currentStepIndex??0,J=(U=p.planExecution.steps)==null?void 0:U[N],ae=typeof J=="string"?J:"";p.thinking=`正在执行: ${ae}`}if(n.userInputWaitState&&p.planExecution?(console.log("[ChatComponent] 需要用户输入:",n.userInputWaitState),p.planExecution.userInputWaitState||(p.planExecution.userInputWaitState={}),p.planExecution.userInputWaitState={message:n.userInputWaitState.message??"",formDescription:n.userInputWaitState.formDescription??"",formInputs:((Z=n.userInputWaitState.formInputs)==null?void 0:Z.map(N=>({label:N.label,value:N.value||""})))??[]},V[j=p.id]??(V[j]={}),p.thinking="等待用户输入..."):(H=p.planExecution)!=null&&H.userInputWaitState&&delete p.planExecution.userInputWaitState,n.completed??n.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete p.thinking;let N="";n.summary?N=n.summary:n.result?N=n.result:N="任务已完成",p.content=b(N),console.log("[ChatComponent] Updated completed message:",p.content)}ne(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},de=t=>t?t.includes("我")||t.includes("您")||t.includes("您好")||t.includes("可以")?t:t.length<10?`${t}！还有什么需要我帮助的吗？`:t.length<50?`好的，${t}。如果您还有其他问题，请随时告诉我。`:`${t}

希望这个回答对您有帮助！还有什么我可以为您做的吗？`:"我明白了，还有什么我可以帮您的吗？",b=t=>t?`${t}`:"任务已完成！还有什么我可以帮您的吗？",m=t=>{console.log("[ChatComponent] Plan completed with rootPlanId:",t);const n=oe.getCachedPlanRecord(t);if(!n){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",t);return}if(console.log("[ChatComponent] Plan details:",n),n.rootPlanId){const c=D.value.findIndex(p=>{var W;return((W=p.planExecution)==null?void 0:W.currentPlanId)===n.rootPlanId});if(c!==-1){const p=D.value[c];delete p.thinking;let U=n.summary??n.result??"任务已完成";!U.includes("我")&&!U.includes("您")&&(U.includes("成功")||U.includes("完成")?U=`很好！${U}。如果您还有其他需要帮助的地方，请随时告诉我。`:U=`我已经完成了您的请求：${U}`),p.content=U,console.log("[ChatComponent] Updated completed message:",p.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",n.rootPlanId)}},u=t=>{if(!t)return"";let n=t.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return n=n.replace(/(<br><br>)/g,"</p><p>"),n.includes("</p><p>")&&(n=`<p>${n}</p>`),n},S=async t=>{var n;if(!((n=t.planExecution)!=null&&n.currentPlanId)||!t.planExecution.userInputWaitState){console.error("[ChatComponent] 缺少planExecution.currentPlanId或userInputWaitState");return}try{const c={},p=t.planExecution.userInputWaitState.formInputs;p&&p.length>0?Object.entries(V[t.id]).forEach(([U,Z])=>{var N;const j=parseInt(U,10),H=((N=p[j])==null?void 0:N.label)||`input_${U}`;c[H]=Z}):c.genericInput=t.genericInput??"",console.log("[ChatComponent] 提交用户输入:",c);const W=await Ve.submitFormInput(t.planExecution.currentPlanId,c);delete t.planExecution.userInputWaitState,delete t.genericInput,delete V[t.id],_.startPolling(),console.log("[ChatComponent] 用户输入提交成功:",W)}catch(c){console.error("[ChatComponent] 用户输入提交失败:",c),alert(`提交失败: ${(c==null?void 0:c.message)||"未知错误"}`)}};return _e(()=>r.initialPrompt,(t,n)=>{console.log("[ChatComponent] initialPrompt changed from:",n,"to:",t),t&&typeof t=="string"&&t.trim()&&t!==n&&(console.log("[ChatComponent] Processing changed initial prompt:",t),ne(()=>{C(t)}))},{immediate:!1}),Ce(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),oe.setEventCallbacks({onPlanUpdate:ve,onPlanCompleted:m,onDialogRoundStart:se,onChatInputUpdateState:t=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",t)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")}}),ne(()=>{me()}),r.initialPrompt&&typeof r.initialPrompt=="string"&&r.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",r.initialPrompt),ne(()=>{C(r.initialPrompt)}))}),Ie(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),ue(),K.value&&clearInterval(K.value),_.cleanup(),Object.keys(V).forEach(t=>delete V[t])}),s({handleSendMessage:C,handlePlanUpdate:ve,handlePlanCompleted:m,handleDialogRoundStart:se,addMessage:o}),(t,n)=>(h(),g("div",Rs,[e("div",{class:"messages",ref_key:"messagesRef",ref:x},[(h(!0),g(ge,null,fe(D.value,c=>{var p,W,U,Z,j,H,N,J,ae;return h(),g("div",{key:c.id,class:te(["message",{user:c.type==="user",assistant:c.type==="assistant"}])},[e("div",As,[c.type==="user"?(h(),g("div",Ms,i(c.content),1)):(h(),g("div",Ns,[c.thinking||((p=c.planExecution)==null?void 0:p.progress)!==void 0||(((U=(W=c.planExecution)==null?void 0:W.steps)==null?void 0:U.length)??0)>0?(h(),g("div",Us,[e("div",Ls,[e("div",Vs,[k(l($),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",qs,i(t.$t("chat.thinkingLabel")),1)]),e("div",Fs,[c.thinking?(h(),g("div",Os,[k(l($),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,i(c.thinking),1)])):B("",!0),((Z=c.planExecution)==null?void 0:Z.progress)!==void 0?(h(),g("div",Bs,[e("div",Ws,[e("div",{class:"progress-fill",style:Ne({width:c.planExecution.progress+"%"})},null,4)]),e("span",js,i(c.planExecution.progressText??t.$t("chat.processing")+"..."),1)])):B("",!0),(((H=(j=c.planExecution)==null?void 0:j.steps)==null?void 0:H.length)??0)>0?(h(),g("div",Hs,[e("h4",Js,i(t.$t("chat.stepExecutionDetails")),1),(h(!0),g(ge,null,fe((N=c.planExecution)==null?void 0:N.steps,(ye,z)=>{var Re,qe,Fe,Oe,Be,We,je,He,Je,ze,Ge,Xe,Ke,Qe,Ye,Ze,et,tt,nt;return h(),g("div",{key:z,class:te(["ai-section",{running:P(c,z)==="RUNNING",completed:P(c,z)==="FINISHED",pending:P(c,z)==="IDLE"}]),onClick:ie(pe=>F(c,z),["stop"])},[e("div",Gs,[e("span",Xs,i(P(c,z)==="FINISHED"?"✓":P(c,z)==="RUNNING"?"▶":"○"),1),e("span",Ks,i(ye||`${t.$t("chat.step")} ${z+1}`),1),P(c,z)==="RUNNING"?(h(),g("span",Qs,i(t.$t("chat.status.executing")),1)):P(c,z)==="FINISHED"?(h(),g("span",Ys,i(t.$t("chat.status.completed")),1)):(h(),g("span",Zs,i(t.$t("chat.status.pending")),1))]),c.stepActions&&c.stepActions[z]?(h(),g("div",eo,[e("div",to,[e("span",no,i(((Re=c.stepActions[z])==null?void 0:Re.status)==="current"?"🔄":((qe=c.stepActions[z])==null?void 0:qe.status)==="completed"?"✓":"⏳"),1),e("strong",null,i((Fe=c.stepActions[z])==null?void 0:Fe.actionDescription),1)]),(Oe=c.stepActions[z])!=null&&Oe.toolParameters?(h(),g("div",so,[n[0]||(n[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",oo,i(t.$t("common.parameters"))+":",1),e("pre",ao,i((Be=c.stepActions[z])==null?void 0:Be.toolParameters),1)])):B("",!0),(We=c.stepActions[z])!=null&&We.thinkOutput?(h(),g("div",lo,[e("div",io,[n[1]||(n[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",co,i(t.$t("chat.thinkingOutput"))+":",1)]),e("div",ro,[e("pre",uo,i((je=c.stepActions[z])==null?void 0:je.thinkOutput),1)])])):B("",!0)])):B("",!0),((He=A(c,z))==null?void 0:He.length)>0?(h(),g("div",po,[e("div",ho,[k(l($),{icon:"carbon:tree-view",class:"sub-plan-icon"}),n[2]||(n[2]=e("span",{class:"sub-plan-title"},"子执行计划",-1))]),e("div",go,[(h(!0),g(ge,null,fe(A(c,z),(pe,le)=>(h(),g("div",{key:`sub-${z}-${le}`,class:te(["sub-plan-step-item",{completed:y(c,z,le)==="completed",current:y(c,z,le)==="current",pending:y(c,z,le)==="pending"}]),onClick:ie(st=>M(c,z,le),["stop"])},[e("div",vo,[e("span",fo,i(y(c,z,le)==="completed"?"✓":y(c,z,le)==="current"?"▶":"○"),1),e("span",bo,i(le+1),1)]),e("div",ko,[e("span",_o,i(pe),1),n[3]||(n[3]=e("span",{class:"sub-step-badge"},"子步骤",-1))])],10,mo))),128))])])):B("",!0),(Je=c.planExecution)!=null&&Je.userInputWaitState&&P(c,z)==="RUNNING"?(h(),g("div",$o,[e("p",Po,i(((Ge=(ze=c.planExecution)==null?void 0:ze.userInputWaitState)==null?void 0:Ge.message)??t.$t("chat.userInput.message")),1),(Ke=(Xe=c.planExecution)==null?void 0:Xe.userInputWaitState)!=null&&Ke.formDescription?(h(),g("p",Co,i((Ye=(Qe=c.planExecution)==null?void 0:Qe.userInputWaitState)==null?void 0:Ye.formDescription),1)):B("",!0),e("form",{onSubmit:ie(pe=>S(c),["prevent"]),class:"user-input-form"},[(et=(Ze=c.planExecution)==null?void 0:Ze.userInputWaitState)!=null&&et.formInputs&&c.planExecution.userInputWaitState.formInputs.length>0?(h(!0),g(ge,{key:0},fe((nt=(tt=c.planExecution)==null?void 0:tt.userInputWaitState)==null?void 0:nt.formInputs,(pe,le)=>(h(),g("div",{key:le,class:"form-group"},[e("label",{for:`form-input-${pe.label.replace(/\W+/g,"_")}`},i(pe.label)+": ",9,yo),re(e("input",{type:"text",id:`form-input-${pe.label.replace(/\W+/g,"_")}`,name:pe.label,"onUpdate:modelValue":st=>V[c.id][le]=st,class:"form-input"},null,8,Eo),[[be,V[c.id][le]]])]))),128)):(h(),g("div",wo,[e("label",To,i(t.$t("common.input"))+":",1),re(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":pe=>c.genericInput=pe,class:"form-input"},null,8,Io),[[be,c.genericInput]])])),e("button",Do,i(t.$t("chat.userInput.submit")),1)],40,So)])):B("",!0)],10,zs)}),128))])):!c.content&&(c.thinking||((J=c.planExecution)==null?void 0:J.progress)!==void 0&&(((ae=c.planExecution)==null?void 0:ae.progress)??0)<100)?(h(),g("div",xo,[e("div",Ro,[n[4]||(n[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,i(c.thinking??t.$t("chat.thinkingProcessing")),1)])])):B("",!0)])])):B("",!0),e("div",Ao,[e("div",Mo,[e("div",No,[k(l($),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Uo,i(t.$t("chat.botName")),1)]),e("div",Lo,[c.content?(h(),g("div",Vo,[e("div",{class:"response-text",innerHTML:u(c.content)},null,8,qo)])):(h(),g("div",Fo,[e("div",Oo,[n[5]||(n[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Bo,i(t.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),I.value?(h(),g("div",Wo,[e("div",jo,[e("div",Ho,[e("div",Jo,[e("div",zo,[e("div",Go,[k(l($),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Xo,i(t.$t("chat.thinkingLabel")),1)]),e("div",Ko,[e("div",Qo,[e("div",Yo,[n[6]||(n[6]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,i(t.$t("chat.thinking")),1)])])])]),e("div",Zo,[e("div",ea,[e("div",ta,[k(l($),{icon:"carbon:bot",class:"bot-icon"})]),e("div",na,i(t.$t("chat.botName")),1)]),e("div",sa,[e("div",oa,[e("div",aa,[n[7]||(n[7]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",la,i(t.$t("chat.thinkingResponse")),1)])])])])])])])):B("",!0)],512),G.value?(h(),g("div",{key:0,class:"scroll-to-bottom-btn",onClick:q,title:t.$t("chat.scrollToBottom")},[k(l($),{icon:"carbon:chevron-down"})],8,ia)):B("",!0)]))}}),ra=Se(ca,[["__scopeId","data-v-d1fb4f30"]]),ua={class:"input-area"},da={class:"input-container"},pa={class:"attach-btn",title:"附加文件"},ha=["placeholder","disabled"],ga=["title"],ma=["disabled","title"],va=Pe({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1},initialValue:{default:""}},emits:["send","clear","update-state","plan-mode-clicked"],setup(w,{expose:s,emit:a}){const{t:r}=Te(),T=w,v=a,_=R(),x=R(""),I=ke(()=>T.placeholder||r("input.placeholder")),D=R(I.value),K=ke(()=>!!T.disabled),G=()=>{ne(()=>{_.value&&(_.value.style.height="auto",_.value.style.height=Math.min(_.value.scrollHeight,120)+"px")})},V=q=>{q.key==="Enter"&&!q.shiftKey&&(q.preventDefault(),o())},o=()=>{if(!x.value.trim()||K.value)return;const q=x.value.trim();v("send",q),E()},d=()=>{v("plan-mode-clicked")},E=()=>{x.value="",G(),v("clear")},X=(q,Q)=>{Q&&(D.value=q?Q:r("input.waiting")),v("update-state",q,Q)},L=q=>{x.value=q,G()},O=()=>x.value.trim();return _e(()=>T.initialValue,q=>{q&&q.trim()&&(x.value=q,G())},{immediate:!0}),s({clearInput:E,updateState:X,setInputValue:L,getQuery:O,focus:()=>{var q;return(q=_.value)==null?void 0:q.focus()}}),Ce(()=>{}),Ie(()=>{}),(q,Q)=>(h(),g("div",ua,[e("div",da,[e("button",pa,[k(l($),{icon:"carbon:attachment"})]),re(e("textarea",{"onUpdate:modelValue":Q[0]||(Q[0]=me=>x.value=me),ref_key:"inputRef",ref:_,class:"chat-input",placeholder:D.value,disabled:K.value,onKeydown:V,onInput:G},null,40,ha),[[be,x.value]]),e("button",{class:"plan-mode-btn",title:q.$t("input.planMode"),onClick:d},[k(l($),{icon:"carbon:document"}),Y(" "+i(q.$t("input.planMode")),1)],8,ga),e("button",{class:"send-button",disabled:!x.value.trim()||K.value,onClick:o,title:q.$t("input.send")},[k(l($),{icon:"carbon:send-alt"}),Y(" "+i(q.$t("input.send")),1)],8,ma)])]))}}),fa=Se(va,[["__scopeId","data-v-639c8b2a"]]);class Ee{static async getAllCronTasks(){try{const s=await fetch(this.BASE_URL);return await(await this.handleResponse(s)).json()}catch(s){throw console.error("Failed to get cron tasks:",s),s}}static async getCronTaskById(s){try{const a=await fetch(`${this.BASE_URL}/${s}`);return await(await this.handleResponse(a)).json()}catch(a){throw console.error("Failed to get cron task by id:",a),a}}static async createCronTask(s){try{const a=await fetch(this.BASE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});return await(await this.handleResponse(a)).json()}catch(a){throw console.error("Failed to create cron task:",a),a}}static async updateCronTask(s,a){try{const r=await fetch(`${this.BASE_URL}/${s}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});return await(await this.handleResponse(r)).json()}catch(r){throw console.error("Failed to update cron task:",r),r}}static async updateTaskStatus(s,a){try{const r=await fetch(`${this.BASE_URL}/${s}/status?status=${a}`,{method:"PUT"});await this.handleResponse(r)}catch(r){throw console.error("Failed to update task status:",r),r}}static async deleteCronTask(s){try{const a=await fetch(`${this.BASE_URL}/${s}`,{method:"DELETE"});await this.handleResponse(a)}catch(a){throw console.error("Failed to delete cron task:",a),a}}static async handleResponse(s){if(!s.ok)try{const a=await s.json();throw new Error(a.message||`API request failed: ${s.status}`)}catch{throw new Error(`API request failed: ${s.status} ${s.statusText}`)}return s}}he(Ee,"BASE_URL","/api/cron-tasks");const we={validateCronExpression(w){const s=w.trim().split(/\s+/);return s.length>=5&&s.length<=6},formatTime(w){return new Date(w).toLocaleString()},async saveTask(w){try{let s;return w.id?s=await Ee.updateCronTask(Number(w.id),w):s=await Ee.createCronTask(w),s}catch(s){throw console.error("Failed to save cron task:",s),s}},async deleteTask(w){try{await Ee.deleteCronTask(String(w))}catch(s){throw console.error("Failed to delete cron task:",s),s}},async toggleTaskStatus(w){if(!w.id)throw new Error("Task ID is required");const s=w.status===0?1:0;return await Ee.updateCronTask(Number(w.id),{...w,status:s})},prepareTaskExecution(w){return w.planTemplateId?{useTemplate:!0,planData:{title:w.cronName||"定时任务执行",planData:{id:w.planTemplateId,planTemplateId:w.planTemplateId,planId:w.planTemplateId},params:w.executionParams||void 0}}:{useTemplate:!1,taskContent:w.planDesc||w.cronName||""}}},ba={class:"modal-header"},ka={class:"header-actions"},_a={class:"status-switch"},$a={class:"status-label"},Pa={class:"toggle-switch"},Ca=["checked"],Sa={class:"modal-content"},ya={class:"form-group"},Ea={class:"form-label"},wa=["placeholder"],Ta={class:"form-group"},Ia={class:"form-label"},Da=["placeholder"],xa={class:"form-help"},Ra={class:"form-group"},Aa={class:"form-label"},Ma=["placeholder"],Na={class:"form-group"},Ua={class:"form-label"},La={class:"template-toggle"},Va={key:0,class:"template-selector"},qa={value:""},Fa=["value"],Oa={class:"form-help"},Ba={key:0,class:"form-group"},Wa={class:"time-info"},ja={class:"time-label"},Ha={class:"time-value"},Ja={key:1,class:"form-group"},za={class:"time-info"},Ga={class:"time-label"},Xa={class:"time-value"},Ka={class:"modal-footer"},Qa=["disabled"],Ya=Pe({__name:"TaskDetailModal",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","save"],setup(w,{emit:s}){const a=w,r=s,T=R(!1),v=R([]),_=R({cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""});Ce(async()=>{try{const o=await Me.getAllPlanTemplates();o&&o.templates&&(v.value=o.templates.map(d=>({id:d.id,name:d.title||"Unnamed Template"})))}catch(o){console.error("Failed to get template list:",o)}});const I=o=>{o.target===o.currentTarget&&r("update:modelValue",!1)},D=()=>{_.value.linkTemplate=!1,_.value.templateId="",_.value.planTemplateId=""},K=()=>_.value.cronName.trim()?_.value.cronTime.trim()?we.validateCronExpression(_.value.cronTime)?_.value.planDesc.trim()?_.value.linkTemplate&&!_.value.templateId?(alert("Please select a plan template"),!1):!0:(alert("Task description cannot be empty"),!1):(alert("Invalid Cron expression format, should be 5-6 parts separated by spaces"),!1):(alert("Cron expression cannot be empty"),!1):(alert("Task name cannot be empty"),!1),G=o=>we.formatTime(o),V=async()=>{var o;if(K()){T.value=!0;try{const d={..._.value,...((o=a.task)==null?void 0:o.id)!==void 0&&{id:a.task.id},cronName:_.value.cronName.trim(),cronTime:_.value.cronTime.trim(),planDesc:_.value.planDesc.trim(),status:_.value.status,planTemplateId:_.value.linkTemplate&&_.value.templateId||""};r("save",d)}finally{T.value=!1}}};return _e(()=>a.task,o=>{if(o){const d=o.templateId||o.planTemplateId||"";_.value={cronName:o.cronName||"",cronTime:o.cronTime||"",planDesc:o.planDesc||"",status:o.status??1,linkTemplate:!!d,templateId:d,planTemplateId:d}}else _.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""}},{immediate:!0}),_e(()=>a.modelValue,o=>{o||(_.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""})}),(o,d)=>(h(),ce(Ae,{to:"body"},[k(De,{name:"modal"},{default:xe(()=>{var E,X,L;return[o.modelValue?(h(),g("div",{key:0,class:"modal-overlay",onClick:I},[e("div",{class:"modal-container",onClick:d[8]||(d[8]=ie(()=>{},["stop"]))},[e("div",ba,[e("h3",null,i(o.$t("cronTask.taskDetail")),1),e("div",ka,[e("div",_a,[e("span",$a,i(o.$t("cronTask.taskStatus")),1),e("label",Pa,[e("input",{type:"checkbox",checked:_.value.status===0,onChange:d[0]||(d[0]=O=>_.value.status=_.value.status===0?1:0)},null,40,Ca),d[9]||(d[9]=e("span",{class:"toggle-slider"},null,-1))])]),e("button",{class:"close-btn",onClick:d[1]||(d[1]=O=>o.$emit("update:modelValue",!1))},[k(l($),{icon:"carbon:close"})])])]),e("div",Sa,[e("form",{onSubmit:ie(V,["prevent"]),class:"task-form"},[e("div",ya,[e("label",Ea,i(o.$t("cronTask.taskName")),1),re(e("input",{"onUpdate:modelValue":d[2]||(d[2]=O=>_.value.cronName=O),type:"text",class:"form-input",placeholder:o.$t("cronTask.taskNamePlaceholder"),required:""},null,8,wa),[[be,_.value.cronName]])]),e("div",Ta,[e("label",Ia,i(o.$t("cronTask.cronExpression")),1),re(e("input",{"onUpdate:modelValue":d[3]||(d[3]=O=>_.value.cronTime=O),type:"text",class:"form-input",placeholder:o.$t("cronTask.cronExpressionPlaceholder"),required:""},null,8,Da),[[be,_.value.cronTime]]),e("div",xa,i(o.$t("cronTask.cronExpressionHelp")),1)]),e("div",Ra,[e("label",Aa,i(o.$t("cronTask.taskDescription")),1),re(e("textarea",{"onUpdate:modelValue":d[4]||(d[4]=O=>_.value.planDesc=O),class:"form-textarea",placeholder:o.$t("cronTask.taskDescriptionPlaceholder"),rows:"4",required:""},null,8,Ma),[[be,_.value.planDesc]])]),e("div",Na,[e("label",Ua,i(o.$t("cronTask.planTemplate")),1),e("div",La,[e("button",{type:"button",class:te(["template-btn",_.value.linkTemplate?"active":""]),onClick:d[5]||(d[5]=O=>_.value.linkTemplate=!0)},[k(l($),{icon:"carbon:checkmark"}),Y(" "+i(o.$t("cronTask.linkTemplate")),1)],2),e("button",{type:"button",class:te(["template-btn",_.value.linkTemplate?"":"active"]),onClick:D},[k(l($),{icon:"carbon:close"}),Y(" "+i(o.$t("cronTask.noTemplate")),1)],2)]),_.value.linkTemplate?(h(),g("div",Va,[re(e("select",{"onUpdate:modelValue":d[6]||(d[6]=O=>_.value.templateId=O),class:"form-select"},[e("option",qa,i(o.$t("cronTask.selectTemplate")),1),(h(!0),g(ge,null,fe(v.value,O=>(h(),g("option",{key:O.id,value:O.id},i(O.name),9,Fa))),128))],512),[[rt,_.value.templateId]]),e("div",Oa,i(o.$t("cronTask.templateHelpText")),1)])):B("",!0)]),(E=o.task)!=null&&E.createTime?(h(),g("div",Ba,[e("div",Wa,[e("span",ja,i(o.$t("cronTask.createTime"))+":",1),e("span",Ha,i(G(o.task.createTime)),1)])])):B("",!0),(X=o.task)!=null&&X.updateTime?(h(),g("div",Ja,[e("div",za,[e("span",Ga,i(o.$t("cronTask.updateTime"))+":",1),e("span",Xa,i(G(o.task.updateTime)),1)])])):B("",!0)],32)]),e("div",Ka,[e("button",{type:"button",class:"cancel-btn",onClick:d[7]||(d[7]=O=>o.$emit("update:modelValue",!1))},i(o.$t("common.cancel")),1),e("button",{type:"button",class:"save-btn",onClick:V,disabled:T.value},[T.value?(h(),ce(l($),{key:0,icon:"carbon:loading",class:"loading-icon"})):B("",!0),Y(" "+i((L=a.task)!=null&&L.id?o.$t("common.save"):o.$t("common.create")),1)],8,Qa)])])])):B("",!0)]}),_:1})]))}}),Za=Se(Ya,[["__scopeId","data-v-c9380237"]]),el={class:"modal-header"},tl={class:"header-actions"},nl={class:"modal-content"},sl={key:0,class:"loading-container"},ol={key:1,class:"empty-container"},al={key:2,class:"task-list"},ll=["onClick"],il={class:"task-main"},cl={class:"task-info"},rl={class:"task-header"},ul={class:"task-name"},dl={class:"task-description"},pl={class:"task-time"},hl=["onClick"],gl=["onClick","disabled","title"],ml=["onClick","title"],vl={class:"dropdown-menu"},fl=["onClick"],bl=["onClick","disabled"],kl=["onClick","disabled"],_l={class:"confirm-header"},$l={class:"confirm-content"},Pl={class:"confirm-actions"},Cl=["disabled"],Sl={class:"confirm-header"},yl={class:"confirm-content"},El={class:"create-options"},wl={class:"option-content"},Tl={class:"option-title"},Il={class:"option-desc"},Dl={class:"option-content"},xl={class:"option-title"},Rl={class:"option-desc"},Al={class:"confirm-actions"},Ml=Pe({__name:"index",props:{modelValue:{type:Boolean,required:!0}},emits:["update:modelValue"],setup(w,{emit:s}){const a=at(),r=lt(),T=ht(),{t:v}=Te(),_=w,x=s,I=R([]),D=R(!1),K=R(null),G=R(null),V=R(null),o=R(null),d=R(!1),E=R(null),X=R(!1),L=R(null),O=R(!1),q=u=>{u.target===u.currentTarget&&x("update:modelValue",!1)},Q=async()=>{D.value=!0;try{I.value=await Ee.getAllCronTasks()}catch(u){console.error("Failed to load cron tasks:",u),T.error(`Failed to load tasks: ${u instanceof Error?u.message:String(u)}`)}finally{D.value=!1}},me=async u=>{K.value=u;try{const S=I.value.find(c=>c.id===u);if(!S){console.error("Task not found:",u);return}x("update:modelValue",!1);const t=Date.now().toString();await a.push({name:"direct",params:{id:t}}),await new Promise(c=>setTimeout(c,100));const n=we.prepareTaskExecution(S);n.useTemplate&&n.planData?r.emitPlanExecutionRequested(n.planData):n.taskContent&&r.setTask(n.taskContent)}catch(S){console.error("Failed to execute task:",S),T.error(`Execution failed: ${S instanceof Error?S.message:String(S)}`)}finally{K.value=null}},ue=u=>{E.value={...u},d.value=!0,o.value=null},C=async u=>{try{await we.saveTask(u),await Q(),d.value=!1,T.success("Task saved successfully")}catch(S){console.error("Failed to save task:",S),T.error(`Save failed: ${S instanceof Error?S.message:String(S)}`)}},P=u=>{L.value=u,X.value=!0},F=async()=>{var u;if((u=L.value)!=null&&u.id){G.value=L.value.id;try{await we.deleteTask(L.value.id),await Q(),X.value=!1,L.value=null,T.success("Task deleted successfully")}catch(S){console.error("Failed to delete task:",S),T.error(`Delete failed: ${S instanceof Error?S.message:String(S)}`)}finally{G.value=null}}},A=()=>{X.value=!1,L.value=null},y=u=>{o.value=o.value===u?null:u},M=async u=>{if(u.id){V.value=u.id;try{await we.toggleTaskStatus(u),await Q(),o.value=null,T.success(`Task ${u.status===0?"disabled":"enabled"} successfully`)}catch(S){console.error("Failed to toggle task status:",S),T.error(`Status toggle failed: ${S instanceof Error?S.message:String(S)}`)}finally{V.value=null}}},ee=async u=>{try{await navigator.clipboard.writeText(u),T.success("Cron expression copied successfully")}catch(S){T.error(`Copy failed: ${S instanceof Error?S.message:String(S)}`)}},se=()=>{O.value=!0},ve=()=>{O.value=!1;try{x("update:modelValue",!1);const u=v("cronTask.template");r.setTaskToInput(u);const S=Date.now().toString();a.push({name:"direct",params:{id:S}})}catch(u){console.error("Error in createWithJmanus:",u),T.error(`Creation failed: ${u instanceof Error?u.message:String(u)}`)}},de=()=>{O.value=!1,E.value={cronName:"",cronTime:"",planDesc:"",status:0,planTemplateId:""},d.value=!0},b=()=>{O.value=!1},m=u=>{const S=u.target;!S.closest(".action-dropdown")&&!S.closest(".dropdown-menu")&&(o.value=null)};return Ce(()=>{document.addEventListener("click",m,!0)}),Ie(()=>{document.removeEventListener("click",m,!0)}),_e(()=>_.modelValue,u=>{u&&Q()}),(u,S)=>(h(),g(ge,null,[(h(),ce(Ae,{to:"body"},[k(De,{name:"modal"},{default:xe(()=>[w.modelValue?(h(),g("div",{key:0,class:"modal-overlay",onClick:q},[e("div",{class:"modal-container",onClick:S[3]||(S[3]=ie(()=>{},["stop"]))},[e("div",el,[e("h3",null,i(u.$t("cronTask.title")),1),e("div",tl,[e("button",{class:"add-task-btn",onClick:[se,S[0]||(S[0]=ie(()=>{},["stop"]))]},[k(l($),{icon:"carbon:add"}),Y(" "+i(u.$t("cronTask.addTask")),1)]),e("button",{class:"close-btn",onClick:S[1]||(S[1]=t=>u.$emit("update:modelValue",!1))},[k(l($),{icon:"carbon:close"})])])]),e("div",nl,[D.value?(h(),g("div",sl,[k(l($),{icon:"carbon:loading",class:"loading-icon"}),e("span",null,i(u.$t("common.loading")),1)])):I.value.length===0?(h(),g("div",ol,[k(l($),{icon:"carbon:time",class:"empty-icon"}),e("span",null,i(u.$t("cronTask.noTasks")),1)])):(h(),g("div",al,[(h(!0),g(ge,null,fe(I.value,t=>(h(),g("div",{key:t.id||"",class:"task-item",onClick:n=>ue(t)},[e("div",il,[e("div",cl,[e("div",rl,[e("div",ul,i(t.cronName),1),e("div",{class:te(["task-status-badge",t.status===0?"active":"inactive"])},[k(l($),{icon:t.status===0?"carbon:checkmark-filled":"carbon:pause-filled"},null,8,["icon"]),e("span",null,i(t.status===0?u.$t("cronTask.active"):u.$t("cronTask.inactive")),1)],2)]),e("div",dl,i(t.planDesc),1),e("div",pl,[k(l($),{icon:"carbon:time"}),e("span",{class:"cron-readable",style:{cursor:"pointer"},onClick:ie(n=>ee(t.cronTime),["stop"])},i(t.cronTime),9,hl)])])]),e("div",{class:"task-actions",onClick:S[2]||(S[2]=ie(()=>{},["stop"]))},[e("button",{class:"action-btn execute-btn",onClick:n=>me(t.id),disabled:K.value===t.id,title:u.$t("cronTask.executeOnce")},[k(l($),{icon:K.value===t.id?"carbon:loading":"carbon:play-filled"},null,8,["icon"]),Y(" "+i(u.$t("cronTask.executeOnce")),1)],8,gl),e("div",{class:te(["action-dropdown",{active:o.value===t.id}])},[e("button",{class:"action-btn dropdown-btn",onClick:n=>y(t.id),title:u.$t("cronTask.operations")},[k(l($),{icon:"carbon:overflow-menu-horizontal"}),Y(" "+i(u.$t("cronTask.operations")),1)],8,ml),re(e("div",vl,[e("button",{class:"dropdown-item edit-btn",onClick:n=>ue(t)},[k(l($),{icon:"carbon:edit"}),Y(" "+i(u.$t("cronTask.edit")),1)],8,fl),e("button",{class:"dropdown-item toggle-btn",onClick:n=>M(t),disabled:V.value===t.id},[k(l($),{icon:V.value===t.id?"carbon:loading":t.status===0?"carbon:pause-filled":"carbon:play-filled"},null,8,["icon"]),Y(" "+i(t.status===0?u.$t("cronTask.disable"):u.$t("cronTask.enable")),1)],8,bl),e("button",{class:"dropdown-item delete-btn",onClick:n=>P(t),disabled:G.value===t.id},[k(l($),{icon:G.value===t.id?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),Y(" "+i(u.$t("cronTask.delete")),1)],8,kl)],512),[[ut,o.value===t.id]])],2)])],8,ll))),128))]))])])])):B("",!0)]),_:1})])),k(Za,{modelValue:d.value,"onUpdate:modelValue":S[4]||(S[4]=t=>d.value=t),task:E.value,onSave:C},null,8,["modelValue","task"]),(h(),ce(Ae,{to:"body"},[k(De,{name:"modal"},{default:xe(()=>{var t,n,c,p;return[X.value?(h(),g("div",{key:0,class:"modal-overlay",onClick:A},[e("div",{class:"confirm-modal",onClick:S[5]||(S[5]=ie(()=>{},["stop"]))},[e("div",_l,[k(l($),{icon:"carbon:warning",class:"warning-icon"}),e("h3",null,i(u.$t("cronTask.deleteConfirm")),1)]),e("div",$l,[e("p",null,i(u.$t("cronTask.deleteConfirmMessage",{taskName:((t=L.value)==null?void 0:t.cronName)||((n=L.value)==null?void 0:n.planDesc)||""})),1)]),e("div",Pl,[e("button",{class:"confirm-btn cancel-btn",onClick:A},i(u.$t("common.cancel")),1),e("button",{class:"confirm-btn delete-btn",onClick:F,disabled:G.value===((c=L.value)==null?void 0:c.id)},[k(l($),{icon:G.value===((p=L.value)==null?void 0:p.id)?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),Y(" "+i(u.$t("cronTask.delete")),1)],8,Cl)])])])):B("",!0)]}),_:1})])),(h(),ce(Ae,{to:"body"},[k(De,{name:"modal"},{default:xe(()=>[O.value?(h(),g("div",{key:0,class:"modal-overlay",onClick:b},[e("div",{class:"confirm-modal create-options-modal",onClick:S[6]||(S[6]=ie(()=>{},["stop"]))},[e("div",Sl,[k(l($),{icon:"carbon:time",class:"create-icon"}),e("h3",null,i(u.$t("cronTask.createTask")),1)]),e("div",yl,[e("p",null,i(u.$t("cronTask.selectCreateMethod")),1),e("div",El,[e("button",{class:"create-option-btn jmanus-btn",onClick:ve},[k(l($),{icon:"carbon:ai-status"}),e("div",wl,[e("span",Tl,i(u.$t("cronTask.createWithJmanus")),1),e("span",Il,i(u.$t("cronTask.createWithJmanusDesc")),1)])]),e("button",{class:"create-option-btn manual-btn",onClick:de},[k(l($),{icon:"carbon:edit"}),e("div",Dl,[e("span",xl,i(u.$t("cronTask.createManually")),1),e("span",Rl,i(u.$t("cronTask.createManuallyDesc")),1)])])])]),e("div",Al,[e("button",{class:"confirm-btn cancel-btn",onClick:b},i(u.$t("common.cancel")),1)])])])):B("",!0)]),_:1})]))],64))}}),Nl=Se(Ml,[["__scopeId","data-v-f31a9ce7"]]),Ul={class:"direct-page"},Ll={class:"direct-chat"},Vl={class:"chat-header"},ql={class:"header-actions"},Fl=["title"],Ol=["title"],Bl={class:"chat-content"},Wl=["title"],jl=Pe({__name:"index",setup(w){const s=dt(),a=at(),r=lt(),{t:T}=Te(),v=R(""),_=R(""),x=R(),I=R(),D=R(),K=R(!1),G=R(!1),V=R(null),o=R(!1),d=R(50),E=R(!1),X=R(0),L=R(0);Ce(()=>{if(console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",r.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",r.hasUnprocessedTask()),oe.setEventCallbacks({onPlanUpdate:m=>{console.log("[Direct] Plan update event received for rootPlanId:",m),ue(m)&&(console.log("[Direct] Processing plan update for current rootPlanId:",m),I.value&&typeof I.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",m),I.value.handlePlanUpdate(m)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),x.value&&typeof x.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",m),x.value.updateDisplayedPlanProgress(m)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:m=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",m),!!ue(m)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",m),I.value&&typeof I.value.handlePlanCompleted=="function"){const u=oe.getCachedPlanRecord(m);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",u),I.value.handlePlanCompleted(u??{planId:m})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");V.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:m=>{console.log("[Direct] Dialog round start event received for rootPlanId:",m),V.value=m,console.log("[Direct] Set currentRootPlanId to:",m),I.value&&typeof I.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",m),I.value.handleDialogRoundStart(m)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),P()},onChatInputUpdateState:m=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",m),!ue(m,!0))return;const u=oe.getCachedUIState(m);u&&A(u.enabled,u.placeholder)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),f.loadPlanTemplateList(),r.hasUnprocessedTask()&&r.currentTask){const m=r.currentTask.prompt;console.log("[Direct] Found unprocessed task from store:",m),r.markTaskAsProcessed(),ne(()=>{I.value&&typeof I.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing task via chatRef.handleSendMessage:",m),I.value.handleSendMessage(m)):(console.warn("[Direct] chatRef.handleSendMessage method not available, falling back to prompt"),v.value=m)})}else{const m=r.getAndClearTaskToInput();m?(_.value=m,console.log("[Direct] Setting inputOnlyContent for input only:",_.value)):(v.value=s.query.prompt||"",console.log("[Direct] Received task from URL:",v.value),console.log("[Direct] No unprocessed task in store"))}const b=localStorage.getItem("directPanelWidth");b&&(d.value=parseFloat(b)),console.log("[Direct] Final prompt value:",v.value),_.value&&ne(()=>{D.value&&typeof D.value.setInputValue=="function"&&(D.value.setInputValue(_.value),console.log("[Direct] Set input value:",_.value),_.value="")}),window.addEventListener("plan-execution-requested",m=>{console.log("[DirectView] Received plan-execution-requested event:",m.detail),de(m.detail)})}),_e(()=>r.currentTask,b=>{if(console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",b),b&&!b.processed){const m=b.prompt;r.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",m),ne(()=>{I.value&&typeof I.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing new task via chatRef.handleSendMessage:",m),I.value.handleSendMessage(m)):console.warn("[Direct] chatRef.handleSendMessage method not available for new task")})}else console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),_e(()=>v.value,(b,m)=>{console.log("[Direct] prompt value changed from:",m,"to:",b)},{immediate:!1}),_e(()=>r.taskToInput,b=>{console.log("[Direct] Watch taskStore.taskToInput triggered, newTaskToInput:",b),b&&b.trim()&&(console.log("[Direct] Setting input value from taskToInput:",b),ne(()=>{D.value&&typeof D.value.setInputValue=="function"&&(D.value.setInputValue(b.trim()),console.log("[Direct] Input value set from taskToInput watch:",b.trim()),r.getAndClearTaskToInput())}))},{immediate:!1}),Ie(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),V.value=null,oe.cleanup(),document.removeEventListener("mousemove",q),document.removeEventListener("mouseup",Q),window.removeEventListener("plan-execution-requested",b=>{de(b.detail)})});const O=b=>{E.value=!0,X.value=b.clientX,L.value=d.value,document.addEventListener("mousemove",q),document.addEventListener("mouseup",Q),document.body.style.cursor="col-resize",document.body.style.userSelect="none",b.preventDefault()},q=b=>{if(!E.value)return;const m=window.innerWidth,S=(b.clientX-X.value)/m*100;let t=L.value+S;t=Math.max(20,Math.min(80,t)),d.value=t},Q=()=>{E.value=!1,document.removeEventListener("mousemove",q),document.removeEventListener("mouseup",Q),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",d.value.toString())},me=()=>{d.value=50,localStorage.setItem("directPanelWidth","50")},ue=(b,m=!1)=>!V.value||b===V.value||m&&(b==="ui-state"||b==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",b,"current:",V.value),!1),C=b=>{console.log("[DirectView] Send message from input:",b),I.value&&typeof I.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",b),I.value.handleSendMessage(b)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},P=()=>{console.log("[DirectView] Input cleared"),D.value&&typeof D.value.clear=="function"&&D.value.clear()},F=()=>{console.log("[DirectView] Input focused")},A=(b,m)=>{console.log("[DirectView] Input state updated:",b,m),G.value=!b},y=(b,m)=>{console.log("[DirectView] Step selected:",b,m),x.value&&typeof x.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",b,m),x.value.handleStepSelected(b,m)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},M=(b,m,u,S)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:b,subPlanId:m,stepIndex:u,subStepIndex:S}),x.value&&typeof x.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:b,subPlanId:m,stepIndex:u,subStepIndex:S}),x.value.handleSubPlanStepSelected(b,m,u,S)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},ee=()=>{console.log("[DirectView] Plan mode button clicked"),f.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",f.isCollapsed)},se=()=>{a.push("/home")},ve=()=>{a.push("/configs")},de=async b=>{var u,S,t,n;if(console.log("[DirectView] Plan execution requested:",b),K.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}K.value=!0;let m=!1;I.value&&typeof I.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",b.title),I.value.addMessage("user",b.title),m=!0):console.warn("[DirectView] chatRef.addMessage method not available");try{const c=((u=b.planData)==null?void 0:u.planTemplateId)||((S=b.planData)==null?void 0:S.id)||((t=b.planData)==null?void 0:t.planId);if(!c)throw new Error("没有找到计划模板ID");console.log("[Direct] Executing plan with templateId:",c,"params:",b.params),console.log("[Direct] About to call PlanActApiService.executePlan");let p;if((n=b.params)!=null&&n.trim()?(console.log("[Direct] Calling executePlan with params:",b.params.trim()),p=await Me.executePlan(c,b.params.trim())):(console.log("[Direct] Calling executePlan without params"),p=await Me.executePlan(c)),console.log("[Direct] Plan execution API response:",p),p.planId)console.log("[Direct] Got planId from response:",p.planId,"starting plan execution"),V.value=p.planId,console.log("[Direct] Set currentRootPlanId to:",p.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),oe.handlePlanExecutionRequested(p.planId,b.title);else throw console.error("[Direct] No planId in response:",p),new Error("执行计划失败：未返回有效的计划ID")}catch(c){console.error("[Direct] Plan execution failed:",c),console.error("[Direct] Error details:",{message:c.message,stack:c.stack}),V.value=null,I.value&&typeof I.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),m||I.value.addMessage("user",b.title),I.value.addMessage("assistant",`执行计划失败: ${c.message||"未知错误"}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`执行计划失败: ${c.message||"未知错误"}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),K.value=!1}};return(b,m)=>(h(),g("div",Ul,[e("div",Ll,[k(gn,{onPlanExecutionRequested:de}),e("div",{class:"left-panel",style:Ne({width:d.value+"%"})},[e("div",Vl,[e("button",{class:"back-button",onClick:se},[k(l($),{icon:"carbon:arrow-left"})]),e("h2",null,i(b.$t("conversation")),1),e("div",ql,[k(pt),e("button",{class:"config-button",onClick:ve,title:b.$t("direct.configuration")},[k(l($),{icon:"carbon:settings-adjust",width:"20"})],8,Fl),e("button",{class:"cron-task-btn",onClick:m[0]||(m[0]=u=>o.value=!0),title:b.$t("cronTask.title")},[k(l($),{icon:"carbon:alarm",width:"20"})],8,Ol)])]),e("div",Bl,[k(ra,{ref_key:"chatRef",ref:I,mode:"direct","initial-prompt":v.value||"",onStepSelected:y,onSubPlanStepSelected:M},null,8,["initial-prompt"])]),(h(),ce(fa,{key:b.$i18n.locale,ref_key:"inputRef",ref:D,disabled:G.value,placeholder:G.value?l(T)("input.waiting"):l(T)("input.placeholder"),"initial-value":v.value,onSend:C,onClear:P,onFocus:F,onUpdateState:A,onPlanModeClicked:ee},null,8,["disabled","placeholder","initial-value"]))],4),e("div",{class:"panel-resizer",onMousedown:O,onDblclick:me,title:b.$t("direct.panelResizeHint")},m[2]||(m[2]=[e("div",{class:"resizer-line"},null,-1)]),40,Wl),k(Ds,{ref_key:"rightPanelRef",ref:x,style:Ne({width:100-d.value+"%"})},null,8,["style"])]),k(Nl,{modelValue:o.value,"onUpdate:modelValue":m[1]||(m[1]=u=>o.value=u)},null,8,["modelValue"])]))}}),Ql=Se(jl,[["__scopeId","data-v-696a3f65"]]);export{Ql as default};
