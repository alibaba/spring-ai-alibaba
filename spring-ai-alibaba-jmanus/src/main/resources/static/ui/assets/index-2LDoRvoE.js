var et=Object.defineProperty;var tt=(W,l,n)=>l in W?et(W,l,{enumerable:!0,configurable:!0,writable:!0,value:n}):W[l]=n;var re=(W,l,n)=>tt(W,typeof l!="symbol"?l+"":l,n);import{m as nt,r as A,g as ie,d as Se,f as ke,h as Ce,c as f,o as g,p as ae,u as a,e,b as J,t as c,i as y,q as ne,F as ve,j as me,s as we,w as Pe,v as _e,x as Ye,k as le,y as $e,a as be,T as st,z as ot,A as Ie,n as xe,B as at,l as lt}from"./index-DZD86Ry3.js";import{I as w,_ as Ee}from"./_plugin-vue_export-helper-D7ZW8YSJ.js";import{L as it}from"./index-B8RkNRFV.js";import{u as ct}from"./task-BVsOenCi.js";class ue{static async generatePlan(l,n){const r={query:l};n&&(r.existingJson=n);const o=await fetch(`${this.PLAN_TEMPLATE_URL}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!o.ok)throw new Error(`Failed to generate plan: ${o.status}`);const h=await o.json();if(h.planJson)try{h.plan=JSON.parse(h.planJson)}catch{h.plan={error:"Unable to parse plan data"}}return h}static async executePlan(l,n){console.log("[PlanActApiService] executePlan called with:",{planTemplateId:l,rawParam:n});const r={planTemplateId:l};n&&(r.rawParam=n),console.log("[PlanActApiService] Making request to:",`${this.PLAN_TEMPLATE_URL}/executePlanByTemplateId`),console.log("[PlanActApiService] Request body:",r);const o=await fetch(`${this.PLAN_TEMPLATE_URL}/executePlanByTemplateId`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(console.log("[PlanActApiService] Response status:",o.status,o.ok),!o.ok){const C=await o.text();throw console.error("[PlanActApiService] Request failed:",C),new Error(`Failed to execute plan: ${o.status}`)}const h=await o.json();return console.log("[PlanActApiService] executePlan response:",h),h}static async savePlanTemplate(l,n){const r=await fetch(`${this.PLAN_TEMPLATE_URL}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:l,planJson:n})});if(!r.ok)throw new Error(`Failed to save plan: ${r.status}`);return await r.json()}static async getPlanVersions(l){const n=await fetch(`${this.PLAN_TEMPLATE_URL}/versions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:l})});if(!n.ok)throw new Error(`Failed to get plan versions: ${n.status}`);return await n.json()}static async getVersionPlan(l,n){const r=await fetch(`${this.PLAN_TEMPLATE_URL}/get-version`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:l,versionIndex:n.toString()})});if(!r.ok)throw new Error(`Failed to get specific version plan: ${r.status}`);return await r.json()}static async getAllPlanTemplates(){const l=await fetch(`${this.PLAN_TEMPLATE_URL}/list`);if(!l.ok)throw new Error(`Failed to get plan template list: ${l.status}`);return await l.json()}static async updatePlanTemplate(l,n,r){const o={planId:l,query:n};r&&(o.existingJson=r);const h=await fetch(`${this.PLAN_TEMPLATE_URL}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!h.ok)throw new Error(`Failed to update plan template: ${h.status}`);const C=await h.json();if(C.planJson)try{C.plan=JSON.parse(C.planJson)}catch{C.plan={error:"Unable to parse plan data"}}return C}static async deletePlanTemplate(l){const n=await fetch(`${this.PLAN_TEMPLATE_URL}/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:l})});if(!n.ok)throw new Error(`Failed to delete plan template: ${n.status}`);return await n.json()}}re(ue,"PLAN_TEMPLATE_URL","/api/plan-template");const Ze=nt("sidebar",()=>{const W=A(!0),l=A("list"),n=A(null),r=A([]),o=A(null),h=A(!1),C=A(""),S=A(""),I=A(""),x=A(""),H=A(!1),X=A(!1),_=A([]),D=A(-1),Y=ie(()=>[...r.value].sort((u,E)=>{const Z=new Date(u.updateTime??u.createTime);return new Date(E.updateTime??E.createTime).getTime()-Z.getTime()})),d=ie(()=>_.value.length>1&&D.value>0),$=ie(()=>_.value.length>1&&D.value<_.value.length-1),T=ie(()=>{if(!o.value)return"";const u=`/api/plan-template/executePlanByTemplateId/${o.value.id}`,E=x.value.trim();return E?`${u}?${encodeURIComponent(E)}`:u}),O=()=>{W.value=!W.value},z=u=>{l.value=u},K=async()=>{h.value=!0,C.value="";try{console.log("[SidebarStore] Starting to load plan template list...");const u=await ue.getAllPlanTemplates();u!=null&&u.templates&&Array.isArray(u.templates)?(r.value=u.templates,console.log(`[SidebarStore] Successfully loaded ${u.templates.length} plan templates`)):(r.value=[],console.warn("[SidebarStore] API returned abnormal data format, using empty list",u))}catch(u){console.error("[SidebarStore] Failed to load plan template list:",u),r.value=[],C.value=`Load failed: ${u.message}`}finally{h.value=!1}},de=async u=>{n.value=u.id,o.value=u,l.value="config",await he(u),console.log(`[SidebarStore] Selected plan template: ${u.id}`)},he=async u=>{try{const E=await ue.getPlanVersions(u.id);if(_.value=E.versions||[],_.value.length>0){const Z=_.value[_.value.length-1];S.value=Z,D.value=_.value.length-1;try{const s=JSON.parse(Z);s.prompt&&(I.value=s.prompt),s.params&&(x.value=s.params)}catch{console.warn("Unable to parse JSON content to get prompt information")}}else S.value="",I.value="",x.value=""}catch(E){throw console.error("Failed to load template data:",E),E}},v=()=>{const u={id:`new-${Date.now()}`,title:"新建计划",description:"请使用计划生成器创建新的计划模板",createTime:new Date().toISOString(),updateTime:new Date().toISOString()};o.value=u,n.value=null,S.value="",I.value="",x.value="",_.value=[],D.value=-1,l.value="config",console.log("[SidebarStore] Created new empty plan template, switching to config tab")},m=async u=>{if(!u.id){console.warn("[SidebarStore] deleteTemplate: Invalid template object or ID");return}try{await ue.deletePlanTemplate(u.id),n.value===u.id&&U(),await K(),console.log(`[SidebarStore] Plan template ${u.id} has been deleted`)}catch(E){throw console.error("Failed to delete plan template:",E),await K(),E}},U=()=>{n.value=null,o.value=null,S.value="",I.value="",x.value="",_.value=[],D.value=-1,l.value="list"};return{isCollapsed:W,currentTab:l,currentPlanTemplateId:n,planTemplateList:r,selectedTemplate:o,isLoading:h,errorMessage:C,jsonContent:S,generatorPrompt:I,executionParams:x,isGenerating:H,isExecuting:X,planVersions:_,currentVersionIndex:D,sortedTemplates:Y,canRollback:d,canRestore:$,computedApiUrl:T,toggleSidebar:O,switchToTab:z,loadPlanTemplateList:K,selectTemplate:de,createNewTemplate:v,deleteTemplate:m,clearSelection:U,clearExecutionParams:()=>{x.value=""},rollbackVersion:()=>{d.value&&(D.value--,S.value=_.value[D.value])},restoreVersion:()=>{$.value&&(D.value++,S.value=_.value[D.value])},saveTemplate:async()=>{if(!o.value)return;const u=S.value.trim();if(!u)throw new Error("Content cannot be empty");try{JSON.parse(u)}catch(E){throw new Error(`Invalid format, please correct and save.
Error: `+E.message)}try{const E=await ue.savePlanTemplate(o.value.id,u);return D.value<_.value.length-1&&(_.value=_.value.slice(0,D.value+1)),_.value.push(u),D.value=_.value.length-1,E}catch(E){throw console.error("Failed to save plan template:",E),E}},generatePlan:async()=>{if(I.value.trim()){H.value=!0;try{const u=await ue.generatePlan(I.value);if(S.value=u.planJson||"",o.value&&o.value.id.startsWith("new-")){let E="New Plan Template";try{E=JSON.parse(u.planJson||"{}").title||E}catch{console.warn("Unable to parse plan JSON to get title")}o.value={id:u.planTemplateId,title:E,description:"通过生成器创建的计划模板",createTime:new Date().toISOString(),updateTime:new Date().toISOString(),planJson:u.planJson},n.value=u.planTemplateId,await K()}return D.value<_.value.length-1&&(_.value=_.value.slice(0,D.value+1)),_.value.push(S.value),D.value=_.value.length-1,u}catch(u){throw console.error("Failed to generate plan:",u),u}finally{H.value=!1}}},updatePlan:async()=>{if(!(!I.value.trim()||!S.value.trim())&&o.value){H.value=!0;try{const u=await ue.updatePlanTemplate(o.value.id,I.value,S.value);return S.value=u.planJson||"",D.value<_.value.length-1&&(_.value=_.value.slice(0,D.value+1)),_.value.push(S.value),D.value=_.value.length-1,u}catch(u){throw console.error("Failed to update plan:",u),u}finally{H.value=!1}}},preparePlanExecution:()=>{if(!o.value)return null;X.value=!0;try{let u;try{u=JSON.parse(S.value),u.planTemplateId=o.value.id}catch{u={planTemplateId:o.value.id,planId:o.value.id,title:o.value.title??"执行计划",steps:[{stepRequirement:"[BROWSER_AGENT] 访问百度搜索阿里巴巴的最新股价"},{stepRequirement:"[DEFAULT_AGENT] 提取和整理搜索结果中的股价信息"},{stepRequirement:"[TEXT_FILE_AGENT] 创建一个文本文件记录查询结果"},{stepRequirement:"[DEFAULT_AGENT] 向用户报告查询结果"}]}}return{title:o.value.title??u.title??"Execution Plan",planData:u,params:x.value.trim()||void 0}}catch(u){throw console.error("Failed to prepare plan execution:",u),X.value=!1,u}},finishPlanExecution:()=>{X.value=!1}}}),rt={class:"sidebar-content"},ut={class:"sidebar-content-header"},dt={class:"sidebar-content-title"},pt={class:"tab-switcher"},ht=["disabled"],gt={key:0,class:"tab-content"},vt={class:"new-task-section"},mt={class:"sidebar-content-list"},ft={key:0,class:"loading-state"},Pt={key:1,class:"error-state"},_t={key:2,class:"empty-state"},bt=["onClick"],St={class:"task-icon"},kt={class:"task-details"},Ct={class:"task-title"},$t={class:"task-preview"},Et={class:"task-time"},yt={class:"task-actions"},wt=["title","onClick"],It={key:1,class:"tab-content config-tab"},xt={key:0,class:"config-container"},Tt={class:"template-info-header"},Rt={class:"template-info"},Dt={class:"template-id"},At={class:"config-section"},Nt={class:"section-header"},Mt={class:"section-actions"},Lt=["disabled","title"],Ut=["disabled","title"],qt=["disabled"],Ot=["placeholder"],Ft={class:"config-section"},Vt={class:"section-header"},Bt={class:"generator-content"},jt=["placeholder"],Wt={class:"generator-actions"},Jt=["disabled"],Ht=["disabled"],zt={class:"config-section"},Gt={class:"section-header"},Xt={class:"execution-content"},Kt={class:"params-input-group"},Qt={class:"params-input-container"},Yt=["placeholder"],Zt=["title"],en={class:"api-url-display"},tn={class:"api-url-label"},nn={class:"api-url"},sn=["disabled"],on=Se({__name:"index",emits:["planExecutionRequested"],setup(W,{expose:l,emit:n}){const{t:r}=ke(),o=Ze(),h=n,C=()=>{o.createNewTemplate(),console.log("[PlanTemplateSidebar] 创建新的空白计划模板，切换到配置标签页")},S=async d=>{try{await o.selectTemplate(d),console.log(`[PlanTemplateSidebar] 选择了计划模板: ${d.id}`)}catch($){console.error("选择计划模板失败:",$),alert(r("sidebar.selectTemplateFailed")+": "+$.message)}},I=async d=>{if(confirm(r("sidebar.confirmDelete",{name:d.title??r("sidebar.unnamedPlan")})))try{await o.deleteTemplate(d),alert(r("sidebar.templateDeleted"))}catch($){console.error("删除计划模板失败:",$),alert(r("sidebar.deleteTemplateFailed")+": "+$.message)}},x=async()=>{try{const d=await o.saveTemplate();d!=null&&d.duplicate?alert(r("sidebar.saveCompleted",{message:d.message,versionCount:d.versionCount})):d!=null&&d.saved?alert(r("sidebar.saveSuccess",{message:d.message,versionCount:d.versionCount})):d!=null&&d.message&&alert(r("sidebar.saveStatus",{message:d.message}))}catch(d){console.error("保存计划修改失败:",d),alert(d.message||r("sidebar.saveFailed"))}},H=async()=>{var d;try{await o.generatePlan(),alert(r("sidebar.generateSuccess",{templateId:((d=o.selectedTemplate)==null?void 0:d.id)??r("sidebar.unknown")}))}catch($){console.error("生成计划失败:",$),alert(r("sidebar.generateFailed")+": "+$.message)}},X=async()=>{try{await o.updatePlan(),alert(r("sidebar.updateSuccess"))}catch(d){console.error("更新计划失败:",d),alert(r("sidebar.updateFailed")+": "+d.message)}},_=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const d=o.preparePlanExecution();if(!d){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] 触发计划执行请求:",d),console.log("[Sidebar] Emitting planExecutionRequested event"),h("planExecutionRequested",d),console.log("[Sidebar] Event emitted")}catch(d){console.error("执行计划出错:",d),alert(r("sidebar.executeFailed")+": "+d.message)}finally{o.finishPlanExecution()}},D=d=>{const T=new Date().getTime()-d.getTime(),O=Math.floor(T/6e4),z=Math.floor(T/36e5),K=Math.floor(T/864e5);return O<1?"刚刚":O<60?`${O}分钟前`:z<24?`${z}小时前`:K<30?`${K}天前`:d.toLocaleDateString("zh-CN")},Y=(d,$)=>!d||d.length<=$?d:d.substring(0,$)+"...";return Ce(()=>{o.loadPlanTemplateList()}),l({loadPlanTemplateList:o.loadPlanTemplateList,toggleSidebar:o.toggleSidebar,currentPlanTemplateId:o.currentPlanTemplateId}),(d,$)=>(g(),f("div",{class:ae(["sidebar-wrapper",{"sidebar-wrapper-collapsed":a(o).isCollapsed}])},[e("div",rt,[e("div",ut,[e("div",dt,c(d.$t("sidebar.title")),1)]),e("div",pt,[e("button",{class:ae(["tab-button",{active:a(o).currentTab==="list"}]),onClick:$[0]||($[0]=T=>a(o).switchToTab("list"))},[y(a(w),{icon:"carbon:list",width:"16"}),ne(" "+c(d.$t("sidebar.templateList")),1)],2),e("button",{class:ae(["tab-button",{active:a(o).currentTab==="config"}]),onClick:$[1]||($[1]=T=>a(o).switchToTab("config")),disabled:!a(o).selectedTemplate},[y(a(w),{icon:"carbon:settings",width:"16"}),ne(" "+c(d.$t("sidebar.configuration")),1)],10,ht)]),a(o).currentTab==="list"?(g(),f("div",gt,[e("div",vt,[e("button",{class:"new-task-btn",onClick:C},[y(a(w),{icon:"carbon:add",width:"16"}),ne(" "+c(d.$t("sidebar.newPlan"))+" ",1),$[10]||($[10]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",mt,[a(o).isLoading?(g(),f("div",ft,[y(a(w),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,c(d.$t("sidebar.loading")),1)])):a(o).errorMessage?(g(),f("div",Pt,[y(a(w),{icon:"carbon:warning",width:"20"}),e("span",null,c(a(o).errorMessage),1),e("button",{onClick:$[2]||($[2]=(...T)=>a(o).loadPlanTemplateList&&a(o).loadPlanTemplateList(...T)),class:"retry-btn"},c(d.$t("sidebar.retry")),1)])):a(o).planTemplateList.length===0?(g(),f("div",_t,[y(a(w),{icon:"carbon:document",width:"32"}),e("span",null,c(d.$t("sidebar.noTemplates")),1)])):(g(!0),f(ve,{key:3},me(a(o).sortedTemplates,T=>(g(),f("div",{key:T.id,class:ae(["sidebar-content-list-item",{"sidebar-content-list-item-active":T.id===a(o).currentPlanTemplateId}]),onClick:O=>S(T)},[e("div",St,[y(a(w),{icon:"carbon:document",width:"20"})]),e("div",kt,[e("div",Ct,c(T.title||d.$t("sidebar.unnamedPlan")),1),e("div",$t,c(Y(T.description||d.$t("sidebar.noDescription"),40)),1)]),e("div",Et,c(D(new Date(T.updateTime||T.createTime))),1),e("div",yt,[e("button",{class:"delete-task-btn",title:d.$t("sidebar.deleteTemplate"),onClick:we(O=>I(T),["stop"])},[y(a(w),{icon:"carbon:close",width:"16"})],8,wt)])],10,bt))),128))])])):a(o).currentTab==="config"?(g(),f("div",It,[a(o).selectedTemplate?(g(),f("div",xt,[e("div",Tt,[e("div",Rt,[e("h3",null,c(a(o).selectedTemplate.title||d.$t("sidebar.unnamedPlan")),1),e("span",Dt,"ID: "+c(a(o).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:$[3]||($[3]=T=>a(o).switchToTab("list"))},[y(a(w),{icon:"carbon:arrow-left",width:"16"})])]),e("div",At,[e("div",Nt,[y(a(w),{icon:"carbon:code",width:"16"}),e("span",null,c(d.$t("sidebar.jsonTemplate")),1),e("div",Mt,[e("button",{class:"btn btn-sm",onClick:$[4]||($[4]=(...T)=>a(o).rollbackVersion&&a(o).rollbackVersion(...T)),disabled:!a(o).canRollback,title:d.$t("sidebar.rollback")},[y(a(w),{icon:"carbon:undo",width:"14"})],8,Lt),e("button",{class:"btn btn-sm",onClick:$[5]||($[5]=(...T)=>a(o).restoreVersion&&a(o).restoreVersion(...T)),disabled:!a(o).canRestore,title:d.$t("sidebar.restore")},[y(a(w),{icon:"carbon:redo",width:"14"})],8,Ut),e("button",{class:"btn btn-primary btn-sm",onClick:x,disabled:a(o).isGenerating||a(o).isExecuting},[y(a(w),{icon:"carbon:save",width:"14"})],8,qt)])]),Pe(e("textarea",{"onUpdate:modelValue":$[6]||($[6]=T=>a(o).jsonContent=T),class:"json-editor",placeholder:d.$t("sidebar.jsonPlaceholder"),rows:"8"},null,8,Ot),[[_e,a(o).jsonContent]])]),e("div",Ft,[e("div",Vt,[y(a(w),{icon:"carbon:generate",width:"16"}),e("span",null,c(d.$t("sidebar.planGenerator")),1)]),e("div",Bt,[Pe(e("textarea",{"onUpdate:modelValue":$[7]||($[7]=T=>a(o).generatorPrompt=T),class:"prompt-input",placeholder:d.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,jt),[[_e,a(o).generatorPrompt]]),e("div",Wt,[e("button",{class:"btn btn-primary btn-sm",onClick:H,disabled:a(o).isGenerating||!a(o).generatorPrompt.trim()},[y(a(w),{icon:a(o).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:ae({spinning:a(o).isGenerating})},null,8,["icon","class"]),ne(" "+c(a(o).isGenerating?d.$t("sidebar.generating"):d.$t("sidebar.generatePlan")),1)],8,Jt),e("button",{class:"btn btn-secondary btn-sm",onClick:X,disabled:a(o).isGenerating||!a(o).generatorPrompt.trim()||!a(o).jsonContent.trim()},[y(a(w),{icon:"carbon:edit",width:"14"}),ne(" "+c(d.$t("sidebar.updatePlan")),1)],8,Ht)])])]),e("div",zt,[e("div",Gt,[y(a(w),{icon:"carbon:play",width:"16"}),e("span",null,c(d.$t("sidebar.executionController")),1)]),e("div",Xt,[e("div",Kt,[e("label",null,c(d.$t("sidebar.executionParams")),1),e("div",Qt,[Pe(e("input",{"onUpdate:modelValue":$[8]||($[8]=T=>a(o).executionParams=T),class:"params-input",placeholder:d.$t("sidebar.executionParamsPlaceholder")},null,8,Yt),[[_e,a(o).executionParams]]),e("button",{class:"clear-params-btn",onClick:$[9]||($[9]=(...T)=>a(o).clearExecutionParams&&a(o).clearExecutionParams(...T)),title:d.$t("sidebar.clearParams")},[y(a(w),{icon:"carbon:close",width:"12"})],8,Zt)])]),e("div",en,[e("span",tn,c(d.$t("sidebar.apiUrl"))+":",1),e("code",nn,c(a(o).computedApiUrl),1)]),e("button",{class:"btn btn-primary execute-btn",onClick:_,disabled:a(o).isExecuting||a(o).isGenerating},[y(a(w),{icon:a(o).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:ae({spinning:a(o).isExecuting})},null,8,["icon","class"]),ne(" "+c(a(o).isExecuting?d.$t("sidebar.executing"):d.$t("sidebar.executePlan")),1)],8,sn)])])])):J("",!0)])):J("",!0)])],2))}}),an=Ee(on,[["__scopeId","data-v-36691af0"]]);class Re{static async sendMessage(l){const n=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:l})});if(!n.ok)throw new Error(`API request failed: ${n.status}`);return await n.json()}}re(Re,"BASE_URL","/api/executor");class De{static async getDetails(l){try{const n=await fetch(`${this.BASE_URL}/details/${l}`);if(n.status===404)return null;if(!n.ok)throw new Error(`Failed to get detailed information: ${n.status}`);const r=await n.text(),o=JSON.parse(r);return o&&typeof o=="object"&&!o.currentPlanId&&(o.currentPlanId=l),o}catch(n){return console.error("[CommonApiService] Failed to get plan details:",n),null}}static async submitFormInput(l,n){const r=await fetch(`${this.BASE_URL}/submit-input/${l}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!r.ok){let h;try{h=await r.json()}catch{h={message:`Failed to submit form input: ${r.status}`}}throw new Error(h.message||`Failed to submit form input: ${r.status}`)}const o=r.headers.get("content-type");return o&&o.indexOf("application/json")!==-1?await r.json():{success:!0}}}re(De,"BASE_URL","/api/executor");const ge=class ge{constructor(){re(this,"POLL_INTERVAL",5e3);re(this,"state",Ye({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));re(this,"callbacks",{});re(this,"planExecutionCache",new Map);re(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(l){return this.planExecutionCache.get(l)}getCachedUIState(l){return this.uiStateCache.get(l)}setCachedUIState(l,n){this.uiStateCache.set(l,n),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${l}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(l){return this.planExecutionCache.has(l)}setCachedPlanRecord(l,n){this.planExecutionCache.set(l,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${l}`)}clearCachedPlanRecord(l){const n=this.planExecutionCache.delete(l);return n&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${l}`),n}clearAllCachedRecords(){const l=this.planExecutionCache.size,n=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${l}, UI States: ${n}`)}static getInstance(){return ge.instance||(ge.instance=new ge),ge.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(l){this.callbacks={...this.callbacks,...l},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(l))}async handleUserMessageSendRequested(l){if(this.validateAndPrepareUIForNewRequest(l))try{if(await this.sendUserMessageAndSetPlanId(l),this.state.activePlanId)this.initiatePlanExecutionSequence(l,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(n){console.error("[PlanExecutionManager] Failed to send user message:",n);const r=this.state.activePlanId??"error";this.setCachedUIState(r,{enabled:!0}),this.emitChatInputUpdateState(r),this.state.activePlanId=null}}handlePlanExecutionRequested(l,n){console.log("[PlanExecutionManager] Received plan execution request:",{planId:l,query:n}),l?(this.state.activePlanId=l,this.initiatePlanExecutionSequence(n??"执行计划",l)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(l,n){const r=this.getCachedPlanRecord(l);return r!=null&&r.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${l}`),this.handlePlanExecutionRequested(r.currentPlanId,n),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${l}`),!1)}validateAndPrepareUIForNewRequest(l){if(!l)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const n=this.state.activePlanId??"ui-state";return this.setCachedUIState(n,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(n),!0}async sendUserMessageAndSetPlanId(l){try{const n=await Re.sendMessage(l);if(n!=null&&n.planId)return this.state.activePlanId=n.planId,n;if(n!=null&&n.planTemplateId)return this.state.activePlanId=n.planTemplateId,{...n,planId:n.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",n),new Error("Failed to get valid planId from API response")}catch(n){throw console.error("[PlanExecutionManager] API call failed:",n),n}}initiatePlanExecutionSequence(l,n){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${l}", planId: ${n}`);const r=n;this.emitDialogRoundStart(r),this.startPolling()}handlePlanCompletion(l){this.emitPlanCompleted(l.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await ue.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}},5e3)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}l.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(l.rootPlanId??""))}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const l=await this.getPlanDetails(this.state.activePlanId);if(!l){console.warn("[PlanExecutionManager] No details received from API");return}if(l.rootPlanId&&this.setCachedPlanRecord(l.rootPlanId,l),!l.steps||l.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(l.rootPlanId??""),this.handlePlanCompletion(l);return}this.emitPlanUpdate(l.rootPlanId??""),l.completed&&this.handlePlanCompletion(l)}catch(l){console.error("[PlanExecutionManager] Failed to poll plan status:",l)}finally{this.state.isPolling=!1}}}async getPlanDetails(l){try{const n=await De.getDetails(l);return n!=null&&n.rootPlanId&&(this.planExecutionCache.set(n.rootPlanId,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${n.rootPlanId}`)),n}catch(n){return console.error("[PlanExecutionManager] Failed to get plan details:",n),null}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(l){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(l)}emitDialogRoundStart(l){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(l)}emitPlanUpdate(l){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(l)}emitPlanCompleted(l){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(l)}};re(ge,"instance",null);let Te=ge;const ee=Te.getInstance(),ln={class:"right-panel"},cn={class:"preview-header"},rn={class:"preview-tabs"},un={class:"tab-button active"},dn={class:"preview-content"},pn={class:"step-details"},hn={key:0,class:"step-info-fixed"},gn={key:0,class:"agent-info"},vn={class:"info-item"},mn={class:"label"},fn={class:"value"},Pn={class:"info-item"},_n={class:"label"},bn={class:"value"},Sn={class:"info-item"},kn={class:"label"},Cn={class:"value"},$n={class:"info-item"},En={class:"label"},yn={class:"value"},wn={class:"info-item"},In={class:"label"},xn={class:"execution-status"},Tn={class:"status-item"},Rn={class:"status-text"},Dn={key:0},An={key:0,class:"think-act-steps"},Nn={class:"steps-container"},Mn={class:"step-header"},Ln={class:"step-number"},Un={class:"think-section"},qn={class:"think-content"},On={class:"input"},Fn={class:"label"},Vn={class:"output"},Bn={class:"label"},jn={key:0,class:"action-section"},Wn={class:"action-content"},Jn={class:"tool-info"},Hn={class:"label"},zn={class:"value"},Gn={class:"input"},Xn={class:"label"},Kn={class:"output"},Qn={class:"label"},Yn={key:0,class:"sub-plan-section"},Zn={class:"sub-plan-content"},es={class:"sub-plan-header"},ts={class:"sub-plan-info"},ns={class:"value"},ss={key:0,class:"sub-plan-info"},os={class:"value"},as={class:"sub-plan-status"},ls={class:"status-text"},is={key:0,class:"no-steps-message"},cs={key:1,class:"no-execution-message"},rs={class:"step-basic-info"},us={class:"info-item"},ds={class:"label"},ps={class:"value"},hs={key:0,class:"info-item"},gs={class:"value"},vs={class:"info-item"},ms={class:"no-execution-hint"},fs={key:2,class:"execution-indicator"},Ps={class:"execution-text"},_s={key:1,class:"no-selection"},bs=["title"],Ss=Se({__name:"index",setup(W,{expose:l}){const{t:n}=ke(),r=A(),o=A(),h=A(),C=A(null),S=A(!1),I=A(!0),x=A(!0),H=ie(()=>h.value?h.value.completed?n("rightPanel.status.completed"):h.value.current?n("rightPanel.status.executing"):n("rightPanel.status.waiting"):""),X=v=>{var U;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${v}`),h.value&&C.value){const M=C.value.rootPlanId??o.value;if(M&&M!==v){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${M}, Requested: ${v}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${v}`);const m=ee.getCachedPlanRecord(v);if(!m){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${v}`);return}if(m.steps&&m.steps.length>0){const M=m.steps.length,b=(m.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${b} / ${M}`)}if(h.value&&o.value&&(o.value===v||((U=C.value)==null?void 0:U.rootPlanId)===v)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${v}`),C.value)){const b=C.value,N=D(b.planId,b.rootPlanId,b.subPlanId);N?(Y(N,b.stepIndex,b.planId,b.isSubPlan),z()):console.warn("[RightPanel] Could not find plan record for refresh:",b)}},_=(v,m,U,M,b)=>{console.log("[RightPanel] Step selected:",{planId:v,stepIndex:m,rootPlanId:U,subPlanId:M,subStepIndex:b});const N=!!(U&&M&&b!==void 0);C.value={planId:v,stepIndex:m,isSubPlan:N,...N&&{rootPlanId:U,subPlanId:M,subStepIndex:b}};const Q=D(v,U,M);if(!Q){console.warn("[RightPanel] Plan data not found:",{planId:v,rootPlanId:U,subPlanId:M}),h.value=null,C.value=null;return}Y(Q,m,v,N)},D=(v,m,U)=>{var N;if(!m||!U)return ee.getCachedPlanRecord(v)??null;const M=ee.getCachedPlanRecord(v);if(M)return M;const b=ee.getCachedPlanRecord(m);if(!(b!=null&&b.agentExecutionSequence))return null;for(const Q of b.agentExecutionSequence)if(Q.thinkActSteps){for(const te of Q.thinkActSteps)if(((N=te.subPlanExecutionRecord)==null?void 0:N.currentPlanId)===U)return te.subPlanExecutionRecord}return null},Y=(v,m,U,M)=>{var P,k,u,E,Z;if(!v.steps||m>=v.steps.length){h.value=null,C.value=null,console.warn("[RightPanel] Invalid step data:",{planId:U,stepIndex:m,hasSteps:!!v.steps,stepsLength:(P=v.steps)==null?void 0:P.length,message:"Invalid step index"});return}o.value=U;const b=v.steps[m],N=(k=v.agentExecutionSequence)==null?void 0:k[m];console.log("[RightPanel] Step data details:",{planId:U,stepIndex:m,step:b,hasAgentExecutionSequence:!!v.agentExecutionSequence,agentExecutionSequenceLength:(u=v.agentExecutionSequence)==null?void 0:u.length,agentExecution:N,hasThinkActSteps:!!(N!=null&&N.thinkActSteps),thinkActStepsLength:(E=N==null?void 0:N.thinkActSteps)==null?void 0:E.length,isSubPlan:M});const Q=(N==null?void 0:N.status)==="FINISHED",te=!Q&&m===v.currentStepIndex&&!v.completed,pe={planId:U,index:m,title:typeof b=="string"?b:b.title||b.description||b.name||`${M?"子":""}步骤 ${m+1}`,description:typeof b=="string"?b:b.description||b,completed:Q,current:te};N&&(pe.agentExecution=N),h.value=pe,console.log("[RightPanel] Step details updated:",{planId:U,stepIndex:m,stepTitle:h.value.title,hasAgentExecution:!!N,hasThinkActSteps:(((Z=N==null?void 0:N.thinkActSteps)==null?void 0:Z.length)??0)>0,completed:Q,current:te,planCurrentStep:v.currentStepIndex,planCompleted:v.completed,isSubPlan:M}),N!=null&&N.thinkActSteps&&N.thinkActSteps.forEach((s,t)=>{s.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${t}:`,s.subPlanExecutionRecord)}),setTimeout(()=>{T()},100),z()},d=(v,m,U,M)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:v,subPlanId:m,stepIndex:U,subStepIndex:M}),_(m,M,v,m,M)},$=v=>{r.value=v??void 0},T=()=>{if(!r.value)return;const{scrollTop:v,scrollHeight:m,clientHeight:U}=r.value,M=m-v-U<50,b=m>U;I.value=M,S.value=b&&!M,M?x.value=!0:m-v-U>100&&(x.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:v,scrollHeight:m,clientHeight:U,isAtBottom:M,hasScrollableContent:b,showButton:S.value,shouldAutoScroll:x.value})},O=()=>{r.value&&(r.value.scrollTo({top:r.value.scrollHeight,behavior:"smooth"}),le(()=>{x.value=!0,T()}))},z=()=>{!x.value||!r.value||le(()=>{r.value&&(r.value.scrollTop=r.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},K=v=>{if(v===null||typeof v>"u"||v==="")return"N/A";try{const m=typeof v=="object"?v:JSON.parse(v);return JSON.stringify(m,null,2)}catch{return String(v)}},de=()=>{h.value=null,o.value=void 0,x.value=!0,r.value&&r.value.removeEventListener("scroll",T)},he=()=>{const v=()=>{const m=r.value;return m?($(m),m.addEventListener("scroll",T),x.value=!0,T(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};le(()=>{v()||setTimeout(()=>{v()},100)})};return Ce(()=>{console.log("[RightPanel] Component mounted"),le(()=>{he()})}),$e(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),C.value=null,de()}),l({updateDisplayedPlanProgress:X,handleStepSelected:_,handleSubPlanStepSelected:d}),(v,m)=>{var U,M;return g(),f("div",ln,[e("div",cn,[e("div",rn,[e("button",un,[y(a(w),{icon:"carbon:events"}),ne(" "+c(a(n)("rightPanel.stepExecutionDetails")),1)])])]),e("div",dn,[e("div",pn,[h.value?(g(),f("div",hn,[e("h3",null,c(h.value.title||h.value.description||a(n)("rightPanel.defaultStepTitle",{number:h.value.index+1})),1),h.value.agentExecution?(g(),f("div",gn,[e("div",vn,[e("span",mn,c(a(n)("rightPanel.executingAgent"))+":",1),e("span",fn,c(h.value.agentExecution.agentName),1)]),e("div",Pn,[e("span",_n,c(a(n)("rightPanel.description"))+":",1),e("span",bn,c(h.value.agentExecution.agentDescription||""),1)]),e("div",Sn,[e("span",kn,c(a(n)("rightPanel.callingModel"))+":",1),e("span",Cn,c(h.value.agentExecution.modelName),1)]),e("div",$n,[e("span",En,c(a(n)("rightPanel.request"))+":",1),e("span",yn,c(h.value.agentExecution.agentRequest||""),1)]),e("div",wn,[e("span",In,c(a(n)("rightPanel.executionResult"))+":",1),e("span",{class:ae(["value",{success:h.value.agentExecution.status==="FINISHED"}])},c(h.value.agentExecution.status||a(n)("rightPanel.executing")),3)])])):J("",!0),e("div",xn,[e("div",Tn,[h.value.completed?(g(),be(a(w),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):h.value.current?(g(),be(a(w),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(g(),be(a(w),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",Rn,c(H.value),1)])])])):J("",!0),e("div",{ref_key:"scrollContainer",ref:r,class:"step-details-scroll-container",onScroll:T},[h.value?(g(),f("div",Dn,[(U=h.value.agentExecution)!=null&&U.thinkActSteps&&h.value.agentExecution.thinkActSteps.length>0?(g(),f("div",An,[e("h4",null,c(a(n)("rightPanel.thinkAndActionSteps")),1),e("div",Nn,[(g(!0),f(ve,null,me(h.value.agentExecution.thinkActSteps,(b,N)=>(g(),f("div",{key:N,class:"think-act-step"},[e("div",Mn,[e("span",Ln,"#"+c(N+1),1),e("span",{class:ae(["step-status",b.status])},c(b.status||a(n)("rightPanel.executing")),3)]),e("div",Un,[e("h5",null,[y(a(w),{icon:"carbon:thinking"}),ne(" "+c(a(n)("rightPanel.thinking")),1)]),e("div",qn,[e("div",On,[e("span",Fn,c(a(n)("rightPanel.input"))+":",1),e("pre",null,c(K(b.thinkInput)),1)]),e("div",Vn,[e("span",Bn,c(a(n)("rightPanel.output"))+":",1),e("pre",null,c(K(b.thinkOutput)),1)])])]),b.actionNeeded?(g(),f("div",jn,[e("h5",null,[y(a(w),{icon:"carbon:play"}),ne(" "+c(a(n)("rightPanel.action")),1)]),e("div",Wn,[(g(!0),f(ve,null,me(b.actToolInfoList,(Q,te)=>(g(),f("div",{key:te},[e("div",Jn,[e("span",Hn,c(a(n)("rightPanel.tool"))+":",1),e("span",zn,c(Q.name||""),1)]),e("div",Gn,[e("span",Xn,c(a(n)("rightPanel.toolParameters"))+":",1),e("pre",null,c(K(Q.parameters)),1)]),e("div",Kn,[e("span",Qn,c(a(n)("rightPanel.executionResult"))+":",1),e("pre",null,c(K(Q.result)),1)])]))),128))]),b.subPlanExecutionRecord?(g(),f("div",Yn,[e("h5",null,[y(a(w),{icon:"carbon:tree-view"}),ne(" "+c(a(n)("rightPanel.subPlan")),1)]),e("div",Zn,[e("div",es,[e("div",ts,[m[0]||(m[0]=e("span",{class:"label"},"子计划ID:",-1)),e("span",ns,c(b.subPlanExecutionRecord.currentPlanId),1)]),b.subPlanExecutionRecord.title?(g(),f("div",ss,[m[1]||(m[1]=e("span",{class:"label"},"标题:",-1)),e("span",os,c(b.subPlanExecutionRecord.title),1)])):J("",!0),e("div",as,[b.subPlanExecutionRecord.completed?(g(),be(a(w),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(g(),be(a(w),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",ls,c(b.subPlanExecutionRecord.completed?"已完成":"执行中"),1)])])])])):J("",!0)])):J("",!0)]))),128))]),h.value.agentExecution&&!((M=h.value.agentExecution.thinkActSteps)!=null&&M.length)?(g(),f("div",is,[e("p",null,c(a(n)("rightPanel.noStepDetails")),1)])):h.value.agentExecution?J("",!0):(g(),f("div",cs,[y(a(w),{icon:"carbon:information",class:"info-icon"}),e("h4",null,c(a(n)("rightPanel.stepInfo")),1),e("div",rs,[e("div",us,[e("span",ds,c(a(n)("rightPanel.stepName"))+":",1),e("span",ps,c(h.value.title||h.value.description||`步骤 ${h.value.index+1}`),1)]),h.value.description?(g(),f("div",hs,[m[2]||(m[2]=e("span",{class:"label"},"描述:",-1)),e("span",gs,c(h.value.description),1)])):J("",!0),e("div",vs,[m[3]||(m[3]=e("span",{class:"label"},"状态:",-1)),e("span",{class:ae(["value",{"status-completed":h.value.completed,"status-current":h.value.current,"status-pending":!h.value.completed&&!h.value.current}])},c(h.value.completed?"已完成":h.value.current?"执行中":"待执行"),3)])]),e("p",ms,c(a(n)("rightPanel.noExecutionInfo")),1)])),h.value.current&&!h.value.completed?(g(),f("div",fs,[m[4]||(m[4]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",Ps,[y(a(w),{icon:"carbon:in-progress",class:"rotating-icon"}),ne(" "+c(a(n)("rightPanel.stepExecuting")),1)])])):J("",!0)])):(g(),f("div",_s,[y(a(w),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,c(a(n)("rightPanel.noStepSelected")),1),e("p",null,c(a(n)("rightPanel.selectStepHint")),1)]))])):J("",!0),y(st,{name:"scroll-button"},{default:ot(()=>[S.value?(g(),f("button",{key:0,onClick:O,class:"scroll-to-bottom-btn",title:a(n)("rightPanel.scrollToBottom")},[y(a(w),{icon:"carbon:chevron-down"})],8,bs)):J("",!0)]),_:1})],544)])])])}}}),ks=Ee(Ss,[["__scopeId","data-v-e90596ce"]]);function Cs(){const W=ee,l=ie(()=>W.getActivePlanId()),n=ie(()=>W.getState()),r=ie(()=>n.value.isPolling),o=ie(()=>!!l.value),h=(x,H)=>{W.initiatePlanExecutionSequence(x,H)},C=()=>{W.stopPolling()},S=()=>{W.startPolling()},I=()=>{W.cleanup()};return $e(()=>{I()}),{activePlanId:l,state:n,isPolling:r,hasActivePlan:o,startExecution:h,stopPolling:C,startPolling:S,cleanup:I}}const $s={class:"chat-container"},Es={class:"message-content"},ys={key:0,class:"user-message"},ws={key:1,class:"assistant-message"},Is={key:0,class:"thinking-section"},xs={class:"thinking-header"},Ts={class:"thinking-avatar"},Rs={class:"thinking-label"},Ds={class:"thinking-content"},As={key:0,class:"thinking"},Ns={key:1,class:"progress"},Ms={class:"progress-bar"},Ls={class:"progress-text"},Us={key:2,class:"steps-container"},qs={class:"steps-title"},Os=["onClick"],Fs={class:"section-header"},Vs={class:"step-icon"},Bs={class:"step-title"},js={key:0,class:"step-status current"},Ws={key:1,class:"step-status completed"},Js={key:2,class:"step-status pending"},Hs={key:0,class:"action-info"},zs={class:"action-description"},Gs={class:"action-icon"},Xs={key:0,class:"tool-params"},Ks={class:"param-label"},Qs={class:"param-content"},Ys={key:1,class:"think-details"},Zs={class:"think-header"},eo={class:"think-label"},to={class:"think-output"},no={class:"think-content"},so={key:1,class:"sub-plan-steps"},oo={class:"sub-plan-header"},ao={class:"sub-plan-step-list"},lo=["onClick"],io={class:"sub-step-indicator"},co={class:"sub-step-icon"},ro={class:"sub-step-number"},uo={class:"sub-step-content"},po={class:"sub-step-title"},ho={key:2,class:"user-input-form-container"},go={class:"user-input-message"},vo={key:0,class:"form-description"},mo=["onSubmit"],fo=["for"],Po=["id","name","onUpdate:modelValue"],_o={key:1,class:"form-group"},bo={for:"form-input-genericInput"},So=["onUpdate:modelValue"],ko={type:"submit",class:"submit-user-input-btn"},Co={key:3,class:"default-processing"},$o={class:"processing-indicator"},Eo={class:"response-section"},yo={class:"response-header"},wo={class:"response-avatar"},Io={class:"response-name"},xo={class:"response-content"},To={key:0,class:"final-response"},Ro=["innerHTML"],Do={key:1,class:"response-placeholder"},Ao={class:"typing-indicator"},No={class:"typing-text"},Mo={key:0,class:"message assistant"},Lo={class:"message-content"},Uo={class:"assistant-message"},qo={class:"thinking-section"},Oo={class:"thinking-header"},Fo={class:"thinking-avatar"},Vo={class:"thinking-label"},Bo={class:"thinking-content"},jo={class:"default-processing"},Wo={class:"processing-indicator"},Jo={class:"response-section"},Ho={class:"response-header"},zo={class:"response-avatar"},Go={class:"response-name"},Xo={class:"response-content"},Ko={class:"response-placeholder"},Qo={class:"typing-indicator"},Yo={class:"typing-text"},Zo=["title"],ea=Se({__name:"index",props:{mode:{default:"plan"},initialPrompt:{}},emits:["step-selected","sub-plan-step-selected"],setup(W,{expose:l,emit:n}){const r=W,o=n,{t:h}=ke(),C=Cs(),S=A(),I=A(!1),x=A([]),H=A(),X=A(!1),_=Ye({}),D=(s,t,i)=>{const p={id:Date.now().toString(),type:s,content:t,timestamp:new Date,...i};return s==="assistant"&&!p.thinking&&!p.content&&(p.thinking=h("chat.thinking")),x.value.push(p),p},Y=s=>{const t=x.value[x.value.length-1];t.type==="assistant"&&Object.assign(t,s)},d=async s=>{try{I.value=!0;const t=D("assistant","",{thinking:"正在理解您的请求并准备回复..."}),i=await Re.sendMessage(s);if(i.planId)console.log("[ChatComponent] Received planId from direct execution:",i.planId),t.planExecution||(t.planExecution={}),t.planExecution.currentPlanId=i.planId,ee.handlePlanExecutionRequested(i.planId,s),delete t.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete t.thinking;const p=$(i,s);t.content=p}}catch(t){console.error("Direct mode error:",t),Y({content:T(t)})}finally{I.value=!1}},$=(s,t)=>s.result??s.message??s.content??"",T=s=>{const t=(s==null?void 0:s.message)??(s==null?void 0:s.toString())??"未知错误";return t.includes("网络")||t.includes("network")||t.includes("timeout")?"抱歉，似乎网络连接有些问题。请检查您的网络连接后再试一次，或者稍等几分钟再重新提问。":t.includes("认证")||t.includes("权限")||t.includes("auth")?"抱歉，访问权限出现了问题。这可能是系统配置的问题，请联系管理员或稍后再试。":t.includes("格式")||t.includes("参数")||t.includes("invalid")?"抱歉，您的请求格式可能有些问题。能否请您重新表述一下您的需求？我会尽力理解并帮助您。":`抱歉，处理您的请求时遇到了一些问题（${t}）。请稍后再试，或者换个方式表达您的需求，我会尽力帮助您的。`},O=(s=!1)=>{le(()=>{if(S.value){const t=S.value;(s||t.scrollHeight-t.scrollTop-t.clientHeight<150)&&t.scrollTo({top:t.scrollHeight,behavior:s?"auto":"smooth"})}})},z=()=>{O(!0),X.value=!1},K=()=>{if(S.value){const s=S.value,t=s.scrollHeight-s.scrollTop-s.clientHeight<150;X.value=!t&&x.value.length>0}},de=()=>{S.value&&S.value.addEventListener("scroll",K)},he=()=>{S.value&&S.value.removeEventListener("scroll",K)},v=s=>{D("user",s),r.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",s):d(s)},m=(s,t)=>{var V;const p=(((V=s.planExecution)==null?void 0:V.agentExecutionSequence)??[])[t];return p?p.status??"IDLE":"IDLE"},U=(s,t)=>{var i,p;if(!((i=s.planExecution)!=null&&i.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:s.planExecution.currentPlanId,stepIndex:t,stepTitle:(p=s.planExecution.steps)==null?void 0:p[t]}),o("step-selected",s.planExecution.currentPlanId,t)},M=(s,t)=>{var i;try{const p=(i=s.planExecution)==null?void 0:i.agentExecutionSequence;if(!(p!=null&&p.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const V=p[t];if(!V)return console.log(`[ChatComponent] No agentExecution found for step ${t}`),[];if(!V.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${t}`),[];for(const L of V.thinkActSteps)if(L.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${t}:`,L.subPlanExecutionRecord),(L.subPlanExecutionRecord.steps??[]).map(B=>typeof B=="string"?B:typeof B=="object"&&B!==null&&(B.title||B.description)||"子步骤");return[]}catch(p){return console.warn("[ChatComponent] Error getting sub-plan steps:",p),[]}},b=(s,t,i)=>{var p;try{const V=(p=s.planExecution)==null?void 0:p.agentExecutionSequence;if(!(V!=null&&V.length))return"pending";const L=V[t];if(!L||!L.thinkActSteps)return"pending";let G=null;for(const F of L.thinkActSteps)if(F.subPlanExecutionRecord){G=F.subPlanExecutionRecord;break}if(!G)return"pending";const B=G.currentStepIndex;return G.completed?"completed":B==null?i===0?"current":"pending":i<B?"completed":i===B?"current":"pending"}catch(V){return console.warn("[ChatComponent] Error getting sub-plan step status:",V),"pending"}},N=(s,t,i)=>{var p,V;try{const L=(p=s.planExecution)==null?void 0:p.agentExecutionSequence;if(!(L!=null&&L.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const G=L[t];if(!G){console.warn("[ChatComponent] No agentExecution found for step",t);return}if(!G.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",t);return}let B=null;for(const F of G.thinkActSteps)if(F.subPlanExecutionRecord){B=F.subPlanExecutionRecord;break}if(!(B!=null&&B.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}o("sub-plan-step-selected",((V=s.planExecution)==null?void 0:V.currentPlanId)??"",B.currentPlanId,t,i)}catch(L){console.error("[ChatComponent] Error handling sub-plan step click:",L)}},Q=(s,t)=>{var p,V,L,G;if(!((p=s.planExecution)!=null&&p.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",s.planExecution.steps.length,"execution sequence:",((V=t.agentExecutionSequence)==null?void 0:V.length)??0);const i=new Array(s.planExecution.steps.length).fill(null);if((L=t.agentExecutionSequence)!=null&&L.length){const B=Math.min(t.agentExecutionSequence.length,s.planExecution.steps.length);for(let F=0;F<B;F++){const R=t.agentExecutionSequence[F];if((G=R==null?void 0:R.thinkActSteps)!=null&&G.length){const q=R.thinkActSteps[R.thinkActSteps.length-1];q!=null&&q.actionDescription&&(q!=null&&q.toolParameters)?(i[F]={actionDescription:q.actionDescription,toolParameters:typeof q.toolParameters=="string"?q.toolParameters:JSON.stringify(q.toolParameters,null,2),thinkInput:q.thinkInput??"",thinkOutput:q.thinkOutput??"",status:t.currentStepIndex!==void 0&&F<t.currentStepIndex?"completed":t.currentStepIndex!==void 0&&F===t.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${F} action set: ${i[F].actionDescription}`)):q?(i[F]={actionDescription:"思考中",toolParameters:"等待决策",thinkInput:q.thinkInput??"",thinkOutput:q.thinkOutput??"",status:t.currentStepIndex!==void 0&&F===t.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${F} is thinking`)):(i[F]={actionDescription:"执行完成",toolParameters:"无工具",thinkInput:"",thinkOutput:"",status:"completed"},console.log(`[ChatComponent] Step ${F} execution completed`))}else i[F]={actionDescription:t.currentStepIndex!==void 0&&F<t.currentStepIndex?"已完成":"等待中",toolParameters:"无工具参数",thinkInput:"",thinkOutput:"",status:t.currentStepIndex!==void 0&&F<t.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] 步骤 ${F} 无执行细节, 状态设为: ${i[F].status}`)}}else console.log("[ChatComponent] 没有执行序列数据");s.stepActions=[...i],console.log("[ChatComponent] 步骤动作更新完成:",JSON.stringify(i.map(B=>B==null?void 0:B.actionDescription))),le(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},te=s=>{console.log("[ChatComponent] Starting dialog round with planId:",s),s&&(x.value.findIndex(i=>{var p;return((p=i.planExecution)==null?void 0:p.currentPlanId)===s&&i.type==="assistant"})===-1?(D("assistant","",{planExecution:{currentPlanId:s},thinking:"正在准备执行计划..."}),console.log("[ChatComponent] Created new assistant message for planId:",s)):console.log("[ChatComponent] Found existing assistant message for planId:",s))},pe=s=>{var L,G,B,F;console.log("[ChatComponent] Processing plan update with rootPlanId:",s);const t=ee.getCachedPlanRecord(s);if(!t){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",s);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",t),console.log("[ChatComponent] Plan steps:",t.steps),console.log("[ChatComponent] Plan completed:",t.completed),!t.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const i=x.value.findIndex(R=>{var q;return((q=R.planExecution)==null?void 0:q.currentPlanId)===t.currentPlanId&&R.type==="assistant"});let p;if(i!==-1)p=x.value[i],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",t.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",t.currentPlanId),console.log("[ChatComponent] Current messages:",x.value.map(q=>{var se;return{type:q.type,planId:(se=q.planExecution)==null?void 0:se.currentPlanId,content:q.content.substring(0,50)}}));let R=-1;for(let q=x.value.length-1;q>=0;q--)if(x.value[q].type==="assistant"){R=q;break}if(R!==-1)p=x.value[R],p.planExecution||(p.planExecution={}),p.planExecution.currentPlanId=t.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",t.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(p.planExecution||(p.planExecution={}),p.planExecution=JSON.parse(JSON.stringify(t)),!t.steps||t.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),t.completed){delete p.thinking;const R=t.summary??t.result??t.message??"处理完成";p.content=P(R),console.log("[ChatComponent] Set simple response content:",p.content)}else t.title&&(p.thinking=`正在执行: ${t.title}`);return}delete p.thinking;const V=t.steps.map(R=>typeof R=="string"?R:typeof R=="object"&&R!==null&&(R.title||R.description)||"步骤");if(p.planExecution&&(p.planExecution.steps=V),t.agentExecutionSequence&&t.agentExecutionSequence.length>0){console.log("[ChatComponent] 发现执行序列数据，数量:",t.agentExecutionSequence.length),Q(p,t);const R=t.currentStepIndex??0;if(R>=0&&R<t.agentExecutionSequence.length){const se=t.agentExecutionSequence[R].thinkActSteps;if(se&&se.length>0){const fe=se[se.length-1];if(fe.thinkOutput){const ye=fe.thinkOutput.length>150?fe.thinkOutput.substring(0,150)+"...":fe.thinkOutput;p.thinking=`正在思考: ${ye}`}}}}else if(p.planExecution){const R=p.planExecution.currentStepIndex??0,q=(L=p.planExecution.steps)==null?void 0:L[R],se=typeof q=="string"?q:"";p.thinking=`正在执行: ${se}`}if(t.userInputWaitState&&p.planExecution?(console.log("[ChatComponent] 需要用户输入:",t.userInputWaitState),p.planExecution.userInputWaitState||(p.planExecution.userInputWaitState={}),p.planExecution.userInputWaitState={message:t.userInputWaitState.message??"",formDescription:t.userInputWaitState.formDescription??"",formInputs:((G=t.userInputWaitState.formInputs)==null?void 0:G.map(R=>({label:R.label,value:R.value||""})))??[]},_[B=p.id]??(_[B]={}),p.thinking="等待用户输入..."):(F=p.planExecution)!=null&&F.userInputWaitState&&delete p.planExecution.userInputWaitState,t.completed??t.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete p.thinking;let R="";t.summary?R=t.summary:t.result?R=t.result:R="任务已完成",p.content=k(R),console.log("[ChatComponent] Updated completed message:",p.content)}le(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},P=s=>s?s.includes("我")||s.includes("您")||s.includes("您好")||s.includes("可以")?s:s.length<10?`${s}！还有什么需要我帮助的吗？`:s.length<50?`好的，${s}。如果您还有其他问题，请随时告诉我。`:`${s}

希望这个回答对您有帮助！还有什么我可以为您做的吗？`:"我明白了，还有什么我可以帮您的吗？",k=s=>s?`${s}`:"任务已完成！还有什么我可以帮您的吗？",u=s=>{console.log("[ChatComponent] Plan completed with rootPlanId:",s);const t=ee.getCachedPlanRecord(s);if(!t){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",s);return}if(console.log("[ChatComponent] Plan details:",t),t!=null&&t.rootPlanId){const i=x.value.findIndex(p=>{var V;return((V=p.planExecution)==null?void 0:V.currentPlanId)===t.rootPlanId});if(i!==-1){const p=x.value[i];delete p.thinking;let L=t.summary??t.result??"任务已完成";!L.includes("我")&&!L.includes("您")&&(L.includes("成功")||L.includes("完成")?L=`很好！${L}。如果您还有其他需要帮助的地方，请随时告诉我。`:L=`我已经完成了您的请求：${L}`),p.content=L,console.log("[ChatComponent] Updated completed message:",p.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",t.rootPlanId)}},E=s=>{if(!s)return"";let t=s.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return t=t.replace(/(<br><br>)/g,"</p><p>"),t.includes("</p><p>")&&(t=`<p>${t}</p>`),t},Z=async s=>{var t;if(!((t=s.planExecution)!=null&&t.currentPlanId)||!s.planExecution.userInputWaitState){console.error("[ChatComponent] 缺少planExecution.currentPlanId或userInputWaitState");return}try{const i={},p=s.planExecution.userInputWaitState.formInputs;p&&p.length>0?Object.entries(_[s.id]).forEach(([L,G])=>{var R;const B=parseInt(L,10),F=((R=p[B])==null?void 0:R.label)||`input_${L}`;i[F]=G}):i.genericInput=s.genericInput??"",console.log("[ChatComponent] 提交用户输入:",i);const V=await De.submitFormInput(s.planExecution.currentPlanId,i);delete s.planExecution.userInputWaitState,delete s.genericInput,delete _[s.id],C.startPolling(),console.log("[ChatComponent] 用户输入提交成功:",V)}catch(i){console.error("[ChatComponent] 用户输入提交失败:",i),alert(`提交失败: ${(i==null?void 0:i.message)||"未知错误"}`)}};return Ie(()=>r.initialPrompt,(s,t)=>{console.log("[ChatComponent] initialPrompt changed from:",t,"to:",s),s&&typeof s=="string"&&s.trim()&&s!==t&&(console.log("[ChatComponent] Processing changed initial prompt:",s),le(()=>{v(s)}))},{immediate:!1}),Ce(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),ee.setEventCallbacks({onPlanUpdate:pe,onPlanCompleted:u,onDialogRoundStart:te,onChatInputUpdateState:s=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",s)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")}}),le(()=>{de()}),r.initialPrompt&&typeof r.initialPrompt=="string"&&r.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",r.initialPrompt),le(()=>{v(r.initialPrompt)}))}),$e(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),he(),H.value&&clearInterval(H.value),C.cleanup(),Object.keys(_).forEach(s=>delete _[s])}),l({handleSendMessage:v,handlePlanUpdate:pe,handlePlanCompleted:u,handleDialogRoundStart:te,addMessage:D}),(s,t)=>(g(),f("div",$s,[e("div",{class:"messages",ref_key:"messagesRef",ref:S},[(g(!0),f(ve,null,me(x.value,i=>{var p,V,L,G,B,F,R,q,se;return g(),f("div",{key:i.id,class:ae(["message",{user:i.type==="user",assistant:i.type==="assistant"}])},[e("div",Es,[i.type==="user"?(g(),f("div",ys,c(i.content),1)):(g(),f("div",ws,[i.thinking||((p=i.planExecution)==null?void 0:p.progress)!==void 0||(((L=(V=i.planExecution)==null?void 0:V.steps)==null?void 0:L.length)??0)>0?(g(),f("div",Is,[e("div",xs,[e("div",Ts,[y(a(w),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Rs,c(s.$t("chat.thinkingLabel")),1)]),e("div",Ds,[i.thinking?(g(),f("div",As,[y(a(w),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,c(i.thinking),1)])):J("",!0),((G=i.planExecution)==null?void 0:G.progress)!==void 0?(g(),f("div",Ns,[e("div",Ms,[e("div",{class:"progress-fill",style:xe({width:i.planExecution.progress+"%"})},null,4)]),e("span",Ls,c(i.planExecution.progressText??s.$t("chat.processing")+"..."),1)])):J("",!0),(((F=(B=i.planExecution)==null?void 0:B.steps)==null?void 0:F.length)??0)>0?(g(),f("div",Us,[e("h4",qs,c(s.$t("chat.stepExecutionDetails")),1),(g(!0),f(ve,null,me((R=i.planExecution)==null?void 0:R.steps,(fe,j)=>{var ye,Ae,Ne,Me,Le,Ue,qe,Oe,Fe,Ve,Be,je,We,Je,He,ze,Ge,Xe,Ke;return g(),f("div",{key:j,class:ae(["ai-section",{running:m(i,j)==="RUNNING",completed:m(i,j)==="FINISHED",pending:m(i,j)==="IDLE"}]),onClick:we(ce=>U(i,j),["stop"])},[e("div",Fs,[e("span",Vs,c(m(i,j)==="FINISHED"?"✓":m(i,j)==="RUNNING"?"▶":"○"),1),e("span",Bs,c(fe||`${s.$t("chat.step")} ${j+1}`),1),m(i,j)==="RUNNING"?(g(),f("span",js,c(s.$t("chat.status.executing")),1)):m(i,j)==="FINISHED"?(g(),f("span",Ws,c(s.$t("chat.status.completed")),1)):(g(),f("span",Js,c(s.$t("chat.status.pending")),1))]),i.stepActions&&i.stepActions[j]?(g(),f("div",Hs,[e("div",zs,[e("span",Gs,c(((ye=i.stepActions[j])==null?void 0:ye.status)==="current"?"🔄":((Ae=i.stepActions[j])==null?void 0:Ae.status)==="completed"?"✓":"⏳"),1),e("strong",null,c((Ne=i.stepActions[j])==null?void 0:Ne.actionDescription),1)]),(Me=i.stepActions[j])!=null&&Me.toolParameters?(g(),f("div",Xs,[t[0]||(t[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",Ks,c(s.$t("common.parameters"))+":",1),e("pre",Qs,c((Le=i.stepActions[j])==null?void 0:Le.toolParameters),1)])):J("",!0),(Ue=i.stepActions[j])!=null&&Ue.thinkOutput?(g(),f("div",Ys,[e("div",Zs,[t[1]||(t[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",eo,c(s.$t("chat.thinkingOutput"))+":",1)]),e("div",to,[e("pre",no,c((qe=i.stepActions[j])==null?void 0:qe.thinkOutput),1)])])):J("",!0)])):J("",!0),((Oe=M(i,j))==null?void 0:Oe.length)>0?(g(),f("div",so,[e("div",oo,[y(a(w),{icon:"carbon:tree-view",class:"sub-plan-icon"}),t[2]||(t[2]=e("span",{class:"sub-plan-title"},"子执行计划",-1))]),e("div",ao,[(g(!0),f(ve,null,me(M(i,j),(ce,oe)=>(g(),f("div",{key:`sub-${j}-${oe}`,class:ae(["sub-plan-step-item",{completed:b(i,j,oe)==="completed",current:b(i,j,oe)==="current",pending:b(i,j,oe)==="pending"}]),onClick:we(Qe=>N(i,j,oe),["stop"])},[e("div",io,[e("span",co,c(b(i,j,oe)==="completed"?"✓":b(i,j,oe)==="current"?"▶":"○"),1),e("span",ro,c(oe+1),1)]),e("div",uo,[e("span",po,c(ce),1),t[3]||(t[3]=e("span",{class:"sub-step-badge"},"子步骤",-1))])],10,lo))),128))])])):J("",!0),(Fe=i.planExecution)!=null&&Fe.userInputWaitState&&m(i,j)==="RUNNING"?(g(),f("div",ho,[e("p",go,c(((Be=(Ve=i.planExecution)==null?void 0:Ve.userInputWaitState)==null?void 0:Be.message)??s.$t("chat.userInput.message")),1),(We=(je=i.planExecution)==null?void 0:je.userInputWaitState)!=null&&We.formDescription?(g(),f("p",vo,c((He=(Je=i.planExecution)==null?void 0:Je.userInputWaitState)==null?void 0:He.formDescription),1)):J("",!0),e("form",{onSubmit:we(ce=>Z(i),["prevent"]),class:"user-input-form"},[(Ge=(ze=i.planExecution)==null?void 0:ze.userInputWaitState)!=null&&Ge.formInputs&&i.planExecution.userInputWaitState.formInputs.length>0?(g(!0),f(ve,{key:0},me((Ke=(Xe=i.planExecution)==null?void 0:Xe.userInputWaitState)==null?void 0:Ke.formInputs,(ce,oe)=>(g(),f("div",{key:oe,class:"form-group"},[e("label",{for:`form-input-${ce.label.replace(/\W+/g,"_")}`},c(ce.label)+": ",9,fo),Pe(e("input",{type:"text",id:`form-input-${ce.label.replace(/\W+/g,"_")}`,name:ce.label,"onUpdate:modelValue":Qe=>_[i.id][oe]=Qe,class:"form-input"},null,8,Po),[[_e,_[i.id][oe]]])]))),128)):(g(),f("div",_o,[e("label",bo,c(s.$t("common.input"))+":",1),Pe(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":ce=>i.genericInput=ce,class:"form-input"},null,8,So),[[_e,i.genericInput]])])),e("button",ko,c(s.$t("chat.userInput.submit")),1)],40,mo)])):J("",!0)],10,Os)}),128))])):!i.content&&(i.thinking||((q=i.planExecution)==null?void 0:q.progress)!==void 0&&(((se=i.planExecution)==null?void 0:se.progress)??0)<100)?(g(),f("div",Co,[e("div",$o,[t[4]||(t[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,c(i.thinking??s.$t("chat.thinkingProcessing")),1)])])):J("",!0)])])):J("",!0),e("div",Eo,[e("div",yo,[e("div",wo,[y(a(w),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Io,c(s.$t("chat.botName")),1)]),e("div",xo,[i.content?(g(),f("div",To,[e("div",{class:"response-text",innerHTML:E(i.content)},null,8,Ro)])):(g(),f("div",Do,[e("div",Ao,[t[5]||(t[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",No,c(s.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),I.value?(g(),f("div",Mo,[e("div",Lo,[e("div",Uo,[e("div",qo,[e("div",Oo,[e("div",Fo,[y(a(w),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Vo,c(s.$t("chat.thinkingLabel")),1)]),e("div",Bo,[e("div",jo,[e("div",Wo,[t[6]||(t[6]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,c(s.$t("chat.thinking")),1)])])])]),e("div",Jo,[e("div",Ho,[e("div",zo,[y(a(w),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Go,c(s.$t("chat.botName")),1)]),e("div",Xo,[e("div",Ko,[e("div",Qo,[t[7]||(t[7]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Yo,c(s.$t("chat.thinkingResponse")),1)])])])])])])])):J("",!0)],512),X.value?(g(),f("div",{key:0,class:"scroll-to-bottom-btn",onClick:z,title:s.$t("chat.scrollToBottom")},[y(a(w),{icon:"carbon:chevron-down"})],8,Zo)):J("",!0)]))}}),ta=Ee(ea,[["__scopeId","data-v-5b649399"]]),na={class:"input-area"},sa={class:"input-container"},oa={class:"attach-btn",title:"附加文件"},aa=["placeholder","disabled"],la=["title"],ia=["disabled","title"],ca=Se({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1}},emits:["send","clear","update-state","plan-mode-clicked"],setup(W,{expose:l,emit:n}){const{t:r}=ke(),o=W,h=n,C=A(),S=A(""),I=ie(()=>o.placeholder||r("input.placeholder")),x=A(I.value),H=ie(()=>!!o.disabled),X=()=>{le(()=>{C.value&&(C.value.style.height="auto",C.value.style.height=Math.min(C.value.scrollHeight,120)+"px")})},_=O=>{O.key==="Enter"&&!O.shiftKey&&(O.preventDefault(),D())},D=()=>{if(!S.value.trim()||H.value)return;const O=S.value.trim();h("send",O),d()},Y=()=>{h("plan-mode-clicked")},d=()=>{S.value="",X(),h("clear")};return l({clearInput:d,updateState:(O,z)=>{z&&(x.value=O?z:r("input.waiting")),h("update-state",O,z)},getQuery:()=>S.value.trim(),focus:()=>{var O;return(O=C.value)==null?void 0:O.focus()}}),Ce(()=>{}),$e(()=>{}),(O,z)=>(g(),f("div",na,[e("div",sa,[e("button",oa,[y(a(w),{icon:"carbon:attachment"})]),Pe(e("textarea",{"onUpdate:modelValue":z[0]||(z[0]=K=>S.value=K),ref_key:"inputRef",ref:C,class:"chat-input",placeholder:x.value,disabled:H.value,onKeydown:_,onInput:X},null,40,aa),[[_e,S.value]]),e("button",{class:"plan-mode-btn",title:O.$t("input.planMode"),onClick:Y},[y(a(w),{icon:"carbon:document"}),ne(" "+c(O.$t("input.planMode")),1)],8,la),e("button",{class:"send-button",disabled:!S.value.trim()||H.value,onClick:D,title:O.$t("input.send")},[y(a(w),{icon:"carbon:send-alt"}),ne(" "+c(O.$t("input.send")),1)],8,ia)])]))}}),ra=Ee(ca,[["__scopeId","data-v-c8e17afe"]]),ua={class:"direct-page"},da={class:"direct-chat"},pa={class:"chat-header"},ha={class:"header-actions"},ga=["title"],va={class:"chat-content"},ma=["title"],fa=Se({__name:"index",setup(W){const l=at(),n=lt(),r=ct(),o=Ze(),{t:h}=ke(),C=A(""),S=A(),I=A(),x=A(),H=A(!1),X=A(!1),_=A(null),D=A(50),Y=A(!1),d=A(0),$=A(0);Ce(()=>{console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",r.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",r.hasUnprocessedTask()),ee.setEventCallbacks({onPlanUpdate:k=>{console.log("[Direct] Plan update event received for rootPlanId:",k),de(k)&&(console.log("[Direct] Processing plan update for current rootPlanId:",k),I.value&&typeof I.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",k),I.value.handlePlanUpdate(k)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),S.value&&typeof S.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",k),S.value.updateDisplayedPlanProgress(k)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:k=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",k),!!de(k)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",k),I.value&&typeof I.value.handlePlanCompleted=="function"){const u=ee.getCachedPlanRecord(k);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",u),I.value.handlePlanCompleted(u??{planId:k})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");_.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:k=>{console.log("[Direct] Dialog round start event received for rootPlanId:",k),_.value=k,console.log("[Direct] Set currentRootPlanId to:",k),I.value&&typeof I.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",k),I.value.handleDialogRoundStart(k)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),v()},onChatInputUpdateState:k=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",k),!de(k,!0))return;const u=ee.getCachedUIState(k);u&&U(u.enabled,u.placeholder)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),o.loadPlanTemplateList(),r.hasUnprocessedTask()&&r.currentTask?(C.value=r.currentTask.prompt,console.log("[Direct] Setting prompt from store:",C.value),r.markTaskAsProcessed(),console.log("[Direct] Received task from store:",C.value)):(C.value=l.query.prompt||"",console.log("[Direct] Received task from URL:",C.value),console.log("[Direct] No unprocessed task in store"));const P=localStorage.getItem("directPanelWidth");P&&(D.value=parseFloat(P)),console.log("[Direct] Final prompt value:",C.value)}),Ie(()=>r.currentTask,P=>{console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",P),P&&!P.processed?(C.value=P.prompt,r.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",C.value)):console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),Ie(()=>C.value,(P,k)=>{console.log("[Direct] prompt value changed from:",k,"to:",P)},{immediate:!1}),$e(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),_.value=null,ee.cleanup(),document.removeEventListener("mousemove",O),document.removeEventListener("mouseup",z)});const T=P=>{Y.value=!0,d.value=P.clientX,$.value=D.value,document.addEventListener("mousemove",O),document.addEventListener("mouseup",z),document.body.style.cursor="col-resize",document.body.style.userSelect="none",P.preventDefault()},O=P=>{if(!Y.value)return;const k=window.innerWidth,E=(P.clientX-d.value)/k*100;let Z=$.value+E;Z=Math.max(20,Math.min(80,Z)),D.value=Z},z=()=>{Y.value=!1,document.removeEventListener("mousemove",O),document.removeEventListener("mouseup",z),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",D.value.toString())},K=()=>{D.value=50,localStorage.setItem("directPanelWidth","50")},de=(P,k=!1)=>!_.value||P===_.value||k&&(P==="ui-state"||P==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",P,"current:",_.value),!1),he=P=>{console.log("[DirectView] Send message from input:",P),I.value&&typeof I.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",P),I.value.handleSendMessage(P)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},v=()=>{console.log("[DirectView] Input cleared"),x.value&&typeof x.value.clear=="function"&&x.value.clear()},m=()=>{console.log("[DirectView] Input focused")},U=(P,k)=>{console.log("[DirectView] Input state updated:",P,k),X.value=!P},M=(P,k)=>{console.log("[DirectView] Step selected:",P,k),S.value&&typeof S.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",P,k),S.value.handleStepSelected(P,k)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},b=(P,k,u,E)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:P,subPlanId:k,stepIndex:u,subStepIndex:E}),S.value&&typeof S.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:P,subPlanId:k,stepIndex:u,subStepIndex:E}),S.value.handleSubPlanStepSelected(P,k,u,E)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},N=()=>{console.log("[DirectView] Plan mode button clicked"),o.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",o.isCollapsed)},Q=()=>{n.push("/home")},te=()=>{n.push("/configs")},pe=async P=>{var k;if(console.log("[DirectView] Plan execution requested:",P),H.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}H.value=!0,I.value&&typeof I.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",P.title),I.value.addMessage("user",P.title)):console.warn("[DirectView] chatRef.addMessage method not available");try{const u=P.planData.planTemplateId||P.planData.planId;if(!u)throw new Error("没有找到计划模板ID");console.log("[Direct] Executing plan with templateId:",u,"params:",P.params),console.log("[Direct] About to call PlanActApiService.executePlan");let E;if((k=P.params)!=null&&k.trim()?(console.log("[Direct] Calling executePlan with params:",P.params.trim()),E=await ue.executePlan(u,P.params.trim())):(console.log("[Direct] Calling executePlan without params"),E=await ue.executePlan(u)),console.log("[Direct] Plan execution API response:",E),E.planId)console.log("[Direct] Got planId from response:",E.planId,"starting plan execution"),_.value=E.planId,console.log("[Direct] Set currentRootPlanId to:",E.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),ee.handlePlanExecutionRequested(E.planId,P.title);else throw console.error("[Direct] No planId in response:",E),new Error("执行计划失败：未返回有效的计划ID")}catch(u){console.error("[Direct] Plan execution failed:",u),console.error("[Direct] Error details:",{message:u.message,stack:u.stack}),_.value=null,I.value&&typeof I.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),I.value.addMessage("user",P.title),I.value.addMessage("assistant",`执行计划失败: ${u.message||"未知错误"}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`执行计划失败: ${u.message||"未知错误"}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),H.value=!1}};return(P,k)=>(g(),f("div",ua,[e("div",da,[y(an,{onPlanExecutionRequested:pe}),e("div",{class:"left-panel",style:xe({width:D.value+"%"})},[e("div",pa,[e("button",{class:"back-button",onClick:Q},[y(a(w),{icon:"carbon:arrow-left"})]),e("h2",null,c(P.$t("conversation")),1),e("div",ha,[y(it),e("button",{class:"config-button",onClick:te,title:P.$t("direct.configuration")},[y(a(w),{icon:"carbon:settings-adjust",width:"20"})],8,ga)])]),e("div",va,[y(ta,{ref_key:"chatRef",ref:I,mode:"direct","initial-prompt":C.value||"",onStepSelected:M,onSubPlanStepSelected:b},null,8,["initial-prompt"])]),y(ra,{ref_key:"inputRef",ref:x,disabled:X.value,placeholder:X.value?"等待任务完成...":a(h)("input.placeholder"),onSend:he,onClear:v,onFocus:m,onUpdateState:U,onPlanModeClicked:N},null,8,["disabled","placeholder"])],4),e("div",{class:"panel-resizer",onMousedown:T,onDblclick:K,title:P.$t("direct.panelResizeHint")},k[0]||(k[0]=[e("div",{class:"resizer-line"},null,-1)]),40,ma),y(ks,{ref_key:"rightPanelRef",ref:S,style:xe({width:100-D.value+"%"})},null,8,["style"])])]))}}),Ca=Ee(fa,[["__scopeId","data-v-134e0c68"]]);export{Ca as default};
