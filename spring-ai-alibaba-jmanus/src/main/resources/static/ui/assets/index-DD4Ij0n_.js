var tt=Object.defineProperty;var nt=(B,t,n)=>t in B?tt(B,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):B[t]=n;var F=(B,t,n)=>nt(B,typeof t!="symbol"?t+"":t,n);import{m as Ae,p as Ie,d as Se,f as Ce,h as ke,c as m,o as h,q as ae,u as a,e,b as j,t as l,i as $,s as ee,F as pe,j as he,x as xe,w as ve,v as Pe,r as q,g as ge,k as ie,y as $e,a as be,T as st,z as ot,A as Te,n as Re,B as at,l as it}from"./index-BhAHEd14.js";import{I as E,_ as Ee}from"./_plugin-vue_export-helper-4DnIhLUO.js";import{L as lt}from"./index-CoeyuGTG.js";import{u as ct}from"./task-1s1IWucL.js";class ce{static async generatePlan(t,n){const c={query:t};n&&(c.existingJson=n);const S=await fetch(`${this.PLAN_TEMPLATE_URL}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!S.ok)throw new Error(`Failed to generate plan: ${S.status}`);const u=await S.json();if(u.planJson)try{u.plan=JSON.parse(u.planJson)}catch{u.plan={error:"Unable to parse plan data"}}return u}static async executePlan(t,n){console.log("[PlanActApiService] executePlan called with:",{planTemplateId:t,rawParam:n});const c={planTemplateId:t};n&&(c.rawParam=n),console.log("[PlanActApiService] Making request to:",`${this.PLAN_TEMPLATE_URL}/executePlanByTemplateId`),console.log("[PlanActApiService] Request body:",c);const S=await fetch(`${this.PLAN_TEMPLATE_URL}/executePlanByTemplateId`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(console.log("[PlanActApiService] Response status:",S.status,S.ok),!S.ok){const y=await S.text();throw console.error("[PlanActApiService] Request failed:",y),new Error(`Failed to execute plan: ${S.status}`)}const u=await S.json();return console.log("[PlanActApiService] executePlan response:",u),u}static async savePlanTemplate(t,n){const c=await fetch(`${this.PLAN_TEMPLATE_URL}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t,planJson:n})});if(!c.ok)throw new Error(`Failed to save plan: ${c.status}`);return await c.json()}static async getPlanVersions(t){const n=await fetch(`${this.PLAN_TEMPLATE_URL}/versions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t})});if(!n.ok)throw new Error(`Failed to get plan versions: ${n.status}`);return await n.json()}static async getVersionPlan(t,n){const c=await fetch(`${this.PLAN_TEMPLATE_URL}/get-version`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t,versionIndex:n.toString()})});if(!c.ok)throw new Error(`Failed to get specific version plan: ${c.status}`);return await c.json()}static async getAllPlanTemplates(){const t=await fetch(`${this.PLAN_TEMPLATE_URL}/list`);if(!t.ok)throw new Error(`Failed to get plan template list: ${t.status}`);return await t.json()}static async updatePlanTemplate(t,n,c){const S={planId:t,query:n};c&&(S.existingJson=c);const u=await fetch(`${this.PLAN_TEMPLATE_URL}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(S)});if(!u.ok)throw new Error(`Failed to update plan template: ${u.status}`);const y=await u.json();if(y.planJson)try{y.plan=JSON.parse(y.planJson)}catch{y.plan={error:"Unable to parse plan data"}}return y}static async deletePlanTemplate(t){const n=await fetch(`${this.PLAN_TEMPLATE_URL}/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t})});if(!n.ok)throw new Error(`Failed to delete plan template: ${n.status}`);return await n.json()}}F(ce,"PLAN_TEMPLATE_URL","/api/plan-template");class rt{constructor(){F(this,"isCollapsed",!0);F(this,"currentTab","list");F(this,"currentPlanTemplateId",null);F(this,"planTemplateList",[]);F(this,"selectedTemplate",null);F(this,"isLoading",!1);F(this,"errorMessage","");F(this,"jsonContent","");F(this,"generatorPrompt","");F(this,"executionParams","");F(this,"isGenerating",!1);F(this,"isExecuting",!1);F(this,"planVersions",[]);F(this,"currentVersionIndex",-1)}get sortedTemplates(){return[...this.planTemplateList].sort((t,n)=>{const c=new Date(t.updateTime??t.createTime);return new Date(n.updateTime??n.createTime).getTime()-c.getTime()})}get canRollback(){return this.planVersions.length>1&&this.currentVersionIndex>0}get canRestore(){return this.planVersions.length>1&&this.currentVersionIndex<this.planVersions.length-1}get computedApiUrl(){if(!this.selectedTemplate)return"";const t=`/api/plan-template/execute/${this.selectedTemplate.id}`,n=this.executionParams.trim();return n?`${t}?allParams=${encodeURIComponent(n)}`:t}toggleSidebar(){this.isCollapsed=!this.isCollapsed}switchToTab(t){this.currentTab=t}async loadPlanTemplateList(){this.isLoading=!0,this.errorMessage="";try{console.log("[SidebarStore] Starting to load plan template list...");const t=await ce.getAllPlanTemplates();t!=null&&t.templates&&Array.isArray(t.templates)?(this.planTemplateList=t.templates,console.log(`[SidebarStore] Successfully loaded ${t.templates.length} plan templates`)):(this.planTemplateList=[],console.warn("[SidebarStore] API returned abnormal data format, using empty list",t))}catch(t){console.error("[SidebarStore] Failed to load plan template list:",t),this.planTemplateList=[],this.errorMessage=`Load failed: ${t.message}`}finally{this.isLoading=!1}}async selectTemplate(t){this.currentPlanTemplateId=t.id,this.selectedTemplate=t,this.currentTab="config",await this.loadTemplateData(t),console.log(`[SidebarStore] Selected plan template: ${t.id}`)}async loadTemplateData(t){try{const n=await ce.getPlanVersions(t.id);if(this.planVersions=n.versions||[],this.planVersions.length>0){const c=this.planVersions[this.planVersions.length-1];this.jsonContent=c,this.currentVersionIndex=this.planVersions.length-1;try{const S=JSON.parse(c);S.prompt&&(this.generatorPrompt=S.prompt),S.params&&(this.executionParams=S.params)}catch{console.warn("Unable to parse JSON content to get prompt information")}}else this.jsonContent="",this.generatorPrompt="",this.executionParams=""}catch(n){throw console.error("Failed to load template data:",n),n}}createNewTemplate(){const t={id:`new-${Date.now()}`,title:Ie.global.t("sidebar.newTemplateName"),description:Ie.global.t("sidebar.newTemplateDescription"),createTime:new Date().toISOString(),updateTime:new Date().toISOString()};this.selectedTemplate=t,this.currentPlanTemplateId=null,this.jsonContent="",this.generatorPrompt="",this.executionParams="",this.planVersions=[],this.currentVersionIndex=-1,this.currentTab="config",console.log("[SidebarStore] Created new empty plan template, switching to config tab")}async deleteTemplate(t){if(!t.id){console.warn("[SidebarStore] deleteTemplate: Invalid template object or ID");return}try{await ce.deletePlanTemplate(t.id),this.currentPlanTemplateId===t.id&&this.clearSelection(),await this.loadPlanTemplateList(),console.log(`[SidebarStore] Plan template ${t.id} has been deleted`)}catch(n){throw console.error("Failed to delete plan template:",n),await this.loadPlanTemplateList(),n}}clearSelection(){this.currentPlanTemplateId=null,this.selectedTemplate=null,this.jsonContent="",this.generatorPrompt="",this.executionParams="",this.planVersions=[],this.currentVersionIndex=-1,this.currentTab="list"}clearExecutionParams(){this.executionParams=""}rollbackVersion(){this.canRollback&&(this.currentVersionIndex--,this.jsonContent=this.planVersions[this.currentVersionIndex])}restoreVersion(){this.canRestore&&(this.currentVersionIndex++,this.jsonContent=this.planVersions[this.currentVersionIndex])}async saveTemplate(){if(!this.selectedTemplate)return;const t=this.jsonContent.trim();if(!t)throw new Error("Content cannot be empty");try{JSON.parse(t)}catch(n){throw new Error(`Invalid format, please correct and save.
Error: `+n.message)}try{const n=await ce.savePlanTemplate(this.selectedTemplate.id,t);return this.currentVersionIndex<this.planVersions.length-1&&(this.planVersions=this.planVersions.slice(0,this.currentVersionIndex+1)),this.planVersions.push(t),this.currentVersionIndex=this.planVersions.length-1,n}catch(n){throw console.error("Failed to save plan template:",n),n}}async generatePlan(){if(this.generatorPrompt.trim()){this.isGenerating=!0;try{const t=await ce.generatePlan(this.generatorPrompt);if(this.jsonContent=t.planJson||"",this.selectedTemplate&&this.selectedTemplate.id.startsWith("new-")){let n="New Plan Template";try{n=JSON.parse(t.planJson||"{}").title||n}catch{console.warn("Unable to parse plan JSON to get title")}this.selectedTemplate={id:t.planTemplateId,title:n,description:Ie.global.t("sidebar.generatedTemplateDescription"),createTime:new Date().toISOString(),updateTime:new Date().toISOString(),planJson:t.planJson},this.currentPlanTemplateId=t.planTemplateId,await this.loadPlanTemplateList()}return this.currentVersionIndex<this.planVersions.length-1&&(this.planVersions=this.planVersions.slice(0,this.currentVersionIndex+1)),this.planVersions.push(this.jsonContent),this.currentVersionIndex=this.planVersions.length-1,t}catch(t){throw console.error("Failed to generate plan:",t),t}finally{this.isGenerating=!1}}}async updatePlan(){if(!(!this.generatorPrompt.trim()||!this.jsonContent.trim())&&this.selectedTemplate){this.isGenerating=!0;try{const t=await ce.updatePlanTemplate(this.selectedTemplate.id,this.generatorPrompt,this.jsonContent);return this.jsonContent=t.planJson||"",this.currentVersionIndex<this.planVersions.length-1&&(this.planVersions=this.planVersions.slice(0,this.currentVersionIndex+1)),this.planVersions.push(this.jsonContent),this.currentVersionIndex=this.planVersions.length-1,t}catch(t){throw console.error("Failed to update plan:",t),t}finally{this.isGenerating=!1}}}preparePlanExecution(){if(!this.selectedTemplate)return null;this.isExecuting=!0;try{let t;try{t=JSON.parse(this.jsonContent),t.planTemplateId=this.selectedTemplate.id}catch{t={planTemplateId:this.selectedTemplate.id,planId:this.selectedTemplate.id,title:this.selectedTemplate.title??Ie.global.t("sidebar.defaultExecutionPlanTitle"),steps:[{stepRequirement:"[BROWSER_AGENT] 访问百度搜索阿里巴巴的最新股价"},{stepRequirement:"[DEFAULT_AGENT] 提取和整理搜索结果中的股价信息"},{stepRequirement:"[TEXT_FILE_AGENT] 创建一个文本文件记录查询结果"},{stepRequirement:"[DEFAULT_AGENT] 向用户报告查询结果"}]}}return{title:this.selectedTemplate.title??t.title??"Execution Plan",planData:t,params:this.executionParams.trim()||void 0}}catch(t){throw console.error("Failed to prepare plan execution:",t),this.isExecuting=!1,t}}finishPlanExecution(){this.isExecuting=!1}}const p=Ae(new rt),ut={class:"sidebar-content"},dt={class:"sidebar-content-header"},pt={class:"sidebar-content-title"},ht={class:"tab-switcher"},gt=["disabled"],mt={key:0,class:"tab-content"},ft={class:"new-task-section"},vt={class:"sidebar-content-list"},Pt={key:0,class:"loading-state"},_t={key:1,class:"error-state"},bt={key:2,class:"empty-state"},St=["onClick"],Ct={class:"task-icon"},kt={class:"task-details"},$t={class:"task-title"},Et={class:"task-preview"},yt={class:"task-time"},wt={class:"task-actions"},It=["title","onClick"],xt={key:1,class:"tab-content config-tab"},Tt={key:0,class:"config-container"},Rt={class:"template-info-header"},Dt={class:"template-info"},At={class:"template-id"},Lt={class:"config-section"},Mt={class:"section-header"},Nt={class:"generator-content"},Ut=["placeholder"],Vt={class:"generator-actions"},qt=["disabled"],Ot=["disabled"],Ft={class:"config-section"},jt={class:"section-header"},Bt={class:"section-actions"},Wt=["disabled","title"],Jt=["disabled","title"],Gt=["disabled"],Ht=["placeholder"],zt={class:"config-section"},Xt={class:"section-header"},Kt={class:"execution-content"},Qt={class:"params-input-group"},Yt={class:"params-help-text"},Zt={class:"params-input-container"},en=["placeholder"],tn=["title"],nn={class:"api-url-display"},sn={class:"api-url-label"},on={class:"api-url"},an={class:"api-url-display"},ln={class:"api-url-label"},cn=["disabled"],rn=Se({__name:"index",emits:["planExecutionRequested"],setup(B,{expose:t,emit:n}){const{t:c}=Ce(),S=n,u=async()=>{try{const r=await p.saveTemplate();r!=null&&r.duplicate?alert(c("sidebar.saveCompleted",{message:r.message,versionCount:r.versionCount})):r!=null&&r.saved?alert(c("sidebar.saveSuccess",{message:r.message,versionCount:r.versionCount})):r!=null&&r.message&&alert(c("sidebar.saveStatus",{message:r.message}))}catch(r){console.error("保存计划修改失败:",r),alert(r.message||c("sidebar.saveFailed"))}},y=async()=>{var r;try{await p.generatePlan(),alert(c("sidebar.generateSuccess",{templateId:((r=p.selectedTemplate)==null?void 0:r.id)??c("sidebar.unknown")}))}catch(v){console.error("生成计划失败:",v),alert(c("sidebar.generateFailed")+": "+v.message)}},C=async()=>{try{await p.updatePlan(),alert(c("sidebar.updateSuccess"))}catch(r){console.error("更新计划失败:",r),alert(c("sidebar.updateFailed")+": "+r.message)}},G=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const r=p.preparePlanExecution();if(!r){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] 触发计划执行请求:",r),console.log("[Sidebar] Emitting planExecutionRequested event"),S("planExecutionRequested",r),console.log("[Sidebar] Event emitted")}catch(r){console.error("执行计划出错:",r),alert(c("sidebar.executeFailed")+": "+r.message)}finally{p.finishPlanExecution()}},R=r=>{const k=new Date().getTime()-r.getTime(),X=Math.floor(k/6e4),te=Math.floor(k/36e5),re=Math.floor(k/864e5);return X<1?"刚刚":X<60?`${X}分钟前`:te<24?`${te}小时前`:re<30?`${re}天前`:r.toLocaleDateString("zh-CN")},z=(r,v)=>!r||r.length<=v?r:r.substring(0,v)+"...";return ke(()=>{p.loadPlanTemplateList()}),t({loadPlanTemplateList:p.loadPlanTemplateList,toggleSidebar:p.toggleSidebar,currentPlanTemplateId:p.currentPlanTemplateId}),(r,v)=>(h(),m("div",{class:ae(["sidebar-wrapper",{"sidebar-wrapper-collapsed":a(p).isCollapsed}])},[e("div",ut,[e("div",dt,[e("div",pt,l(r.$t("sidebar.title")),1)]),e("div",ht,[e("button",{class:ae(["tab-button",{active:a(p).currentTab==="list"}]),onClick:v[0]||(v[0]=k=>a(p).switchToTab("list"))},[$(a(E),{icon:"carbon:list",width:"16"}),ee(" "+l(r.$t("sidebar.templateList")),1)],2),e("button",{class:ae(["tab-button",{active:a(p).currentTab==="config"}]),onClick:v[1]||(v[1]=k=>a(p).switchToTab("config")),disabled:!a(p).selectedTemplate},[$(a(E),{icon:"carbon:settings",width:"16"}),ee(" "+l(r.$t("sidebar.configuration")),1)],10,gt)]),a(p).currentTab==="list"?(h(),m("div",mt,[e("div",ft,[e("button",{class:"new-task-btn",onClick:v[2]||(v[2]=k=>a(p).createNewTemplate())},[$(a(E),{icon:"carbon:add",width:"16"}),ee(" "+l(r.$t("sidebar.newPlan"))+" ",1),v[11]||(v[11]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",vt,[a(p).isLoading?(h(),m("div",Pt,[$(a(E),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,l(r.$t("sidebar.loading")),1)])):a(p).errorMessage?(h(),m("div",_t,[$(a(E),{icon:"carbon:warning",width:"20"}),e("span",null,l(a(p).errorMessage),1),e("button",{onClick:v[3]||(v[3]=(...k)=>a(p).loadPlanTemplateList&&a(p).loadPlanTemplateList(...k)),class:"retry-btn"},l(r.$t("sidebar.retry")),1)])):a(p).planTemplateList.length===0?(h(),m("div",bt,[$(a(E),{icon:"carbon:document",width:"32"}),e("span",null,l(r.$t("sidebar.noTemplates")),1)])):(h(!0),m(pe,{key:3},he(a(p).sortedTemplates,k=>(h(),m("div",{key:k.id,class:ae(["sidebar-content-list-item",{"sidebar-content-list-item-active":k.id===a(p).currentPlanTemplateId}]),onClick:X=>a(p).selectTemplate(k)},[e("div",Ct,[$(a(E),{icon:"carbon:document",width:"20"})]),e("div",kt,[e("div",$t,l(k.title||r.$t("sidebar.unnamedPlan")),1),e("div",Et,l(z(k.description||r.$t("sidebar.noDescription"),40)),1)]),e("div",yt,l(R(new Date(k.updateTime||k.createTime))),1),e("div",wt,[e("button",{class:"delete-task-btn",title:r.$t("sidebar.deleteTemplate"),onClick:xe(X=>a(p).deleteTemplate(k),["stop"])},[$(a(E),{icon:"carbon:close",width:"16"})],8,It)])],10,St))),128))])])):a(p).currentTab==="config"?(h(),m("div",xt,[a(p).selectedTemplate?(h(),m("div",Tt,[e("div",Rt,[e("div",Dt,[e("h3",null,l(a(p).selectedTemplate.title||r.$t("sidebar.unnamedPlan")),1),e("span",At,"ID: "+l(a(p).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:v[4]||(v[4]=k=>a(p).switchToTab("list"))},[$(a(E),{icon:"carbon:arrow-left",width:"16"})])]),e("div",Lt,[e("div",Mt,[$(a(E),{icon:"carbon:generate",width:"16"}),e("span",null,l(r.$t("sidebar.planGenerator")),1)]),e("div",Nt,[ve(e("textarea",{"onUpdate:modelValue":v[5]||(v[5]=k=>a(p).generatorPrompt=k),class:"prompt-input",placeholder:r.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,Ut),[[Pe,a(p).generatorPrompt]]),e("div",Vt,[e("button",{class:"btn btn-primary btn-sm",onClick:y,disabled:a(p).isGenerating||!a(p).generatorPrompt.trim()},[$(a(E),{icon:a(p).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:ae({spinning:a(p).isGenerating})},null,8,["icon","class"]),ee(" "+l(a(p).isGenerating?r.$t("sidebar.generating"):r.$t("sidebar.generatePlan")),1)],8,qt),e("button",{class:"btn btn-secondary btn-sm",onClick:C,disabled:a(p).isGenerating||!a(p).generatorPrompt.trim()||!a(p).jsonContent.trim()},[$(a(E),{icon:"carbon:edit",width:"14"}),ee(" "+l(r.$t("sidebar.updatePlan")),1)],8,Ot)])])]),e("div",Ft,[e("div",jt,[$(a(E),{icon:"carbon:code",width:"16"}),e("span",null,l(r.$t("sidebar.jsonTemplate")),1),e("div",Bt,[e("button",{class:"btn btn-sm",onClick:v[6]||(v[6]=(...k)=>a(p).rollbackVersion&&a(p).rollbackVersion(...k)),disabled:!a(p).canRollback,title:r.$t("sidebar.rollback")},[$(a(E),{icon:"carbon:undo",width:"14"})],8,Wt),e("button",{class:"btn btn-sm",onClick:v[7]||(v[7]=(...k)=>a(p).restoreVersion&&a(p).restoreVersion(...k)),disabled:!a(p).canRestore,title:r.$t("sidebar.restore")},[$(a(E),{icon:"carbon:redo",width:"14"})],8,Jt),e("button",{class:"btn btn-primary btn-sm",onClick:u,disabled:a(p).isGenerating||a(p).isExecuting},[$(a(E),{icon:"carbon:save",width:"14"})],8,Gt)])]),ve(e("textarea",{"onUpdate:modelValue":v[8]||(v[8]=k=>a(p).jsonContent=k),class:"json-editor",placeholder:r.$t("sidebar.jsonPlaceholder"),rows:"8"},null,8,Ht),[[Pe,a(p).jsonContent]])]),e("div",zt,[e("div",Xt,[$(a(E),{icon:"carbon:play",width:"16"}),e("span",null,l(r.$t("sidebar.executionController")),1)]),e("div",Kt,[e("div",Qt,[e("label",null,l(r.$t("sidebar.executionParams")),1),e("div",Yt,l(r.$t("sidebar.executionParamsHelp")),1),e("div",Zt,[ve(e("input",{"onUpdate:modelValue":v[9]||(v[9]=k=>a(p).executionParams=k),class:"params-input",placeholder:r.$t("sidebar.executionParamsPlaceholder")},null,8,en),[[Pe,a(p).executionParams]]),e("button",{class:"clear-params-btn",onClick:v[10]||(v[10]=(...k)=>a(p).clearExecutionParams&&a(p).clearExecutionParams(...k)),title:r.$t("sidebar.clearParams")},[$(a(E),{icon:"carbon:close",width:"12"})],8,tn)])]),e("div",nn,[e("span",sn,l(r.$t("sidebar.apiUrl"))+":",1),e("code",on,l(a(p).computedApiUrl),1)]),e("div",an,[e("span",ln,l(r.$t("sidebar.statusApiUrl"))+":",1),v[12]||(v[12]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:G,disabled:a(p).isExecuting||a(p).isGenerating},[$(a(E),{icon:a(p).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:ae({spinning:a(p).isExecuting})},null,8,["icon","class"]),ee(" "+l(a(p).isExecuting?r.$t("sidebar.executing"):r.$t("sidebar.executePlan")),1)],8,cn)])])])):j("",!0)])):j("",!0)])],2))}}),un=Ee(rn,[["__scopeId","data-v-094cd641"]]);class Le{static async sendMessage(t){const n=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t})});if(!n.ok)throw new Error(`API request failed: ${n.status}`);return await n.json()}}F(Le,"BASE_URL","/api/executor");class Me{static async getDetails(t){try{const n=await fetch(`${this.BASE_URL}/details/${t}`);if(n.status===404)return null;if(!n.ok)throw new Error(`Failed to get detailed information: ${n.status}`);const c=await n.text(),S=JSON.parse(c);return S&&typeof S=="object"&&!S.currentPlanId&&(S.currentPlanId=t),S}catch(n){return console.error("[CommonApiService] Failed to get plan details:",n),null}}static async submitFormInput(t,n){const c=await fetch(`${this.BASE_URL}/submit-input/${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!c.ok){let u;try{u=await c.json()}catch{u={message:`Failed to submit form input: ${c.status}`}}throw new Error(u.message||`Failed to submit form input: ${c.status}`)}const S=c.headers.get("content-type");return S&&S.indexOf("application/json")!==-1?await c.json():{success:!0}}static async getAllPrompts(){try{const t=await fetch(this.BASE_URL);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get Prompt list:",t),t}}static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}}F(Me,"BASE_URL","/api/executor");const de=class de{constructor(){F(this,"POLL_INTERVAL",5e3);F(this,"state",Ae({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));F(this,"callbacks",{});F(this,"planExecutionCache",new Map);F(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(t){return this.planExecutionCache.get(t)}getCachedUIState(t){return this.uiStateCache.get(t)}setCachedUIState(t,n){this.uiStateCache.set(t,n),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${t}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(t){return this.planExecutionCache.has(t)}setCachedPlanRecord(t,n){this.planExecutionCache.set(t,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${t}`)}clearCachedPlanRecord(t){const n=this.planExecutionCache.delete(t);return n&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${t}`),n}clearAllCachedRecords(){const t=this.planExecutionCache.size,n=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${t}, UI States: ${n}`)}static getInstance(){return de.instance||(de.instance=new de),de.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(t){this.callbacks={...this.callbacks,...t},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(t))}async handleUserMessageSendRequested(t){if(this.validateAndPrepareUIForNewRequest(t))try{if(await this.sendUserMessageAndSetPlanId(t),this.state.activePlanId)this.initiatePlanExecutionSequence(t,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(n){console.error("[PlanExecutionManager] Failed to send user message:",n);const c=this.state.activePlanId??"error";this.setCachedUIState(c,{enabled:!0}),this.emitChatInputUpdateState(c),this.state.activePlanId=null}}handlePlanExecutionRequested(t,n){console.log("[PlanExecutionManager] Received plan execution request:",{planId:t,query:n}),t?(this.state.activePlanId=t,this.initiatePlanExecutionSequence(n??"执行计划",t)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(t,n){const c=this.getCachedPlanRecord(t);return c!=null&&c.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${t}`),this.handlePlanExecutionRequested(c.currentPlanId,n),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${t}`),!1)}validateAndPrepareUIForNewRequest(t){if(!t)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const n=this.state.activePlanId??"ui-state";return this.setCachedUIState(n,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(n),!0}async sendUserMessageAndSetPlanId(t){try{const n=await Le.sendMessage(t);if(n!=null&&n.planId)return this.state.activePlanId=n.planId,n;if(n!=null&&n.planTemplateId)return this.state.activePlanId=n.planTemplateId,{...n,planId:n.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",n),new Error("Failed to get valid planId from API response")}catch(n){throw console.error("[PlanExecutionManager] API call failed:",n),n}}initiatePlanExecutionSequence(t,n){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${t}", planId: ${n}`);const c=n;this.emitDialogRoundStart(c),this.startPolling()}handlePlanCompletion(t){this.emitPlanCompleted(t.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await ce.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}},5e3)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}t.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(t.rootPlanId??""))}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const t=await this.getPlanDetails(this.state.activePlanId);if(!t){console.warn("[PlanExecutionManager] No details received from API");return}if(t.rootPlanId&&this.setCachedPlanRecord(t.rootPlanId,t),!t.steps||t.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(t.rootPlanId??""),this.handlePlanCompletion(t);return}this.emitPlanUpdate(t.rootPlanId??""),t.completed&&this.handlePlanCompletion(t)}catch(t){console.error("[PlanExecutionManager] Failed to poll plan status:",t)}finally{this.state.isPolling=!1}}}async getPlanDetails(t){try{const n=await Me.getDetails(t);return n!=null&&n.rootPlanId&&(this.planExecutionCache.set(n.rootPlanId,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${n.rootPlanId}`)),n}catch(n){return console.error("[PlanExecutionManager] Failed to get plan details:",n),null}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(t){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(t)}emitDialogRoundStart(t){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(t)}emitPlanUpdate(t){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(t)}emitPlanCompleted(t){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(t)}};F(de,"instance",null);let De=de;const K=De.getInstance(),dn={class:"right-panel"},pn={class:"preview-header"},hn={class:"preview-tabs"},gn={class:"tab-button active"},mn={class:"preview-content"},fn={class:"step-details"},vn={key:0,class:"step-info-fixed"},Pn={key:0,class:"agent-info"},_n={class:"info-item"},bn={class:"label"},Sn={class:"value"},Cn={class:"info-item"},kn={class:"label"},$n={class:"value"},En={class:"info-item"},yn={class:"label"},wn={class:"value"},In={class:"info-item"},xn={class:"label"},Tn={class:"value"},Rn={class:"info-item"},Dn={class:"label"},An={class:"execution-status"},Ln={class:"status-item"},Mn={class:"status-text"},Nn={key:0},Un={key:0,class:"think-act-steps"},Vn={class:"steps-container"},qn={class:"step-header"},On={class:"step-number"},Fn={class:"think-section"},jn={class:"think-content"},Bn={class:"input"},Wn={class:"label"},Jn={class:"output"},Gn={class:"label"},Hn={key:0,class:"action-section"},zn={class:"action-content"},Xn={class:"tool-info"},Kn={class:"label"},Qn={class:"value"},Yn={class:"input"},Zn={class:"label"},es={class:"output"},ts={class:"label"},ns={key:0,class:"sub-plan-section"},ss={class:"sub-plan-content"},os={class:"sub-plan-header"},as={class:"sub-plan-info"},is={class:"value"},ls={key:0,class:"sub-plan-info"},cs={class:"value"},rs={class:"sub-plan-status"},us={class:"status-text"},ds={key:0,class:"no-steps-message"},ps={key:1,class:"no-execution-message"},hs={class:"step-basic-info"},gs={class:"info-item"},ms={class:"label"},fs={class:"value"},vs={key:0,class:"info-item"},Ps={class:"value"},_s={class:"info-item"},bs={class:"no-execution-hint"},Ss={key:2,class:"execution-indicator"},Cs={class:"execution-text"},ks={key:1,class:"no-selection"},$s=["title"],Es=Se({__name:"index",setup(B,{expose:t}){const{t:n}=Ce(),c=q(),S=q(),u=q(),y=q(null),C=q(!1),G=q(!0),R=q(!0),z=ge(()=>u.value?u.value.completed?n("rightPanel.status.completed"):u.value.current?n("rightPanel.status.executing"):n("rightPanel.status.waiting"):""),r=f=>{var D;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${f}`),u.value&&y.value){const x=y.value.rootPlanId??S.value;if(x&&x!==f){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${x}, Requested: ${f}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${f}`);const g=K.getCachedPlanRecord(f);if(!g){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${f}`);return}if(g.steps&&g.steps.length>0){const x=g.steps.length,_=(g.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${_} / ${x}`)}if(u.value&&S.value&&(S.value===f||((D=y.value)==null?void 0:D.rootPlanId)===f)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${f}`),y.value)){const _=y.value,I=k(_.planId,_.rootPlanId,_.subPlanId);I?(X(I,_.stepIndex,_.planId,_.isSubPlan),Y()):console.warn("[RightPanel] Could not find plan record for refresh:",_)}},v=(f,g,D,x,_)=>{console.log("[RightPanel] Step selected:",{planId:f,stepIndex:g,rootPlanId:D,subPlanId:x,subStepIndex:_});const I=!!(D&&x&&_!==void 0);y.value={planId:f,stepIndex:g,isSubPlan:I,...I&&{rootPlanId:D,subPlanId:x,subStepIndex:_}};const H=k(f,D,x);if(!H){console.warn("[RightPanel] Plan data not found:",{planId:f,rootPlanId:D,subPlanId:x}),u.value=null,y.value=null;return}X(H,g,f,I)},k=(f,g,D)=>{var I;if(!g||!D)return K.getCachedPlanRecord(f)??null;const x=K.getCachedPlanRecord(f);if(x)return x;const _=K.getCachedPlanRecord(g);if(!(_!=null&&_.agentExecutionSequence))return null;for(const H of _.agentExecutionSequence)if(H.thinkActSteps){for(const ne of H.thinkActSteps)if(((I=ne.subPlanExecutionRecord)==null?void 0:I.currentPlanId)===D)return ne.subPlanExecutionRecord}return null},X=(f,g,D,x)=>{var b,V,W,ue,ye;if(!f.steps||g>=f.steps.length){u.value=null,y.value=null,console.warn("[RightPanel] Invalid step data:",{planId:D,stepIndex:g,hasSteps:!!f.steps,stepsLength:(b=f.steps)==null?void 0:b.length,message:"Invalid step index"});return}S.value=D;const _=f.steps[g],I=(V=f.agentExecutionSequence)==null?void 0:V[g];console.log("[RightPanel] Step data details:",{planId:D,stepIndex:g,step:_,hasAgentExecutionSequence:!!f.agentExecutionSequence,agentExecutionSequenceLength:(W=f.agentExecutionSequence)==null?void 0:W.length,agentExecution:I,hasThinkActSteps:!!(I!=null&&I.thinkActSteps),thinkActStepsLength:(ue=I==null?void 0:I.thinkActSteps)==null?void 0:ue.length,isSubPlan:x});const H=(I==null?void 0:I.status)==="FINISHED",ne=!H&&g===f.currentStepIndex&&!f.completed,P={planId:D,index:g,title:typeof _=="string"?_:_.title||_.description||_.name||`${x?"子":""}步骤 ${g+1}`,description:typeof _=="string"?_:_.description||_,completed:H,current:ne};I&&(P.agentExecution=I),u.value=P,console.log("[RightPanel] Step details updated:",{planId:D,stepIndex:g,stepTitle:u.value.title,hasAgentExecution:!!I,hasThinkActSteps:(((ye=I==null?void 0:I.thinkActSteps)==null?void 0:ye.length)??0)>0,completed:H,current:ne,planCurrentStep:f.currentStepIndex,planCompleted:f.completed,isSubPlan:x}),I!=null&&I.thinkActSteps&&I.thinkActSteps.forEach((o,s)=>{o.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${s}:`,o.subPlanExecutionRecord)}),setTimeout(()=>{Q()},100),Y()},te=(f,g,D,x)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:f,subPlanId:g,stepIndex:D,subStepIndex:x}),v(g,x,f,g,x)},re=f=>{c.value=f??void 0},Q=()=>{if(!c.value)return;const{scrollTop:f,scrollHeight:g,clientHeight:D}=c.value,x=g-f-D<50,_=g>D;G.value=x,C.value=_&&!x,x?R.value=!0:g-f-D>100&&(R.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:f,scrollHeight:g,clientHeight:D,isAtBottom:x,hasScrollableContent:_,showButton:C.value,shouldAutoScroll:R.value})},O=()=>{c.value&&(c.value.scrollTo({top:c.value.scrollHeight,behavior:"smooth"}),ie(()=>{R.value=!0,Q()}))},Y=()=>{!R.value||!c.value||ie(()=>{c.value&&(c.value.scrollTop=c.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},Z=f=>{if(f===null||typeof f>"u"||f==="")return"N/A";try{const g=typeof f=="object"?f:JSON.parse(f);return JSON.stringify(g,null,2)}catch{return String(f)}},_e=()=>{u.value=null,S.value=void 0,R.value=!0,c.value&&c.value.removeEventListener("scroll",Q)},me=()=>{const f=()=>{const g=c.value;return g?(re(g),g.addEventListener("scroll",Q),R.value=!0,Q(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};ie(()=>{f()||setTimeout(()=>{f()},100)})};return ke(()=>{console.log("[RightPanel] Component mounted"),ie(()=>{me()})}),$e(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),y.value=null,_e()}),t({updateDisplayedPlanProgress:r,handleStepSelected:v,handleSubPlanStepSelected:te}),(f,g)=>{var D,x;return h(),m("div",dn,[e("div",pn,[e("div",hn,[e("button",gn,[$(a(E),{icon:"carbon:events"}),ee(" "+l(a(n)("rightPanel.stepExecutionDetails")),1)])])]),e("div",mn,[e("div",fn,[u.value?(h(),m("div",vn,[e("h3",null,l(u.value.title||u.value.description||a(n)("rightPanel.defaultStepTitle",{number:u.value.index+1})),1),u.value.agentExecution?(h(),m("div",Pn,[e("div",_n,[e("span",bn,l(a(n)("rightPanel.executingAgent"))+":",1),e("span",Sn,l(u.value.agentExecution.agentName),1)]),e("div",Cn,[e("span",kn,l(a(n)("rightPanel.description"))+":",1),e("span",$n,l(u.value.agentExecution.agentDescription||""),1)]),e("div",En,[e("span",yn,l(a(n)("rightPanel.callingModel"))+":",1),e("span",wn,l(u.value.agentExecution.modelName),1)]),e("div",In,[e("span",xn,l(a(n)("rightPanel.request"))+":",1),e("span",Tn,l(u.value.agentExecution.agentRequest||""),1)]),e("div",Rn,[e("span",Dn,l(a(n)("rightPanel.executionResult"))+":",1),e("span",{class:ae(["value",{success:u.value.agentExecution.status==="FINISHED"}])},l(u.value.agentExecution.status||a(n)("rightPanel.executing")),3)])])):j("",!0),e("div",An,[e("div",Ln,[u.value.completed?(h(),be(a(E),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):u.value.current?(h(),be(a(E),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(h(),be(a(E),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",Mn,l(z.value),1)])])])):j("",!0),e("div",{ref_key:"scrollContainer",ref:c,class:"step-details-scroll-container",onScroll:Q},[u.value?(h(),m("div",Nn,[(D=u.value.agentExecution)!=null&&D.thinkActSteps&&u.value.agentExecution.thinkActSteps.length>0?(h(),m("div",Un,[e("h4",null,l(a(n)("rightPanel.thinkAndActionSteps")),1),e("div",Vn,[(h(!0),m(pe,null,he(u.value.agentExecution.thinkActSteps,(_,I)=>(h(),m("div",{key:I,class:"think-act-step"},[e("div",qn,[e("span",On,"#"+l(I+1),1),e("span",{class:ae(["step-status",_.status])},l(_.status||a(n)("rightPanel.executing")),3)]),e("div",Fn,[e("h5",null,[$(a(E),{icon:"carbon:thinking"}),ee(" "+l(a(n)("rightPanel.thinking")),1)]),e("div",jn,[e("div",Bn,[e("span",Wn,l(a(n)("rightPanel.input"))+":",1),e("pre",null,l(Z(_.thinkInput)),1)]),e("div",Jn,[e("span",Gn,l(a(n)("rightPanel.output"))+":",1),e("pre",null,l(Z(_.thinkOutput)),1)])])]),_.actionNeeded?(h(),m("div",Hn,[e("h5",null,[$(a(E),{icon:"carbon:play"}),ee(" "+l(a(n)("rightPanel.action")),1)]),e("div",zn,[(h(!0),m(pe,null,he(_.actToolInfoList,(H,ne)=>(h(),m("div",{key:ne},[e("div",Xn,[e("span",Kn,l(a(n)("rightPanel.tool"))+":",1),e("span",Qn,l(H.name||""),1)]),e("div",Yn,[e("span",Zn,l(a(n)("rightPanel.toolParameters"))+":",1),e("pre",null,l(Z(H.parameters)),1)]),e("div",es,[e("span",ts,l(a(n)("rightPanel.executionResult"))+":",1),e("pre",null,l(Z(H.result)),1)])]))),128))]),_.subPlanExecutionRecord?(h(),m("div",ns,[e("h5",null,[$(a(E),{icon:"carbon:tree-view"}),ee(" "+l(a(n)("rightPanel.subPlan")),1)]),e("div",ss,[e("div",os,[e("div",as,[g[0]||(g[0]=e("span",{class:"label"},"子计划ID:",-1)),e("span",is,l(_.subPlanExecutionRecord.currentPlanId),1)]),_.subPlanExecutionRecord.title?(h(),m("div",ls,[g[1]||(g[1]=e("span",{class:"label"},"标题:",-1)),e("span",cs,l(_.subPlanExecutionRecord.title),1)])):j("",!0),e("div",rs,[_.subPlanExecutionRecord.completed?(h(),be(a(E),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(h(),be(a(E),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",us,l(_.subPlanExecutionRecord.completed?"已完成":"执行中"),1)])])])])):j("",!0)])):j("",!0)]))),128))]),u.value.agentExecution&&!((x=u.value.agentExecution.thinkActSteps)!=null&&x.length)?(h(),m("div",ds,[e("p",null,l(a(n)("rightPanel.noStepDetails")),1)])):u.value.agentExecution?j("",!0):(h(),m("div",ps,[$(a(E),{icon:"carbon:information",class:"info-icon"}),e("h4",null,l(a(n)("rightPanel.stepInfo")),1),e("div",hs,[e("div",gs,[e("span",ms,l(a(n)("rightPanel.stepName"))+":",1),e("span",fs,l(u.value.title||u.value.description||`步骤 ${u.value.index+1}`),1)]),u.value.description?(h(),m("div",vs,[g[2]||(g[2]=e("span",{class:"label"},"描述:",-1)),e("span",Ps,l(u.value.description),1)])):j("",!0),e("div",_s,[g[3]||(g[3]=e("span",{class:"label"},"状态:",-1)),e("span",{class:ae(["value",{"status-completed":u.value.completed,"status-current":u.value.current,"status-pending":!u.value.completed&&!u.value.current}])},l(u.value.completed?"已完成":u.value.current?"执行中":"待执行"),3)])]),e("p",bs,l(a(n)("rightPanel.noExecutionInfo")),1)])),u.value.current&&!u.value.completed?(h(),m("div",Ss,[g[4]||(g[4]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",Cs,[$(a(E),{icon:"carbon:in-progress",class:"rotating-icon"}),ee(" "+l(a(n)("rightPanel.stepExecuting")),1)])])):j("",!0)])):(h(),m("div",ks,[$(a(E),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,l(a(n)("rightPanel.noStepSelected")),1),e("p",null,l(a(n)("rightPanel.selectStepHint")),1)]))])):j("",!0),$(st,{name:"scroll-button"},{default:ot(()=>[C.value?(h(),m("button",{key:0,onClick:O,class:"scroll-to-bottom-btn",title:a(n)("rightPanel.scrollToBottom")},[$(a(E),{icon:"carbon:chevron-down"})],8,$s)):j("",!0)]),_:1})],544)])])])}}}),ys=Ee(Es,[["__scopeId","data-v-e90596ce"]]);function ws(){const B=K,t=ge(()=>B.getActivePlanId()),n=ge(()=>B.getState()),c=ge(()=>n.value.isPolling),S=ge(()=>!!t.value),u=(R,z)=>{B.initiatePlanExecutionSequence(R,z)},y=()=>{B.stopPolling()},C=()=>{B.startPolling()},G=()=>{B.cleanup()};return $e(()=>{G()}),{activePlanId:t,state:n,isPolling:c,hasActivePlan:S,startExecution:u,stopPolling:y,startPolling:C,cleanup:G}}const Is={class:"chat-container"},xs={class:"message-content"},Ts={key:0,class:"user-message"},Rs={key:1,class:"assistant-message"},Ds={key:0,class:"thinking-section"},As={class:"thinking-header"},Ls={class:"thinking-avatar"},Ms={class:"thinking-label"},Ns={class:"thinking-content"},Us={key:0,class:"thinking"},Vs={key:1,class:"progress"},qs={class:"progress-bar"},Os={class:"progress-text"},Fs={key:2,class:"steps-container"},js={class:"steps-title"},Bs=["onClick"],Ws={class:"section-header"},Js={class:"step-icon"},Gs={class:"step-title"},Hs={key:0,class:"step-status current"},zs={key:1,class:"step-status completed"},Xs={key:2,class:"step-status pending"},Ks={key:0,class:"action-info"},Qs={class:"action-description"},Ys={class:"action-icon"},Zs={key:0,class:"tool-params"},eo={class:"param-label"},to={class:"param-content"},no={key:1,class:"think-details"},so={class:"think-header"},oo={class:"think-label"},ao={class:"think-output"},io={class:"think-content"},lo={key:1,class:"sub-plan-steps"},co={class:"sub-plan-header"},ro={class:"sub-plan-step-list"},uo=["onClick"],po={class:"sub-step-indicator"},ho={class:"sub-step-icon"},go={class:"sub-step-number"},mo={class:"sub-step-content"},fo={class:"sub-step-title"},vo={key:2,class:"user-input-form-container"},Po={class:"user-input-message"},_o={key:0,class:"form-description"},bo=["onSubmit"],So=["for"],Co=["id","name","onUpdate:modelValue"],ko={key:1,class:"form-group"},$o={for:"form-input-genericInput"},Eo=["onUpdate:modelValue"],yo={type:"submit",class:"submit-user-input-btn"},wo={key:3,class:"default-processing"},Io={class:"processing-indicator"},xo={class:"response-section"},To={class:"response-header"},Ro={class:"response-avatar"},Do={class:"response-name"},Ao={class:"response-content"},Lo={key:0,class:"final-response"},Mo=["innerHTML"],No={key:1,class:"response-placeholder"},Uo={class:"typing-indicator"},Vo={class:"typing-text"},qo={key:0,class:"message assistant"},Oo={class:"message-content"},Fo={class:"assistant-message"},jo={class:"thinking-section"},Bo={class:"thinking-header"},Wo={class:"thinking-avatar"},Jo={class:"thinking-label"},Go={class:"thinking-content"},Ho={class:"default-processing"},zo={class:"processing-indicator"},Xo={class:"response-section"},Ko={class:"response-header"},Qo={class:"response-avatar"},Yo={class:"response-name"},Zo={class:"response-content"},ea={class:"response-placeholder"},ta={class:"typing-indicator"},na={class:"typing-text"},sa=["title"],oa=Se({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(B,{expose:t,emit:n}){const c=B,S=n,{t:u}=Ce(),y=ws(),C=q(),G=q(!1),R=q([]),z=q(),r=q(!1),v=Ae({}),k=(o,s,i)=>{const d={id:Date.now().toString(),type:o,content:s,timestamp:new Date,...i};return o==="assistant"&&!d.thinking&&!d.content&&(d.thinking=u("chat.thinking")),R.value.push(d),d},X=o=>{const s=R.value[R.value.length-1];s.type==="assistant"&&Object.assign(s,o)},te=async o=>{try{G.value=!0;const s=k("assistant","",{thinking:"正在理解您的请求并准备回复..."}),i=await Le.sendMessage(o);if(i.planId)console.log("[ChatComponent] Received planId from direct execution:",i.planId),s.planExecution||(s.planExecution={}),s.planExecution.currentPlanId=i.planId,K.handlePlanExecutionRequested(i.planId,o),delete s.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete s.thinking;const d=re(i,o);s.content=d}}catch(s){console.error("Direct mode error:",s),X({content:Q(s)})}finally{G.value=!1}},re=(o,s)=>o.result??o.message??o.content??"",Q=o=>{const s=(o==null?void 0:o.message)??(o==null?void 0:o.toString())??"未知错误";return s.includes("网络")||s.includes("network")||s.includes("timeout")?"抱歉，似乎网络连接有些问题。请检查您的网络连接后再试一次，或者稍等几分钟再重新提问。":s.includes("认证")||s.includes("权限")||s.includes("auth")?"抱歉，访问权限出现了问题。这可能是系统配置的问题，请联系管理员或稍后再试。":s.includes("格式")||s.includes("参数")||s.includes("invalid")?"抱歉，您的请求格式可能有些问题。能否请您重新表述一下您的需求？我会尽力理解并帮助您。":`抱歉，处理您的请求时遇到了一些问题（${s}）。请稍后再试，或者换个方式表达您的需求，我会尽力帮助您的。`},O=(o=!1)=>{ie(()=>{if(C.value){const s=C.value;(o||s.scrollHeight-s.scrollTop-s.clientHeight<150)&&s.scrollTo({top:s.scrollHeight,behavior:o?"auto":"smooth"})}})},Y=()=>{O(!0),r.value=!1},Z=()=>{if(C.value){const o=C.value,s=o.scrollHeight-o.scrollTop-o.clientHeight<150;r.value=!s&&R.value.length>0}},_e=()=>{C.value&&C.value.addEventListener("scroll",Z)},me=()=>{C.value&&C.value.removeEventListener("scroll",Z)},f=o=>{k("user",o),c.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",o):te(o)},g=(o,s)=>{var A;const i=((A=o.planExecution)==null?void 0:A.agentExecutionSequence)??[];return s<0||s>=i.length?"IDLE":i[s].status??"IDLE"},D=(o,s)=>{var i,d;if(!((i=o.planExecution)!=null&&i.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:o.planExecution.currentPlanId,stepIndex:s,stepTitle:(d=o.planExecution.steps)==null?void 0:d[s]}),S("step-selected",o.planExecution.currentPlanId,s)},x=(o,s)=>{var i;try{const d=(i=o.planExecution)==null?void 0:i.agentExecutionSequence;if(!(d!=null&&d.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const A=d[s];if(!A)return console.log(`[ChatComponent] No agentExecution found for step ${s}`),[];if(!A.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${s}`),[];for(const T of A.thinkActSteps)if(T.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${s}:`,T.subPlanExecutionRecord),(T.subPlanExecutionRecord.steps??[]).map(L=>typeof L=="string"?L:typeof L=="object"&&L!==null&&(L.title||L.description)||"子步骤");return[]}catch(d){return console.warn("[ChatComponent] Error getting sub-plan steps:",d),[]}},_=(o,s,i)=>{var d;try{const A=(d=o.planExecution)==null?void 0:d.agentExecutionSequence;if(!(A!=null&&A.length))return"pending";const T=A[s];if(!T||!T.thinkActSteps)return"pending";let J=null;for(const M of T.thinkActSteps)if(M.subPlanExecutionRecord){J=M.subPlanExecutionRecord;break}if(!J)return"pending";const L=J.currentStepIndex;return J.completed?"completed":L==null?i===0?"current":"pending":i<L?"completed":i===L?"current":"pending"}catch(A){return console.warn("[ChatComponent] Error getting sub-plan step status:",A),"pending"}},I=(o,s,i)=>{var d,A;try{const T=(d=o.planExecution)==null?void 0:d.agentExecutionSequence;if(!(T!=null&&T.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const J=T[s];if(!J){console.warn("[ChatComponent] No agentExecution found for step",s);return}if(!J.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",s);return}let L=null;for(const M of J.thinkActSteps)if(M.subPlanExecutionRecord){L=M.subPlanExecutionRecord;break}if(!(L!=null&&L.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}S("sub-plan-step-selected",((A=o.planExecution)==null?void 0:A.currentPlanId)??"",L.currentPlanId,s,i)}catch(T){console.error("[ChatComponent] Error handling sub-plan step click:",T)}},H=(o,s)=>{var d,A,T,J;if(!((d=o.planExecution)!=null&&d.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",o.planExecution.steps.length,"execution sequence:",((A=s.agentExecutionSequence)==null?void 0:A.length)??0);const i=new Array(o.planExecution.steps.length).fill(null);if((T=s.agentExecutionSequence)!=null&&T.length){const L=Math.min(s.agentExecutionSequence.length,o.planExecution.steps.length);for(let M=0;M<L;M++){const w=s.agentExecutionSequence[M];if((J=w.thinkActSteps)!=null&&J.length){const N=w.thinkActSteps[w.thinkActSteps.length-1];N.actionDescription&&N.toolParameters?(i[M]={actionDescription:N.actionDescription,toolParameters:typeof N.toolParameters=="string"?N.toolParameters:JSON.stringify(N.toolParameters,null,2),thinkInput:N.thinkInput??"",thinkOutput:N.thinkOutput??"",status:s.currentStepIndex!==void 0&&M<s.currentStepIndex?"completed":s.currentStepIndex!==void 0&&M===s.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${M} action set: ${i[M].actionDescription}`)):(i[M]={actionDescription:"思考中",toolParameters:"等待决策",thinkInput:N.thinkInput??"",thinkOutput:N.thinkOutput??"",status:s.currentStepIndex!==void 0&&M===s.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${M} is thinking`))}else i[M]={actionDescription:s.currentStepIndex!==void 0&&M<s.currentStepIndex?"已完成":"等待中",toolParameters:"无工具参数",thinkInput:"",thinkOutput:"",status:s.currentStepIndex!==void 0&&M<s.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] 步骤 ${M} 无执行细节, 状态设为: ${i[M].status}`)}}else console.log("[ChatComponent] 没有执行序列数据");o.stepActions=[...i],console.log("[ChatComponent] 步骤动作更新完成:",JSON.stringify(i.map(L=>L==null?void 0:L.actionDescription))),ie(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},ne=o=>{console.log("[ChatComponent] Starting dialog round with planId:",o),o&&(R.value.findIndex(i=>{var d;return((d=i.planExecution)==null?void 0:d.currentPlanId)===o&&i.type==="assistant"})===-1?(k("assistant","",{planExecution:{currentPlanId:o},thinking:"正在准备执行计划..."}),console.log("[ChatComponent] Created new assistant message for planId:",o)):console.log("[ChatComponent] Found existing assistant message for planId:",o))},P=o=>{var T,J,L,M;console.log("[ChatComponent] Processing plan update with rootPlanId:",o);const s=K.getCachedPlanRecord(o);if(!s){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",o);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",s),console.log("[ChatComponent] Plan steps:",s.steps),console.log("[ChatComponent] Plan completed:",s.completed),!s.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const i=R.value.findIndex(w=>{var N;return((N=w.planExecution)==null?void 0:N.currentPlanId)===s.currentPlanId&&w.type==="assistant"});let d;if(i!==-1)d=R.value[i],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",s.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",s.currentPlanId),console.log("[ChatComponent] Current messages:",R.value.map(N=>{var se;return{type:N.type,planId:(se=N.planExecution)==null?void 0:se.currentPlanId,content:N.content.substring(0,50)}}));let w=-1;for(let N=R.value.length-1;N>=0;N--)if(R.value[N].type==="assistant"){w=N;break}if(w!==-1)d=R.value[w],d.planExecution||(d.planExecution={}),d.planExecution.currentPlanId=s.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",s.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(d.planExecution||(d.planExecution={}),d.planExecution=JSON.parse(JSON.stringify(s)),!s.steps||s.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),s.completed){delete d.thinking;const w=s.summary??s.result??s.message??"处理完成";d.content=b(w),console.log("[ChatComponent] Set simple response content:",d.content)}else s.title&&(d.thinking=`正在执行: ${s.title}`);return}delete d.thinking;const A=s.steps.map(w=>typeof w=="string"?w:typeof w=="object"&&w!==null&&(w.title||w.description)||"步骤");if(d.planExecution&&(d.planExecution.steps=A),s.agentExecutionSequence&&s.agentExecutionSequence.length>0){console.log("[ChatComponent] 发现执行序列数据，数量:",s.agentExecutionSequence.length),H(d,s);const w=s.currentStepIndex??0;if(w>=0&&w<s.agentExecutionSequence.length){const se=s.agentExecutionSequence[w].thinkActSteps;if(se&&se.length>0){const fe=se[se.length-1];if(fe.thinkOutput){const we=fe.thinkOutput.length>150?fe.thinkOutput.substring(0,150)+"...":fe.thinkOutput;d.thinking=`正在思考: ${we}`}}}}else if(d.planExecution){const w=d.planExecution.currentStepIndex??0,N=(T=d.planExecution.steps)==null?void 0:T[w],se=typeof N=="string"?N:"";d.thinking=`正在执行: ${se}`}if(s.userInputWaitState&&d.planExecution?(console.log("[ChatComponent] 需要用户输入:",s.userInputWaitState),d.planExecution.userInputWaitState||(d.planExecution.userInputWaitState={}),d.planExecution.userInputWaitState={message:s.userInputWaitState.message??"",formDescription:s.userInputWaitState.formDescription??"",formInputs:((J=s.userInputWaitState.formInputs)==null?void 0:J.map(w=>({label:w.label,value:w.value||""})))??[]},v[L=d.id]??(v[L]={}),d.thinking="等待用户输入..."):(M=d.planExecution)!=null&&M.userInputWaitState&&delete d.planExecution.userInputWaitState,s.completed??s.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete d.thinking;let w="";s.summary?w=s.summary:s.result?w=s.result:w="任务已完成",d.content=V(w),console.log("[ChatComponent] Updated completed message:",d.content)}ie(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},b=o=>o?o.includes("我")||o.includes("您")||o.includes("您好")||o.includes("可以")?o:o.length<10?`${o}！还有什么需要我帮助的吗？`:o.length<50?`好的，${o}。如果您还有其他问题，请随时告诉我。`:`${o}

希望这个回答对您有帮助！还有什么我可以为您做的吗？`:"我明白了，还有什么我可以帮您的吗？",V=o=>o?`${o}`:"任务已完成！还有什么我可以帮您的吗？",W=o=>{console.log("[ChatComponent] Plan completed with rootPlanId:",o);const s=K.getCachedPlanRecord(o);if(!s){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",o);return}if(console.log("[ChatComponent] Plan details:",s),s.rootPlanId){const i=R.value.findIndex(d=>{var A;return((A=d.planExecution)==null?void 0:A.currentPlanId)===s.rootPlanId});if(i!==-1){const d=R.value[i];delete d.thinking;let T=s.summary??s.result??"任务已完成";!T.includes("我")&&!T.includes("您")&&(T.includes("成功")||T.includes("完成")?T=`很好！${T}。如果您还有其他需要帮助的地方，请随时告诉我。`:T=`我已经完成了您的请求：${T}`),d.content=T,console.log("[ChatComponent] Updated completed message:",d.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",s.rootPlanId)}},ue=o=>{if(!o)return"";let s=o.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return s=s.replace(/(<br><br>)/g,"</p><p>"),s.includes("</p><p>")&&(s=`<p>${s}</p>`),s},ye=async o=>{var s;if(!((s=o.planExecution)!=null&&s.currentPlanId)||!o.planExecution.userInputWaitState){console.error("[ChatComponent] 缺少planExecution.currentPlanId或userInputWaitState");return}try{const i={},d=o.planExecution.userInputWaitState.formInputs;d&&d.length>0?Object.entries(v[o.id]).forEach(([T,J])=>{var w;const L=parseInt(T,10),M=((w=d[L])==null?void 0:w.label)||`input_${T}`;i[M]=J}):i.genericInput=o.genericInput??"",console.log("[ChatComponent] 提交用户输入:",i);const A=await Me.submitFormInput(o.planExecution.currentPlanId,i);delete o.planExecution.userInputWaitState,delete o.genericInput,delete v[o.id],y.startPolling(),console.log("[ChatComponent] 用户输入提交成功:",A)}catch(i){console.error("[ChatComponent] 用户输入提交失败:",i),alert(`提交失败: ${(i==null?void 0:i.message)||"未知错误"}`)}};return Te(()=>c.initialPrompt,(o,s)=>{console.log("[ChatComponent] initialPrompt changed from:",s,"to:",o),o&&typeof o=="string"&&o.trim()&&o!==s&&(console.log("[ChatComponent] Processing changed initial prompt:",o),ie(()=>{f(o)}))},{immediate:!1}),ke(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),K.setEventCallbacks({onPlanUpdate:P,onPlanCompleted:W,onDialogRoundStart:ne,onChatInputUpdateState:o=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",o)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")}}),ie(()=>{_e()}),c.initialPrompt&&typeof c.initialPrompt=="string"&&c.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",c.initialPrompt),ie(()=>{f(c.initialPrompt)}))}),$e(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),me(),z.value&&clearInterval(z.value),y.cleanup(),Object.keys(v).forEach(o=>delete v[o])}),t({handleSendMessage:f,handlePlanUpdate:P,handlePlanCompleted:W,handleDialogRoundStart:ne,addMessage:k}),(o,s)=>(h(),m("div",Is,[e("div",{class:"messages",ref_key:"messagesRef",ref:C},[(h(!0),m(pe,null,he(R.value,i=>{var d,A,T,J,L,M,w,N,se;return h(),m("div",{key:i.id,class:ae(["message",{user:i.type==="user",assistant:i.type==="assistant"}])},[e("div",xs,[i.type==="user"?(h(),m("div",Ts,l(i.content),1)):(h(),m("div",Rs,[i.thinking||((d=i.planExecution)==null?void 0:d.progress)!==void 0||(((T=(A=i.planExecution)==null?void 0:A.steps)==null?void 0:T.length)??0)>0?(h(),m("div",Ds,[e("div",As,[e("div",Ls,[$(a(E),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Ms,l(o.$t("chat.thinkingLabel")),1)]),e("div",Ns,[i.thinking?(h(),m("div",Us,[$(a(E),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,l(i.thinking),1)])):j("",!0),((J=i.planExecution)==null?void 0:J.progress)!==void 0?(h(),m("div",Vs,[e("div",qs,[e("div",{class:"progress-fill",style:Re({width:i.planExecution.progress+"%"})},null,4)]),e("span",Os,l(i.planExecution.progressText??o.$t("chat.processing")+"..."),1)])):j("",!0),(((M=(L=i.planExecution)==null?void 0:L.steps)==null?void 0:M.length)??0)>0?(h(),m("div",Fs,[e("h4",js,l(o.$t("chat.stepExecutionDetails")),1),(h(!0),m(pe,null,he((w=i.planExecution)==null?void 0:w.steps,(fe,U)=>{var we,Ne,Ue,Ve,qe,Oe,Fe,je,Be,We,Je,Ge,He,ze,Xe,Ke,Qe,Ye,Ze;return h(),m("div",{key:U,class:ae(["ai-section",{running:g(i,U)==="RUNNING",completed:g(i,U)==="FINISHED",pending:g(i,U)==="IDLE"}]),onClick:xe(le=>D(i,U),["stop"])},[e("div",Ws,[e("span",Js,l(g(i,U)==="FINISHED"?"✓":g(i,U)==="RUNNING"?"▶":"○"),1),e("span",Gs,l(fe||`${o.$t("chat.step")} ${U+1}`),1),g(i,U)==="RUNNING"?(h(),m("span",Hs,l(o.$t("chat.status.executing")),1)):g(i,U)==="FINISHED"?(h(),m("span",zs,l(o.$t("chat.status.completed")),1)):(h(),m("span",Xs,l(o.$t("chat.status.pending")),1))]),i.stepActions&&i.stepActions[U]?(h(),m("div",Ks,[e("div",Qs,[e("span",Ys,l(((we=i.stepActions[U])==null?void 0:we.status)==="current"?"🔄":((Ne=i.stepActions[U])==null?void 0:Ne.status)==="completed"?"✓":"⏳"),1),e("strong",null,l((Ue=i.stepActions[U])==null?void 0:Ue.actionDescription),1)]),(Ve=i.stepActions[U])!=null&&Ve.toolParameters?(h(),m("div",Zs,[s[0]||(s[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",eo,l(o.$t("common.parameters"))+":",1),e("pre",to,l((qe=i.stepActions[U])==null?void 0:qe.toolParameters),1)])):j("",!0),(Oe=i.stepActions[U])!=null&&Oe.thinkOutput?(h(),m("div",no,[e("div",so,[s[1]||(s[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",oo,l(o.$t("chat.thinkingOutput"))+":",1)]),e("div",ao,[e("pre",io,l((Fe=i.stepActions[U])==null?void 0:Fe.thinkOutput),1)])])):j("",!0)])):j("",!0),((je=x(i,U))==null?void 0:je.length)>0?(h(),m("div",lo,[e("div",co,[$(a(E),{icon:"carbon:tree-view",class:"sub-plan-icon"}),s[2]||(s[2]=e("span",{class:"sub-plan-title"},"子执行计划",-1))]),e("div",ro,[(h(!0),m(pe,null,he(x(i,U),(le,oe)=>(h(),m("div",{key:`sub-${U}-${oe}`,class:ae(["sub-plan-step-item",{completed:_(i,U,oe)==="completed",current:_(i,U,oe)==="current",pending:_(i,U,oe)==="pending"}]),onClick:xe(et=>I(i,U,oe),["stop"])},[e("div",po,[e("span",ho,l(_(i,U,oe)==="completed"?"✓":_(i,U,oe)==="current"?"▶":"○"),1),e("span",go,l(oe+1),1)]),e("div",mo,[e("span",fo,l(le),1),s[3]||(s[3]=e("span",{class:"sub-step-badge"},"子步骤",-1))])],10,uo))),128))])])):j("",!0),(Be=i.planExecution)!=null&&Be.userInputWaitState&&g(i,U)==="RUNNING"?(h(),m("div",vo,[e("p",Po,l(((Je=(We=i.planExecution)==null?void 0:We.userInputWaitState)==null?void 0:Je.message)??o.$t("chat.userInput.message")),1),(He=(Ge=i.planExecution)==null?void 0:Ge.userInputWaitState)!=null&&He.formDescription?(h(),m("p",_o,l((Xe=(ze=i.planExecution)==null?void 0:ze.userInputWaitState)==null?void 0:Xe.formDescription),1)):j("",!0),e("form",{onSubmit:xe(le=>ye(i),["prevent"]),class:"user-input-form"},[(Qe=(Ke=i.planExecution)==null?void 0:Ke.userInputWaitState)!=null&&Qe.formInputs&&i.planExecution.userInputWaitState.formInputs.length>0?(h(!0),m(pe,{key:0},he((Ze=(Ye=i.planExecution)==null?void 0:Ye.userInputWaitState)==null?void 0:Ze.formInputs,(le,oe)=>(h(),m("div",{key:oe,class:"form-group"},[e("label",{for:`form-input-${le.label.replace(/\W+/g,"_")}`},l(le.label)+": ",9,So),ve(e("input",{type:"text",id:`form-input-${le.label.replace(/\W+/g,"_")}`,name:le.label,"onUpdate:modelValue":et=>v[i.id][oe]=et,class:"form-input"},null,8,Co),[[Pe,v[i.id][oe]]])]))),128)):(h(),m("div",ko,[e("label",$o,l(o.$t("common.input"))+":",1),ve(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":le=>i.genericInput=le,class:"form-input"},null,8,Eo),[[Pe,i.genericInput]])])),e("button",yo,l(o.$t("chat.userInput.submit")),1)],40,bo)])):j("",!0)],10,Bs)}),128))])):!i.content&&(i.thinking||((N=i.planExecution)==null?void 0:N.progress)!==void 0&&(((se=i.planExecution)==null?void 0:se.progress)??0)<100)?(h(),m("div",wo,[e("div",Io,[s[4]||(s[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,l(i.thinking??o.$t("chat.thinkingProcessing")),1)])])):j("",!0)])])):j("",!0),e("div",xo,[e("div",To,[e("div",Ro,[$(a(E),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Do,l(o.$t("chat.botName")),1)]),e("div",Ao,[i.content?(h(),m("div",Lo,[e("div",{class:"response-text",innerHTML:ue(i.content)},null,8,Mo)])):(h(),m("div",No,[e("div",Uo,[s[5]||(s[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Vo,l(o.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),G.value?(h(),m("div",qo,[e("div",Oo,[e("div",Fo,[e("div",jo,[e("div",Bo,[e("div",Wo,[$(a(E),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Jo,l(o.$t("chat.thinkingLabel")),1)]),e("div",Go,[e("div",Ho,[e("div",zo,[s[6]||(s[6]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,l(o.$t("chat.thinking")),1)])])])]),e("div",Xo,[e("div",Ko,[e("div",Qo,[$(a(E),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Yo,l(o.$t("chat.botName")),1)]),e("div",Zo,[e("div",ea,[e("div",ta,[s[7]||(s[7]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",na,l(o.$t("chat.thinkingResponse")),1)])])])])])])])):j("",!0)],512),r.value?(h(),m("div",{key:0,class:"scroll-to-bottom-btn",onClick:Y,title:o.$t("chat.scrollToBottom")},[$(a(E),{icon:"carbon:chevron-down"})],8,sa)):j("",!0)]))}}),aa=Ee(oa,[["__scopeId","data-v-d1fb4f30"]]),ia={class:"input-area"},la={class:"input-container"},ca={class:"attach-btn",title:"附加文件"},ra=["placeholder","disabled"],ua=["title"],da=["disabled","title"],pa=Se({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1}},emits:["send","clear","update-state","plan-mode-clicked"],setup(B,{expose:t,emit:n}){const{t:c}=Ce(),S=B,u=n,y=q(),C=q(""),G=ge(()=>S.placeholder||c("input.placeholder")),R=q(G.value),z=ge(()=>!!S.disabled),r=()=>{ie(()=>{y.value&&(y.value.style.height="auto",y.value.style.height=Math.min(y.value.scrollHeight,120)+"px")})},v=O=>{O.key==="Enter"&&!O.shiftKey&&(O.preventDefault(),k())},k=()=>{if(!C.value.trim()||z.value)return;const O=C.value.trim();u("send",O),te()},X=()=>{u("plan-mode-clicked")},te=()=>{C.value="",r(),u("clear")};return t({clearInput:te,updateState:(O,Y)=>{Y&&(R.value=O?Y:c("input.waiting")),u("update-state",O,Y)},getQuery:()=>C.value.trim(),focus:()=>{var O;return(O=y.value)==null?void 0:O.focus()}}),ke(()=>{}),$e(()=>{}),(O,Y)=>(h(),m("div",ia,[e("div",la,[e("button",ca,[$(a(E),{icon:"carbon:attachment"})]),ve(e("textarea",{"onUpdate:modelValue":Y[0]||(Y[0]=Z=>C.value=Z),ref_key:"inputRef",ref:y,class:"chat-input",placeholder:R.value,disabled:z.value,onKeydown:v,onInput:r},null,40,ra),[[Pe,C.value]]),e("button",{class:"plan-mode-btn",title:O.$t("input.planMode"),onClick:X},[$(a(E),{icon:"carbon:document"}),ee(" "+l(O.$t("input.planMode")),1)],8,ua),e("button",{class:"send-button",disabled:!C.value.trim()||z.value,onClick:k,title:O.$t("input.send")},[$(a(E),{icon:"carbon:send-alt"}),ee(" "+l(O.$t("input.send")),1)],8,da)])]))}}),ha=Ee(pa,[["__scopeId","data-v-c8e17afe"]]),ga={class:"direct-page"},ma={class:"direct-chat"},fa={class:"chat-header"},va={class:"header-actions"},Pa=["title"],_a={class:"chat-content"},ba=["title"],Sa=Se({__name:"index",setup(B){const t=at(),n=it(),c=ct(),{t:S}=Ce(),u=q(""),y=q(),C=q(),G=q(),R=q(!1),z=q(!1),r=q(null),v=q(50),k=q(!1),X=q(0),te=q(0);ke(()=>{console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",c.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",c.hasUnprocessedTask()),K.setEventCallbacks({onPlanUpdate:b=>{console.log("[Direct] Plan update event received for rootPlanId:",b),Z(b)&&(console.log("[Direct] Processing plan update for current rootPlanId:",b),C.value&&typeof C.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",b),C.value.handlePlanUpdate(b)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),y.value&&typeof y.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",b),y.value.updateDisplayedPlanProgress(b)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:b=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",b),!!Z(b)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",b),C.value&&typeof C.value.handlePlanCompleted=="function"){const V=K.getCachedPlanRecord(b);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",V),C.value.handlePlanCompleted(V??{planId:b})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");r.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:b=>{console.log("[Direct] Dialog round start event received for rootPlanId:",b),r.value=b,console.log("[Direct] Set currentRootPlanId to:",b),C.value&&typeof C.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",b),C.value.handleDialogRoundStart(b)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),me()},onChatInputUpdateState:b=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",b),!Z(b,!0))return;const V=K.getCachedUIState(b);V&&g(V.enabled,V.placeholder)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),p.loadPlanTemplateList(),c.hasUnprocessedTask()&&c.currentTask?(u.value=c.currentTask.prompt,console.log("[Direct] Setting prompt from store:",u.value),c.markTaskAsProcessed(),console.log("[Direct] Received task from store:",u.value)):(u.value=t.query.prompt||"",console.log("[Direct] Received task from URL:",u.value),console.log("[Direct] No unprocessed task in store"));const P=localStorage.getItem("directPanelWidth");P&&(v.value=parseFloat(P)),console.log("[Direct] Final prompt value:",u.value)}),Te(()=>c.currentTask,P=>{console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",P),P&&!P.processed?(u.value=P.prompt,c.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",u.value)):console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),Te(()=>u.value,(P,b)=>{console.log("[Direct] prompt value changed from:",b,"to:",P)},{immediate:!1}),$e(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),r.value=null,K.cleanup(),document.removeEventListener("mousemove",Q),document.removeEventListener("mouseup",O)});const re=P=>{k.value=!0,X.value=P.clientX,te.value=v.value,document.addEventListener("mousemove",Q),document.addEventListener("mouseup",O),document.body.style.cursor="col-resize",document.body.style.userSelect="none",P.preventDefault()},Q=P=>{if(!k.value)return;const b=window.innerWidth,W=(P.clientX-X.value)/b*100;let ue=te.value+W;ue=Math.max(20,Math.min(80,ue)),v.value=ue},O=()=>{k.value=!1,document.removeEventListener("mousemove",Q),document.removeEventListener("mouseup",O),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",v.value.toString())},Y=()=>{v.value=50,localStorage.setItem("directPanelWidth","50")},Z=(P,b=!1)=>!r.value||P===r.value||b&&(P==="ui-state"||P==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",P,"current:",r.value),!1),_e=P=>{console.log("[DirectView] Send message from input:",P),C.value&&typeof C.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",P),C.value.handleSendMessage(P)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},me=()=>{console.log("[DirectView] Input cleared"),G.value&&typeof G.value.clear=="function"&&G.value.clear()},f=()=>{console.log("[DirectView] Input focused")},g=(P,b)=>{console.log("[DirectView] Input state updated:",P,b),z.value=!P},D=(P,b)=>{console.log("[DirectView] Step selected:",P,b),y.value&&typeof y.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",P,b),y.value.handleStepSelected(P,b)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},x=(P,b,V,W)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:P,subPlanId:b,stepIndex:V,subStepIndex:W}),y.value&&typeof y.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:P,subPlanId:b,stepIndex:V,subStepIndex:W}),y.value.handleSubPlanStepSelected(P,b,V,W)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},_=()=>{console.log("[DirectView] Plan mode button clicked"),p.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",p.isCollapsed)},I=()=>{n.push("/home")},H=()=>{n.push("/configs")},ne=async P=>{var b;if(console.log("[DirectView] Plan execution requested:",P),R.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}R.value=!0,C.value&&typeof C.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",P.title),C.value.addMessage("user",P.title)):console.warn("[DirectView] chatRef.addMessage method not available");try{const V=P.planData.planTemplateId||P.planData.planId;if(!V)throw new Error("没有找到计划模板ID");console.log("[Direct] Executing plan with templateId:",V,"params:",P.params),console.log("[Direct] About to call PlanActApiService.executePlan");let W;if((b=P.params)!=null&&b.trim()?(console.log("[Direct] Calling executePlan with params:",P.params.trim()),W=await ce.executePlan(V,P.params.trim())):(console.log("[Direct] Calling executePlan without params"),W=await ce.executePlan(V)),console.log("[Direct] Plan execution API response:",W),W.planId)console.log("[Direct] Got planId from response:",W.planId,"starting plan execution"),r.value=W.planId,console.log("[Direct] Set currentRootPlanId to:",W.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),K.handlePlanExecutionRequested(W.planId,P.title);else throw console.error("[Direct] No planId in response:",W),new Error("执行计划失败：未返回有效的计划ID")}catch(V){console.error("[Direct] Plan execution failed:",V),console.error("[Direct] Error details:",{message:V.message,stack:V.stack}),r.value=null,C.value&&typeof C.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),C.value.addMessage("user",P.title),C.value.addMessage("assistant",`执行计划失败: ${V.message||"未知错误"}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`执行计划失败: ${V.message||"未知错误"}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),R.value=!1}};return(P,b)=>(h(),m("div",ga,[e("div",ma,[$(un,{onPlanExecutionRequested:ne}),e("div",{class:"left-panel",style:Re({width:v.value+"%"})},[e("div",fa,[e("button",{class:"back-button",onClick:I},[$(a(E),{icon:"carbon:arrow-left"})]),e("h2",null,l(P.$t("conversation")),1),e("div",va,[$(lt),e("button",{class:"config-button",onClick:H,title:P.$t("direct.configuration")},[$(a(E),{icon:"carbon:settings-adjust",width:"20"})],8,Pa)])]),e("div",_a,[$(aa,{ref_key:"chatRef",ref:C,mode:"direct","initial-prompt":u.value||"",onStepSelected:D,onSubPlanStepSelected:x},null,8,["initial-prompt"])]),$(ha,{ref_key:"inputRef",ref:G,disabled:z.value,placeholder:z.value?"等待任务完成...":a(S)("input.placeholder"),onSend:_e,onClear:me,onFocus:f,onUpdateState:g,onPlanModeClicked:_},null,8,["disabled","placeholder"])],4),e("div",{class:"panel-resizer",onMousedown:re,onDblclick:Y,title:P.$t("direct.panelResizeHint")},b[0]||(b[0]=[e("div",{class:"resizer-line"},null,-1)]),40,ba),$(ys,{ref_key:"rightPanelRef",ref:y,style:Re({width:100-v.value+"%"})},null,8,["style"])])]))}}),wa=Ee(Sa,[["__scopeId","data-v-9a591970"]]);export{wa as default};
