var ct=Object.defineProperty;var rt=(T,n,s)=>n in T?ct(T,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):T[n]=s;var he=(T,n,s)=>rt(T,typeof n!="symbol"?n+"":n,s);import{d as Ce,u as Ie,c as _e,o as Se,a as m,b as h,n as te,x as i,e,f as F,t as l,g as k,i as Y,F as ge,l as ve,h as ie,w as de,j as fe,z as at,r as D,y as ne,A as De,s as ue,T as xe,k as Re,B as $e,q as Ue,C as Ne,D as ut,E as dt,p as lt,G as pt}from"./index-4v3E7DlV.js";import{I as C}from"./iconify-BLmmgPNH.js";import{s as f,P as Ae,u as it}from"./sidebar-CmBcz3il.js";import{_ as ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{L as ht}from"./llm-check-BVkAKrj3.js";import{L as gt}from"./index-qVolg4Ti.js";import{u as mt,a as vt}from"./useMessage-C57EfbNm.js";const ft={class:"sidebar-content"},bt={class:"sidebar-content-header"},kt={class:"sidebar-content-title"},_t={class:"tab-switcher"},$t=["disabled"],Pt={key:0,class:"tab-content"},Ct={class:"new-task-section"},St={class:"sidebar-content-list"},yt={key:0,class:"loading-state"},Et={key:1,class:"error-state"},wt={key:2,class:"empty-state"},Tt=["onClick"],It={class:"task-icon"},Dt={class:"task-details"},xt={class:"task-title"},Rt={class:"task-preview"},At={class:"task-time"},Mt={class:"task-actions"},Nt=["title","onClick"],Ut={key:1,class:"tab-content config-tab"},Lt={key:0,class:"config-container"},qt={class:"template-info-header"},Ft={class:"template-info"},Vt={class:"template-id"},Ot={class:"config-section"},Bt={class:"section-header"},Wt={class:"generator-content"},jt=["placeholder"],Ht={class:"generator-actions"},zt=["disabled"],Jt=["disabled"],Gt={class:"config-section"},Xt={class:"section-header"},Kt={class:"section-actions"},Qt=["disabled","title"],Yt=["disabled","title"],Zt=["disabled"],en=["placeholder"],tn={class:"config-section"},nn={class:"section-header"},sn={class:"execution-content"},on={class:"params-input-group"},an={class:"params-help-text"},ln={class:"params-input-container"},cn=["placeholder"],rn=["title"],un={class:"api-url-display"},dn={class:"api-url-label"},pn={class:"api-url"},hn={class:"api-url-display"},gn={class:"api-url-label"},mn=["disabled"],vn=Ce({__name:"index",emits:["planExecutionRequested"],setup(T,{expose:n,emit:s}){const{t:d}=Ie(),E=["currentPlanId","userRequest","rootPlanId"],u=_e({get(){try{if(!f.jsonContent)return"";const g={...JSON.parse(f.jsonContent)};return E.forEach(S=>{delete g[S]}),JSON.stringify(g,null,2)}catch{return f.jsonContent}},set(o){try{if(!o.trim()){f.jsonContent="";return}const g=JSON.parse(o);let S={};try{S=JSON.parse(f.jsonContent||"{}")}catch{}const K={...g};E.forEach(U=>{S[U]!==void 0&&(K[U]=S[U])}),f.jsonContent=JSON.stringify(K)}catch{f.jsonContent=o}}}),$=s,x=async()=>{try{const o=await f.saveTemplate();o!=null&&o.duplicate?alert(d("sidebar.saveCompleted",{message:o.message,versionCount:o.versionCount})):o!=null&&o.saved?alert(d("sidebar.saveSuccess",{message:o.message,versionCount:o.versionCount})):o!=null&&o.message&&alert(d("sidebar.saveStatus",{message:o.message}))}catch(o){console.error("Failed to save plan modifications:",o),alert(o.message||d("sidebar.saveFailed"))}},O=async()=>{var o;try{await f.generatePlan(),alert(d("sidebar.generateSuccess",{templateId:((o=f.selectedTemplate)==null?void 0:o.id)??d("sidebar.unknown")}))}catch(g){console.error("Failed to generate plan:",g),alert(d("sidebar.generateFailed")+": "+g.message)}},P=async()=>{try{await f.updatePlan(),alert(d("sidebar.updateSuccess"))}catch(o){console.error("Failed to update plan:",o),alert(d("sidebar.updateFailed")+": "+o.message)}},B=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const o=f.preparePlanExecution();if(!o){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] Triggering plan execution request:",o),console.log("[Sidebar] Emitting planExecutionRequested event"),$("planExecutionRequested",o),console.log("[Sidebar] Event emitted")}catch(o){console.error("Error executing plan:",o),alert(d("sidebar.executeFailed")+": "+o.message)}finally{f.finishPlanExecution()}},X=o=>{if(isNaN(o.getTime()))return console.warn("Invalid date received:",o),d("time.unknown");const S=new Date().getTime()-o.getTime(),K=Math.floor(S/6e4),U=Math.floor(S/36e5),q=Math.floor(S/864e5);return K<1?d("time.now"):K<60?d("time.minuteAgo",{count:K}):U<24?d("time.hourAgo",{count:U}):q<30?d("time.dayAgo",{count:q}):o.toLocaleDateString("zh-CN")},G=(o,g)=>!o||o.length<=g?o:o.substring(0,g)+"...";return Se(()=>{f.loadPlanTemplateList()}),n({loadPlanTemplateList:f.loadPlanTemplateList,toggleSidebar:f.toggleSidebar,currentPlanTemplateId:f.currentPlanTemplateId}),(o,g)=>(h(),m("div",{class:te(["sidebar-wrapper",{"sidebar-wrapper-collapsed":i(f).isCollapsed}])},[e("div",ft,[e("div",bt,[e("div",kt,l(o.$t("sidebar.title")),1)]),e("div",_t,[e("button",{class:te(["tab-button",{active:i(f).currentTab==="list"}]),onClick:g[0]||(g[0]=S=>i(f).switchToTab("list"))},[k(i(C),{icon:"carbon:list",width:"16"}),Y(" "+l(o.$t("sidebar.templateList")),1)],2),e("button",{class:te(["tab-button",{active:i(f).currentTab==="config"}]),onClick:g[1]||(g[1]=S=>i(f).switchToTab("config")),disabled:!i(f).selectedTemplate},[k(i(C),{icon:"carbon:settings",width:"16"}),Y(" "+l(o.$t("sidebar.configuration")),1)],10,$t)]),i(f).currentTab==="list"?(h(),m("div",Pt,[e("div",Ct,[e("button",{class:"new-task-btn",onClick:g[2]||(g[2]=S=>i(f).createNewTemplate())},[k(i(C),{icon:"carbon:add",width:"16"}),Y(" "+l(o.$t("sidebar.newPlan"))+" ",1),g[11]||(g[11]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",St,[i(f).isLoading?(h(),m("div",yt,[k(i(C),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,l(o.$t("sidebar.loading")),1)])):i(f).errorMessage?(h(),m("div",Et,[k(i(C),{icon:"carbon:warning",width:"20"}),e("span",null,l(i(f).errorMessage),1),e("button",{onClick:g[3]||(g[3]=(...S)=>i(f).loadPlanTemplateList&&i(f).loadPlanTemplateList(...S)),class:"retry-btn"},l(o.$t("sidebar.retry")),1)])):i(f).planTemplateList.length===0?(h(),m("div",wt,[k(i(C),{icon:"carbon:document",width:"32"}),e("span",null,l(o.$t("sidebar.noTemplates")),1)])):(h(!0),m(ge,{key:3},ve(i(f).sortedTemplates,S=>(h(),m("div",{key:S.id,class:te(["sidebar-content-list-item",{"sidebar-content-list-item-active":S.id===i(f).currentPlanTemplateId}]),onClick:K=>i(f).selectTemplate(S)},[e("div",It,[k(i(C),{icon:"carbon:document",width:"20"})]),e("div",Dt,[e("div",xt,l(S.title||o.$t("sidebar.unnamedPlan")),1),e("div",Rt,l(G(S.description||o.$t("sidebar.noDescription"),40)),1)]),e("div",At,l(X(i(f).parseDateTime(S.updateTime||S.createTime))),1),e("div",Mt,[e("button",{class:"delete-task-btn",title:o.$t("sidebar.deleteTemplate"),onClick:ie(K=>i(f).deleteTemplate(S),["stop"])},[k(i(C),{icon:"carbon:close",width:"16"})],8,Nt)])],10,Tt))),128))])])):i(f).currentTab==="config"?(h(),m("div",Ut,[i(f).selectedTemplate?(h(),m("div",Lt,[e("div",qt,[e("div",Ft,[e("h3",null,l(i(f).selectedTemplate.title||o.$t("sidebar.unnamedPlan")),1),e("span",Vt,"ID: "+l(i(f).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:g[4]||(g[4]=S=>i(f).switchToTab("list"))},[k(i(C),{icon:"carbon:arrow-left",width:"16"})])]),e("div",Ot,[e("div",Bt,[k(i(C),{icon:"carbon:generate",width:"16"}),e("span",null,l(o.$t("sidebar.planGenerator")),1)]),e("div",Wt,[de(e("textarea",{"onUpdate:modelValue":g[5]||(g[5]=S=>i(f).generatorPrompt=S),class:"prompt-input",placeholder:o.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,jt),[[fe,i(f).generatorPrompt]]),e("div",Ht,[e("button",{class:"btn btn-primary btn-sm",onClick:O,disabled:i(f).isGenerating||!i(f).generatorPrompt.trim()},[k(i(C),{icon:i(f).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:te({spinning:i(f).isGenerating})},null,8,["icon","class"]),Y(" "+l(i(f).isGenerating?o.$t("sidebar.generating"):o.$t("sidebar.generatePlan")),1)],8,zt),e("button",{class:"btn btn-secondary btn-sm",onClick:P,disabled:i(f).isGenerating||!i(f).generatorPrompt.trim()||!i(f).jsonContent.trim()},[k(i(C),{icon:"carbon:edit",width:"14"}),Y(" "+l(o.$t("sidebar.updatePlan")),1)],8,Jt)])])]),e("div",Gt,[e("div",Xt,[k(i(C),{icon:"carbon:code",width:"16"}),e("span",null,l(o.$t("sidebar.jsonTemplate")),1),e("div",Kt,[e("button",{class:"btn btn-sm",onClick:g[6]||(g[6]=(...S)=>i(f).rollbackVersion&&i(f).rollbackVersion(...S)),disabled:!i(f).canRollback,title:o.$t("sidebar.rollback")},[k(i(C),{icon:"carbon:undo",width:"14"})],8,Qt),e("button",{class:"btn btn-sm",onClick:g[7]||(g[7]=(...S)=>i(f).restoreVersion&&i(f).restoreVersion(...S)),disabled:!i(f).canRestore,title:o.$t("sidebar.restore")},[k(i(C),{icon:"carbon:redo",width:"14"})],8,Yt),e("button",{class:"btn btn-primary btn-sm",onClick:x,disabled:i(f).isGenerating||i(f).isExecuting},[k(i(C),{icon:"carbon:save",width:"14"})],8,Zt)])]),de(e("textarea",{"onUpdate:modelValue":g[8]||(g[8]=S=>u.value=S),class:"json-editor",placeholder:o.$t("sidebar.jsonPlaceholder"),rows:"12"},null,8,en),[[fe,u.value]])]),e("div",tn,[e("div",nn,[k(i(C),{icon:"carbon:play",width:"16"}),e("span",null,l(o.$t("sidebar.executionController")),1)]),e("div",sn,[e("div",on,[e("label",null,l(o.$t("sidebar.executionParams")),1),e("div",an,l(o.$t("sidebar.executionParamsHelp")),1),e("div",ln,[de(e("input",{"onUpdate:modelValue":g[9]||(g[9]=S=>i(f).executionParams=S),class:"params-input",placeholder:o.$t("sidebar.executionParamsPlaceholder")},null,8,cn),[[fe,i(f).executionParams]]),e("button",{class:"clear-params-btn",onClick:g[10]||(g[10]=(...S)=>i(f).clearExecutionParams&&i(f).clearExecutionParams(...S)),title:o.$t("sidebar.clearParams")},[k(i(C),{icon:"carbon:close",width:"12"})],8,rn)])]),e("div",un,[e("span",dn,l(o.$t("sidebar.apiUrl"))+":",1),e("code",pn,l(i(f).computedApiUrl),1)]),e("div",hn,[e("span",gn,l(o.$t("sidebar.statusApiUrl"))+":",1),g[12]||(g[12]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:B,disabled:i(f).isExecuting||i(f).isGenerating},[k(i(C),{icon:i(f).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:te({spinning:i(f).isExecuting})},null,8,["icon","class"]),Y(" "+l(i(f).isExecuting?o.$t("sidebar.executing"):o.$t("sidebar.executePlan")),1)],8,mn)])])])):F("",!0)])):F("",!0)])],2))}}),fn=ye(vn,[["__scopeId","data-v-3c0cf310"]]);class qe{static async sendMessage(n){return ht.withLlmCheck(async()=>{const s=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:n})});if(!s.ok)throw new Error(`API request failed: ${s.status}`);return await s.json()})}}he(qe,"BASE_URL","/api/executor");class Fe{static async getDetails(n){try{const s=await fetch(`${this.BASE_URL}/details/${n}`);if(s.status===404)return null;if(!s.ok){const u=await s.text();throw new Error(`Failed to get detailed information: ${s.status} - ${u}`)}const d=await s.text(),E=JSON.parse(d);return E&&typeof E=="object"&&!E.currentPlanId&&(E.currentPlanId=n),E}catch(s){return console.error("[CommonApiService] Failed to get plan details:",s),{currentPlanId:n,status:"failed",message:s instanceof Error?s.message:"Failed to save, please retry"}}}static async submitFormInput(n,s){const d=await fetch(`${this.BASE_URL}/submit-input/${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!d.ok){let u;try{u=await d.json()}catch{u={message:`Failed to submit form input: ${d.status}`}}throw new Error(u.message||`Failed to submit form input: ${d.status}`)}const E=d.headers.get("content-type");return E&&E.indexOf("application/json")!==-1?await d.json():{success:!0}}static async getAllPrompts(){try{const n=await fetch(this.BASE_URL);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get Prompt list:",n),n}}static async handleResponse(n){if(!n.ok)try{const s=await n.json();throw new Error(s.message||`API request failed: ${n.status}`)}catch{throw new Error(`API request failed: ${n.status} ${n.statusText}`)}return n}}he(Fe,"BASE_URL","/api/executor");const Pe=class Pe{constructor(){he(this,"POLL_INTERVAL",5e3);he(this,"state",at({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));he(this,"callbacks",{});he(this,"planExecutionCache",new Map);he(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(n){return this.planExecutionCache.get(n)}getCachedUIState(n){return this.uiStateCache.get(n)}setCachedUIState(n,s){this.uiStateCache.set(n,s),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${n}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(n){return this.planExecutionCache.has(n)}setCachedPlanRecord(n,s){this.planExecutionCache.set(n,s),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${n}`)}clearCachedPlanRecord(n){const s=this.planExecutionCache.delete(n);return s&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${n}`),s}clearAllCachedRecords(){const n=this.planExecutionCache.size,s=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${n}, UI States: ${s}`)}static getInstance(){return Pe.instance||(Pe.instance=new Pe),Pe.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(n){this.callbacks={...this.callbacks,...n},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(n))}async handleUserMessageSendRequested(n){if(this.validateAndPrepareUIForNewRequest(n))try{if(await this.sendUserMessageAndSetPlanId(n),this.state.activePlanId)this.initiatePlanExecutionSequence(n,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(s){console.error("[PlanExecutionManager] Failed to send user message:",s);const d=this.state.activePlanId??"error";this.setCachedUIState(d,{enabled:!0}),this.emitChatInputUpdateState(d),this.state.activePlanId=null}}handlePlanExecutionRequested(n,s){console.log("[PlanExecutionManager] Received plan execution request:",{planId:n,query:s}),n?(this.state.activePlanId=n,this.initiatePlanExecutionSequence(s??"Execute Plan",n)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(n,s){const d=this.getCachedPlanRecord(n);return d!=null&&d.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${n}`),this.handlePlanExecutionRequested(d.currentPlanId,s),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${n}`),!1)}validateAndPrepareUIForNewRequest(n){if(!n)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const s=this.state.activePlanId??"ui-state";return this.setCachedUIState(s,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(s),!0}async sendUserMessageAndSetPlanId(n){try{const s=await qe.sendMessage(n);if(s!=null&&s.planId)return this.state.activePlanId=s.planId,s;if(s!=null&&s.planTemplateId)return this.state.activePlanId=s.planTemplateId,{...s,planId:s.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",s),new Error("Failed to get valid planId from API response")}catch(s){throw console.error("[PlanExecutionManager] API call failed:",s),s}}initiatePlanExecutionSequence(n,s){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${n}", planId: ${s}`);const d=s;this.emitDialogRoundStart(d),this.startPolling()}handlePlanCompletion(n){this.emitPlanCompleted(n.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await Ae.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(s){console.log(`Delete plan execution record failed: ${s.message}`)}},5e3)}catch(s){console.log(`Delete plan execution record failed: ${s.message}`)}n.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(n.rootPlanId??""))}handlePlanError(n){this.emitPlanError(n.message??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await Ae.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(s){console.log(`Delete plan execution record failed: ${s.message}`)}},5e3)}catch(s){console.log(`Delete plan execution record failed: ${s.message}`)}}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const n=await this.getPlanDetails(this.state.activePlanId);if(!n){console.warn("[PlanExecutionManager] No details received from API");return}if(n.status&&n.status==="failed"){this.handlePlanError(n);return}if(n.rootPlanId&&this.setCachedPlanRecord(n.rootPlanId,n),!n.steps||n.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(n.rootPlanId??""),this.handlePlanCompletion(n);return}this.emitPlanUpdate(n.rootPlanId??""),n.completed&&this.handlePlanCompletion(n)}catch(n){console.error("[PlanExecutionManager] Failed to poll plan status:",n)}finally{this.state.isPolling=!1}}}async getPlanDetails(n){try{const s=await Fe.getDetails(n);return s!=null&&s.rootPlanId&&(this.planExecutionCache.set(s.rootPlanId,s),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${s.rootPlanId}`)),s}catch(s){return console.error("[PlanExecutionManager] Failed to get plan details:",s),{currentPlanId:n,status:"failed",message:s instanceof Error?s.message:"Failed to get plan"}}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(n){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(n)}emitDialogRoundStart(n){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(n)}emitPlanUpdate(n){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(n)}emitPlanCompleted(n){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(n)}emitPlanError(n){this.callbacks.onPlanError&&this.callbacks.onPlanError(n)}};he(Pe,"instance",null);let Le=Pe;const oe=Le.getInstance(),bn={class:"right-panel"},kn={class:"preview-header"},_n={class:"preview-tabs"},$n={class:"tab-button active"},Pn={class:"preview-content"},Cn={class:"step-details"},Sn={key:0,class:"step-info-fixed"},yn={key:0,class:"agent-info"},En={class:"info-item"},wn={class:"label"},Tn={class:"value"},In={class:"info-item"},Dn={class:"label"},xn={class:"value"},Rn={class:"info-item"},An={class:"label"},Mn={class:"value"},Nn={class:"info-item"},Un={class:"label"},Ln={class:"value"},qn={class:"info-item"},Fn={class:"label"},Vn={class:"execution-status"},On={class:"status-item"},Bn={class:"status-text"},Wn={key:0},jn={key:0,class:"think-act-steps"},Hn={class:"steps-container"},zn={class:"step-header"},Jn={class:"step-number"},Gn={class:"think-section"},Xn={class:"think-content"},Kn={class:"input"},Qn={class:"label"},Yn={class:"output"},Zn={class:"label"},es={key:0,class:"action-section"},ts={class:"action-content"},ns={class:"tool-info"},ss={class:"label"},os={class:"value"},as={class:"input"},ls={class:"label"},is={class:"output"},cs={class:"label"},rs={key:0,class:"sub-plan-section"},us={class:"sub-plan-content"},ds={class:"sub-plan-header"},ps={class:"sub-plan-info"},hs={class:"label"},gs={class:"value"},ms={key:0,class:"sub-plan-info"},vs={class:"label"},fs={class:"value"},bs={class:"sub-plan-status"},ks={class:"status-text"},_s={key:0,class:"no-steps-message"},$s={key:1,class:"no-execution-message"},Ps={class:"step-basic-info"},Cs={class:"info-item"},Ss={class:"label"},ys={class:"value"},Es={key:0,class:"info-item"},ws={class:"label"},Ts={class:"value"},Is={class:"info-item"},Ds={class:"label"},xs={class:"no-execution-hint"},Rs={key:2,class:"execution-indicator"},As={class:"execution-text"},Ms={key:1,class:"no-selection"},Ns=["title"],Us=Ce({__name:"index",setup(T,{expose:n}){const{t:s}=Ie(),d=D(),E=D(),u=D(),$=D(null),x=D(!1),O=D(!0),P=D(!0),B=_e(()=>u.value?u.value.completed?s("rightPanel.status.completed"):u.value.current?s("rightPanel.status.executing"):s("rightPanel.status.waiting"):""),X=v=>{var L;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${v}`),u.value&&$.value){const R=$.value.rootPlanId??E.value;if(R&&R!==v){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${R}, Requested: ${v}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${v}`);const w=oe.getCachedPlanRecord(v);if(!w){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${v}`);return}if(w.steps&&w.steps.length>0){const R=w.steps.length,y=(w.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${y} / ${R}`)}if(u.value&&E.value&&(E.value===v||((L=$.value)==null?void 0:L.rootPlanId)===v)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${v}`),$.value)){const y=$.value,A=o(y.planId,y.rootPlanId,y.subPlanId);A?(g(A,y.stepIndex,y.planId,y.isSubPlan),V()):console.warn("[RightPanel] Could not find plan record for refresh:",y)}},G=(v,w,L,R,y)=>{console.log("[RightPanel] Step selected:",{planId:v,stepIndex:w,rootPlanId:L,subPlanId:R,subStepIndex:y});const A=!!(L&&R&&y!==void 0);$.value={planId:v,stepIndex:w,isSubPlan:A,...A&&{rootPlanId:L,subPlanId:R,subStepIndex:y}};const ee=o(v,L,R);if(!ee){console.warn("[RightPanel] Plan data not found:",{planId:v,rootPlanId:L,subPlanId:R}),u.value=null,$.value=null;return}g(ee,w,v,A)},o=(v,w,L)=>{var A;if(!w||!L)return oe.getCachedPlanRecord(v)??null;const R=oe.getCachedPlanRecord(v);if(R)return R;const y=oe.getCachedPlanRecord(w);if(!(y!=null&&y.agentExecutionSequence))return null;for(const ee of y.agentExecutionSequence)if(ee.thinkActSteps){for(const se of ee.thinkActSteps)if(((A=se.subPlanExecutionRecord)==null?void 0:A.currentPlanId)===L)return se.subPlanExecutionRecord}return null},g=(v,w,L,R)=>{var ke,re,b,c,_;if(!v.steps||w>=v.steps.length){u.value=null,$.value=null,console.warn("[RightPanel] Invalid step data:",{planId:L,stepIndex:w,hasSteps:!!v.steps,stepsLength:(ke=v.steps)==null?void 0:ke.length,message:"Invalid step index"});return}E.value=L;const y=v.steps[w],A=(re=v.agentExecutionSequence)==null?void 0:re[w];console.log("[RightPanel] Step data details:",{planId:L,stepIndex:w,step:y,hasAgentExecutionSequence:!!v.agentExecutionSequence,agentExecutionSequenceLength:(b=v.agentExecutionSequence)==null?void 0:b.length,agentExecution:A,hasThinkActSteps:!!(A!=null&&A.thinkActSteps),thinkActStepsLength:(c=A==null?void 0:A.thinkActSteps)==null?void 0:c.length,isSubPlan:R});const ee=(A==null?void 0:A.status)==="FINISHED",se=!ee&&w===v.currentStepIndex&&!v.completed,me={planId:L,index:w,title:typeof y=="string"?y:y.title||y.description||y.name||`${R?"Sub ":""}Step ${w+1}`,description:typeof y=="string"?y:y.description||y,completed:ee,current:se};A&&(me.agentExecution=A),u.value=me,console.log("[RightPanel] Step details updated:",{planId:L,stepIndex:w,stepTitle:u.value.title,hasAgentExecution:!!A,hasThinkActSteps:(((_=A==null?void 0:A.thinkActSteps)==null?void 0:_.length)??0)>0,completed:ee,current:se,planCurrentStep:v.currentStepIndex,planCompleted:v.completed,isSubPlan:R}),A!=null&&A.thinkActSteps&&A.thinkActSteps.forEach((I,t)=>{I.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${t}:`,I.subPlanExecutionRecord)}),setTimeout(()=>{U()},100),V()},S=(v,w,L,R)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:v,subPlanId:w,stepIndex:L,subStepIndex:R}),G(w,R,v,w,R)},K=v=>{d.value=v??void 0},U=()=>{if(!d.value)return;const{scrollTop:v,scrollHeight:w,clientHeight:L}=d.value,R=w-v-L<50,y=w>L;O.value=R,x.value=y&&!R,R?P.value=!0:w-v-L>100&&(P.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:v,scrollHeight:w,clientHeight:L,isAtBottom:R,hasScrollableContent:y,showButton:x.value,shouldAutoScroll:P.value})},q=()=>{d.value&&(d.value.scrollTo({top:d.value.scrollHeight,behavior:"smooth"}),ne(()=>{P.value=!0,U()}))},V=()=>{!P.value||!d.value||ne(()=>{d.value&&(d.value.scrollTop=d.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},Q=v=>{if(v===null||typeof v>"u"||v==="")return"N/A";try{const w=typeof v=="object"?v:JSON.parse(v);return JSON.stringify(w,null,2)}catch{return String(v)}},ce=()=>{u.value=null,E.value=void 0,P.value=!0,d.value&&d.value.removeEventListener("scroll",U)},be=()=>{const v=()=>{const w=d.value;return w?(K(w),w.addEventListener("scroll",U),P.value=!0,U(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};ne(()=>{v()||setTimeout(()=>{v()},100)})};return Se(()=>{console.log("[RightPanel] Component mounted"),ne(()=>{be()})}),De(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),$.value=null,ce()}),n({updateDisplayedPlanProgress:X,handleStepSelected:G,handleSubPlanStepSelected:S}),(v,w)=>{var L,R;return h(),m("div",bn,[e("div",kn,[e("div",_n,[e("button",$n,[k(i(C),{icon:"carbon:events"}),Y(" "+l(i(s)("rightPanel.stepExecutionDetails")),1)])])]),e("div",Pn,[e("div",Cn,[u.value?(h(),m("div",Sn,[e("h3",null,l(u.value.title||u.value.description||i(s)("rightPanel.defaultStepTitle",{number:u.value.index+1})),1),u.value.agentExecution?(h(),m("div",yn,[e("div",En,[e("span",wn,l(i(s)("rightPanel.executingAgent"))+":",1),e("span",Tn,l(u.value.agentExecution.agentName),1)]),e("div",In,[e("span",Dn,l(i(s)("rightPanel.description"))+":",1),e("span",xn,l(u.value.agentExecution.agentDescription||""),1)]),e("div",Rn,[e("span",An,l(i(s)("rightPanel.callingModel"))+":",1),e("span",Mn,l(u.value.agentExecution.modelName),1)]),e("div",Nn,[e("span",Un,l(i(s)("rightPanel.request"))+":",1),e("span",Ln,l(u.value.agentExecution.agentRequest||""),1)]),e("div",qn,[e("span",Fn,l(i(s)("rightPanel.executionResult"))+":",1),e("span",{class:te(["value",{success:u.value.agentExecution.status==="FINISHED"}])},l(u.value.agentExecution.status||i(s)("rightPanel.executing")),3)])])):F("",!0),e("div",Vn,[e("div",On,[u.value.completed?(h(),ue(i(C),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):u.value.current?(h(),ue(i(C),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(h(),ue(i(C),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",Bn,l(B.value),1)])])])):F("",!0),e("div",{ref_key:"scrollContainer",ref:d,class:"step-details-scroll-container",onScroll:U},[u.value?(h(),m("div",Wn,[(L=u.value.agentExecution)!=null&&L.thinkActSteps&&u.value.agentExecution.thinkActSteps.length>0?(h(),m("div",jn,[e("h4",null,l(i(s)("rightPanel.thinkAndActionSteps")),1),e("div",Hn,[(h(!0),m(ge,null,ve(u.value.agentExecution.thinkActSteps,(y,A)=>(h(),m("div",{key:A,class:"think-act-step"},[e("div",zn,[e("span",Jn,"#"+l(A+1),1),e("span",{class:te(["step-status",y.status])},l(y.status||i(s)("rightPanel.executing")),3)]),e("div",Gn,[e("h5",null,[k(i(C),{icon:"carbon:thinking"}),Y(" "+l(i(s)("rightPanel.thinking")),1)]),e("div",Xn,[e("div",Kn,[e("span",Qn,l(i(s)("rightPanel.input"))+":",1),e("pre",null,l(Q(y.thinkInput)),1)]),e("div",Yn,[e("span",Zn,l(i(s)("rightPanel.output"))+":",1),e("pre",null,l(Q(y.thinkOutput)),1)])])]),y.actionNeeded?(h(),m("div",es,[e("h5",null,[k(i(C),{icon:"carbon:play"}),Y(" "+l(i(s)("rightPanel.action")),1)]),e("div",ts,[(h(!0),m(ge,null,ve(y.actToolInfoList,(ee,se)=>(h(),m("div",{key:se},[e("div",ns,[e("span",ss,l(i(s)("rightPanel.tool"))+":",1),e("span",os,l(ee.name||""),1)]),e("div",as,[e("span",ls,l(i(s)("rightPanel.toolParameters"))+":",1),e("pre",null,l(Q(ee.parameters)),1)]),e("div",is,[e("span",cs,l(i(s)("rightPanel.executionResult"))+":",1),e("pre",null,l(Q(ee.result)),1)])]))),128))]),y.subPlanExecutionRecord?(h(),m("div",rs,[e("h5",null,[k(i(C),{icon:"carbon:tree-view"}),Y(" "+l(i(s)("rightPanel.subPlan")),1)]),e("div",us,[e("div",ds,[e("div",ps,[e("span",hs,l(v.$t("rightPanel.subPlanId"))+":",1),e("span",gs,l(y.subPlanExecutionRecord.currentPlanId),1)]),y.subPlanExecutionRecord.title?(h(),m("div",ms,[e("span",vs,l(v.$t("rightPanel.title"))+":",1),e("span",fs,l(y.subPlanExecutionRecord.title),1)])):F("",!0),e("div",bs,[y.subPlanExecutionRecord.completed?(h(),ue(i(C),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(h(),ue(i(C),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",ks,l(y.subPlanExecutionRecord.completed?v.$t("rightPanel.status.completed"):v.$t("rightPanel.status.executing")),1)])])])])):F("",!0)])):F("",!0)]))),128))]),u.value.agentExecution&&!((R=u.value.agentExecution.thinkActSteps)!=null&&R.length)?(h(),m("div",_s,[e("p",null,l(i(s)("rightPanel.noStepDetails")),1)])):u.value.agentExecution?F("",!0):(h(),m("div",$s,[k(i(C),{icon:"carbon:information",class:"info-icon"}),e("h4",null,l(i(s)("rightPanel.stepInfo")),1),e("div",Ps,[e("div",Cs,[e("span",Ss,l(i(s)("rightPanel.stepName"))+":",1),e("span",ys,l(u.value.title||u.value.description||v.$t("rightPanel.stepNumber",{number:u.value.index+1})),1)]),u.value.description?(h(),m("div",Es,[e("span",ws,l(v.$t("rightPanel.description"))+":",1),e("span",Ts,l(u.value.description),1)])):F("",!0),e("div",Is,[e("span",Ds,l(v.$t("rightPanel.status.label"))+":",1),e("span",{class:te(["value",{"status-completed":u.value.completed,"status-current":u.value.current,"status-pending":!u.value.completed&&!u.value.current}])},l(u.value.completed?v.$t("rightPanel.status.completed"):u.value.current?v.$t("rightPanel.status.executing"):v.$t("rightPanel.status.pending")),3)])]),e("p",xs,l(i(s)("rightPanel.noExecutionInfo")),1)])),u.value.current&&!u.value.completed?(h(),m("div",Rs,[w[0]||(w[0]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",As,[k(i(C),{icon:"carbon:in-progress",class:"rotating-icon"}),Y(" "+l(i(s)("rightPanel.stepExecuting")),1)])])):F("",!0)])):(h(),m("div",Ms,[k(i(C),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,l(i(s)("rightPanel.noStepSelected")),1),e("p",null,l(i(s)("rightPanel.selectStepHint")),1)]))])):F("",!0),k(xe,{name:"scroll-button"},{default:Re(()=>[x.value?(h(),m("button",{key:0,onClick:q,class:"scroll-to-bottom-btn",title:i(s)("rightPanel.scrollToBottom")},[k(i(C),{icon:"carbon:chevron-down"})],8,Ns)):F("",!0)]),_:1})],544)])])])}}}),Ls=ye(Us,[["__scopeId","data-v-3c3758b3"]]);function qs(){const T=oe,n=_e(()=>T.getActivePlanId()),s=_e(()=>T.getState()),d=_e(()=>s.value.isPolling),E=_e(()=>!!n.value),u=(P,B)=>{T.initiatePlanExecutionSequence(P,B)},$=()=>{T.stopPolling()},x=()=>{T.startPolling()},O=()=>{T.cleanup()};return De(()=>{O()}),{activePlanId:n,state:s,isPolling:d,hasActivePlan:E,startExecution:u,stopPolling:$,startPolling:x,cleanup:O}}const Fs={class:"chat-container"},Vs={class:"message-content"},Os={key:0,class:"user-message"},Bs={key:1,class:"assistant-message"},Ws={key:0,class:"thinking-section"},js={class:"thinking-header"},Hs={class:"thinking-avatar"},zs={class:"thinking-label"},Js={class:"thinking-content"},Gs={key:0,class:"thinking"},Xs={key:1,class:"progress"},Ks={class:"progress-bar"},Qs={class:"progress-text"},Ys={key:2,class:"steps-container"},Zs={class:"steps-title"},eo=["onClick"],to={class:"section-header"},no={class:"step-icon"},so={class:"step-title"},oo={key:0,class:"step-status current"},ao={key:1,class:"step-status completed"},lo={key:2,class:"step-status pending"},io={key:0,class:"action-info"},co={class:"action-description"},ro={class:"action-icon"},uo={key:0,class:"tool-params"},po={class:"param-label"},ho={class:"param-content"},go={key:1,class:"think-details"},mo={class:"think-header"},vo={class:"think-label"},fo={class:"think-output"},bo={class:"think-content"},ko={key:1,class:"sub-plan-steps"},_o={class:"sub-plan-header"},$o={class:"sub-plan-title"},Po={class:"sub-plan-step-list"},Co=["onClick"],So={class:"sub-step-indicator"},yo={class:"sub-step-icon"},Eo={class:"sub-step-number"},wo={class:"sub-step-content"},To={class:"sub-step-title"},Io={class:"sub-step-badge"},Do={key:2,class:"user-input-form-container"},xo={class:"user-input-message"},Ro={key:0,class:"form-description"},Ao=["onSubmit"],Mo=["for"],No=["id","name","onUpdate:modelValue"],Uo={key:1,class:"form-group"},Lo={for:"form-input-genericInput"},qo=["onUpdate:modelValue"],Fo={type:"submit",class:"submit-user-input-btn"},Vo={key:3,class:"default-processing"},Oo={class:"processing-indicator"},Bo={class:"response-section"},Wo={class:"response-header"},jo={class:"response-avatar"},Ho={class:"response-name"},zo={class:"response-content"},Jo={key:0,class:"final-response"},Go=["innerHTML"],Xo={key:1,class:"response-placeholder"},Ko={class:"typing-indicator"},Qo={class:"typing-text"},Yo={key:0,class:"message assistant"},Zo={class:"message-content"},ea={class:"assistant-message"},ta={class:"thinking-section"},na={class:"thinking-header"},sa={class:"thinking-avatar"},oa={class:"thinking-label"},aa={class:"thinking-content"},la={class:"default-processing"},ia={class:"processing-indicator"},ca={class:"response-section"},ra={class:"response-header"},ua={class:"response-avatar"},da={class:"response-name"},pa={class:"response-content"},ha={class:"response-placeholder"},ga={class:"typing-indicator"},ma={class:"typing-text"},va=["title"],fa=Ce({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(T,{expose:n,emit:s}){const d=T,E=s,{t:u}=Ie(),$=qs(),x=D(),O=D(!1),P=D([]),B=D(),X=D(!1),G=at({}),o=(t,a,r)=>{const p={id:Date.now().toString(),type:t,content:a,timestamp:new Date,...r};return t==="assistant"&&!p.thinking&&!p.content&&(p.thinking=u("chat.thinking")),P.value.push(p),p},g=t=>{const a=P.value[P.value.length-1];a.type==="assistant"&&Object.assign(a,t)},S=async t=>{try{O.value=!0;const a=o("assistant","",{thinking:u("chat.thinkingProcessing")}),r=await qe.sendMessage(t);if(r.planId)console.log("[ChatComponent] Received planId from direct execution:",r.planId),a.planExecution||(a.planExecution={}),a.planExecution.currentPlanId=r.planId,oe.handlePlanExecutionRequested(r.planId,t),delete a.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete a.thinking;const p=K(r,t);a.content=p}}catch(a){console.error("Direct mode error:",a),g({content:U(a)})}finally{O.value=!1}},K=(t,a)=>t.result??t.message??t.content??"",U=t=>{const a=(t==null?void 0:t.message)??(t==null?void 0:t.toString())??u("chat.unknownError");return a.includes("network")||a.includes("timeout")?u("chat.networkError"):a.includes("auth")||a.includes("unauthorized")?u("chat.authError"):a.includes("invalid")||a.includes("format")||a.includes("parameter")?u("chat.formatError"):`${u("chat.unknownError")} (${a})`},q=(t=!1)=>{ne(()=>{if(x.value){const a=x.value;(t||a.scrollHeight-a.scrollTop-a.clientHeight<150)&&a.scrollTo({top:a.scrollHeight,behavior:t?"auto":"smooth"})}})},V=()=>{q(!0),X.value=!1},Q=()=>{if(x.value){const t=x.value,a=t.scrollHeight-t.scrollTop-t.clientHeight<150;X.value=!a&&P.value.length>0}},ce=()=>{x.value&&x.value.addEventListener("scroll",Q)},be=()=>{x.value&&x.value.removeEventListener("scroll",Q)},v=t=>{o("user",t),d.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",t):S(t)},w=(t,a)=>{var W;const r=((W=t.planExecution)==null?void 0:W.agentExecutionSequence)??[];return a<0||a>=r.length?"IDLE":r[a].status??"IDLE"},L=(t,a)=>{var r,p;if(!((r=t.planExecution)!=null&&r.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:t.planExecution.currentPlanId,stepIndex:a,stepTitle:(p=t.planExecution.steps)==null?void 0:p[a]}),E("step-selected",t.planExecution.currentPlanId,a)},R=(t,a)=>{var r;try{const p=(r=t.planExecution)==null?void 0:r.agentExecutionSequence;if(!(p!=null&&p.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const W=p[a];if(!W)return console.log(`[ChatComponent] No agentExecution found for step ${a}`),[];if(!W.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${a}`),[];for(const N of W.thinkActSteps)if(N.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${a}:`,N.subPlanExecutionRecord),(N.subPlanExecutionRecord.steps??[]).map(j=>typeof j=="string"?j:typeof j=="object"&&j!==null&&(j.title||j.description)||u("rightPanel.subStep"));return[]}catch(p){return console.warn("[ChatComponent] Error getting sub-plan steps:",p),[]}},y=(t,a,r)=>{var p;try{const W=(p=t.planExecution)==null?void 0:p.agentExecutionSequence;if(!(W!=null&&W.length))return"pending";const N=W[a];if(!N||!N.thinkActSteps)return"pending";let Z=null;for(const H of N.thinkActSteps)if(H.subPlanExecutionRecord){Z=H.subPlanExecutionRecord;break}if(!Z)return"pending";const j=Z.currentStepIndex;return Z.completed?"completed":j==null?r===0?"current":"pending":r<j?"completed":r===j?"current":"pending"}catch(W){return console.warn("[ChatComponent] Error getting sub-plan step status:",W),"pending"}},A=(t,a,r)=>{var p,W;try{const N=(p=t.planExecution)==null?void 0:p.agentExecutionSequence;if(!(N!=null&&N.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const Z=N[a];if(!Z){console.warn("[ChatComponent] No agentExecution found for step",a);return}if(!Z.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",a);return}let j=null;for(const H of Z.thinkActSteps)if(H.subPlanExecutionRecord){j=H.subPlanExecutionRecord;break}if(!(j!=null&&j.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}E("sub-plan-step-selected",((W=t.planExecution)==null?void 0:W.currentPlanId)??"",j.currentPlanId,a,r)}catch(N){console.error("[ChatComponent] Error handling sub-plan step click:",N)}},ee=(t,a)=>{var p,W,N,Z;if(!((p=t.planExecution)!=null&&p.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",t.planExecution.steps.length,"execution sequence:",((W=a.agentExecutionSequence)==null?void 0:W.length)??0);const r=new Array(t.planExecution.steps.length).fill(null);if((N=a.agentExecutionSequence)!=null&&N.length){const j=Math.min(a.agentExecutionSequence.length,t.planExecution.steps.length);for(let H=0;H<j;H++){const M=a.agentExecutionSequence[H];if((Z=M.thinkActSteps)!=null&&Z.length){const z=M.thinkActSteps[M.thinkActSteps.length-1];z.actionDescription&&z.toolParameters?(r[H]={actionDescription:z.actionDescription,toolParameters:typeof z.toolParameters=="string"?z.toolParameters:JSON.stringify(z.toolParameters,null,2),thinkInput:z.thinkInput??"",thinkOutput:z.thinkOutput??"",status:a.currentStepIndex!==void 0&&H<a.currentStepIndex?"completed":a.currentStepIndex!==void 0&&H===a.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${H} action set: ${r[H].actionDescription}`)):(r[H]={actionDescription:u("chat.thinking"),toolParameters:u("chat.waitingDecision"),thinkInput:z.thinkInput??"",thinkOutput:z.thinkOutput??"",status:a.currentStepIndex!==void 0&&H===a.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${H} is thinking`))}else r[H]={actionDescription:a.currentStepIndex!==void 0&&H<a.currentStepIndex?u("chat.status.completed"):u("chat.status.pending"),toolParameters:u("chat.noToolParameters"),thinkInput:"",thinkOutput:"",status:a.currentStepIndex!==void 0&&H<a.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] Step ${H} has no execution details, status set to: ${r[H].status}`)}}else console.log("[ChatComponent] No execution sequence data");t.stepActions=[...r],console.log("[ChatComponent] Step actions update completed:",JSON.stringify(r.map(j=>j==null?void 0:j.actionDescription))),ne(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},se=t=>{console.log("[ChatComponent] Starting dialog round with planId:",t),t&&(P.value.findIndex(r=>{var p;return((p=r.planExecution)==null?void 0:p.currentPlanId)===t&&r.type==="assistant"})===-1?(o("assistant","",{planExecution:{currentPlanId:t},thinking:u("chat.preparingExecution")}),console.log("[ChatComponent] Created new assistant message for planId:",t)):console.log("[ChatComponent] Found existing assistant message for planId:",t))},me=t=>{var N,Z,j,H;console.log("[ChatComponent] Processing plan update with rootPlanId:",t);const a=oe.getCachedPlanRecord(t);if(!a){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",t);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",a),console.log("[ChatComponent] Plan steps:",a.steps),console.log("[ChatComponent] Plan completed:",a.completed),!a.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const r=P.value.findIndex(M=>{var z;return((z=M.planExecution)==null?void 0:z.currentPlanId)===a.currentPlanId&&M.type==="assistant"});let p;if(r!==-1)p=P.value[r],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",a.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",a.currentPlanId),console.log("[ChatComponent] Current messages:",P.value.map(z=>{var ae;return{type:z.type,planId:(ae=z.planExecution)==null?void 0:ae.currentPlanId,content:z.content.substring(0,50)}}));let M=-1;for(let z=P.value.length-1;z>=0;z--)if(P.value[z].type==="assistant"){M=z;break}if(M!==-1)p=P.value[M],p.planExecution||(p.planExecution={}),p.planExecution.currentPlanId=a.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",a.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(p.planExecution||(p.planExecution={}),p.planExecution=JSON.parse(JSON.stringify(a)),!a.steps||a.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),a.completed){delete p.thinking;const M=a.summary??a.result??a.message??u("chat.executionCompleted");p.content=ke(M),console.log("[ChatComponent] Set simple response content:",p.content)}else a.title&&(p.thinking=`${u("chat.thinkingExecuting",{title:a.title})}`);return}delete p.thinking;const W=a.steps.map(M=>typeof M=="string"?M:typeof M=="object"&&M!==null&&(M.title||M.description)||u("chat.step"));if(p.planExecution&&(p.planExecution.steps=W),a.agentExecutionSequence&&a.agentExecutionSequence.length>0){console.log("[ChatComponent] Found execution sequence data, count:",a.agentExecutionSequence.length),ee(p,a);const M=a.currentStepIndex??0;if(M>=0&&M<a.agentExecutionSequence.length){const ae=a.agentExecutionSequence[M].thinkActSteps;if(ae&&ae.length>0){const Ee=ae[ae.length-1];if(Ee.thinkOutput){const Me=Ee.thinkOutput.length>150?Ee.thinkOutput.substring(0,150)+"...":Ee.thinkOutput;p.thinking=`${u("chat.thinking")}: ${Me}`}}}}else if(p.planExecution){const M=p.planExecution.currentStepIndex??0,z=(N=p.planExecution.steps)==null?void 0:N[M],ae=typeof z=="string"?z:"";p.thinking=`${u("chat.thinkingExecuting",{title:ae})}`}if(a.userInputWaitState&&p.planExecution?(console.log("[ChatComponent] User input required:",a.userInputWaitState),p.planExecution.userInputWaitState||(p.planExecution.userInputWaitState={}),p.planExecution.userInputWaitState={message:a.userInputWaitState.message??"",formDescription:a.userInputWaitState.formDescription??"",formInputs:((Z=a.userInputWaitState.formInputs)==null?void 0:Z.map(M=>({label:M.label,value:M.value||""})))??[]},G[j=p.id]??(G[j]={}),p.thinking=u("input.waiting")):(H=p.planExecution)!=null&&H.userInputWaitState&&delete p.planExecution.userInputWaitState,a.completed??a.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete p.thinking;let M="";a.summary?M=a.summary:a.result?M=a.result:M=u("chat.executionCompleted"),p.content=re(M),console.log("[ChatComponent] Updated completed message:",p.content)}ne(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},ke=t=>t?t.includes("I ")||t.includes("you")||t.includes("hello")||t.includes("can")||t.includes("I")||t.includes("you")||t.includes("can")?t:t.length<10?`${t}! ${u("chat.anythingElse")}`:t.length<50?`${u("chat.okayDone",{text:t})}. ${u("chat.ifOtherQuestions")}`:`${t}

${u("chat.hopeHelpful")} ${u("chat.anythingElse")}`:u("chat.defaultResponse"),re=t=>t?`${t}`:`${u("chat.executionCompleted")}! ${u("chat.anythingElse")}`,b=t=>{console.log("[ChatComponent] Plan completed with rootPlanId:",t);const a=oe.getCachedPlanRecord(t);if(!a){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",t);return}if(console.log("[ChatComponent] Plan details:",a),a.rootPlanId){const r=P.value.findIndex(p=>{var W;return((W=p.planExecution)==null?void 0:W.currentPlanId)===a.rootPlanId});if(r!==-1){const p=P.value[r];delete p.thinking;let N=a.summary??a.result??u("chat.executionCompleted");!N.includes("I")&&!N.includes("you")&&(N.includes("success")||N.includes("complete")||N.includes("finished")?N=`${u("chat.great")}${N}. ${u("chat.ifOtherHelp")}`:N=`${u("chat.completedRequest",{result:N})}`),p.content=N,console.log("[ChatComponent] Updated completed message:",p.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",a.rootPlanId)}},c=t=>{O.value=!1,P.value[P.value.length-1]={id:Date.now().toString(),type:"assistant",content:t,timestamp:new Date}},_=t=>{if(!t)return"";let a=t.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return a=a.replace(/(<br><br>)/g,"</p><p>"),a.includes("</p><p>")&&(a=`<p>${a}</p>`),a},I=async t=>{var a;if(!((a=t.planExecution)!=null&&a.currentPlanId)||!t.planExecution.userInputWaitState){console.error("[ChatComponent] Missing planExecution.currentPlanId or userInputWaitState");return}try{const r={},p=t.planExecution.userInputWaitState.formInputs;p&&p.length>0?Object.entries(G[t.id]).forEach(([N,Z])=>{var M;const j=parseInt(N,10),H=((M=p[j])==null?void 0:M.label)||`input_${N}`;r[H]=Z}):r.genericInput=t.genericInput??"",console.log("[ChatComponent] Submitting user input:",r);const W=await Fe.submitFormInput(t.planExecution.currentPlanId,r);delete t.planExecution.userInputWaitState,delete t.genericInput,delete G[t.id],$.startPolling(),console.log("[ChatComponent] User input submitted successfully:",W)}catch(r){console.error("[ChatComponent] User input submission failed:",r),alert(`${u("common.submitFailed")}: ${(r==null?void 0:r.message)||u("common.unknownError")}`)}};return $e(()=>d.initialPrompt,(t,a)=>{console.log("[ChatComponent] initialPrompt changed from:",a,"to:",t),t&&typeof t=="string"&&t.trim()&&t!==a&&(console.log("[ChatComponent] Processing changed initial prompt:",t),ne(()=>{v(t)}))},{immediate:!1}),Se(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),oe.setEventCallbacks({onPlanUpdate:me,onPlanCompleted:b,onDialogRoundStart:se,onChatInputUpdateState:t=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",t)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")},onPlanError:c}),ne(()=>{ce()}),d.initialPrompt&&typeof d.initialPrompt=="string"&&d.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",d.initialPrompt),ne(()=>{v(d.initialPrompt)}))}),De(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),be(),B.value&&clearInterval(B.value),$.cleanup(),Object.keys(G).forEach(t=>delete G[t])}),n({handleSendMessage:v,handlePlanUpdate:me,handlePlanCompleted:b,handleDialogRoundStart:se,addMessage:o,handlePlanError:c}),(t,a)=>(h(),m("div",Fs,[e("div",{class:"messages",ref_key:"messagesRef",ref:x},[(h(!0),m(ge,null,ve(P.value,r=>{var p,W,N,Z,j,H,M,z,ae;return h(),m("div",{key:r.id,class:te(["message",{user:r.type==="user",assistant:r.type==="assistant"}])},[e("div",Vs,[r.type==="user"?(h(),m("div",Os,l(r.content),1)):(h(),m("div",Bs,[r.thinking||((p=r.planExecution)==null?void 0:p.progress)!==void 0||(((N=(W=r.planExecution)==null?void 0:W.steps)==null?void 0:N.length)??0)>0?(h(),m("div",Ws,[e("div",js,[e("div",Hs,[k(i(C),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",zs,l(t.$t("chat.thinkingLabel")),1)]),e("div",Js,[r.thinking?(h(),m("div",Gs,[k(i(C),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,l(r.thinking),1)])):F("",!0),((Z=r.planExecution)==null?void 0:Z.progress)!==void 0?(h(),m("div",Xs,[e("div",Ks,[e("div",{class:"progress-fill",style:Ue({width:r.planExecution.progress+"%"})},null,4)]),e("span",Qs,l(r.planExecution.progressText??t.$t("chat.processing")+"..."),1)])):F("",!0),(((H=(j=r.planExecution)==null?void 0:j.steps)==null?void 0:H.length)??0)>0?(h(),m("div",Ys,[e("h4",Zs,l(t.$t("chat.stepExecutionDetails")),1),(h(!0),m(ge,null,ve((M=r.planExecution)==null?void 0:M.steps,(Ee,J)=>{var Me,Ve,Oe,Be,We,je,He,ze,Je,Ge,Xe,Ke,Qe,Ye,Ze,et,tt,nt,st;return h(),m("div",{key:J,class:te(["ai-section",{running:w(r,J)==="RUNNING",completed:w(r,J)==="FINISHED",pending:w(r,J)==="IDLE"}]),onClick:ie(pe=>L(r,J),["stop"])},[e("div",to,[e("span",no,l(w(r,J)==="FINISHED"?"✓":w(r,J)==="RUNNING"?"▶":"○"),1),e("span",so,l(Ee||`${t.$t("chat.step")} ${J+1}`),1),w(r,J)==="RUNNING"?(h(),m("span",oo,l(t.$t("chat.status.executing")),1)):w(r,J)==="FINISHED"?(h(),m("span",ao,l(t.$t("chat.status.completed")),1)):(h(),m("span",lo,l(t.$t("chat.status.pending")),1))]),r.stepActions&&r.stepActions[J]?(h(),m("div",io,[e("div",co,[e("span",ro,l(((Me=r.stepActions[J])==null?void 0:Me.status)==="current"?"🔄":((Ve=r.stepActions[J])==null?void 0:Ve.status)==="completed"?"✓":"⏳"),1),e("strong",null,l((Oe=r.stepActions[J])==null?void 0:Oe.actionDescription),1)]),(Be=r.stepActions[J])!=null&&Be.toolParameters?(h(),m("div",uo,[a[0]||(a[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",po,l(t.$t("common.parameters"))+":",1),e("pre",ho,l((We=r.stepActions[J])==null?void 0:We.toolParameters),1)])):F("",!0),(je=r.stepActions[J])!=null&&je.thinkOutput?(h(),m("div",go,[e("div",mo,[a[1]||(a[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",vo,l(t.$t("chat.thinkingOutput"))+":",1)]),e("div",fo,[e("pre",bo,l((He=r.stepActions[J])==null?void 0:He.thinkOutput),1)])])):F("",!0)])):F("",!0),((ze=R(r,J))==null?void 0:ze.length)>0?(h(),m("div",ko,[e("div",_o,[k(i(C),{icon:"carbon:tree-view",class:"sub-plan-icon"}),e("span",$o,l(t.$t("rightPanel.subPlan")),1)]),e("div",Po,[(h(!0),m(ge,null,ve(R(r,J),(pe,le)=>(h(),m("div",{key:`sub-${J}-${le}`,class:te(["sub-plan-step-item",{completed:y(r,J,le)==="completed",current:y(r,J,le)==="current",pending:y(r,J,le)==="pending"}]),onClick:ie(ot=>A(r,J,le),["stop"])},[e("div",So,[e("span",yo,l(y(r,J,le)==="completed"?"✓":y(r,J,le)==="current"?"▶":"○"),1),e("span",Eo,l(le+1),1)]),e("div",wo,[e("span",To,l(pe),1),e("span",Io,l(t.$t("rightPanel.subStep")),1)])],10,Co))),128))])])):F("",!0),(Je=r.planExecution)!=null&&Je.userInputWaitState&&w(r,J)==="RUNNING"?(h(),m("div",Do,[e("p",xo,l(((Xe=(Ge=r.planExecution)==null?void 0:Ge.userInputWaitState)==null?void 0:Xe.message)??t.$t("chat.userInput.message")),1),(Qe=(Ke=r.planExecution)==null?void 0:Ke.userInputWaitState)!=null&&Qe.formDescription?(h(),m("p",Ro,l((Ze=(Ye=r.planExecution)==null?void 0:Ye.userInputWaitState)==null?void 0:Ze.formDescription),1)):F("",!0),e("form",{onSubmit:ie(pe=>I(r),["prevent"]),class:"user-input-form"},[(tt=(et=r.planExecution)==null?void 0:et.userInputWaitState)!=null&&tt.formInputs&&r.planExecution.userInputWaitState.formInputs.length>0?(h(!0),m(ge,{key:0},ve((st=(nt=r.planExecution)==null?void 0:nt.userInputWaitState)==null?void 0:st.formInputs,(pe,le)=>(h(),m("div",{key:le,class:"form-group"},[e("label",{for:`form-input-${pe.label.replace(/\W+/g,"_")}`},l(pe.label)+": ",9,Mo),de(e("input",{type:"text",id:`form-input-${pe.label.replace(/\W+/g,"_")}`,name:pe.label,"onUpdate:modelValue":ot=>G[r.id][le]=ot,class:"form-input"},null,8,No),[[fe,G[r.id][le]]])]))),128)):(h(),m("div",Uo,[e("label",Lo,l(t.$t("common.input"))+":",1),de(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":pe=>r.genericInput=pe,class:"form-input"},null,8,qo),[[fe,r.genericInput]])])),e("button",Fo,l(t.$t("chat.userInput.submit")),1)],40,Ao)])):F("",!0)],10,eo)}),128))])):!r.content&&(r.thinking||((z=r.planExecution)==null?void 0:z.progress)!==void 0&&(((ae=r.planExecution)==null?void 0:ae.progress)??0)<100)?(h(),m("div",Vo,[e("div",Oo,[a[2]||(a[2]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,l(r.thinking??t.$t("chat.thinkingProcessing")),1)])])):F("",!0)])])):F("",!0),e("div",Bo,[e("div",Wo,[e("div",jo,[k(i(C),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Ho,l(t.$t("chat.botName")),1)]),e("div",zo,[r.content?(h(),m("div",Jo,[e("div",{class:"response-text",innerHTML:_(r.content)},null,8,Go)])):(h(),m("div",Xo,[e("div",Ko,[a[3]||(a[3]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Qo,l(t.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),O.value?(h(),m("div",Yo,[e("div",Zo,[e("div",ea,[e("div",ta,[e("div",na,[e("div",sa,[k(i(C),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",oa,l(t.$t("chat.thinkingLabel")),1)]),e("div",aa,[e("div",la,[e("div",ia,[a[4]||(a[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,l(t.$t("chat.thinking")),1)])])])]),e("div",ca,[e("div",ra,[e("div",ua,[k(i(C),{icon:"carbon:bot",class:"bot-icon"})]),e("div",da,l(t.$t("chat.botName")),1)]),e("div",pa,[e("div",ha,[e("div",ga,[a[5]||(a[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",ma,l(t.$t("chat.thinkingResponse")),1)])])])])])])])):F("",!0)],512),X.value?(h(),m("div",{key:0,class:"scroll-to-bottom-btn",onClick:V,title:t.$t("chat.scrollToBottom")},[k(i(C),{icon:"carbon:chevron-down"})],8,va)):F("",!0)]))}}),ba=ye(fa,[["__scopeId","data-v-99c33eb1"]]),ka={class:"input-area"},_a={class:"input-container"},$a=["title"],Pa=["placeholder","disabled"],Ca=["title"],Sa=["disabled","title"],ya=Ce({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1},initialValue:{default:""}},emits:["send","clear","update-state","plan-mode-clicked"],setup(T,{expose:n,emit:s}){const{t:d}=Ie(),E=T,u=s,$=D(),x=D(""),O=_e(()=>E.placeholder||d("input.placeholder")),P=D(O.value),B=_e(()=>!!E.disabled),X=()=>{ne(()=>{$.value&&($.value.style.height="auto",$.value.style.height=Math.min($.value.scrollHeight,120)+"px")})},G=V=>{V.key==="Enter"&&!V.shiftKey&&(V.preventDefault(),o())},o=()=>{if(!x.value.trim()||B.value)return;const V=x.value.trim();u("send",V),S()},g=()=>{u("plan-mode-clicked")},S=()=>{x.value="",X(),u("clear")},K=(V,Q)=>{Q&&(P.value=V?Q:d("input.waiting")),u("update-state",V,Q)},U=V=>{x.value=V,X()},q=()=>x.value.trim();return $e(()=>E.initialValue,V=>{V&&V.trim()&&(x.value=V,X())},{immediate:!0}),n({clearInput:S,updateState:K,setInputValue:U,getQuery:q,focus:()=>{var V;return(V=$.value)==null?void 0:V.focus()}}),Se(()=>{}),De(()=>{}),(V,Q)=>(h(),m("div",ka,[e("div",_a,[e("button",{class:"attach-btn",title:V.$t("input.attachFile")},[k(i(C),{icon:"carbon:attachment"})],8,$a),de(e("textarea",{"onUpdate:modelValue":Q[0]||(Q[0]=ce=>x.value=ce),ref_key:"inputRef",ref:$,class:"chat-input",placeholder:P.value,disabled:B.value,onKeydown:G,onInput:X},null,40,Pa),[[fe,x.value]]),e("button",{class:"plan-mode-btn",title:V.$t("input.planMode"),onClick:g},[k(i(C),{icon:"carbon:document"}),Y(" "+l(V.$t("input.planMode")),1)],8,Ca),e("button",{class:"send-button",disabled:!x.value.trim()||B.value,onClick:o,title:V.$t("input.send")},[k(i(C),{icon:"carbon:send-alt"}),Y(" "+l(V.$t("input.send")),1)],8,Sa)])]))}}),Ea=ye(ya,[["__scopeId","data-v-4b2cba42"]]);class we{static async getAllCronTasks(){try{const n=await fetch(this.BASE_URL);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get cron tasks:",n),n}}static async getCronTaskById(n){try{const s=await fetch(`${this.BASE_URL}/${n}`);return await(await this.handleResponse(s)).json()}catch(s){throw console.error("Failed to get cron task by id:",s),s}}static async createCronTask(n){try{const s=await fetch(this.BASE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});return await(await this.handleResponse(s)).json()}catch(s){throw console.error("Failed to create cron task:",s),s}}static async updateCronTask(n,s){try{const d=await fetch(`${this.BASE_URL}/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});return await(await this.handleResponse(d)).json()}catch(d){throw console.error("Failed to update cron task:",d),d}}static async updateTaskStatus(n,s){try{const d=await fetch(`${this.BASE_URL}/${n}/status?status=${s}`,{method:"PUT"});await this.handleResponse(d)}catch(d){throw console.error("Failed to update task status:",d),d}}static async deleteCronTask(n){try{const s=await fetch(`${this.BASE_URL}/${n}`,{method:"DELETE"});await this.handleResponse(s)}catch(s){throw console.error("Failed to delete cron task:",s),s}}static async handleResponse(n){if(!n.ok)try{const s=await n.json();throw new Error(s.message||`API request failed: ${n.status}`)}catch{throw new Error(`API request failed: ${n.status} ${n.statusText}`)}return n}}he(we,"BASE_URL","/api/cron-tasks");const Te={validateCronExpression(T){const n=T.trim().split(/\s+/);return n.length>=5&&n.length<=6},formatTime(T){return new Date(T).toLocaleString()},async saveTask(T){try{let n;return T.id?n=await we.updateCronTask(Number(T.id),T):n=await we.createCronTask(T),n}catch(n){throw console.error("Failed to save cron task:",n),n}},async deleteTask(T){try{await we.deleteCronTask(String(T))}catch(n){throw console.error("Failed to delete cron task:",n),n}},async toggleTaskStatus(T){if(!T.id)throw new Error("Task ID is required");const n=T.status===0?1:0;return await we.updateCronTask(Number(T.id),{...T,status:n})},prepareTaskExecution(T){return T.planTemplateId?{useTemplate:!0,planData:{title:T.cronName||"Scheduled Task Execution",planData:{id:T.planTemplateId,planTemplateId:T.planTemplateId,planId:T.planTemplateId},params:T.executionParams||void 0}}:{useTemplate:!1,taskContent:T.planDesc||T.cronName||""}}},wa={class:"modal-header"},Ta={class:"header-actions"},Ia={class:"status-switch"},Da={class:"status-label"},xa={class:"toggle-switch"},Ra=["checked"],Aa={class:"modal-content"},Ma={class:"form-group"},Na={class:"form-label"},Ua=["placeholder"],La={class:"form-group"},qa={class:"form-label"},Fa=["placeholder"],Va={class:"form-help"},Oa={class:"form-group"},Ba={class:"form-label"},Wa=["placeholder"],ja={class:"form-group"},Ha={class:"form-label"},za={class:"template-toggle"},Ja={key:0,class:"template-selector"},Ga={value:""},Xa=["value"],Ka={class:"form-help"},Qa={key:0,class:"form-group"},Ya={class:"time-info"},Za={class:"time-label"},el={class:"time-value"},tl={key:1,class:"form-group"},nl={class:"time-info"},sl={class:"time-label"},ol={class:"time-value"},al={class:"modal-footer"},ll=["disabled"],il=Ce({__name:"TaskDetailModal",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","save"],setup(T,{emit:n}){const s=T,d=n,E=D(!1),u=D([]),$=D({cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""});Se(async()=>{try{const o=await Ae.getAllPlanTemplates();o&&o.templates&&(u.value=o.templates.map(g=>({id:g.id,name:g.title||"Unnamed Template"})))}catch(o){console.error("Failed to get template list:",o)}});const O=o=>{o.target===o.currentTarget&&d("update:modelValue",!1)},P=()=>{$.value.linkTemplate=!1,$.value.templateId="",$.value.planTemplateId=""},B=()=>$.value.cronName.trim()?$.value.cronTime.trim()?Te.validateCronExpression($.value.cronTime)?$.value.planDesc.trim()?$.value.linkTemplate&&!$.value.templateId?(alert("Please select a plan template"),!1):!0:(alert("Task description cannot be empty"),!1):(alert("Invalid Cron expression format, should be 5-6 parts separated by spaces"),!1):(alert("Cron expression cannot be empty"),!1):(alert("Task name cannot be empty"),!1),X=o=>Te.formatTime(o),G=async()=>{var o;if(B()){E.value=!0;try{const g={...$.value,...((o=s.task)==null?void 0:o.id)!==void 0&&{id:s.task.id},cronName:$.value.cronName.trim(),cronTime:$.value.cronTime.trim(),planDesc:$.value.planDesc.trim(),status:$.value.status,planTemplateId:$.value.linkTemplate&&$.value.templateId||""};d("save",g)}finally{E.value=!1}}};return $e(()=>s.task,o=>{if(o){const g=o.templateId||o.planTemplateId||"";$.value={cronName:o.cronName||"",cronTime:o.cronTime||"",planDesc:o.planDesc||"",status:o.status??1,linkTemplate:!!g,templateId:g,planTemplateId:g}}else $.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""}},{immediate:!0}),$e(()=>s.modelValue,o=>{o||($.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""})}),(o,g)=>(h(),ue(Ne,{to:"body"},[k(xe,{name:"modal"},{default:Re(()=>{var S,K,U;return[o.modelValue?(h(),m("div",{key:0,class:"modal-overlay",onClick:O},[e("div",{class:"modal-container",onClick:g[8]||(g[8]=ie(()=>{},["stop"]))},[e("div",wa,[e("h3",null,l(o.$t("cronTask.taskDetail")),1),e("div",Ta,[e("div",Ia,[e("span",Da,l(o.$t("cronTask.taskStatus")),1),e("label",xa,[e("input",{type:"checkbox",checked:$.value.status===0,onChange:g[0]||(g[0]=q=>$.value.status=$.value.status===0?1:0)},null,40,Ra),g[9]||(g[9]=e("span",{class:"toggle-slider"},null,-1))])]),e("button",{class:"close-btn",onClick:g[1]||(g[1]=q=>o.$emit("update:modelValue",!1))},[k(i(C),{icon:"carbon:close"})])])]),e("div",Aa,[e("form",{onSubmit:ie(G,["prevent"]),class:"task-form"},[e("div",Ma,[e("label",Na,l(o.$t("cronTask.taskName")),1),de(e("input",{"onUpdate:modelValue":g[2]||(g[2]=q=>$.value.cronName=q),type:"text",class:"form-input",placeholder:o.$t("cronTask.taskNamePlaceholder"),required:""},null,8,Ua),[[fe,$.value.cronName]])]),e("div",La,[e("label",qa,l(o.$t("cronTask.cronExpression")),1),de(e("input",{"onUpdate:modelValue":g[3]||(g[3]=q=>$.value.cronTime=q),type:"text",class:"form-input",placeholder:o.$t("cronTask.cronExpressionPlaceholder"),required:""},null,8,Fa),[[fe,$.value.cronTime]]),e("div",Va,l(o.$t("cronTask.cronExpressionHelp")),1)]),e("div",Oa,[e("label",Ba,l(o.$t("cronTask.taskDescription")),1),de(e("textarea",{"onUpdate:modelValue":g[4]||(g[4]=q=>$.value.planDesc=q),class:"form-textarea",placeholder:o.$t("cronTask.taskDescriptionPlaceholder"),rows:"4",required:""},null,8,Wa),[[fe,$.value.planDesc]])]),e("div",ja,[e("label",Ha,l(o.$t("cronTask.planTemplate")),1),e("div",za,[e("button",{type:"button",class:te(["template-btn",$.value.linkTemplate?"active":""]),onClick:g[5]||(g[5]=q=>$.value.linkTemplate=!0)},[k(i(C),{icon:"carbon:checkmark"}),Y(" "+l(o.$t("cronTask.linkTemplate")),1)],2),e("button",{type:"button",class:te(["template-btn",$.value.linkTemplate?"":"active"]),onClick:P},[k(i(C),{icon:"carbon:close"}),Y(" "+l(o.$t("cronTask.noTemplate")),1)],2)]),$.value.linkTemplate?(h(),m("div",Ja,[de(e("select",{"onUpdate:modelValue":g[6]||(g[6]=q=>$.value.templateId=q),class:"form-select"},[e("option",Ga,l(o.$t("cronTask.selectTemplate")),1),(h(!0),m(ge,null,ve(u.value,q=>(h(),m("option",{key:q.id,value:q.id},l(q.name),9,Xa))),128))],512),[[ut,$.value.templateId]]),e("div",Ka,l(o.$t("cronTask.templateHelpText")),1)])):F("",!0)]),(S=o.task)!=null&&S.createTime?(h(),m("div",Qa,[e("div",Ya,[e("span",Za,l(o.$t("cronTask.createTime"))+":",1),e("span",el,l(X(o.task.createTime)),1)])])):F("",!0),(K=o.task)!=null&&K.updateTime?(h(),m("div",tl,[e("div",nl,[e("span",sl,l(o.$t("cronTask.updateTime"))+":",1),e("span",ol,l(X(o.task.updateTime)),1)])])):F("",!0)],32)]),e("div",al,[e("button",{type:"button",class:"cancel-btn",onClick:g[7]||(g[7]=q=>o.$emit("update:modelValue",!1))},l(o.$t("common.cancel")),1),e("button",{type:"button",class:"save-btn",onClick:G,disabled:E.value},[E.value?(h(),ue(i(C),{key:0,icon:"carbon:loading",class:"loading-icon"})):F("",!0),Y(" "+l((U=s.task)!=null&&U.id?o.$t("common.save"):o.$t("common.create")),1)],8,ll)])])])):F("",!0)]}),_:1})]))}}),cl=ye(il,[["__scopeId","data-v-5b32448e"]]),rl={class:"modal-header"},ul={class:"header-actions"},dl={class:"modal-content"},pl={key:0,class:"loading-container"},hl={key:1,class:"empty-container"},gl={key:2,class:"task-list"},ml=["onClick"],vl={class:"task-main"},fl={class:"task-info"},bl={class:"task-header"},kl={class:"task-name"},_l={class:"task-description"},$l={class:"task-time"},Pl=["onClick"],Cl=["onClick","disabled","title"],Sl=["onClick","title"],yl={class:"dropdown-menu"},El=["onClick"],wl=["onClick","disabled"],Tl=["onClick","disabled"],Il={class:"confirm-header"},Dl={class:"confirm-content"},xl={class:"confirm-actions"},Rl=["disabled"],Al={class:"confirm-header"},Ml={class:"confirm-content"},Nl={class:"create-options"},Ul={class:"option-content"},Ll={class:"option-title"},ql={class:"option-desc"},Fl={class:"option-content"},Vl={class:"option-title"},Ol={class:"option-desc"},Bl={class:"confirm-actions"},Wl=Ce({__name:"index",props:{modelValue:{type:Boolean,required:!0}},emits:["update:modelValue"],setup(T,{emit:n}){const s=lt(),d=it(),E=mt(),{t:u}=Ie(),$=T,x=n,O=D([]),P=D(!1),B=D(null),X=D(null),G=D(null),o=D(null),g=D(!1),S=D(null),K=D(!1),U=D(null),q=D(!1),V=c=>{c.target===c.currentTarget&&x("update:modelValue",!1)},Q=async()=>{P.value=!0;try{O.value=await we.getAllCronTasks()}catch(c){console.error("Failed to load cron tasks:",c),E.error(`Failed to load tasks: ${c instanceof Error?c.message:String(c)}`)}finally{P.value=!1}},ce=async c=>{B.value=c;try{const _=O.value.find(a=>a.id===c);if(!_){console.error("Task not found:",c);return}x("update:modelValue",!1);const I=Date.now().toString();await s.push({name:"direct",params:{id:I}}),await new Promise(a=>setTimeout(a,100));const t=Te.prepareTaskExecution(_);t.useTemplate&&t.planData?d.emitPlanExecutionRequested(t.planData):t.taskContent&&d.setTask(t.taskContent)}catch(_){console.error("Failed to execute task:",_),E.error(`Execution failed: ${_ instanceof Error?_.message:String(_)}`)}finally{B.value=null}},be=c=>{S.value={...c},g.value=!0,o.value=null},v=async c=>{try{await Te.saveTask(c),await Q(),g.value=!1,E.success("Task saved successfully")}catch(_){console.error("Failed to save task:",_),E.error(`Save failed: ${_ instanceof Error?_.message:String(_)}`)}},w=c=>{U.value=c,K.value=!0},L=async()=>{var c;if((c=U.value)!=null&&c.id){X.value=U.value.id;try{await Te.deleteTask(U.value.id),await Q(),K.value=!1,U.value=null,E.success("Task deleted successfully")}catch(_){console.error("Failed to delete task:",_),E.error(`Delete failed: ${_ instanceof Error?_.message:String(_)}`)}finally{X.value=null}}},R=()=>{K.value=!1,U.value=null},y=c=>{o.value=o.value===c?null:c},A=async c=>{if(c.id){G.value=c.id;try{await Te.toggleTaskStatus(c),await Q(),o.value=null,E.success(`Task ${c.status===0?"disabled":"enabled"} successfully`)}catch(_){console.error("Failed to toggle task status:",_),E.error(`Status toggle failed: ${_ instanceof Error?_.message:String(_)}`)}finally{G.value=null}}},ee=async c=>{try{await navigator.clipboard.writeText(c),E.success("Cron expression copied successfully")}catch(_){E.error(`Copy failed: ${_ instanceof Error?_.message:String(_)}`)}},se=()=>{q.value=!0},me=()=>{q.value=!1;try{x("update:modelValue",!1);const c=u("cronTask.template");d.setTaskToInput(c);const _=Date.now().toString();s.push({name:"direct",params:{id:_}})}catch(c){console.error("Error in createWithJmanus:",c),E.error(`Creation failed: ${c instanceof Error?c.message:String(c)}`)}},ke=()=>{q.value=!1,S.value={cronName:"",cronTime:"",planDesc:"",status:0,planTemplateId:""},g.value=!0},re=()=>{q.value=!1},b=c=>{const _=c.target;!_.closest(".action-dropdown")&&!_.closest(".dropdown-menu")&&(o.value=null)};return Se(()=>{document.addEventListener("click",b,!0)}),De(()=>{document.removeEventListener("click",b,!0)}),$e(()=>$.modelValue,c=>{c&&Q()}),(c,_)=>(h(),m(ge,null,[(h(),ue(Ne,{to:"body"},[k(xe,{name:"modal"},{default:Re(()=>[T.modelValue?(h(),m("div",{key:0,class:"modal-overlay",onClick:V},[e("div",{class:"modal-container",onClick:_[3]||(_[3]=ie(()=>{},["stop"]))},[e("div",rl,[e("h3",null,l(c.$t("cronTask.title")),1),e("div",ul,[e("button",{class:"add-task-btn",onClick:[se,_[0]||(_[0]=ie(()=>{},["stop"]))]},[k(i(C),{icon:"carbon:add"}),Y(" "+l(c.$t("cronTask.addTask")),1)]),e("button",{class:"close-btn",onClick:_[1]||(_[1]=I=>c.$emit("update:modelValue",!1))},[k(i(C),{icon:"carbon:close"})])])]),e("div",dl,[P.value?(h(),m("div",pl,[k(i(C),{icon:"carbon:loading",class:"loading-icon"}),e("span",null,l(c.$t("common.loading")),1)])):O.value.length===0?(h(),m("div",hl,[k(i(C),{icon:"carbon:time",class:"empty-icon"}),e("span",null,l(c.$t("cronTask.noTasks")),1)])):(h(),m("div",gl,[(h(!0),m(ge,null,ve(O.value,I=>(h(),m("div",{key:I.id||"",class:"task-item",onClick:t=>be(I)},[e("div",vl,[e("div",fl,[e("div",bl,[e("div",kl,l(I.cronName),1),e("div",{class:te(["task-status-badge",I.status===0?"active":"inactive"])},[k(i(C),{icon:I.status===0?"carbon:checkmark-filled":"carbon:pause-filled"},null,8,["icon"]),e("span",null,l(I.status===0?c.$t("cronTask.active"):c.$t("cronTask.inactive")),1)],2)]),e("div",_l,l(I.planDesc),1),e("div",$l,[k(i(C),{icon:"carbon:time"}),e("span",{class:"cron-readable",style:{cursor:"pointer"},onClick:ie(t=>ee(I.cronTime),["stop"])},l(I.cronTime),9,Pl)])])]),e("div",{class:"task-actions",onClick:_[2]||(_[2]=ie(()=>{},["stop"]))},[e("button",{class:"action-btn execute-btn",onClick:t=>ce(I.id),disabled:B.value===I.id,title:c.$t("cronTask.executeOnce")},[k(i(C),{icon:B.value===I.id?"carbon:loading":"carbon:play-filled"},null,8,["icon"]),Y(" "+l(c.$t("cronTask.executeOnce")),1)],8,Cl),e("div",{class:te(["action-dropdown",{active:o.value===I.id}])},[e("button",{class:"action-btn dropdown-btn",onClick:t=>y(I.id),title:c.$t("cronTask.operations")},[k(i(C),{icon:"carbon:overflow-menu-horizontal"}),Y(" "+l(c.$t("cronTask.operations")),1)],8,Sl),de(e("div",yl,[e("button",{class:"dropdown-item edit-btn",onClick:t=>be(I)},[k(i(C),{icon:"carbon:edit"}),Y(" "+l(c.$t("cronTask.edit")),1)],8,El),e("button",{class:"dropdown-item toggle-btn",onClick:t=>A(I),disabled:G.value===I.id},[k(i(C),{icon:G.value===I.id?"carbon:loading":I.status===0?"carbon:pause-filled":"carbon:play-filled"},null,8,["icon"]),Y(" "+l(I.status===0?c.$t("cronTask.disable"):c.$t("cronTask.enable")),1)],8,wl),e("button",{class:"dropdown-item delete-btn",onClick:t=>w(I),disabled:X.value===I.id},[k(i(C),{icon:X.value===I.id?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),Y(" "+l(c.$t("cronTask.delete")),1)],8,Tl)],512),[[dt,o.value===I.id]])],2)])],8,ml))),128))]))])])])):F("",!0)]),_:1})])),k(cl,{modelValue:g.value,"onUpdate:modelValue":_[4]||(_[4]=I=>g.value=I),task:S.value,onSave:v},null,8,["modelValue","task"]),(h(),ue(Ne,{to:"body"},[k(xe,{name:"modal"},{default:Re(()=>{var I,t,a,r;return[K.value?(h(),m("div",{key:0,class:"modal-overlay",onClick:R},[e("div",{class:"confirm-modal",onClick:_[5]||(_[5]=ie(()=>{},["stop"]))},[e("div",Il,[k(i(C),{icon:"carbon:warning",class:"warning-icon"}),e("h3",null,l(c.$t("cronTask.deleteConfirm")),1)]),e("div",Dl,[e("p",null,l(c.$t("cronTask.deleteConfirmMessage",{taskName:((I=U.value)==null?void 0:I.cronName)||((t=U.value)==null?void 0:t.planDesc)||""})),1)]),e("div",xl,[e("button",{class:"confirm-btn cancel-btn",onClick:R},l(c.$t("common.cancel")),1),e("button",{class:"confirm-btn delete-btn",onClick:L,disabled:X.value===((a=U.value)==null?void 0:a.id)},[k(i(C),{icon:X.value===((r=U.value)==null?void 0:r.id)?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),Y(" "+l(c.$t("cronTask.delete")),1)],8,Rl)])])])):F("",!0)]}),_:1})])),(h(),ue(Ne,{to:"body"},[k(xe,{name:"modal"},{default:Re(()=>[q.value?(h(),m("div",{key:0,class:"modal-overlay",onClick:re},[e("div",{class:"confirm-modal create-options-modal",onClick:_[6]||(_[6]=ie(()=>{},["stop"]))},[e("div",Al,[k(i(C),{icon:"carbon:time",class:"create-icon"}),e("h3",null,l(c.$t("cronTask.createTask")),1)]),e("div",Ml,[e("p",null,l(c.$t("cronTask.selectCreateMethod")),1),e("div",Nl,[e("button",{class:"create-option-btn jmanus-btn",onClick:me},[k(i(C),{icon:"carbon:ai-status"}),e("div",Ul,[e("span",Ll,l(c.$t("cronTask.createWithJmanus")),1),e("span",ql,l(c.$t("cronTask.createWithJmanusDesc")),1)])]),e("button",{class:"create-option-btn manual-btn",onClick:ke},[k(i(C),{icon:"carbon:edit"}),e("div",Fl,[e("span",Vl,l(c.$t("cronTask.createManually")),1),e("span",Ol,l(c.$t("cronTask.createManuallyDesc")),1)])])])]),e("div",Bl,[e("button",{class:"confirm-btn cancel-btn",onClick:re},l(c.$t("common.cancel")),1)])])])):F("",!0)]),_:1})]))],64))}}),jl=ye(Wl,[["__scopeId","data-v-837947df"]]),Hl={class:"direct-page"},zl={class:"direct-chat"},Jl={class:"chat-header"},Gl={class:"header-actions"},Xl=["title"],Kl=["title"],Ql={class:"chat-content"},Yl=["title"],Zl={class:"message-content"},ei=Ce({__name:"index",setup(T){const n=pt(),s=lt(),d=it(),{t:E}=Ie(),{message:u}=vt(),$=D(""),x=D(""),O=D(),P=D(),B=D(),X=D(!1),G=D(!1),o=D(null),g=D(!1),S=D(50),K=D(!1),U=D(0),q=D(0);Se(()=>{if(console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",d.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",d.hasUnprocessedTask()),oe.setEventCallbacks({onPlanUpdate:c=>{console.log("[Direct] Plan update event received for rootPlanId:",c),v(c)&&(console.log("[Direct] Processing plan update for current rootPlanId:",c),P.value&&typeof P.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",c),P.value.handlePlanUpdate(c)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),O.value&&typeof O.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",c),O.value.updateDisplayedPlanProgress(c)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:c=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",c),!!v(c)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",c),P.value&&typeof P.value.handlePlanCompleted=="function"){const _=oe.getCachedPlanRecord(c);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",_),P.value.handlePlanCompleted(_??{planId:c})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");o.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:c=>{console.log("[Direct] Dialog round start event received for rootPlanId:",c),o.value=c,console.log("[Direct] Set currentRootPlanId to:",c),P.value&&typeof P.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",c),P.value.handleDialogRoundStart(c)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),L()},onChatInputUpdateState:c=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",c),!v(c,!0))return;const _=oe.getCachedUIState(c);_&&y(_.enabled,_.placeholder)},onPlanError:c=>{P.value.handlePlanError(c)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),f.loadPlanTemplateList(),d.hasUnprocessedTask()&&d.currentTask){const c=d.currentTask.prompt;console.log("[Direct] Found unprocessed task from store:",c),d.markTaskAsProcessed(),ne(()=>{P.value&&typeof P.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing task via chatRef.handleSendMessage:",c),P.value.handleSendMessage(c)):(console.warn("[Direct] chatRef.handleSendMessage method not available, falling back to prompt"),$.value=c)})}else{const c=d.getAndClearTaskToInput();c?(x.value=c,console.log("[Direct] Setting inputOnlyContent for input only:",x.value)):($.value=n.query.prompt||"",console.log("[Direct] Received task from URL:",$.value),console.log("[Direct] No unprocessed task in store"))}const b=localStorage.getItem("directPanelWidth");b&&(S.value=parseFloat(b)),console.log("[Direct] Final prompt value:",$.value),x.value&&ne(()=>{B.value&&typeof B.value.setInputValue=="function"&&(B.value.setInputValue(x.value),console.log("[Direct] Set input value:",x.value),x.value="")}),window.addEventListener("plan-execution-requested",c=>{console.log("[DirectView] Received plan-execution-requested event:",c.detail),re(c.detail)})}),$e(()=>d.currentTask,b=>{if(console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",b),b&&!b.processed){const c=b.prompt;d.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",c),ne(()=>{P.value&&typeof P.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing new task via chatRef.handleSendMessage:",c),P.value.handleSendMessage(c)):console.warn("[Direct] chatRef.handleSendMessage method not available for new task")})}else console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),$e(()=>$.value,(b,c)=>{console.log("[Direct] prompt value changed from:",c,"to:",b)},{immediate:!1}),$e(()=>d.taskToInput,b=>{console.log("[Direct] Watch taskStore.taskToInput triggered, newTaskToInput:",b),b&&b.trim()&&(console.log("[Direct] Setting input value from taskToInput:",b),ne(()=>{B.value&&typeof B.value.setInputValue=="function"&&(B.value.setInputValue(b.trim()),console.log("[Direct] Input value set from taskToInput watch:",b.trim()),d.getAndClearTaskToInput())}))},{immediate:!1}),De(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),o.value=null,oe.cleanup(),document.removeEventListener("mousemove",Q),document.removeEventListener("mouseup",ce),window.removeEventListener("plan-execution-requested",b=>{re(b.detail)})});const V=b=>{K.value=!0,U.value=b.clientX,q.value=S.value,document.addEventListener("mousemove",Q),document.addEventListener("mouseup",ce),document.body.style.cursor="col-resize",document.body.style.userSelect="none",b.preventDefault()},Q=b=>{if(!K.value)return;const c=window.innerWidth,I=(b.clientX-U.value)/c*100;let t=q.value+I;t=Math.max(20,Math.min(80,t)),S.value=t},ce=()=>{K.value=!1,document.removeEventListener("mousemove",Q),document.removeEventListener("mouseup",ce),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",S.value.toString())},be=()=>{S.value=50,localStorage.setItem("directPanelWidth","50")},v=(b,c=!1)=>!o.value||b===o.value||c&&(b==="ui-state"||b==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",b,"current:",o.value),!1),w=b=>{console.log("[DirectView] Send message from input:",b),P.value&&typeof P.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",b),P.value.handleSendMessage(b)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},L=()=>{console.log("[DirectView] Input cleared"),B.value&&typeof B.value.clear=="function"&&B.value.clear()},R=()=>{console.log("[DirectView] Input focused")},y=(b,c)=>{console.log("[DirectView] Input state updated:",b,c),G.value=!b},A=(b,c)=>{console.log("[DirectView] Step selected:",b,c),O.value&&typeof O.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",b,c),O.value.handleStepSelected(b,c)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},ee=(b,c,_,I)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:b,subPlanId:c,stepIndex:_,subStepIndex:I}),O.value&&typeof O.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:b,subPlanId:c,stepIndex:_,subStepIndex:I}),O.value.handleSubPlanStepSelected(b,c,_,I)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},se=()=>{console.log("[DirectView] Plan mode button clicked"),f.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",f.isCollapsed)},me=()=>{s.push("/home")},ke=()=>{s.push("/configs")},re=async b=>{var _,I,t,a;if(console.log("[DirectView] Plan execution requested:",b),X.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}X.value=!0;let c=!1;P.value&&typeof P.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",b.title),P.value.addMessage("user",b.title),c=!0):console.warn("[DirectView] chatRef.addMessage method not available");try{const r=((_=b.planData)==null?void 0:_.planTemplateId)||((I=b.planData)==null?void 0:I.id)||((t=b.planData)==null?void 0:t.planId);if(!r)throw new Error(E("direct.planTemplateIdNotFound"));console.log("[Direct] Executing plan with templateId:",r,"params:",b.params),console.log("[Direct] About to call PlanActApiService.executePlan");let p;if((a=b.params)!=null&&a.trim()?(console.log("[Direct] Calling executePlan with params:",b.params.trim()),p=await Ae.executePlan(r,b.params.trim())):(console.log("[Direct] Calling executePlan without params"),p=await Ae.executePlan(r)),console.log("[Direct] Plan execution API response:",p),p.planId)console.log("[Direct] Got planId from response:",p.planId,"starting plan execution"),o.value=p.planId,console.log("[Direct] Set currentRootPlanId to:",p.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),oe.handlePlanExecutionRequested(p.planId,b.title);else throw console.error("[Direct] No planId in response:",p),new Error(E("direct.executionFailedNoPlanId"))}catch(r){console.error("[Direct] Plan execution failed:",r),console.error("[Direct] Error details:",{message:r.message,stack:r.stack}),o.value=null,P.value&&typeof P.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),c||P.value.addMessage("user",b.title),P.value.addMessage("assistant",`${E("direct.executionFailed")}: ${r.message||E("common.unknownError")}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`${E("direct.executionFailed")}: ${r.message||E("common.unknownError")}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),X.value=!1}};return(b,c)=>(h(),m("div",Hl,[e("div",zl,[k(fn,{onPlanExecutionRequested:re}),e("div",{class:"left-panel",style:Ue({width:S.value+"%"})},[e("div",Jl,[e("button",{class:"back-button",onClick:me},[k(i(C),{icon:"carbon:arrow-left"})]),e("h2",null,l(b.$t("conversation")),1),e("div",Gl,[k(gt),e("button",{class:"config-button",onClick:ke,title:b.$t("direct.configuration")},[k(i(C),{icon:"carbon:settings-adjust",width:"20"})],8,Xl),e("button",{class:"cron-task-btn",onClick:c[0]||(c[0]=_=>g.value=!0),title:b.$t("cronTask.title")},[k(i(C),{icon:"carbon:alarm",width:"20"})],8,Kl)])]),e("div",Ql,[k(ba,{ref_key:"chatRef",ref:P,mode:"direct","initial-prompt":$.value||"",onStepSelected:A,onSubPlanStepSelected:ee},null,8,["initial-prompt"])]),(h(),ue(Ea,{key:b.$i18n.locale,ref_key:"inputRef",ref:B,disabled:G.value,placeholder:G.value?i(E)("input.waiting"):i(E)("input.placeholder"),"initial-value":$.value,onSend:w,onClear:L,onFocus:R,onUpdateState:y,onPlanModeClicked:se},null,8,["disabled","placeholder","initial-value"]))],4),e("div",{class:"panel-resizer",onMousedown:V,onDblclick:be,title:b.$t("direct.panelResizeHint")},c[2]||(c[2]=[e("div",{class:"resizer-line"},null,-1)]),40,Yl),k(Ls,{ref_key:"rightPanelRef",ref:O,style:Ue({width:100-S.value+"%"})},null,8,["style"])]),k(jl,{modelValue:g.value,"onUpdate:modelValue":c[1]||(c[1]=_=>g.value=_)},null,8,["modelValue"]),i(u).show?(h(),m("div",{key:0,class:te(["message-toast",i(u).type])},[e("div",Zl,[e("span",null,l(i(u).text),1)])],2)):F("",!0)]))}}),ri=ye(ei,[["__scopeId","data-v-eab98c50"]]);export{ri as default};
