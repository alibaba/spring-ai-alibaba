var it=Object.defineProperty;var lt=(B,t,s)=>t in B?it(B,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):B[t]=s;var F=(B,t,s)=>lt(B,typeof t!="symbol"?t+"":t,s);import{m as Ue,p as Te,d as ke,f as $e,h as Ee,c as g,o as p,q as oe,u as a,e,b as O,t as l,i as $,s as K,F as me,j as fe,x as Ce,w as pe,v as Se,r as q,g as ve,k as ie,y as ye,a as _e,T as ct,z as rt,A as Le,n as Me,B as at,C as ut,l as dt}from"./index-CJAcPQRq.js";import{I as E,_ as we}from"./_plugin-vue_export-helper-BRtV-D-h.js";import{L as pt}from"./index-CJl3JG9l.js";import{u as ht}from"./task-DMl2qY4d.js";class ce{static async generatePlan(t,s){const c={query:t};s&&(c.existingJson=s);const _=await fetch(`${this.PLAN_TEMPLATE_URL}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!_.ok)throw new Error(`Failed to generate plan: ${_.status}`);const r=await _.json();if(r.planJson)try{r.plan=JSON.parse(r.planJson)}catch{r.plan={error:"Unable to parse plan data"}}return r}static async executePlan(t,s){console.log("[PlanActApiService] executePlan called with:",{planTemplateId:t,rawParam:s});const c={planTemplateId:t};s&&(c.rawParam=s),console.log("[PlanActApiService] Making request to:",`${this.PLAN_TEMPLATE_URL}/executePlanByTemplateId`),console.log("[PlanActApiService] Request body:",c);const _=await fetch(`${this.PLAN_TEMPLATE_URL}/executePlanByTemplateId`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(console.log("[PlanActApiService] Response status:",_.status,_.ok),!_.ok){const y=await _.text();throw console.error("[PlanActApiService] Request failed:",y),new Error(`Failed to execute plan: ${_.status}`)}const r=await _.json();return console.log("[PlanActApiService] executePlan response:",r),r}static async savePlanTemplate(t,s){const c=await fetch(`${this.PLAN_TEMPLATE_URL}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t,planJson:s})});if(!c.ok)throw new Error(`Failed to save plan: ${c.status}`);return await c.json()}static async getPlanVersions(t){const s=await fetch(`${this.PLAN_TEMPLATE_URL}/versions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t})});if(!s.ok)throw new Error(`Failed to get plan versions: ${s.status}`);return await s.json()}static async getVersionPlan(t,s){const c=await fetch(`${this.PLAN_TEMPLATE_URL}/get-version`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t,versionIndex:s.toString()})});if(!c.ok)throw new Error(`Failed to get specific version plan: ${c.status}`);return await c.json()}static async getAllPlanTemplates(){const t=await fetch(`${this.PLAN_TEMPLATE_URL}/list`);if(!t.ok)throw new Error(`Failed to get plan template list: ${t.status}`);return await t.json()}static async updatePlanTemplate(t,s,c){const _={planId:t,query:s};c&&(_.existingJson=c);const r=await fetch(`${this.PLAN_TEMPLATE_URL}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(_)});if(!r.ok)throw new Error(`Failed to update plan template: ${r.status}`);const y=await r.json();if(y.planJson)try{y.plan=JSON.parse(y.planJson)}catch{y.plan={error:"Unable to parse plan data"}}return y}static async deletePlanTemplate(t){const s=await fetch(`${this.PLAN_TEMPLATE_URL}/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t})});if(!s.ok)throw new Error(`Failed to delete plan template: ${s.status}`);return await s.json()}}F(ce,"PLAN_TEMPLATE_URL","/api/plan-template");class gt{constructor(){F(this,"isCollapsed",!0);F(this,"currentTab","list");F(this,"currentPlanTemplateId",null);F(this,"planTemplateList",[]);F(this,"selectedTemplate",null);F(this,"isLoading",!1);F(this,"errorMessage","");F(this,"jsonContent","");F(this,"generatorPrompt","");F(this,"executionParams","");F(this,"isGenerating",!1);F(this,"isExecuting",!1);F(this,"planVersions",[]);F(this,"currentVersionIndex",-1)}get sortedTemplates(){return[...this.planTemplateList].sort((t,s)=>{const c=new Date(t.updateTime??t.createTime);return new Date(s.updateTime??s.createTime).getTime()-c.getTime()})}get canRollback(){return this.planVersions.length>1&&this.currentVersionIndex>0}get canRestore(){return this.planVersions.length>1&&this.currentVersionIndex<this.planVersions.length-1}get computedApiUrl(){if(!this.selectedTemplate)return"";const t=`/api/plan-template/execute/${this.selectedTemplate.id}`,s=this.executionParams.trim();return s?`${t}?allParams=${encodeURIComponent(s)}`:t}toggleSidebar(){this.isCollapsed=!this.isCollapsed}switchToTab(t){this.currentTab=t}async loadPlanTemplateList(){this.isLoading=!0,this.errorMessage="";try{console.log("[SidebarStore] Starting to load plan template list...");const t=await ce.getAllPlanTemplates();t!=null&&t.templates&&Array.isArray(t.templates)?(this.planTemplateList=t.templates,console.log(`[SidebarStore] Successfully loaded ${t.templates.length} plan templates`)):(this.planTemplateList=[],console.warn("[SidebarStore] API returned abnormal data format, using empty list",t))}catch(t){console.error("[SidebarStore] Failed to load plan template list:",t),this.planTemplateList=[],this.errorMessage=`Load failed: ${t.message}`}finally{this.isLoading=!1}}async selectTemplate(t){this.currentPlanTemplateId=t.id,this.selectedTemplate=t,this.currentTab="config",await this.loadTemplateData(t),console.log(`[SidebarStore] Selected plan template: ${t.id}`)}async loadTemplateData(t){try{const s=await ce.getPlanVersions(t.id);if(this.planVersions=s.versions||[],this.planVersions.length>0){const c=this.planVersions[this.planVersions.length-1];this.jsonContent=c,this.currentVersionIndex=this.planVersions.length-1;try{const _=JSON.parse(c);_.prompt&&(this.generatorPrompt=_.prompt),_.params&&(this.executionParams=_.params)}catch{console.warn("Unable to parse JSON content to get prompt information")}}else this.jsonContent="",this.generatorPrompt="",this.executionParams=""}catch(s){throw console.error("Failed to load template data:",s),s}}createNewTemplate(){const t={id:`new-${Date.now()}`,title:Te.global.t("sidebar.newTemplateName"),description:Te.global.t("sidebar.newTemplateDescription"),createTime:new Date().toISOString(),updateTime:new Date().toISOString()};this.selectedTemplate=t,this.currentPlanTemplateId=null,this.jsonContent="",this.generatorPrompt="",this.executionParams="",this.planVersions=[],this.currentVersionIndex=-1,this.currentTab="config",console.log("[SidebarStore] Created new empty plan template, switching to config tab")}async deleteTemplate(t){if(!t.id){console.warn("[SidebarStore] deleteTemplate: Invalid template object or ID");return}try{await ce.deletePlanTemplate(t.id),this.currentPlanTemplateId===t.id&&this.clearSelection(),await this.loadPlanTemplateList(),console.log(`[SidebarStore] Plan template ${t.id} has been deleted`)}catch(s){throw console.error("Failed to delete plan template:",s),await this.loadPlanTemplateList(),s}}clearSelection(){this.currentPlanTemplateId=null,this.selectedTemplate=null,this.jsonContent="",this.generatorPrompt="",this.executionParams="",this.planVersions=[],this.currentVersionIndex=-1,this.currentTab="list"}clearExecutionParams(){this.executionParams=""}rollbackVersion(){this.canRollback&&(this.currentVersionIndex--,this.jsonContent=this.planVersions[this.currentVersionIndex])}restoreVersion(){this.canRestore&&(this.currentVersionIndex++,this.jsonContent=this.planVersions[this.currentVersionIndex])}async saveTemplate(){if(!this.selectedTemplate)return;const t=this.jsonContent.trim();if(!t)throw new Error("Content cannot be empty");try{JSON.parse(t)}catch(s){throw new Error(`Invalid format, please correct and save.
Error: `+s.message)}try{const s=await ce.savePlanTemplate(this.selectedTemplate.id,t);return this.currentVersionIndex<this.planVersions.length-1&&(this.planVersions=this.planVersions.slice(0,this.currentVersionIndex+1)),this.planVersions.push(t),this.currentVersionIndex=this.planVersions.length-1,s}catch(s){throw console.error("Failed to save plan template:",s),s}}async generatePlan(){if(this.generatorPrompt.trim()){this.isGenerating=!0;try{const t=await ce.generatePlan(this.generatorPrompt);if(this.jsonContent=t.planJson||"",this.selectedTemplate&&this.selectedTemplate.id.startsWith("new-")){let s="New Plan Template";try{s=JSON.parse(t.planJson||"{}").title||s}catch{console.warn("Unable to parse plan JSON to get title")}this.selectedTemplate={id:t.planTemplateId,title:s,description:Te.global.t("sidebar.generatedTemplateDescription"),createTime:new Date().toISOString(),updateTime:new Date().toISOString(),planJson:t.planJson},this.currentPlanTemplateId=t.planTemplateId,await this.loadPlanTemplateList()}return this.currentVersionIndex<this.planVersions.length-1&&(this.planVersions=this.planVersions.slice(0,this.currentVersionIndex+1)),this.planVersions.push(this.jsonContent),this.currentVersionIndex=this.planVersions.length-1,t}catch(t){throw console.error("Failed to generate plan:",t),t}finally{this.isGenerating=!1}}}async updatePlan(){if(!(!this.generatorPrompt.trim()||!this.jsonContent.trim())&&this.selectedTemplate){this.isGenerating=!0;try{const t=await ce.updatePlanTemplate(this.selectedTemplate.id,this.generatorPrompt,this.jsonContent);return this.jsonContent=t.planJson||"",this.currentVersionIndex<this.planVersions.length-1&&(this.planVersions=this.planVersions.slice(0,this.currentVersionIndex+1)),this.planVersions.push(this.jsonContent),this.currentVersionIndex=this.planVersions.length-1,t}catch(t){throw console.error("Failed to update plan:",t),t}finally{this.isGenerating=!1}}}preparePlanExecution(){if(!this.selectedTemplate)return null;this.isExecuting=!0;try{let t;try{t=JSON.parse(this.jsonContent),t.planTemplateId=this.selectedTemplate.id}catch{t={planTemplateId:this.selectedTemplate.id,planId:this.selectedTemplate.id,title:this.selectedTemplate.title??Te.global.t("sidebar.defaultExecutionPlanTitle"),steps:[{stepRequirement:"[BROWSER_AGENT] 访问百度搜索阿里巴巴的最新股价"},{stepRequirement:"[DEFAULT_AGENT] 提取和整理搜索结果中的股价信息"},{stepRequirement:"[TEXT_FILE_AGENT] 创建一个文本文件记录查询结果"},{stepRequirement:"[DEFAULT_AGENT] 向用户报告查询结果"}]}}return{title:this.selectedTemplate.title??t.title??"Execution Plan",planData:t,params:this.executionParams.trim()||void 0}}catch(t){throw console.error("Failed to prepare plan execution:",t),this.isExecuting=!1,t}}finishPlanExecution(){this.isExecuting=!1}}const h=Ue(new gt),mt={class:"sidebar-content"},ft={class:"sidebar-content-header"},vt={class:"sidebar-content-title"},Pt={class:"tab-switcher"},bt=["disabled"],_t={key:0,class:"tab-content"},St={class:"new-task-section"},Ct={class:"sidebar-content-list"},kt={key:0,class:"loading-state"},$t={key:1,class:"error-state"},Et={key:2,class:"empty-state"},yt=["onClick"],wt={class:"task-icon"},It={class:"task-details"},xt={class:"task-title"},Tt={class:"task-preview"},Rt={class:"task-time"},Dt={class:"task-actions"},At=["title","onClick"],Lt={key:1,class:"tab-content config-tab"},Mt={key:0,class:"config-container"},Nt={class:"template-info-header"},Ut={class:"template-info"},Vt={class:"template-id"},qt={class:"config-section"},Ot={class:"section-header"},jt={class:"generator-content"},Ft=["placeholder"],Bt={class:"generator-actions"},Jt=["disabled"],Wt=["disabled"],Ht={class:"config-section"},Gt={class:"section-header"},zt={class:"section-actions"},Xt=["disabled","title"],Kt=["disabled","title"],Qt=["disabled"],Yt=["placeholder"],Zt={class:"config-section"},en={class:"section-header"},tn={class:"execution-content"},nn={class:"params-input-group"},sn={class:"params-help-text"},on={class:"params-input-container"},an=["placeholder"],ln=["title"],cn={class:"api-url-display"},rn={class:"api-url-label"},un={class:"api-url"},dn={class:"api-url-display"},pn={class:"api-url-label"},hn=["disabled"],gn=ke({__name:"index",emits:["planExecutionRequested"],setup(B,{expose:t,emit:s}){const{t:c}=$e(),_=s,r=async()=>{try{const u=await h.saveTemplate();u!=null&&u.duplicate?alert(c("sidebar.saveCompleted",{message:u.message,versionCount:u.versionCount})):u!=null&&u.saved?alert(c("sidebar.saveSuccess",{message:u.message,versionCount:u.versionCount})):u!=null&&u.message&&alert(c("sidebar.saveStatus",{message:u.message}))}catch(u){console.error("保存计划修改失败:",u),alert(u.message||c("sidebar.saveFailed"))}},y=async()=>{var u;try{await h.generatePlan(),alert(c("sidebar.generateSuccess",{templateId:((u=h.selectedTemplate)==null?void 0:u.id)??c("sidebar.unknown")}))}catch(f){console.error("生成计划失败:",f),alert(c("sidebar.generateFailed")+": "+f.message)}},C=async()=>{try{await h.updatePlan(),alert(c("sidebar.updateSuccess"))}catch(u){console.error("更新计划失败:",u),alert(c("sidebar.updateFailed")+": "+u.message)}},G=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const u=h.preparePlanExecution();if(!u){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] 触发计划执行请求:",u),console.log("[Sidebar] Emitting planExecutionRequested event"),_("planExecutionRequested",u),console.log("[Sidebar] Event emitted")}catch(u){console.error("执行计划出错:",u),alert(c("sidebar.executeFailed")+": "+u.message)}finally{h.finishPlanExecution()}},D=u=>{const k=new Date().getTime()-u.getTime(),H=Math.floor(k/6e4),ee=Math.floor(k/36e5),re=Math.floor(k/864e5);return H<1?"刚刚":H<60?`${H}分钟前`:ee<24?`${ee}小时前`:re<30?`${re}天前`:u.toLocaleDateString("zh-CN")},X=(u,f)=>!u||u.length<=f?u:u.substring(0,f)+"...";return Ee(()=>{h.loadPlanTemplateList()}),t({loadPlanTemplateList:h.loadPlanTemplateList,toggleSidebar:h.toggleSidebar,currentPlanTemplateId:h.currentPlanTemplateId}),(u,f)=>(p(),g("div",{class:oe(["sidebar-wrapper",{"sidebar-wrapper-collapsed":a(h).isCollapsed}])},[e("div",mt,[e("div",ft,[e("div",vt,l(u.$t("sidebar.title")),1)]),e("div",Pt,[e("button",{class:oe(["tab-button",{active:a(h).currentTab==="list"}]),onClick:f[0]||(f[0]=k=>a(h).switchToTab("list"))},[$(a(E),{icon:"carbon:list",width:"16"}),K(" "+l(u.$t("sidebar.templateList")),1)],2),e("button",{class:oe(["tab-button",{active:a(h).currentTab==="config"}]),onClick:f[1]||(f[1]=k=>a(h).switchToTab("config")),disabled:!a(h).selectedTemplate},[$(a(E),{icon:"carbon:settings",width:"16"}),K(" "+l(u.$t("sidebar.configuration")),1)],10,bt)]),a(h).currentTab==="list"?(p(),g("div",_t,[e("div",St,[e("button",{class:"new-task-btn",onClick:f[2]||(f[2]=k=>a(h).createNewTemplate())},[$(a(E),{icon:"carbon:add",width:"16"}),K(" "+l(u.$t("sidebar.newPlan"))+" ",1),f[11]||(f[11]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",Ct,[a(h).isLoading?(p(),g("div",kt,[$(a(E),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,l(u.$t("sidebar.loading")),1)])):a(h).errorMessage?(p(),g("div",$t,[$(a(E),{icon:"carbon:warning",width:"20"}),e("span",null,l(a(h).errorMessage),1),e("button",{onClick:f[3]||(f[3]=(...k)=>a(h).loadPlanTemplateList&&a(h).loadPlanTemplateList(...k)),class:"retry-btn"},l(u.$t("sidebar.retry")),1)])):a(h).planTemplateList.length===0?(p(),g("div",Et,[$(a(E),{icon:"carbon:document",width:"32"}),e("span",null,l(u.$t("sidebar.noTemplates")),1)])):(p(!0),g(me,{key:3},fe(a(h).sortedTemplates,k=>(p(),g("div",{key:k.id,class:oe(["sidebar-content-list-item",{"sidebar-content-list-item-active":k.id===a(h).currentPlanTemplateId}]),onClick:H=>a(h).selectTemplate(k)},[e("div",wt,[$(a(E),{icon:"carbon:document",width:"20"})]),e("div",It,[e("div",xt,l(k.title||u.$t("sidebar.unnamedPlan")),1),e("div",Tt,l(X(k.description||u.$t("sidebar.noDescription"),40)),1)]),e("div",Rt,l(D(new Date(k.updateTime||k.createTime))),1),e("div",Dt,[e("button",{class:"delete-task-btn",title:u.$t("sidebar.deleteTemplate"),onClick:Ce(H=>a(h).deleteTemplate(k),["stop"])},[$(a(E),{icon:"carbon:close",width:"16"})],8,At)])],10,yt))),128))])])):a(h).currentTab==="config"?(p(),g("div",Lt,[a(h).selectedTemplate?(p(),g("div",Mt,[e("div",Nt,[e("div",Ut,[e("h3",null,l(a(h).selectedTemplate.title||u.$t("sidebar.unnamedPlan")),1),e("span",Vt,"ID: "+l(a(h).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:f[4]||(f[4]=k=>a(h).switchToTab("list"))},[$(a(E),{icon:"carbon:arrow-left",width:"16"})])]),e("div",qt,[e("div",Ot,[$(a(E),{icon:"carbon:generate",width:"16"}),e("span",null,l(u.$t("sidebar.planGenerator")),1)]),e("div",jt,[pe(e("textarea",{"onUpdate:modelValue":f[5]||(f[5]=k=>a(h).generatorPrompt=k),class:"prompt-input",placeholder:u.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,Ft),[[Se,a(h).generatorPrompt]]),e("div",Bt,[e("button",{class:"btn btn-primary btn-sm",onClick:y,disabled:a(h).isGenerating||!a(h).generatorPrompt.trim()},[$(a(E),{icon:a(h).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:oe({spinning:a(h).isGenerating})},null,8,["icon","class"]),K(" "+l(a(h).isGenerating?u.$t("sidebar.generating"):u.$t("sidebar.generatePlan")),1)],8,Jt),e("button",{class:"btn btn-secondary btn-sm",onClick:C,disabled:a(h).isGenerating||!a(h).generatorPrompt.trim()||!a(h).jsonContent.trim()},[$(a(E),{icon:"carbon:edit",width:"14"}),K(" "+l(u.$t("sidebar.updatePlan")),1)],8,Wt)])])]),e("div",Ht,[e("div",Gt,[$(a(E),{icon:"carbon:code",width:"16"}),e("span",null,l(u.$t("sidebar.jsonTemplate")),1),e("div",zt,[e("button",{class:"btn btn-sm",onClick:f[6]||(f[6]=(...k)=>a(h).rollbackVersion&&a(h).rollbackVersion(...k)),disabled:!a(h).canRollback,title:u.$t("sidebar.rollback")},[$(a(E),{icon:"carbon:undo",width:"14"})],8,Xt),e("button",{class:"btn btn-sm",onClick:f[7]||(f[7]=(...k)=>a(h).restoreVersion&&a(h).restoreVersion(...k)),disabled:!a(h).canRestore,title:u.$t("sidebar.restore")},[$(a(E),{icon:"carbon:redo",width:"14"})],8,Kt),e("button",{class:"btn btn-primary btn-sm",onClick:r,disabled:a(h).isGenerating||a(h).isExecuting},[$(a(E),{icon:"carbon:save",width:"14"})],8,Qt)])]),pe(e("textarea",{"onUpdate:modelValue":f[8]||(f[8]=k=>a(h).jsonContent=k),class:"json-editor",placeholder:u.$t("sidebar.jsonPlaceholder"),rows:"8"},null,8,Yt),[[Se,a(h).jsonContent]])]),e("div",Zt,[e("div",en,[$(a(E),{icon:"carbon:play",width:"16"}),e("span",null,l(u.$t("sidebar.executionController")),1)]),e("div",tn,[e("div",nn,[e("label",null,l(u.$t("sidebar.executionParams")),1),e("div",sn,l(u.$t("sidebar.executionParamsHelp")),1),e("div",on,[pe(e("input",{"onUpdate:modelValue":f[9]||(f[9]=k=>a(h).executionParams=k),class:"params-input",placeholder:u.$t("sidebar.executionParamsPlaceholder")},null,8,an),[[Se,a(h).executionParams]]),e("button",{class:"clear-params-btn",onClick:f[10]||(f[10]=(...k)=>a(h).clearExecutionParams&&a(h).clearExecutionParams(...k)),title:u.$t("sidebar.clearParams")},[$(a(E),{icon:"carbon:close",width:"12"})],8,ln)])]),e("div",cn,[e("span",rn,l(u.$t("sidebar.apiUrl"))+":",1),e("code",un,l(a(h).computedApiUrl),1)]),e("div",dn,[e("span",pn,l(u.$t("sidebar.statusApiUrl"))+":",1),f[12]||(f[12]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:G,disabled:a(h).isExecuting||a(h).isGenerating},[$(a(E),{icon:a(h).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:oe({spinning:a(h).isExecuting})},null,8,["icon","class"]),K(" "+l(a(h).isExecuting?u.$t("sidebar.executing"):u.$t("sidebar.executePlan")),1)],8,hn)])])])):O("",!0)])):O("",!0)])],2))}}),mn=we(gn,[["__scopeId","data-v-094cd641"]]);class Ve{static async sendMessage(t){const s=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t})});if(!s.ok)throw new Error(`API request failed: ${s.status}`);return await s.json()}}F(Ve,"BASE_URL","/api/executor");class Re{static async getDetails(t){try{const s=await fetch(`${this.BASE_URL}/details/${t}`);if(s.status===404)return null;if(!s.ok)throw new Error(`Failed to get detailed information: ${s.status}`);const c=await s.text(),_=JSON.parse(c);return _&&typeof _=="object"&&!_.currentPlanId&&(_.currentPlanId=t),_}catch(s){return console.error("[CommonApiService] Failed to get plan details:",s),null}}static async submitFormInput(t,s){const c=await fetch(`${this.BASE_URL}/submit-input/${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!c.ok){let r;try{r=await c.json()}catch{r={message:`Failed to submit form input: ${c.status}`}}throw new Error(r.message||`Failed to submit form input: ${c.status}`)}const _=c.headers.get("content-type");return _&&_.indexOf("application/json")!==-1?await c.json():{success:!0}}static async getAllPrompts(){try{const t=await fetch(this.BASE_URL);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get Prompt list:",t),t}}static async handleResponse(t){if(!t.ok)try{const s=await t.json();throw new Error(s.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}static async submitConfirmPlan(t,s){const c=await fetch(`${this.BASE_URL}/confirm-plan/${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!c.ok){let r;try{r=await c.json()}catch{r={message:`Failed to submit confirm plan: ${c.status}`}}throw new Error(r.message||`Failed to submit confirm plan: ${c.status}`)}const _=c.headers.get("content-type");return _&&_.indexOf("application/json")!==-1?await c.json():{success:!0}}}F(Re,"BASE_URL","/api/executor");const ge=class ge{constructor(){F(this,"POLL_INTERVAL",5e3);F(this,"state",Ue({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));F(this,"callbacks",{});F(this,"planExecutionCache",new Map);F(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(t){return this.planExecutionCache.get(t)}getCachedUIState(t){return this.uiStateCache.get(t)}setCachedUIState(t,s){this.uiStateCache.set(t,s),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${t}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(t){return this.planExecutionCache.has(t)}setCachedPlanRecord(t,s){this.planExecutionCache.set(t,s),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${t}`)}clearCachedPlanRecord(t){const s=this.planExecutionCache.delete(t);return s&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${t}`),s}clearAllCachedRecords(){const t=this.planExecutionCache.size,s=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${t}, UI States: ${s}`)}static getInstance(){return ge.instance||(ge.instance=new ge),ge.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(t){this.callbacks={...this.callbacks,...t},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(t))}async handleUserMessageSendRequested(t){if(this.validateAndPrepareUIForNewRequest(t))try{if(await this.sendUserMessageAndSetPlanId(t),this.state.activePlanId)this.initiatePlanExecutionSequence(t,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(s){console.error("[PlanExecutionManager] Failed to send user message:",s);const c=this.state.activePlanId??"error";this.setCachedUIState(c,{enabled:!0}),this.emitChatInputUpdateState(c),this.state.activePlanId=null}}handlePlanExecutionRequested(t,s){console.log("[PlanExecutionManager] Received plan execution request:",{planId:t,query:s}),t?(this.state.activePlanId=t,this.initiatePlanExecutionSequence(s??"执行计划",t)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(t,s){const c=this.getCachedPlanRecord(t);return c!=null&&c.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${t}`),this.handlePlanExecutionRequested(c.currentPlanId,s),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${t}`),!1)}validateAndPrepareUIForNewRequest(t){if(!t)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const s=this.state.activePlanId??"ui-state";return this.setCachedUIState(s,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(s),!0}async sendUserMessageAndSetPlanId(t){try{const s=await Ve.sendMessage(t);if(s!=null&&s.planId)return this.state.activePlanId=s.planId,s;if(s!=null&&s.planTemplateId)return this.state.activePlanId=s.planTemplateId,{...s,planId:s.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",s),new Error("Failed to get valid planId from API response")}catch(s){throw console.error("[PlanExecutionManager] API call failed:",s),s}}initiatePlanExecutionSequence(t,s){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${t}", planId: ${s}`);const c=s;this.emitDialogRoundStart(c),this.startPolling()}handlePlanCompletion(t){this.emitPlanCompleted(t.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await ce.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(s){console.log(`Delete plan execution record failed: ${s.message}`)}},5e3)}catch(s){console.log(`Delete plan execution record failed: ${s.message}`)}t.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(t.rootPlanId??""))}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const t=await this.getPlanDetails(this.state.activePlanId);if(!t){console.warn("[PlanExecutionManager] No details received from API");return}if(t.rootPlanId&&this.setCachedPlanRecord(t.rootPlanId,t),!t.steps||t.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(t.rootPlanId??""),this.handlePlanCompletion(t);return}this.emitPlanUpdate(t.rootPlanId??""),t.completed&&this.handlePlanCompletion(t)}catch(t){console.error("[PlanExecutionManager] Failed to poll plan status:",t)}finally{this.state.isPolling=!1}}}async getPlanDetails(t){try{const s=await Re.getDetails(t);return s!=null&&s.rootPlanId&&(this.planExecutionCache.set(s.rootPlanId,s),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${s.rootPlanId}`)),s}catch(s){return console.error("[PlanExecutionManager] Failed to get plan details:",s),null}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(t){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(t)}emitDialogRoundStart(t){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(t)}emitPlanUpdate(t){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(t)}emitPlanCompleted(t){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(t)}};F(ge,"instance",null);let Ne=ge;const Q=Ne.getInstance(),fn={class:"right-panel"},vn={class:"preview-header"},Pn={class:"preview-tabs"},bn={class:"tab-button active"},_n={class:"preview-content"},Sn={class:"step-details"},Cn={key:0,class:"step-info-fixed"},kn={key:0,class:"agent-info"},$n={class:"info-item"},En={class:"label"},yn={class:"value"},wn={class:"info-item"},In={class:"label"},xn={class:"value"},Tn={class:"info-item"},Rn={class:"label"},Dn={class:"value"},An={class:"info-item"},Ln={class:"label"},Mn={class:"value"},Nn={class:"info-item"},Un={class:"label"},Vn={class:"execution-status"},qn={class:"status-item"},On={class:"status-text"},jn={key:0},Fn={key:0,class:"think-act-steps"},Bn={class:"steps-container"},Jn={class:"step-header"},Wn={class:"step-number"},Hn={class:"think-section"},Gn={class:"think-content"},zn={class:"input"},Xn={class:"label"},Kn={class:"output"},Qn={class:"label"},Yn={key:0,class:"action-section"},Zn={class:"action-content"},es={class:"tool-info"},ts={class:"label"},ns={class:"value"},ss={class:"input"},os={class:"label"},as={class:"output"},is={class:"label"},ls={key:0,class:"sub-plan-section"},cs={class:"sub-plan-content"},rs={class:"sub-plan-header"},us={class:"sub-plan-info"},ds={class:"value"},ps={key:0,class:"sub-plan-info"},hs={class:"value"},gs={class:"sub-plan-status"},ms={class:"status-text"},fs={key:0,class:"no-steps-message"},vs={key:1,class:"no-execution-message"},Ps={class:"step-basic-info"},bs={class:"info-item"},_s={class:"label"},Ss={class:"value"},Cs={key:0,class:"info-item"},ks={class:"value"},$s={class:"info-item"},Es={class:"no-execution-hint"},ys={key:2,class:"execution-indicator"},ws={class:"execution-text"},Is={key:1,class:"no-selection"},xs=["title"],Ts=ke({__name:"index",setup(B,{expose:t}){const{t:s}=$e(),c=q(),_=q(),r=q(),y=q(null),C=q(!1),G=q(!0),D=q(!0),X=ve(()=>r.value?r.value.completed?s("rightPanel.status.completed"):r.value.current?s("rightPanel.status.executing"):s("rightPanel.status.waiting"):""),u=v=>{var x;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${v}`),r.value&&y.value){const R=y.value.rootPlanId??_.value;if(R&&R!==v){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${R}, Requested: ${v}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${v}`);const P=Q.getCachedPlanRecord(v);if(!P){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${v}`);return}if(P.steps&&P.steps.length>0){const R=P.steps.length,S=(P.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${S} / ${R}`)}if(r.value&&_.value&&(_.value===v||((x=y.value)==null?void 0:x.rootPlanId)===v)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${v}`),y.value)){const S=y.value,w=k(S.planId,S.rootPlanId,S.subPlanId);w?(H(w,S.stepIndex,S.planId,S.isSubPlan),Z()):console.warn("[RightPanel] Could not find plan record for refresh:",S)}},f=(v,P,x,R,S)=>{console.log("[RightPanel] Step selected:",{planId:v,stepIndex:P,rootPlanId:x,subPlanId:R,subStepIndex:S});const w=!!(x&&R&&S!==void 0);y.value={planId:v,stepIndex:P,isSubPlan:w,...w&&{rootPlanId:x,subPlanId:R,subStepIndex:S}};const z=k(v,x,R);if(!z){console.warn("[RightPanel] Plan data not found:",{planId:v,rootPlanId:x,subPlanId:R}),r.value=null,y.value=null;return}H(z,P,v,w)},k=(v,P,x)=>{var w;if(!P||!x)return Q.getCachedPlanRecord(v)??null;const R=Q.getCachedPlanRecord(v);if(R)return R;const S=Q.getCachedPlanRecord(P);if(!(S!=null&&S.agentExecutionSequence))return null;for(const z of S.agentExecutionSequence)if(z.thinkActSteps){for(const ae of z.thinkActSteps)if(((w=ae.subPlanExecutionRecord)==null?void 0:w.currentPlanId)===x)return ae.subPlanExecutionRecord}return null},H=(v,P,x,R)=>{var b,V,J,ue,Ie;if(!v.steps||P>=v.steps.length){r.value=null,y.value=null,console.warn("[RightPanel] Invalid step data:",{planId:x,stepIndex:P,hasSteps:!!v.steps,stepsLength:(b=v.steps)==null?void 0:b.length,message:"Invalid step index"});return}_.value=x;const S=v.steps[P],w=(V=v.agentExecutionSequence)==null?void 0:V[P];console.log("[RightPanel] Step data details:",{planId:x,stepIndex:P,step:S,hasAgentExecutionSequence:!!v.agentExecutionSequence,agentExecutionSequenceLength:(J=v.agentExecutionSequence)==null?void 0:J.length,agentExecution:w,hasThinkActSteps:!!(w!=null&&w.thinkActSteps),thinkActStepsLength:(ue=w==null?void 0:w.thinkActSteps)==null?void 0:ue.length,isSubPlan:R});const z=(w==null?void 0:w.status)==="FINISHED",ae=!z&&P===v.currentStepIndex&&!v.completed,m={planId:x,index:P,title:typeof S=="string"?S:S.title||S.description||S.name||`${R?"子":""}步骤 ${P+1}`,description:typeof S=="string"?S:S.description||S,completed:z,current:ae};w&&(m.agentExecution=w),r.value=m,console.log("[RightPanel] Step details updated:",{planId:x,stepIndex:P,stepTitle:r.value.title,hasAgentExecution:!!w,hasThinkActSteps:(((Ie=w==null?void 0:w.thinkActSteps)==null?void 0:Ie.length)??0)>0,completed:z,current:ae,planCurrentStep:v.currentStepIndex,planCompleted:v.completed,isSubPlan:R}),w!=null&&w.thinkActSteps&&w.thinkActSteps.forEach((xe,De)=>{xe.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${De}:`,xe.subPlanExecutionRecord)}),setTimeout(()=>{Y()},100),Z()},ee=(v,P,x,R)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:v,subPlanId:P,stepIndex:x,subStepIndex:R}),f(P,R,v,P,R)},re=v=>{c.value=v??void 0},Y=()=>{if(!c.value)return;const{scrollTop:v,scrollHeight:P,clientHeight:x}=c.value,R=P-v-x<50,S=P>x;G.value=R,C.value=S&&!R,R?D.value=!0:P-v-x>100&&(D.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:v,scrollHeight:P,clientHeight:x,isAtBottom:R,hasScrollableContent:S,showButton:C.value,shouldAutoScroll:D.value})},j=()=>{c.value&&(c.value.scrollTo({top:c.value.scrollHeight,behavior:"smooth"}),ie(()=>{D.value=!0,Y()}))},Z=()=>{!D.value||!c.value||ie(()=>{c.value&&(c.value.scrollTop=c.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},te=v=>{if(v===null||typeof v>"u"||v==="")return"N/A";try{const P=typeof v=="object"?v:JSON.parse(v);return JSON.stringify(P,null,2)}catch{return String(v)}},Pe=()=>{r.value=null,_.value=void 0,D.value=!0,c.value&&c.value.removeEventListener("scroll",Y)},be=()=>{const v=()=>{const P=c.value;return P?(re(P),P.addEventListener("scroll",Y),D.value=!0,Y(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};ie(()=>{v()||setTimeout(()=>{v()},100)})};return Ee(()=>{console.log("[RightPanel] Component mounted"),ie(()=>{be()})}),ye(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),y.value=null,Pe()}),t({updateDisplayedPlanProgress:u,handleStepSelected:f,handleSubPlanStepSelected:ee}),(v,P)=>{var x,R;return p(),g("div",fn,[e("div",vn,[e("div",Pn,[e("button",bn,[$(a(E),{icon:"carbon:events"}),K(" "+l(a(s)("rightPanel.stepExecutionDetails")),1)])])]),e("div",_n,[e("div",Sn,[r.value?(p(),g("div",Cn,[e("h3",null,l(r.value.title||r.value.description||a(s)("rightPanel.defaultStepTitle",{number:r.value.index+1})),1),r.value.agentExecution?(p(),g("div",kn,[e("div",$n,[e("span",En,l(a(s)("rightPanel.executingAgent"))+":",1),e("span",yn,l(r.value.agentExecution.agentName),1)]),e("div",wn,[e("span",In,l(a(s)("rightPanel.description"))+":",1),e("span",xn,l(r.value.agentExecution.agentDescription||""),1)]),e("div",Tn,[e("span",Rn,l(a(s)("rightPanel.callingModel"))+":",1),e("span",Dn,l(r.value.agentExecution.modelName),1)]),e("div",An,[e("span",Ln,l(a(s)("rightPanel.request"))+":",1),e("span",Mn,l(r.value.agentExecution.agentRequest||""),1)]),e("div",Nn,[e("span",Un,l(a(s)("rightPanel.executionResult"))+":",1),e("span",{class:oe(["value",{success:r.value.agentExecution.status==="FINISHED"}])},l(r.value.agentExecution.status||a(s)("rightPanel.executing")),3)])])):O("",!0),e("div",Vn,[e("div",qn,[r.value.completed?(p(),_e(a(E),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):r.value.current?(p(),_e(a(E),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(p(),_e(a(E),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",On,l(X.value),1)])])])):O("",!0),e("div",{ref_key:"scrollContainer",ref:c,class:"step-details-scroll-container",onScroll:Y},[r.value?(p(),g("div",jn,[(x=r.value.agentExecution)!=null&&x.thinkActSteps&&r.value.agentExecution.thinkActSteps.length>0?(p(),g("div",Fn,[e("h4",null,l(a(s)("rightPanel.thinkAndActionSteps")),1),e("div",Bn,[(p(!0),g(me,null,fe(r.value.agentExecution.thinkActSteps,(S,w)=>(p(),g("div",{key:w,class:"think-act-step"},[e("div",Jn,[e("span",Wn,"#"+l(w+1),1),e("span",{class:oe(["step-status",S.status])},l(S.status||a(s)("rightPanel.executing")),3)]),e("div",Hn,[e("h5",null,[$(a(E),{icon:"carbon:thinking"}),K(" "+l(a(s)("rightPanel.thinking")),1)]),e("div",Gn,[e("div",zn,[e("span",Xn,l(a(s)("rightPanel.input"))+":",1),e("pre",null,l(te(S.thinkInput)),1)]),e("div",Kn,[e("span",Qn,l(a(s)("rightPanel.output"))+":",1),e("pre",null,l(te(S.thinkOutput)),1)])])]),S.actionNeeded?(p(),g("div",Yn,[e("h5",null,[$(a(E),{icon:"carbon:play"}),K(" "+l(a(s)("rightPanel.action")),1)]),e("div",Zn,[(p(!0),g(me,null,fe(S.actToolInfoList,(z,ae)=>(p(),g("div",{key:ae},[e("div",es,[e("span",ts,l(a(s)("rightPanel.tool"))+":",1),e("span",ns,l(z.name||""),1)]),e("div",ss,[e("span",os,l(a(s)("rightPanel.toolParameters"))+":",1),e("pre",null,l(te(z.parameters)),1)]),e("div",as,[e("span",is,l(a(s)("rightPanel.executionResult"))+":",1),e("pre",null,l(te(z.result)),1)])]))),128))]),S.subPlanExecutionRecord?(p(),g("div",ls,[e("h5",null,[$(a(E),{icon:"carbon:tree-view"}),K(" "+l(a(s)("rightPanel.subPlan")),1)]),e("div",cs,[e("div",rs,[e("div",us,[P[0]||(P[0]=e("span",{class:"label"},"子计划ID:",-1)),e("span",ds,l(S.subPlanExecutionRecord.currentPlanId),1)]),S.subPlanExecutionRecord.title?(p(),g("div",ps,[P[1]||(P[1]=e("span",{class:"label"},"标题:",-1)),e("span",hs,l(S.subPlanExecutionRecord.title),1)])):O("",!0),e("div",gs,[S.subPlanExecutionRecord.completed?(p(),_e(a(E),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(p(),_e(a(E),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",ms,l(S.subPlanExecutionRecord.completed?"已完成":"执行中"),1)])])])])):O("",!0)])):O("",!0)]))),128))]),r.value.agentExecution&&!((R=r.value.agentExecution.thinkActSteps)!=null&&R.length)?(p(),g("div",fs,[e("p",null,l(a(s)("rightPanel.noStepDetails")),1)])):r.value.agentExecution?O("",!0):(p(),g("div",vs,[$(a(E),{icon:"carbon:information",class:"info-icon"}),e("h4",null,l(a(s)("rightPanel.stepInfo")),1),e("div",Ps,[e("div",bs,[e("span",_s,l(a(s)("rightPanel.stepName"))+":",1),e("span",Ss,l(r.value.title||r.value.description||`步骤 ${r.value.index+1}`),1)]),r.value.description?(p(),g("div",Cs,[P[2]||(P[2]=e("span",{class:"label"},"描述:",-1)),e("span",ks,l(r.value.description),1)])):O("",!0),e("div",$s,[P[3]||(P[3]=e("span",{class:"label"},"状态:",-1)),e("span",{class:oe(["value",{"status-completed":r.value.completed,"status-current":r.value.current,"status-pending":!r.value.completed&&!r.value.current}])},l(r.value.completed?"已完成":r.value.current?"执行中":"待执行"),3)])]),e("p",Es,l(a(s)("rightPanel.noExecutionInfo")),1)])),r.value.current&&!r.value.completed?(p(),g("div",ys,[P[4]||(P[4]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",ws,[$(a(E),{icon:"carbon:in-progress",class:"rotating-icon"}),K(" "+l(a(s)("rightPanel.stepExecuting")),1)])])):O("",!0)])):(p(),g("div",Is,[$(a(E),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,l(a(s)("rightPanel.noStepSelected")),1),e("p",null,l(a(s)("rightPanel.selectStepHint")),1)]))])):O("",!0),$(ct,{name:"scroll-button"},{default:rt(()=>[C.value?(p(),g("button",{key:0,onClick:j,class:"scroll-to-bottom-btn",title:a(s)("rightPanel.scrollToBottom")},[$(a(E),{icon:"carbon:chevron-down"})],8,xs)):O("",!0)]),_:1})],544)])])])}}}),Rs=we(Ts,[["__scopeId","data-v-e90596ce"]]);function Ds(){const B=Q,t=ve(()=>B.getActivePlanId()),s=ve(()=>B.getState()),c=ve(()=>s.value.isPolling),_=ve(()=>!!t.value),r=(D,X)=>{B.initiatePlanExecutionSequence(D,X)},y=()=>{B.stopPolling()},C=()=>{B.startPolling()},G=()=>{B.cleanup()};return ye(()=>{G()}),{activePlanId:t,state:s,isPolling:c,hasActivePlan:_,startExecution:r,stopPolling:y,startPolling:C,cleanup:G}}const As={class:"chat-container"},Ls={class:"message-content"},Ms={key:0,class:"user-message"},Ns={key:1,class:"assistant-message"},Us={key:0,class:"thinking-section"},Vs={class:"thinking-header"},qs={class:"thinking-avatar"},Os={class:"thinking-label"},js={class:"thinking-content"},Fs={key:0,class:"thinking"},Bs={key:1,class:"progress"},Js={class:"progress-bar"},Ws={class:"progress-text"},Hs={key:2,class:"steps-container"},Gs={class:"steps-title"},zs=["onClick"],Xs={class:"section-header"},Ks={class:"step-icon"},Qs={class:"step-title"},Ys={key:0,class:"step-status current"},Zs={key:1,class:"step-status completed"},eo={key:2,class:"step-status pending"},to={key:0,class:"action-info"},no={class:"action-description"},so={class:"action-icon"},oo={key:0,class:"tool-params"},ao={class:"param-label"},io={class:"param-content"},lo={key:1,class:"think-details"},co={class:"think-header"},ro={class:"think-label"},uo={class:"think-output"},po={class:"think-content"},ho={key:1,class:"sub-plan-steps"},go={class:"sub-plan-header"},mo={class:"sub-plan-step-list"},fo=["onClick"],vo={class:"sub-step-indicator"},Po={class:"sub-step-icon"},bo={class:"sub-step-number"},_o={class:"sub-step-content"},So={class:"sub-step-title"},Co={key:2,class:"user-input-form-container"},ko={class:"user-input-message"},$o={key:0,class:"form-description"},Eo=["onSubmit"],yo=["for"],wo=["id","name","onUpdate:modelValue"],Io={key:1,class:"form-group"},xo={for:"form-input-genericInput"},To=["onUpdate:modelValue"],Ro={type:"submit",class:"submit-user-input-btn"},Do={key:3,class:"user-confirm-plan-form-container"},Ao=["onSubmit"],Lo={class:"form-group"},Mo={class:"radio-group"},No={key:4,class:"default-processing"},Uo={class:"processing-indicator"},Vo={key:1,class:"response-section"},qo={class:"response-header"},Oo={class:"response-avatar"},jo={class:"response-name"},Fo={class:"response-content"},Bo={key:0,class:"final-response"},Jo=["innerHTML"],Wo={key:1,class:"response-placeholder"},Ho={class:"typing-indicator"},Go={class:"typing-text"},zo={key:0,class:"message assistant"},Xo={class:"message-content"},Ko={class:"assistant-message"},Qo={class:"thinking-section"},Yo={class:"thinking-header"},Zo={class:"thinking-avatar"},ea={class:"thinking-label"},ta={class:"thinking-content"},na={class:"default-processing"},sa={class:"processing-indicator"},oa={class:"response-section"},aa={class:"response-header"},ia={class:"response-avatar"},la={class:"response-name"},ca={class:"response-content"},ra={class:"response-placeholder"},ua={class:"typing-indicator"},da={class:"typing-text"},pa=["title"],ha=ke({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(B,{expose:t,emit:s}){const c=B,_=s,{t:r}=$e(),y=Ds(),C=q(),G=q(!1),D=q([]),X=q(),u=q(!1),f=Ue({}),k=q(),H=(o,n,i)=>{const d={id:Date.now().toString(),type:o,content:n,timestamp:new Date,...i};return o==="assistant"&&!d.thinking&&!d.content&&(d.thinking=r("chat.thinking")),D.value.push(d),d},ee=o=>{const n=D.value[D.value.length-1];n.type==="assistant"&&Object.assign(n,o)},re=async o=>{try{G.value=!0;const n=H("assistant","",{thinking:"正在理解您的请求并准备回复..."}),i=await Ve.sendMessage(o);if(i.planId)console.log("[ChatComponent] Received planId from direct execution:",i.planId),n.planExecution||(n.planExecution={}),n.planExecution.currentPlanId=i.planId,Q.handlePlanExecutionRequested(i.planId,o),delete n.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete n.thinking;const d=Y(i,o);n.content=d}}catch(n){console.error("Direct mode error:",n),ee({content:j(n)})}finally{G.value=!1}},Y=(o,n)=>o.result??o.message??o.content??"",j=o=>{const n=(o==null?void 0:o.message)??(o==null?void 0:o.toString())??"未知错误";return n.includes("网络")||n.includes("network")||n.includes("timeout")?"抱歉，似乎网络连接有些问题。请检查您的网络连接后再试一次，或者稍等几分钟再重新提问。":n.includes("认证")||n.includes("权限")||n.includes("auth")?"抱歉，访问权限出现了问题。这可能是系统配置的问题，请联系管理员或稍后再试。":n.includes("格式")||n.includes("参数")||n.includes("invalid")?"抱歉，您的请求格式可能有些问题。能否请您重新表述一下您的需求？我会尽力理解并帮助您。":`抱歉，处理您的请求时遇到了一些问题（${n}）。请稍后再试，或者换个方式表达您的需求，我会尽力帮助您的。`},Z=(o=!1)=>{ie(()=>{if(C.value){const n=C.value;(o||n.scrollHeight-n.scrollTop-n.clientHeight<150)&&n.scrollTo({top:n.scrollHeight,behavior:o?"auto":"smooth"})}})},te=()=>{Z(!0),u.value=!1},Pe=()=>{if(C.value){const o=C.value,n=o.scrollHeight-o.scrollTop-o.clientHeight<150;u.value=!n&&D.value.length>0}},be=()=>{C.value&&C.value.addEventListener("scroll",Pe)},v=()=>{C.value&&C.value.removeEventListener("scroll",Pe)},P=o=>{H("user",o),c.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",o):re(o)},x=(o,n)=>{var A;const i=((A=o.planExecution)==null?void 0:A.agentExecutionSequence)??[];return n<0||n>=i.length?"IDLE":i[n].status??"IDLE"},R=(o,n)=>{var i,d;if(!((i=o.planExecution)!=null&&i.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:o.planExecution.currentPlanId,stepIndex:n,stepTitle:(d=o.planExecution.steps)==null?void 0:d[n]}),_("step-selected",o.planExecution.currentPlanId,n)},S=(o,n)=>{var i;try{const d=(i=o.planExecution)==null?void 0:i.agentExecutionSequence;if(!(d!=null&&d.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const A=d[n];if(!A)return console.log(`[ChatComponent] No agentExecution found for step ${n}`),[];if(!A.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${n}`),[];for(const T of A.thinkActSteps)if(T.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${n}:`,T.subPlanExecutionRecord),(T.subPlanExecutionRecord.steps??[]).map(L=>typeof L=="string"?L:typeof L=="object"&&L!==null&&(L.title||L.description)||"子步骤");return[]}catch(d){return console.warn("[ChatComponent] Error getting sub-plan steps:",d),[]}},w=(o,n,i)=>{var d;try{const A=(d=o.planExecution)==null?void 0:d.agentExecutionSequence;if(!(A!=null&&A.length))return"pending";const T=A[n];if(!T||!T.thinkActSteps)return"pending";let W=null;for(const M of T.thinkActSteps)if(M.subPlanExecutionRecord){W=M.subPlanExecutionRecord;break}if(!W)return"pending";const L=W.currentStepIndex;return W.completed?"completed":L==null?i===0?"current":"pending":i<L?"completed":i===L?"current":"pending"}catch(A){return console.warn("[ChatComponent] Error getting sub-plan step status:",A),"pending"}},z=(o,n,i)=>{var d,A;try{const T=(d=o.planExecution)==null?void 0:d.agentExecutionSequence;if(!(T!=null&&T.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const W=T[n];if(!W){console.warn("[ChatComponent] No agentExecution found for step",n);return}if(!W.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",n);return}let L=null;for(const M of W.thinkActSteps)if(M.subPlanExecutionRecord){L=M.subPlanExecutionRecord;break}if(!(L!=null&&L.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}_("sub-plan-step-selected",((A=o.planExecution)==null?void 0:A.currentPlanId)??"",L.currentPlanId,n,i)}catch(T){console.error("[ChatComponent] Error handling sub-plan step click:",T)}},ae=(o,n)=>{var d,A,T,W;if(!((d=o.planExecution)!=null&&d.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",o.planExecution.steps.length,"execution sequence:",((A=n.agentExecutionSequence)==null?void 0:A.length)??0);const i=new Array(o.planExecution.steps.length).fill(null);if((T=n.agentExecutionSequence)!=null&&T.length){const L=Math.min(n.agentExecutionSequence.length,o.planExecution.steps.length);for(let M=0;M<L;M++){const I=n.agentExecutionSequence[M];if((W=I.thinkActSteps)!=null&&W.length){const N=I.thinkActSteps[I.thinkActSteps.length-1];N.actionDescription&&N.toolParameters?(i[M]={actionDescription:N.actionDescription,toolParameters:typeof N.toolParameters=="string"?N.toolParameters:JSON.stringify(N.toolParameters,null,2),thinkInput:N.thinkInput??"",thinkOutput:N.thinkOutput??"",status:n.currentStepIndex!==void 0&&M<n.currentStepIndex?"completed":n.currentStepIndex!==void 0&&M===n.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${M} action set: ${i[M].actionDescription}`)):(i[M]={actionDescription:"思考中",toolParameters:"等待决策",thinkInput:N.thinkInput??"",thinkOutput:N.thinkOutput??"",status:n.currentStepIndex!==void 0&&M===n.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${M} is thinking`))}else i[M]={actionDescription:n.currentStepIndex!==void 0&&M<n.currentStepIndex?"已完成":"等待中",toolParameters:"无工具参数",thinkInput:"",thinkOutput:"",status:n.currentStepIndex!==void 0&&M<n.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] 步骤 ${M} 无执行细节, 状态设为: ${i[M].status}`)}}else console.log("[ChatComponent] 没有执行序列数据");o.stepActions=[...i],console.log("[ChatComponent] 步骤动作更新完成:",JSON.stringify(i.map(L=>L==null?void 0:L.actionDescription))),ie(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},m=o=>{console.log("[ChatComponent] Starting dialog round with planId:",o),o&&(D.value.findIndex(i=>{var d;return((d=i.planExecution)==null?void 0:d.currentPlanId)===o&&i.type==="assistant"})===-1?(H("assistant","",{planExecution:{currentPlanId:o},thinking:"正在准备执行计划..."}),console.log("[ChatComponent] Created new assistant message for planId:",o)):console.log("[ChatComponent] Found existing assistant message for planId:",o))},b=o=>{var T,W,L,M;console.log("[ChatComponent] Processing plan update with rootPlanId:",o);const n=Q.getCachedPlanRecord(o);if(!n){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",o);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",n),console.log("[ChatComponent] Plan steps:",n.steps),console.log("[ChatComponent] Plan completed:",n.completed),!n.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const i=D.value.findIndex(I=>{var N;return((N=I.planExecution)==null?void 0:N.currentPlanId)===n.currentPlanId&&I.type==="assistant"});let d;if(i!==-1)d=D.value[i],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",n.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",n.currentPlanId),console.log("[ChatComponent] Current messages:",D.value.map(N=>{var ne;return{type:N.type,planId:(ne=N.planExecution)==null?void 0:ne.currentPlanId,content:N.content.substring(0,50)}}));let I=-1;for(let N=D.value.length-1;N>=0;N--)if(D.value[N].type==="assistant"){I=N;break}if(I!==-1)d=D.value[I],d.planExecution||(d.planExecution={}),d.planExecution.currentPlanId=n.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",n.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(d.planExecution||(d.planExecution={}),d.planExecution=JSON.parse(JSON.stringify(n)),!n.steps||n.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),n.completed){delete d.thinking;const I=n.summary??n.result??n.message??"处理完成";d.content=V(I),console.log("[ChatComponent] Set simple response content:",d.content)}else console.log("[ChatComponent] Handling plan execution without steps"),n.title&&(d.thinking=`正在执行: ${n.title}`);return}delete d.thinking;const A=n.steps.map(I=>typeof I=="string"?I:typeof I=="object"&&I!==null&&(I.title||I.description)||"步骤");if(d.planExecution&&(d.planExecution.steps=A),n.agentExecutionSequence&&n.agentExecutionSequence.length>0){console.log("[ChatComponent] 发现执行序列数据，数量:",n.agentExecutionSequence.length),ae(d,n);const I=n.currentStepIndex??0;if(I>=0&&I<n.agentExecutionSequence.length){const ne=n.agentExecutionSequence[I].thinkActSteps;if(ne&&ne.length>0){const he=ne[ne.length-1];if(he.thinkOutput){const de=he.thinkOutput.length>150?he.thinkOutput.substring(0,150)+"...":he.thinkOutput;d.thinking=`正在思考: ${de}`}}}}else if(d.planExecution){const I=d.planExecution.currentStepIndex??0,N=(T=d.planExecution.steps)==null?void 0:T[I],ne=typeof N=="string"?N:"";d.thinking=`正在执行: ${ne}`}if(n.userInputWaitState&&d.planExecution?(console.log("[ChatComponent] 需要用户输入:",n.userInputWaitState),d.planExecution.userInputWaitState||(d.planExecution.userInputWaitState={}),d.planExecution.userInputWaitState={message:n.userInputWaitState.message??"",formDescription:n.userInputWaitState.formDescription??"",formInputs:((W=n.userInputWaitState.formInputs)==null?void 0:W.map(I=>({label:I.label,value:I.value||""})))??[]},f[L=d.id]??(f[L]={}),d.thinking="等待用户输入..."):(M=d.planExecution)!=null&&M.userInputWaitState&&delete d.planExecution.userInputWaitState,n.acceptedPlan!=="await"?n.acceptedPlan==="accept"?(console.log("[ChatComponent] 接受计划"),d.thinking="用户确认计划"):n.acceptedPlan==="reject"&&(console.log("[ChatComponent] 拒绝计划"),d.thinking="用户拒绝计划"):d.thinking="等到用户确认中...",n.completed??n.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete d.thinking;let I="";n.summary?I=n.summary:n.result?I=n.result:I="任务已完成",d.content=J(I),console.log("[ChatComponent] Updated completed message:",d.content)}ie(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},V=o=>o?o.includes("我")||o.includes("您")||o.includes("您好")||o.includes("可以")?o:o.length<10?`${o}！还有什么需要我帮助的吗？`:o.length<50?`好的，${o}。如果您还有其他问题，请随时告诉我。`:`${o}

希望这个回答对您有帮助！还有什么我可以为您做的吗？`:"我明白了，还有什么我可以帮您的吗？",J=o=>o?`${o}`:"任务已完成！还有什么我可以帮您的吗？",ue=o=>{console.log("[ChatComponent] Plan completed with rootPlanId:",o);const n=Q.getCachedPlanRecord(o);if(!n){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",o);return}if(console.log("[ChatComponent] Plan details:",n),n.rootPlanId){const i=D.value.findIndex(d=>{var A;return((A=d.planExecution)==null?void 0:A.currentPlanId)===n.rootPlanId});if(i!==-1){const d=D.value[i];delete d.thinking;let T=n.summary??n.result??"任务已完成";!T.includes("我")&&!T.includes("您")&&(T.includes("成功")||T.includes("完成")?T=`很好！${T}。如果您还有其他需要帮助的地方，请随时告诉我。`:T=`我已经完成了您的请求：${T}`),d.content=T,console.log("[ChatComponent] Updated completed message:",d.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",n.rootPlanId)}},Ie=o=>{if(!o)return"";let n=o.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return n=n.replace(/(<br><br>)/g,"</p><p>"),n.includes("</p><p>")&&(n=`<p>${n}</p>`),n},xe=async o=>{var n;if(!((n=o.planExecution)!=null&&n.currentPlanId)||!o.planExecution.userInputWaitState){console.error("[ChatComponent] 缺少planExecution.currentPlanId或userInputWaitState");return}try{const i={},d=o.planExecution.userInputWaitState.formInputs;d&&d.length>0?Object.entries(f[o.id]).forEach(([T,W])=>{var I;const L=parseInt(T,10),M=((I=d[L])==null?void 0:I.label)||`input_${T}`;i[M]=W}):i.genericInput=o.genericInput??"",console.log("[ChatComponent] 提交用户输入:",i);const A=await Re.submitFormInput(o.planExecution.currentPlanId,i);delete o.planExecution.userInputWaitState,delete o.genericInput,delete f[o.id],y.startPolling(),console.log("[ChatComponent] 用户输入提交成功:",A)}catch(i){console.error("[ChatComponent] 用户输入提交失败:",i),alert(`提交失败: ${(i==null?void 0:i.message)||"未知错误"}`)}},De=async(o,n)=>{var i;if(!((i=o.planExecution)!=null&&i.currentPlanId)||!n){console.error("[ChatComponent] 缺少planExecution.currentPlanId或inputData");return}try{console.log("[ChatComponent] 提交用户输入:",n);const d={planId:o.planExecution.currentPlanId,accepted:n},A=await Re.submitConfirmPlan(o.planExecution.currentPlanId,d);o.thinking="操作确认中...",o.planExecution.acceptedPlan="",y.startPolling(),console.log("[ChatComponent] 用户输入提交成功:",A)}catch(d){console.error("[ChatComponent] 用户输入提交失败:",d),alert(`提交失败: ${(d==null?void 0:d.message)||"未知错误"}`)}};return Le(()=>c.initialPrompt,(o,n)=>{console.log("[ChatComponent] initialPrompt changed from:",n,"to:",o),o&&typeof o=="string"&&o.trim()&&o!==n&&(console.log("[ChatComponent] Processing changed initial prompt:",o),ie(()=>{P(o)}))},{immediate:!1}),Ee(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),Q.setEventCallbacks({onPlanUpdate:b,onPlanCompleted:ue,onDialogRoundStart:m,onChatInputUpdateState:o=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",o)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")}}),ie(()=>{be()}),c.initialPrompt&&typeof c.initialPrompt=="string"&&c.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",c.initialPrompt),ie(()=>{P(c.initialPrompt)}))}),ye(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),v(),X.value&&clearInterval(X.value),y.cleanup(),Object.keys(f).forEach(o=>delete f[o])}),t({handleSendMessage:P,handlePlanUpdate:b,handlePlanCompleted:ue,handleDialogRoundStart:m,addMessage:H}),(o,n)=>(p(),g("div",As,[e("div",{class:"messages",ref_key:"messagesRef",ref:C},[(p(!0),g(me,null,fe(D.value,i=>{var d,A,T,W,L,M,I,N,ne,he,Ae;return p(),g("div",{key:i.id,class:oe(["message",{user:i.type==="user",assistant:i.type==="assistant"}])},[e("div",Ls,[i.type==="user"?(p(),g("div",Ms,l(i.content),1)):(p(),g("div",Ns,[i.thinking||((d=i.planExecution)==null?void 0:d.progress)!==void 0||(((T=(A=i.planExecution)==null?void 0:A.steps)==null?void 0:T.length)??0)>0?(p(),g("div",Us,[e("div",Vs,[e("div",qs,[$(a(E),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Os,l(o.$t("chat.thinkingLabel")),1)]),e("div",js,[i.thinking?(p(),g("div",Fs,[$(a(E),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,l(i.thinking),1)])):O("",!0),((W=i.planExecution)==null?void 0:W.progress)!==void 0?(p(),g("div",Bs,[e("div",Js,[e("div",{class:"progress-fill",style:Me({width:i.planExecution.progress+"%"})},null,4)]),e("span",Ws,l(i.planExecution.progressText??o.$t("chat.processing")+"..."),1)])):O("",!0),(((M=(L=i.planExecution)==null?void 0:L.steps)==null?void 0:M.length)??0)>0?(p(),g("div",Hs,[e("h4",Gs,l(o.$t("chat.stepExecutionDetails")),1),(p(!0),g(me,null,fe((I=i.planExecution)==null?void 0:I.steps,(de,U)=>{var qe,Oe,je,Fe,Be,Je,We,He,Ge,ze,Xe,Ke,Qe,Ye,Ze,et,tt,nt,st;return p(),g("div",{key:U,class:oe(["ai-section",{running:x(i,U)==="RUNNING",completed:x(i,U)==="FINISHED",pending:x(i,U)==="IDLE"}]),onClick:Ce(le=>R(i,U),["stop"])},[e("div",Xs,[e("span",Ks,l(x(i,U)==="FINISHED"?"✓":x(i,U)==="RUNNING"?"▶":"○"),1),e("span",Qs,l(de||`${o.$t("chat.step")} ${U+1}`),1),x(i,U)==="RUNNING"?(p(),g("span",Ys,l(o.$t("chat.status.executing")),1)):x(i,U)==="FINISHED"?(p(),g("span",Zs,l(o.$t("chat.status.completed")),1)):(p(),g("span",eo,l(o.$t("chat.status.pending")),1))]),i.stepActions&&i.stepActions[U]?(p(),g("div",to,[e("div",no,[e("span",so,l(((qe=i.stepActions[U])==null?void 0:qe.status)==="current"?"🔄":((Oe=i.stepActions[U])==null?void 0:Oe.status)==="completed"?"✓":"⏳"),1),e("strong",null,l((je=i.stepActions[U])==null?void 0:je.actionDescription),1)]),(Fe=i.stepActions[U])!=null&&Fe.toolParameters?(p(),g("div",oo,[n[2]||(n[2]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",ao,l(o.$t("common.parameters"))+":",1),e("pre",io,l((Be=i.stepActions[U])==null?void 0:Be.toolParameters),1)])):O("",!0),(Je=i.stepActions[U])!=null&&Je.thinkOutput?(p(),g("div",lo,[e("div",co,[n[3]||(n[3]=e("span",{class:"think-icon"},"💭",-1)),e("span",ro,l(o.$t("chat.thinkingOutput"))+":",1)]),e("div",uo,[e("pre",po,l((We=i.stepActions[U])==null?void 0:We.thinkOutput),1)])])):O("",!0)])):O("",!0),((He=S(i,U))==null?void 0:He.length)>0?(p(),g("div",ho,[e("div",go,[$(a(E),{icon:"carbon:tree-view",class:"sub-plan-icon"}),n[4]||(n[4]=e("span",{class:"sub-plan-title"},"子执行计划",-1))]),e("div",mo,[(p(!0),g(me,null,fe(S(i,U),(le,se)=>(p(),g("div",{key:`sub-${U}-${se}`,class:oe(["sub-plan-step-item",{completed:w(i,U,se)==="completed",current:w(i,U,se)==="current",pending:w(i,U,se)==="pending"}]),onClick:Ce(ot=>z(i,U,se),["stop"])},[e("div",vo,[e("span",Po,l(w(i,U,se)==="completed"?"✓":w(i,U,se)==="current"?"▶":"○"),1),e("span",bo,l(se+1),1)]),e("div",_o,[e("span",So,l(le),1),n[5]||(n[5]=e("span",{class:"sub-step-badge"},"子步骤",-1))])],10,fo))),128))])])):O("",!0),(Ge=i.planExecution)!=null&&Ge.userInputWaitState&&x(i,U)==="RUNNING"?(p(),g("div",Co,[e("p",ko,l(((Xe=(ze=i.planExecution)==null?void 0:ze.userInputWaitState)==null?void 0:Xe.message)??o.$t("chat.userInput.message")),1),(Qe=(Ke=i.planExecution)==null?void 0:Ke.userInputWaitState)!=null&&Qe.formDescription?(p(),g("p",$o,l((Ze=(Ye=i.planExecution)==null?void 0:Ye.userInputWaitState)==null?void 0:Ze.formDescription),1)):O("",!0),e("form",{onSubmit:Ce(le=>xe(i),["prevent"]),class:"user-input-form"},[(tt=(et=i.planExecution)==null?void 0:et.userInputWaitState)!=null&&tt.formInputs&&i.planExecution.userInputWaitState.formInputs.length>0?(p(!0),g(me,{key:0},fe((st=(nt=i.planExecution)==null?void 0:nt.userInputWaitState)==null?void 0:st.formInputs,(le,se)=>(p(),g("div",{key:se,class:"form-group"},[e("label",{for:`form-input-${le.label.replace(/\W+/g,"_")}`},l(le.label)+": ",9,yo),pe(e("input",{type:"text",id:`form-input-${le.label.replace(/\W+/g,"_")}`,name:le.label,"onUpdate:modelValue":ot=>f[i.id][se]=ot,class:"form-input"},null,8,wo),[[Se,f[i.id][se]]])]))),128)):(p(),g("div",Io,[e("label",xo,l(o.$t("common.input"))+":",1),pe(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":le=>i.genericInput=le,class:"form-input"},null,8,To),[[Se,i.genericInput]])])),e("button",Ro,l(o.$t("chat.userInput.submit")),1)],40,Eo)])):O("",!0)],10,zs)}),128))])):O("",!0),((N=i.planExecution)==null?void 0:N.acceptedPlan)==="await"?(p(),g("div",Do,[e("form",{onSubmit:Ce(de=>De(i,k.value),["prevent"]),class:"user-confirm-plan-form"},[e("div",Lo,[n[8]||(n[8]=e("label",null,"是否接受上述计划",-1)),e("div",Mo,[e("label",null,[pe(e("input",{type:"radio","onUpdate:modelValue":n[0]||(n[0]=de=>k.value=de),value:"accept",name:"acceptPlan",required:""},null,512),[[at,k.value]]),n[6]||(n[6]=K(" 是 "))]),e("label",null,[pe(e("input",{type:"radio","onUpdate:modelValue":n[1]||(n[1]=de=>k.value=de),value:"reject",name:"acceptPlan",required:""},null,512),[[at,k.value]]),n[7]||(n[7]=K(" 否 "))])])]),n[9]||(n[9]=e("button",{type:"submit",class:"user-confirm-plan-submit-button"},"提交",-1))],40,Ao)])):!i.content&&(i.thinking||((ne=i.planExecution)==null?void 0:ne.progress)!==void 0&&(((he=i.planExecution)==null?void 0:he.progress)??0)<100)?(p(),g("div",No,[e("div",Uo,[n[10]||(n[10]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,l(i.thinking??o.$t("chat.thinkingProcessing")),1)])])):O("",!0)])])):O("",!0),((Ae=i.planExecution)==null?void 0:Ae.acceptedPlan)!=="await"?(p(),g("div",Vo,[e("div",qo,[e("div",Oo,[$(a(E),{icon:"carbon:bot",class:"bot-icon"})]),e("div",jo,l(o.$t("chat.botName")),1)]),e("div",Fo,[i.content?(p(),g("div",Bo,[e("div",{class:"response-text",innerHTML:Ie(i.content)},null,8,Jo)])):(p(),g("div",Wo,[e("div",Ho,[n[11]||(n[11]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Go,l(o.$t("chat.thinkingResponse")),1)])]))])])):O("",!0)]))])],2)}),128)),G.value?(p(),g("div",zo,[e("div",Xo,[e("div",Ko,[e("div",Qo,[e("div",Yo,[e("div",Zo,[$(a(E),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",ea,l(o.$t("chat.thinkingLabel")),1)]),e("div",ta,[e("div",na,[e("div",sa,[n[12]||(n[12]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,l(o.$t("chat.thinking")),1)])])])]),e("div",oa,[e("div",aa,[e("div",ia,[$(a(E),{icon:"carbon:bot",class:"bot-icon"})]),e("div",la,l(o.$t("chat.botName")),1)]),e("div",ca,[e("div",ra,[e("div",ua,[n[13]||(n[13]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",da,l(o.$t("chat.thinkingResponse")),1)])])])])])])])):O("",!0)],512),u.value?(p(),g("div",{key:0,class:"scroll-to-bottom-btn",onClick:te,title:o.$t("chat.scrollToBottom")},[$(a(E),{icon:"carbon:chevron-down"})],8,pa)):O("",!0)]))}}),ga=we(ha,[["__scopeId","data-v-7ca10885"]]),ma={class:"input-area"},fa={class:"input-container"},va={class:"attach-btn",title:"附加文件"},Pa=["placeholder","disabled"],ba=["title"],_a=["disabled","title"],Sa=ke({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1}},emits:["send","clear","update-state","plan-mode-clicked"],setup(B,{expose:t,emit:s}){const{t:c}=$e(),_=B,r=s,y=q(),C=q(""),G=ve(()=>_.placeholder||c("input.placeholder")),D=q(G.value),X=ve(()=>!!_.disabled),u=()=>{ie(()=>{y.value&&(y.value.style.height="auto",y.value.style.height=Math.min(y.value.scrollHeight,120)+"px")})},f=j=>{j.key==="Enter"&&!j.shiftKey&&(j.preventDefault(),k())},k=()=>{if(!C.value.trim()||X.value)return;const j=C.value.trim();r("send",j),ee()},H=()=>{r("plan-mode-clicked")},ee=()=>{C.value="",u(),r("clear")};return t({clearInput:ee,updateState:(j,Z)=>{Z&&(D.value=j?Z:c("input.waiting")),r("update-state",j,Z)},getQuery:()=>C.value.trim(),focus:()=>{var j;return(j=y.value)==null?void 0:j.focus()}}),Ee(()=>{}),ye(()=>{}),(j,Z)=>(p(),g("div",ma,[e("div",fa,[e("button",va,[$(a(E),{icon:"carbon:attachment"})]),pe(e("textarea",{"onUpdate:modelValue":Z[0]||(Z[0]=te=>C.value=te),ref_key:"inputRef",ref:y,class:"chat-input",placeholder:D.value,disabled:X.value,onKeydown:f,onInput:u},null,40,Pa),[[Se,C.value]]),e("button",{class:"plan-mode-btn",title:j.$t("input.planMode"),onClick:H},[$(a(E),{icon:"carbon:document"}),K(" "+l(j.$t("input.planMode")),1)],8,ba),e("button",{class:"send-button",disabled:!C.value.trim()||X.value,onClick:k,title:j.$t("input.send")},[$(a(E),{icon:"carbon:send-alt"}),K(" "+l(j.$t("input.send")),1)],8,_a)])]))}}),Ca=we(Sa,[["__scopeId","data-v-c8e17afe"]]),ka={class:"direct-page"},$a={class:"direct-chat"},Ea={class:"chat-header"},ya={class:"header-actions"},wa=["title"],Ia={class:"chat-content"},xa=["title"],Ta=ke({__name:"index",setup(B){const t=ut(),s=dt(),c=ht(),{t:_}=$e(),r=q(""),y=q(),C=q(),G=q(),D=q(!1),X=q(!1),u=q(null),f=q(50),k=q(!1),H=q(0),ee=q(0);Ee(()=>{console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",c.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",c.hasUnprocessedTask()),Q.setEventCallbacks({onPlanUpdate:b=>{console.log("[Direct] Plan update event received for rootPlanId:",b),te(b)&&(console.log("[Direct] Processing plan update for current rootPlanId:",b),C.value&&typeof C.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",b),C.value.handlePlanUpdate(b)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),y.value&&typeof y.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",b),y.value.updateDisplayedPlanProgress(b)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:b=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",b),!!te(b)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",b),C.value&&typeof C.value.handlePlanCompleted=="function"){const V=Q.getCachedPlanRecord(b);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",V),C.value.handlePlanCompleted(V??{planId:b})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");u.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:b=>{console.log("[Direct] Dialog round start event received for rootPlanId:",b),u.value=b,console.log("[Direct] Set currentRootPlanId to:",b),C.value&&typeof C.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",b),C.value.handleDialogRoundStart(b)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),be()},onChatInputUpdateState:b=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",b),!te(b,!0))return;const V=Q.getCachedUIState(b);V&&P(V.enabled,V.placeholder)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),h.loadPlanTemplateList(),c.hasUnprocessedTask()&&c.currentTask?(r.value=c.currentTask.prompt,console.log("[Direct] Setting prompt from store:",r.value),c.markTaskAsProcessed(),console.log("[Direct] Received task from store:",r.value)):(r.value=t.query.prompt||"",console.log("[Direct] Received task from URL:",r.value),console.log("[Direct] No unprocessed task in store"));const m=localStorage.getItem("directPanelWidth");m&&(f.value=parseFloat(m)),console.log("[Direct] Final prompt value:",r.value)}),Le(()=>c.currentTask,m=>{console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",m),m&&!m.processed?(r.value=m.prompt,c.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",r.value)):console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),Le(()=>r.value,(m,b)=>{console.log("[Direct] prompt value changed from:",b,"to:",m)},{immediate:!1}),ye(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),u.value=null,Q.cleanup(),document.removeEventListener("mousemove",Y),document.removeEventListener("mouseup",j)});const re=m=>{k.value=!0,H.value=m.clientX,ee.value=f.value,document.addEventListener("mousemove",Y),document.addEventListener("mouseup",j),document.body.style.cursor="col-resize",document.body.style.userSelect="none",m.preventDefault()},Y=m=>{if(!k.value)return;const b=window.innerWidth,J=(m.clientX-H.value)/b*100;let ue=ee.value+J;ue=Math.max(20,Math.min(80,ue)),f.value=ue},j=()=>{k.value=!1,document.removeEventListener("mousemove",Y),document.removeEventListener("mouseup",j),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",f.value.toString())},Z=()=>{f.value=50,localStorage.setItem("directPanelWidth","50")},te=(m,b=!1)=>!u.value||m===u.value||b&&(m==="ui-state"||m==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",m,"current:",u.value),!1),Pe=m=>{console.log("[DirectView] Send message from input:",m),C.value&&typeof C.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",m),C.value.handleSendMessage(m)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},be=()=>{console.log("[DirectView] Input cleared"),G.value&&typeof G.value.clear=="function"&&G.value.clear()},v=()=>{console.log("[DirectView] Input focused")},P=(m,b)=>{console.log("[DirectView] Input state updated:",m,b),X.value=!m},x=(m,b)=>{console.log("[DirectView] Step selected:",m,b),y.value&&typeof y.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",m,b),y.value.handleStepSelected(m,b)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},R=(m,b,V,J)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:m,subPlanId:b,stepIndex:V,subStepIndex:J}),y.value&&typeof y.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:m,subPlanId:b,stepIndex:V,subStepIndex:J}),y.value.handleSubPlanStepSelected(m,b,V,J)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},S=()=>{console.log("[DirectView] Plan mode button clicked"),h.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",h.isCollapsed)},w=()=>{s.push("/home")},z=()=>{s.push("/configs")},ae=async m=>{var b;if(console.log("[DirectView] Plan execution requested:",m),D.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}D.value=!0,C.value&&typeof C.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",m.title),C.value.addMessage("user",m.title)):console.warn("[DirectView] chatRef.addMessage method not available");try{const V=m.planData.planTemplateId||m.planData.planId;if(!V)throw new Error("没有找到计划模板ID");console.log("[Direct] Executing plan with templateId:",V,"params:",m.params),console.log("[Direct] About to call PlanActApiService.executePlan");let J;if((b=m.params)!=null&&b.trim()?(console.log("[Direct] Calling executePlan with params:",m.params.trim()),J=await ce.executePlan(V,m.params.trim())):(console.log("[Direct] Calling executePlan without params"),J=await ce.executePlan(V)),console.log("[Direct] Plan execution API response:",J),J.planId)console.log("[Direct] Got planId from response:",J.planId,"starting plan execution"),u.value=J.planId,console.log("[Direct] Set currentRootPlanId to:",J.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),Q.handlePlanExecutionRequested(J.planId,m.title);else throw console.error("[Direct] No planId in response:",J),new Error("执行计划失败：未返回有效的计划ID")}catch(V){console.error("[Direct] Plan execution failed:",V),console.error("[Direct] Error details:",{message:V.message,stack:V.stack}),u.value=null,C.value&&typeof C.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),C.value.addMessage("user",m.title),C.value.addMessage("assistant",`执行计划失败: ${V.message||"未知错误"}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`执行计划失败: ${V.message||"未知错误"}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),D.value=!1}};return(m,b)=>(p(),g("div",ka,[e("div",$a,[$(mn,{onPlanExecutionRequested:ae}),e("div",{class:"left-panel",style:Me({width:f.value+"%"})},[e("div",Ea,[e("button",{class:"back-button",onClick:w},[$(a(E),{icon:"carbon:arrow-left"})]),e("h2",null,l(m.$t("conversation")),1),e("div",ya,[$(pt),e("button",{class:"config-button",onClick:z,title:m.$t("direct.configuration")},[$(a(E),{icon:"carbon:settings-adjust",width:"20"})],8,wa)])]),e("div",Ia,[$(ga,{ref_key:"chatRef",ref:C,mode:"direct","initial-prompt":r.value||"",onStepSelected:x,onSubPlanStepSelected:R},null,8,["initial-prompt"])]),(p(),_e(Ca,{key:m.$i18n.locale,ref_key:"inputRef",ref:G,disabled:X.value,placeholder:X.value?a(_)("input.waiting"):a(_)("input.placeholder"),onSend:Pe,onClear:be,onFocus:v,onUpdateState:P,onPlanModeClicked:S},null,8,["disabled","placeholder"]))],4),e("div",{class:"panel-resizer",onMousedown:re,onDblclick:Z,title:m.$t("direct.panelResizeHint")},b[0]||(b[0]=[e("div",{class:"resizer-line"},null,-1)]),40,xa),$(Rs,{ref_key:"rightPanelRef",ref:y,style:Me({width:100-f.value+"%"})},null,8,["style"])])]))}}),Na=we(Ta,[["__scopeId","data-v-e22ae6d7"]]);export{Na as default};
