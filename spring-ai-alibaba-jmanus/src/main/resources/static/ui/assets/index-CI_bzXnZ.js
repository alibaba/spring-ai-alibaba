var ot=Object.defineProperty;var lt=(V,s,l)=>s in V?ot(V,s,{enumerable:!0,configurable:!0,writable:!0,value:l}):V[s]=l;var te=(V,s,l)=>lt(V,typeof s!="symbol"?s+"":s,l);import{m as it,r as T,g as ne,d as Pe,f as be,h as Se,c as b,o as m,p as ee,u as c,e,b as W,t as u,i as y,q as Y,F as he,j as ge,s as $e,w as ve,v as me,x as ct,k as ie,y as _e,a as fe,T as rt,z as ut,n as Ce,A as dt,B as st,l as pt}from"./index-BZbJwECV.js";import{I as w,_ as ke}from"./_plugin-vue_export-helper-XLqeYZ5Y.js";import{L as ht}from"./index-BYo4zL21.js";import{u as gt}from"./task-Sj5Oy37R.js";class oe{static async generatePlan(s,l){const r={query:s};l&&(r.existingJson=l);const a=await fetch(`${this.PLAN_TEMPLATE_URL}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!a.ok)throw new Error(`Failed to generate plan: ${a.status}`);const h=await a.json();if(h.planJson)try{h.plan=JSON.parse(h.planJson)}catch{h.plan={error:"Unable to parse plan data"}}return h}static async executePlan(s,l){console.log("[PlanActApiService] executePlan called with:",{planTemplateId:s,rawParam:l});const r={planTemplateId:s};l&&(r.rawParam=l),console.log("[PlanActApiService] Making request to:",`${this.PLAN_TEMPLATE_URL}/executePlanByTemplateId`),console.log("[PlanActApiService] Request body:",r);const a=await fetch(`${this.PLAN_TEMPLATE_URL}/executePlanByTemplateId`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(console.log("[PlanActApiService] Response status:",a.status,a.ok),!a.ok){const $=await a.text();throw console.error("[PlanActApiService] Request failed:",$),new Error(`Failed to execute plan: ${a.status}`)}const h=await a.json();return console.log("[PlanActApiService] executePlan response:",h),h}static async savePlanTemplate(s,l){const r=await fetch(`${this.PLAN_TEMPLATE_URL}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:s,planJson:l})});if(!r.ok)throw new Error(`Failed to save plan: ${r.status}`);return await r.json()}static async getPlanVersions(s){const l=await fetch(`${this.PLAN_TEMPLATE_URL}/versions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:s})});if(!l.ok)throw new Error(`Failed to get plan versions: ${l.status}`);return await l.json()}static async getVersionPlan(s,l){const r=await fetch(`${this.PLAN_TEMPLATE_URL}/get-version`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:s,versionIndex:l.toString()})});if(!r.ok)throw new Error(`Failed to get specific version plan: ${r.status}`);return await r.json()}static async getAllPlanTemplates(){const s=await fetch(`${this.PLAN_TEMPLATE_URL}/list`);if(!s.ok)throw new Error(`Failed to get plan template list: ${s.status}`);return await s.json()}static async updatePlanTemplate(s,l,r){const a={planId:s,query:l};r&&(a.existingJson=r);const h=await fetch(`${this.PLAN_TEMPLATE_URL}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!h.ok)throw new Error(`Failed to update plan template: ${h.status}`);const $=await h.json();if($.planJson)try{$.plan=JSON.parse($.planJson)}catch{$.plan={error:"Unable to parse plan data"}}return $}static async deletePlanTemplate(s){const l=await fetch(`${this.PLAN_TEMPLATE_URL}/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:s})});if(!l.ok)throw new Error(`Failed to delete plan template: ${l.status}`);return await l.json()}}te(oe,"PLAN_TEMPLATE_URL","/api/plan-template");const at=it("sidebar",()=>{const V=T(!0),s=T("list"),l=T(null),r=T([]),a=T(null),h=T(!1),$=T(""),S=T(""),M=T(""),E=T(""),j=T(!1),z=T(!1),k=T([]),U=T(-1),X=ne(()=>[...r.value].sort((i,t)=>{const n=new Date(i.updateTime??i.createTime);return new Date(t.updateTime??t.createTime).getTime()-n.getTime()})),d=ne(()=>k.value.length>1&&U.value>0),C=ne(()=>k.value.length>1&&U.value<k.value.length-1),I=ne(()=>{if(!a.value)return"";const i=`/api/plan-template/executePlanByTemplateId/${a.value.id}`,t=E.value.trim();return t?`${i}?${encodeURIComponent(t)}`:i}),L=()=>{V.value=!V.value},J=i=>{s.value=i},H=async()=>{h.value=!0,$.value="";try{console.log("[SidebarStore] Starting to load plan template list...");const i=await oe.getAllPlanTemplates();i!=null&&i.templates&&Array.isArray(i.templates)?(r.value=i.templates,console.log(`[SidebarStore] Successfully loaded ${i.templates.length} plan templates`)):(r.value=[],console.warn("[SidebarStore] API returned abnormal data format, using empty list",i))}catch(i){console.error("[SidebarStore] Failed to load plan template list:",i),r.value=[],$.value=`Load failed: ${i.message}`}finally{h.value=!1}},le=async i=>{l.value=i.id,a.value=i,s.value="config",await ce(i),console.log(`[SidebarStore] Selected plan template: ${i.id}`)},ce=async i=>{try{const t=await oe.getPlanVersions(i.id);if(k.value=t.versions||[],k.value.length>0){const n=k.value[k.value.length-1];S.value=n,U.value=k.value.length-1;try{const o=JSON.parse(n);o.prompt&&(M.value=o.prompt),o.params&&(E.value=o.params)}catch{console.warn("Unable to parse JSON content to get prompt information")}}else S.value="",M.value="",E.value=""}catch(t){throw console.error("Failed to load template data:",t),t}},p=()=>{const i={id:`new-${Date.now()}`,title:"新建计划",description:"请使用计划生成器创建新的计划模板",createTime:new Date().toISOString(),updateTime:new Date().toISOString()};a.value=i,l.value=null,S.value="",M.value="",E.value="",k.value=[],U.value=-1,s.value="config",console.log("[SidebarStore] Created new empty plan template, switching to config tab")},v=async i=>{if(!i.id){console.warn("[SidebarStore] deleteTemplate: Invalid template object or ID");return}try{await oe.deletePlanTemplate(i.id),l.value===i.id&&x(),await H(),console.log(`[SidebarStore] Plan template ${i.id} has been deleted`)}catch(t){throw console.error("Failed to delete plan template:",t),await H(),t}},x=()=>{l.value=null,a.value=null,S.value="",M.value="",E.value="",k.value=[],U.value=-1,s.value="list"};return{isCollapsed:V,currentTab:s,currentPlanTemplateId:l,planTemplateList:r,selectedTemplate:a,isLoading:h,errorMessage:$,jsonContent:S,generatorPrompt:M,executionParams:E,isGenerating:j,isExecuting:z,planVersions:k,currentVersionIndex:U,sortedTemplates:X,canRollback:d,canRestore:C,computedApiUrl:I,toggleSidebar:L,switchToTab:J,loadPlanTemplateList:H,selectTemplate:le,createNewTemplate:p,deleteTemplate:v,clearSelection:x,clearExecutionParams:()=>{E.value=""},rollbackVersion:()=>{d.value&&(U.value--,S.value=k.value[U.value])},restoreVersion:()=>{C.value&&(U.value++,S.value=k.value[U.value])},saveTemplate:async()=>{if(!a.value)return;const i=S.value.trim();if(!i)throw new Error("Content cannot be empty");try{JSON.parse(i)}catch(t){throw new Error(`Invalid format, please correct and save.
Error: `+t.message)}try{const t=await oe.savePlanTemplate(a.value.id,i);return U.value<k.value.length-1&&(k.value=k.value.slice(0,U.value+1)),k.value.push(i),U.value=k.value.length-1,t}catch(t){throw console.error("Failed to save plan template:",t),t}},generatePlan:async()=>{if(M.value.trim()){j.value=!0;try{const i=await oe.generatePlan(M.value);if(S.value=i.planJson||"",a.value&&a.value.id.startsWith("new-")){let t="New Plan Template";try{t=JSON.parse(i.planJson||"{}").title||t}catch{console.warn("Unable to parse plan JSON to get title")}a.value={id:i.planTemplateId,title:t,description:"通过生成器创建的计划模板",createTime:new Date().toISOString(),updateTime:new Date().toISOString(),planJson:i.planJson},l.value=i.planTemplateId,await H()}return U.value<k.value.length-1&&(k.value=k.value.slice(0,U.value+1)),k.value.push(S.value),U.value=k.value.length-1,i}catch(i){throw console.error("Failed to generate plan:",i),i}finally{j.value=!1}}},updatePlan:async()=>{if(!(!M.value.trim()||!S.value.trim())&&a.value){j.value=!0;try{const i=await oe.updatePlanTemplate(a.value.id,M.value,S.value);return S.value=i.planJson||"",U.value<k.value.length-1&&(k.value=k.value.slice(0,U.value+1)),k.value.push(S.value),U.value=k.value.length-1,i}catch(i){throw console.error("Failed to update plan:",i),i}finally{j.value=!1}}},preparePlanExecution:()=>{if(!a.value)return null;z.value=!0;try{let i;try{i=JSON.parse(S.value),i.planTemplateId=a.value.id}catch{i={planTemplateId:a.value.id,planId:a.value.id,title:a.value.title??"执行计划",steps:[{stepRequirement:"[BROWSER_AGENT] 访问百度搜索阿里巴巴的最新股价"},{stepRequirement:"[DEFAULT_AGENT] 提取和整理搜索结果中的股价信息"},{stepRequirement:"[TEXT_FILE_AGENT] 创建一个文本文件记录查询结果"},{stepRequirement:"[DEFAULT_AGENT] 向用户报告查询结果"}]}}return{title:a.value.title??i.title??"Execution Plan",planData:i,params:E.value.trim()||void 0}}catch(i){throw console.error("Failed to prepare plan execution:",i),z.value=!1,i}},finishPlanExecution:()=>{z.value=!1}}}),vt={class:"sidebar-content"},mt={class:"sidebar-content-header"},ft={class:"sidebar-content-title"},Pt={class:"tab-switcher"},bt=["disabled"],St={key:0,class:"tab-content"},_t={class:"new-task-section"},kt={class:"sidebar-content-list"},$t={key:0,class:"loading-state"},Ct={key:1,class:"error-state"},yt={key:2,class:"empty-state"},Et=["onClick"],wt={class:"task-icon"},It={class:"task-details"},Tt={class:"task-title"},xt={class:"task-preview"},Rt={class:"task-time"},Dt={class:"task-actions"},At=["title","onClick"],Mt={key:1,class:"tab-content config-tab"},Ut={key:0,class:"config-container"},Lt={class:"template-info-header"},Nt={class:"template-info"},qt={class:"template-id"},Ot={class:"config-section"},Ft={class:"section-header"},Vt={class:"section-actions"},Bt=["disabled","title"],Wt=["disabled","title"],jt=["disabled"],Jt=["placeholder"],zt={class:"config-section"},Ht={class:"section-header"},Gt={class:"generator-content"},Xt=["placeholder"],Kt={class:"generator-actions"},Qt=["disabled"],Yt=["disabled"],Zt={class:"config-section"},en={class:"section-header"},tn={class:"execution-content"},nn={class:"params-input-group"},sn={class:"params-input-container"},an=["placeholder"],on=["title"],ln={class:"api-url-display"},cn={class:"api-url-label"},rn={class:"api-url"},un=["disabled"],dn=Pe({__name:"index",emits:["planExecutionRequested"],setup(V,{expose:s,emit:l}){const{t:r}=be(),a=at(),h=l,$=()=>{a.createNewTemplate(),console.log("[PlanTemplateSidebar] 创建新的空白计划模板，切换到配置标签页")},S=async d=>{try{await a.selectTemplate(d),console.log(`[PlanTemplateSidebar] 选择了计划模板: ${d.id}`)}catch(C){console.error("选择计划模板失败:",C),alert(r("sidebar.selectTemplateFailed")+": "+C.message)}},M=async d=>{if(confirm(r("sidebar.confirmDelete",{name:d.title??r("sidebar.unnamedPlan")})))try{await a.deleteTemplate(d),alert(r("sidebar.templateDeleted"))}catch(C){console.error("删除计划模板失败:",C),alert(r("sidebar.deleteTemplateFailed")+": "+C.message)}},E=async()=>{try{const d=await a.saveTemplate();d!=null&&d.duplicate?alert(r("sidebar.saveCompleted",{message:d.message,versionCount:d.versionCount})):d!=null&&d.saved?alert(r("sidebar.saveSuccess",{message:d.message,versionCount:d.versionCount})):d!=null&&d.message&&alert(r("sidebar.saveStatus",{message:d.message}))}catch(d){console.error("保存计划修改失败:",d),alert(d.message||r("sidebar.saveFailed"))}},j=async()=>{var d;try{await a.generatePlan(),alert(r("sidebar.generateSuccess",{templateId:((d=a.selectedTemplate)==null?void 0:d.id)??r("sidebar.unknown")}))}catch(C){console.error("生成计划失败:",C),alert(r("sidebar.generateFailed")+": "+C.message)}},z=async()=>{try{await a.updatePlan(),alert(r("sidebar.updateSuccess"))}catch(d){console.error("更新计划失败:",d),alert(r("sidebar.updateFailed")+": "+d.message)}},k=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const d=a.preparePlanExecution();if(!d){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] 触发计划执行请求:",d),console.log("[Sidebar] Emitting planExecutionRequested event"),h("planExecutionRequested",d),console.log("[Sidebar] Event emitted")}catch(d){console.error("执行计划出错:",d),alert(r("sidebar.executeFailed")+": "+d.message)}finally{a.finishPlanExecution()}},U=d=>{const I=new Date().getTime()-d.getTime(),L=Math.floor(I/6e4),J=Math.floor(I/36e5),H=Math.floor(I/864e5);return L<1?"刚刚":L<60?`${L}分钟前`:J<24?`${J}小时前`:H<30?`${H}天前`:d.toLocaleDateString("zh-CN")},X=(d,C)=>!d||d.length<=C?d:d.substring(0,C)+"...";return Se(()=>{a.loadPlanTemplateList()}),s({loadPlanTemplateList:a.loadPlanTemplateList,toggleSidebar:a.toggleSidebar,currentPlanTemplateId:a.currentPlanTemplateId}),(d,C)=>(m(),b("div",{class:ee(["sidebar-wrapper",{"sidebar-wrapper-collapsed":c(a).isCollapsed}])},[e("div",vt,[e("div",mt,[e("div",ft,u(d.$t("sidebar.title")),1)]),e("div",Pt,[e("button",{class:ee(["tab-button",{active:c(a).currentTab==="list"}]),onClick:C[0]||(C[0]=I=>c(a).switchToTab("list"))},[y(c(w),{icon:"carbon:list",width:"16"}),Y(" "+u(d.$t("sidebar.templateList")),1)],2),e("button",{class:ee(["tab-button",{active:c(a).currentTab==="config"}]),onClick:C[1]||(C[1]=I=>c(a).switchToTab("config")),disabled:!c(a).selectedTemplate},[y(c(w),{icon:"carbon:settings",width:"16"}),Y(" "+u(d.$t("sidebar.configuration")),1)],10,bt)]),c(a).currentTab==="list"?(m(),b("div",St,[e("div",_t,[e("button",{class:"new-task-btn",onClick:$},[y(c(w),{icon:"carbon:add",width:"16"}),Y(" "+u(d.$t("sidebar.newPlan"))+" ",1),C[10]||(C[10]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",kt,[c(a).isLoading?(m(),b("div",$t,[y(c(w),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,u(d.$t("sidebar.loading")),1)])):c(a).errorMessage?(m(),b("div",Ct,[y(c(w),{icon:"carbon:warning",width:"20"}),e("span",null,u(c(a).errorMessage),1),e("button",{onClick:C[2]||(C[2]=(...I)=>c(a).loadPlanTemplateList&&c(a).loadPlanTemplateList(...I)),class:"retry-btn"},u(d.$t("sidebar.retry")),1)])):c(a).planTemplateList.length===0?(m(),b("div",yt,[y(c(w),{icon:"carbon:document",width:"32"}),e("span",null,u(d.$t("sidebar.noTemplates")),1)])):(m(!0),b(he,{key:3},ge(c(a).sortedTemplates,I=>(m(),b("div",{key:I.id,class:ee(["sidebar-content-list-item",{"sidebar-content-list-item-active":I.id===c(a).currentPlanTemplateId}]),onClick:L=>S(I)},[e("div",wt,[y(c(w),{icon:"carbon:document",width:"20"})]),e("div",It,[e("div",Tt,u(I.title||d.$t("sidebar.unnamedPlan")),1),e("div",xt,u(X(I.description||d.$t("sidebar.noDescription"),40)),1)]),e("div",Rt,u(U(new Date(I.updateTime||I.createTime))),1),e("div",Dt,[e("button",{class:"delete-task-btn",title:d.$t("sidebar.deleteTemplate"),onClick:$e(L=>M(I),["stop"])},[y(c(w),{icon:"carbon:close",width:"16"})],8,At)])],10,Et))),128))])])):c(a).currentTab==="config"?(m(),b("div",Mt,[c(a).selectedTemplate?(m(),b("div",Ut,[e("div",Lt,[e("div",Nt,[e("h3",null,u(c(a).selectedTemplate.title||d.$t("sidebar.unnamedPlan")),1),e("span",qt,"ID: "+u(c(a).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:C[3]||(C[3]=I=>c(a).switchToTab("list"))},[y(c(w),{icon:"carbon:arrow-left",width:"16"})])]),e("div",Ot,[e("div",Ft,[y(c(w),{icon:"carbon:code",width:"16"}),e("span",null,u(d.$t("sidebar.jsonTemplate")),1),e("div",Vt,[e("button",{class:"btn btn-sm",onClick:C[4]||(C[4]=(...I)=>c(a).rollbackVersion&&c(a).rollbackVersion(...I)),disabled:!c(a).canRollback,title:d.$t("sidebar.rollback")},[y(c(w),{icon:"carbon:undo",width:"14"})],8,Bt),e("button",{class:"btn btn-sm",onClick:C[5]||(C[5]=(...I)=>c(a).restoreVersion&&c(a).restoreVersion(...I)),disabled:!c(a).canRestore,title:d.$t("sidebar.restore")},[y(c(w),{icon:"carbon:redo",width:"14"})],8,Wt),e("button",{class:"btn btn-primary btn-sm",onClick:E,disabled:c(a).isGenerating||c(a).isExecuting},[y(c(w),{icon:"carbon:save",width:"14"})],8,jt)])]),ve(e("textarea",{"onUpdate:modelValue":C[6]||(C[6]=I=>c(a).jsonContent=I),class:"json-editor",placeholder:d.$t("sidebar.jsonPlaceholder"),rows:"8"},null,8,Jt),[[me,c(a).jsonContent]])]),e("div",zt,[e("div",Ht,[y(c(w),{icon:"carbon:generate",width:"16"}),e("span",null,u(d.$t("sidebar.planGenerator")),1)]),e("div",Gt,[ve(e("textarea",{"onUpdate:modelValue":C[7]||(C[7]=I=>c(a).generatorPrompt=I),class:"prompt-input",placeholder:d.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,Xt),[[me,c(a).generatorPrompt]]),e("div",Kt,[e("button",{class:"btn btn-primary btn-sm",onClick:j,disabled:c(a).isGenerating||!c(a).generatorPrompt.trim()},[y(c(w),{icon:c(a).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:ee({spinning:c(a).isGenerating})},null,8,["icon","class"]),Y(" "+u(c(a).isGenerating?d.$t("sidebar.generating"):d.$t("sidebar.generatePlan")),1)],8,Qt),e("button",{class:"btn btn-secondary btn-sm",onClick:z,disabled:c(a).isGenerating||!c(a).generatorPrompt.trim()||!c(a).jsonContent.trim()},[y(c(w),{icon:"carbon:edit",width:"14"}),Y(" "+u(d.$t("sidebar.updatePlan")),1)],8,Yt)])])]),e("div",Zt,[e("div",en,[y(c(w),{icon:"carbon:play",width:"16"}),e("span",null,u(d.$t("sidebar.executionController")),1)]),e("div",tn,[e("div",nn,[e("label",null,u(d.$t("sidebar.executionParams")),1),e("div",sn,[ve(e("input",{"onUpdate:modelValue":C[8]||(C[8]=I=>c(a).executionParams=I),class:"params-input",placeholder:d.$t("sidebar.executionParamsPlaceholder")},null,8,an),[[me,c(a).executionParams]]),e("button",{class:"clear-params-btn",onClick:C[9]||(C[9]=(...I)=>c(a).clearExecutionParams&&c(a).clearExecutionParams(...I)),title:d.$t("sidebar.clearParams")},[y(c(w),{icon:"carbon:close",width:"12"})],8,on)])]),e("div",ln,[e("span",cn,u(d.$t("sidebar.apiUrl"))+":",1),e("code",rn,u(c(a).computedApiUrl),1)]),e("button",{class:"btn btn-primary execute-btn",onClick:k,disabled:c(a).isExecuting||c(a).isGenerating},[y(c(w),{icon:c(a).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:ee({spinning:c(a).isExecuting})},null,8,["icon","class"]),Y(" "+u(c(a).isExecuting?d.$t("sidebar.executing"):d.$t("sidebar.executePlan")),1)],8,un)])])])):W("",!0)])):W("",!0)])],2))}}),pn=ke(dn,[["__scopeId","data-v-44f5dac0"]]);class Ee{static async sendMessage(s){const l=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:s})});if(!l.ok)throw new Error(`API request failed: ${l.status}`);return await l.json()}}te(Ee,"BASE_URL","/api/executor");class we{static async getDetails(s){try{const l=await fetch(`${this.BASE_URL}/details/${s}`);if(l.status===404)return null;if(!l.ok)throw new Error(`Failed to get detailed information: ${l.status}`);const r=await l.text(),a=JSON.parse(r);return a&&typeof a=="object"&&!a.currentPlanId&&(a.currentPlanId=s),a}catch(l){return console.error("[CommonApiService] Failed to get plan details:",l),null}}static async submitFormInput(s,l){const r=await fetch(`${this.BASE_URL}/submit-input/${s}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(!r.ok){let h;try{h=await r.json()}catch{h={message:`Failed to submit form input: ${r.status}`}}throw new Error(h.message||`Failed to submit form input: ${r.status}`)}const a=r.headers.get("content-type");return a&&a.indexOf("application/json")!==-1?await r.json():{success:!0}}}te(we,"BASE_URL","/api/executor");const pe=class pe{constructor(){te(this,"POLL_INTERVAL",5e3);te(this,"state",ct({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));te(this,"callbacks",{});te(this,"planExecutionCache",new Map);te(this,"messageCache",new Map);te(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(s){return this.planExecutionCache.get(s)}getCachedMessage(s){return this.messageCache.get(s)}getCachedUIState(s){return this.uiStateCache.get(s)}setCachedMessage(s,l){this.messageCache.set(s,l),console.log(`[PlanExecutionManager] Cached message data for rootPlanId: ${s}`)}setCachedUIState(s,l){this.uiStateCache.set(s,l),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${s}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(s){return this.planExecutionCache.has(s)}setCachedPlanRecord(s,l){this.planExecutionCache.set(s,l),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${s}`)}clearCachedPlanRecord(s){const l=this.planExecutionCache.delete(s);return l&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${s}`),l}clearAllCachedRecords(){const s=this.planExecutionCache.size,l=this.messageCache.size,r=this.uiStateCache.size;this.planExecutionCache.clear(),this.messageCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${s}, Messages: ${l}, UI States: ${r}`)}static getInstance(){return pe.instance||(pe.instance=new pe),pe.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(s){this.callbacks={...this.callbacks,...s},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(s))}async handleUserMessageSendRequested(s){if(this.validateAndPrepareUIForNewRequest(s))try{if(await this.sendUserMessageAndSetPlanId(s),this.state.activePlanId)this.initiatePlanExecutionSequence(s,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(l){const r=this.state.activePlanId??"error";this.setCachedMessage(r,{content:`Send failed: ${l.message}`,type:"error",planId:this.state.activePlanId}),this.setCachedUIState(r,{enabled:!0}),this.emitMessageUpdate(r),this.emitChatInputUpdateState(r),this.state.activePlanId=null}}handlePlanExecutionRequested(s,l){console.log("[PlanExecutionManager] Received plan execution request:",{planId:s,query:l}),s?(this.state.activePlanId=s,this.initiatePlanExecutionSequence(l??"执行计划",s)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(s,l){const r=this.getCachedPlanRecord(s);return r!=null&&r.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${s}`),this.handlePlanExecutionRequested(r.currentPlanId,l),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${s}`),!1)}validateAndPrepareUIForNewRequest(s){if(!s)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId){const r=this.state.activePlanId;return this.setCachedMessage(r,{content:"There is a task currently executing, please wait for completion before submitting a new task",type:"error",planId:this.state.activePlanId}),this.emitMessageUpdate(r),!1}this.emitChatInputClear();const l=this.state.activePlanId??"ui-state";return this.setCachedUIState(l,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(l),!0}async sendUserMessageAndSetPlanId(s){try{const l=await Ee.sendMessage(s);if(l!=null&&l.planId)return this.state.activePlanId=l.planId,l;if(l!=null&&l.planTemplateId)return this.state.activePlanId=l.planTemplateId,{...l,planId:l.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",l),new Error("Failed to get valid planId from API response")}catch(l){throw console.error("[PlanExecutionManager] API call failed:",l),l}}initiatePlanExecutionSequence(s,l){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${s}", planId: ${l}`);const r=l;this.emitDialogRoundStart(r),this.startPolling()}handlePlanCompletion(s){this.emitPlanCompleted(s.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await oe.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(l){console.log(`Delete plan execution record failed: ${l.message}`)}},5e3)}catch(l){console.log(`Delete plan execution record failed: ${l.message}`)}s.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(s.rootPlanId??""))}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const s=await this.getPlanDetails(this.state.activePlanId);if(!s){console.warn("[PlanExecutionManager] No details received from API");return}if(s.rootPlanId&&this.setCachedPlanRecord(s.rootPlanId,s),!s.steps||s.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(s.rootPlanId??""),this.handlePlanCompletion(s);return}this.emitPlanUpdate(s.rootPlanId??""),s.completed&&this.handlePlanCompletion(s)}catch(s){console.error("[PlanExecutionManager] Failed to poll plan status:",s)}finally{this.state.isPolling=!1}}}async getPlanDetails(s){try{const l=await we.getDetails(s);return l!=null&&l.rootPlanId&&(this.planExecutionCache.set(l.rootPlanId,l),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${l.rootPlanId}`)),l}catch(l){return console.error("[PlanExecutionManager] Failed to get plan details:",l),null}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitMessageUpdate(s){this.callbacks.onMessageUpdate&&this.callbacks.onMessageUpdate(s)}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(s){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(s)}emitDialogRoundStart(s){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(s)}emitPlanUpdate(s){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(s)}emitPlanCompleted(s){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(s)}};te(pe,"instance",null);let ye=pe;const Q=ye.getInstance(),hn={class:"right-panel"},gn={class:"preview-header"},vn={class:"preview-tabs"},mn={class:"tab-button active"},fn={class:"preview-content"},Pn={class:"step-details"},bn={key:0,class:"step-info-fixed"},Sn={key:0,class:"agent-info"},_n={class:"info-item"},kn={class:"label"},$n={class:"value"},Cn={class:"info-item"},yn={class:"label"},En={class:"value"},wn={class:"info-item"},In={class:"label"},Tn={class:"value"},xn={class:"info-item"},Rn={class:"label"},Dn={class:"execution-status"},An={class:"status-item"},Mn={class:"status-text"},Un={key:0},Ln={key:0,class:"think-act-steps"},Nn={class:"steps-container"},qn={class:"step-header"},On={class:"step-number"},Fn={class:"think-section"},Vn={class:"think-content"},Bn={class:"input"},Wn={class:"label"},jn={class:"output"},Jn={class:"label"},zn={key:0,class:"action-section"},Hn={class:"action-content"},Gn={class:"tool-info"},Xn={class:"label"},Kn={class:"value"},Qn={class:"input"},Yn={class:"label"},Zn={class:"output"},es={class:"label"},ts={key:1,class:"sub-plan-section"},ns={class:"sub-plan-content"},ss={class:"sub-plan-header"},as={class:"sub-plan-info"},os={class:"value"},ls={key:0,class:"sub-plan-info"},is={class:"value"},cs={class:"sub-plan-status"},rs={class:"status-text"},us={key:1,class:"no-steps-message"},ds={key:2,class:"no-execution-message"},ps={class:"step-basic-info"},hs={class:"info-item"},gs={class:"value"},vs={key:0,class:"info-item"},ms={class:"value"},fs={class:"info-item"},Ps={key:3,class:"execution-indicator"},bs={class:"execution-text"},Ss={key:1,class:"no-selection"},_s=["title"],ks=Pe({__name:"index",setup(V,{expose:s}){const{t:l}=be(),r=T(),a=T(),h=T(),$=T(null),S=T(!1),M=T(!0),E=T(!0),j=ne(()=>h.value?h.value.completed?"已完成":h.value.current?"执行中":"等待执行":""),z=p=>{var x;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${p}`),h.value&&$.value){const R=$.value.rootPlanId??a.value;if(R&&R!==p){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${R}, Requested: ${p}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${p}`);const v=Q.getCachedPlanRecord(p);if(!v){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${p}`);return}if(v.steps&&v.steps.length>0){const R=v.steps.length,_=(v.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${_} / ${R}`)}if(h.value&&a.value&&(a.value===p||((x=$.value)==null?void 0:x.rootPlanId)===p)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${p}`),$.value)){const _=$.value,D=U(_.planId,_.rootPlanId,_.subPlanId);D?(X(D,_.stepIndex,_.planId,_.isSubPlan),J()):console.warn("[RightPanel] Could not find plan record for refresh:",_)}},k=(p,v,x,R,_)=>{console.log("[RightPanel] Step selected:",{planId:p,stepIndex:v,rootPlanId:x,subPlanId:R,subStepIndex:_});const D=!!(x&&R&&_!==void 0);$.value={planId:p,stepIndex:v,isSubPlan:D,...D&&{rootPlanId:x,subPlanId:R,subStepIndex:_}};const K=U(p,x,R);if(!K){console.warn("[RightPanel] Plan data not found:",{planId:p,rootPlanId:x,subPlanId:R}),h.value=null,$.value=null;return}X(K,v,p,D)},U=(p,v,x)=>{var D;if(!v||!x)return Q.getCachedPlanRecord(p)??null;const R=Q.getCachedPlanRecord(p);if(R)return R;const _=Q.getCachedPlanRecord(v);if(!(_!=null&&_.agentExecutionSequence))return null;for(const K of _.agentExecutionSequence)if(K.thinkActSteps){for(const se of K.thinkActSteps)if(((D=se.subPlanExecutionRecord)==null?void 0:D.currentPlanId)===x)return se.subPlanExecutionRecord}return null},X=(p,v,x,R)=>{var ue,f,i,t,n;if(!p.steps||v>=p.steps.length){h.value=null,$.value=null,console.warn("[RightPanel] Invalid step data:",{planId:x,stepIndex:v,hasSteps:!!p.steps,stepsLength:(ue=p.steps)==null?void 0:ue.length,message:"Invalid step index"});return}a.value=x;const _=p.steps[v],D=(f=p.agentExecutionSequence)==null?void 0:f[v];console.log("[RightPanel] Step data details:",{planId:x,stepIndex:v,step:_,hasAgentExecutionSequence:!!p.agentExecutionSequence,agentExecutionSequenceLength:(i=p.agentExecutionSequence)==null?void 0:i.length,agentExecution:D,hasThinkActSteps:!!(D!=null&&D.thinkActSteps),thinkActStepsLength:(t=D==null?void 0:D.thinkActSteps)==null?void 0:t.length,isSubPlan:R});const K=(D==null?void 0:D.isCompleted)??p.completed??(p.currentStepIndex!==void 0&&v<p.currentStepIndex),se=!K&&v===p.currentStepIndex&&!p.completed,re={planId:x,index:v,title:typeof _=="string"?_:_.title||_.description||_.name||`${R?"子":""}步骤 ${v+1}`,description:typeof _=="string"?_:_.description||_,completed:K,current:se};D&&(re.agentExecution=D),h.value=re,console.log("[RightPanel] Step details updated:",{planId:x,stepIndex:v,stepTitle:h.value.title,hasAgentExecution:!!D,hasThinkActSteps:(((n=D==null?void 0:D.thinkActSteps)==null?void 0:n.length)??0)>0,completed:K,current:se,planCurrentStep:p.currentStepIndex,planCompleted:p.completed,isSubPlan:R}),D!=null&&D.thinkActSteps&&D.thinkActSteps.forEach((o,g)=>{o.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${g}:`,o.subPlanExecutionRecord)}),setTimeout(()=>{I()},100),J()},d=(p,v,x,R)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:p,subPlanId:v,stepIndex:x,subStepIndex:R}),k(v,R,p,v,R)},C=p=>{r.value=p??void 0},I=()=>{if(!r.value)return;const{scrollTop:p,scrollHeight:v,clientHeight:x}=r.value,R=v-p-x<50,_=v>x;M.value=R,S.value=_&&!R,R?E.value=!0:v-p-x>100&&(E.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:p,scrollHeight:v,clientHeight:x,isAtBottom:R,hasScrollableContent:_,showButton:S.value,shouldAutoScroll:E.value})},L=()=>{r.value&&(r.value.scrollTo({top:r.value.scrollHeight,behavior:"smooth"}),ie(()=>{E.value=!0,I()}))},J=()=>{!E.value||!r.value||ie(()=>{r.value&&(r.value.scrollTop=r.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},H=p=>{if(p===null||typeof p>"u"||p==="")return"N/A";try{const v=typeof p=="object"?p:JSON.parse(p);return JSON.stringify(v,null,2)}catch{return String(p)}},le=()=>{h.value=null,a.value=void 0,E.value=!0,r.value&&r.value.removeEventListener("scroll",I)},ce=()=>{const p=()=>{const v=r.value;return v?(C(v),v.addEventListener("scroll",I),E.value=!0,I(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};ie(()=>{p()||setTimeout(()=>{p()},100)})};return Se(()=>{console.log("[RightPanel] Component mounted"),ie(()=>{ce()})}),_e(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),$.value=null,le()}),s({updateDisplayedPlanProgress:z,handleStepSelected:k,handleSubPlanStepSelected:d}),(p,v)=>{var x,R;return m(),b("div",hn,[e("div",gn,[e("div",vn,[e("button",mn,[y(c(w),{icon:"carbon:events"}),v[0]||(v[0]=Y(" 步骤执行详情 "))])])]),e("div",fn,[e("div",Pn,[h.value?(m(),b("div",bn,[e("h3",null,u(h.value.title||h.value.description||`步骤 ${h.value.index+1}`),1),h.value.agentExecution?(m(),b("div",Sn,[e("div",_n,[e("span",kn,u(p.$t("rightPanel.executingAgent"))+":",1),e("span",$n,u(h.value.agentExecution.agentName),1)]),e("div",Cn,[e("span",yn,u(p.$t("rightPanel.description"))+":",1),e("span",En,u(h.value.agentExecution.agentDescription||""),1)]),e("div",wn,[e("span",In,u(p.$t("rightPanel.request"))+":",1),e("span",Tn,u(h.value.agentExecution.agentRequest||""),1)]),e("div",xn,[e("span",Rn,u(p.$t("rightPanel.executionResult"))+":",1),e("span",{class:ee(["value",{success:h.value.agentExecution.isCompleted}])},u(h.value.agentExecution.result||p.$t("rightPanel.executing")),3)])])):W("",!0),e("div",Dn,[e("div",An,[h.value.completed?(m(),fe(c(w),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):h.value.current?(m(),fe(c(w),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(m(),fe(c(w),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",Mn,u(j.value),1)])])])):W("",!0),e("div",{ref_key:"scrollContainer",ref:r,class:"step-details-scroll-container",onScroll:I},[h.value?(m(),b("div",Un,[(x=h.value.agentExecution)!=null&&x.thinkActSteps&&h.value.agentExecution.thinkActSteps.length>0?(m(),b("div",Ln,[e("h4",null,u(p.$t("rightPanel.thinkAndActionSteps")),1),e("div",Nn,[(m(!0),b(he,null,ge(h.value.agentExecution.thinkActSteps,(_,D)=>(m(),b("div",{key:D,class:"think-act-step"},[e("div",qn,[e("span",On,"#"+u(D+1),1),e("span",{class:ee(["step-status",_.status])},u(_.status||p.$t("rightPanel.executing")),3)]),e("div",Fn,[e("h5",null,[y(c(w),{icon:"carbon:thinking"}),Y(" "+u(p.$t("rightPanel.thinking")),1)]),e("div",Vn,[e("div",Bn,[e("span",Wn,u(p.$t("rightPanel.input"))+":",1),e("pre",null,u(H(_.thinkInput)),1)]),e("div",jn,[e("span",Jn,u(p.$t("rightPanel.output"))+":",1),e("pre",null,u(H(_.thinkOutput)),1)])])]),_.actionNeeded?(m(),b("div",zn,[e("h5",null,[y(c(w),{icon:"carbon:play"}),Y(" "+u(p.$t("rightPanel.action")),1)]),e("div",Hn,[e("div",Gn,[e("span",Xn,u(p.$t("rightPanel.tool"))+":",1),e("span",Kn,u(_.toolName||""),1)]),e("div",Qn,[e("span",Yn,u(p.$t("rightPanel.toolParameters"))+":",1),e("pre",null,u(H(_.toolParameters)),1)]),e("div",Zn,[e("span",es,u(p.$t("rightPanel.executionResult"))+":",1),e("pre",null,u(H(_.actionResult)),1)])])])):W("",!0),_.subPlanExecutionRecord?(m(),b("div",ts,[e("h5",null,[y(c(w),{icon:"carbon:tree-view"}),v[1]||(v[1]=Y(" 子执行计划"))]),e("div",ns,[e("div",ss,[e("div",as,[v[2]||(v[2]=e("span",{class:"label"},"子计划ID:",-1)),e("span",os,u(_.subPlanExecutionRecord.currentPlanId),1)]),_.subPlanExecutionRecord.title?(m(),b("div",ls,[v[3]||(v[3]=e("span",{class:"label"},"标题:",-1)),e("span",is,u(_.subPlanExecutionRecord.title),1)])):W("",!0),e("div",cs,[_.subPlanExecutionRecord.completed?(m(),fe(c(w),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(m(),fe(c(w),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",rs,u(_.subPlanExecutionRecord.completed?"已完成":"执行中"),1)])])])])):W("",!0)]))),128))])])):h.value.agentExecution&&!((R=h.value.agentExecution.thinkActSteps)!=null&&R.length)?(m(),b("div",us,[e("p",null,u(p.$t("rightPanel.noStepDetails")),1)])):h.value.agentExecution?W("",!0):(m(),b("div",ds,[y(c(w),{icon:"carbon:information",class:"info-icon"}),v[7]||(v[7]=e("h4",null,"步骤信息",-1)),e("div",ps,[e("div",hs,[v[4]||(v[4]=e("span",{class:"label"},"步骤名称:",-1)),e("span",gs,u(h.value.title||h.value.description||`步骤 ${h.value.index+1}`),1)]),h.value.description?(m(),b("div",vs,[v[5]||(v[5]=e("span",{class:"label"},"描述:",-1)),e("span",ms,u(h.value.description),1)])):W("",!0),e("div",fs,[v[6]||(v[6]=e("span",{class:"label"},"状态:",-1)),e("span",{class:ee(["value",{"status-completed":h.value.completed,"status-current":h.value.current,"status-pending":!h.value.completed&&!h.value.current}])},u(h.value.completed?"已完成":h.value.current?"执行中":"待执行"),3)])]),v[8]||(v[8]=e("p",{class:"no-execution-hint"},"该步骤暂无详细执行信息",-1))])),h.value.current&&!h.value.completed?(m(),b("div",Ps,[v[9]||(v[9]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",bs,[y(c(w),{icon:"carbon:in-progress",class:"rotating-icon"}),Y(" "+u(p.$t("rightPanel.stepExecuting")),1)])])):W("",!0)])):(m(),b("div",Ss,[y(c(w),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,u(c(l)("rightPanel.noStepSelected")),1),e("p",null,u(c(l)("rightPanel.selectStepHint")),1)]))],544),y(rt,{name:"scroll-button"},{default:ut(()=>[S.value?(m(),b("button",{key:0,onClick:L,class:"scroll-to-bottom-btn",title:p.$t("rightPanel.scrollToBottom")},[y(c(w),{icon:"carbon:chevron-down"})],8,_s)):W("",!0)]),_:1})])])])}}}),$s=ke(ks,[["__scopeId","data-v-c6fb8dc2"]]);function Cs(){const V=Q,s=ne(()=>V.getActivePlanId()),l=ne(()=>V.getState()),r=ne(()=>l.value.isPolling),a=ne(()=>!!s.value),h=(E,j)=>{V.initiatePlanExecutionSequence(E,j)},$=()=>{V.stopPolling()},S=()=>{V.startPolling()},M=()=>{V.cleanup()};return _e(()=>{M()}),{activePlanId:s,state:l,isPolling:r,hasActivePlan:a,startExecution:h,stopPolling:$,startPolling:S,cleanup:M}}const ys={class:"chat-container"},Es={class:"message-content"},ws={key:0,class:"user-message"},Is={key:1,class:"assistant-message"},Ts={key:0,class:"thinking-section"},xs={class:"thinking-header"},Rs={class:"thinking-avatar"},Ds={class:"thinking-label"},As={class:"thinking-content"},Ms={key:0,class:"thinking"},Us={key:1,class:"progress"},Ls={class:"progress-bar"},Ns={class:"progress-text"},qs={key:2,class:"steps-container"},Os={class:"steps-title"},Fs=["onClick"],Vs={class:"section-header"},Bs={class:"step-icon"},Ws={class:"step-title"},js={key:0,class:"step-status current"},Js={key:1,class:"step-status completed"},zs={key:2,class:"step-status pending"},Hs={key:0,class:"action-info"},Gs={class:"action-description"},Xs={class:"action-icon"},Ks={key:0,class:"tool-params"},Qs={class:"param-label"},Ys={class:"param-content"},Zs={key:1,class:"think-details"},ea={class:"think-header"},ta={class:"think-label"},na={class:"think-output"},sa={class:"think-content"},aa={key:1,class:"sub-plan-steps"},oa={class:"sub-plan-header"},la={class:"sub-plan-step-list"},ia=["onClick"],ca={class:"sub-step-indicator"},ra={class:"sub-step-icon"},ua={class:"sub-step-number"},da={class:"sub-step-content"},pa={class:"sub-step-title"},ha={key:2,class:"user-input-form-container"},ga={class:"user-input-message"},va={key:0,class:"form-description"},ma=["onSubmit"],fa=["for"],Pa=["id","name","onUpdate:modelValue"],ba={key:1,class:"form-group"},Sa={for:"form-input-genericInput"},_a=["onUpdate:modelValue"],ka={type:"submit",class:"submit-user-input-btn"},$a={key:3,class:"default-processing"},Ca={class:"processing-indicator"},ya={class:"response-section"},Ea={class:"response-header"},wa={class:"response-avatar"},Ia={class:"response-name"},Ta={class:"response-content"},xa={key:0,class:"final-response"},Ra=["innerHTML"],Da={key:1,class:"response-placeholder"},Aa={class:"typing-indicator"},Ma={class:"typing-text"},Ua={key:0,class:"message assistant"},La={class:"message-content"},Na={class:"assistant-message"},qa={class:"thinking-section"},Oa={class:"thinking-header"},Fa={class:"thinking-avatar"},Va={class:"thinking-label"},Ba={class:"thinking-content"},Wa={class:"default-processing"},ja={class:"processing-indicator"},Ja={class:"response-section"},za={class:"response-header"},Ha={class:"response-avatar"},Ga={class:"response-name"},Xa={class:"response-content"},Ka={class:"response-placeholder"},Qa={class:"typing-indicator"},Ya={class:"typing-text"},Za=["title"],eo=Pe({__name:"index",props:{mode:{default:"plan"}},emits:["user-message-send-requested","input-clear","step-selected","sub-plan-step-selected"],setup(V,{expose:s,emit:l}){const r=V,a=l,{t:h}=be(),$=Cs(),S=T(),M=T(!1),E=T([]),j=T(),z=T(!1),k=(t,n,o)=>{const g={id:Date.now().toString(),type:t,content:n,timestamp:new Date,...o};return t==="assistant"&&!g.thinking&&!g.content&&(g.thinking=h("chat.thinking")),E.value.push(g),g},U=t=>{const n=E.value[E.value.length-1];n.type==="assistant"&&Object.assign(n,t)},X=async t=>{try{M.value=!0;const n=k("assistant","",{thinking:"正在理解您的请求并准备回复..."}),o=await Ee.sendMessage(t);delete n.thinking;const g=d(o,t);n.content=g}catch(n){console.error("Direct mode error:",n),U({content:C(n)})}finally{M.value=!1}},d=(t,n)=>t.result??t.message??t.content??"",C=t=>{const n=(t==null?void 0:t.message)??(t==null?void 0:t.toString())??"未知错误";return n.includes("网络")||n.includes("network")||n.includes("timeout")?"抱歉，似乎网络连接有些问题。请检查您的网络连接后再试一次，或者稍等几分钟再重新提问。":n.includes("认证")||n.includes("权限")||n.includes("auth")?"抱歉，访问权限出现了问题。这可能是系统配置的问题，请联系管理员或稍后再试。":n.includes("格式")||n.includes("参数")||n.includes("invalid")?"抱歉，您的请求格式可能有些问题。能否请您重新表述一下您的需求？我会尽力理解并帮助您。":`抱歉，处理您的请求时遇到了一些问题（${n}）。请稍后再试，或者换个方式表达您的需求，我会尽力帮助您的。`},I=(t=!1)=>{ie(()=>{if(S.value){const n=S.value;(t||n.scrollHeight-n.scrollTop-n.clientHeight<150)&&n.scrollTo({top:n.scrollHeight,behavior:t?"auto":"smooth"})}})},L=()=>{I(!0),z.value=!1},J=()=>{if(S.value){const t=S.value,n=t.scrollHeight-t.scrollTop-t.clientHeight<150;z.value=!n&&E.value.length>0}},H=()=>{S.value&&S.value.addEventListener("scroll",J)},le=()=>{S.value&&S.value.removeEventListener("scroll",J)},ce=t=>{k("user",t),a("input-clear"),r.mode==="plan"?a("user-message-send-requested",t):X(t)},p=(t,n)=>{var o,g;if(!((o=t.planExecution)!=null&&o.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:t.planExecution.currentPlanId,stepIndex:n,stepTitle:(g=t.planExecution.steps)==null?void 0:g[n]}),a("step-selected",t.planExecution.currentPlanId,n)},v=(t,n)=>{var o;try{const g=(o=t.planExecution)==null?void 0:o.agentExecutionSequence;if(!(g!=null&&g.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const A=g[n];if(!A.thinkActSteps)return console.log(`[ChatComponent] No agentExecution or thinkActSteps found for step ${n}`),[];for(const q of A.thinkActSteps)if(q.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${n}:`,q.subPlanExecutionRecord),(q.subPlanExecutionRecord.steps??[]).map(O=>typeof O=="string"?O:typeof O=="object"&&O!==null&&(O.title||O.description)||"子步骤");return[]}catch(g){return console.warn("[ChatComponent] Error getting sub-plan steps:",g),[]}},x=(t,n,o)=>{var g;try{const A=(g=t.planExecution)==null?void 0:g.agentExecutionSequence;if(!(A!=null&&A.length))return"pending";const q=A[n];if(!q.thinkActSteps)return"pending";let G=null;for(const P of q.thinkActSteps)if(P.subPlanExecutionRecord){G=P.subPlanExecutionRecord;break}if(!G)return"pending";const O=G.currentStepIndex;return G.completed?"completed":O==null?o===0?"current":"pending":o<O?"completed":o===O?"current":"pending"}catch(A){return console.warn("[ChatComponent] Error getting sub-plan step status:",A),"pending"}},R=(t,n,o)=>{var g,A;try{const q=(g=t.planExecution)==null?void 0:g.agentExecutionSequence;if(!(q!=null&&q.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const G=q[n];if(!G.thinkActSteps){console.warn("[ChatComponent] No agentExecution or thinkActSteps for step click");return}let O=null;for(const P of G.thinkActSteps)if(P.subPlanExecutionRecord){O=P.subPlanExecutionRecord;break}if(!(O!=null&&O.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}a("sub-plan-step-selected",((A=t.planExecution)==null?void 0:A.currentPlanId)??"",O.currentPlanId,n,o)}catch(q){console.error("[ChatComponent] Error handling sub-plan step click:",q)}},_=(t,n)=>{var g,A,q,G;if(!((g=t.planExecution)!=null&&g.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",t.planExecution.steps.length,"execution sequence:",((A=n.agentExecutionSequence)==null?void 0:A.length)??0);const o=new Array(t.planExecution.steps.length).fill(null);if((q=n.agentExecutionSequence)!=null&&q.length){const O=Math.min(n.agentExecutionSequence.length,t.planExecution.steps.length);for(let P=0;P<O;P++){const B=n.agentExecutionSequence[P];if(((G=B==null?void 0:B.thinkActSteps)==null?void 0:G.length)>0){const F=B.thinkActSteps[B.thinkActSteps.length-1];F!=null&&F.actionDescription&&(F!=null&&F.toolParameters)?(o[P]={actionDescription:F.actionDescription,toolParameters:typeof F.toolParameters=="string"?F.toolParameters:JSON.stringify(F.toolParameters,null,2),thinkInput:F.thinkInput??"",thinkOutput:F.thinkOutput??"",status:P<n.currentStepIndex?"completed":P===n.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${P} action set: ${o[P].actionDescription}`)):F?(o[P]={actionDescription:"思考中",toolParameters:"等待决策",thinkInput:F.thinkInput??"",thinkOutput:F.thinkOutput??"",status:P===n.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${P} is thinking`)):(o[P]={actionDescription:"执行完成",toolParameters:"无工具",thinkInput:"",thinkOutput:"",status:"completed"},console.log(`[ChatComponent] Step ${P} execution completed`))}else o[P]={actionDescription:P<n.currentStepIndex?"已完成":"等待中",toolParameters:"无工具参数",thinkInput:"",thinkOutput:"",status:P<n.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] 步骤 ${P} 无执行细节, 状态设为: ${o[P].status}`)}}else console.log("[ChatComponent] 没有执行序列数据");t.stepActions=[...o],console.log("[ChatComponent] 步骤动作更新完成:",JSON.stringify(o.map(O=>O==null?void 0:O.actionDescription))),ie(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},D=(t,n)=>{console.log("[ChatComponent] Starting dialog round with planId:",t,"query:",n),t&&n&&(E.value.findIndex(A=>A.type==="user"&&A.content===n)===-1?(k("user",n),console.log("[ChatComponent] Added user message:",n)):console.log("[ChatComponent] User message already exists:",n),E.value.findIndex(A=>{var q;return((q=A.planExecution)==null?void 0:q.currentPlanId)===t&&A.type==="assistant"})===-1?(k("assistant","",{planExecution:{currentPlanId:t},thinking:"正在准备执行计划..."}),console.log("[ChatComponent] Created new assistant message for planId:",t)):console.log("[ChatComponent] Found existing assistant message for planId:",t))},K=t=>{var q,G,O;console.log("[ChatComponent] Processing plan update with rootPlanId:",t);const n=Q.getCachedPlanRecord(t);if(!n){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",t);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",n),console.log("[ChatComponent] Plan steps:",n.steps),console.log("[ChatComponent] Plan completed:",n.completed),!n.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const o=E.value.findIndex(P=>{var B;return((B=P.planExecution)==null?void 0:B.currentPlanId)===n.currentPlanId&&P.type==="assistant"});let g;if(o!==-1)g=E.value[o],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",n.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",n.currentPlanId),console.log("[ChatComponent] Current messages:",E.value.map(B=>{var F;return{type:B.type,planId:(F=B.planExecution)==null?void 0:F.currentPlanId,content:B.content.substring(0,50)}}));let P=-1;for(let B=E.value.length-1;B>=0;B--)if(E.value[B].type==="assistant"){P=B;break}if(P!==-1)g=E.value[P],g.planExecution||(g.planExecution={}),g.planExecution.currentPlanId=n.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",n.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(g.planExecution||(g.planExecution={}),g.planExecution=JSON.parse(JSON.stringify(n)),!n.steps||n.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),n.completed){delete g.thinking;const P=n.summary??n.result??n.message??"处理完成";g.content=se(P),console.log("[ChatComponent] Set simple response content:",g.content)}else n.title&&(g.thinking=`正在执行: ${n.title}`);return}const A=n.steps.map(P=>typeof P=="string"?P:typeof P=="object"&&P!==null&&(P.title||P.description)||"步骤");if(g.planExecution&&(g.planExecution.steps=A),n.agentExecutionSequence&&n.agentExecutionSequence.length>0){console.log("[ChatComponent] 发现执行序列数据，数量:",n.agentExecutionSequence.length),_(g,n);const P=n.currentStepIndex??0;if(P>=0&&P<n.agentExecutionSequence.length){const F=n.agentExecutionSequence[P].thinkActSteps;if(F&&F.length>0){const de=F[F.length-1];if(de.thinkOutput){const N=de.thinkOutput.length>150?de.thinkOutput.substring(0,150)+"...":de.thinkOutput;g.thinking=`正在思考: ${N}`}}}}else if(g.planExecution){const P=g.planExecution.currentStepIndex??0,B=(q=g.planExecution.steps)==null?void 0:q[P],F=typeof B=="string"?B:"";g.thinking=`正在执行: ${F}`}if(n.userInputWaitState&&g.planExecution?(console.log("[ChatComponent] 需要用户输入:",n.userInputWaitState),g.planExecution.userInputWaitState||(g.planExecution.userInputWaitState={}),g.planExecution.userInputWaitState={message:n.userInputWaitState.message??"",formDescription:n.userInputWaitState.formDescription??"",formInputs:((G=n.userInputWaitState.formInputs)==null?void 0:G.map(P=>({label:P.label,value:P.value??""})))??[]},g.thinking="等待用户输入..."):(O=g.planExecution)!=null&&O.userInputWaitState&&delete g.planExecution.userInputWaitState,n.completed??n.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete g.thinking;let P="";n.summary?P=n.summary:n.result?P=n.result:P="任务已完成",g.content=re(P,n),console.log("[ChatComponent] Updated completed message:",g.content)}ie(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},se=t=>t?t.includes("我")||t.includes("您")||t.includes("您好")||t.includes("可以")?t:t.length<10?`${t}！还有什么需要我帮助的吗？`:t.length<50?`好的，${t}。如果您还有其他问题，请随时告诉我。`:`${t}

希望这个回答对您有帮助！还有什么我可以为您做的吗？`:"我明白了，还有什么我可以帮您的吗？",re=(t,n)=>{var g;return t?t.includes("我")||t.includes("您")?!t.includes("?")&&!t.includes("？")&&!t.includes("。")&&!t.includes("！")?`${t}。还有其他需要帮助的地方吗？`:t:((g=n==null?void 0:n.steps)==null?void 0:g.length)>0?`很好！我已经完成了您的任务：${t}

所有步骤都已成功执行。还有什么我可以帮您处理的吗？`:`${t}

希望这个回答对您有帮助！如果还有其他问题，请随时告诉我。`:"任务已完成！还有什么我可以帮您的吗？"},ue=t=>{if(console.log("[ChatComponent] Plan completed:",t),t!=null&&t.planId){const n=E.value.findIndex(o=>{var g;return((g=o.planExecution)==null?void 0:g.currentPlanId)===t.planId});if(n!==-1){const o=E.value[n];delete o.thinking;let A=t.summary??t.result??"任务已完成";!A.includes("我")&&!A.includes("您")&&(A.includes("成功")||A.includes("完成")?A=`很好！${A}。如果您还有其他需要帮助的地方，请随时告诉我。`:A=`我已经完成了您的请求：${A}`),o.content=A,console.log("[ChatComponent] Updated completed message:",o.content)}else console.warn("[ChatComponent] No message found for completed planId:",t.planId)}},f=t=>{if(!t)return"";let n=t.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return n=n.replace(/(<br><br>)/g,"</p><p>"),n.includes("</p><p>")&&(n=`<p>${n}</p>`),n},i=async t=>{var n;if(!((n=t.planExecution)!=null&&n.currentPlanId)||!t.planExecution.userInputWaitState){console.error("[ChatComponent] 缺少planExecution.currentPlanId或userInputWaitState");return}try{const o={},g=t.planExecution.userInputWaitState.formInputs;g&&g.length>0?g.forEach(q=>{o[q.label]=q.value??""}):o.genericInput=t.genericInput??"",console.log("[ChatComponent] 提交用户输入:",o);const A=await we.submitFormInput(t.planExecution.currentPlanId,o);delete t.planExecution.userInputWaitState,delete t.genericInput,$.startPolling(),console.log("[ChatComponent] 用户输入提交成功:",A)}catch(o){console.error("[ChatComponent] 用户输入提交失败:",o),alert(`提交失败: ${(o==null?void 0:o.message)||"未知错误"}`)}};return Se(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),ie(()=>{H()})}),_e(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),le(),j.value&&clearInterval(j.value),$.cleanup()}),s({handleSendMessage:ce,handlePlanUpdate:K,handlePlanCompleted:ue,handleDialogRoundStart:D,addMessage:k}),(t,n)=>(m(),b("div",ys,[e("div",{class:"messages",ref_key:"messagesRef",ref:S},[(m(!0),b(he,null,ge(E.value,o=>{var g,A,q,G,O,P,B,F,de;return m(),b("div",{key:o.id,class:ee(["message",{user:o.type==="user",assistant:o.type==="assistant"}])},[e("div",Es,[o.type==="user"?(m(),b("div",ws,u(o.content),1)):(m(),b("div",Is,[o.thinking||((g=o.planExecution)==null?void 0:g.progress)!==void 0||(((q=(A=o.planExecution)==null?void 0:A.steps)==null?void 0:q.length)??0)>0?(m(),b("div",Ts,[e("div",xs,[e("div",Rs,[y(c(w),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Ds,u(t.$t("chat.thinkingLabel")),1)]),e("div",As,[o.thinking?(m(),b("div",Ms,[y(c(w),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,u(o.thinking),1)])):W("",!0),((G=o.planExecution)==null?void 0:G.progress)!==void 0?(m(),b("div",Us,[e("div",Ls,[e("div",{class:"progress-fill",style:Ce({width:o.planExecution.progress+"%"})},null,4)]),e("span",Ns,u(o.planExecution.progressText??t.$t("chat.processing")+"..."),1)])):W("",!0),(((P=(O=o.planExecution)==null?void 0:O.steps)==null?void 0:P.length)??0)>0?(m(),b("div",qs,[e("h4",Os,u(t.$t("chat.stepExecutionDetails")),1),(m(!0),b(he,null,ge((B=o.planExecution)==null?void 0:B.steps,(Ie,N)=>{var Te,xe,Re,De,Ae,Me,Ue,Le,Ne,qe,Oe,Fe,Ve,Be,We,je,Je,ze,He,Ge,Xe,Ke,Qe,Ye,Ze,et,tt;return m(),b("div",{key:N,class:ee(["ai-section",{current:N===(((Te=o.planExecution)==null?void 0:Te.currentStepIndex)??-1),completed:N<(((xe=o.planExecution)==null?void 0:xe.currentStepIndex)??0),pending:N>(((Re=o.planExecution)==null?void 0:Re.currentStepIndex)??0)}]),onClick:$e(ae=>p(o,N),["stop"])},[e("div",Vs,[e("span",Bs,u(N<(((De=o.planExecution)==null?void 0:De.currentStepIndex)??0)?"✓":N===(((Ae=o.planExecution)==null?void 0:Ae.currentStepIndex)??-1)?"▶":"○"),1),e("span",Ws,u(Ie||`${t.$t("chat.step")} ${N+1}`),1),N===(((Me=o.planExecution)==null?void 0:Me.currentStepIndex)??-1)?(m(),b("span",js,u(t.$t("chat.status.executing")),1)):N<(((Ue=o.planExecution)==null?void 0:Ue.currentStepIndex)??0)?(m(),b("span",Js,u(t.$t("chat.status.completed")),1)):(m(),b("span",zs,u(t.$t("chat.status.pending")),1))]),o.stepActions&&o.stepActions[N]?(m(),b("div",Hs,[e("div",Gs,[e("span",Xs,u(((Le=o.stepActions[N])==null?void 0:Le.status)==="current"?"🔄":((Ne=o.stepActions[N])==null?void 0:Ne.status)==="completed"?"✓":"⏳"),1),e("strong",null,u((qe=o.stepActions[N])==null?void 0:qe.actionDescription),1)]),(Oe=o.stepActions[N])!=null&&Oe.toolParameters?(m(),b("div",Ks,[n[0]||(n[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",Qs,u(t.$t("common.parameters"))+":",1),e("pre",Ys,u((Fe=o.stepActions[N])==null?void 0:Fe.toolParameters),1)])):W("",!0),(Ve=o.stepActions[N])!=null&&Ve.thinkOutput?(m(),b("div",Zs,[e("div",ea,[n[1]||(n[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",ta,u(t.$t("chat.thinkingOutput"))+":",1)]),e("div",na,[e("pre",sa,u((Be=o.stepActions[N])==null?void 0:Be.thinkOutput),1)])])):W("",!0)])):W("",!0),((We=v(o,N))==null?void 0:We.length)>0?(m(),b("div",aa,[e("div",oa,[y(c(w),{icon:"carbon:tree-view",class:"sub-plan-icon"}),n[2]||(n[2]=e("span",{class:"sub-plan-title"},"子执行计划",-1))]),e("div",la,[(m(!0),b(he,null,ge(v(o,N),(ae,Z)=>(m(),b("div",{key:`sub-${N}-${Z}`,class:ee(["sub-plan-step-item",{completed:x(o,N,Z)==="completed",current:x(o,N,Z)==="current",pending:x(o,N,Z)==="pending"}]),onClick:$e(nt=>R(o,N,Z),["stop"])},[e("div",ca,[e("span",ra,u(x(o,N,Z)==="completed"?"✓":x(o,N,Z)==="current"?"▶":"○"),1),e("span",ua,u(Z+1),1)]),e("div",da,[e("span",pa,u(ae),1),n[3]||(n[3]=e("span",{class:"sub-step-badge"},"子步骤",-1))])],10,ia))),128))])])):W("",!0),(je=o.planExecution)!=null&&je.userInputWaitState&&N===(((Je=o.planExecution)==null?void 0:Je.currentStepIndex)??-1)?(m(),b("div",ha,[e("p",ga,u(((He=(ze=o.planExecution)==null?void 0:ze.userInputWaitState)==null?void 0:He.message)??t.$t("chat.userInput.message")),1),(Xe=(Ge=o.planExecution)==null?void 0:Ge.userInputWaitState)!=null&&Xe.formDescription?(m(),b("p",va,u((Qe=(Ke=o.planExecution)==null?void 0:Ke.userInputWaitState)==null?void 0:Qe.formDescription),1)):W("",!0),e("form",{onSubmit:$e(ae=>i(o),["prevent"]),class:"user-input-form"},[(Ze=(Ye=o.planExecution)==null?void 0:Ye.userInputWaitState)!=null&&Ze.formInputs&&o.planExecution.userInputWaitState.formInputs.length>0?(m(!0),b(he,{key:0},ge((tt=(et=o.planExecution)==null?void 0:et.userInputWaitState)==null?void 0:tt.formInputs,(ae,Z)=>(m(),b("div",{key:Z,class:"form-group"},[e("label",{for:`form-input-${ae.label.replace(/\W+/g,"_")}`},u(ae.label)+": ",9,fa),ve(e("input",{type:"text",id:`form-input-${ae.label.replace(/\W+/g,"_")}`,name:ae.label,"onUpdate:modelValue":nt=>o.planExecution.userInputWaitState.formInputs[Z].value=nt,class:"form-input"},null,8,Pa),[[me,o.planExecution.userInputWaitState.formInputs[Z].value]])]))),128)):(m(),b("div",ba,[e("label",Sa,u(t.$t("common.input"))+":",1),ve(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":ae=>o.genericInput=ae,class:"form-input"},null,8,_a),[[me,o.genericInput]])])),e("button",ka,u(t.$t("chat.userInput.submit")),1)],40,ma)])):W("",!0)],10,Fs)}),128))])):!o.content&&(o.thinking||((F=o.planExecution)==null?void 0:F.progress)!==void 0&&(((de=o.planExecution)==null?void 0:de.progress)??0)<100)?(m(),b("div",$a,[e("div",Ca,[n[4]||(n[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,u(o.thinking??t.$t("chat.thinkingProcessing")),1)])])):W("",!0)])])):W("",!0),e("div",ya,[e("div",Ea,[e("div",wa,[y(c(w),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Ia,u(t.$t("chat.botName")),1)]),e("div",Ta,[o.content?(m(),b("div",xa,[e("div",{class:"response-text",innerHTML:f(o.content)},null,8,Ra)])):(m(),b("div",Da,[e("div",Aa,[n[5]||(n[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Ma,u(t.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),M.value?(m(),b("div",Ua,[e("div",La,[e("div",Na,[e("div",qa,[e("div",Oa,[e("div",Fa,[y(c(w),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Va,u(t.$t("chat.thinkingLabel")),1)]),e("div",Ba,[e("div",Wa,[e("div",ja,[n[6]||(n[6]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,u(t.$t("chat.thinking")),1)])])])]),e("div",Ja,[e("div",za,[e("div",Ha,[y(c(w),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Ga,u(t.$t("chat.botName")),1)]),e("div",Xa,[e("div",Ka,[e("div",Qa,[n[7]||(n[7]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Ya,u(t.$t("chat.thinkingResponse")),1)])])])])])])])):W("",!0)],512),z.value?(m(),b("div",{key:0,class:"scroll-to-bottom-btn",onClick:L,title:t.$t("chat.scrollToBottom")},[y(c(w),{icon:"carbon:chevron-down"})],8,Za)):W("",!0)]))}}),to=ke(eo,[["__scopeId","data-v-63b051ac"]]),no={class:"input-area"},so={class:"input-container"},ao={class:"attach-btn",title:"附加文件"},oo=["placeholder","disabled"],lo=["title"],io=["disabled","title"],co=Pe({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1}},emits:["send","clear","update-state","message-sent","plan-mode-clicked"],setup(V,{expose:s,emit:l}){const{t:r}=be(),a=V,h=l,$=T(),S=T(""),M=ne(()=>a.placeholder||r("input.placeholder")),E=T(M.value),j=ne(()=>!!a.disabled),z=()=>{ie(()=>{$.value&&($.value.style.height="auto",$.value.style.height=Math.min($.value.scrollHeight,120)+"px")})},k=L=>{L.key==="Enter"&&!L.shiftKey&&(L.preventDefault(),U())},U=()=>{if(!S.value.trim()||j.value)return;const L=S.value.trim();h("send",L),d(),h("message-sent",L)},X=()=>{h("plan-mode-clicked")},d=()=>{S.value="",z(),h("clear")};return s({clearInput:d,updateState:(L,J)=>{J&&(E.value=L?J:r("input.waiting")),h("update-state",L,J)},getQuery:()=>S.value.trim(),focus:()=>{var L;return(L=$.value)==null?void 0:L.focus()}}),Se(()=>{}),_e(()=>{}),(L,J)=>(m(),b("div",no,[e("div",so,[e("button",ao,[y(c(w),{icon:"carbon:attachment"})]),ve(e("textarea",{"onUpdate:modelValue":J[0]||(J[0]=H=>S.value=H),ref_key:"inputRef",ref:$,class:"chat-input",placeholder:E.value,disabled:j.value,onKeydown:k,onInput:z},null,40,oo),[[me,S.value]]),e("button",{class:"plan-mode-btn",title:L.$t("input.planMode"),onClick:X},[y(c(w),{icon:"carbon:document"}),Y(" "+u(L.$t("input.planMode")),1)],8,lo),e("button",{class:"send-button",disabled:!S.value.trim()||j.value,onClick:U,title:L.$t("input.send")},[y(c(w),{icon:"carbon:send-alt"}),Y(" "+u(L.$t("input.send")),1)],8,io)])]))}}),ro=ke(co,[["__scopeId","data-v-b31c7f01"]]),uo={class:"direct-page"},po={class:"direct-chat"},ho={class:"chat-header"},go={class:"header-actions"},vo=["title"],mo={class:"chat-content"},fo=["title"],Po=Pe({__name:"index",setup(V){const s=dt(),l=pt(),r=gt(),a=at(),{t:h}=be(),$=T(""),S=T(),M=T(),E=T(),j=T(!1),z=T(!1),k=T(null),U=T(50),X=T(!1),d=T(0),C=T(0);Se(()=>{console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",r.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",r.hasUnprocessedTask()),Q.setEventCallbacks({onPlanUpdate:i=>{console.log("[Direct] Plan update event received for rootPlanId:",i),le(i)&&(console.log("[Direct] Processing plan update for current rootPlanId:",i),M.value&&typeof M.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",i),M.value.handlePlanUpdate(i)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),S.value&&typeof S.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",i),S.value.updateDisplayedPlanProgress(i)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:i=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",i),!!le(i)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",i),M.value&&typeof M.value.handlePlanCompleted=="function"){const t=Q.getCachedPlanRecord(i);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",t),M.value.handlePlanCompleted(t??{planId:i})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");k.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:i=>{if(console.log("[Direct] Dialog round start event received for rootPlanId:",i),k.value=i,console.log("[Direct] Set currentRootPlanId to:",i),M.value&&typeof M.value.handleDialogRoundStart=="function"){const t=Q.getCachedPlanRecord(i),n=(t==null?void 0:t.title)??"执行计划";console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId and query:",i,n),M.value.handleDialogRoundStart(i,n)}else console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),v()},onChatInputUpdateState:i=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",i),!le(i,!0))return;const t=Q.getCachedUIState(i);t&&R(t.enabled,t.placeholder)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),a.loadPlanTemplateList(),r.hasUnprocessedTask()&&r.currentTask?($.value=r.currentTask.prompt,console.log("[Direct] Setting prompt from store:",$.value),r.markTaskAsProcessed(),console.log("[Direct] Received task from store:",$.value)):($.value=s.query.prompt||"",console.log("[Direct] Received task from URL:",$.value),console.log("[Direct] No unprocessed task in store"));const f=localStorage.getItem("directPanelWidth");f&&(U.value=parseFloat(f)),console.log("[Direct] Final prompt value:",$.value)}),st(()=>r.currentTask,f=>{console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",f),f&&!f.processed?($.value=f.prompt,r.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",$.value)):console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),st(()=>$.value,(f,i)=>{console.log("[Direct] prompt value changed from:",i,"to:",f)},{immediate:!1}),_e(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),k.value=null,Q.cleanup(),document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",J)});const I=f=>{X.value=!0,d.value=f.clientX,C.value=U.value,document.addEventListener("mousemove",L),document.addEventListener("mouseup",J),document.body.style.cursor="col-resize",document.body.style.userSelect="none",f.preventDefault()},L=f=>{if(!X.value)return;const i=window.innerWidth,n=(f.clientX-d.value)/i*100;let o=C.value+n;o=Math.max(20,Math.min(80,o)),U.value=o},J=()=>{X.value=!1,document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",J),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",U.value.toString())},H=()=>{U.value=50,localStorage.setItem("directPanelWidth","50")},le=(f,i=!1)=>!k.value||f===k.value||i&&(f==="ui-state"||f==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",f,"current:",k.value),!1),ce=f=>{console.log("[DirectView] Message sent from chat:",f),console.log("[DirectView] Delegating chat message to planExecutionManager:",f),Q.handleUserMessageSendRequested(f)},p=f=>{console.log("[DirectView] Send message from input:",f),console.log("[DirectView] Delegating message to planExecutionManager:",f),Q.handleUserMessageSendRequested(f)},v=()=>{console.log("[DirectView] Input cleared"),E.value&&typeof E.value.clear=="function"&&E.value.clear()},x=()=>{console.log("[DirectView] Input focused")},R=(f,i)=>{console.log("[DirectView] Input state updated:",f,i),z.value=!f},_=(f,i)=>{console.log("[DirectView] Step selected:",f,i),S.value&&typeof S.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",f,i),S.value.handleStepSelected(f,i)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},D=(f,i,t,n)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:f,subPlanId:i,stepIndex:t,subStepIndex:n}),S.value&&typeof S.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:f,subPlanId:i,stepIndex:t,subStepIndex:n}),S.value.handleSubPlanStepSelected(f,i,t,n)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},K=()=>{console.log("[DirectView] Plan mode button clicked"),a.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",a.isCollapsed)},se=()=>{l.push("/home")},re=()=>{l.push("/configs")},ue=async f=>{var i;if(console.log("[DirectView] Plan execution requested:",f),j.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}j.value=!0;try{const t=f.planData.planTemplateId||f.planData.planId;if(!t)throw new Error("没有找到计划模板ID");console.log("[Direct] Executing plan with templateId:",t,"params:",f.params),console.log("[Direct] About to call PlanActApiService.executePlan");let n;if((i=f.params)!=null&&i.trim()?(console.log("[Direct] Calling executePlan with params:",f.params.trim()),n=await oe.executePlan(t,f.params.trim())):(console.log("[Direct] Calling executePlan without params"),n=await oe.executePlan(t)),console.log("[Direct] Plan execution API response:",n),n.planId)console.log("[Direct] Got planId from response:",n.planId,"starting plan execution"),k.value=n.planId,console.log("[Direct] Set currentRootPlanId to:",n.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),Q.handlePlanExecutionRequested(n.planId,f.title);else throw console.error("[Direct] No planId in response:",n),new Error("执行计划失败：未返回有效的计划ID")}catch(t){console.error("[Direct] Plan execution failed:",t),console.error("[Direct] Error details:",{message:t.message,stack:t.stack}),k.value=null,M.value&&typeof M.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),M.value.addMessage("user",f.title),M.value.addMessage("assistant",`执行计划失败: ${t.message||"未知错误"}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`执行计划失败: ${t.message||"未知错误"}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),j.value=!1}};return(f,i)=>(m(),b("div",uo,[e("div",po,[y(pn,{onPlanExecutionRequested:ue}),e("div",{class:"left-panel",style:Ce({width:U.value+"%"})},[e("div",ho,[e("button",{class:"back-button",onClick:se},[y(c(w),{icon:"carbon:arrow-left"})]),e("h2",null,u(f.$t("conversation")),1),e("div",go,[y(ht),e("button",{class:"config-button",onClick:re,title:f.$t("direct.configuration")},[y(c(w),{icon:"carbon:settings-adjust",width:"20"})],8,vo)])]),e("div",mo,[y(to,{ref_key:"chatRef",ref:M,"initial-prompt":$.value||"",onUserMessageSendRequested:ce,onInputClear:v,onInputUpdateState:R,onInputFocus:x,onStepSelected:_,onSubPlanStepSelected:D},null,8,["initial-prompt"])]),y(ro,{ref_key:"inputRef",ref:E,disabled:z.value,placeholder:z.value?"等待任务完成...":c(h)("input.placeholder"),onSend:p,onClear:v,onFocus:x,onUpdateState:R,onPlanModeClicked:K},null,8,["disabled","placeholder"])],4),e("div",{class:"panel-resizer",onMousedown:I,onDblclick:H,title:f.$t("direct.panelResizeHint")},i[0]||(i[0]=[e("div",{class:"resizer-line"},null,-1)]),40,fo),y($s,{ref_key:"rightPanelRef",ref:S,style:Ce({width:100-U.value+"%"})},null,8,["style"])])]))}}),Co=ke(Po,[["__scopeId","data-v-c983740a"]]);export{Co as default};
