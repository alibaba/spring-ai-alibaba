var ht=Object.defineProperty;var mt=(T,t,n)=>t in T?ht(T,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):T[t]=n;var de=(T,t,n)=>mt(T,typeof t!="symbol"?t+"":t,n);import{d as Pe,u as De,c as be,o as Ee,a as h,b as d,n as ae,i as o,e,f as F,t as s,g,h as oe,F as me,q as _e,j as ie,w as ve,m as ye,A as Oe,r as S,l as pe,T as Ne,p as Fe,B as Ue,C as Ie,y as Be,D as vt,E as we,z as ue,G as gt,H as ft,x as ut,I as $t}from"./index-BUGgHSP7.js";import{I as f,_ as Se}from"./_plugin-vue_export-helper-BYa0H4tv.js";import{s as w,P as qe,u as pt}from"./sidebar-CAxea9dn.js";import{L as bt}from"./llm-check-BVkAKrj3.js";import{L as _t}from"./index-BkmZsptu.js";import{u as kt,a as yt}from"./useMessage-Dv-fCoE0.js";const Ct={class:"sidebar-content"},wt={class:"sidebar-content-header"},Pt={class:"sidebar-content-title"},St={class:"tab-switcher"},Et=["disabled"],It={key:0,class:"tab-content"},Tt={class:"new-task-section"},xt={class:"sidebar-content-list"},Dt={key:0,class:"loading-state"},Rt={key:1,class:"error-state"},Mt={key:2,class:"empty-state"},At=["onClick"],Nt={class:"task-icon"},Ft={class:"task-details"},Ut={class:"task-title"},Lt={class:"task-preview"},Bt={class:"task-time"},qt={class:"task-actions"},Vt=["title","onClick"],jt={key:1,class:"tab-content config-tab"},Ot={key:0,class:"config-container"},Wt={class:"template-info-header"},zt={class:"template-info"},Ht={class:"template-id"},Jt={class:"config-section"},Gt={class:"section-header"},Kt={class:"generator-content"},Xt=["placeholder"],Qt={class:"generator-actions"},Yt=["disabled"],Zt=["disabled"],en={class:"config-section"},tn={class:"section-header"},nn={class:"section-actions"},sn=["disabled","title"],on=["disabled","title"],an=["disabled"],ln=["placeholder"],cn={class:"config-section"},rn={class:"section-header"},dn={class:"execution-content"},un={class:"params-input-group"},pn={class:"params-help-text"},hn={class:"params-input-container"},mn=["placeholder"],vn=["title"],gn={class:"api-url-display"},fn={class:"api-url-label"},$n={class:"api-url"},bn={class:"api-url-display"},_n={class:"api-url-label"},kn=["disabled"],yn=Pe({__name:"index",emits:["planExecutionRequested"],setup(T,{expose:t,emit:n}){const{t:c}=De(),m=["currentPlanId","userRequest","rootPlanId"],$=be({get(){try{if(!w.jsonContent)return"";const b={...JSON.parse(w.jsonContent)};return m.forEach(P=>{delete b[P]}),JSON.stringify(b,null,2)}catch{return w.jsonContent}},set(a){try{if(!a.trim()){w.jsonContent="";return}const b=JSON.parse(a);let P={};try{P=JSON.parse(w.jsonContent||"{}")}catch{}const J={...b};m.forEach(I=>{P[I]!==void 0&&(J[I]=P[I])}),w.jsonContent=JSON.stringify(J)}catch{w.jsonContent=a}}}),r=n,E=async()=>{try{const a=await w.saveTemplate();a!=null&&a.duplicate?alert(c("sidebar.saveCompleted",{message:a.message,versionCount:a.versionCount})):a!=null&&a.saved?alert(c("sidebar.saveSuccess",{message:a.message,versionCount:a.versionCount})):a!=null&&a.message&&alert(c("sidebar.saveStatus",{message:a.message}))}catch(a){console.error("Failed to save plan modifications:",a),alert(a.message||c("sidebar.saveFailed"))}},L=async()=>{var a;try{await w.generatePlan(),alert(c("sidebar.generateSuccess",{templateId:((a=w.selectedTemplate)==null?void 0:a.id)??c("sidebar.unknown")}))}catch(b){console.error("Failed to generate plan:",b),alert(c("sidebar.generateFailed")+": "+b.message)}},y=async()=>{try{await w.updatePlan(),alert(c("sidebar.updateSuccess"))}catch(a){console.error("Failed to update plan:",a),alert(c("sidebar.updateFailed")+": "+a.message)}},M=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const a=w.preparePlanExecution();if(!a){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] Triggering plan execution request:",a),console.log("[Sidebar] Emitting planExecutionRequested event"),r("planExecutionRequested",a),console.log("[Sidebar] Event emitted")}catch(a){console.error("Error executing plan:",a),alert(c("sidebar.executeFailed")+": "+a.message)}finally{w.finishPlanExecution()}},H=a=>{if(isNaN(a.getTime()))return console.warn("Invalid date received:",a),c("time.unknown");const P=new Date().getTime()-a.getTime(),J=Math.floor(P/6e4),I=Math.floor(P/36e5),D=Math.floor(P/864e5);return J<1?c("time.now"):J<60?c("time.minuteAgo",{count:J}):I<24?c("time.hourAgo",{count:I}):D<30?c("time.dayAgo",{count:D}):a.toLocaleDateString("zh-CN")},G=(a,b)=>!a||a.length<=b?a:a.substring(0,b)+"...";return Ee(()=>{w.loadPlanTemplateList()}),t({loadPlanTemplateList:w.loadPlanTemplateList,toggleSidebar:w.toggleSidebar,currentPlanTemplateId:w.currentPlanTemplateId}),(a,b)=>(d(),h("div",{class:ae(["sidebar-wrapper",{"sidebar-wrapper-collapsed":o(w).isCollapsed}])},[e("div",Ct,[e("div",wt,[e("div",Pt,s(a.$t("sidebar.title")),1)]),e("div",St,[e("button",{class:ae(["tab-button",{active:o(w).currentTab==="list"}]),onClick:b[0]||(b[0]=P=>o(w).switchToTab("list"))},[g(o(f),{icon:"carbon:list",width:"16"}),oe(" "+s(a.$t("sidebar.templateList")),1)],2),e("button",{class:ae(["tab-button",{active:o(w).currentTab==="config"}]),onClick:b[1]||(b[1]=P=>o(w).switchToTab("config")),disabled:!o(w).selectedTemplate},[g(o(f),{icon:"carbon:settings",width:"16"}),oe(" "+s(a.$t("sidebar.configuration")),1)],10,Et)]),o(w).currentTab==="list"?(d(),h("div",It,[e("div",Tt,[e("button",{class:"new-task-btn",onClick:b[2]||(b[2]=P=>o(w).createNewTemplate())},[g(o(f),{icon:"carbon:add",width:"16"}),oe(" "+s(a.$t("sidebar.newPlan"))+" ",1),b[11]||(b[11]=e("span",{class:"shortcut"},"âŒ˜ K",-1))])]),e("div",xt,[o(w).isLoading?(d(),h("div",Dt,[g(o(f),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,s(a.$t("sidebar.loading")),1)])):o(w).errorMessage?(d(),h("div",Rt,[g(o(f),{icon:"carbon:warning",width:"20"}),e("span",null,s(o(w).errorMessage),1),e("button",{onClick:b[3]||(b[3]=(...P)=>o(w).loadPlanTemplateList&&o(w).loadPlanTemplateList(...P)),class:"retry-btn"},s(a.$t("sidebar.retry")),1)])):o(w).planTemplateList.length===0?(d(),h("div",Mt,[g(o(f),{icon:"carbon:document",width:"32"}),e("span",null,s(a.$t("sidebar.noTemplates")),1)])):(d(!0),h(me,{key:3},_e(o(w).sortedTemplates,P=>(d(),h("div",{key:P.id,class:ae(["sidebar-content-list-item",{"sidebar-content-list-item-active":P.id===o(w).currentPlanTemplateId}]),onClick:J=>o(w).selectTemplate(P)},[e("div",Nt,[g(o(f),{icon:"carbon:document",width:"20"})]),e("div",Ft,[e("div",Ut,s(P.title||a.$t("sidebar.unnamedPlan")),1),e("div",Lt,s(G(P.description||a.$t("sidebar.noDescription"),40)),1)]),e("div",Bt,s(H(o(w).parseDateTime(P.updateTime||P.createTime))),1),e("div",qt,[e("button",{class:"delete-task-btn",title:a.$t("sidebar.deleteTemplate"),onClick:ie(J=>o(w).deleteTemplate(P),["stop"])},[g(o(f),{icon:"carbon:close",width:"16"})],8,Vt)])],10,At))),128))])])):o(w).currentTab==="config"?(d(),h("div",jt,[o(w).selectedTemplate?(d(),h("div",Ot,[e("div",Wt,[e("div",zt,[e("h3",null,s(o(w).selectedTemplate.title||a.$t("sidebar.unnamedPlan")),1),e("span",Ht,"ID: "+s(o(w).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:b[4]||(b[4]=P=>o(w).switchToTab("list"))},[g(o(f),{icon:"carbon:arrow-left",width:"16"})])]),e("div",Jt,[e("div",Gt,[g(o(f),{icon:"carbon:generate",width:"16"}),e("span",null,s(a.$t("sidebar.planGenerator")),1)]),e("div",Kt,[ve(e("textarea",{"onUpdate:modelValue":b[5]||(b[5]=P=>o(w).generatorPrompt=P),class:"prompt-input",placeholder:a.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,Xt),[[ye,o(w).generatorPrompt]]),e("div",Qt,[e("button",{class:"btn btn-primary btn-sm",onClick:L,disabled:o(w).isGenerating||!o(w).generatorPrompt.trim()},[g(o(f),{icon:o(w).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:ae({spinning:o(w).isGenerating})},null,8,["icon","class"]),oe(" "+s(o(w).isGenerating?a.$t("sidebar.generating"):a.$t("sidebar.generatePlan")),1)],8,Yt),e("button",{class:"btn btn-secondary btn-sm",onClick:y,disabled:o(w).isGenerating||!o(w).generatorPrompt.trim()||!o(w).jsonContent.trim()},[g(o(f),{icon:"carbon:edit",width:"14"}),oe(" "+s(a.$t("sidebar.updatePlan")),1)],8,Zt)])])]),e("div",en,[e("div",tn,[g(o(f),{icon:"carbon:code",width:"16"}),e("span",null,s(a.$t("sidebar.jsonTemplate")),1),e("div",nn,[e("button",{class:"btn btn-sm",onClick:b[6]||(b[6]=(...P)=>o(w).rollbackVersion&&o(w).rollbackVersion(...P)),disabled:!o(w).canRollback,title:a.$t("sidebar.rollback")},[g(o(f),{icon:"carbon:undo",width:"14"})],8,sn),e("button",{class:"btn btn-sm",onClick:b[7]||(b[7]=(...P)=>o(w).restoreVersion&&o(w).restoreVersion(...P)),disabled:!o(w).canRestore,title:a.$t("sidebar.restore")},[g(o(f),{icon:"carbon:redo",width:"14"})],8,on),e("button",{class:"btn btn-primary btn-sm",onClick:E,disabled:o(w).isGenerating||o(w).isExecuting},[g(o(f),{icon:"carbon:save",width:"14"})],8,an)])]),ve(e("textarea",{"onUpdate:modelValue":b[8]||(b[8]=P=>$.value=P),class:"json-editor",placeholder:a.$t("sidebar.jsonPlaceholder"),rows:"12"},null,8,ln),[[ye,$.value]])]),e("div",cn,[e("div",rn,[g(o(f),{icon:"carbon:play",width:"16"}),e("span",null,s(a.$t("sidebar.executionController")),1)]),e("div",dn,[e("div",un,[e("label",null,s(a.$t("sidebar.executionParams")),1),e("div",pn,s(a.$t("sidebar.executionParamsHelp")),1),e("div",hn,[ve(e("input",{"onUpdate:modelValue":b[9]||(b[9]=P=>o(w).executionParams=P),class:"params-input",placeholder:a.$t("sidebar.executionParamsPlaceholder")},null,8,mn),[[ye,o(w).executionParams]]),e("button",{class:"clear-params-btn",onClick:b[10]||(b[10]=(...P)=>o(w).clearExecutionParams&&o(w).clearExecutionParams(...P)),title:a.$t("sidebar.clearParams")},[g(o(f),{icon:"carbon:close",width:"12"})],8,vn)])]),e("div",gn,[e("span",fn,s(a.$t("sidebar.apiUrl"))+":",1),e("code",$n,s(o(w).computedApiUrl),1)]),e("div",bn,[e("span",_n,s(a.$t("sidebar.statusApiUrl"))+":",1),b[12]||(b[12]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:M,disabled:o(w).isExecuting||o(w).isGenerating},[g(o(f),{icon:o(w).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:ae({spinning:o(w).isExecuting})},null,8,["icon","class"]),oe(" "+s(o(w).isExecuting?a.$t("sidebar.executing"):a.$t("sidebar.executePlan")),1)],8,kn)])])])):F("",!0)])):F("",!0)])],2))}}),Cn=Se(yn,[["__scopeId","data-v-b3ed0b42"]]);class Le{static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}static async getMemories(){try{const t=await fetch(`${this.BASE_URL}`);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get memory list:",t),t}}static async getMemory(t){try{const n=await fetch(`${this.BASE_URL}/single?memoryId=${t}`);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get memory :",n),n}}static async update(t,n){try{const c=await fetch(`${this.BASE_URL}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({memoryId:t,memoryName:n})});return await(await this.handleResponse(c)).json()}catch(c){throw console.error("Failed to update memory:",c),c}}static async delete(t){try{const n=await fetch(`${this.BASE_URL}/delete?memoryId=${t}`);await this.handleResponse(n)}catch(n){throw console.error("Failed to update memory:",n),n}}}de(Le,"BASE_URL","/api/memories");class wn{constructor(){de(this,"isCollapsed",!1);de(this,"selectMemoryId","");de(this,"loadMessages",()=>{});de(this,"intervalId")}toggleSidebar(){this.isCollapsed=!this.isCollapsed,this.isCollapsed?(this.loadMessages(),this.intervalId=window.setInterval(()=>{this.loadMessages()},3e3)):clearInterval(this.intervalId)}selectMemory(t){this.toggleSidebar(),this.selectMemoryId=t}defaultMemoryId(){this.selectMemoryId=this.generateRandomId()}clearMemoryId(){this.selectMemoryId=""}generateRandomId(){return Math.random().toString(36).substring(2,10)}setLoadMessages(t){this.loadMessages=t}}const $e=Oe(new wn),Pn={key:0,class:"app-container"},Sn={class:"app-content"},En={class:"header"},In={class:"relative"},Tn={class:"title-edit-group"},xn={id:"main-title",class:"main-title"},Dn={key:0,id:"title-edit-container",class:"title-edit-container"},Rn={class:"search-bar"},Mn={class:"search-container"},An=["placeholder"],Nn={class:"message-list",id:"message-list"},Fn={class:"message-header"},Un={class:"message-content"},Ln={class:"sender-info"},Bn={style:{display:"flex","align-items":"center"}},qn=["onClick"],Vn=["onClick"],jn=["onClick"],On={class:"action-buttons"},Wn=["onClick"],zn={class:"message-preview"},Hn={class:"preview-line"},Jn={key:0,class:"preview-line",style:{opacity:"0.8"}},Gn={class:"message-meta"},Kn={class:"message-id"},Xn={class:"meta-right"},Qn={key:0,class:"unread-count"},Yn={class:"message-time"},Zn=["id"],es={style:{display:"flex","flex-direction":"column",gap:"0.75rem"}},ts={class:"bubble-avatar"},ns={class:"bubble-content"},ss={class:"bubble-text"},os={key:0,class:"empty-state"},as={class:"modal-content"},ls={class:"modal-header"},is={class:"modal-title"},cs=["placeholder"],rs={id:"name-char-count",class:"char-count",style:{"text-align":"right",display:"block","margin-top":"0.25rem"}},ds={class:"modal-footer"},us={class:"modal-content"},ps={class:"modal-header"},hs={class:"modal-title"},ms={class:"state-text",id:"delete-message"},vs={class:"modal-footer"},gs=Pe({__name:"index",emits:["memory-selected"],setup(T,{emit:t}){const n=S(!1),c=S(""),m=S([]),$=S([]),r=S(!1),E=S(null),L=S(""),y=S(!1),M=S(null),H=new Map,G=t;Ee(()=>{$e.setLoadMessages(a)});const a=async()=>{try{const x=await Le.getMemories();m.value?m.value=x.map(B=>({...B,expanded:H.has(B.memoryId)?H.get(B.memoryId):!1})):m.value=x.map(B=>({...B,expanded:!1})),$.value=[...m.value],J()}catch(x){console.error("error:",x),m.value=[],$.value=[]}},b=x=>{$e.selectMemory(x),G("memory-selected")},P=x=>{const B=typeof x=="string"?parseInt(x,10):x;return isNaN(B)||B<=0?"unknow time":new Date(B.toString().length===13?B:B*1e3).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(","," ")},J=()=>{const x=c.value.toLowerCase().trim();if(!x){$.value=[...m.value];return}$.value=m.value.filter(B=>{const U=B.memoryName.toLowerCase().includes(x),ee=B.memoryId.toLowerCase().includes(x),ke=B.messages.some(C=>C.text.toLowerCase().includes(x));return U||ee||ke})},I=(x,B)=>{E.value=x,L.value=B,r.value=!0},D=()=>{r.value=!1,E.value=null},q=async()=>{if(!E.value)return;const x=L.value.trim()||"unknow name",B=m.value.findIndex(U=>U.memoryId===E.value);if(B!==-1){const U=m.value[B];try{const ee=await Le.update(U.memoryId,x);ee.messages||(ee.messages=[]),m.value[B]={...ee,expanded:U.expanded},J(),r.value=!1}catch(ee){console.error("error:",ee)}}},X=x=>{const B=m.value.find(U=>U.memoryId===x);if(B){B.expanded=!B.expanded,H.set(x,B.expanded);const U=$.value.findIndex(ee=>ee.memoryId===x);U!==-1&&($.value[U]={...B})}},A=x=>{M.value=x,y.value=!0},se=()=>{y.value=!1,M.value=null},le=async()=>{if(M.value)try{await Le.delete(M.value),m.value=m.value.filter(x=>x.memoryId!==M.value),J(),m.value.length===0&&$e.clearMemoryId(),y.value=!1,M.value=null}catch(x){console.error("error:",x)}};return(x,B)=>(d(),pe(Ue,{to:"body"},[g(Ne,{name:"modal"},{default:Fe(()=>[o($e).isCollapsed?(d(),h("div",Pn,[e("div",Sn,[e("div",En,[e("div",In,[e("div",Tn,[e("h1",xn,[e("span",null,s(x.$t("memory.title")),1)])]),n.value?(d(),h("div",Dn)):F("",!0)]),e("button",{class:"close-btn",onClick:B[0]||(B[0]=U=>o($e).isCollapsed=!1)},[g(o(f),{icon:"carbon:close"})])]),e("div",Rn,[e("div",Mn,[g(o(f),{class:"search-container-icon",icon:"carbon:search"}),ve(e("input",{type:"text",placeholder:x.$t("memory.searchPlaceholder"),class:"search-input","onUpdate:modelValue":B[1]||(B[1]=U=>c.value=U),onInput:J},null,40,An),[[ye,c.value]])])]),e("div",Nn,[e("div",null,[(d(!0),h(me,null,_e($.value,U=>(d(),h("div",{class:ae(["message-item",{expanded:U.expanded}]),key:U.memoryId},[e("div",Fn,[e("div",Un,[e("div",Ln,[e("div",Bn,[e("h3",{class:"sender-name",onClick:ie(ee=>b(U.memoryId),["stop"])},s(U.memoryName),9,qn),e("span",{onClick:ie(ee=>I(U.memoryId,U.memoryName),["stop"])},[g(o(f),{icon:"carbon:edit",style:{"margin-left":"10px",cursor:"pointer"}})],8,Vn)]),e("div",{class:"toggle-container",onClick:ie(ee=>X(U.memoryId),["stop"])},[g(o(f),{id:"toggle-"+U.memoryId,icon:"carbon:chevron-down",style:{cursor:"pointer"}},null,8,["id"])],8,jn),e("div",On,[e("button",{class:"delete-btn",onClick:ie(ee=>A(U.memoryId),["stop"])},[g(o(f),{icon:"carbon:delete"})],8,Wn)])]),e("div",zn,[e("p",Hn,s(U.messages.length>0?U.messages[0].text:"none message"),1),U.messages.length>1?(d(),h("p",Jn,s(U.messages[1].text),1)):F("",!0)]),e("div",Gn,[e("span",Kn,"ID: "+s(U.memoryId),1),e("div",Xn,[U.messages.length>0?(d(),h("span",Qn,s(U.messages.length)+" "+s(x.$t("memory.size")),1)):F("",!0),e("span",Yn,s(P(U.createTime)),1)])])])]),U.expanded?(d(),h("div",{key:0,id:"content-"+U.memoryId,class:"expanded-content"},[e("div",es,[(d(!0),h(me,null,_e(U.messages,(ee,ke)=>(d(),h("div",{class:"message-bubble",key:ke},[e("div",ts,s(ee.messageType),1),e("div",ns,[e("p",ss,s(ee.text),1)])]))),128))])],8,Zn)):F("",!0)],2))),128))]),$.value.length===0&&c.value?(d(),h("div",os,B[3]||(B[3]=[e("p",{class:"state-text"},"none message",-1)]))):F("",!0)]),r.value?(d(),h("div",{key:0,id:"name-edit-modal",class:"modal-overlay",onClick:ie(D,["self"])},[e("div",as,[e("div",ls,[e("h3",is,s(x.$t("memory.changeName")),1),ve(e("input",{type:"text","onUpdate:modelValue":B[2]||(B[2]=U=>L.value=U),class:"edit-input",placeholder:x.$t("memory.newNamePlaceholder"),maxlength:"100"},null,8,cs),[[ye,L.value]]),e("span",rs,s(L.value.length)+"/100 ",1)]),e("div",ds,[e("button",{id:"cancel-name",class:"modal-btn cancel-btn",onClick:D},s(x.$t("memory.cancel")),1),e("button",{id:"save-name",class:"modal-btn confirm-btn",onClick:q},s(x.$t("memory.save")),1)])])])):F("",!0),y.value?(d(),h("div",{key:1,id:"delete-modal",class:"modal-overlay",onClick:ie(se,["self"])},[e("div",us,[e("div",ps,[e("h3",hs,s(x.$t("memory.deleteHint")),1),e("p",ms,s(x.$t("memory.deleteHintPrefix"))+" "+s(M.value)+" "+s(x.$t("memory.deleteHintSuffix")),1)]),e("div",vs,[e("button",{id:"cancel-delete",class:"modal-btn cancel-btn",onClick:se},s(x.$t("memory.cancel")),1),e("button",{id:"confirm-delete",class:"modal-btn delete-btn-confirm",onClick:le},s(x.$t("memory.delete")),1)])])])):F("",!0)])])):F("",!0)]),_:1})]))}}),fs=Se(gs,[["__scopeId","data-v-a31aa6d4"]]);class We{static async sendMessage(t){return bt.withLlmCheck(async()=>{const n=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`API request failed: ${n.status}`);return await n.json()})}}de(We,"BASE_URL","/api/executor");class ze{static async getDetails(t){try{const n=await fetch(`${this.BASE_URL}/details/${t}`);if(n.status===404)return null;if(!n.ok){const $=await n.text();throw new Error(`Failed to get detailed information: ${n.status} - ${$}`)}const c=await n.text(),m=JSON.parse(c);return m&&typeof m=="object"&&!m.currentPlanId&&(m.currentPlanId=t),m}catch(n){return console.error("[CommonApiService] Failed to get plan details:",n),{currentPlanId:t,status:"failed",message:n instanceof Error?n.message:"Failed to save, please retry"}}}static async submitFormInput(t,n){const c=await fetch(`${this.BASE_URL}/submit-input/${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!c.ok){let $;try{$=await c.json()}catch{$={message:`Failed to submit form input: ${c.status}`}}throw new Error($.message||`Failed to submit form input: ${c.status}`)}const m=c.headers.get("content-type");return m&&m.indexOf("application/json")!==-1?await c.json():{success:!0}}static async getAllPrompts(){try{const t=await fetch(this.BASE_URL);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get Prompt list:",t),t}}static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}}de(ze,"BASE_URL","/api/executor");const xe=class xe{constructor(){de(this,"POLL_INTERVAL",5e3);de(this,"state",Oe({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));de(this,"callbacks",{});de(this,"planExecutionCache",new Map);de(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(t){return this.planExecutionCache.get(t)}getCachedUIState(t){return this.uiStateCache.get(t)}setCachedUIState(t,n){this.uiStateCache.set(t,n),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${t}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(t){return this.planExecutionCache.has(t)}setCachedPlanRecord(t,n){this.planExecutionCache.set(t,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${t}`)}clearCachedPlanRecord(t){const n=this.planExecutionCache.delete(t);return n&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${t}`),n}clearAllCachedRecords(){const t=this.planExecutionCache.size,n=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${t}, UI States: ${n}`)}static getInstance(){return xe.instance||(xe.instance=new xe),xe.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(t){this.callbacks={...this.callbacks,...t},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(t))}async handleUserMessageSendRequested(t){if(this.validateAndPrepareUIForNewRequest(t))try{if(await this.sendUserMessageAndSetPlanId(t),this.state.activePlanId)this.initiatePlanExecutionSequence(t,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(n){console.error("[PlanExecutionManager] Failed to send user message:",n);const c=this.state.activePlanId??"error";this.setCachedUIState(c,{enabled:!0}),this.emitChatInputUpdateState(c),this.state.activePlanId=null}}handlePlanExecutionRequested(t,n){console.log("[PlanExecutionManager] Received plan execution request:",{planId:t,query:n}),t?(this.state.activePlanId=t,this.initiatePlanExecutionSequence(n??"Execute Plan",t)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(t,n){const c=this.getCachedPlanRecord(t);return c!=null&&c.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${t}`),this.handlePlanExecutionRequested(c.currentPlanId,n),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${t}`),!1)}validateAndPrepareUIForNewRequest(t){if(!t)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const n=this.state.activePlanId??"ui-state";return this.setCachedUIState(n,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(n),!0}async sendUserMessageAndSetPlanId(t){try{const n=await We.sendMessage({input:t});if(n!=null&&n.planId)return this.state.activePlanId=n.planId,n;if(n!=null&&n.planTemplateId)return this.state.activePlanId=n.planTemplateId,{...n,planId:n.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",n),new Error("Failed to get valid planId from API response")}catch(n){throw console.error("[PlanExecutionManager] API call failed:",n),n}}initiatePlanExecutionSequence(t,n){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${t}", planId: ${n}`);const c=n;this.emitDialogRoundStart(c),this.startPolling()}handlePlanCompletion(t){this.emitPlanCompleted(t.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await qe.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}},5e3)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}t.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(t.rootPlanId??""))}handlePlanError(t){this.emitPlanError(t.message??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await qe.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}},5e3)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const t=await this.getPlanDetails(this.state.activePlanId);if(!t){console.warn("[PlanExecutionManager] No details received from API");return}if(t.status&&t.status==="failed"){this.handlePlanError(t);return}if(t.rootPlanId&&this.setCachedPlanRecord(t.rootPlanId,t),!t.steps||t.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(t.rootPlanId??""),this.handlePlanCompletion(t);return}this.emitPlanUpdate(t.rootPlanId??""),t.completed&&this.handlePlanCompletion(t)}catch(t){console.error("[PlanExecutionManager] Failed to poll plan status:",t)}finally{this.state.isPolling=!1}}}async getPlanDetails(t){try{const n=await ze.getDetails(t);return n!=null&&n.rootPlanId&&(this.planExecutionCache.set(n.rootPlanId,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${n.rootPlanId}`)),n}catch(n){return console.error("[PlanExecutionManager] Failed to get plan details:",n),{currentPlanId:t,status:"failed",message:n instanceof Error?n.message:"Failed to get plan"}}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(t){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(t)}emitDialogRoundStart(t){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(t)}emitPlanUpdate(t){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(t)}emitPlanCompleted(t){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(t)}emitPlanError(t){this.callbacks.onPlanError&&this.callbacks.onPlanError(t)}};de(xe,"instance",null);let je=xe;const he=je.getInstance();class Te{static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}static async getFileTree(t){try{const n=await fetch(`${this.BASE_URL}/tree/${t}`),m=await(await this.handleResponse(n)).json();if(!m.success)throw new Error(m.message||"Failed to get file tree");return m.data}catch(n){throw console.error("Failed to get file tree:",n),n}}static async getFileContent(t,n){try{const c=await fetch(`${this.BASE_URL}/content/${t}?path=${encodeURIComponent(n)}`),$=await(await this.handleResponse(c)).json();if(!$.success)throw new Error($.message||"Failed to get file content");return $.data}catch(c){throw console.error("Failed to get file content:",c),c}}static async downloadFile(t,n,c){try{const m=await fetch(`${this.BASE_URL}/download/${t}?path=${encodeURIComponent(n)}`);await this.handleResponse(m);const $=await m.blob(),r=window.URL.createObjectURL($),E=document.createElement("a");E.href=r,E.download=c||n.split("/").pop()||"download",document.body.appendChild(E),E.click(),window.URL.revokeObjectURL(r),document.body.removeChild(E)}catch(m){throw console.error("Failed to download file:",m),m}}static isTextFile(t,n){const c=["text/","application/json","application/xml","application/javascript","application/typescript"],m=[".txt",".md",".json",".xml",".html",".css",".js",".ts",".vue",".jsx",".tsx",".py",".java",".cpp",".c",".h",".sh",".bat",".yml",".yaml",".properties",".conf",".cfg"];if(c.some(r=>t.startsWith(r)))return!0;const $=n.toLowerCase();return m.some(r=>$.endsWith(r))}static getFileIcon(t){if(t.type==="directory")return"carbon:folder";const n=t.name.toLowerCase();return n.endsWith(".js")?"vscode-icons:file-type-js":n.endsWith(".ts")?"vscode-icons:file-type-typescript":n.endsWith(".vue")?"vscode-icons:file-type-vue":n.endsWith(".java")?"vscode-icons:file-type-java":n.endsWith(".py")?"vscode-icons:file-type-python":n.endsWith(".json")?"vscode-icons:file-type-json":n.endsWith(".xml")?"vscode-icons:file-type-xml":n.endsWith(".html")?"vscode-icons:file-type-html":n.endsWith(".css")?"vscode-icons:file-type-css":n.endsWith(".md")?"vscode-icons:file-type-markdown":n.endsWith(".yml")||n.endsWith(".yaml")?"vscode-icons:file-type-yaml":n.endsWith(".pdf")?"vscode-icons:file-type-pdf2":n.endsWith(".doc")||n.endsWith(".docx")?"vscode-icons:file-type-word":n.endsWith(".xls")||n.endsWith(".xlsx")?"vscode-icons:file-type-excel":n.endsWith(".ppt")||n.endsWith(".pptx")?"vscode-icons:file-type-powerpoint":n.match(/\.(jpg|jpeg|png|gif|bmp|svg)$/)?"carbon:image":n.match(/\.(zip|rar|7z|tar|gz)$/)?"carbon:archive":"carbon:document"}}de(Te,"BASE_URL","/api/file-browser");const $s={class:"file-tree-node"},bs={class:"node-icon"},_s={class:"node-name"},ks={key:1,class:"file-size"},ys={key:2,class:"node-actions"},Cs={key:0,class:"children"},ws=Pe({__name:"FileTreeNode",props:{node:{},level:{}},emits:["file-selected","download-file"],setup(T,{emit:t}){const n=T,c=t,m=S(n.level===0),$=S(!1),r=S(!1),E=S({}),L=()=>{n.node.type==="directory"&&(m.value=!m.value)},y=()=>{n.node.type==="directory"?L():M()},M=()=>{n.node.type==="file"&&c("file-selected",n.node),a()},H=()=>{c("download-file",n.node),a()},G=I=>{I.preventDefault(),r.value=!0,E.value={position:"fixed",top:`${I.clientY}px`,left:`${I.clientX}px`,zIndex:1e3},setTimeout(()=>{document.addEventListener("click",a)},0)},a=()=>{r.value=!1,document.removeEventListener("click",a)},b=async()=>{try{await navigator.clipboard.writeText(n.node.path)}catch(I){console.error("Failed to copy path:",I)}a()},P=()=>n.node.type==="directory"?m.value?"carbon:folder-open":"carbon:folder":Te.getFileIcon(n.node),J=I=>{if(I===0)return"0 B";const D=1024,q=["B","KB","MB","GB"],X=Math.floor(Math.log(I)/Math.log(D));return parseFloat((I/Math.pow(D,X)).toFixed(1))+" "+q[X]};return Ie(()=>{document.removeEventListener("click",a)}),(I,D)=>{const q=vt("FileTreeNode",!0);return d(),h("div",$s,[e("div",{class:ae(["node-content",{"is-directory":I.node.type==="directory","is-file":I.node.type==="file","is-expanded":m.value}]),style:Be({paddingLeft:`${I.level*16+12}px`}),onClick:y,onContextmenu:ie(G,["prevent"])},[I.node.type==="directory"?(d(),h("div",{key:0,class:"expand-icon",onClick:ie(L,["stop"])},[g(o(f),{icon:m.value?"carbon:chevron-down":"carbon:chevron-right",class:"chevron-icon"},null,8,["icon"])])):F("",!0),e("div",bs,[g(o(f),{icon:P()},null,8,["icon"])]),e("span",_s,s(I.node.name),1),I.node.type==="file"?(d(),h("span",ks,s(J(I.node.size)),1)):F("",!0),$.value?(d(),h("div",ys,[I.node.type==="file"?(d(),h("button",{key:0,onClick:D[0]||(D[0]=ie(X=>I.$emit("download-file",I.node),["stop"])),class:"action-btn download-btn",title:"Download"},[g(o(f),{icon:"carbon:download"})])):F("",!0)])):F("",!0)],38),I.node.type==="directory"&&m.value&&I.node.children?(d(),h("div",Cs,[(d(!0),h(me,null,_e(I.node.children,X=>(d(),pe(q,{key:X.path,node:X,level:I.level+1,onFileSelected:D[1]||(D[1]=A=>I.$emit("file-selected",A)),onDownloadFile:D[2]||(D[2]=A=>I.$emit("download-file",A))},null,8,["node","level"]))),128))])):F("",!0),r.value?(d(),h("div",{key:1,class:"context-menu",style:Be(E.value),onClick:D[3]||(D[3]=ie(()=>{},["stop"]))},[e("div",{class:"context-menu-item",onClick:M},[g(o(f),{icon:"carbon:view"}),D[4]||(D[4]=e("span",null,"Open",-1))]),I.node.type==="file"?(d(),h("div",{key:0,class:"context-menu-item",onClick:H},[g(o(f),{icon:"carbon:download"}),D[5]||(D[5]=e("span",null,"Download",-1))])):F("",!0),D[7]||(D[7]=e("div",{class:"context-menu-divider"},null,-1)),e("div",{class:"context-menu-item",onClick:b},[g(o(f),{icon:"carbon:copy"}),D[6]||(D[6]=e("span",null,"Copy Path",-1))])],4)):F("",!0)])}}}),Ps=Se(ws,[["__scopeId","data-v-4c2c30c7"]]),Ss={class:"file-browser"},Es={class:"file-browser-header"},Is={class:"header-actions"},Ts=["disabled","title"],xs={class:"file-browser-content"},Ds={class:"file-tree-panel"},Rs={key:0,class:"loading-state"},Ms={key:1,class:"error-state"},As={key:0,class:"waiting-for-files"},Ns={class:"message-content"},Fs={class:"tips"},Us=["disabled"],Ls={key:1,class:"actual-error"},Bs={key:2,class:"empty-state"},qs={key:3,class:"file-tree"},Vs={key:0,class:"file-content-panel"},js={class:"file-content-header"},Os={class:"file-info"},Ws={class:"file-name"},zs={class:"file-size"},Hs={class:"file-actions"},Js=["title"],Gs=["title"],Ks={class:"file-content-body"},Xs={key:0,class:"loading-content"},Qs={key:1,class:"content-error"},Ys={key:2,class:"file-content"},Zs={key:0,class:"text-content"},eo={key:1,class:"binary-content"},to=Pe({__name:"index",props:{planId:{}},setup(T){const t=T,{t:n}=De(),c=S(!1),m=S(null),$=S(null),r=S(null),E=S(null),L=S(!1),y=S(null),M=S(null),H=be(()=>!E.value||!r.value?!1:Te.isTextFile(E.value.mimeType,r.value.name)),G=be(()=>m.value&&(m.value.includes("Plan directory not found")||m.value.includes("not found"))),a=()=>{M.value&&(clearTimeout(M.value),M.value=null)},b=()=>{a(),M.value=window.setTimeout(()=>{G.value&&P()},5e3)},P=async()=>{if(t.planId){c.value=!0,m.value=null,a();try{$.value=await Te.getFileTree(t.planId)}catch(A){m.value=A instanceof Error?A.message:n("fileBrowser.loadError"),console.error("Failed to load file tree:",A);const se=A instanceof Error?A.message:"";(se.includes("Plan directory not found")||se.includes("not found"))&&b()}finally{c.value=!1}}},J=async A=>{if(A.type!=="directory"){r.value=A,E.value=null,L.value=!0,y.value=null;try{E.value=await Te.getFileContent(t.planId,A.path)}catch(se){y.value=se instanceof Error?se.message:n("fileBrowser.contentLoadError"),console.error("Failed to load file content:",se)}finally{L.value=!1}}},I=async A=>{try{await Te.downloadFile(t.planId,A.path,A.name)}catch(se){console.error("Failed to download file:",se)}},D=()=>{r.value=null,E.value=null,y.value=null},q=A=>Te.getFileIcon(A),X=A=>{if(A===0)return"0 B";const se=1024,le=["B","KB","MB","GB"],x=Math.floor(Math.log(A)/Math.log(se));return parseFloat((A/Math.pow(se,x)).toFixed(1))+" "+le[x]};return we(()=>t.planId,A=>{A&&(r.value=null,E.value=null,P())},{immediate:!0}),Ee(()=>{t.planId&&P()}),Ie(()=>{a()}),(A,se)=>(d(),h("div",Ss,[e("div",Es,[e("h3",null,s(A.$t("fileBrowser.title")),1),e("div",Is,[e("button",{class:"refresh-btn",onClick:P,disabled:c.value,title:A.$t("fileBrowser.refresh")},[g(o(f),{icon:"carbon:refresh",class:ae({rotating:c.value}),style:{color:"#ffffff",fontSize:"18px",width:"18px",height:"18px"}},null,8,["class"])],8,Ts)])]),e("div",xs,[e("div",Ds,[c.value?(d(),h("div",Rs,[g(o(f),{icon:"carbon:loading",class:"rotating"}),e("span",null,s(A.$t("fileBrowser.loading")),1)])):m.value?(d(),h("div",Ms,[G.value?(d(),h("div",As,[g(o(f),{icon:"carbon:time",class:"rotating"}),e("div",Ns,[e("h3",null,s(A.$t("fileBrowser.waitingForGeneration")),1),e("p",null,s(A.$t("fileBrowser.planExecuting")),1),e("div",Fs,[g(o(f),{icon:"carbon:information"}),e("span",null,s(A.$t("fileBrowser.filesTip")),1)])]),e("button",{onClick:P,class:"retry-btn",disabled:c.value},[g(o(f),{icon:"carbon:refresh",class:ae({rotating:c.value})},null,8,["class"]),oe(" "+s(c.value?A.$t("fileBrowser.checking"):A.$t("fileBrowser.checkNow")),1)],8,Us)])):(d(),h("div",Ls,[g(o(f),{icon:"carbon:warning"}),e("span",null,s(m.value),1),e("button",{onClick:P,class:"retry-btn"},s(A.$t("fileBrowser.retry")),1)]))])):$.value?(d(),h("div",qs,[g(Ps,{node:$.value,level:0,onFileSelected:J,onDownloadFile:I},null,8,["node"])])):(d(),h("div",Bs,[g(o(f),{icon:"carbon:folder-off"}),e("span",null,s(A.$t("fileBrowser.noFiles")),1)]))]),r.value?(d(),h("div",Vs,[e("div",js,[e("div",Os,[g(o(f),{icon:q(r.value)},null,8,["icon"]),e("span",Ws,s(r.value.name),1),e("span",zs,"("+s(X(r.value.size))+")",1)]),e("div",Hs,[e("button",{onClick:se[0]||(se[0]=le=>I(r.value)),class:"download-btn",title:A.$t("fileBrowser.download")},[g(o(f),{icon:"carbon:download"})],8,Js),e("button",{onClick:D,class:"close-btn",title:A.$t("common.close")},[g(o(f),{icon:"carbon:close"})],8,Gs)])]),e("div",Ks,[L.value?(d(),h("div",Xs,[g(o(f),{icon:"carbon:loading",class:"rotating"}),e("span",null,s(A.$t("fileBrowser.loadingContent")),1)])):y.value?(d(),h("div",Qs,[g(o(f),{icon:"carbon:warning"}),e("span",null,s(y.value),1)])):E.value?(d(),h("div",Ys,[H.value?(d(),h("div",Zs,[e("pre",null,[e("code",null,s(E.value.content),1)])])):(d(),h("div",eo,[g(o(f),{icon:"carbon:document-unknown"}),e("p",null,s(A.$t("fileBrowser.binaryFile")),1),e("button",{onClick:se[1]||(se[1]=le=>I(r.value)),class:"download-btn-large"},[g(o(f),{icon:"carbon:download"}),oe(" "+s(A.$t("fileBrowser.downloadToView")),1)])]))])):F("",!0)])])):F("",!0)])]))}}),no=Se(to,[["__scopeId","data-v-2a488cd0"]]),so={class:"right-panel"},oo={class:"preview-header"},ao={class:"preview-tabs"},lo={class:"preview-content"},io={key:0,class:"step-details"},co={key:0,class:"step-info-fixed"},ro={key:0,class:"agent-info"},uo={class:"info-item"},po={class:"label"},ho={class:"value"},mo={class:"info-item"},vo={class:"label"},go={class:"value"},fo={class:"info-item"},$o={class:"label"},bo={class:"value"},_o={class:"info-item"},ko={class:"label"},yo={class:"value"},Co={class:"info-item"},wo={class:"label"},Po={class:"execution-status"},So={class:"status-item"},Eo={class:"status-text"},Io={key:0},To={key:0,class:"think-act-steps"},xo={class:"steps-container"},Do={class:"step-header"},Ro={class:"step-number"},Mo={class:"think-section"},Ao={class:"think-content"},No={class:"input"},Fo={class:"label"},Uo={class:"output"},Lo={class:"label"},Bo={key:0,class:"action-section"},qo={class:"action-content"},Vo={class:"tool-info"},jo={class:"label"},Oo={class:"value"},Wo={class:"input"},zo={class:"label"},Ho={class:"output"},Jo={class:"label"},Go={key:0,class:"sub-plan-section"},Ko={class:"sub-plan-content"},Xo={class:"sub-plan-header"},Qo={class:"sub-plan-info"},Yo={class:"label"},Zo={class:"value"},ea={key:0,class:"sub-plan-info"},ta={class:"label"},na={class:"value"},sa={class:"sub-plan-status"},oa={class:"status-text"},aa={key:0,class:"no-steps-message"},la={key:1,class:"no-execution-message"},ia={class:"step-basic-info"},ca={class:"info-item"},ra={class:"label"},da={class:"value"},ua={key:0,class:"info-item"},pa={class:"label"},ha={class:"value"},ma={class:"info-item"},va={class:"label"},ga={class:"no-execution-hint"},fa={key:2,class:"execution-indicator"},$a={class:"execution-text"},ba={key:1,class:"no-selection"},_a=["title"],ka={key:1,class:"file-browser-container"},ya={key:1,class:"no-plan-message"},Ca={class:"message-content"},wa={class:"tips"},Pa=Pe({__name:"index",props:{currentRootPlanId:{}},setup(T,{expose:t}){const n=T,{t:c}=De(),m=S(),$=S(),r=S(),E=S("details"),L=S(localStorage.getItem("jmanus-last-plan-id")),y=S(localStorage.getItem("jmanus-has-executed-plan")==="true"),M=S(null),H=S(!1),G=S(!0),a=S(!0),b=be(()=>r.value?r.value.completed?c("rightPanel.status.completed"):r.value.current?c("rightPanel.status.executing"):c("rightPanel.status.waiting"):""),P=be(()=>n.currentRootPlanId?n.currentRootPlanId:L.value),J=be(()=>!P.value&&!y.value),I=C=>{var K;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${C}`),r.value&&M.value){const W=M.value.rootPlanId??$.value;if(W&&W!==C){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${W}, Requested: ${C}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${C}`);const N=he.getCachedPlanRecord(C);if(!N){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${C}`);return}if(N.steps&&N.steps.length>0){const W=N.steps.length,R=(N.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${R} / ${W}`)}if(r.value&&$.value&&($.value===C||((K=M.value)==null?void 0:K.rootPlanId)===C)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${C}`),M.value)){const R=M.value,V=q(R.planId,R.rootPlanId,R.subPlanId);V?(X(V,R.stepIndex,R.planId,R.isSubPlan),B()):console.warn("[RightPanel] Could not find plan record for refresh:",R)}},D=(C,N,K,W,R)=>{console.log("[RightPanel] Step selected:",{planId:C,stepIndex:N,rootPlanId:K,subPlanId:W,subStepIndex:R});const V=!!(K&&W&&R!==void 0);M.value={planId:C,stepIndex:N,isSubPlan:V,...V&&{rootPlanId:K,subPlanId:W,subStepIndex:R}};const k=q(C,K,W);if(!k){console.warn("[RightPanel] Plan data not found:",{planId:C,rootPlanId:K,subPlanId:W}),r.value=null,M.value=null;return}X(k,N,C,V)},q=(C,N,K)=>{var V;if(!N||!K)return he.getCachedPlanRecord(C)??null;const W=he.getCachedPlanRecord(C);if(W)return W;const R=he.getCachedPlanRecord(N);if(!(R!=null&&R.agentExecutionSequence))return null;for(const k of R.agentExecutionSequence)if(k.thinkActSteps){for(const p of k.thinkActSteps)if(((V=p.subPlanExecutionRecord)==null?void 0:V.currentPlanId)===K)return p.subPlanExecutionRecord}return null},X=(C,N,K,W)=>{var O,re,i,l,u;if(!C.steps||N>=C.steps.length){r.value=null,M.value=null,console.warn("[RightPanel] Invalid step data:",{planId:K,stepIndex:N,hasSteps:!!C.steps,stepsLength:(O=C.steps)==null?void 0:O.length,message:"Invalid step index"});return}$.value=K;const R=C.steps[N],V=(re=C.agentExecutionSequence)==null?void 0:re[N];console.log("[RightPanel] Step data details:",{planId:K,stepIndex:N,step:R,hasAgentExecutionSequence:!!C.agentExecutionSequence,agentExecutionSequenceLength:(i=C.agentExecutionSequence)==null?void 0:i.length,agentExecution:V,hasThinkActSteps:!!(V!=null&&V.thinkActSteps),thinkActStepsLength:(l=V==null?void 0:V.thinkActSteps)==null?void 0:l.length,isSubPlan:W});const k=(V==null?void 0:V.status)==="FINISHED",p=!k&&N===C.currentStepIndex&&!C.completed,v={planId:K,index:N,title:typeof R=="string"?R:R.title||R.description||R.name||`${W?"Sub ":""}Step ${N+1}`,description:typeof R=="string"?R:R.description||R,completed:k,current:p};V&&(v.agentExecution=V),r.value=v,console.log("[RightPanel] Step details updated:",{planId:K,stepIndex:N,stepTitle:r.value.title,hasAgentExecution:!!V,hasThinkActSteps:(((u=V==null?void 0:V.thinkActSteps)==null?void 0:u.length)??0)>0,completed:k,current:p,planCurrentStep:C.currentStepIndex,planCompleted:C.completed,isSubPlan:W}),V!=null&&V.thinkActSteps&&V.thinkActSteps.forEach((_,Q)=>{_.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${Q}:`,_.subPlanExecutionRecord)}),setTimeout(()=>{le()},100),B()},A=(C,N,K,W)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:C,subPlanId:N,stepIndex:K,subStepIndex:W}),D(N,W,C,N,W)},se=C=>{m.value=C??void 0},le=()=>{if(!m.value)return;const{scrollTop:C,scrollHeight:N,clientHeight:K}=m.value,W=N-C-K<50,R=N>K;G.value=W,H.value=R&&!W,W?a.value=!0:N-C-K>100&&(a.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:C,scrollHeight:N,clientHeight:K,isAtBottom:W,hasScrollableContent:R,showButton:H.value,shouldAutoScroll:a.value})},x=()=>{m.value&&(m.value.scrollTo({top:m.value.scrollHeight,behavior:"smooth"}),ue(()=>{a.value=!0,le()}))},B=()=>{!a.value||!m.value||ue(()=>{m.value&&(m.value.scrollTop=m.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},U=C=>{if(C===null||typeof C>"u"||C==="")return"N/A";try{const N=typeof C=="object"?C:JSON.parse(C);return JSON.stringify(N,null,2)}catch{return String(C)}},ee=()=>{r.value=null,$.value=void 0,a.value=!0,m.value&&m.value.removeEventListener("scroll",le)},ke=()=>{const C=()=>{const N=m.value;return N?(se(N),N.addEventListener("scroll",le),a.value=!0,le(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};ue(()=>{C()||setTimeout(()=>{C()},100)})};return we(()=>n.currentRootPlanId,(C,N)=>{C&&C!==N?(L.value=C,y.value=!0,localStorage.setItem("jmanus-last-plan-id",C),localStorage.setItem("jmanus-has-executed-plan","true"),console.log("[RightPanel] New plan started:",C)):!C&&N&&console.log("[RightPanel] Plan execution finished, keeping last plan:",L.value)},{immediate:!0}),Ee(()=>{console.log("[RightPanel] Component mounted"),ue(()=>{ke()})}),Ie(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),M.value=null,ee()}),t({updateDisplayedPlanProgress:I,handleStepSelected:D,handleSubPlanStepSelected:A}),(C,N)=>{var K,W;return d(),h("div",so,[e("div",oo,[e("div",ao,[e("div",{class:ae(["tab-item",{active:E.value==="details"}]),onClick:N[0]||(N[0]=R=>E.value="details")},[g(o(f),{icon:"carbon:events"}),e("span",null,s(o(c)("rightPanel.stepExecutionDetails")),1)],2),e("div",{class:ae(["tab-item",{active:E.value==="files"}]),onClick:N[1]||(N[1]=R=>E.value="files")},[g(o(f),{icon:"carbon:folder"}),e("span",null,s(o(c)("fileBrowser.title")),1)],2)])]),e("div",lo,[E.value==="details"?(d(),h("div",io,[r.value?(d(),h("div",co,[e("h3",null,s(r.value.title||r.value.description||o(c)("rightPanel.defaultStepTitle",{number:r.value.index+1})),1),r.value.agentExecution?(d(),h("div",ro,[e("div",uo,[e("span",po,s(o(c)("rightPanel.executingAgent"))+":",1),e("span",ho,s(r.value.agentExecution.agentName),1)]),e("div",mo,[e("span",vo,s(o(c)("rightPanel.description"))+":",1),e("span",go,s(r.value.agentExecution.agentDescription||""),1)]),e("div",fo,[e("span",$o,s(o(c)("rightPanel.callingModel"))+":",1),e("span",bo,s(r.value.agentExecution.modelName),1)]),e("div",_o,[e("span",ko,s(o(c)("rightPanel.request"))+":",1),e("span",yo,s(r.value.agentExecution.agentRequest||""),1)]),e("div",Co,[e("span",wo,s(o(c)("rightPanel.executionResult"))+":",1),e("span",{class:ae(["value",{success:r.value.agentExecution.status==="FINISHED"}])},s(r.value.agentExecution.status||o(c)("rightPanel.executing")),3)])])):F("",!0),e("div",Po,[e("div",So,[r.value.completed?(d(),pe(o(f),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):r.value.current?(d(),pe(o(f),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(d(),pe(o(f),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",Eo,s(b.value),1)])])])):F("",!0),e("div",{ref_key:"scrollContainer",ref:m,class:"step-details-scroll-container",onScroll:le},[r.value?(d(),h("div",Io,[(K=r.value.agentExecution)!=null&&K.thinkActSteps&&r.value.agentExecution.thinkActSteps.length>0?(d(),h("div",To,[e("h4",null,s(o(c)("rightPanel.thinkAndActionSteps")),1),e("div",xo,[(d(!0),h(me,null,_e(r.value.agentExecution.thinkActSteps,(R,V)=>(d(),h("div",{key:V,class:"think-act-step"},[e("div",Do,[e("span",Ro,"#"+s(V+1),1),e("span",{class:ae(["step-status",R.status])},s(R.status||o(c)("rightPanel.executing")),3)]),e("div",Mo,[e("h5",null,[g(o(f),{icon:"carbon:thinking"}),oe(" "+s(o(c)("rightPanel.thinking")),1)]),e("div",Ao,[e("div",No,[e("span",Fo,s(o(c)("rightPanel.input"))+":",1),e("pre",null,s(U(R.thinkInput)),1)]),e("div",Uo,[e("span",Lo,s(o(c)("rightPanel.output"))+":",1),e("pre",null,s(U(R.thinkOutput)),1)])])]),R.actionNeeded?(d(),h("div",Bo,[e("h5",null,[g(o(f),{icon:"carbon:play"}),oe(" "+s(o(c)("rightPanel.action")),1)]),e("div",qo,[(d(!0),h(me,null,_e(R.actToolInfoList,(k,p)=>(d(),h("div",{key:p},[e("div",Vo,[e("span",jo,s(o(c)("rightPanel.tool"))+":",1),e("span",Oo,s(k.name||""),1)]),e("div",Wo,[e("span",zo,s(o(c)("rightPanel.toolParameters"))+":",1),e("pre",null,s(U(k.parameters)),1)]),e("div",Ho,[e("span",Jo,s(o(c)("rightPanel.executionResult"))+":",1),e("pre",null,s(U(k.result)),1)])]))),128))]),R.subPlanExecutionRecord?(d(),h("div",Go,[e("h5",null,[g(o(f),{icon:"carbon:tree-view"}),oe(" "+s(o(c)("rightPanel.subPlan")),1)]),e("div",Ko,[e("div",Xo,[e("div",Qo,[e("span",Yo,s(C.$t("rightPanel.subPlanId"))+":",1),e("span",Zo,s(R.subPlanExecutionRecord.currentPlanId),1)]),R.subPlanExecutionRecord.title?(d(),h("div",ea,[e("span",ta,s(C.$t("rightPanel.title"))+":",1),e("span",na,s(R.subPlanExecutionRecord.title),1)])):F("",!0),e("div",sa,[R.subPlanExecutionRecord.completed?(d(),pe(o(f),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(d(),pe(o(f),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",oa,s(R.subPlanExecutionRecord.completed?C.$t("rightPanel.status.completed"):C.$t("rightPanel.status.executing")),1)])])])])):F("",!0)])):F("",!0)]))),128))]),r.value.agentExecution&&!((W=r.value.agentExecution.thinkActSteps)!=null&&W.length)?(d(),h("div",aa,[e("p",null,s(o(c)("rightPanel.noStepDetails")),1)])):r.value.agentExecution?F("",!0):(d(),h("div",la,[g(o(f),{icon:"carbon:information",class:"info-icon"}),e("h4",null,s(o(c)("rightPanel.stepInfo")),1),e("div",ia,[e("div",ca,[e("span",ra,s(o(c)("rightPanel.stepName"))+":",1),e("span",da,s(r.value.title||r.value.description||C.$t("rightPanel.stepNumber",{number:r.value.index+1})),1)]),r.value.description?(d(),h("div",ua,[e("span",pa,s(C.$t("rightPanel.description"))+":",1),e("span",ha,s(r.value.description),1)])):F("",!0),e("div",ma,[e("span",va,s(C.$t("rightPanel.status.label"))+":",1),e("span",{class:ae(["value",{"status-completed":r.value.completed,"status-current":r.value.current,"status-pending":!r.value.completed&&!r.value.current}])},s(r.value.completed?C.$t("rightPanel.status.completed"):r.value.current?C.$t("rightPanel.status.executing"):C.$t("rightPanel.status.pending")),3)])]),e("p",ga,s(o(c)("rightPanel.noExecutionInfo")),1)])),r.value.current&&!r.value.completed?(d(),h("div",fa,[N[2]||(N[2]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",$a,[g(o(f),{icon:"carbon:in-progress",class:"rotating-icon"}),oe(" "+s(o(c)("rightPanel.stepExecuting")),1)])])):F("",!0)])):(d(),h("div",ba,[g(o(f),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,s(o(c)("rightPanel.noStepSelected")),1),e("p",null,s(o(c)("rightPanel.selectStepHint")),1)]))])):F("",!0),g(Ne,{name:"scroll-button"},{default:Fe(()=>[H.value?(d(),h("button",{key:0,onClick:x,class:"scroll-to-bottom-btn",title:o(c)("rightPanel.scrollToBottom")},[g(o(f),{icon:"carbon:chevron-down"})],8,_a)):F("",!0)]),_:1})],544)])):F("",!0),E.value==="files"?(d(),h("div",ka,[P.value?(d(),pe(no,{key:0,"plan-id":P.value},null,8,["plan-id"])):J.value?(d(),h("div",ya,[g(o(f),{icon:"carbon:folder-off"}),e("div",Ca,[e("h3",null,s(o(c)("fileBrowser.noFilesYet")),1),e("p",null,s(o(c)("fileBrowser.noPlanExecuting")),1),e("div",wa,[g(o(f),{icon:"carbon:information"}),e("span",null,s(o(c)("fileBrowser.startTaskTip")),1)])])])):F("",!0)])):F("",!0)])])}}}),Sa=Se(Pa,[["__scopeId","data-v-1f1365f7"]]);function Ea(){const T=he,t=be(()=>T.getActivePlanId()),n=be(()=>T.getState()),c=be(()=>n.value.isPolling),m=be(()=>!!t.value),$=(y,M)=>{T.initiatePlanExecutionSequence(y,M)},r=()=>{T.stopPolling()},E=()=>{T.startPolling()},L=()=>{T.cleanup()};return Ie(()=>{L()}),{activePlanId:t,state:n,isPolling:c,hasActivePlan:m,startExecution:$,stopPolling:r,startPolling:E,cleanup:L}}const Ia={class:"chat-container"},Ta={class:"message-content"},xa={key:0,class:"user-message"},Da={key:1,class:"assistant-message"},Ra={key:0,class:"thinking-section"},Ma={class:"thinking-header"},Aa={class:"thinking-avatar"},Na={class:"thinking-label"},Fa={class:"thinking-content"},Ua={key:0,class:"thinking"},La={key:1,class:"progress"},Ba={class:"progress-bar"},qa={class:"progress-text"},Va={key:2,class:"steps-container"},ja={class:"steps-title"},Oa=["onClick"],Wa={class:"section-header"},za={class:"step-icon"},Ha={class:"step-title"},Ja={key:0,class:"step-status current"},Ga={key:1,class:"step-status completed"},Ka={key:2,class:"step-status pending"},Xa={key:0,class:"action-info"},Qa={class:"action-description"},Ya={class:"action-icon"},Za={key:0,class:"tool-params"},el={class:"param-label"},tl={class:"param-content"},nl={key:1,class:"think-details"},sl={class:"think-header"},ol={class:"think-label"},al={class:"think-output"},ll={class:"think-content"},il={key:1,class:"sub-plan-steps"},cl={class:"sub-plan-header"},rl={class:"sub-plan-title"},dl={class:"sub-plan-step-list"},ul=["onClick"],pl={class:"sub-step-indicator"},hl={class:"sub-step-icon"},ml={class:"sub-step-number"},vl={class:"sub-step-content"},gl={class:"sub-step-title"},fl={class:"sub-step-badge"},$l={key:2,class:"user-input-form-container"},bl={class:"user-input-message"},_l={key:0,class:"form-description"},kl=["onSubmit"],yl=["for"],Cl=["id","name","onUpdate:modelValue"],wl={key:1,class:"form-group"},Pl={for:"form-input-genericInput"},Sl=["onUpdate:modelValue"],El={type:"submit",class:"submit-user-input-btn"},Il={key:3,class:"default-processing"},Tl={class:"processing-indicator"},xl={class:"response-section"},Dl={class:"response-header"},Rl={class:"response-avatar"},Ml={class:"response-name"},Al={class:"response-content"},Nl={key:0,class:"final-response"},Fl=["innerHTML"],Ul={key:1,class:"response-placeholder"},Ll={class:"typing-indicator"},Bl={class:"typing-text"},ql={key:0,class:"message assistant"},Vl={class:"message-content"},jl={class:"assistant-message"},Ol={class:"thinking-section"},Wl={class:"thinking-header"},zl={class:"thinking-avatar"},Hl={class:"thinking-label"},Jl={class:"thinking-content"},Gl={class:"default-processing"},Kl={class:"processing-indicator"},Xl={class:"response-section"},Ql={class:"response-header"},Yl={class:"response-avatar"},Zl={class:"response-name"},ei={class:"response-content"},ti={class:"response-placeholder"},ni={class:"typing-indicator"},si={class:"typing-text"},oi=["title"],ai=Pe({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(T,{expose:t,emit:n}){const c=T,m=n,{t:$}=De(),r=Ea(),E=S(),L=S(!1),y=S([]),M=S(),H=S(!1),G=Oe({}),a=(i,l,u)=>{const _={id:Date.now().toString(),type:i,content:l,timestamp:new Date,...u};return i==="assistant"&&!_.thinking&&!_.content&&(_.thinking=$("chat.thinking")),y.value.push(_),_},b=i=>{const l=y.value[y.value.length-1];l.type==="assistant"&&Object.assign(l,i)},P=async i=>{try{L.value=!0;const l=a("assistant","",{thinking:$("chat.thinkingProcessing")}),u=await We.sendMessage(i);if(u.planId)console.log("[ChatComponent] Received planId from direct execution:",u.planId),l.planExecution||(l.planExecution={}),l.planExecution.currentPlanId=u.planId,he.handlePlanExecutionRequested(u.planId,i.input),delete l.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete l.thinking;const _=J(u,i.input);l.content=_}}catch(l){console.error("Direct mode error:",l),b({content:I(l)})}finally{L.value=!1}},J=(i,l)=>i.result??i.message??i.content??"",I=i=>{const l=(i==null?void 0:i.message)??(i==null?void 0:i.toString())??$("chat.unknownError");return l.includes("network")||l.includes("timeout")?$("chat.networkError"):l.includes("auth")||l.includes("unauthorized")?$("chat.authError"):l.includes("invalid")||l.includes("format")||l.includes("parameter")?$("chat.formatError"):`${$("chat.unknownError")} (${l})`},D=(i=!1)=>{ue(()=>{if(E.value){const l=E.value;(i||l.scrollHeight-l.scrollTop-l.clientHeight<150)&&l.scrollTo({top:l.scrollHeight,behavior:i?"auto":"smooth"})}})},q=()=>{D(!0),H.value=!1},X=()=>{if(E.value){const i=E.value,l=i.scrollHeight-i.scrollTop-i.clientHeight<150;H.value=!l&&y.value.length>0}},A=()=>{E.value&&E.value.addEventListener("scroll",X)},se=()=>{E.value&&E.value.removeEventListener("scroll",X)},le=i=>{a("user",i.input),c.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",i.input):P(i)},x=(i,l)=>{var Q;const u=((Q=i.planExecution)==null?void 0:Q.agentExecutionSequence)??[];return l<0||l>=u.length?"IDLE":u[l].status??"IDLE"},B=(i,l)=>{var u,_;if(!((u=i.planExecution)!=null&&u.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:i.planExecution.currentPlanId,stepIndex:l,stepTitle:(_=i.planExecution.steps)==null?void 0:_[l]}),m("step-selected",i.planExecution.currentPlanId,l)},U=(i,l)=>{var u;try{const _=(u=i.planExecution)==null?void 0:u.agentExecutionSequence;if(!(_!=null&&_.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const Q=_[l];if(!Q)return console.log(`[ChatComponent] No agentExecution found for step ${l}`),[];if(!Q.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${l}`),[];for(const z of Q.thinkActSteps)if(z.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${l}:`,z.subPlanExecutionRecord),(z.subPlanExecutionRecord.steps??[]).map(Y=>typeof Y=="string"?Y:typeof Y=="object"&&Y!==null&&(Y.title||Y.description)||$("rightPanel.subStep"));return[]}catch(_){return console.warn("[ChatComponent] Error getting sub-plan steps:",_),[]}},ee=(i,l,u)=>{var _;try{const Q=(_=i.planExecution)==null?void 0:_.agentExecutionSequence;if(!(Q!=null&&Q.length))return"pending";const z=Q[l];if(!z||!z.thinkActSteps)return"pending";let ce=null;for(const Z of z.thinkActSteps)if(Z.subPlanExecutionRecord){ce=Z.subPlanExecutionRecord;break}if(!ce)return"pending";const Y=ce.currentStepIndex;return ce.completed?"completed":Y==null?u===0?"current":"pending":u<Y?"completed":u===Y?"current":"pending"}catch(Q){return console.warn("[ChatComponent] Error getting sub-plan step status:",Q),"pending"}},ke=(i,l,u)=>{var _,Q;try{const z=(_=i.planExecution)==null?void 0:_.agentExecutionSequence;if(!(z!=null&&z.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const ce=z[l];if(!ce){console.warn("[ChatComponent] No agentExecution found for step",l);return}if(!ce.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",l);return}let Y=null;for(const Z of ce.thinkActSteps)if(Z.subPlanExecutionRecord){Y=Z.subPlanExecutionRecord;break}if(!(Y!=null&&Y.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}m("sub-plan-step-selected",((Q=i.planExecution)==null?void 0:Q.currentPlanId)??"",Y.currentPlanId,l,u)}catch(z){console.error("[ChatComponent] Error handling sub-plan step click:",z)}},C=(i,l)=>{var _,Q,z,ce;if(!((_=i.planExecution)!=null&&_.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",i.planExecution.steps.length,"execution sequence:",((Q=l.agentExecutionSequence)==null?void 0:Q.length)??0);const u=new Array(i.planExecution.steps.length).fill(null);if((z=l.agentExecutionSequence)!=null&&z.length){const Y=Math.min(l.agentExecutionSequence.length,i.planExecution.steps.length);for(let Z=0;Z<Y;Z++){const j=l.agentExecutionSequence[Z];if((ce=j.thinkActSteps)!=null&&ce.length){const te=j.thinkActSteps[j.thinkActSteps.length-1];te.actionDescription&&te.toolParameters?(u[Z]={actionDescription:te.actionDescription,toolParameters:typeof te.toolParameters=="string"?te.toolParameters:JSON.stringify(te.toolParameters,null,2),thinkInput:te.thinkInput??"",thinkOutput:te.thinkOutput??"",status:l.currentStepIndex!==void 0&&Z<l.currentStepIndex?"completed":l.currentStepIndex!==void 0&&Z===l.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${Z} action set: ${u[Z].actionDescription}`)):(u[Z]={actionDescription:$("chat.thinking"),toolParameters:$("chat.waitingDecision"),thinkInput:te.thinkInput??"",thinkOutput:te.thinkOutput??"",status:l.currentStepIndex!==void 0&&Z===l.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${Z} is thinking`))}else u[Z]={actionDescription:l.currentStepIndex!==void 0&&Z<l.currentStepIndex?$("chat.status.completed"):$("chat.status.pending"),toolParameters:$("chat.noToolParameters"),thinkInput:"",thinkOutput:"",status:l.currentStepIndex!==void 0&&Z<l.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] Step ${Z} has no execution details, status set to: ${u[Z].status}`)}}else console.log("[ChatComponent] No execution sequence data");i.stepActions=[...u],console.log("[ChatComponent] Step actions update completed:",JSON.stringify(u.map(Y=>Y==null?void 0:Y.actionDescription))),ue(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},N=i=>{console.log("[ChatComponent] Starting dialog round with planId:",i),i&&(y.value.findIndex(u=>{var _;return((_=u.planExecution)==null?void 0:_.currentPlanId)===i&&u.type==="assistant"})===-1?(a("assistant","",{planExecution:{currentPlanId:i},thinking:$("chat.preparingExecution")}),console.log("[ChatComponent] Created new assistant message for planId:",i)):console.log("[ChatComponent] Found existing assistant message for planId:",i))},K=i=>{var z,ce,Y,Z;console.log("[ChatComponent] Processing plan update with rootPlanId:",i);const l=he.getCachedPlanRecord(i);if(!l){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",i);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",l),console.log("[ChatComponent] Plan steps:",l.steps),console.log("[ChatComponent] Plan completed:",l.completed),!l.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const u=y.value.findIndex(j=>{var te;return((te=j.planExecution)==null?void 0:te.currentPlanId)===l.currentPlanId&&j.type==="assistant"});let _;if(u!==-1)_=y.value[u],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",l.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",l.currentPlanId),console.log("[ChatComponent] Current messages:",y.value.map(te=>{var ge;return{type:te.type,planId:(ge=te.planExecution)==null?void 0:ge.currentPlanId,content:te.content.substring(0,50)}}));let j=-1;for(let te=y.value.length-1;te>=0;te--)if(y.value[te].type==="assistant"){j=te;break}if(j!==-1)_=y.value[j],_.planExecution||(_.planExecution={}),_.planExecution.currentPlanId=l.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",l.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(_.planExecution||(_.planExecution={}),_.planExecution=JSON.parse(JSON.stringify(l)),!l.steps||l.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),l.completed){delete _.thinking;const j=l.summary??l.result??l.message??$("chat.executionCompleted");_.content=W(j),console.log("[ChatComponent] Set simple response content:",_.content)}else l.title&&(_.thinking=`${$("chat.thinkingExecuting",{title:l.title})}`);return}delete _.thinking;const Q=l.steps.map(j=>typeof j=="string"?j:typeof j=="object"&&j!==null&&(j.title||j.description)||$("chat.step"));if(_.planExecution&&(_.planExecution.steps=Q),l.agentExecutionSequence&&l.agentExecutionSequence.length>0){console.log("[ChatComponent] Found execution sequence data, count:",l.agentExecutionSequence.length),C(_,l);const j=l.currentStepIndex??0;if(j>=0&&j<l.agentExecutionSequence.length){const ge=l.agentExecutionSequence[j].thinkActSteps;if(ge&&ge.length>0){const Re=ge[ge.length-1];if(Re.thinkOutput){const Ve=Re.thinkOutput.length>150?Re.thinkOutput.substring(0,150)+"...":Re.thinkOutput;_.thinking=`${$("chat.thinking")}: ${Ve}`}}}}else if(_.planExecution){const j=_.planExecution.currentStepIndex??0,te=(z=_.planExecution.steps)==null?void 0:z[j],ge=typeof te=="string"?te:"";_.thinking=`${$("chat.thinkingExecuting",{title:ge})}`}if(l.userInputWaitState&&_.planExecution?(console.log("[ChatComponent] User input required:",l.userInputWaitState),_.planExecution.userInputWaitState||(_.planExecution.userInputWaitState={}),_.planExecution.userInputWaitState={message:l.userInputWaitState.message??"",formDescription:l.userInputWaitState.formDescription??"",formInputs:((ce=l.userInputWaitState.formInputs)==null?void 0:ce.map(j=>({label:j.label,value:j.value||""})))??[]},G[Y=_.id]??(G[Y]={}),_.thinking=$("input.waiting")):(Z=_.planExecution)!=null&&Z.userInputWaitState&&delete _.planExecution.userInputWaitState,l.completed??l.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete _.thinking;let j="";l.summary?j=l.summary:l.result?j=l.result:j=$("chat.executionCompleted"),_.content=R(j),console.log("[ChatComponent] Updated completed message:",_.content)}ue(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},W=i=>i?i.includes("I ")||i.includes("you")||i.includes("hello")||i.includes("can")||i.includes("I")||i.includes("you")||i.includes("can")?i:i.length<10?`${i}! ${$("chat.anythingElse")}`:i.length<50?`${$("chat.okayDone",{text:i})}. ${$("chat.ifOtherQuestions")}`:`${i}

${$("chat.hopeHelpful")} ${$("chat.anythingElse")}`:$("chat.defaultResponse"),R=i=>i?`${i}`:`${$("chat.executionCompleted")}! ${$("chat.anythingElse")}`,V=i=>{console.log("[ChatComponent] Plan completed with rootPlanId:",i);const l=he.getCachedPlanRecord(i);if(!l){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",i);return}if(console.log("[ChatComponent] Plan details:",l),l.rootPlanId){const u=y.value.findIndex(_=>{var Q;return((Q=_.planExecution)==null?void 0:Q.currentPlanId)===l.rootPlanId});if(u!==-1){const _=y.value[u];delete _.thinking;let z=l.summary??l.result??$("chat.executionCompleted");!z.includes("I")&&!z.includes("you")&&(z.includes("success")||z.includes("complete")||z.includes("finished")?z=`${$("chat.great")}${z}. ${$("chat.ifOtherHelp")}`:z=`${$("chat.completedRequest",{result:z})}`),_.content=z,console.log("[ChatComponent] Updated completed message:",_.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",l.rootPlanId)}},k=i=>{L.value=!1,y.value[y.value.length-1]={id:Date.now().toString(),type:"assistant",content:i,timestamp:new Date}},p=i=>{if(!i)return"";let l=i.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return l=l.replace(/(<br><br>)/g,"</p><p>"),l.includes("</p><p>")&&(l=`<p>${l}</p>`),l},v=async i=>{var l;if(!((l=i.planExecution)!=null&&l.currentPlanId)||!i.planExecution.userInputWaitState){console.error("[ChatComponent] Missing planExecution.currentPlanId or userInputWaitState");return}try{const u={},_=i.planExecution.userInputWaitState.formInputs;_&&_.length>0?Object.entries(G[i.id]).forEach(([z,ce])=>{var j;const Y=parseInt(z,10),Z=((j=_[Y])==null?void 0:j.label)||`input_${z}`;u[Z]=ce}):u.genericInput=i.genericInput??"",console.log("[ChatComponent] Submitting user input:",u);const Q=await ze.submitFormInput(i.planExecution.currentPlanId,u);delete i.planExecution.userInputWaitState,delete i.genericInput,delete G[i.id],r.startPolling(),console.log("[ChatComponent] User input submitted successfully:",Q)}catch(u){console.error("[ChatComponent] User input submission failed:",u),alert(`${$("common.submitFailed")}: ${(u==null?void 0:u.message)||$("common.unknownError")}`)}};return we(()=>c.initialPrompt,(i,l)=>{console.log("[ChatComponent] initialPrompt changed from:",l,"to:",i),i&&typeof i=="string"&&i.trim()&&i!==l&&(console.log("[ChatComponent] Processing changed initial prompt:",i),ue(()=>{le({input:i})}))},{immediate:!1}),Ee(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),he.setEventCallbacks({onPlanUpdate:K,onPlanCompleted:V,onDialogRoundStart:N,onChatInputUpdateState:i=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",i)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")},onPlanError:k}),ue(()=>{A()}),c.initialPrompt&&typeof c.initialPrompt=="string"&&c.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",c.initialPrompt),ue(()=>{le({input:c.initialPrompt})}))}),Ie(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),se(),M.value&&clearInterval(M.value),r.cleanup(),Object.keys(G).forEach(i=>delete G[i])}),t({handleSendMessage:le,handlePlanUpdate:K,handlePlanCompleted:V,handleDialogRoundStart:N,addMessage:a,handlePlanError:k,showMemory:async()=>{if($e.selectMemoryId){const i=await Le.getMemory($e.selectMemoryId);y.value=[],i.messages.map(l=>{l.messageType.toLowerCase()==="user"&&a("user",l.text),l.messageType.toLowerCase()==="assistant"&&a("assistant",l.text)}),q()}},newChat:()=>{y.value=[]}}),(i,l)=>(d(),h("div",Ia,[e("div",{class:"messages",ref_key:"messagesRef",ref:E},[(d(!0),h(me,null,_e(y.value,u=>{var _,Q,z,ce,Y,Z,j,te,ge;return d(),h("div",{key:u.id,class:ae(["message",{user:u.type==="user",assistant:u.type==="assistant"}])},[e("div",Ta,[u.type==="user"?(d(),h("div",xa,s(u.content),1)):(d(),h("div",Da,[u.thinking||((_=u.planExecution)==null?void 0:_.progress)!==void 0||(((z=(Q=u.planExecution)==null?void 0:Q.steps)==null?void 0:z.length)??0)>0?(d(),h("div",Ra,[e("div",Ma,[e("div",Aa,[g(o(f),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Na,s(i.$t("chat.thinkingLabel")),1)]),e("div",Fa,[u.thinking?(d(),h("div",Ua,[g(o(f),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,s(u.thinking),1)])):F("",!0),((ce=u.planExecution)==null?void 0:ce.progress)!==void 0?(d(),h("div",La,[e("div",Ba,[e("div",{class:"progress-fill",style:Be({width:u.planExecution.progress+"%"})},null,4)]),e("span",qa,s(u.planExecution.progressText??i.$t("chat.processing")+"..."),1)])):F("",!0),(((Z=(Y=u.planExecution)==null?void 0:Y.steps)==null?void 0:Z.length)??0)>0?(d(),h("div",Va,[e("h4",ja,s(i.$t("chat.stepExecutionDetails")),1),(d(!0),h(me,null,_e((j=u.planExecution)==null?void 0:j.steps,(Re,ne)=>{var Ve,He,Je,Ge,Ke,Xe,Qe,Ye,Ze,et,tt,nt,st,ot,at,lt,it,ct,rt;return d(),h("div",{key:ne,class:ae(["ai-section",{running:x(u,ne)==="RUNNING",completed:x(u,ne)==="FINISHED",pending:x(u,ne)==="IDLE"}]),onClick:ie(Ce=>B(u,ne),["stop"])},[e("div",Wa,[e("span",za,s(x(u,ne)==="FINISHED"?"âœ“":x(u,ne)==="RUNNING"?"â–¶":"â—‹"),1),e("span",Ha,s(Re||`${i.$t("chat.step")} ${ne+1}`),1),x(u,ne)==="RUNNING"?(d(),h("span",Ja,s(i.$t("chat.status.executing")),1)):x(u,ne)==="FINISHED"?(d(),h("span",Ga,s(i.$t("chat.status.completed")),1)):(d(),h("span",Ka,s(i.$t("chat.status.pending")),1))]),u.stepActions&&u.stepActions[ne]?(d(),h("div",Xa,[e("div",Qa,[e("span",Ya,s(((Ve=u.stepActions[ne])==null?void 0:Ve.status)==="current"?"ðŸ”„":((He=u.stepActions[ne])==null?void 0:He.status)==="completed"?"âœ“":"â³"),1),e("strong",null,s((Je=u.stepActions[ne])==null?void 0:Je.actionDescription),1)]),(Ge=u.stepActions[ne])!=null&&Ge.toolParameters?(d(),h("div",Za,[l[0]||(l[0]=e("span",{class:"tool-icon"},"âš™ï¸",-1)),e("span",el,s(i.$t("common.parameters"))+":",1),e("pre",tl,s((Ke=u.stepActions[ne])==null?void 0:Ke.toolParameters),1)])):F("",!0),(Xe=u.stepActions[ne])!=null&&Xe.thinkOutput?(d(),h("div",nl,[e("div",sl,[l[1]||(l[1]=e("span",{class:"think-icon"},"ðŸ’­",-1)),e("span",ol,s(i.$t("chat.thinkingOutput"))+":",1)]),e("div",al,[e("pre",ll,s((Qe=u.stepActions[ne])==null?void 0:Qe.thinkOutput),1)])])):F("",!0)])):F("",!0),((Ye=U(u,ne))==null?void 0:Ye.length)>0?(d(),h("div",il,[e("div",cl,[g(o(f),{icon:"carbon:tree-view",class:"sub-plan-icon"}),e("span",rl,s(i.$t("rightPanel.subPlan")),1)]),e("div",dl,[(d(!0),h(me,null,_e(U(u,ne),(Ce,fe)=>(d(),h("div",{key:`sub-${ne}-${fe}`,class:ae(["sub-plan-step-item",{completed:ee(u,ne,fe)==="completed",current:ee(u,ne,fe)==="current",pending:ee(u,ne,fe)==="pending"}]),onClick:ie(dt=>ke(u,ne,fe),["stop"])},[e("div",pl,[e("span",hl,s(ee(u,ne,fe)==="completed"?"âœ“":ee(u,ne,fe)==="current"?"â–¶":"â—‹"),1),e("span",ml,s(fe+1),1)]),e("div",vl,[e("span",gl,s(Ce),1),e("span",fl,s(i.$t("rightPanel.subStep")),1)])],10,ul))),128))])])):F("",!0),(Ze=u.planExecution)!=null&&Ze.userInputWaitState&&x(u,ne)==="RUNNING"?(d(),h("div",$l,[e("p",bl,s(((tt=(et=u.planExecution)==null?void 0:et.userInputWaitState)==null?void 0:tt.message)??i.$t("chat.userInput.message")),1),(st=(nt=u.planExecution)==null?void 0:nt.userInputWaitState)!=null&&st.formDescription?(d(),h("p",_l,s((at=(ot=u.planExecution)==null?void 0:ot.userInputWaitState)==null?void 0:at.formDescription),1)):F("",!0),e("form",{onSubmit:ie(Ce=>v(u),["prevent"]),class:"user-input-form"},[(it=(lt=u.planExecution)==null?void 0:lt.userInputWaitState)!=null&&it.formInputs&&u.planExecution.userInputWaitState.formInputs.length>0?(d(!0),h(me,{key:0},_e((rt=(ct=u.planExecution)==null?void 0:ct.userInputWaitState)==null?void 0:rt.formInputs,(Ce,fe)=>(d(),h("div",{key:fe,class:"form-group"},[e("label",{for:`form-input-${Ce.label.replace(/\W+/g,"_")}`},s(Ce.label)+": ",9,yl),ve(e("input",{type:"text",id:`form-input-${Ce.label.replace(/\W+/g,"_")}`,name:Ce.label,"onUpdate:modelValue":dt=>G[u.id][fe]=dt,class:"form-input"},null,8,Cl),[[ye,G[u.id][fe]]])]))),128)):(d(),h("div",wl,[e("label",Pl,s(i.$t("common.input"))+":",1),ve(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":Ce=>u.genericInput=Ce,class:"form-input"},null,8,Sl),[[ye,u.genericInput]])])),e("button",El,s(i.$t("chat.userInput.submit")),1)],40,kl)])):F("",!0)],10,Oa)}),128))])):!u.content&&(u.thinking||((te=u.planExecution)==null?void 0:te.progress)!==void 0&&(((ge=u.planExecution)==null?void 0:ge.progress)??0)<100)?(d(),h("div",Il,[e("div",Tl,[l[2]||(l[2]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,s(u.thinking??i.$t("chat.thinkingProcessing")),1)])])):F("",!0)])])):F("",!0),e("div",xl,[e("div",Dl,[e("div",Rl,[g(o(f),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Ml,s(i.$t("chat.botName")),1)]),e("div",Al,[u.content?(d(),h("div",Nl,[e("div",{class:"response-text",innerHTML:p(u.content)},null,8,Fl)])):(d(),h("div",Ul,[e("div",Ll,[l[3]||(l[3]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Bl,s(i.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),L.value?(d(),h("div",ql,[e("div",Vl,[e("div",jl,[e("div",Ol,[e("div",Wl,[e("div",zl,[g(o(f),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Hl,s(i.$t("chat.thinkingLabel")),1)]),e("div",Jl,[e("div",Gl,[e("div",Kl,[l[4]||(l[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,s(i.$t("chat.thinking")),1)])])])]),e("div",Xl,[e("div",Ql,[e("div",Yl,[g(o(f),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Zl,s(i.$t("chat.botName")),1)]),e("div",ei,[e("div",ti,[e("div",ni,[l[5]||(l[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",si,s(i.$t("chat.thinkingResponse")),1)])])])])])])])):F("",!0)],512),H.value?(d(),h("div",{key:0,class:"scroll-to-bottom-btn",onClick:q,title:i.$t("chat.scrollToBottom")},[g(o(f),{icon:"carbon:chevron-down"})],8,oi)):F("",!0)]))}}),li=Se(ai,[["__scopeId","data-v-728fe752"]]),ii={class:"input-area"},ci={class:"input-container"},ri=["title"],di=["placeholder","disabled"],ui=["title"],pi=["disabled","title"],hi=Pe({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1},initialValue:{default:""}},emits:["send","clear","update-state","plan-mode-clicked"],setup(T,{expose:t,emit:n}){const{t:c}=De(),m=T,$=n,r=S(),E=S(""),L=be(()=>m.placeholder||c("input.placeholder")),y=S(L.value),M=be(()=>!!m.disabled),H=()=>{ue(()=>{r.value&&(r.value.style.height="auto",r.value.style.height=Math.min(r.value.scrollHeight,120)+"px")})},G=q=>{q.key==="Enter"&&!q.shiftKey&&(q.preventDefault(),a())},a=()=>{if(!E.value.trim()||M.value)return;$e.selectMemoryId||$e.defaultMemoryId();const q={input:E.value.trim(),memoryId:$e.selectMemoryId};$("send",q),P()},b=()=>{$("plan-mode-clicked")},P=()=>{E.value="",H(),$("clear")},J=(q,X)=>{X&&(y.value=q?X:c("input.waiting")),$("update-state",q,X)},I=q=>{E.value=q,H()},D=()=>E.value.trim();return we(()=>m.initialValue,q=>{q&&q.trim()&&(E.value=q,H())},{immediate:!0}),t({clearInput:P,updateState:J,setInputValue:I,getQuery:D,focus:()=>{var q;return(q=r.value)==null?void 0:q.focus()}}),Ee(()=>{}),Ie(()=>{}),(q,X)=>(d(),h("div",ii,[e("div",ci,[e("button",{class:"attach-btn",title:q.$t("input.attachFile")},[g(o(f),{icon:"carbon:attachment"})],8,ri),ve(e("textarea",{"onUpdate:modelValue":X[0]||(X[0]=A=>E.value=A),ref_key:"inputRef",ref:r,class:"chat-input",placeholder:y.value,disabled:M.value,onKeydown:G,onInput:H},null,40,di),[[ye,E.value]]),e("button",{class:"plan-mode-btn",title:q.$t("input.planMode"),onClick:b},[g(o(f),{icon:"carbon:document"}),oe(" "+s(q.$t("input.planMode")),1)],8,ui),e("button",{class:"send-button",disabled:!E.value.trim()||M.value,onClick:a,title:q.$t("input.send")},[g(o(f),{icon:"carbon:send-alt"}),oe(" "+s(q.$t("input.send")),1)],8,pi)])]))}}),mi=Se(hi,[["__scopeId","data-v-a39d9e9a"]]);class Me{static async getAllCronTasks(){try{const t=await fetch(this.BASE_URL);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get cron tasks:",t),t}}static async getCronTaskById(t){try{const n=await fetch(`${this.BASE_URL}/${t}`);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get cron task by id:",n),n}}static async createCronTask(t){try{const n=await fetch(this.BASE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to create cron task:",n),n}}static async updateCronTask(t,n){try{const c=await fetch(`${this.BASE_URL}/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});return await(await this.handleResponse(c)).json()}catch(c){throw console.error("Failed to update cron task:",c),c}}static async updateTaskStatus(t,n){try{const c=await fetch(`${this.BASE_URL}/${t}/status?status=${n}`,{method:"PUT"});await this.handleResponse(c)}catch(c){throw console.error("Failed to update task status:",c),c}}static async deleteCronTask(t){try{const n=await fetch(`${this.BASE_URL}/${t}`,{method:"DELETE"});await this.handleResponse(n)}catch(n){throw console.error("Failed to delete cron task:",n),n}}static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}}de(Me,"BASE_URL","/api/cron-tasks");const Ae={validateCronExpression(T){const t=T.trim().split(/\s+/);return t.length>=5&&t.length<=6},formatTime(T){return new Date(T).toLocaleString()},async saveTask(T){try{let t;return T.id?t=await Me.updateCronTask(Number(T.id),T):t=await Me.createCronTask(T),t}catch(t){throw console.error("Failed to save cron task:",t),t}},async deleteTask(T){try{await Me.deleteCronTask(String(T))}catch(t){throw console.error("Failed to delete cron task:",t),t}},async toggleTaskStatus(T){if(!T.id)throw new Error("Task ID is required");const t=T.status===0?1:0;return await Me.updateCronTask(Number(T.id),{...T,status:t})},prepareTaskExecution(T){return T.planTemplateId?{useTemplate:!0,planData:{title:T.cronName||"Scheduled Task Execution",planData:{id:T.planTemplateId,planTemplateId:T.planTemplateId,planId:T.planTemplateId},params:T.executionParams||void 0}}:{useTemplate:!1,taskContent:T.planDesc||T.cronName||""}}},vi={class:"modal-header"},gi={class:"header-actions"},fi={class:"status-switch"},$i={class:"status-label"},bi={class:"toggle-switch"},_i=["checked"],ki={class:"modal-content"},yi={class:"form-group"},Ci={class:"form-label"},wi=["placeholder"],Pi={class:"form-group"},Si={class:"form-label"},Ei=["placeholder"],Ii={class:"form-help"},Ti={class:"form-group"},xi={class:"form-label"},Di=["placeholder"],Ri={class:"form-group"},Mi={class:"form-label"},Ai={class:"template-toggle"},Ni={key:0,class:"template-selector"},Fi={value:""},Ui=["value"],Li={class:"form-help"},Bi={key:0,class:"form-group"},qi={class:"time-info"},Vi={class:"time-label"},ji={class:"time-value"},Oi={key:1,class:"form-group"},Wi={class:"time-info"},zi={class:"time-label"},Hi={class:"time-value"},Ji={class:"modal-footer"},Gi=["disabled"],Ki=Pe({__name:"TaskDetailModal",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","save"],setup(T,{emit:t}){const n=T,c=t,m=S(!1),$=S([]),r=S({cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""});Ee(async()=>{try{const a=await qe.getAllPlanTemplates();a&&a.templates&&($.value=a.templates.map(b=>({id:b.id,name:b.title||"Unnamed Template"})))}catch(a){console.error("Failed to get template list:",a)}});const L=a=>{a.target===a.currentTarget&&c("update:modelValue",!1)},y=()=>{r.value.linkTemplate=!1,r.value.templateId="",r.value.planTemplateId=""},M=()=>r.value.cronName.trim()?r.value.cronTime.trim()?Ae.validateCronExpression(r.value.cronTime)?r.value.planDesc.trim()?r.value.linkTemplate&&!r.value.templateId?(alert("Please select a plan template"),!1):!0:(alert("Task description cannot be empty"),!1):(alert("Invalid Cron expression format, should be 5-6 parts separated by spaces"),!1):(alert("Cron expression cannot be empty"),!1):(alert("Task name cannot be empty"),!1),H=a=>Ae.formatTime(a),G=async()=>{var a;if(M()){m.value=!0;try{const b={...r.value,...((a=n.task)==null?void 0:a.id)!==void 0&&{id:n.task.id},cronName:r.value.cronName.trim(),cronTime:r.value.cronTime.trim(),planDesc:r.value.planDesc.trim(),status:r.value.status,planTemplateId:r.value.linkTemplate&&r.value.templateId||""};c("save",b)}finally{m.value=!1}}};return we(()=>n.task,a=>{if(a){const b=a.templateId||a.planTemplateId||"";r.value={cronName:a.cronName||"",cronTime:a.cronTime||"",planDesc:a.planDesc||"",status:a.status??1,linkTemplate:!!b,templateId:b,planTemplateId:b}}else r.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""}},{immediate:!0}),we(()=>n.modelValue,a=>{a||(r.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""})}),(a,b)=>(d(),pe(Ue,{to:"body"},[g(Ne,{name:"modal"},{default:Fe(()=>{var P,J,I;return[a.modelValue?(d(),h("div",{key:0,class:"modal-overlay",onClick:L},[e("div",{class:"modal-container",onClick:b[8]||(b[8]=ie(()=>{},["stop"]))},[e("div",vi,[e("h3",null,s(a.$t("cronTask.taskDetail")),1),e("div",gi,[e("div",fi,[e("span",$i,s(a.$t("cronTask.taskStatus")),1),e("label",bi,[e("input",{type:"checkbox",checked:r.value.status===0,onChange:b[0]||(b[0]=D=>r.value.status=r.value.status===0?1:0)},null,40,_i),b[9]||(b[9]=e("span",{class:"toggle-slider"},null,-1))])]),e("button",{class:"close-btn",onClick:b[1]||(b[1]=D=>a.$emit("update:modelValue",!1))},[g(o(f),{icon:"carbon:close"})])])]),e("div",ki,[e("form",{onSubmit:ie(G,["prevent"]),class:"task-form"},[e("div",yi,[e("label",Ci,s(a.$t("cronTask.taskName")),1),ve(e("input",{"onUpdate:modelValue":b[2]||(b[2]=D=>r.value.cronName=D),type:"text",class:"form-input",placeholder:a.$t("cronTask.taskNamePlaceholder"),required:""},null,8,wi),[[ye,r.value.cronName]])]),e("div",Pi,[e("label",Si,s(a.$t("cronTask.cronExpression")),1),ve(e("input",{"onUpdate:modelValue":b[3]||(b[3]=D=>r.value.cronTime=D),type:"text",class:"form-input",placeholder:a.$t("cronTask.cronExpressionPlaceholder"),required:""},null,8,Ei),[[ye,r.value.cronTime]]),e("div",Ii,s(a.$t("cronTask.cronExpressionHelp")),1)]),e("div",Ti,[e("label",xi,s(a.$t("cronTask.taskDescription")),1),ve(e("textarea",{"onUpdate:modelValue":b[4]||(b[4]=D=>r.value.planDesc=D),class:"form-textarea",placeholder:a.$t("cronTask.taskDescriptionPlaceholder"),rows:"4",required:""},null,8,Di),[[ye,r.value.planDesc]])]),e("div",Ri,[e("label",Mi,s(a.$t("cronTask.planTemplate")),1),e("div",Ai,[e("button",{type:"button",class:ae(["template-btn",r.value.linkTemplate?"active":""]),onClick:b[5]||(b[5]=D=>r.value.linkTemplate=!0)},[g(o(f),{icon:"carbon:checkmark"}),oe(" "+s(a.$t("cronTask.linkTemplate")),1)],2),e("button",{type:"button",class:ae(["template-btn",r.value.linkTemplate?"":"active"]),onClick:y},[g(o(f),{icon:"carbon:close"}),oe(" "+s(a.$t("cronTask.noTemplate")),1)],2)]),r.value.linkTemplate?(d(),h("div",Ni,[ve(e("select",{"onUpdate:modelValue":b[6]||(b[6]=D=>r.value.templateId=D),class:"form-select"},[e("option",Fi,s(a.$t("cronTask.selectTemplate")),1),(d(!0),h(me,null,_e($.value,D=>(d(),h("option",{key:D.id,value:D.id},s(D.name),9,Ui))),128))],512),[[gt,r.value.templateId]]),e("div",Li,s(a.$t("cronTask.templateHelpText")),1)])):F("",!0)]),(P=a.task)!=null&&P.createTime?(d(),h("div",Bi,[e("div",qi,[e("span",Vi,s(a.$t("cronTask.createTime"))+":",1),e("span",ji,s(H(a.task.createTime)),1)])])):F("",!0),(J=a.task)!=null&&J.updateTime?(d(),h("div",Oi,[e("div",Wi,[e("span",zi,s(a.$t("cronTask.updateTime"))+":",1),e("span",Hi,s(H(a.task.updateTime)),1)])])):F("",!0)],32)]),e("div",Ji,[e("button",{type:"button",class:"cancel-btn",onClick:b[7]||(b[7]=D=>a.$emit("update:modelValue",!1))},s(a.$t("common.cancel")),1),e("button",{type:"button",class:"save-btn",onClick:G,disabled:m.value},[m.value?(d(),pe(o(f),{key:0,icon:"carbon:loading",class:"loading-icon"})):F("",!0),oe(" "+s((I=n.task)!=null&&I.id?a.$t("common.save"):a.$t("common.create")),1)],8,Gi)])])])):F("",!0)]}),_:1})]))}}),Xi=Se(Ki,[["__scopeId","data-v-1ac463d9"]]),Qi={class:"modal-header"},Yi={class:"header-actions"},Zi={class:"modal-content"},ec={key:0,class:"loading-container"},tc={key:1,class:"empty-container"},nc={key:2,class:"task-list"},sc=["onClick"],oc={class:"task-main"},ac={class:"task-info"},lc={class:"task-header"},ic={class:"task-name"},cc={class:"task-description"},rc={class:"task-time"},dc=["onClick"],uc=["onClick","disabled","title"],pc=["onClick","title"],hc={class:"dropdown-menu"},mc=["onClick"],vc=["onClick","disabled"],gc=["onClick","disabled"],fc={class:"confirm-header"},$c={class:"confirm-content"},bc={class:"confirm-actions"},_c=["disabled"],kc={class:"confirm-header"},yc={class:"confirm-content"},Cc={class:"create-options"},wc={class:"option-content"},Pc={class:"option-title"},Sc={class:"option-desc"},Ec={class:"option-content"},Ic={class:"option-title"},Tc={class:"option-desc"},xc={class:"confirm-actions"},Dc=Pe({__name:"index",props:{modelValue:{type:Boolean,required:!0}},emits:["update:modelValue"],setup(T,{emit:t}){const n=ut(),c=pt(),m=kt(),{t:$}=De(),r=T,E=t,L=S([]),y=S(!1),M=S(null),H=S(null),G=S(null),a=S(null),b=S(!1),P=S(null),J=S(!1),I=S(null),D=S(!1),q=k=>{k.target===k.currentTarget&&E("update:modelValue",!1)},X=async()=>{y.value=!0;try{L.value=await Me.getAllCronTasks()}catch(k){console.error("Failed to load cron tasks:",k),m.error(`Failed to load tasks: ${k instanceof Error?k.message:String(k)}`)}finally{y.value=!1}},A=async k=>{M.value=k;try{const p=L.value.find(re=>re.id===k);if(!p){console.error("Task not found:",k);return}E("update:modelValue",!1);const v=Date.now().toString();await n.push({name:"direct",params:{id:v}}),await new Promise(re=>setTimeout(re,100));const O=Ae.prepareTaskExecution(p);O.useTemplate&&O.planData?c.emitPlanExecutionRequested(O.planData):O.taskContent&&c.setTask(O.taskContent)}catch(p){console.error("Failed to execute task:",p),m.error(`Execution failed: ${p instanceof Error?p.message:String(p)}`)}finally{M.value=null}},se=k=>{P.value={...k},b.value=!0,a.value=null},le=async k=>{try{await Ae.saveTask(k),await X(),b.value=!1,m.success("Task saved successfully")}catch(p){console.error("Failed to save task:",p),m.error(`Save failed: ${p instanceof Error?p.message:String(p)}`)}},x=k=>{I.value=k,J.value=!0},B=async()=>{var k;if((k=I.value)!=null&&k.id){H.value=I.value.id;try{await Ae.deleteTask(I.value.id),await X(),J.value=!1,I.value=null,m.success("Task deleted successfully")}catch(p){console.error("Failed to delete task:",p),m.error(`Delete failed: ${p instanceof Error?p.message:String(p)}`)}finally{H.value=null}}},U=()=>{J.value=!1,I.value=null},ee=k=>{a.value=a.value===k?null:k},ke=async k=>{if(k.id){G.value=k.id;try{await Ae.toggleTaskStatus(k),await X(),a.value=null,m.success(`Task ${k.status===0?"disabled":"enabled"} successfully`)}catch(p){console.error("Failed to toggle task status:",p),m.error(`Status toggle failed: ${p instanceof Error?p.message:String(p)}`)}finally{G.value=null}}},C=async k=>{try{await navigator.clipboard.writeText(k),m.success("Cron expression copied successfully")}catch(p){m.error(`Copy failed: ${p instanceof Error?p.message:String(p)}`)}},N=()=>{D.value=!0},K=()=>{D.value=!1;try{E("update:modelValue",!1);const k=$("cronTask.template");c.setTaskToInput(k);const p=Date.now().toString();n.push({name:"direct",params:{id:p}})}catch(k){console.error("Error in createWithJmanus:",k),m.error(`Creation failed: ${k instanceof Error?k.message:String(k)}`)}},W=()=>{D.value=!1,P.value={cronName:"",cronTime:"",planDesc:"",status:0,planTemplateId:""},b.value=!0},R=()=>{D.value=!1},V=k=>{const p=k.target;!p.closest(".action-dropdown")&&!p.closest(".dropdown-menu")&&(a.value=null)};return Ee(()=>{document.addEventListener("click",V,!0)}),Ie(()=>{document.removeEventListener("click",V,!0)}),we(()=>r.modelValue,k=>{k&&X()}),(k,p)=>(d(),h(me,null,[(d(),pe(Ue,{to:"body"},[g(Ne,{name:"modal"},{default:Fe(()=>[T.modelValue?(d(),h("div",{key:0,class:"modal-overlay",onClick:q},[e("div",{class:"modal-container",onClick:p[3]||(p[3]=ie(()=>{},["stop"]))},[e("div",Qi,[e("h3",null,s(k.$t("cronTask.title")),1),e("div",Yi,[e("button",{class:"add-task-btn",onClick:[N,p[0]||(p[0]=ie(()=>{},["stop"]))]},[g(o(f),{icon:"carbon:add"}),oe(" "+s(k.$t("cronTask.addTask")),1)]),e("button",{class:"close-btn",onClick:p[1]||(p[1]=v=>k.$emit("update:modelValue",!1))},[g(o(f),{icon:"carbon:close"})])])]),e("div",Zi,[y.value?(d(),h("div",ec,[g(o(f),{icon:"carbon:loading",class:"loading-icon"}),e("span",null,s(k.$t("common.loading")),1)])):L.value.length===0?(d(),h("div",tc,[g(o(f),{icon:"carbon:time",class:"empty-icon"}),e("span",null,s(k.$t("cronTask.noTasks")),1)])):(d(),h("div",nc,[(d(!0),h(me,null,_e(L.value,v=>(d(),h("div",{key:v.id||"",class:"task-item",onClick:O=>se(v)},[e("div",oc,[e("div",ac,[e("div",lc,[e("div",ic,s(v.cronName),1),e("div",{class:ae(["task-status-badge",v.status===0?"active":"inactive"])},[g(o(f),{icon:v.status===0?"carbon:checkmark-filled":"carbon:pause-filled"},null,8,["icon"]),e("span",null,s(v.status===0?k.$t("cronTask.active"):k.$t("cronTask.inactive")),1)],2)]),e("div",cc,s(v.planDesc),1),e("div",rc,[g(o(f),{icon:"carbon:time"}),e("span",{class:"cron-readable",style:{cursor:"pointer"},onClick:ie(O=>C(v.cronTime),["stop"])},s(v.cronTime),9,dc)])])]),e("div",{class:"task-actions",onClick:p[2]||(p[2]=ie(()=>{},["stop"]))},[e("button",{class:"action-btn execute-btn",onClick:O=>A(v.id),disabled:M.value===v.id,title:k.$t("cronTask.executeOnce")},[g(o(f),{icon:M.value===v.id?"carbon:loading":"carbon:play-filled"},null,8,["icon"]),oe(" "+s(k.$t("cronTask.executeOnce")),1)],8,uc),e("div",{class:ae(["action-dropdown",{active:a.value===v.id}])},[e("button",{class:"action-btn dropdown-btn",onClick:O=>ee(v.id),title:k.$t("cronTask.operations")},[g(o(f),{icon:"carbon:overflow-menu-horizontal"}),oe(" "+s(k.$t("cronTask.operations")),1)],8,pc),ve(e("div",hc,[e("button",{class:"dropdown-item edit-btn",onClick:O=>se(v)},[g(o(f),{icon:"carbon:edit"}),oe(" "+s(k.$t("cronTask.edit")),1)],8,mc),e("button",{class:"dropdown-item toggle-btn",onClick:O=>ke(v),disabled:G.value===v.id},[g(o(f),{icon:G.value===v.id?"carbon:loading":v.status===0?"carbon:pause-filled":"carbon:play-filled"},null,8,["icon"]),oe(" "+s(v.status===0?k.$t("cronTask.disable"):k.$t("cronTask.enable")),1)],8,vc),e("button",{class:"dropdown-item delete-btn",onClick:O=>x(v),disabled:H.value===v.id},[g(o(f),{icon:H.value===v.id?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),oe(" "+s(k.$t("cronTask.delete")),1)],8,gc)],512),[[ft,a.value===v.id]])],2)])],8,sc))),128))]))])])])):F("",!0)]),_:1})])),g(Xi,{modelValue:b.value,"onUpdate:modelValue":p[4]||(p[4]=v=>b.value=v),task:P.value,onSave:le},null,8,["modelValue","task"]),(d(),pe(Ue,{to:"body"},[g(Ne,{name:"modal"},{default:Fe(()=>{var v,O,re,i;return[J.value?(d(),h("div",{key:0,class:"modal-overlay",onClick:U},[e("div",{class:"confirm-modal",onClick:p[5]||(p[5]=ie(()=>{},["stop"]))},[e("div",fc,[g(o(f),{icon:"carbon:warning",class:"warning-icon"}),e("h3",null,s(k.$t("cronTask.deleteConfirm")),1)]),e("div",$c,[e("p",null,s(k.$t("cronTask.deleteConfirmMessage",{taskName:((v=I.value)==null?void 0:v.cronName)||((O=I.value)==null?void 0:O.planDesc)||""})),1)]),e("div",bc,[e("button",{class:"confirm-btn cancel-btn",onClick:U},s(k.$t("common.cancel")),1),e("button",{class:"confirm-btn delete-btn",onClick:B,disabled:H.value===((re=I.value)==null?void 0:re.id)},[g(o(f),{icon:H.value===((i=I.value)==null?void 0:i.id)?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),oe(" "+s(k.$t("cronTask.delete")),1)],8,_c)])])])):F("",!0)]}),_:1})])),(d(),pe(Ue,{to:"body"},[g(Ne,{name:"modal"},{default:Fe(()=>[D.value?(d(),h("div",{key:0,class:"modal-overlay",onClick:R},[e("div",{class:"confirm-modal create-options-modal",onClick:p[6]||(p[6]=ie(()=>{},["stop"]))},[e("div",kc,[g(o(f),{icon:"carbon:time",class:"create-icon"}),e("h3",null,s(k.$t("cronTask.createTask")),1)]),e("div",yc,[e("p",null,s(k.$t("cronTask.selectCreateMethod")),1),e("div",Cc,[e("button",{class:"create-option-btn jmanus-btn",onClick:K},[g(o(f),{icon:"carbon:ai-status"}),e("div",wc,[e("span",Pc,s(k.$t("cronTask.createWithJmanus")),1),e("span",Sc,s(k.$t("cronTask.createWithJmanusDesc")),1)])]),e("button",{class:"create-option-btn manual-btn",onClick:W},[g(o(f),{icon:"carbon:edit"}),e("div",Ec,[e("span",Ic,s(k.$t("cronTask.createManually")),1),e("span",Tc,s(k.$t("cronTask.createManuallyDesc")),1)])])])]),e("div",xc,[e("button",{class:"confirm-btn cancel-btn",onClick:R},s(k.$t("common.cancel")),1)])])])):F("",!0)]),_:1})]))],64))}}),Rc=Se(Dc,[["__scopeId","data-v-848c7703"]]),Mc={class:"direct-page"},Ac={class:"direct-chat"},Nc={class:"chat-header"},Fc={class:"header-actions"},Uc=["title"],Lc=["title"],Bc=["title"],qc=["title"],Vc={class:"chat-content"},jc=["title"],Oc={class:"message-content"},Wc=Pe({__name:"index",setup(T){const t=$t(),n=ut(),c=pt(),{t:m}=De(),{message:$}=yt(),r=S(""),E=S(""),L=S(),y=S(),M=S(),H=S(!1),G=S(!1),a=S(null),b=S(!1),P=S(50),J=S(!1),I=S(0),D=S(0);Ee(()=>{if(console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",c.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",c.hasUnprocessedTask()),he.setEventCallbacks({onPlanUpdate:v=>{console.log("[Direct] Plan update event received for rootPlanId:",v),le(v)&&(console.log("[Direct] Processing plan update for current rootPlanId:",v),y.value&&typeof y.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",v),y.value.handlePlanUpdate(v)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),L.value&&typeof L.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",v),L.value.updateDisplayedPlanProgress(v)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:v=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",v),!!le(v)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",v),y.value&&typeof y.value.handlePlanCompleted=="function"){const O=he.getCachedPlanRecord(v);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",O),y.value.handlePlanCompleted(O??{planId:v})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");a.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:v=>{console.log("[Direct] Dialog round start event received for rootPlanId:",v),a.value=v,console.log("[Direct] Set currentRootPlanId to:",v),y.value&&typeof y.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",v),y.value.handleDialogRoundStart(v)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),B()},onChatInputUpdateState:v=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",v),!le(v,!0))return;const O=he.getCachedUIState(v);O&&ee(O.enabled,O.placeholder)},onPlanError:v=>{y.value.handlePlanError(v)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),w.loadPlanTemplateList(),c.hasUnprocessedTask()&&c.currentTask){const v=c.currentTask.prompt;console.log("[Direct] Found unprocessed task from store:",v),c.markTaskAsProcessed(),ue(()=>{y.value&&typeof y.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing task via chatRef.handleSendMessage:",v),y.value.handleSendMessage(v)):(console.warn("[Direct] chatRef.handleSendMessage method not available, falling back to prompt"),r.value=v)})}else{const v=c.getAndClearTaskToInput();v?(E.value=v,console.log("[Direct] Setting inputOnlyContent for input only:",E.value)):(r.value=t.query.prompt||"",console.log("[Direct] Received task from URL:",r.value),console.log("[Direct] No unprocessed task in store"))}const p=localStorage.getItem("directPanelWidth");p&&(P.value=parseFloat(p)),console.log("[Direct] Final prompt value:",r.value),E.value&&ue(()=>{M.value&&typeof M.value.setInputValue=="function"&&(M.value.setInputValue(E.value),console.log("[Direct] Set input value:",E.value),E.value="")}),window.addEventListener("plan-execution-requested",v=>{console.log("[DirectView] Received plan-execution-requested event:",v.detail),R(v.detail)})}),we(()=>c.currentTask,p=>{if(console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",p),p&&!p.processed){const v=p.prompt;c.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",v),ue(()=>{y.value&&typeof y.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing new task via chatRef.handleSendMessage:",v),y.value.handleSendMessage(v)):console.warn("[Direct] chatRef.handleSendMessage method not available for new task")})}else console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),we(()=>r.value,(p,v)=>{console.log("[Direct] prompt value changed from:",v,"to:",p)},{immediate:!1}),we(()=>c.taskToInput,p=>{console.log("[Direct] Watch taskStore.taskToInput triggered, newTaskToInput:",p),p&&p.trim()&&(console.log("[Direct] Setting input value from taskToInput:",p),ue(()=>{M.value&&typeof M.value.setInputValue=="function"&&(M.value.setInputValue(p.trim()),console.log("[Direct] Input value set from taskToInput watch:",p.trim()),c.getAndClearTaskToInput())}))},{immediate:!1}),Ie(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),a.value=null,he.cleanup(),document.removeEventListener("mousemove",X),document.removeEventListener("mouseup",A),window.removeEventListener("plan-execution-requested",p=>{R(p.detail)})});const q=p=>{J.value=!0,I.value=p.clientX,D.value=P.value,document.addEventListener("mousemove",X),document.addEventListener("mouseup",A),document.body.style.cursor="col-resize",document.body.style.userSelect="none",p.preventDefault()},X=p=>{if(!J.value)return;const v=window.innerWidth,re=(p.clientX-I.value)/v*100;let i=D.value+re;i=Math.max(20,Math.min(80,i)),P.value=i},A=()=>{J.value=!1,document.removeEventListener("mousemove",X),document.removeEventListener("mouseup",A),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",P.value.toString())},se=()=>{P.value=50,localStorage.setItem("directPanelWidth","50")},le=(p,v=!1)=>!a.value||p===a.value||v&&(p==="ui-state"||p==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",p,"current:",a.value),!1),x=p=>{console.log("[DirectView] Send message from input:",JSON.stringify(p)),y.value&&typeof y.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",JSON.stringify(p)),y.value.handleSendMessage(p)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},B=()=>{console.log("[DirectView] Input cleared"),M.value&&typeof M.value.clear=="function"&&M.value.clear()},U=()=>{console.log("[DirectView] Input focused")},ee=(p,v)=>{console.log("[DirectView] Input state updated:",p,v),G.value=!p},ke=(p,v)=>{console.log("[DirectView] Step selected:",p,v),L.value&&typeof L.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",p,v),L.value.handleStepSelected(p,v)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},C=(p,v,O,re)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:p,subPlanId:v,stepIndex:O,subStepIndex:re}),L.value&&typeof L.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:p,subPlanId:v,stepIndex:O,subStepIndex:re}),L.value.handleSubPlanStepSelected(p,v,O,re)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},N=()=>{console.log("[DirectView] Plan mode button clicked"),w.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",w.isCollapsed)},K=()=>{n.push("/home")},W=()=>{n.push("/configs")},R=async p=>{var O,re,i,l;if(console.log("[DirectView] Plan execution requested:",p),H.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}H.value=!0;let v=!1;y.value&&typeof y.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",p.title),y.value.addMessage("user",p.title),v=!0):console.warn("[DirectView] chatRef.addMessage method not available");try{const u=((O=p.planData)==null?void 0:O.planTemplateId)||((re=p.planData)==null?void 0:re.id)||((i=p.planData)==null?void 0:i.planId);if(!u)throw new Error(m("direct.planTemplateIdNotFound"));console.log("[Direct] Executing plan with templateId:",u,"params:",p.params),console.log("[Direct] About to call PlanActApiService.executePlan");let _;if((l=p.params)!=null&&l.trim()?(console.log("[Direct] Calling executePlan with params:",p.params.trim()),_=await qe.executePlan(u,p.params.trim())):(console.log("[Direct] Calling executePlan without params"),_=await qe.executePlan(u)),console.log("[Direct] Plan execution API response:",_),_.planId)console.log("[Direct] Got planId from response:",_.planId,"starting plan execution"),a.value=_.planId,console.log("[Direct] Set currentRootPlanId to:",_.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),he.handlePlanExecutionRequested(_.planId,p.title);else throw console.error("[Direct] No planId in response:",_),new Error(m("direct.executionFailedNoPlanId"))}catch(u){console.error("[Direct] Plan execution failed:",u),console.error("[Direct] Error details:",{message:u.message,stack:u.stack}),a.value=null,y.value&&typeof y.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),v||y.value.addMessage("user",p.title),y.value.addMessage("assistant",`${m("direct.executionFailed")}: ${u.message||m("common.unknownError")}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`${m("direct.executionFailed")}: ${u.message||m("common.unknownError")}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),H.value=!1}},V=()=>{y.value.showMemory()},k=()=>{$e.clearMemoryId(),y.value.newChat()};return(p,v)=>(d(),h("div",Mc,[e("div",Ac,[g(Cn,{onPlanExecutionRequested:R}),e("div",{class:"left-panel",style:Be({width:P.value+"%"})},[e("div",Nc,[e("button",{class:"back-button",onClick:K},[g(o(f),{icon:"carbon:arrow-left"})]),e("h2",null,s(p.$t("conversation")),1),e("div",Fc,[g(_t),e("button",{class:"config-button",onClick:k,title:p.$t("memory.newChat")},[g(o(f),{icon:"carbon:add",width:"20"})],8,Uc),e("button",{class:"config-button",onClick:W,title:p.$t("direct.configuration")},[g(o(f),{icon:"carbon:settings-adjust",width:"20"})],8,Lc),e("button",{class:"cron-task-btn",onClick:v[0]||(v[0]=O=>b.value=!0),title:p.$t("cronTask.title")},[g(o(f),{icon:"carbon:alarm",width:"20"})],8,Bc),e("button",{class:"cron-task-btn",onClick:v[1]||(v[1]=O=>o($e).toggleSidebar()),title:p.$t("memory.selectMemory")},[g(o(f),{icon:"carbon:calendar",width:"20"})],8,qc)])]),e("div",Vc,[g(li,{ref_key:"chatRef",ref:y,mode:"direct","initial-prompt":r.value||"",onStepSelected:ke,onSubPlanStepSelected:C},null,8,["initial-prompt"])]),(d(),pe(mi,{key:p.$i18n.locale,ref_key:"inputRef",ref:M,disabled:G.value,placeholder:G.value?o(m)("input.waiting"):o(m)("input.placeholder"),"initial-value":r.value,onSend:x,onClear:B,onFocus:U,onUpdateState:ee,onPlanModeClicked:N},null,8,["disabled","placeholder","initial-value"]))],4),e("div",{class:"panel-resizer",onMousedown:q,onDblclick:se,title:p.$t("direct.panelResizeHint")},v[3]||(v[3]=[e("div",{class:"resizer-line"},null,-1)]),40,jc),g(Sa,{ref_key:"rightPanelRef",ref:L,style:Be({width:100-P.value+"%"}),"current-root-plan-id":a.value},null,8,["style","current-root-plan-id"])]),g(Rc,{modelValue:b.value,"onUpdate:modelValue":v[2]||(v[2]=O=>b.value=O)},null,8,["modelValue"]),g(fs,{onMemorySelected:V}),o($).show?(d(),h("div",{key:0,class:ae(["message-toast",o($).type])},[e("div",Oc,[e("span",null,s(o($).text),1)])],2)):F("",!0)]))}}),Yc=Se(Wc,[["__scopeId","data-v-68e48dfe"]]);export{Yc as default};
