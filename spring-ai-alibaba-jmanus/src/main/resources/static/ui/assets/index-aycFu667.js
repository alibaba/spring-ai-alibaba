var it=Object.defineProperty;var ct=(B,t,n)=>t in B?it(B,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):B[t]=n;var z=(B,t,n)=>ct(B,typeof t!="symbol"?t+"":t,n);import{m as Me,p as De,d as $e,f as Ie,h as we,c as m,o as h,q as ne,u as o,e,b as O,t as a,i as _,s as K,F as me,j as be,x as pe,w as he,v as ve,r as R,g as ke,k as ce,y as Te,a as de,T as Re,z as Ae,A as ye,n as Ne,B as Le,C as rt,l as at,D as ut}from"./index-BDbwf6Be.js";import{I as S,_ as Se}from"./_plugin-vue_export-helper-BTLtti6u.js";import{L as dt}from"./index-CkfDdrZ9.js";import{u as lt}from"./task-C-7pziSp.js";import{u as pt}from"./useToast-EGQGPL5v.js";class ue{static async generatePlan(t,n){const c={query:t};n&&(c.existingJson=n);const y=await fetch(`${this.PLAN_TEMPLATE_URL}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!y.ok)throw new Error(`Failed to generate plan: ${y.status}`);const r=await y.json();if(r.planJson)try{r.plan=JSON.parse(r.planJson)}catch{r.plan={error:"Unable to parse plan data"}}return r}static async executePlan(t,n){console.log("[PlanActApiService] executePlan called with:",{planTemplateId:t,rawParam:n});const c={planTemplateId:t};n&&(c.rawParam=n),console.log("[PlanActApiService] Making request to:",`${this.PLAN_TEMPLATE_URL}/executePlanByTemplateId`),console.log("[PlanActApiService] Request body:",c);const y=await fetch(`${this.PLAN_TEMPLATE_URL}/executePlanByTemplateId`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(console.log("[PlanActApiService] Response status:",y.status,y.ok),!y.ok){const E=await y.text();throw console.error("[PlanActApiService] Request failed:",E),new Error(`Failed to execute plan: ${y.status}`)}const r=await y.json();return console.log("[PlanActApiService] executePlan response:",r),r}static async savePlanTemplate(t,n){const c=await fetch(`${this.PLAN_TEMPLATE_URL}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t,planJson:n})});if(!c.ok)throw new Error(`Failed to save plan: ${c.status}`);return await c.json()}static async getPlanVersions(t){const n=await fetch(`${this.PLAN_TEMPLATE_URL}/versions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t})});if(!n.ok)throw new Error(`Failed to get plan versions: ${n.status}`);return await n.json()}static async getVersionPlan(t,n){const c=await fetch(`${this.PLAN_TEMPLATE_URL}/get-version`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t,versionIndex:n.toString()})});if(!c.ok)throw new Error(`Failed to get specific version plan: ${c.status}`);return await c.json()}static async getAllPlanTemplates(){const t=await fetch(`${this.PLAN_TEMPLATE_URL}/list`);if(!t.ok)throw new Error(`Failed to get plan template list: ${t.status}`);return await t.json()}static async updatePlanTemplate(t,n,c){const y={planId:t,query:n};c&&(y.existingJson=c);const r=await fetch(`${this.PLAN_TEMPLATE_URL}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(y)});if(!r.ok)throw new Error(`Failed to update plan template: ${r.status}`);const E=await r.json();if(E.planJson)try{E.plan=JSON.parse(E.planJson)}catch{E.plan={error:"Unable to parse plan data"}}return E}static async deletePlanTemplate(t){const n=await fetch(`${this.PLAN_TEMPLATE_URL}/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:t})});if(!n.ok)throw new Error(`Failed to delete plan template: ${n.status}`);return await n.json()}}z(ue,"PLAN_TEMPLATE_URL","/api/plan-template");class ht{constructor(){z(this,"isCollapsed",!0);z(this,"currentTab","list");z(this,"currentPlanTemplateId",null);z(this,"planTemplateList",[]);z(this,"selectedTemplate",null);z(this,"isLoading",!1);z(this,"errorMessage","");z(this,"jsonContent","");z(this,"generatorPrompt","");z(this,"executionParams","");z(this,"isGenerating",!1);z(this,"isExecuting",!1);z(this,"planVersions",[]);z(this,"currentVersionIndex",-1)}get sortedTemplates(){return[...this.planTemplateList].sort((t,n)=>{const c=new Date(t.updateTime??t.createTime);return new Date(n.updateTime??n.createTime).getTime()-c.getTime()})}get canRollback(){return this.planVersions.length>1&&this.currentVersionIndex>0}get canRestore(){return this.planVersions.length>1&&this.currentVersionIndex<this.planVersions.length-1}get computedApiUrl(){if(!this.selectedTemplate)return"";const t=`/api/plan-template/execute/${this.selectedTemplate.id}`,n=this.executionParams.trim();return n?`${t}?allParams=${encodeURIComponent(n)}`:t}toggleSidebar(){this.isCollapsed=!this.isCollapsed}switchToTab(t){this.currentTab=t}async loadPlanTemplateList(){this.isLoading=!0,this.errorMessage="";try{console.log("[SidebarStore] Starting to load plan template list...");const t=await ue.getAllPlanTemplates();t!=null&&t.templates&&Array.isArray(t.templates)?(this.planTemplateList=t.templates,console.log(`[SidebarStore] Successfully loaded ${t.templates.length} plan templates`)):(this.planTemplateList=[],console.warn("[SidebarStore] API returned abnormal data format, using empty list",t))}catch(t){console.error("[SidebarStore] Failed to load plan template list:",t),this.planTemplateList=[],this.errorMessage=`Load failed: ${t.message}`}finally{this.isLoading=!1}}async selectTemplate(t){this.currentPlanTemplateId=t.id,this.selectedTemplate=t,this.currentTab="config",await this.loadTemplateData(t),console.log(`[SidebarStore] Selected plan template: ${t.id}`)}async loadTemplateData(t){try{const n=await ue.getPlanVersions(t.id);if(this.planVersions=n.versions||[],this.planVersions.length>0){const c=this.planVersions[this.planVersions.length-1];this.jsonContent=c,this.currentVersionIndex=this.planVersions.length-1;try{const y=JSON.parse(c);y.prompt&&(this.generatorPrompt=y.prompt),y.params&&(this.executionParams=y.params)}catch{console.warn("Unable to parse JSON content to get prompt information")}}else this.jsonContent="",this.generatorPrompt="",this.executionParams=""}catch(n){throw console.error("Failed to load template data:",n),n}}createNewTemplate(){const t={id:`new-${Date.now()}`,title:De.global.t("sidebar.newTemplateName"),description:De.global.t("sidebar.newTemplateDescription"),createTime:new Date().toISOString(),updateTime:new Date().toISOString()};this.selectedTemplate=t,this.currentPlanTemplateId=null,this.jsonContent="",this.generatorPrompt="",this.executionParams="",this.planVersions=[],this.currentVersionIndex=-1,this.currentTab="config",console.log("[SidebarStore] Created new empty plan template, switching to config tab")}async deleteTemplate(t){if(!t.id){console.warn("[SidebarStore] deleteTemplate: Invalid template object or ID");return}try{await ue.deletePlanTemplate(t.id),this.currentPlanTemplateId===t.id&&this.clearSelection(),await this.loadPlanTemplateList(),console.log(`[SidebarStore] Plan template ${t.id} has been deleted`)}catch(n){throw console.error("Failed to delete plan template:",n),await this.loadPlanTemplateList(),n}}clearSelection(){this.currentPlanTemplateId=null,this.selectedTemplate=null,this.jsonContent="",this.generatorPrompt="",this.executionParams="",this.planVersions=[],this.currentVersionIndex=-1,this.currentTab="list"}clearExecutionParams(){this.executionParams=""}rollbackVersion(){this.canRollback&&(this.currentVersionIndex--,this.jsonContent=this.planVersions[this.currentVersionIndex])}restoreVersion(){this.canRestore&&(this.currentVersionIndex++,this.jsonContent=this.planVersions[this.currentVersionIndex])}async saveTemplate(){if(!this.selectedTemplate)return;const t=this.jsonContent.trim();if(!t)throw new Error("Content cannot be empty");try{JSON.parse(t)}catch(n){throw new Error(`Invalid format, please correct and save.
Error: `+n.message)}try{const n=await ue.savePlanTemplate(this.selectedTemplate.id,t);return this.currentVersionIndex<this.planVersions.length-1&&(this.planVersions=this.planVersions.slice(0,this.currentVersionIndex+1)),this.planVersions.push(t),this.currentVersionIndex=this.planVersions.length-1,n}catch(n){throw console.error("Failed to save plan template:",n),n}}async generatePlan(){if(this.generatorPrompt.trim()){this.isGenerating=!0;try{const t=await ue.generatePlan(this.generatorPrompt);if(this.jsonContent=t.planJson||"",this.selectedTemplate&&this.selectedTemplate.id.startsWith("new-")){let n="New Plan Template";try{n=JSON.parse(t.planJson||"{}").title||n}catch{console.warn("Unable to parse plan JSON to get title")}this.selectedTemplate={id:t.planTemplateId,title:n,description:De.global.t("sidebar.generatedTemplateDescription"),createTime:new Date().toISOString(),updateTime:new Date().toISOString(),planJson:t.planJson},this.currentPlanTemplateId=t.planTemplateId,await this.loadPlanTemplateList()}return this.currentVersionIndex<this.planVersions.length-1&&(this.planVersions=this.planVersions.slice(0,this.currentVersionIndex+1)),this.planVersions.push(this.jsonContent),this.currentVersionIndex=this.planVersions.length-1,t}catch(t){throw console.error("Failed to generate plan:",t),t}finally{this.isGenerating=!1}}}async updatePlan(){if(!(!this.generatorPrompt.trim()||!this.jsonContent.trim())&&this.selectedTemplate){this.isGenerating=!0;try{const t=await ue.updatePlanTemplate(this.selectedTemplate.id,this.generatorPrompt,this.jsonContent);return this.jsonContent=t.planJson||"",this.currentVersionIndex<this.planVersions.length-1&&(this.planVersions=this.planVersions.slice(0,this.currentVersionIndex+1)),this.planVersions.push(this.jsonContent),this.currentVersionIndex=this.planVersions.length-1,t}catch(t){throw console.error("Failed to update plan:",t),t}finally{this.isGenerating=!1}}}preparePlanExecution(){if(!this.selectedTemplate)return null;this.isExecuting=!0;try{let t;try{t=JSON.parse(this.jsonContent),t.planTemplateId=this.selectedTemplate.id}catch{t={planTemplateId:this.selectedTemplate.id,planId:this.selectedTemplate.id,title:this.selectedTemplate.title??De.global.t("sidebar.defaultExecutionPlanTitle"),steps:[{stepRequirement:"[BROWSER_AGENT] 访问百度搜索阿里巴巴的最新股价"},{stepRequirement:"[DEFAULT_AGENT] 提取和整理搜索结果中的股价信息"},{stepRequirement:"[TEXT_FILE_AGENT] 创建一个文本文件记录查询结果"},{stepRequirement:"[DEFAULT_AGENT] 向用户报告查询结果"}]}}return{title:this.selectedTemplate.title??t.title??"Execution Plan",planData:t,params:this.executionParams.trim()||void 0}}catch(t){throw console.error("Failed to prepare plan execution:",t),this.isExecuting=!1,t}}finishPlanExecution(){this.isExecuting=!1}}const P=Me(new ht),gt={class:"sidebar-content"},mt={class:"sidebar-content-header"},vt={class:"sidebar-content-title"},ft={class:"tab-switcher"},bt=["disabled"],Pt={key:0,class:"tab-content"},_t={class:"new-task-section"},kt={class:"sidebar-content-list"},$t={key:0,class:"loading-state"},St={key:1,class:"error-state"},Ct={key:2,class:"empty-state"},yt=["onClick"],wt={class:"task-icon"},Tt={class:"task-details"},Et={class:"task-title"},It={class:"task-preview"},xt={class:"task-time"},Dt={class:"task-actions"},Rt=["title","onClick"],At={key:1,class:"tab-content config-tab"},Nt={key:0,class:"config-container"},Lt={class:"template-info-header"},Vt={class:"template-info"},Mt={class:"template-id"},Ut={class:"config-section"},Ot={class:"section-header"},qt={class:"generator-content"},Ft=["placeholder"],jt={class:"generator-actions"},Bt=["disabled"],Jt=["disabled"],Wt={class:"config-section"},Ht={class:"section-header"},Gt={class:"section-actions"},zt=["disabled","title"],Xt=["disabled","title"],Kt=["disabled"],Qt=["placeholder"],Yt={class:"config-section"},Zt={class:"section-header"},en={class:"execution-content"},tn={class:"params-input-group"},nn={class:"params-help-text"},sn={class:"params-input-container"},on=["placeholder"],an=["title"],ln={class:"api-url-display"},cn={class:"api-url-label"},rn={class:"api-url"},un={class:"api-url-display"},dn={class:"api-url-label"},pn=["disabled"],hn=$e({__name:"index",emits:["planExecutionRequested"],setup(B,{expose:t,emit:n}){const{t:c}=Ie(),y=n,r=async()=>{try{const u=await P.saveTemplate();u!=null&&u.duplicate?alert(c("sidebar.saveCompleted",{message:u.message,versionCount:u.versionCount})):u!=null&&u.saved?alert(c("sidebar.saveSuccess",{message:u.message,versionCount:u.versionCount})):u!=null&&u.message&&alert(c("sidebar.saveStatus",{message:u.message}))}catch(u){console.error("保存计划修改失败:",u),alert(u.message||c("sidebar.saveFailed"))}},E=async()=>{var u;try{await P.generatePlan(),alert(c("sidebar.generateSuccess",{templateId:((u=P.selectedTemplate)==null?void 0:u.id)??c("sidebar.unknown")}))}catch(b){console.error("生成计划失败:",b),alert(c("sidebar.generateFailed")+": "+b.message)}},T=async()=>{try{await P.updatePlan(),alert(c("sidebar.updateSuccess"))}catch(u){console.error("更新计划失败:",u),alert(c("sidebar.updateFailed")+": "+u.message)}},G=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const u=P.preparePlanExecution();if(!u){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] 触发计划执行请求:",u),console.log("[Sidebar] Emitting planExecutionRequested event"),y("planExecutionRequested",u),console.log("[Sidebar] Event emitted")}catch(u){console.error("执行计划出错:",u),alert(c("sidebar.executeFailed")+": "+u.message)}finally{P.finishPlanExecution()}},p=u=>{const C=new Date().getTime()-u.getTime(),U=Math.floor(C/6e4),ee=Math.floor(C/36e5),Q=Math.floor(C/864e5);return U<1?"刚刚":U<60?`${U}分钟前`:ee<24?`${ee}小时前`:Q<30?`${Q}天前`:u.toLocaleDateString("zh-CN")},I=(u,b)=>!u||u.length<=b?u:u.substring(0,b)+"...";return we(()=>{P.loadPlanTemplateList()}),t({loadPlanTemplateList:P.loadPlanTemplateList,toggleSidebar:P.toggleSidebar,currentPlanTemplateId:P.currentPlanTemplateId}),(u,b)=>(h(),m("div",{class:ne(["sidebar-wrapper",{"sidebar-wrapper-collapsed":o(P).isCollapsed}])},[e("div",gt,[e("div",mt,[e("div",vt,a(u.$t("sidebar.title")),1)]),e("div",ft,[e("button",{class:ne(["tab-button",{active:o(P).currentTab==="list"}]),onClick:b[0]||(b[0]=C=>o(P).switchToTab("list"))},[_(o(S),{icon:"carbon:list",width:"16"}),K(" "+a(u.$t("sidebar.templateList")),1)],2),e("button",{class:ne(["tab-button",{active:o(P).currentTab==="config"}]),onClick:b[1]||(b[1]=C=>o(P).switchToTab("config")),disabled:!o(P).selectedTemplate},[_(o(S),{icon:"carbon:settings",width:"16"}),K(" "+a(u.$t("sidebar.configuration")),1)],10,bt)]),o(P).currentTab==="list"?(h(),m("div",Pt,[e("div",_t,[e("button",{class:"new-task-btn",onClick:b[2]||(b[2]=C=>o(P).createNewTemplate())},[_(o(S),{icon:"carbon:add",width:"16"}),K(" "+a(u.$t("sidebar.newPlan"))+" ",1),b[11]||(b[11]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",kt,[o(P).isLoading?(h(),m("div",$t,[_(o(S),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,a(u.$t("sidebar.loading")),1)])):o(P).errorMessage?(h(),m("div",St,[_(o(S),{icon:"carbon:warning",width:"20"}),e("span",null,a(o(P).errorMessage),1),e("button",{onClick:b[3]||(b[3]=(...C)=>o(P).loadPlanTemplateList&&o(P).loadPlanTemplateList(...C)),class:"retry-btn"},a(u.$t("sidebar.retry")),1)])):o(P).planTemplateList.length===0?(h(),m("div",Ct,[_(o(S),{icon:"carbon:document",width:"32"}),e("span",null,a(u.$t("sidebar.noTemplates")),1)])):(h(!0),m(me,{key:3},be(o(P).sortedTemplates,C=>(h(),m("div",{key:C.id,class:ne(["sidebar-content-list-item",{"sidebar-content-list-item-active":C.id===o(P).currentPlanTemplateId}]),onClick:U=>o(P).selectTemplate(C)},[e("div",wt,[_(o(S),{icon:"carbon:document",width:"20"})]),e("div",Tt,[e("div",Et,a(C.title||u.$t("sidebar.unnamedPlan")),1),e("div",It,a(I(C.description||u.$t("sidebar.noDescription"),40)),1)]),e("div",xt,a(p(new Date(C.updateTime||C.createTime))),1),e("div",Dt,[e("button",{class:"delete-task-btn",title:u.$t("sidebar.deleteTemplate"),onClick:pe(U=>o(P).deleteTemplate(C),["stop"])},[_(o(S),{icon:"carbon:close",width:"16"})],8,Rt)])],10,yt))),128))])])):o(P).currentTab==="config"?(h(),m("div",At,[o(P).selectedTemplate?(h(),m("div",Nt,[e("div",Lt,[e("div",Vt,[e("h3",null,a(o(P).selectedTemplate.title||u.$t("sidebar.unnamedPlan")),1),e("span",Mt,"ID: "+a(o(P).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:b[4]||(b[4]=C=>o(P).switchToTab("list"))},[_(o(S),{icon:"carbon:arrow-left",width:"16"})])]),e("div",Ut,[e("div",Ot,[_(o(S),{icon:"carbon:generate",width:"16"}),e("span",null,a(u.$t("sidebar.planGenerator")),1)]),e("div",qt,[he(e("textarea",{"onUpdate:modelValue":b[5]||(b[5]=C=>o(P).generatorPrompt=C),class:"prompt-input",placeholder:u.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,Ft),[[ve,o(P).generatorPrompt]]),e("div",jt,[e("button",{class:"btn btn-primary btn-sm",onClick:E,disabled:o(P).isGenerating||!o(P).generatorPrompt.trim()},[_(o(S),{icon:o(P).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:ne({spinning:o(P).isGenerating})},null,8,["icon","class"]),K(" "+a(o(P).isGenerating?u.$t("sidebar.generating"):u.$t("sidebar.generatePlan")),1)],8,Bt),e("button",{class:"btn btn-secondary btn-sm",onClick:T,disabled:o(P).isGenerating||!o(P).generatorPrompt.trim()||!o(P).jsonContent.trim()},[_(o(S),{icon:"carbon:edit",width:"14"}),K(" "+a(u.$t("sidebar.updatePlan")),1)],8,Jt)])])]),e("div",Wt,[e("div",Ht,[_(o(S),{icon:"carbon:code",width:"16"}),e("span",null,a(u.$t("sidebar.jsonTemplate")),1),e("div",Gt,[e("button",{class:"btn btn-sm",onClick:b[6]||(b[6]=(...C)=>o(P).rollbackVersion&&o(P).rollbackVersion(...C)),disabled:!o(P).canRollback,title:u.$t("sidebar.rollback")},[_(o(S),{icon:"carbon:undo",width:"14"})],8,zt),e("button",{class:"btn btn-sm",onClick:b[7]||(b[7]=(...C)=>o(P).restoreVersion&&o(P).restoreVersion(...C)),disabled:!o(P).canRestore,title:u.$t("sidebar.restore")},[_(o(S),{icon:"carbon:redo",width:"14"})],8,Xt),e("button",{class:"btn btn-primary btn-sm",onClick:r,disabled:o(P).isGenerating||o(P).isExecuting},[_(o(S),{icon:"carbon:save",width:"14"})],8,Kt)])]),he(e("textarea",{"onUpdate:modelValue":b[8]||(b[8]=C=>o(P).jsonContent=C),class:"json-editor",placeholder:u.$t("sidebar.jsonPlaceholder"),rows:"8"},null,8,Qt),[[ve,o(P).jsonContent]])]),e("div",Yt,[e("div",Zt,[_(o(S),{icon:"carbon:play",width:"16"}),e("span",null,a(u.$t("sidebar.executionController")),1)]),e("div",en,[e("div",tn,[e("label",null,a(u.$t("sidebar.executionParams")),1),e("div",nn,a(u.$t("sidebar.executionParamsHelp")),1),e("div",sn,[he(e("input",{"onUpdate:modelValue":b[9]||(b[9]=C=>o(P).executionParams=C),class:"params-input",placeholder:u.$t("sidebar.executionParamsPlaceholder")},null,8,on),[[ve,o(P).executionParams]]),e("button",{class:"clear-params-btn",onClick:b[10]||(b[10]=(...C)=>o(P).clearExecutionParams&&o(P).clearExecutionParams(...C)),title:u.$t("sidebar.clearParams")},[_(o(S),{icon:"carbon:close",width:"12"})],8,an)])]),e("div",ln,[e("span",cn,a(u.$t("sidebar.apiUrl"))+":",1),e("code",rn,a(o(P).computedApiUrl),1)]),e("div",un,[e("span",dn,a(u.$t("sidebar.statusApiUrl"))+":",1),b[12]||(b[12]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:G,disabled:o(P).isExecuting||o(P).isGenerating},[_(o(S),{icon:o(P).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:ne({spinning:o(P).isExecuting})},null,8,["icon","class"]),K(" "+a(o(P).isExecuting?u.$t("sidebar.executing"):u.$t("sidebar.executePlan")),1)],8,pn)])])])):O("",!0)])):O("",!0)])],2))}}),gn=Se(hn,[["__scopeId","data-v-094cd641"]]);class Ue{static async sendMessage(t){const n=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t})});if(!n.ok)throw new Error(`API request failed: ${n.status}`);return await n.json()}}z(Ue,"BASE_URL","/api/executor");class Oe{static async getDetails(t){try{const n=await fetch(`${this.BASE_URL}/details/${t}`);if(n.status===404)return null;if(!n.ok)throw new Error(`Failed to get detailed information: ${n.status}`);const c=await n.text(),y=JSON.parse(c);return y&&typeof y=="object"&&!y.currentPlanId&&(y.currentPlanId=t),y}catch(n){return console.error("[CommonApiService] Failed to get plan details:",n),null}}static async submitFormInput(t,n){const c=await fetch(`${this.BASE_URL}/submit-input/${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!c.ok){let r;try{r=await c.json()}catch{r={message:`Failed to submit form input: ${c.status}`}}throw new Error(r.message||`Failed to submit form input: ${c.status}`)}const y=c.headers.get("content-type");return y&&y.indexOf("application/json")!==-1?await c.json():{success:!0}}static async getAllPrompts(){try{const t=await fetch(this.BASE_URL);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get Prompt list:",t),t}}static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}}z(Oe,"BASE_URL","/api/executor");const _e=class _e{constructor(){z(this,"POLL_INTERVAL",5e3);z(this,"state",Me({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));z(this,"callbacks",{});z(this,"planExecutionCache",new Map);z(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(t){return this.planExecutionCache.get(t)}getCachedUIState(t){return this.uiStateCache.get(t)}setCachedUIState(t,n){this.uiStateCache.set(t,n),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${t}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(t){return this.planExecutionCache.has(t)}setCachedPlanRecord(t,n){this.planExecutionCache.set(t,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${t}`)}clearCachedPlanRecord(t){const n=this.planExecutionCache.delete(t);return n&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${t}`),n}clearAllCachedRecords(){const t=this.planExecutionCache.size,n=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${t}, UI States: ${n}`)}static getInstance(){return _e.instance||(_e.instance=new _e),_e.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(t){this.callbacks={...this.callbacks,...t},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(t))}async handleUserMessageSendRequested(t){if(this.validateAndPrepareUIForNewRequest(t))try{if(await this.sendUserMessageAndSetPlanId(t),this.state.activePlanId)this.initiatePlanExecutionSequence(t,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(n){console.error("[PlanExecutionManager] Failed to send user message:",n);const c=this.state.activePlanId??"error";this.setCachedUIState(c,{enabled:!0}),this.emitChatInputUpdateState(c),this.state.activePlanId=null}}handlePlanExecutionRequested(t,n){console.log("[PlanExecutionManager] Received plan execution request:",{planId:t,query:n}),t?(this.state.activePlanId=t,this.initiatePlanExecutionSequence(n??"执行计划",t)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(t,n){const c=this.getCachedPlanRecord(t);return c!=null&&c.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${t}`),this.handlePlanExecutionRequested(c.currentPlanId,n),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${t}`),!1)}validateAndPrepareUIForNewRequest(t){if(!t)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const n=this.state.activePlanId??"ui-state";return this.setCachedUIState(n,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(n),!0}async sendUserMessageAndSetPlanId(t){try{const n=await Ue.sendMessage(t);if(n!=null&&n.planId)return this.state.activePlanId=n.planId,n;if(n!=null&&n.planTemplateId)return this.state.activePlanId=n.planTemplateId,{...n,planId:n.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",n),new Error("Failed to get valid planId from API response")}catch(n){throw console.error("[PlanExecutionManager] API call failed:",n),n}}initiatePlanExecutionSequence(t,n){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${t}", planId: ${n}`);const c=n;this.emitDialogRoundStart(c),this.startPolling()}handlePlanCompletion(t){this.emitPlanCompleted(t.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await ue.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}},5e3)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}t.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(t.rootPlanId??""))}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const t=await this.getPlanDetails(this.state.activePlanId);if(!t){console.warn("[PlanExecutionManager] No details received from API");return}if(t.rootPlanId&&this.setCachedPlanRecord(t.rootPlanId,t),!t.steps||t.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(t.rootPlanId??""),this.handlePlanCompletion(t);return}this.emitPlanUpdate(t.rootPlanId??""),t.completed&&this.handlePlanCompletion(t)}catch(t){console.error("[PlanExecutionManager] Failed to poll plan status:",t)}finally{this.state.isPolling=!1}}}async getPlanDetails(t){try{const n=await Oe.getDetails(t);return n!=null&&n.rootPlanId&&(this.planExecutionCache.set(n.rootPlanId,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${n.rootPlanId}`)),n}catch(n){return console.error("[PlanExecutionManager] Failed to get plan details:",n),null}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(t){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(t)}emitDialogRoundStart(t){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(t)}emitPlanUpdate(t){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(t)}emitPlanCompleted(t){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(t)}};z(_e,"instance",null);let Ve=_e;const se=Ve.getInstance(),mn={class:"right-panel"},vn={class:"preview-header"},fn={class:"preview-tabs"},bn={class:"tab-button active"},Pn={class:"preview-content"},_n={class:"step-details"},kn={key:0,class:"step-info-fixed"},$n={key:0,class:"agent-info"},Sn={class:"info-item"},Cn={class:"label"},yn={class:"value"},wn={class:"info-item"},Tn={class:"label"},En={class:"value"},In={class:"info-item"},xn={class:"label"},Dn={class:"value"},Rn={class:"info-item"},An={class:"label"},Nn={class:"value"},Ln={class:"info-item"},Vn={class:"label"},Mn={class:"execution-status"},Un={class:"status-item"},On={class:"status-text"},qn={key:0},Fn={key:0,class:"think-act-steps"},jn={class:"steps-container"},Bn={class:"step-header"},Jn={class:"step-number"},Wn={class:"think-section"},Hn={class:"think-content"},Gn={class:"input"},zn={class:"label"},Xn={class:"output"},Kn={class:"label"},Qn={key:0,class:"action-section"},Yn={class:"action-content"},Zn={class:"tool-info"},es={class:"label"},ts={class:"value"},ns={class:"input"},ss={class:"label"},os={class:"output"},as={class:"label"},ls={key:0,class:"sub-plan-section"},is={class:"sub-plan-content"},cs={class:"sub-plan-header"},rs={class:"sub-plan-info"},us={class:"value"},ds={key:0,class:"sub-plan-info"},ps={class:"value"},hs={class:"sub-plan-status"},gs={class:"status-text"},ms={key:0,class:"no-steps-message"},vs={key:1,class:"no-execution-message"},fs={class:"step-basic-info"},bs={class:"info-item"},Ps={class:"label"},_s={class:"value"},ks={key:0,class:"info-item"},$s={class:"value"},Ss={class:"info-item"},Cs={class:"no-execution-hint"},ys={key:2,class:"execution-indicator"},ws={class:"execution-text"},Ts={key:1,class:"no-selection"},Es=["title"],Is=$e({__name:"index",setup(B,{expose:t}){const{t:n}=Ie(),c=R(),y=R(),r=R(),E=R(null),T=R(!1),G=R(!0),p=R(!0),I=ke(()=>r.value?r.value.completed?n("rightPanel.status.completed"):r.value.current?n("rightPanel.status.executing"):n("rightPanel.status.waiting"):""),u=k=>{var V;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${k}`),r.value&&E.value){const A=E.value.rootPlanId??y.value;if(A&&A!==k){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${A}, Requested: ${k}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${k}`);const $=se.getCachedPlanRecord(k);if(!$){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${k}`);return}if($.steps&&$.steps.length>0){const A=$.steps.length,w=($.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${w} / ${A}`)}if(r.value&&y.value&&(y.value===k||((V=E.value)==null?void 0:V.rootPlanId)===k)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${k}`),E.value)){const w=E.value,x=C(w.planId,w.rootPlanId,w.subPlanId);x?(U(x,w.stepIndex,w.planId,w.isSubPlan),te()):console.warn("[RightPanel] Could not find plan record for refresh:",w)}},b=(k,$,V,A,w)=>{console.log("[RightPanel] Step selected:",{planId:k,stepIndex:$,rootPlanId:V,subPlanId:A,subStepIndex:w});const x=!!(V&&A&&w!==void 0);E.value={planId:k,stepIndex:$,isSubPlan:x,...x&&{rootPlanId:V,subPlanId:A,subStepIndex:w}};const Y=C(k,V,A);if(!Y){console.warn("[RightPanel] Plan data not found:",{planId:k,rootPlanId:V,subPlanId:A}),r.value=null,E.value=null;return}U(Y,$,k,x)},C=(k,$,V)=>{var x;if(!$||!V)return se.getCachedPlanRecord(k)??null;const A=se.getCachedPlanRecord(k);if(A)return A;const w=se.getCachedPlanRecord($);if(!(w!=null&&w.agentExecutionSequence))return null;for(const Y of w.agentExecutionSequence)if(Y.thinkActSteps){for(const v of Y.thinkActSteps)if(((x=v.subPlanExecutionRecord)==null?void 0:x.currentPlanId)===V)return v.subPlanExecutionRecord}return null},U=(k,$,V,A)=>{var d,f,M,X,fe;if(!k.steps||$>=k.steps.length){r.value=null,E.value=null,console.warn("[RightPanel] Invalid step data:",{planId:V,stepIndex:$,hasSteps:!!k.steps,stepsLength:(d=k.steps)==null?void 0:d.length,message:"Invalid step index"});return}y.value=V;const w=k.steps[$],x=(f=k.agentExecutionSequence)==null?void 0:f[$];console.log("[RightPanel] Step data details:",{planId:V,stepIndex:$,step:w,hasAgentExecutionSequence:!!k.agentExecutionSequence,agentExecutionSequenceLength:(M=k.agentExecutionSequence)==null?void 0:M.length,agentExecution:x,hasThinkActSteps:!!(x!=null&&x.thinkActSteps),thinkActStepsLength:(X=x==null?void 0:x.thinkActSteps)==null?void 0:X.length,isSubPlan:A});const Y=(x==null?void 0:x.status)==="FINISHED",v=!Y&&$===k.currentStepIndex&&!k.completed,N={planId:V,index:$,title:typeof w=="string"?w:w.title||w.description||w.name||`${A?"子":""}步骤 ${$+1}`,description:typeof w=="string"?w:w.description||w,completed:Y,current:v};x&&(N.agentExecution=x),r.value=N,console.log("[RightPanel] Step details updated:",{planId:V,stepIndex:$,stepTitle:r.value.title,hasAgentExecution:!!x,hasThinkActSteps:(((fe=x==null?void 0:x.thinkActSteps)==null?void 0:fe.length)??0)>0,completed:Y,current:v,planCurrentStep:k.currentStepIndex,planCompleted:k.completed,isSubPlan:A}),x!=null&&x.thinkActSteps&&x.thinkActSteps.forEach((l,s)=>{l.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${s}:`,l.subPlanExecutionRecord)}),setTimeout(()=>{oe()},100),te()},ee=(k,$,V,A)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:k,subPlanId:$,stepIndex:V,subStepIndex:A}),b($,A,k,$,A)},Q=k=>{c.value=k??void 0},oe=()=>{if(!c.value)return;const{scrollTop:k,scrollHeight:$,clientHeight:V}=c.value,A=$-k-V<50,w=$>V;G.value=A,T.value=w&&!A,A?p.value=!0:$-k-V>100&&(p.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:k,scrollHeight:$,clientHeight:V,isAtBottom:A,hasScrollableContent:w,showButton:T.value,shouldAutoScroll:p.value})},J=()=>{c.value&&(c.value.scrollTo({top:c.value.scrollHeight,behavior:"smooth"}),ce(()=>{p.value=!0,oe()}))},te=()=>{!p.value||!c.value||ce(()=>{c.value&&(c.value.scrollTop=c.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},ae=k=>{if(k===null||typeof k>"u"||k==="")return"N/A";try{const $=typeof k=="object"?k:JSON.parse(k);return JSON.stringify($,null,2)}catch{return String(k)}},ge=()=>{r.value=null,y.value=void 0,p.value=!0,c.value&&c.value.removeEventListener("scroll",oe)},Pe=()=>{const k=()=>{const $=c.value;return $?(Q($),$.addEventListener("scroll",oe),p.value=!0,oe(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};ce(()=>{k()||setTimeout(()=>{k()},100)})};return we(()=>{console.log("[RightPanel] Component mounted"),ce(()=>{Pe()})}),Te(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),E.value=null,ge()}),t({updateDisplayedPlanProgress:u,handleStepSelected:b,handleSubPlanStepSelected:ee}),(k,$)=>{var V,A;return h(),m("div",mn,[e("div",vn,[e("div",fn,[e("button",bn,[_(o(S),{icon:"carbon:events"}),K(" "+a(o(n)("rightPanel.stepExecutionDetails")),1)])])]),e("div",Pn,[e("div",_n,[r.value?(h(),m("div",kn,[e("h3",null,a(r.value.title||r.value.description||o(n)("rightPanel.defaultStepTitle",{number:r.value.index+1})),1),r.value.agentExecution?(h(),m("div",$n,[e("div",Sn,[e("span",Cn,a(o(n)("rightPanel.executingAgent"))+":",1),e("span",yn,a(r.value.agentExecution.agentName),1)]),e("div",wn,[e("span",Tn,a(o(n)("rightPanel.description"))+":",1),e("span",En,a(r.value.agentExecution.agentDescription||""),1)]),e("div",In,[e("span",xn,a(o(n)("rightPanel.callingModel"))+":",1),e("span",Dn,a(r.value.agentExecution.modelName),1)]),e("div",Rn,[e("span",An,a(o(n)("rightPanel.request"))+":",1),e("span",Nn,a(r.value.agentExecution.agentRequest||""),1)]),e("div",Ln,[e("span",Vn,a(o(n)("rightPanel.executionResult"))+":",1),e("span",{class:ne(["value",{success:r.value.agentExecution.status==="FINISHED"}])},a(r.value.agentExecution.status||o(n)("rightPanel.executing")),3)])])):O("",!0),e("div",Mn,[e("div",Un,[r.value.completed?(h(),de(o(S),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):r.value.current?(h(),de(o(S),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(h(),de(o(S),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",On,a(I.value),1)])])])):O("",!0),e("div",{ref_key:"scrollContainer",ref:c,class:"step-details-scroll-container",onScroll:oe},[r.value?(h(),m("div",qn,[(V=r.value.agentExecution)!=null&&V.thinkActSteps&&r.value.agentExecution.thinkActSteps.length>0?(h(),m("div",Fn,[e("h4",null,a(o(n)("rightPanel.thinkAndActionSteps")),1),e("div",jn,[(h(!0),m(me,null,be(r.value.agentExecution.thinkActSteps,(w,x)=>(h(),m("div",{key:x,class:"think-act-step"},[e("div",Bn,[e("span",Jn,"#"+a(x+1),1),e("span",{class:ne(["step-status",w.status])},a(w.status||o(n)("rightPanel.executing")),3)]),e("div",Wn,[e("h5",null,[_(o(S),{icon:"carbon:thinking"}),K(" "+a(o(n)("rightPanel.thinking")),1)]),e("div",Hn,[e("div",Gn,[e("span",zn,a(o(n)("rightPanel.input"))+":",1),e("pre",null,a(ae(w.thinkInput)),1)]),e("div",Xn,[e("span",Kn,a(o(n)("rightPanel.output"))+":",1),e("pre",null,a(ae(w.thinkOutput)),1)])])]),w.actionNeeded?(h(),m("div",Qn,[e("h5",null,[_(o(S),{icon:"carbon:play"}),K(" "+a(o(n)("rightPanel.action")),1)]),e("div",Yn,[(h(!0),m(me,null,be(w.actToolInfoList,(Y,v)=>(h(),m("div",{key:v},[e("div",Zn,[e("span",es,a(o(n)("rightPanel.tool"))+":",1),e("span",ts,a(Y.name||""),1)]),e("div",ns,[e("span",ss,a(o(n)("rightPanel.toolParameters"))+":",1),e("pre",null,a(ae(Y.parameters)),1)]),e("div",os,[e("span",as,a(o(n)("rightPanel.executionResult"))+":",1),e("pre",null,a(ae(Y.result)),1)])]))),128))]),w.subPlanExecutionRecord?(h(),m("div",ls,[e("h5",null,[_(o(S),{icon:"carbon:tree-view"}),K(" "+a(o(n)("rightPanel.subPlan")),1)]),e("div",is,[e("div",cs,[e("div",rs,[$[0]||($[0]=e("span",{class:"label"},"子计划ID:",-1)),e("span",us,a(w.subPlanExecutionRecord.currentPlanId),1)]),w.subPlanExecutionRecord.title?(h(),m("div",ds,[$[1]||($[1]=e("span",{class:"label"},"标题:",-1)),e("span",ps,a(w.subPlanExecutionRecord.title),1)])):O("",!0),e("div",hs,[w.subPlanExecutionRecord.completed?(h(),de(o(S),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(h(),de(o(S),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",gs,a(w.subPlanExecutionRecord.completed?"已完成":"执行中"),1)])])])])):O("",!0)])):O("",!0)]))),128))]),r.value.agentExecution&&!((A=r.value.agentExecution.thinkActSteps)!=null&&A.length)?(h(),m("div",ms,[e("p",null,a(o(n)("rightPanel.noStepDetails")),1)])):r.value.agentExecution?O("",!0):(h(),m("div",vs,[_(o(S),{icon:"carbon:information",class:"info-icon"}),e("h4",null,a(o(n)("rightPanel.stepInfo")),1),e("div",fs,[e("div",bs,[e("span",Ps,a(o(n)("rightPanel.stepName"))+":",1),e("span",_s,a(r.value.title||r.value.description||`步骤 ${r.value.index+1}`),1)]),r.value.description?(h(),m("div",ks,[$[2]||($[2]=e("span",{class:"label"},"描述:",-1)),e("span",$s,a(r.value.description),1)])):O("",!0),e("div",Ss,[$[3]||($[3]=e("span",{class:"label"},"状态:",-1)),e("span",{class:ne(["value",{"status-completed":r.value.completed,"status-current":r.value.current,"status-pending":!r.value.completed&&!r.value.current}])},a(r.value.completed?"已完成":r.value.current?"执行中":"待执行"),3)])]),e("p",Cs,a(o(n)("rightPanel.noExecutionInfo")),1)])),r.value.current&&!r.value.completed?(h(),m("div",ys,[$[4]||($[4]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",ws,[_(o(S),{icon:"carbon:in-progress",class:"rotating-icon"}),K(" "+a(o(n)("rightPanel.stepExecuting")),1)])])):O("",!0)])):(h(),m("div",Ts,[_(o(S),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,a(o(n)("rightPanel.noStepSelected")),1),e("p",null,a(o(n)("rightPanel.selectStepHint")),1)]))])):O("",!0),_(Re,{name:"scroll-button"},{default:Ae(()=>[T.value?(h(),m("button",{key:0,onClick:J,class:"scroll-to-bottom-btn",title:o(n)("rightPanel.scrollToBottom")},[_(o(S),{icon:"carbon:chevron-down"})],8,Es)):O("",!0)]),_:1})],544)])])])}}}),xs=Se(Is,[["__scopeId","data-v-e90596ce"]]);function Ds(){const B=se,t=ke(()=>B.getActivePlanId()),n=ke(()=>B.getState()),c=ke(()=>n.value.isPolling),y=ke(()=>!!t.value),r=(p,I)=>{B.initiatePlanExecutionSequence(p,I)},E=()=>{B.stopPolling()},T=()=>{B.startPolling()},G=()=>{B.cleanup()};return Te(()=>{G()}),{activePlanId:t,state:n,isPolling:c,hasActivePlan:y,startExecution:r,stopPolling:E,startPolling:T,cleanup:G}}const Rs={class:"chat-container"},As={class:"message-content"},Ns={key:0,class:"user-message"},Ls={key:1,class:"assistant-message"},Vs={key:0,class:"thinking-section"},Ms={class:"thinking-header"},Us={class:"thinking-avatar"},Os={class:"thinking-label"},qs={class:"thinking-content"},Fs={key:0,class:"thinking"},js={key:1,class:"progress"},Bs={class:"progress-bar"},Js={class:"progress-text"},Ws={key:2,class:"steps-container"},Hs={class:"steps-title"},Gs=["onClick"],zs={class:"section-header"},Xs={class:"step-icon"},Ks={class:"step-title"},Qs={key:0,class:"step-status current"},Ys={key:1,class:"step-status completed"},Zs={key:2,class:"step-status pending"},eo={key:0,class:"action-info"},to={class:"action-description"},no={class:"action-icon"},so={key:0,class:"tool-params"},oo={class:"param-label"},ao={class:"param-content"},lo={key:1,class:"think-details"},io={class:"think-header"},co={class:"think-label"},ro={class:"think-output"},uo={class:"think-content"},po={key:1,class:"sub-plan-steps"},ho={class:"sub-plan-header"},go={class:"sub-plan-step-list"},mo=["onClick"],vo={class:"sub-step-indicator"},fo={class:"sub-step-icon"},bo={class:"sub-step-number"},Po={class:"sub-step-content"},_o={class:"sub-step-title"},ko={key:2,class:"user-input-form-container"},$o={class:"user-input-message"},So={key:0,class:"form-description"},Co=["onSubmit"],yo=["for"],wo=["id","name","onUpdate:modelValue"],To={key:1,class:"form-group"},Eo={for:"form-input-genericInput"},Io=["onUpdate:modelValue"],xo={type:"submit",class:"submit-user-input-btn"},Do={key:3,class:"default-processing"},Ro={class:"processing-indicator"},Ao={class:"response-section"},No={class:"response-header"},Lo={class:"response-avatar"},Vo={class:"response-name"},Mo={class:"response-content"},Uo={key:0,class:"final-response"},Oo=["innerHTML"],qo={key:1,class:"response-placeholder"},Fo={class:"typing-indicator"},jo={class:"typing-text"},Bo={key:0,class:"message assistant"},Jo={class:"message-content"},Wo={class:"assistant-message"},Ho={class:"thinking-section"},Go={class:"thinking-header"},zo={class:"thinking-avatar"},Xo={class:"thinking-label"},Ko={class:"thinking-content"},Qo={class:"default-processing"},Yo={class:"processing-indicator"},Zo={class:"response-section"},ea={class:"response-header"},ta={class:"response-avatar"},na={class:"response-name"},sa={class:"response-content"},oa={class:"response-placeholder"},aa={class:"typing-indicator"},la={class:"typing-text"},ia=["title"],ca=$e({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(B,{expose:t,emit:n}){const c=B,y=n,{t:r}=Ie(),E=Ds(),T=R(),G=R(!1),p=R([]),I=R(),u=R(!1),b=Me({}),C=(l,s,i)=>{const g={id:Date.now().toString(),type:l,content:s,timestamp:new Date,...i};return l==="assistant"&&!g.thinking&&!g.content&&(g.thinking=r("chat.thinking")),p.value.push(g),g},U=l=>{const s=p.value[p.value.length-1];s.type==="assistant"&&Object.assign(s,l)},ee=async l=>{try{G.value=!0;const s=C("assistant","",{thinking:"正在理解您的请求并准备回复..."}),i=await Ue.sendMessage(l);if(i.planId)console.log("[ChatComponent] Received planId from direct execution:",i.planId),s.planExecution||(s.planExecution={}),s.planExecution.currentPlanId=i.planId,se.handlePlanExecutionRequested(i.planId,l),delete s.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete s.thinking;const g=Q(i,l);s.content=g}}catch(s){console.error("Direct mode error:",s),U({content:oe(s)})}finally{G.value=!1}},Q=(l,s)=>l.result??l.message??l.content??"",oe=l=>{const s=(l==null?void 0:l.message)??(l==null?void 0:l.toString())??"未知错误";return s.includes("网络")||s.includes("network")||s.includes("timeout")?"抱歉，似乎网络连接有些问题。请检查您的网络连接后再试一次，或者稍等几分钟再重新提问。":s.includes("认证")||s.includes("权限")||s.includes("auth")?"抱歉，访问权限出现了问题。这可能是系统配置的问题，请联系管理员或稍后再试。":s.includes("格式")||s.includes("参数")||s.includes("invalid")?"抱歉，您的请求格式可能有些问题。能否请您重新表述一下您的需求？我会尽力理解并帮助您。":`抱歉，处理您的请求时遇到了一些问题（${s}）。请稍后再试，或者换个方式表达您的需求，我会尽力帮助您的。`},J=(l=!1)=>{ce(()=>{if(T.value){const s=T.value;(l||s.scrollHeight-s.scrollTop-s.clientHeight<150)&&s.scrollTo({top:s.scrollHeight,behavior:l?"auto":"smooth"})}})},te=()=>{J(!0),u.value=!1},ae=()=>{if(T.value){const l=T.value,s=l.scrollHeight-l.scrollTop-l.clientHeight<150;u.value=!s&&p.value.length>0}},ge=()=>{T.value&&T.value.addEventListener("scroll",ae)},Pe=()=>{T.value&&T.value.removeEventListener("scroll",ae)},k=l=>{C("user",l),c.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",l):ee(l)},$=(l,s)=>{var q;const i=((q=l.planExecution)==null?void 0:q.agentExecutionSequence)??[];return s<0||s>=i.length?"IDLE":i[s].status??"IDLE"},V=(l,s)=>{var i,g;if(!((i=l.planExecution)!=null&&i.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:l.planExecution.currentPlanId,stepIndex:s,stepTitle:(g=l.planExecution.steps)==null?void 0:g[s]}),y("step-selected",l.planExecution.currentPlanId,s)},A=(l,s)=>{var i;try{const g=(i=l.planExecution)==null?void 0:i.agentExecutionSequence;if(!(g!=null&&g.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const q=g[s];if(!q)return console.log(`[ChatComponent] No agentExecution found for step ${s}`),[];if(!q.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${s}`),[];for(const L of q.thinkActSteps)if(L.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${s}:`,L.subPlanExecutionRecord),(L.subPlanExecutionRecord.steps??[]).map(F=>typeof F=="string"?F:typeof F=="object"&&F!==null&&(F.title||F.description)||"子步骤");return[]}catch(g){return console.warn("[ChatComponent] Error getting sub-plan steps:",g),[]}},w=(l,s,i)=>{var g;try{const q=(g=l.planExecution)==null?void 0:g.agentExecutionSequence;if(!(q!=null&&q.length))return"pending";const L=q[s];if(!L||!L.thinkActSteps)return"pending";let Z=null;for(const j of L.thinkActSteps)if(j.subPlanExecutionRecord){Z=j.subPlanExecutionRecord;break}if(!Z)return"pending";const F=Z.currentStepIndex;return Z.completed?"completed":F==null?i===0?"current":"pending":i<F?"completed":i===F?"current":"pending"}catch(q){return console.warn("[ChatComponent] Error getting sub-plan step status:",q),"pending"}},x=(l,s,i)=>{var g,q;try{const L=(g=l.planExecution)==null?void 0:g.agentExecutionSequence;if(!(L!=null&&L.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const Z=L[s];if(!Z){console.warn("[ChatComponent] No agentExecution found for step",s);return}if(!Z.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",s);return}let F=null;for(const j of Z.thinkActSteps)if(j.subPlanExecutionRecord){F=j.subPlanExecutionRecord;break}if(!(F!=null&&F.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}y("sub-plan-step-selected",((q=l.planExecution)==null?void 0:q.currentPlanId)??"",F.currentPlanId,s,i)}catch(L){console.error("[ChatComponent] Error handling sub-plan step click:",L)}},Y=(l,s)=>{var g,q,L,Z;if(!((g=l.planExecution)!=null&&g.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",l.planExecution.steps.length,"execution sequence:",((q=s.agentExecutionSequence)==null?void 0:q.length)??0);const i=new Array(l.planExecution.steps.length).fill(null);if((L=s.agentExecutionSequence)!=null&&L.length){const F=Math.min(s.agentExecutionSequence.length,l.planExecution.steps.length);for(let j=0;j<F;j++){const D=s.agentExecutionSequence[j];if((Z=D.thinkActSteps)!=null&&Z.length){const W=D.thinkActSteps[D.thinkActSteps.length-1];W.actionDescription&&W.toolParameters?(i[j]={actionDescription:W.actionDescription,toolParameters:typeof W.toolParameters=="string"?W.toolParameters:JSON.stringify(W.toolParameters,null,2),thinkInput:W.thinkInput??"",thinkOutput:W.thinkOutput??"",status:s.currentStepIndex!==void 0&&j<s.currentStepIndex?"completed":s.currentStepIndex!==void 0&&j===s.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${j} action set: ${i[j].actionDescription}`)):(i[j]={actionDescription:"思考中",toolParameters:"等待决策",thinkInput:W.thinkInput??"",thinkOutput:W.thinkOutput??"",status:s.currentStepIndex!==void 0&&j===s.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${j} is thinking`))}else i[j]={actionDescription:s.currentStepIndex!==void 0&&j<s.currentStepIndex?"已完成":"等待中",toolParameters:"无工具参数",thinkInput:"",thinkOutput:"",status:s.currentStepIndex!==void 0&&j<s.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] 步骤 ${j} 无执行细节, 状态设为: ${i[j].status}`)}}else console.log("[ChatComponent] 没有执行序列数据");l.stepActions=[...i],console.log("[ChatComponent] 步骤动作更新完成:",JSON.stringify(i.map(F=>F==null?void 0:F.actionDescription))),ce(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},v=l=>{console.log("[ChatComponent] Starting dialog round with planId:",l),l&&(p.value.findIndex(i=>{var g;return((g=i.planExecution)==null?void 0:g.currentPlanId)===l&&i.type==="assistant"})===-1?(C("assistant","",{planExecution:{currentPlanId:l},thinking:"正在准备执行计划..."}),console.log("[ChatComponent] Created new assistant message for planId:",l)):console.log("[ChatComponent] Found existing assistant message for planId:",l))},N=l=>{var L,Z,F,j;console.log("[ChatComponent] Processing plan update with rootPlanId:",l);const s=se.getCachedPlanRecord(l);if(!s){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",l);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",s),console.log("[ChatComponent] Plan steps:",s.steps),console.log("[ChatComponent] Plan completed:",s.completed),!s.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const i=p.value.findIndex(D=>{var W;return((W=D.planExecution)==null?void 0:W.currentPlanId)===s.currentPlanId&&D.type==="assistant"});let g;if(i!==-1)g=p.value[i],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",s.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",s.currentPlanId),console.log("[ChatComponent] Current messages:",p.value.map(W=>{var le;return{type:W.type,planId:(le=W.planExecution)==null?void 0:le.currentPlanId,content:W.content.substring(0,50)}}));let D=-1;for(let W=p.value.length-1;W>=0;W--)if(p.value[W].type==="assistant"){D=W;break}if(D!==-1)g=p.value[D],g.planExecution||(g.planExecution={}),g.planExecution.currentPlanId=s.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",s.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(g.planExecution||(g.planExecution={}),g.planExecution=JSON.parse(JSON.stringify(s)),!s.steps||s.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),s.completed){delete g.thinking;const D=s.summary??s.result??s.message??"处理完成";g.content=d(D),console.log("[ChatComponent] Set simple response content:",g.content)}else s.title&&(g.thinking=`正在执行: ${s.title}`);return}delete g.thinking;const q=s.steps.map(D=>typeof D=="string"?D:typeof D=="object"&&D!==null&&(D.title||D.description)||"步骤");if(g.planExecution&&(g.planExecution.steps=q),s.agentExecutionSequence&&s.agentExecutionSequence.length>0){console.log("[ChatComponent] 发现执行序列数据，数量:",s.agentExecutionSequence.length),Y(g,s);const D=s.currentStepIndex??0;if(D>=0&&D<s.agentExecutionSequence.length){const le=s.agentExecutionSequence[D].thinkActSteps;if(le&&le.length>0){const Ce=le[le.length-1];if(Ce.thinkOutput){const xe=Ce.thinkOutput.length>150?Ce.thinkOutput.substring(0,150)+"...":Ce.thinkOutput;g.thinking=`正在思考: ${xe}`}}}}else if(g.planExecution){const D=g.planExecution.currentStepIndex??0,W=(L=g.planExecution.steps)==null?void 0:L[D],le=typeof W=="string"?W:"";g.thinking=`正在执行: ${le}`}if(s.userInputWaitState&&g.planExecution?(console.log("[ChatComponent] 需要用户输入:",s.userInputWaitState),g.planExecution.userInputWaitState||(g.planExecution.userInputWaitState={}),g.planExecution.userInputWaitState={message:s.userInputWaitState.message??"",formDescription:s.userInputWaitState.formDescription??"",formInputs:((Z=s.userInputWaitState.formInputs)==null?void 0:Z.map(D=>({label:D.label,value:D.value||""})))??[]},b[F=g.id]??(b[F]={}),g.thinking="等待用户输入..."):(j=g.planExecution)!=null&&j.userInputWaitState&&delete g.planExecution.userInputWaitState,s.completed??s.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete g.thinking;let D="";s.summary?D=s.summary:s.result?D=s.result:D="任务已完成",g.content=f(D),console.log("[ChatComponent] Updated completed message:",g.content)}ce(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},d=l=>l?l.includes("我")||l.includes("您")||l.includes("您好")||l.includes("可以")?l:l.length<10?`${l}！还有什么需要我帮助的吗？`:l.length<50?`好的，${l}。如果您还有其他问题，请随时告诉我。`:`${l}

希望这个回答对您有帮助！还有什么我可以为您做的吗？`:"我明白了，还有什么我可以帮您的吗？",f=l=>l?`${l}`:"任务已完成！还有什么我可以帮您的吗？",M=l=>{console.log("[ChatComponent] Plan completed with rootPlanId:",l);const s=se.getCachedPlanRecord(l);if(!s){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",l);return}if(console.log("[ChatComponent] Plan details:",s),s.rootPlanId){const i=p.value.findIndex(g=>{var q;return((q=g.planExecution)==null?void 0:q.currentPlanId)===s.rootPlanId});if(i!==-1){const g=p.value[i];delete g.thinking;let L=s.summary??s.result??"任务已完成";!L.includes("我")&&!L.includes("您")&&(L.includes("成功")||L.includes("完成")?L=`很好！${L}。如果您还有其他需要帮助的地方，请随时告诉我。`:L=`我已经完成了您的请求：${L}`),g.content=L,console.log("[ChatComponent] Updated completed message:",g.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",s.rootPlanId)}},X=l=>{if(!l)return"";let s=l.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return s=s.replace(/(<br><br>)/g,"</p><p>"),s.includes("</p><p>")&&(s=`<p>${s}</p>`),s},fe=async l=>{var s;if(!((s=l.planExecution)!=null&&s.currentPlanId)||!l.planExecution.userInputWaitState){console.error("[ChatComponent] 缺少planExecution.currentPlanId或userInputWaitState");return}try{const i={},g=l.planExecution.userInputWaitState.formInputs;g&&g.length>0?Object.entries(b[l.id]).forEach(([L,Z])=>{var D;const F=parseInt(L,10),j=((D=g[F])==null?void 0:D.label)||`input_${L}`;i[j]=Z}):i.genericInput=l.genericInput??"",console.log("[ChatComponent] 提交用户输入:",i);const q=await Oe.submitFormInput(l.planExecution.currentPlanId,i);delete l.planExecution.userInputWaitState,delete l.genericInput,delete b[l.id],E.startPolling(),console.log("[ChatComponent] 用户输入提交成功:",q)}catch(i){console.error("[ChatComponent] 用户输入提交失败:",i),alert(`提交失败: ${(i==null?void 0:i.message)||"未知错误"}`)}};return ye(()=>c.initialPrompt,(l,s)=>{console.log("[ChatComponent] initialPrompt changed from:",s,"to:",l),l&&typeof l=="string"&&l.trim()&&l!==s&&(console.log("[ChatComponent] Processing changed initial prompt:",l),ce(()=>{k(l)}))},{immediate:!1}),we(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),se.setEventCallbacks({onPlanUpdate:N,onPlanCompleted:M,onDialogRoundStart:v,onChatInputUpdateState:l=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",l)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")}}),ce(()=>{ge()}),c.initialPrompt&&typeof c.initialPrompt=="string"&&c.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",c.initialPrompt),ce(()=>{k(c.initialPrompt)}))}),Te(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),Pe(),I.value&&clearInterval(I.value),E.cleanup(),Object.keys(b).forEach(l=>delete b[l])}),t({handleSendMessage:k,handlePlanUpdate:N,handlePlanCompleted:M,handleDialogRoundStart:v,addMessage:C}),(l,s)=>(h(),m("div",Rs,[e("div",{class:"messages",ref_key:"messagesRef",ref:T},[(h(!0),m(me,null,be(p.value,i=>{var g,q,L,Z,F,j,D,W,le;return h(),m("div",{key:i.id,class:ne(["message",{user:i.type==="user",assistant:i.type==="assistant"}])},[e("div",As,[i.type==="user"?(h(),m("div",Ns,a(i.content),1)):(h(),m("div",Ls,[i.thinking||((g=i.planExecution)==null?void 0:g.progress)!==void 0||(((L=(q=i.planExecution)==null?void 0:q.steps)==null?void 0:L.length)??0)>0?(h(),m("div",Vs,[e("div",Ms,[e("div",Us,[_(o(S),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Os,a(l.$t("chat.thinkingLabel")),1)]),e("div",qs,[i.thinking?(h(),m("div",Fs,[_(o(S),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,a(i.thinking),1)])):O("",!0),((Z=i.planExecution)==null?void 0:Z.progress)!==void 0?(h(),m("div",js,[e("div",Bs,[e("div",{class:"progress-fill",style:Ne({width:i.planExecution.progress+"%"})},null,4)]),e("span",Js,a(i.planExecution.progressText??l.$t("chat.processing")+"..."),1)])):O("",!0),(((j=(F=i.planExecution)==null?void 0:F.steps)==null?void 0:j.length)??0)>0?(h(),m("div",Ws,[e("h4",Hs,a(l.$t("chat.stepExecutionDetails")),1),(h(!0),m(me,null,be((D=i.planExecution)==null?void 0:D.steps,(Ce,H)=>{var xe,qe,Fe,je,Be,Je,We,He,Ge,ze,Xe,Ke,Qe,Ye,Ze,et,tt,nt,st;return h(),m("div",{key:H,class:ne(["ai-section",{running:$(i,H)==="RUNNING",completed:$(i,H)==="FINISHED",pending:$(i,H)==="IDLE"}]),onClick:pe(re=>V(i,H),["stop"])},[e("div",zs,[e("span",Xs,a($(i,H)==="FINISHED"?"✓":$(i,H)==="RUNNING"?"▶":"○"),1),e("span",Ks,a(Ce||`${l.$t("chat.step")} ${H+1}`),1),$(i,H)==="RUNNING"?(h(),m("span",Qs,a(l.$t("chat.status.executing")),1)):$(i,H)==="FINISHED"?(h(),m("span",Ys,a(l.$t("chat.status.completed")),1)):(h(),m("span",Zs,a(l.$t("chat.status.pending")),1))]),i.stepActions&&i.stepActions[H]?(h(),m("div",eo,[e("div",to,[e("span",no,a(((xe=i.stepActions[H])==null?void 0:xe.status)==="current"?"🔄":((qe=i.stepActions[H])==null?void 0:qe.status)==="completed"?"✓":"⏳"),1),e("strong",null,a((Fe=i.stepActions[H])==null?void 0:Fe.actionDescription),1)]),(je=i.stepActions[H])!=null&&je.toolParameters?(h(),m("div",so,[s[0]||(s[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",oo,a(l.$t("common.parameters"))+":",1),e("pre",ao,a((Be=i.stepActions[H])==null?void 0:Be.toolParameters),1)])):O("",!0),(Je=i.stepActions[H])!=null&&Je.thinkOutput?(h(),m("div",lo,[e("div",io,[s[1]||(s[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",co,a(l.$t("chat.thinkingOutput"))+":",1)]),e("div",ro,[e("pre",uo,a((We=i.stepActions[H])==null?void 0:We.thinkOutput),1)])])):O("",!0)])):O("",!0),((He=A(i,H))==null?void 0:He.length)>0?(h(),m("div",po,[e("div",ho,[_(o(S),{icon:"carbon:tree-view",class:"sub-plan-icon"}),s[2]||(s[2]=e("span",{class:"sub-plan-title"},"子执行计划",-1))]),e("div",go,[(h(!0),m(me,null,be(A(i,H),(re,ie)=>(h(),m("div",{key:`sub-${H}-${ie}`,class:ne(["sub-plan-step-item",{completed:w(i,H,ie)==="completed",current:w(i,H,ie)==="current",pending:w(i,H,ie)==="pending"}]),onClick:pe(ot=>x(i,H,ie),["stop"])},[e("div",vo,[e("span",fo,a(w(i,H,ie)==="completed"?"✓":w(i,H,ie)==="current"?"▶":"○"),1),e("span",bo,a(ie+1),1)]),e("div",Po,[e("span",_o,a(re),1),s[3]||(s[3]=e("span",{class:"sub-step-badge"},"子步骤",-1))])],10,mo))),128))])])):O("",!0),(Ge=i.planExecution)!=null&&Ge.userInputWaitState&&$(i,H)==="RUNNING"?(h(),m("div",ko,[e("p",$o,a(((Xe=(ze=i.planExecution)==null?void 0:ze.userInputWaitState)==null?void 0:Xe.message)??l.$t("chat.userInput.message")),1),(Qe=(Ke=i.planExecution)==null?void 0:Ke.userInputWaitState)!=null&&Qe.formDescription?(h(),m("p",So,a((Ze=(Ye=i.planExecution)==null?void 0:Ye.userInputWaitState)==null?void 0:Ze.formDescription),1)):O("",!0),e("form",{onSubmit:pe(re=>fe(i),["prevent"]),class:"user-input-form"},[(tt=(et=i.planExecution)==null?void 0:et.userInputWaitState)!=null&&tt.formInputs&&i.planExecution.userInputWaitState.formInputs.length>0?(h(!0),m(me,{key:0},be((st=(nt=i.planExecution)==null?void 0:nt.userInputWaitState)==null?void 0:st.formInputs,(re,ie)=>(h(),m("div",{key:ie,class:"form-group"},[e("label",{for:`form-input-${re.label.replace(/\W+/g,"_")}`},a(re.label)+": ",9,yo),he(e("input",{type:"text",id:`form-input-${re.label.replace(/\W+/g,"_")}`,name:re.label,"onUpdate:modelValue":ot=>b[i.id][ie]=ot,class:"form-input"},null,8,wo),[[ve,b[i.id][ie]]])]))),128)):(h(),m("div",To,[e("label",Eo,a(l.$t("common.input"))+":",1),he(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":re=>i.genericInput=re,class:"form-input"},null,8,Io),[[ve,i.genericInput]])])),e("button",xo,a(l.$t("chat.userInput.submit")),1)],40,Co)])):O("",!0)],10,Gs)}),128))])):!i.content&&(i.thinking||((W=i.planExecution)==null?void 0:W.progress)!==void 0&&(((le=i.planExecution)==null?void 0:le.progress)??0)<100)?(h(),m("div",Do,[e("div",Ro,[s[4]||(s[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,a(i.thinking??l.$t("chat.thinkingProcessing")),1)])])):O("",!0)])])):O("",!0),e("div",Ao,[e("div",No,[e("div",Lo,[_(o(S),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Vo,a(l.$t("chat.botName")),1)]),e("div",Mo,[i.content?(h(),m("div",Uo,[e("div",{class:"response-text",innerHTML:X(i.content)},null,8,Oo)])):(h(),m("div",qo,[e("div",Fo,[s[5]||(s[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",jo,a(l.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),G.value?(h(),m("div",Bo,[e("div",Jo,[e("div",Wo,[e("div",Ho,[e("div",Go,[e("div",zo,[_(o(S),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Xo,a(l.$t("chat.thinkingLabel")),1)]),e("div",Ko,[e("div",Qo,[e("div",Yo,[s[6]||(s[6]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,a(l.$t("chat.thinking")),1)])])])]),e("div",Zo,[e("div",ea,[e("div",ta,[_(o(S),{icon:"carbon:bot",class:"bot-icon"})]),e("div",na,a(l.$t("chat.botName")),1)]),e("div",sa,[e("div",oa,[e("div",aa,[s[7]||(s[7]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",la,a(l.$t("chat.thinkingResponse")),1)])])])])])])])):O("",!0)],512),u.value?(h(),m("div",{key:0,class:"scroll-to-bottom-btn",onClick:te,title:l.$t("chat.scrollToBottom")},[_(o(S),{icon:"carbon:chevron-down"})],8,ia)):O("",!0)]))}}),ra=Se(ca,[["__scopeId","data-v-d1fb4f30"]]),ua={class:"input-area"},da={class:"input-container"},pa={class:"attach-btn",title:"附加文件"},ha=["placeholder","disabled"],ga=["title"],ma=["disabled","title"],va=$e({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1}},emits:["send","clear","update-state","plan-mode-clicked"],setup(B,{expose:t,emit:n}){const{t:c}=Ie(),y=B,r=n,E=R(),T=R(""),G=ke(()=>y.placeholder||c("input.placeholder")),p=R(G.value),I=ke(()=>!!y.disabled),u=()=>{ce(()=>{E.value&&(E.value.style.height="auto",E.value.style.height=Math.min(E.value.scrollHeight,120)+"px")})},b=J=>{J.key==="Enter"&&!J.shiftKey&&(J.preventDefault(),C())},C=()=>{if(!T.value.trim()||I.value)return;const J=T.value.trim();r("send",J),ee()},U=()=>{r("plan-mode-clicked")},ee=()=>{T.value="",u(),r("clear")};return t({clearInput:ee,updateState:(J,te)=>{te&&(p.value=J?te:c("input.waiting")),r("update-state",J,te)},getQuery:()=>T.value.trim(),focus:()=>{var J;return(J=E.value)==null?void 0:J.focus()}}),we(()=>{}),Te(()=>{}),(J,te)=>(h(),m("div",ua,[e("div",da,[e("button",pa,[_(o(S),{icon:"carbon:attachment"})]),he(e("textarea",{"onUpdate:modelValue":te[0]||(te[0]=ae=>T.value=ae),ref_key:"inputRef",ref:E,class:"chat-input",placeholder:p.value,disabled:I.value,onKeydown:b,onInput:u},null,40,ha),[[ve,T.value]]),e("button",{class:"plan-mode-btn",title:J.$t("input.planMode"),onClick:U},[_(o(S),{icon:"carbon:document"}),K(" "+a(J.$t("input.planMode")),1)],8,ga),e("button",{class:"send-button",disabled:!T.value.trim()||I.value,onClick:C,title:J.$t("input.send")},[_(o(S),{icon:"carbon:send-alt"}),K(" "+a(J.$t("input.send")),1)],8,ma)])]))}}),fa=Se(va,[["__scopeId","data-v-c8e17afe"]]);class Ee{static async getAllCronTasks(){try{const t=await fetch(this.BASE_URL);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get cron tasks:",t),t}}static async getCronTaskById(t){try{const n=await fetch(`${this.BASE_URL}/${t}`);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get cron task by id:",n),n}}static async createCronTask(t){try{const n=await fetch(this.BASE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to create cron task:",n),n}}static async updateCronTask(t,n){try{const c=await fetch(`${this.BASE_URL}/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});return await(await this.handleResponse(c)).json()}catch(c){throw console.error("Failed to update cron task:",c),c}}static async updateTaskStatus(t,n){try{const c=await fetch(`${this.BASE_URL}/${t}/status?status=${n}`,{method:"PUT"});await this.handleResponse(c)}catch(c){throw console.error("Failed to update task status:",c),c}}static async deleteCronTask(t){try{const n=await fetch(`${this.BASE_URL}/${t}`,{method:"DELETE"});await this.handleResponse(n)}catch(n){throw console.error("Failed to delete cron task:",n),n}}static async executeTaskNow(t){return console.log("Execute task now:",t),new Promise(n=>{setTimeout(()=>{n()},1e3)})}static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}}z(Ee,"BASE_URL","/api/cron-tasks");const ba={class:"modal-header"},Pa={class:"modal-content"},_a={class:"form-group"},ka={class:"form-label"},$a=["placeholder"],Sa={class:"form-group"},Ca={class:"form-label"},ya=["placeholder"],wa={class:"form-help"},Ta={class:"form-group"},Ea={class:"form-label"},Ia=["placeholder"],xa={class:"form-group"},Da={class:"form-label"},Ra={class:"status-toggle"},Aa={key:0,class:"form-group"},Na={class:"form-label"},La={class:"form-info"},Va={key:1,class:"form-group"},Ma={class:"form-label"},Ua={class:"form-info"},Oa={key:2,class:"form-group"},qa={class:"form-label"},Fa={class:"form-info"},ja={class:"modal-footer"},Ba=["disabled"],Ja=$e({__name:"TaskDetailModal",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","save"],setup(B,{emit:t}){const n=B,c=t,y=R(!1),r=R({cronName:"",cronTime:"",planDesc:"",status:1}),E=p=>{p.target===p.currentTarget&&c("update:modelValue",!1)},T=async()=>{var p,I,u;if(!(!((p=r.value.cronName)!=null&&p.trim())||!((I=r.value.cronTime)!=null&&I.trim()))){y.value=!0;try{const b={...r.value,id:((u=n.task)==null?void 0:u.id)||"",cronName:r.value.cronName,cronTime:r.value.cronTime,planDesc:r.value.planDesc,status:r.value.status};console.log("Saving task:",b),c("save",b)}finally{y.value=!1}}},G=p=>new Date(p).toLocaleString();return ye(()=>n.task,p=>{console.log("TaskDetailModal received task:",p),p&&(r.value={cronName:p.name||p.cronName||"",cronTime:p.cronExpression||p.cronTime||"",planDesc:p.description||p.planDesc||"",status:p.status??1},console.log("TaskDetailModal formData updated:",r.value))},{immediate:!0}),ye(()=>n.modelValue,p=>{p||(r.value={cronName:"",cronTime:"",planDesc:"",status:1})}),(p,I)=>(h(),de(Le,{to:"body"},[_(Re,{name:"modal"},{default:Ae(()=>{var u,b,C;return[p.modelValue?(h(),m("div",{key:0,class:"modal-overlay",onClick:E},[e("div",{class:"modal-container",onClick:I[7]||(I[7]=pe(()=>{},["stop"]))},[e("div",ba,[e("h3",null,a(p.$t("cronTask.taskDetail")),1),e("button",{class:"close-btn",onClick:I[0]||(I[0]=U=>p.$emit("update:modelValue",!1))},[_(o(S),{icon:"carbon:close"})])]),e("div",Pa,[e("form",{onSubmit:pe(T,["prevent"]),class:"task-form"},[e("div",_a,[e("label",ka,a(p.$t("cronTask.taskName")),1),he(e("input",{"onUpdate:modelValue":I[1]||(I[1]=U=>r.value.cronName=U),type:"text",class:"form-input",placeholder:p.$t("cronTask.taskNamePlaceholder"),required:""},null,8,$a),[[ve,r.value.cronName]])]),e("div",Sa,[e("label",Ca,a(p.$t("cronTask.cronExpression")),1),he(e("input",{"onUpdate:modelValue":I[2]||(I[2]=U=>r.value.cronTime=U),type:"text",class:"form-input",placeholder:p.$t("cronTask.cronExpressionPlaceholder"),required:""},null,8,ya),[[ve,r.value.cronTime]]),e("div",wa,a(p.$t("cronTask.cronExpressionHelp")),1)]),e("div",Ta,[e("label",Ea,a(p.$t("cronTask.taskDescription")),1),he(e("textarea",{"onUpdate:modelValue":I[3]||(I[3]=U=>r.value.planDesc=U),class:"form-textarea",placeholder:p.$t("cronTask.taskDescriptionPlaceholder"),rows:"4"},null,8,Ia),[[ve,r.value.planDesc]])]),e("div",xa,[e("label",Da,a(p.$t("cronTask.taskStatus")),1),e("div",Ra,[e("button",{type:"button",class:ne(["status-btn",r.value.status===0?"active":""]),onClick:I[4]||(I[4]=U=>r.value.status=0)},[_(o(S),{icon:"carbon:checkmark"}),K(" "+a(p.$t("cronTask.active")),1)],2),e("button",{type:"button",class:ne(["status-btn",r.value.status===1?"active":""]),onClick:I[5]||(I[5]=U=>r.value.status=1)},[_(o(S),{icon:"carbon:close"}),K(" "+a(p.$t("cronTask.inactive")),1)],2)])]),(u=p.task)!=null&&u.createTime?(h(),m("div",Aa,[e("label",Na,a(p.$t("cronTask.createTime")),1),e("div",La,a(G(p.task.createTime)),1)])):O("",!0),(b=p.task)!=null&&b.updateTime?(h(),m("div",Va,[e("label",Ma,a(p.$t("cronTask.updateTime")),1),e("div",Ua,a(G(p.task.updateTime)),1)])):O("",!0),(C=p.task)!=null&&C.nextExecutionTime?(h(),m("div",Oa,[e("label",qa,a(p.$t("cronTask.nextExecution")),1),e("div",Fa,a(G(p.task.nextExecutionTime)),1)])):O("",!0)],32)]),e("div",ja,[e("button",{type:"button",class:"cancel-btn",onClick:I[6]||(I[6]=U=>p.$emit("update:modelValue",!1))},a(p.$t("common.cancel")),1),e("button",{type:"button",class:"save-btn",onClick:T,disabled:y.value},[y.value?(h(),de(o(S),{key:0,icon:"carbon:loading",class:"loading-icon"})):O("",!0),K(" "+a(p.$t("common.save")),1)],8,Ba)])])])):O("",!0)]}),_:1})]))}}),Wa=Se(Ja,[["__scopeId","data-v-df9d96bb"]]),Ha={class:"modal-header"},Ga={class:"header-left"},za={class:"title-row"},Xa={class:"modal-content"},Ka={key:0,class:"loading-container"},Qa={key:1,class:"empty-container"},Ya={key:2,class:"task-list"},Za=["onClick"],el={class:"task-main"},tl={class:"task-info"},nl={class:"task-header"},sl={class:"task-name"},ol={class:"task-description"},al={class:"task-time"},ll=["onClick"],il=["onClick","disabled","title"],cl=["onClick","title"],rl={class:"dropdown-menu"},ul=["onClick"],dl=["onClick","disabled"],pl=["onClick","disabled"],hl={class:"confirm-header"},gl={class:"confirm-content"},ml={class:"confirm-actions"},vl=["disabled"],fl=$e({__name:"index",props:{modelValue:{type:Boolean,required:!0}},emits:["update:modelValue"],setup(B,{emit:t}){const n=at(),c=lt(),y=pt(),r=B,E=t,T=R([]),G=R(!1),p=R(null),I=R(null),u=R(null),b=R(null),C=R(!1),U=R(null),ee=R(!1),Q=R(null),oe=v=>{v.target===v.currentTarget&&E("update:modelValue",!1)},J=async()=>{G.value=!0;try{T.value=await Ee.getAllCronTasks()}catch(v){console.error("Failed to load cron tasks:",v)}finally{G.value=!1}},te=async v=>{p.value=v;try{const N=T.value.find(f=>f.id===v);if(!N){console.error("Task not found:",v);return}const d=N.planDesc||N.description||N.cronName||"";if(d.trim()){console.log("[CronTaskModal] Setting task to store:",d),c.setTask(d.trim()),E("update:modelValue",!1);const f=Date.now().toString();console.log("[CronTaskModal] Navigating to direct page with chatId:",f),await n.push({name:"direct",params:{id:f}}),console.log("[CronTaskModal] Navigation to direct page completed")}else console.warn("[CronTaskModal] No task content found for task:",N)}catch(N){console.error("Failed to execute task:",N)}finally{p.value=null}},ae=v=>{console.log("showTaskDetail called with task:",v),U.value={...v},console.log("selectedTask.value set to:",U.value),C.value=!0},ge=v=>{U.value={...v},C.value=!0,b.value=null},Pe=async v=>{try{v.id&&(await Ee.updateCronTask(Number(v.id),v),await J()),C.value=!1}catch(N){console.error("Failed to save task:",N)}},k=v=>{Q.value=v,ee.value=!0},$=async()=>{var v;if((v=Q.value)!=null&&v.id){I.value=Q.value.id;try{await Ee.deleteCronTask(String(Q.value.id)),await J(),ee.value=!1,Q.value=null}catch(N){console.error("Failed to delete task:",N)}finally{I.value=null}}},V=()=>{ee.value=!1,Q.value=null},A=v=>{b.value=b.value===v?null:v},w=async v=>{if(v.id){u.value=v.id;try{const N=v.status===0?1:0;await Ee.updateCronTask(Number(v.id),{...v,status:N}),await J(),b.value=null}catch(N){console.error("Failed to toggle task status:",N)}finally{u.value=null}}},x=async v=>{try{await navigator.clipboard.writeText(v),y.success("成功复制cron表达式")}catch{y.error("复制失败")}},Y=v=>{const N=v.target;!N.closest(".action-dropdown")&&!N.closest(".dropdown-menu")&&(b.value=null)};return we(()=>{document.addEventListener("click",Y,!0)}),Te(()=>{document.removeEventListener("click",Y,!0)}),ye(()=>r.modelValue,v=>{v&&J()}),(v,N)=>(h(),m(me,null,[(h(),de(Le,{to:"body"},[_(Re,{name:"modal"},{default:Ae(()=>[B.modelValue?(h(),m("div",{key:0,class:"modal-overlay",onClick:oe},[e("div",{class:"modal-container",onClick:N[2]||(N[2]=pe(()=>{},["stop"]))},[e("div",Ha,[e("div",Ga,[e("div",za,[e("h3",null,a(v.$t("cronTask.title")),1)])]),e("button",{class:"close-btn",onClick:N[0]||(N[0]=d=>v.$emit("update:modelValue",!1))},[_(o(S),{icon:"carbon:close"})])]),e("div",Xa,[G.value?(h(),m("div",Ka,[_(o(S),{icon:"carbon:loading",class:"loading-icon"}),e("span",null,a(v.$t("common.loading")),1)])):T.value.length===0?(h(),m("div",Qa,[_(o(S),{icon:"carbon:time",class:"empty-icon"}),e("span",null,a(v.$t("cronTask.noTasks")),1)])):(h(),m("div",Ya,[(h(!0),m(me,null,be(T.value,d=>(h(),m("div",{key:d.id||"",class:"task-item",onClick:f=>ae(d)},[e("div",el,[e("div",tl,[e("div",nl,[e("div",sl,a(d.cronName),1),e("div",{class:ne(["task-status-badge",d.status===0?"active":"inactive"])},[_(o(S),{icon:d.status===0?"carbon:checkmark-filled":"carbon:pause-filled"},null,8,["icon"]),e("span",null,a(d.status===0?v.$t("cronTask.active"):v.$t("cronTask.inactive")),1)],2)]),e("div",ol,a(d.planDesc||d.description),1),e("div",al,[_(o(S),{icon:"carbon:time"}),e("span",{class:"cron-readable",style:{cursor:"pointer"},onClick:pe(f=>x(d.cronTime),["stop"])},a(d.cronTime),9,ll)])])]),e("div",{class:"task-actions",onClick:N[1]||(N[1]=pe(()=>{},["stop"]))},[e("button",{class:"action-btn execute-btn",onClick:f=>te(d.id),disabled:p.value===d.id,title:v.$t("cronTask.executeOnce")},[_(o(S),{icon:p.value===d.id?"carbon:loading":"carbon:play-filled"},null,8,["icon"]),K(" "+a(v.$t("cronTask.executeOnce")),1)],8,il),e("div",{class:ne(["action-dropdown",{active:b.value===d.id}])},[e("button",{class:"action-btn dropdown-btn",onClick:f=>A(d.id),title:v.$t("cronTask.operations")},[_(o(S),{icon:"carbon:overflow-menu-horizontal"}),K(" "+a(v.$t("cronTask.operations")),1)],8,cl),he(e("div",rl,[e("button",{class:"dropdown-item edit-btn",onClick:f=>ge(d)},[_(o(S),{icon:"carbon:edit"}),K(" "+a(v.$t("cronTask.edit")),1)],8,ul),e("button",{class:"dropdown-item toggle-btn",onClick:f=>w(d),disabled:u.value===d.id},[_(o(S),{icon:u.value===d.id?"carbon:loading":d.status===0?"carbon:pause-filled":"carbon:play-filled"},null,8,["icon"]),K(" "+a(d.status===0?v.$t("cronTask.disable"):v.$t("cronTask.enable")),1)],8,dl),e("button",{class:"dropdown-item delete-btn",onClick:f=>k(d),disabled:I.value===d.id},[_(o(S),{icon:I.value===d.id?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),K(" "+a(v.$t("cronTask.delete")),1)],8,pl)],512),[[rt,b.value===d.id]])],2)])],8,Za))),128))]))])])])):O("",!0)]),_:1})])),_(Wa,{modelValue:C.value,"onUpdate:modelValue":N[3]||(N[3]=d=>C.value=d),task:U.value,onSave:Pe},null,8,["modelValue","task"]),(h(),de(Le,{to:"body"},[_(Re,{name:"modal"},{default:Ae(()=>{var d,f,M,X;return[ee.value?(h(),m("div",{key:0,class:"modal-overlay",onClick:V},[e("div",{class:"confirm-modal",onClick:N[4]||(N[4]=pe(()=>{},["stop"]))},[e("div",hl,[_(o(S),{icon:"carbon:warning",class:"warning-icon"}),e("h3",null,a(v.$t("cronTask.deleteConfirm")),1)]),e("div",gl,[e("p",null,a(v.$t("cronTask.deleteConfirmMessage",{taskName:((d=Q.value)==null?void 0:d.cronName)||((f=Q.value)==null?void 0:f.planDesc)||""})),1)]),e("div",ml,[e("button",{class:"confirm-btn cancel-btn",onClick:V},a(v.$t("common.cancel")),1),e("button",{class:"confirm-btn delete-btn",onClick:$,disabled:I.value===((M=Q.value)==null?void 0:M.id)},[_(o(S),{icon:I.value===((X=Q.value)==null?void 0:X.id)?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),K(" "+a(v.$t("cronTask.delete")),1)],8,vl)])])])):O("",!0)]}),_:1})]))],64))}}),bl=Se(fl,[["__scopeId","data-v-1312062c"]]),Pl={class:"direct-page"},_l={class:"direct-chat"},kl={class:"chat-header"},$l={class:"header-actions"},Sl=["title"],Cl=["title"],yl={class:"chat-content"},wl=["title"],Tl=$e({__name:"index",setup(B){const t=ut(),n=at(),c=lt(),{t:y}=Ie(),r=R(""),E=R(),T=R(),G=R(),p=R(!1),I=R(!1),u=R(null),b=R(!1),C=R(50),U=R(!1),ee=R(0),Q=R(0);we(()=>{console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",c.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",c.hasUnprocessedTask()),se.setEventCallbacks({onPlanUpdate:f=>{console.log("[Direct] Plan update event received for rootPlanId:",f),ge(f)&&(console.log("[Direct] Processing plan update for current rootPlanId:",f),T.value&&typeof T.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",f),T.value.handlePlanUpdate(f)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),E.value&&typeof E.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",f),E.value.updateDisplayedPlanProgress(f)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:f=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",f),!!ge(f)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",f),T.value&&typeof T.value.handlePlanCompleted=="function"){const M=se.getCachedPlanRecord(f);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",M),T.value.handlePlanCompleted(M??{planId:f})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");u.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:f=>{console.log("[Direct] Dialog round start event received for rootPlanId:",f),u.value=f,console.log("[Direct] Set currentRootPlanId to:",f),T.value&&typeof T.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",f),T.value.handleDialogRoundStart(f)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),k()},onChatInputUpdateState:f=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",f),!ge(f,!0))return;const M=se.getCachedUIState(f);M&&V(M.enabled,M.placeholder)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),P.loadPlanTemplateList(),c.hasUnprocessedTask()&&c.currentTask?(r.value=c.currentTask.prompt,console.log("[Direct] Setting prompt from store:",r.value),c.markTaskAsProcessed(),console.log("[Direct] Received task from store:",r.value)):(r.value=t.query.prompt||"",console.log("[Direct] Received task from URL:",r.value),console.log("[Direct] No unprocessed task in store"));const d=localStorage.getItem("directPanelWidth");d&&(C.value=parseFloat(d)),console.log("[Direct] Final prompt value:",r.value)}),ye(()=>c.currentTask,d=>{console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",d),d&&!d.processed?(r.value=d.prompt,c.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",r.value)):console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),ye(()=>r.value,(d,f)=>{console.log("[Direct] prompt value changed from:",f,"to:",d)},{immediate:!1}),Te(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),u.value=null,se.cleanup(),document.removeEventListener("mousemove",J),document.removeEventListener("mouseup",te)});const oe=d=>{U.value=!0,ee.value=d.clientX,Q.value=C.value,document.addEventListener("mousemove",J),document.addEventListener("mouseup",te),document.body.style.cursor="col-resize",document.body.style.userSelect="none",d.preventDefault()},J=d=>{if(!U.value)return;const f=window.innerWidth,X=(d.clientX-ee.value)/f*100;let fe=Q.value+X;fe=Math.max(20,Math.min(80,fe)),C.value=fe},te=()=>{U.value=!1,document.removeEventListener("mousemove",J),document.removeEventListener("mouseup",te),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",C.value.toString())},ae=()=>{C.value=50,localStorage.setItem("directPanelWidth","50")},ge=(d,f=!1)=>!u.value||d===u.value||f&&(d==="ui-state"||d==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",d,"current:",u.value),!1),Pe=d=>{console.log("[DirectView] Send message from input:",d),T.value&&typeof T.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",d),T.value.handleSendMessage(d)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},k=()=>{console.log("[DirectView] Input cleared"),G.value&&typeof G.value.clear=="function"&&G.value.clear()},$=()=>{console.log("[DirectView] Input focused")},V=(d,f)=>{console.log("[DirectView] Input state updated:",d,f),I.value=!d},A=(d,f)=>{console.log("[DirectView] Step selected:",d,f),E.value&&typeof E.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",d,f),E.value.handleStepSelected(d,f)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},w=(d,f,M,X)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:d,subPlanId:f,stepIndex:M,subStepIndex:X}),E.value&&typeof E.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:d,subPlanId:f,stepIndex:M,subStepIndex:X}),E.value.handleSubPlanStepSelected(d,f,M,X)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},x=()=>{console.log("[DirectView] Plan mode button clicked"),P.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",P.isCollapsed)},Y=()=>{n.push("/home")},v=()=>{n.push("/configs")},N=async d=>{var f;if(console.log("[DirectView] Plan execution requested:",d),p.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}p.value=!0,T.value&&typeof T.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",d.title),T.value.addMessage("user",d.title)):console.warn("[DirectView] chatRef.addMessage method not available");try{const M=d.planData.planTemplateId||d.planData.planId;if(!M)throw new Error("没有找到计划模板ID");console.log("[Direct] Executing plan with templateId:",M,"params:",d.params),console.log("[Direct] About to call PlanActApiService.executePlan");let X;if((f=d.params)!=null&&f.trim()?(console.log("[Direct] Calling executePlan with params:",d.params.trim()),X=await ue.executePlan(M,d.params.trim())):(console.log("[Direct] Calling executePlan without params"),X=await ue.executePlan(M)),console.log("[Direct] Plan execution API response:",X),X.planId)console.log("[Direct] Got planId from response:",X.planId,"starting plan execution"),u.value=X.planId,console.log("[Direct] Set currentRootPlanId to:",X.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),se.handlePlanExecutionRequested(X.planId,d.title);else throw console.error("[Direct] No planId in response:",X),new Error("执行计划失败：未返回有效的计划ID")}catch(M){console.error("[Direct] Plan execution failed:",M),console.error("[Direct] Error details:",{message:M.message,stack:M.stack}),u.value=null,T.value&&typeof T.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),T.value.addMessage("user",d.title),T.value.addMessage("assistant",`执行计划失败: ${M.message||"未知错误"}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`执行计划失败: ${M.message||"未知错误"}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),p.value=!1}};return(d,f)=>(h(),m("div",Pl,[e("div",_l,[_(gn,{onPlanExecutionRequested:N}),e("div",{class:"left-panel",style:Ne({width:C.value+"%"})},[e("div",kl,[e("button",{class:"back-button",onClick:Y},[_(o(S),{icon:"carbon:arrow-left"})]),e("h2",null,a(d.$t("conversation")),1),e("div",$l,[_(dt),e("button",{class:"config-button",onClick:v,title:d.$t("direct.configuration")},[_(o(S),{icon:"carbon:settings-adjust",width:"20"})],8,Sl),e("button",{class:"cron-task-btn",onClick:f[0]||(f[0]=M=>b.value=!0),title:d.$t("cronTask.title")},[_(o(S),{icon:"carbon:alarm",width:"20"})],8,Cl)])]),e("div",yl,[_(ra,{ref_key:"chatRef",ref:T,mode:"direct","initial-prompt":r.value||"",onStepSelected:A,onSubPlanStepSelected:w},null,8,["initial-prompt"])]),(h(),de(fa,{key:d.$i18n.locale,ref_key:"inputRef",ref:G,disabled:I.value,placeholder:I.value?o(y)("input.waiting"):o(y)("input.placeholder"),onSend:Pe,onClear:k,onFocus:$,onUpdateState:V,onPlanModeClicked:x},null,8,["disabled","placeholder"]))],4),e("div",{class:"panel-resizer",onMousedown:oe,onDblclick:ae,title:d.$t("direct.panelResizeHint")},f[2]||(f[2]=[e("div",{class:"resizer-line"},null,-1)]),40,wl),_(xs,{ref_key:"rightPanelRef",ref:E,style:Ne({width:100-C.value+"%"})},null,8,["style"])]),_(bl,{modelValue:b.value,"onUpdate:modelValue":f[1]||(f[1]=M=>b.value=M)},null,8,["modelValue"])]))}}),Nl=Se(Tl,[["__scopeId","data-v-cf083d3a"]]);export{Nl as default};
