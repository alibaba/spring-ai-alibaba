var it=Object.defineProperty;var ct=(j,l,s)=>l in j?it(j,l,{enumerable:!0,configurable:!0,writable:!0,value:s}):j[l]=s;var ce=(j,l,s)=>ct(j,typeof l!="symbol"?l+"":l,s);import{m as rt,r as M,g as le,d as be,f as Se,h as ke,c as m,o as v,p as oe,u as a,e,b as J,t as c,i as y,q as te,F as ge,j as ve,s as ye,w as fe,v as Pe,x as at,k as ae,y as Ce,a as _e,T as ut,z as dt,A as we,n as xe,B as pt,l as ht}from"./index-szgMflqz.js";import{I as w,_ as $e}from"./_plugin-vue_export-helper-BQaDodiB.js";import{L as gt}from"./index-DBe7YN46.js";import{u as vt}from"./task-Bi5XAqP-.js";class re{static async generatePlan(l,s){const r={query:l};s&&(r.existingJson=s);const o=await fetch(`${this.PLAN_TEMPLATE_URL}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!o.ok)throw new Error(`Failed to generate plan: ${o.status}`);const p=await o.json();if(p.planJson)try{p.plan=JSON.parse(p.planJson)}catch{p.plan={error:"Unable to parse plan data"}}return p}static async executePlan(l,s){console.log("[PlanActApiService] executePlan called with:",{planTemplateId:l,rawParam:s});const r={planTemplateId:l};s&&(r.rawParam=s),console.log("[PlanActApiService] Making request to:",`${this.PLAN_TEMPLATE_URL}/executePlanByTemplateId`),console.log("[PlanActApiService] Request body:",r);const o=await fetch(`${this.PLAN_TEMPLATE_URL}/executePlanByTemplateId`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(console.log("[PlanActApiService] Response status:",o.status,o.ok),!o.ok){const C=await o.text();throw console.error("[PlanActApiService] Request failed:",C),new Error(`Failed to execute plan: ${o.status}`)}const p=await o.json();return console.log("[PlanActApiService] executePlan response:",p),p}static async savePlanTemplate(l,s){const r=await fetch(`${this.PLAN_TEMPLATE_URL}/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:l,planJson:s})});if(!r.ok)throw new Error(`Failed to save plan: ${r.status}`);return await r.json()}static async getPlanVersions(l){const s=await fetch(`${this.PLAN_TEMPLATE_URL}/versions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:l})});if(!s.ok)throw new Error(`Failed to get plan versions: ${s.status}`);return await s.json()}static async getVersionPlan(l,s){const r=await fetch(`${this.PLAN_TEMPLATE_URL}/get-version`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:l,versionIndex:s.toString()})});if(!r.ok)throw new Error(`Failed to get specific version plan: ${r.status}`);return await r.json()}static async getAllPlanTemplates(){const l=await fetch(`${this.PLAN_TEMPLATE_URL}/list`);if(!l.ok)throw new Error(`Failed to get plan template list: ${l.status}`);return await l.json()}static async updatePlanTemplate(l,s,r){const o={planId:l,query:s};r&&(o.existingJson=r);const p=await fetch(`${this.PLAN_TEMPLATE_URL}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!p.ok)throw new Error(`Failed to update plan template: ${p.status}`);const C=await p.json();if(C.planJson)try{C.plan=JSON.parse(C.planJson)}catch{C.plan={error:"Unable to parse plan data"}}return C}static async deletePlanTemplate(l){const s=await fetch(`${this.PLAN_TEMPLATE_URL}/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({planId:l})});if(!s.ok)throw new Error(`Failed to delete plan template: ${s.status}`);return await s.json()}}ce(re,"PLAN_TEMPLATE_URL","/api/plan-template");const lt=rt("sidebar",()=>{const j=M(!0),l=M("list"),s=M(null),r=M([]),o=M(null),p=M(!1),C=M(""),b=M(""),x=M(""),I=M(""),z=M(!1),X=M(!1),_=M([]),D=M(-1),Y=le(()=>[...r.value].sort((u,E)=>{const t=new Date(u.updateTime??u.createTime);return new Date(E.updateTime??E.createTime).getTime()-t.getTime()})),d=le(()=>_.value.length>1&&D.value>0),$=le(()=>_.value.length>1&&D.value<_.value.length-1),T=le(()=>{if(!o.value)return"";const u=`/api/plan-template/executePlanByTemplateId/${o.value.id}`,E=I.value.trim();return E?`${u}?${encodeURIComponent(E)}`:u}),q=()=>{j.value=!j.value},H=u=>{l.value=u},K=async()=>{p.value=!0,C.value="";try{console.log("[SidebarStore] Starting to load plan template list...");const u=await re.getAllPlanTemplates();u!=null&&u.templates&&Array.isArray(u.templates)?(r.value=u.templates,console.log(`[SidebarStore] Successfully loaded ${u.templates.length} plan templates`)):(r.value=[],console.warn("[SidebarStore] API returned abnormal data format, using empty list",u))}catch(u){console.error("[SidebarStore] Failed to load plan template list:",u),r.value=[],C.value=`Load failed: ${u.message}`}finally{p.value=!1}},ue=async u=>{s.value=u.id,o.value=u,l.value="config",await de(u),console.log(`[SidebarStore] Selected plan template: ${u.id}`)},de=async u=>{try{const E=await re.getPlanVersions(u.id);if(_.value=E.versions||[],_.value.length>0){const t=_.value[_.value.length-1];b.value=t,D.value=_.value.length-1;try{const n=JSON.parse(t);n.prompt&&(x.value=n.prompt),n.params&&(I.value=n.params)}catch{console.warn("Unable to parse JSON content to get prompt information")}}else b.value="",x.value="",I.value=""}catch(E){throw console.error("Failed to load template data:",E),E}},g=()=>{const u={id:`new-${Date.now()}`,title:"新建计划",description:"请使用计划生成器创建新的计划模板",createTime:new Date().toISOString(),updateTime:new Date().toISOString()};o.value=u,s.value=null,b.value="",x.value="",I.value="",_.value=[],D.value=-1,l.value="config",console.log("[SidebarStore] Created new empty plan template, switching to config tab")},P=async u=>{if(!u.id){console.warn("[SidebarStore] deleteTemplate: Invalid template object or ID");return}try{await re.deletePlanTemplate(u.id),s.value===u.id&&U(),await K(),console.log(`[SidebarStore] Plan template ${u.id} has been deleted`)}catch(E){throw console.error("Failed to delete plan template:",E),await K(),E}},U=()=>{s.value=null,o.value=null,b.value="",x.value="",I.value="",_.value=[],D.value=-1,l.value="list"};return{isCollapsed:j,currentTab:l,currentPlanTemplateId:s,planTemplateList:r,selectedTemplate:o,isLoading:p,errorMessage:C,jsonContent:b,generatorPrompt:x,executionParams:I,isGenerating:z,isExecuting:X,planVersions:_,currentVersionIndex:D,sortedTemplates:Y,canRollback:d,canRestore:$,computedApiUrl:T,toggleSidebar:q,switchToTab:H,loadPlanTemplateList:K,selectTemplate:ue,createNewTemplate:g,deleteTemplate:P,clearSelection:U,clearExecutionParams:()=>{I.value=""},rollbackVersion:()=>{d.value&&(D.value--,b.value=_.value[D.value])},restoreVersion:()=>{$.value&&(D.value++,b.value=_.value[D.value])},saveTemplate:async()=>{if(!o.value)return;const u=b.value.trim();if(!u)throw new Error("Content cannot be empty");try{JSON.parse(u)}catch(E){throw new Error(`Invalid format, please correct and save.
Error: `+E.message)}try{const E=await re.savePlanTemplate(o.value.id,u);return D.value<_.value.length-1&&(_.value=_.value.slice(0,D.value+1)),_.value.push(u),D.value=_.value.length-1,E}catch(E){throw console.error("Failed to save plan template:",E),E}},generatePlan:async()=>{if(x.value.trim()){z.value=!0;try{const u=await re.generatePlan(x.value);if(b.value=u.planJson||"",o.value&&o.value.id.startsWith("new-")){let E="New Plan Template";try{E=JSON.parse(u.planJson||"{}").title||E}catch{console.warn("Unable to parse plan JSON to get title")}o.value={id:u.planTemplateId,title:E,description:"通过生成器创建的计划模板",createTime:new Date().toISOString(),updateTime:new Date().toISOString(),planJson:u.planJson},s.value=u.planTemplateId,await K()}return D.value<_.value.length-1&&(_.value=_.value.slice(0,D.value+1)),_.value.push(b.value),D.value=_.value.length-1,u}catch(u){throw console.error("Failed to generate plan:",u),u}finally{z.value=!1}}},updatePlan:async()=>{if(!(!x.value.trim()||!b.value.trim())&&o.value){z.value=!0;try{const u=await re.updatePlanTemplate(o.value.id,x.value,b.value);return b.value=u.planJson||"",D.value<_.value.length-1&&(_.value=_.value.slice(0,D.value+1)),_.value.push(b.value),D.value=_.value.length-1,u}catch(u){throw console.error("Failed to update plan:",u),u}finally{z.value=!1}}},preparePlanExecution:()=>{if(!o.value)return null;X.value=!0;try{let u;try{u=JSON.parse(b.value),u.planTemplateId=o.value.id}catch{u={planTemplateId:o.value.id,planId:o.value.id,title:o.value.title??"执行计划",steps:[{stepRequirement:"[BROWSER_AGENT] 访问百度搜索阿里巴巴的最新股价"},{stepRequirement:"[DEFAULT_AGENT] 提取和整理搜索结果中的股价信息"},{stepRequirement:"[TEXT_FILE_AGENT] 创建一个文本文件记录查询结果"},{stepRequirement:"[DEFAULT_AGENT] 向用户报告查询结果"}]}}return{title:o.value.title??u.title??"Execution Plan",planData:u,params:I.value.trim()||void 0}}catch(u){throw console.error("Failed to prepare plan execution:",u),X.value=!1,u}},finishPlanExecution:()=>{X.value=!1}}}),mt={class:"sidebar-content"},ft={class:"sidebar-content-header"},Pt={class:"sidebar-content-title"},_t={class:"tab-switcher"},bt=["disabled"],St={key:0,class:"tab-content"},kt={class:"new-task-section"},Ct={class:"sidebar-content-list"},$t={key:0,class:"loading-state"},Et={key:1,class:"error-state"},yt={key:2,class:"empty-state"},wt=["onClick"],xt={class:"task-icon"},It={class:"task-details"},Tt={class:"task-title"},Rt={class:"task-preview"},Dt={class:"task-time"},At={class:"task-actions"},Mt=["title","onClick"],Lt={key:1,class:"tab-content config-tab"},Ut={key:0,class:"config-container"},Nt={class:"template-info-header"},Ot={class:"template-info"},qt={class:"template-id"},Ft={class:"config-section"},Vt={class:"section-header"},Bt={class:"section-actions"},jt=["disabled","title"],Wt=["disabled","title"],Jt=["disabled"],zt=["placeholder"],Ht={class:"config-section"},Gt={class:"section-header"},Xt={class:"generator-content"},Kt=["placeholder"],Qt={class:"generator-actions"},Yt=["disabled"],Zt=["disabled"],en={class:"config-section"},tn={class:"section-header"},nn={class:"execution-content"},sn={class:"params-input-group"},on={class:"params-input-container"},an=["placeholder"],ln=["title"],cn={class:"api-url-display"},rn={class:"api-url-label"},un={class:"api-url"},dn=["disabled"],pn=be({__name:"index",emits:["planExecutionRequested"],setup(j,{expose:l,emit:s}){const{t:r}=Se(),o=lt(),p=s,C=()=>{o.createNewTemplate(),console.log("[PlanTemplateSidebar] 创建新的空白计划模板，切换到配置标签页")},b=async d=>{try{await o.selectTemplate(d),console.log(`[PlanTemplateSidebar] 选择了计划模板: ${d.id}`)}catch($){console.error("选择计划模板失败:",$),alert(r("sidebar.selectTemplateFailed")+": "+$.message)}},x=async d=>{if(confirm(r("sidebar.confirmDelete",{name:d.title??r("sidebar.unnamedPlan")})))try{await o.deleteTemplate(d),alert(r("sidebar.templateDeleted"))}catch($){console.error("删除计划模板失败:",$),alert(r("sidebar.deleteTemplateFailed")+": "+$.message)}},I=async()=>{try{const d=await o.saveTemplate();d!=null&&d.duplicate?alert(r("sidebar.saveCompleted",{message:d.message,versionCount:d.versionCount})):d!=null&&d.saved?alert(r("sidebar.saveSuccess",{message:d.message,versionCount:d.versionCount})):d!=null&&d.message&&alert(r("sidebar.saveStatus",{message:d.message}))}catch(d){console.error("保存计划修改失败:",d),alert(d.message||r("sidebar.saveFailed"))}},z=async()=>{var d;try{await o.generatePlan(),alert(r("sidebar.generateSuccess",{templateId:((d=o.selectedTemplate)==null?void 0:d.id)??r("sidebar.unknown")}))}catch($){console.error("生成计划失败:",$),alert(r("sidebar.generateFailed")+": "+$.message)}},X=async()=>{try{await o.updatePlan(),alert(r("sidebar.updateSuccess"))}catch(d){console.error("更新计划失败:",d),alert(r("sidebar.updateFailed")+": "+d.message)}},_=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const d=o.preparePlanExecution();if(!d){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] 触发计划执行请求:",d),console.log("[Sidebar] Emitting planExecutionRequested event"),p("planExecutionRequested",d),console.log("[Sidebar] Event emitted")}catch(d){console.error("执行计划出错:",d),alert(r("sidebar.executeFailed")+": "+d.message)}finally{o.finishPlanExecution()}},D=d=>{const T=new Date().getTime()-d.getTime(),q=Math.floor(T/6e4),H=Math.floor(T/36e5),K=Math.floor(T/864e5);return q<1?"刚刚":q<60?`${q}分钟前`:H<24?`${H}小时前`:K<30?`${K}天前`:d.toLocaleDateString("zh-CN")},Y=(d,$)=>!d||d.length<=$?d:d.substring(0,$)+"...";return ke(()=>{o.loadPlanTemplateList()}),l({loadPlanTemplateList:o.loadPlanTemplateList,toggleSidebar:o.toggleSidebar,currentPlanTemplateId:o.currentPlanTemplateId}),(d,$)=>(v(),m("div",{class:oe(["sidebar-wrapper",{"sidebar-wrapper-collapsed":a(o).isCollapsed}])},[e("div",mt,[e("div",ft,[e("div",Pt,c(d.$t("sidebar.title")),1)]),e("div",_t,[e("button",{class:oe(["tab-button",{active:a(o).currentTab==="list"}]),onClick:$[0]||($[0]=T=>a(o).switchToTab("list"))},[y(a(w),{icon:"carbon:list",width:"16"}),te(" "+c(d.$t("sidebar.templateList")),1)],2),e("button",{class:oe(["tab-button",{active:a(o).currentTab==="config"}]),onClick:$[1]||($[1]=T=>a(o).switchToTab("config")),disabled:!a(o).selectedTemplate},[y(a(w),{icon:"carbon:settings",width:"16"}),te(" "+c(d.$t("sidebar.configuration")),1)],10,bt)]),a(o).currentTab==="list"?(v(),m("div",St,[e("div",kt,[e("button",{class:"new-task-btn",onClick:C},[y(a(w),{icon:"carbon:add",width:"16"}),te(" "+c(d.$t("sidebar.newPlan"))+" ",1),$[10]||($[10]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",Ct,[a(o).isLoading?(v(),m("div",$t,[y(a(w),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,c(d.$t("sidebar.loading")),1)])):a(o).errorMessage?(v(),m("div",Et,[y(a(w),{icon:"carbon:warning",width:"20"}),e("span",null,c(a(o).errorMessage),1),e("button",{onClick:$[2]||($[2]=(...T)=>a(o).loadPlanTemplateList&&a(o).loadPlanTemplateList(...T)),class:"retry-btn"},c(d.$t("sidebar.retry")),1)])):a(o).planTemplateList.length===0?(v(),m("div",yt,[y(a(w),{icon:"carbon:document",width:"32"}),e("span",null,c(d.$t("sidebar.noTemplates")),1)])):(v(!0),m(ge,{key:3},ve(a(o).sortedTemplates,T=>(v(),m("div",{key:T.id,class:oe(["sidebar-content-list-item",{"sidebar-content-list-item-active":T.id===a(o).currentPlanTemplateId}]),onClick:q=>b(T)},[e("div",xt,[y(a(w),{icon:"carbon:document",width:"20"})]),e("div",It,[e("div",Tt,c(T.title||d.$t("sidebar.unnamedPlan")),1),e("div",Rt,c(Y(T.description||d.$t("sidebar.noDescription"),40)),1)]),e("div",Dt,c(D(new Date(T.updateTime||T.createTime))),1),e("div",At,[e("button",{class:"delete-task-btn",title:d.$t("sidebar.deleteTemplate"),onClick:ye(q=>x(T),["stop"])},[y(a(w),{icon:"carbon:close",width:"16"})],8,Mt)])],10,wt))),128))])])):a(o).currentTab==="config"?(v(),m("div",Lt,[a(o).selectedTemplate?(v(),m("div",Ut,[e("div",Nt,[e("div",Ot,[e("h3",null,c(a(o).selectedTemplate.title||d.$t("sidebar.unnamedPlan")),1),e("span",qt,"ID: "+c(a(o).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:$[3]||($[3]=T=>a(o).switchToTab("list"))},[y(a(w),{icon:"carbon:arrow-left",width:"16"})])]),e("div",Ft,[e("div",Vt,[y(a(w),{icon:"carbon:code",width:"16"}),e("span",null,c(d.$t("sidebar.jsonTemplate")),1),e("div",Bt,[e("button",{class:"btn btn-sm",onClick:$[4]||($[4]=(...T)=>a(o).rollbackVersion&&a(o).rollbackVersion(...T)),disabled:!a(o).canRollback,title:d.$t("sidebar.rollback")},[y(a(w),{icon:"carbon:undo",width:"14"})],8,jt),e("button",{class:"btn btn-sm",onClick:$[5]||($[5]=(...T)=>a(o).restoreVersion&&a(o).restoreVersion(...T)),disabled:!a(o).canRestore,title:d.$t("sidebar.restore")},[y(a(w),{icon:"carbon:redo",width:"14"})],8,Wt),e("button",{class:"btn btn-primary btn-sm",onClick:I,disabled:a(o).isGenerating||a(o).isExecuting},[y(a(w),{icon:"carbon:save",width:"14"})],8,Jt)])]),fe(e("textarea",{"onUpdate:modelValue":$[6]||($[6]=T=>a(o).jsonContent=T),class:"json-editor",placeholder:d.$t("sidebar.jsonPlaceholder"),rows:"8"},null,8,zt),[[Pe,a(o).jsonContent]])]),e("div",Ht,[e("div",Gt,[y(a(w),{icon:"carbon:generate",width:"16"}),e("span",null,c(d.$t("sidebar.planGenerator")),1)]),e("div",Xt,[fe(e("textarea",{"onUpdate:modelValue":$[7]||($[7]=T=>a(o).generatorPrompt=T),class:"prompt-input",placeholder:d.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,Kt),[[Pe,a(o).generatorPrompt]]),e("div",Qt,[e("button",{class:"btn btn-primary btn-sm",onClick:z,disabled:a(o).isGenerating||!a(o).generatorPrompt.trim()},[y(a(w),{icon:a(o).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:oe({spinning:a(o).isGenerating})},null,8,["icon","class"]),te(" "+c(a(o).isGenerating?d.$t("sidebar.generating"):d.$t("sidebar.generatePlan")),1)],8,Yt),e("button",{class:"btn btn-secondary btn-sm",onClick:X,disabled:a(o).isGenerating||!a(o).generatorPrompt.trim()||!a(o).jsonContent.trim()},[y(a(w),{icon:"carbon:edit",width:"14"}),te(" "+c(d.$t("sidebar.updatePlan")),1)],8,Zt)])])]),e("div",en,[e("div",tn,[y(a(w),{icon:"carbon:play",width:"16"}),e("span",null,c(d.$t("sidebar.executionController")),1)]),e("div",nn,[e("div",sn,[e("label",null,c(d.$t("sidebar.executionParams")),1),e("div",on,[fe(e("input",{"onUpdate:modelValue":$[8]||($[8]=T=>a(o).executionParams=T),class:"params-input",placeholder:d.$t("sidebar.executionParamsPlaceholder")},null,8,an),[[Pe,a(o).executionParams]]),e("button",{class:"clear-params-btn",onClick:$[9]||($[9]=(...T)=>a(o).clearExecutionParams&&a(o).clearExecutionParams(...T)),title:d.$t("sidebar.clearParams")},[y(a(w),{icon:"carbon:close",width:"12"})],8,ln)])]),e("div",cn,[e("span",rn,c(d.$t("sidebar.apiUrl"))+":",1),e("code",un,c(a(o).computedApiUrl),1)]),e("button",{class:"btn btn-primary execute-btn",onClick:_,disabled:a(o).isExecuting||a(o).isGenerating},[y(a(w),{icon:a(o).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:oe({spinning:a(o).isExecuting})},null,8,["icon","class"]),te(" "+c(a(o).isExecuting?d.$t("sidebar.executing"):d.$t("sidebar.executePlan")),1)],8,dn)])])])):J("",!0)])):J("",!0)])],2))}}),hn=$e(pn,[["__scopeId","data-v-36691af0"]]);class Te{static async sendMessage(l){const s=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:l})});if(!s.ok)throw new Error(`API request failed: ${s.status}`);return await s.json()}}ce(Te,"BASE_URL","/api/executor");class Re{static async getDetails(l){try{const s=await fetch(`${this.BASE_URL}/details/${l}`);if(s.status===404)return null;if(!s.ok)throw new Error(`Failed to get detailed information: ${s.status}`);const r=await s.text(),o=JSON.parse(r);return o&&typeof o=="object"&&!o.currentPlanId&&(o.currentPlanId=l),o}catch(s){return console.error("[CommonApiService] Failed to get plan details:",s),null}}static async submitFormInput(l,s){const r=await fetch(`${this.BASE_URL}/submit-input/${l}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!r.ok){let p;try{p=await r.json()}catch{p={message:`Failed to submit form input: ${r.status}`}}throw new Error(p.message||`Failed to submit form input: ${r.status}`)}const o=r.headers.get("content-type");return o&&o.indexOf("application/json")!==-1?await r.json():{success:!0}}}ce(Re,"BASE_URL","/api/executor");const he=class he{constructor(){ce(this,"POLL_INTERVAL",5e3);ce(this,"state",at({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));ce(this,"callbacks",{});ce(this,"planExecutionCache",new Map);ce(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(l){return this.planExecutionCache.get(l)}getCachedUIState(l){return this.uiStateCache.get(l)}setCachedUIState(l,s){this.uiStateCache.set(l,s),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${l}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(l){return this.planExecutionCache.has(l)}setCachedPlanRecord(l,s){this.planExecutionCache.set(l,s),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${l}`)}clearCachedPlanRecord(l){const s=this.planExecutionCache.delete(l);return s&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${l}`),s}clearAllCachedRecords(){const l=this.planExecutionCache.size,s=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${l}, UI States: ${s}`)}static getInstance(){return he.instance||(he.instance=new he),he.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(l){this.callbacks={...this.callbacks,...l},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(l))}async handleUserMessageSendRequested(l){if(this.validateAndPrepareUIForNewRequest(l))try{if(await this.sendUserMessageAndSetPlanId(l),this.state.activePlanId)this.initiatePlanExecutionSequence(l,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(s){console.error("[PlanExecutionManager] Failed to send user message:",s);const r=this.state.activePlanId??"error";this.setCachedUIState(r,{enabled:!0}),this.emitChatInputUpdateState(r),this.state.activePlanId=null}}handlePlanExecutionRequested(l,s){console.log("[PlanExecutionManager] Received plan execution request:",{planId:l,query:s}),l?(this.state.activePlanId=l,this.initiatePlanExecutionSequence(s??"执行计划",l)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(l,s){const r=this.getCachedPlanRecord(l);return r!=null&&r.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${l}`),this.handlePlanExecutionRequested(r.currentPlanId,s),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${l}`),!1)}validateAndPrepareUIForNewRequest(l){if(!l)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const s=this.state.activePlanId??"ui-state";return this.setCachedUIState(s,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(s),!0}async sendUserMessageAndSetPlanId(l){try{const s=await Te.sendMessage(l);if(s!=null&&s.planId)return this.state.activePlanId=s.planId,s;if(s!=null&&s.planTemplateId)return this.state.activePlanId=s.planTemplateId,{...s,planId:s.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",s),new Error("Failed to get valid planId from API response")}catch(s){throw console.error("[PlanExecutionManager] API call failed:",s),s}}initiatePlanExecutionSequence(l,s){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${l}", planId: ${s}`);const r=s;this.emitDialogRoundStart(r),this.startPolling()}handlePlanCompletion(l){this.emitPlanCompleted(l.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await re.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(s){console.log(`Delete plan execution record failed: ${s.message}`)}},5e3)}catch(s){console.log(`Delete plan execution record failed: ${s.message}`)}l.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(l.rootPlanId??""))}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const l=await this.getPlanDetails(this.state.activePlanId);if(!l){console.warn("[PlanExecutionManager] No details received from API");return}if(l.rootPlanId&&this.setCachedPlanRecord(l.rootPlanId,l),!l.steps||l.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(l.rootPlanId??""),this.handlePlanCompletion(l);return}this.emitPlanUpdate(l.rootPlanId??""),l.completed&&this.handlePlanCompletion(l)}catch(l){console.error("[PlanExecutionManager] Failed to poll plan status:",l)}finally{this.state.isPolling=!1}}}async getPlanDetails(l){try{const s=await Re.getDetails(l);return s!=null&&s.rootPlanId&&(this.planExecutionCache.set(s.rootPlanId,s),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${s.rootPlanId}`)),s}catch(s){return console.error("[PlanExecutionManager] Failed to get plan details:",s),null}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(l){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(l)}emitDialogRoundStart(l){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(l)}emitPlanUpdate(l){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(l)}emitPlanCompleted(l){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(l)}};ce(he,"instance",null);let Ie=he;const Z=Ie.getInstance(),gn={class:"right-panel"},vn={class:"preview-header"},mn={class:"preview-tabs"},fn={class:"tab-button active"},Pn={class:"preview-content"},_n={class:"step-details"},bn={key:0,class:"step-info-fixed"},Sn={key:0,class:"agent-info"},kn={class:"info-item"},Cn={class:"label"},$n={class:"value"},En={class:"info-item"},yn={class:"label"},wn={class:"value"},xn={class:"info-item"},In={class:"label"},Tn={class:"value"},Rn={class:"info-item"},Dn={class:"label"},An={class:"value"},Mn={class:"info-item"},Ln={class:"label"},Un={class:"execution-status"},Nn={class:"status-item"},On={class:"status-text"},qn={key:0},Fn={key:0,class:"think-act-steps"},Vn={class:"steps-container"},Bn={class:"step-header"},jn={class:"step-number"},Wn={class:"think-section"},Jn={class:"think-content"},zn={class:"input"},Hn={class:"label"},Gn={class:"output"},Xn={class:"label"},Kn={key:0,class:"action-section"},Qn={class:"action-content"},Yn={class:"tool-info"},Zn={class:"label"},es={class:"value"},ts={class:"input"},ns={class:"label"},ss={class:"output"},os={class:"label"},as={key:0,class:"sub-plan-section"},ls={class:"sub-plan-content"},is={class:"sub-plan-header"},cs={class:"sub-plan-info"},rs={class:"value"},us={key:0,class:"sub-plan-info"},ds={class:"value"},ps={class:"sub-plan-status"},hs={class:"status-text"},gs={key:0,class:"no-steps-message"},vs={key:1,class:"no-execution-message"},ms={class:"step-basic-info"},fs={class:"info-item"},Ps={class:"label"},_s={class:"value"},bs={key:0,class:"info-item"},Ss={class:"value"},ks={class:"info-item"},Cs={class:"no-execution-hint"},$s={key:2,class:"execution-indicator"},Es={class:"execution-text"},ys={key:1,class:"no-selection"},ws=["title"],xs=be({__name:"index",setup(j,{expose:l}){const{t:s}=Se(),r=M(),o=M(),p=M(),C=M(null),b=M(!1),x=M(!0),I=M(!0),z=le(()=>p.value?p.value.completed?s("rightPanel.status.completed"):p.value.current?s("rightPanel.status.executing"):s("rightPanel.status.waiting"):""),X=g=>{var U;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${g}`),p.value&&C.value){const A=C.value.rootPlanId??o.value;if(A&&A!==g){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${A}, Requested: ${g}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${g}`);const P=Z.getCachedPlanRecord(g);if(!P){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${g}`);return}if(P.steps&&P.steps.length>0){const A=P.steps.length,k=(P.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${k} / ${A}`)}if(p.value&&o.value&&(o.value===g||((U=C.value)==null?void 0:U.rootPlanId)===g)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${g}`),C.value)){const k=C.value,L=D(k.planId,k.rootPlanId,k.subPlanId);L?(Y(L,k.stepIndex,k.planId,k.isSubPlan),H()):console.warn("[RightPanel] Could not find plan record for refresh:",k)}},_=(g,P,U,A,k)=>{console.log("[RightPanel] Step selected:",{planId:g,stepIndex:P,rootPlanId:U,subPlanId:A,subStepIndex:k});const L=!!(U&&A&&k!==void 0);C.value={planId:g,stepIndex:P,isSubPlan:L,...L&&{rootPlanId:U,subPlanId:A,subStepIndex:k}};const Q=D(g,U,A);if(!Q){console.warn("[RightPanel] Plan data not found:",{planId:g,rootPlanId:U,subPlanId:A}),p.value=null,C.value=null;return}Y(Q,P,g,L)},D=(g,P,U)=>{var L;if(!P||!U)return Z.getCachedPlanRecord(g)??null;const A=Z.getCachedPlanRecord(g);if(A)return A;const k=Z.getCachedPlanRecord(P);if(!(k!=null&&k.agentExecutionSequence))return null;for(const Q of k.agentExecutionSequence)if(Q.thinkActSteps){for(const ee of Q.thinkActSteps)if(((L=ee.subPlanExecutionRecord)==null?void 0:L.currentPlanId)===U)return ee.subPlanExecutionRecord}return null},Y=(g,P,U,A)=>{var f,S,u,E,t;if(!g.steps||P>=g.steps.length){p.value=null,C.value=null,console.warn("[RightPanel] Invalid step data:",{planId:U,stepIndex:P,hasSteps:!!g.steps,stepsLength:(f=g.steps)==null?void 0:f.length,message:"Invalid step index"});return}o.value=U;const k=g.steps[P],L=(S=g.agentExecutionSequence)==null?void 0:S[P];console.log("[RightPanel] Step data details:",{planId:U,stepIndex:P,step:k,hasAgentExecutionSequence:!!g.agentExecutionSequence,agentExecutionSequenceLength:(u=g.agentExecutionSequence)==null?void 0:u.length,agentExecution:L,hasThinkActSteps:!!(L!=null&&L.thinkActSteps),thinkActStepsLength:(E=L==null?void 0:L.thinkActSteps)==null?void 0:E.length,isSubPlan:A});const Q=(L==null?void 0:L.isCompleted)??g.completed??(g.currentStepIndex!==void 0&&P<g.currentStepIndex),ee=!Q&&P===g.currentStepIndex&&!g.completed,pe={planId:U,index:P,title:typeof k=="string"?k:k.title||k.description||k.name||`${A?"子":""}步骤 ${P+1}`,description:typeof k=="string"?k:k.description||k,completed:Q,current:ee};L&&(pe.agentExecution=L),p.value=pe,console.log("[RightPanel] Step details updated:",{planId:U,stepIndex:P,stepTitle:p.value.title,hasAgentExecution:!!L,hasThinkActSteps:(((t=L==null?void 0:L.thinkActSteps)==null?void 0:t.length)??0)>0,completed:Q,current:ee,planCurrentStep:g.currentStepIndex,planCompleted:g.completed,isSubPlan:A}),L!=null&&L.thinkActSteps&&L.thinkActSteps.forEach((n,i)=>{n.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${i}:`,n.subPlanExecutionRecord)}),setTimeout(()=>{T()},100),H()},d=(g,P,U,A)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:g,subPlanId:P,stepIndex:U,subStepIndex:A}),_(P,A,g,P,A)},$=g=>{r.value=g??void 0},T=()=>{if(!r.value)return;const{scrollTop:g,scrollHeight:P,clientHeight:U}=r.value,A=P-g-U<50,k=P>U;x.value=A,b.value=k&&!A,A?I.value=!0:P-g-U>100&&(I.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:g,scrollHeight:P,clientHeight:U,isAtBottom:A,hasScrollableContent:k,showButton:b.value,shouldAutoScroll:I.value})},q=()=>{r.value&&(r.value.scrollTo({top:r.value.scrollHeight,behavior:"smooth"}),ae(()=>{I.value=!0,T()}))},H=()=>{!I.value||!r.value||ae(()=>{r.value&&(r.value.scrollTop=r.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},K=g=>{if(g===null||typeof g>"u"||g==="")return"N/A";try{const P=typeof g=="object"?g:JSON.parse(g);return JSON.stringify(P,null,2)}catch{return String(g)}},ue=()=>{p.value=null,o.value=void 0,I.value=!0,r.value&&r.value.removeEventListener("scroll",T)},de=()=>{const g=()=>{const P=r.value;return P?($(P),P.addEventListener("scroll",T),I.value=!0,T(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};ae(()=>{g()||setTimeout(()=>{g()},100)})};return ke(()=>{console.log("[RightPanel] Component mounted"),ae(()=>{de()})}),Ce(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),C.value=null,ue()}),l({updateDisplayedPlanProgress:X,handleStepSelected:_,handleSubPlanStepSelected:d}),(g,P)=>{var U,A;return v(),m("div",gn,[e("div",vn,[e("div",mn,[e("button",fn,[y(a(w),{icon:"carbon:events"}),te(" "+c(a(s)("rightPanel.stepExecutionDetails")),1)])])]),e("div",Pn,[e("div",_n,[p.value?(v(),m("div",bn,[e("h3",null,c(p.value.title||p.value.description||a(s)("rightPanel.defaultStepTitle",{number:p.value.index+1})),1),p.value.agentExecution?(v(),m("div",Sn,[e("div",kn,[e("span",Cn,c(a(s)("rightPanel.executingAgent"))+":",1),e("span",$n,c(p.value.agentExecution.agentName),1)]),e("div",En,[e("span",yn,c(a(s)("rightPanel.description"))+":",1),e("span",wn,c(p.value.agentExecution.agentDescription||""),1)]),e("div",xn,[e("span",In,c(a(s)("rightPanel.callingModel"))+":",1),e("span",Tn,c(p.value.agentExecution.modelName),1)]),e("div",Rn,[e("span",Dn,c(a(s)("rightPanel.request"))+":",1),e("span",An,c(p.value.agentExecution.agentRequest||""),1)]),e("div",Mn,[e("span",Ln,c(a(s)("rightPanel.executionResult"))+":",1),e("span",{class:oe(["value",{success:p.value.agentExecution.isCompleted}])},c(p.value.agentExecution.result||a(s)("rightPanel.executing")),3)])])):J("",!0),e("div",Un,[e("div",Nn,[p.value.completed?(v(),_e(a(w),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):p.value.current?(v(),_e(a(w),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(v(),_e(a(w),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",On,c(z.value),1)])])])):J("",!0),e("div",{ref_key:"scrollContainer",ref:r,class:"step-details-scroll-container",onScroll:T},[p.value?(v(),m("div",qn,[(U=p.value.agentExecution)!=null&&U.thinkActSteps&&p.value.agentExecution.thinkActSteps.length>0?(v(),m("div",Fn,[e("h4",null,c(a(s)("rightPanel.thinkAndActionSteps")),1),e("div",Vn,[(v(!0),m(ge,null,ve(p.value.agentExecution.thinkActSteps,(k,L)=>(v(),m("div",{key:L,class:"think-act-step"},[e("div",Bn,[e("span",jn,"#"+c(L+1),1),e("span",{class:oe(["step-status",k.status])},c(k.status||a(s)("rightPanel.executing")),3)]),e("div",Wn,[e("h5",null,[y(a(w),{icon:"carbon:thinking"}),te(" "+c(a(s)("rightPanel.thinking")),1)]),e("div",Jn,[e("div",zn,[e("span",Hn,c(a(s)("rightPanel.input"))+":",1),e("pre",null,c(K(k.thinkInput)),1)]),e("div",Gn,[e("span",Xn,c(a(s)("rightPanel.output"))+":",1),e("pre",null,c(K(k.thinkOutput)),1)])])]),k.actionNeeded?(v(),m("div",Kn,[e("h5",null,[y(a(w),{icon:"carbon:play"}),te(" "+c(a(s)("rightPanel.action")),1)]),e("div",Qn,[(v(!0),m(ge,null,ve(k.actToolInfoList,(Q,ee)=>(v(),m("div",{key:ee},[e("div",Yn,[e("span",Zn,c(a(s)("rightPanel.tool"))+":",1),e("span",es,c(Q.name||""),1)]),e("div",ts,[e("span",ns,c(a(s)("rightPanel.toolParameters"))+":",1),e("pre",null,c(K(Q.parameters)),1)]),e("div",ss,[e("span",os,c(a(s)("rightPanel.executionResult"))+":",1),e("pre",null,c(K(Q.result)),1)])]))),128))]),k.subPlanExecutionRecord?(v(),m("div",as,[e("h5",null,[y(a(w),{icon:"carbon:tree-view"}),te(" "+c(a(s)("rightPanel.subPlan")),1)]),e("div",ls,[e("div",is,[e("div",cs,[P[0]||(P[0]=e("span",{class:"label"},"子计划ID:",-1)),e("span",rs,c(k.subPlanExecutionRecord.currentPlanId),1)]),k.subPlanExecutionRecord.title?(v(),m("div",us,[P[1]||(P[1]=e("span",{class:"label"},"标题:",-1)),e("span",ds,c(k.subPlanExecutionRecord.title),1)])):J("",!0),e("div",ps,[k.subPlanExecutionRecord.completed?(v(),_e(a(w),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(v(),_e(a(w),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",hs,c(k.subPlanExecutionRecord.completed?"已完成":"执行中"),1)])])])])):J("",!0)])):J("",!0)]))),128))]),p.value.agentExecution&&!((A=p.value.agentExecution.thinkActSteps)!=null&&A.length)?(v(),m("div",gs,[e("p",null,c(a(s)("rightPanel.noStepDetails")),1)])):p.value.agentExecution?J("",!0):(v(),m("div",vs,[y(a(w),{icon:"carbon:information",class:"info-icon"}),e("h4",null,c(a(s)("rightPanel.stepInfo")),1),e("div",ms,[e("div",fs,[e("span",Ps,c(a(s)("rightPanel.stepName"))+":",1),e("span",_s,c(p.value.title||p.value.description||`步骤 ${p.value.index+1}`),1)]),p.value.description?(v(),m("div",bs,[P[2]||(P[2]=e("span",{class:"label"},"描述:",-1)),e("span",Ss,c(p.value.description),1)])):J("",!0),e("div",ks,[P[3]||(P[3]=e("span",{class:"label"},"状态:",-1)),e("span",{class:oe(["value",{"status-completed":p.value.completed,"status-current":p.value.current,"status-pending":!p.value.completed&&!p.value.current}])},c(p.value.completed?"已完成":p.value.current?"执行中":"待执行"),3)])]),e("p",Cs,c(a(s)("rightPanel.noExecutionInfo")),1)])),p.value.current&&!p.value.completed?(v(),m("div",$s,[P[4]||(P[4]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",Es,[y(a(w),{icon:"carbon:in-progress",class:"rotating-icon"}),te(" "+c(a(s)("rightPanel.stepExecuting")),1)])])):J("",!0)])):(v(),m("div",ys,[y(a(w),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,c(a(s)("rightPanel.noStepSelected")),1),e("p",null,c(a(s)("rightPanel.selectStepHint")),1)]))])):J("",!0),y(ut,{name:"scroll-button"},{default:dt(()=>[b.value?(v(),m("button",{key:0,onClick:q,class:"scroll-to-bottom-btn",title:a(s)("rightPanel.scrollToBottom")},[y(a(w),{icon:"carbon:chevron-down"})],8,ws)):J("",!0)]),_:1})],544)])])])}}}),Is=$e(xs,[["__scopeId","data-v-eca1d134"]]);function Ts(){const j=Z,l=le(()=>j.getActivePlanId()),s=le(()=>j.getState()),r=le(()=>s.value.isPolling),o=le(()=>!!l.value),p=(I,z)=>{j.initiatePlanExecutionSequence(I,z)},C=()=>{j.stopPolling()},b=()=>{j.startPolling()},x=()=>{j.cleanup()};return Ce(()=>{x()}),{activePlanId:l,state:s,isPolling:r,hasActivePlan:o,startExecution:p,stopPolling:C,startPolling:b,cleanup:x}}const Rs={class:"chat-container"},Ds={class:"message-content"},As={key:0,class:"user-message"},Ms={key:1,class:"assistant-message"},Ls={key:0,class:"thinking-section"},Us={class:"thinking-header"},Ns={class:"thinking-avatar"},Os={class:"thinking-label"},qs={class:"thinking-content"},Fs={key:0,class:"thinking"},Vs={key:1,class:"progress"},Bs={class:"progress-bar"},js={class:"progress-text"},Ws={key:2,class:"steps-container"},Js={class:"steps-title"},zs=["onClick"],Hs={class:"section-header"},Gs={class:"step-icon"},Xs={class:"step-title"},Ks={key:0,class:"step-status current"},Qs={key:1,class:"step-status completed"},Ys={key:2,class:"step-status pending"},Zs={key:0,class:"action-info"},eo={class:"action-description"},to={class:"action-icon"},no={key:0,class:"tool-params"},so={class:"param-label"},oo={class:"param-content"},ao={key:1,class:"think-details"},lo={class:"think-header"},io={class:"think-label"},co={class:"think-output"},ro={class:"think-content"},uo={key:1,class:"sub-plan-steps"},po={class:"sub-plan-header"},ho={class:"sub-plan-step-list"},go=["onClick"],vo={class:"sub-step-indicator"},mo={class:"sub-step-icon"},fo={class:"sub-step-number"},Po={class:"sub-step-content"},_o={class:"sub-step-title"},bo={key:2,class:"user-input-form-container"},So={class:"user-input-message"},ko={key:0,class:"form-description"},Co=["onSubmit"],$o=["for"],Eo=["id","name","onUpdate:modelValue"],yo={key:1,class:"form-group"},wo={for:"form-input-genericInput"},xo=["onUpdate:modelValue"],Io={type:"submit",class:"submit-user-input-btn"},To={key:3,class:"default-processing"},Ro={class:"processing-indicator"},Do={class:"response-section"},Ao={class:"response-header"},Mo={class:"response-avatar"},Lo={class:"response-name"},Uo={class:"response-content"},No={key:0,class:"final-response"},Oo=["innerHTML"],qo={key:1,class:"response-placeholder"},Fo={class:"typing-indicator"},Vo={class:"typing-text"},Bo={key:0,class:"message assistant"},jo={class:"message-content"},Wo={class:"assistant-message"},Jo={class:"thinking-section"},zo={class:"thinking-header"},Ho={class:"thinking-avatar"},Go={class:"thinking-label"},Xo={class:"thinking-content"},Ko={class:"default-processing"},Qo={class:"processing-indicator"},Yo={class:"response-section"},Zo={class:"response-header"},ea={class:"response-avatar"},ta={class:"response-name"},na={class:"response-content"},sa={class:"response-placeholder"},oa={class:"typing-indicator"},aa={class:"typing-text"},la=["title"],ia=be({__name:"index",props:{mode:{default:"plan"},initialPrompt:{}},emits:["step-selected","sub-plan-step-selected"],setup(j,{expose:l,emit:s}){const r=j,o=s,{t:p}=Se(),C=Ts(),b=M(),x=M(!1),I=M([]),z=M(),X=M(!1),_=at({}),D=(t,n,i)=>{const h={id:Date.now().toString(),type:t,content:n,timestamp:new Date,...i};return t==="assistant"&&!h.thinking&&!h.content&&(h.thinking=p("chat.thinking")),I.value.push(h),h},Y=t=>{const n=I.value[I.value.length-1];n.type==="assistant"&&Object.assign(n,t)},d=async t=>{try{x.value=!0;const n=D("assistant","",{thinking:"正在理解您的请求并准备回复..."}),i=await Te.sendMessage(t);if(i.planId)console.log("[ChatComponent] Received planId from direct execution:",i.planId),n.planExecution||(n.planExecution={}),n.planExecution.currentPlanId=i.planId,Z.handlePlanExecutionRequested(i.planId,t),delete n.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete n.thinking;const h=$(i,t);n.content=h}}catch(n){console.error("Direct mode error:",n),Y({content:T(n)})}finally{x.value=!1}},$=(t,n)=>t.result??t.message??t.content??"",T=t=>{const n=(t==null?void 0:t.message)??(t==null?void 0:t.toString())??"未知错误";return n.includes("网络")||n.includes("network")||n.includes("timeout")?"抱歉，似乎网络连接有些问题。请检查您的网络连接后再试一次，或者稍等几分钟再重新提问。":n.includes("认证")||n.includes("权限")||n.includes("auth")?"抱歉，访问权限出现了问题。这可能是系统配置的问题，请联系管理员或稍后再试。":n.includes("格式")||n.includes("参数")||n.includes("invalid")?"抱歉，您的请求格式可能有些问题。能否请您重新表述一下您的需求？我会尽力理解并帮助您。":`抱歉，处理您的请求时遇到了一些问题（${n}）。请稍后再试，或者换个方式表达您的需求，我会尽力帮助您的。`},q=(t=!1)=>{ae(()=>{if(b.value){const n=b.value;(t||n.scrollHeight-n.scrollTop-n.clientHeight<150)&&n.scrollTo({top:n.scrollHeight,behavior:t?"auto":"smooth"})}})},H=()=>{q(!0),X.value=!1},K=()=>{if(b.value){const t=b.value,n=t.scrollHeight-t.scrollTop-t.clientHeight<150;X.value=!n&&I.value.length>0}},ue=()=>{b.value&&b.value.addEventListener("scroll",K)},de=()=>{b.value&&b.value.removeEventListener("scroll",K)},g=t=>{D("user",t),r.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",t):d(t)},P=(t,n)=>{var i,h;if(!((i=t.planExecution)!=null&&i.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:t.planExecution.currentPlanId,stepIndex:n,stepTitle:(h=t.planExecution.steps)==null?void 0:h[n]}),o("step-selected",t.planExecution.currentPlanId,n)},U=(t,n)=>{var i;try{const h=(i=t.planExecution)==null?void 0:i.agentExecutionSequence;if(!(h!=null&&h.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const O=h[n];if(!O)return console.log(`[ChatComponent] No agentExecution found for step ${n}`),[];if(!O.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${n}`),[];for(const W of O.thinkActSteps)if(W.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${n}:`,W.subPlanExecutionRecord),(W.subPlanExecutionRecord.steps??[]).map(V=>typeof V=="string"?V:typeof V=="object"&&V!==null&&(V.title||V.description)||"子步骤");return[]}catch(h){return console.warn("[ChatComponent] Error getting sub-plan steps:",h),[]}},A=(t,n,i)=>{var h;try{const O=(h=t.planExecution)==null?void 0:h.agentExecutionSequence;if(!(O!=null&&O.length))return"pending";const W=O[n];if(!W||!W.thinkActSteps)return"pending";let G=null;for(const F of W.thinkActSteps)if(F.subPlanExecutionRecord){G=F.subPlanExecutionRecord;break}if(!G)return"pending";const V=G.currentStepIndex;return G.completed?"completed":V==null?i===0?"current":"pending":i<V?"completed":i===V?"current":"pending"}catch(O){return console.warn("[ChatComponent] Error getting sub-plan step status:",O),"pending"}},k=(t,n,i)=>{var h,O;try{const W=(h=t.planExecution)==null?void 0:h.agentExecutionSequence;if(!(W!=null&&W.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const G=W[n];if(!G){console.warn("[ChatComponent] No agentExecution found for step",n);return}if(!G.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",n);return}let V=null;for(const F of G.thinkActSteps)if(F.subPlanExecutionRecord){V=F.subPlanExecutionRecord;break}if(!(V!=null&&V.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}o("sub-plan-step-selected",((O=t.planExecution)==null?void 0:O.currentPlanId)??"",V.currentPlanId,n,i)}catch(W){console.error("[ChatComponent] Error handling sub-plan step click:",W)}},L=(t,n)=>{var h,O,W,G;if(!((h=t.planExecution)!=null&&h.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",t.planExecution.steps.length,"execution sequence:",((O=n.agentExecutionSequence)==null?void 0:O.length)??0);const i=new Array(t.planExecution.steps.length).fill(null);if((W=n.agentExecutionSequence)!=null&&W.length){const V=Math.min(n.agentExecutionSequence.length,t.planExecution.steps.length);for(let F=0;F<V;F++){const R=n.agentExecutionSequence[F];if(((G=R==null?void 0:R.thinkActSteps)==null?void 0:G.length)>0){const N=R.thinkActSteps[R.thinkActSteps.length-1];N!=null&&N.actionDescription&&(N!=null&&N.toolParameters)?(i[F]={actionDescription:N.actionDescription,toolParameters:typeof N.toolParameters=="string"?N.toolParameters:JSON.stringify(N.toolParameters,null,2),thinkInput:N.thinkInput??"",thinkOutput:N.thinkOutput??"",status:F<n.currentStepIndex?"completed":F===n.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${F} action set: ${i[F].actionDescription}`)):N?(i[F]={actionDescription:"思考中",toolParameters:"等待决策",thinkInput:N.thinkInput??"",thinkOutput:N.thinkOutput??"",status:F===n.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${F} is thinking`)):(i[F]={actionDescription:"执行完成",toolParameters:"无工具",thinkInput:"",thinkOutput:"",status:"completed"},console.log(`[ChatComponent] Step ${F} execution completed`))}else i[F]={actionDescription:F<n.currentStepIndex?"已完成":"等待中",toolParameters:"无工具参数",thinkInput:"",thinkOutput:"",status:F<n.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] 步骤 ${F} 无执行细节, 状态设为: ${i[F].status}`)}}else console.log("[ChatComponent] 没有执行序列数据");t.stepActions=[...i],console.log("[ChatComponent] 步骤动作更新完成:",JSON.stringify(i.map(V=>V==null?void 0:V.actionDescription))),ae(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},Q=t=>{console.log("[ChatComponent] Starting dialog round with planId:",t),t&&(I.value.findIndex(i=>{var h;return((h=i.planExecution)==null?void 0:h.currentPlanId)===t&&i.type==="assistant"})===-1?(D("assistant","",{planExecution:{currentPlanId:t},thinking:"正在准备执行计划..."}),console.log("[ChatComponent] Created new assistant message for planId:",t)):console.log("[ChatComponent] Found existing assistant message for planId:",t))},ee=t=>{var W,G,V,F;console.log("[ChatComponent] Processing plan update with rootPlanId:",t);const n=Z.getCachedPlanRecord(t);if(!n){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",t);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",n),console.log("[ChatComponent] Plan steps:",n.steps),console.log("[ChatComponent] Plan completed:",n.completed),!n.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const i=I.value.findIndex(R=>{var N;return((N=R.planExecution)==null?void 0:N.currentPlanId)===n.currentPlanId&&R.type==="assistant"});let h;if(i!==-1)h=I.value[i],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",n.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",n.currentPlanId),console.log("[ChatComponent] Current messages:",I.value.map(N=>{var ne;return{type:N.type,planId:(ne=N.planExecution)==null?void 0:ne.currentPlanId,content:N.content.substring(0,50)}}));let R=-1;for(let N=I.value.length-1;N>=0;N--)if(I.value[N].type==="assistant"){R=N;break}if(R!==-1)h=I.value[R],h.planExecution||(h.planExecution={}),h.planExecution.currentPlanId=n.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",n.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(h.planExecution||(h.planExecution={}),h.planExecution=JSON.parse(JSON.stringify(n)),!n.steps||n.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),n.completed){delete h.thinking;const R=n.summary??n.result??n.message??"处理完成";h.content=pe(R),console.log("[ChatComponent] Set simple response content:",h.content)}else n.title&&(h.thinking=`正在执行: ${n.title}`);return}delete h.thinking;const O=n.steps.map(R=>typeof R=="string"?R:typeof R=="object"&&R!==null&&(R.title||R.description)||"步骤");if(h.planExecution&&(h.planExecution.steps=O),n.agentExecutionSequence&&n.agentExecutionSequence.length>0){console.log("[ChatComponent] 发现执行序列数据，数量:",n.agentExecutionSequence.length),L(h,n);const R=n.currentStepIndex??0;if(R>=0&&R<n.agentExecutionSequence.length){const ne=n.agentExecutionSequence[R].thinkActSteps;if(ne&&ne.length>0){const me=ne[ne.length-1];if(me.thinkOutput){const Ee=me.thinkOutput.length>150?me.thinkOutput.substring(0,150)+"...":me.thinkOutput;h.thinking=`正在思考: ${Ee}`}}}}else if(h.planExecution){const R=h.planExecution.currentStepIndex??0,N=(W=h.planExecution.steps)==null?void 0:W[R],ne=typeof N=="string"?N:"";h.thinking=`正在执行: ${ne}`}if(n.userInputWaitState&&h.planExecution?(console.log("[ChatComponent] 需要用户输入:",n.userInputWaitState),h.planExecution.userInputWaitState||(h.planExecution.userInputWaitState={}),h.planExecution.userInputWaitState={message:n.userInputWaitState.message??"",formDescription:n.userInputWaitState.formDescription??"",formInputs:((G=n.userInputWaitState.formInputs)==null?void 0:G.map(R=>({label:R.label,value:R.value||""})))??[]},_[V=h.id]??(_[V]={}),h.thinking="等待用户输入..."):(F=h.planExecution)!=null&&F.userInputWaitState&&delete h.planExecution.userInputWaitState,n.completed??n.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete h.thinking;let R="";n.summary?R=n.summary:n.result?R=n.result:R="任务已完成",h.content=f(R),console.log("[ChatComponent] Updated completed message:",h.content)}ae(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},pe=t=>t?t.includes("我")||t.includes("您")||t.includes("您好")||t.includes("可以")?t:t.length<10?`${t}！还有什么需要我帮助的吗？`:t.length<50?`好的，${t}。如果您还有其他问题，请随时告诉我。`:`${t}

希望这个回答对您有帮助！还有什么我可以为您做的吗？`:"我明白了，还有什么我可以帮您的吗？",f=t=>t?`${t}`:"任务已完成！还有什么我可以帮您的吗？",S=t=>{if(console.log("[ChatComponent] Plan completed:",t),t!=null&&t.planId){const n=I.value.findIndex(i=>{var h;return((h=i.planExecution)==null?void 0:h.currentPlanId)===t.planId});if(n!==-1){const i=I.value[n];delete i.thinking;let O=t.summary??t.result??"任务已完成";!O.includes("我")&&!O.includes("您")&&(O.includes("成功")||O.includes("完成")?O=`很好！${O}。如果您还有其他需要帮助的地方，请随时告诉我。`:O=`我已经完成了您的请求：${O}`),i.content=O,console.log("[ChatComponent] Updated completed message:",i.content)}else console.warn("[ChatComponent] No message found for completed planId:",t.planId)}},u=t=>{if(!t)return"";let n=t.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return n=n.replace(/(<br><br>)/g,"</p><p>"),n.includes("</p><p>")&&(n=`<p>${n}</p>`),n},E=async t=>{var n;if(!((n=t.planExecution)!=null&&n.currentPlanId)||!t.planExecution.userInputWaitState){console.error("[ChatComponent] 缺少planExecution.currentPlanId或userInputWaitState");return}try{const i={},h=t.planExecution.userInputWaitState.formInputs;h&&h.length>0?Object.entries(_[t.id]).forEach(([W,G])=>{var R;const V=parseInt(W,10),F=((R=h[V])==null?void 0:R.label)||`input_${W}`;i[F]=G}):i.genericInput=t.genericInput??"",console.log("[ChatComponent] 提交用户输入:",i);const O=await Re.submitFormInput(t.planExecution.currentPlanId,i);delete t.planExecution.userInputWaitState,delete t.genericInput,delete _[t.id],C.startPolling(),console.log("[ChatComponent] 用户输入提交成功:",O)}catch(i){console.error("[ChatComponent] 用户输入提交失败:",i),alert(`提交失败: ${(i==null?void 0:i.message)||"未知错误"}`)}};return we(()=>r.initialPrompt,(t,n)=>{console.log("[ChatComponent] initialPrompt changed from:",n,"to:",t),t&&typeof t=="string"&&t.trim()&&t!==n&&(console.log("[ChatComponent] Processing changed initial prompt:",t),ae(()=>{g(t)}))},{immediate:!1}),ke(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),Z.setEventCallbacks({onPlanUpdate:ee,onPlanCompleted:S,onDialogRoundStart:Q,onChatInputUpdateState:t=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",t)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")}}),ae(()=>{ue()}),r.initialPrompt&&typeof r.initialPrompt=="string"&&r.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",r.initialPrompt),ae(()=>{g(r.initialPrompt)}))}),Ce(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),de(),z.value&&clearInterval(z.value),C.cleanup(),Object.keys(_).forEach(t=>delete _[t])}),l({handleSendMessage:g,handlePlanUpdate:ee,handlePlanCompleted:S,handleDialogRoundStart:Q,addMessage:D}),(t,n)=>(v(),m("div",Rs,[e("div",{class:"messages",ref_key:"messagesRef",ref:b},[(v(!0),m(ge,null,ve(I.value,i=>{var h,O,W,G,V,F,R,N,ne;return v(),m("div",{key:i.id,class:oe(["message",{user:i.type==="user",assistant:i.type==="assistant"}])},[e("div",Ds,[i.type==="user"?(v(),m("div",As,c(i.content),1)):(v(),m("div",Ms,[i.thinking||((h=i.planExecution)==null?void 0:h.progress)!==void 0||(((W=(O=i.planExecution)==null?void 0:O.steps)==null?void 0:W.length)??0)>0?(v(),m("div",Ls,[e("div",Us,[e("div",Ns,[y(a(w),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Os,c(t.$t("chat.thinkingLabel")),1)]),e("div",qs,[i.thinking?(v(),m("div",Fs,[y(a(w),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,c(i.thinking),1)])):J("",!0),((G=i.planExecution)==null?void 0:G.progress)!==void 0?(v(),m("div",Vs,[e("div",Bs,[e("div",{class:"progress-fill",style:xe({width:i.planExecution.progress+"%"})},null,4)]),e("span",js,c(i.planExecution.progressText??t.$t("chat.processing")+"..."),1)])):J("",!0),(((F=(V=i.planExecution)==null?void 0:V.steps)==null?void 0:F.length)??0)>0?(v(),m("div",Ws,[e("h4",Js,c(t.$t("chat.stepExecutionDetails")),1),(v(!0),m(ge,null,ve((R=i.planExecution)==null?void 0:R.steps,(me,B)=>{var Ee,De,Ae,Me,Le,Ue,Ne,Oe,qe,Fe,Ve,Be,je,We,Je,ze,He,Ge,Xe,Ke,Qe,Ye,Ze,et,tt,nt,st;return v(),m("div",{key:B,class:oe(["ai-section",{current:B===(((Ee=i.planExecution)==null?void 0:Ee.currentStepIndex)??-1),completed:B<(((De=i.planExecution)==null?void 0:De.currentStepIndex)??0),pending:B>(((Ae=i.planExecution)==null?void 0:Ae.currentStepIndex)??0)}]),onClick:ye(ie=>P(i,B),["stop"])},[e("div",Hs,[e("span",Gs,c(B<(((Me=i.planExecution)==null?void 0:Me.currentStepIndex)??0)?"✓":B===(((Le=i.planExecution)==null?void 0:Le.currentStepIndex)??-1)?"▶":"○"),1),e("span",Xs,c(me||`${t.$t("chat.step")} ${B+1}`),1),B===(((Ue=i.planExecution)==null?void 0:Ue.currentStepIndex)??-1)?(v(),m("span",Ks,c(t.$t("chat.status.executing")),1)):B<(((Ne=i.planExecution)==null?void 0:Ne.currentStepIndex)??0)?(v(),m("span",Qs,c(t.$t("chat.status.completed")),1)):(v(),m("span",Ys,c(t.$t("chat.status.pending")),1))]),i.stepActions&&i.stepActions[B]?(v(),m("div",Zs,[e("div",eo,[e("span",to,c(((Oe=i.stepActions[B])==null?void 0:Oe.status)==="current"?"🔄":((qe=i.stepActions[B])==null?void 0:qe.status)==="completed"?"✓":"⏳"),1),e("strong",null,c((Fe=i.stepActions[B])==null?void 0:Fe.actionDescription),1)]),(Ve=i.stepActions[B])!=null&&Ve.toolParameters?(v(),m("div",no,[n[0]||(n[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",so,c(t.$t("common.parameters"))+":",1),e("pre",oo,c((Be=i.stepActions[B])==null?void 0:Be.toolParameters),1)])):J("",!0),(je=i.stepActions[B])!=null&&je.thinkOutput?(v(),m("div",ao,[e("div",lo,[n[1]||(n[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",io,c(t.$t("chat.thinkingOutput"))+":",1)]),e("div",co,[e("pre",ro,c((We=i.stepActions[B])==null?void 0:We.thinkOutput),1)])])):J("",!0)])):J("",!0),((Je=U(i,B))==null?void 0:Je.length)>0?(v(),m("div",uo,[e("div",po,[y(a(w),{icon:"carbon:tree-view",class:"sub-plan-icon"}),n[2]||(n[2]=e("span",{class:"sub-plan-title"},"子执行计划",-1))]),e("div",ho,[(v(!0),m(ge,null,ve(U(i,B),(ie,se)=>(v(),m("div",{key:`sub-${B}-${se}`,class:oe(["sub-plan-step-item",{completed:A(i,B,se)==="completed",current:A(i,B,se)==="current",pending:A(i,B,se)==="pending"}]),onClick:ye(ot=>k(i,B,se),["stop"])},[e("div",vo,[e("span",mo,c(A(i,B,se)==="completed"?"✓":A(i,B,se)==="current"?"▶":"○"),1),e("span",fo,c(se+1),1)]),e("div",Po,[e("span",_o,c(ie),1),n[3]||(n[3]=e("span",{class:"sub-step-badge"},"子步骤",-1))])],10,go))),128))])])):J("",!0),(ze=i.planExecution)!=null&&ze.userInputWaitState&&B===(((He=i.planExecution)==null?void 0:He.currentStepIndex)??-1)?(v(),m("div",bo,[e("p",So,c(((Xe=(Ge=i.planExecution)==null?void 0:Ge.userInputWaitState)==null?void 0:Xe.message)??t.$t("chat.userInput.message")),1),(Qe=(Ke=i.planExecution)==null?void 0:Ke.userInputWaitState)!=null&&Qe.formDescription?(v(),m("p",ko,c((Ze=(Ye=i.planExecution)==null?void 0:Ye.userInputWaitState)==null?void 0:Ze.formDescription),1)):J("",!0),e("form",{onSubmit:ye(ie=>E(i),["prevent"]),class:"user-input-form"},[(tt=(et=i.planExecution)==null?void 0:et.userInputWaitState)!=null&&tt.formInputs&&i.planExecution.userInputWaitState.formInputs.length>0?(v(!0),m(ge,{key:0},ve((st=(nt=i.planExecution)==null?void 0:nt.userInputWaitState)==null?void 0:st.formInputs,(ie,se)=>(v(),m("div",{key:se,class:"form-group"},[e("label",{for:`form-input-${ie.label.replace(/\W+/g,"_")}`},c(ie.label)+": ",9,$o),fe(e("input",{type:"text",id:`form-input-${ie.label.replace(/\W+/g,"_")}`,name:ie.label,"onUpdate:modelValue":ot=>_[i.id][se]=ot,class:"form-input"},null,8,Eo),[[Pe,_[i.id][se]]])]))),128)):(v(),m("div",yo,[e("label",wo,c(t.$t("common.input"))+":",1),fe(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":ie=>i.genericInput=ie,class:"form-input"},null,8,xo),[[Pe,i.genericInput]])])),e("button",Io,c(t.$t("chat.userInput.submit")),1)],40,Co)])):J("",!0)],10,zs)}),128))])):!i.content&&(i.thinking||((N=i.planExecution)==null?void 0:N.progress)!==void 0&&(((ne=i.planExecution)==null?void 0:ne.progress)??0)<100)?(v(),m("div",To,[e("div",Ro,[n[4]||(n[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,c(i.thinking??t.$t("chat.thinkingProcessing")),1)])])):J("",!0)])])):J("",!0),e("div",Do,[e("div",Ao,[e("div",Mo,[y(a(w),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Lo,c(t.$t("chat.botName")),1)]),e("div",Uo,[i.content?(v(),m("div",No,[e("div",{class:"response-text",innerHTML:u(i.content)},null,8,Oo)])):(v(),m("div",qo,[e("div",Fo,[n[5]||(n[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Vo,c(t.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),x.value?(v(),m("div",Bo,[e("div",jo,[e("div",Wo,[e("div",Jo,[e("div",zo,[e("div",Ho,[y(a(w),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Go,c(t.$t("chat.thinkingLabel")),1)]),e("div",Xo,[e("div",Ko,[e("div",Qo,[n[6]||(n[6]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,c(t.$t("chat.thinking")),1)])])])]),e("div",Yo,[e("div",Zo,[e("div",ea,[y(a(w),{icon:"carbon:bot",class:"bot-icon"})]),e("div",ta,c(t.$t("chat.botName")),1)]),e("div",na,[e("div",sa,[e("div",oa,[n[7]||(n[7]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",aa,c(t.$t("chat.thinkingResponse")),1)])])])])])])])):J("",!0)],512),X.value?(v(),m("div",{key:0,class:"scroll-to-bottom-btn",onClick:H,title:t.$t("chat.scrollToBottom")},[y(a(w),{icon:"carbon:chevron-down"})],8,la)):J("",!0)]))}}),ca=$e(ia,[["__scopeId","data-v-4c00158a"]]),ra={class:"input-area"},ua={class:"input-container"},da={class:"attach-btn",title:"附加文件"},pa=["placeholder","disabled"],ha=["title"],ga=["disabled","title"],va=be({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1}},emits:["send","clear","update-state","plan-mode-clicked"],setup(j,{expose:l,emit:s}){const{t:r}=Se(),o=j,p=s,C=M(),b=M(""),x=le(()=>o.placeholder||r("input.placeholder")),I=M(x.value),z=le(()=>!!o.disabled),X=()=>{ae(()=>{C.value&&(C.value.style.height="auto",C.value.style.height=Math.min(C.value.scrollHeight,120)+"px")})},_=q=>{q.key==="Enter"&&!q.shiftKey&&(q.preventDefault(),D())},D=()=>{if(!b.value.trim()||z.value)return;const q=b.value.trim();p("send",q),d()},Y=()=>{p("plan-mode-clicked")},d=()=>{b.value="",X(),p("clear")};return l({clearInput:d,updateState:(q,H)=>{H&&(I.value=q?H:r("input.waiting")),p("update-state",q,H)},getQuery:()=>b.value.trim(),focus:()=>{var q;return(q=C.value)==null?void 0:q.focus()}}),ke(()=>{}),Ce(()=>{}),(q,H)=>(v(),m("div",ra,[e("div",ua,[e("button",da,[y(a(w),{icon:"carbon:attachment"})]),fe(e("textarea",{"onUpdate:modelValue":H[0]||(H[0]=K=>b.value=K),ref_key:"inputRef",ref:C,class:"chat-input",placeholder:I.value,disabled:z.value,onKeydown:_,onInput:X},null,40,pa),[[Pe,b.value]]),e("button",{class:"plan-mode-btn",title:q.$t("input.planMode"),onClick:Y},[y(a(w),{icon:"carbon:document"}),te(" "+c(q.$t("input.planMode")),1)],8,ha),e("button",{class:"send-button",disabled:!b.value.trim()||z.value,onClick:D,title:q.$t("input.send")},[y(a(w),{icon:"carbon:send-alt"}),te(" "+c(q.$t("input.send")),1)],8,ga)])]))}}),ma=$e(va,[["__scopeId","data-v-c8e17afe"]]),fa={class:"direct-page"},Pa={class:"direct-chat"},_a={class:"chat-header"},ba={class:"header-actions"},Sa=["title"],ka={class:"chat-content"},Ca=["title"],$a=be({__name:"index",setup(j){const l=pt(),s=ht(),r=vt(),o=lt(),{t:p}=Se(),C=M(""),b=M(),x=M(),I=M(),z=M(!1),X=M(!1),_=M(null),D=M(50),Y=M(!1),d=M(0),$=M(0);ke(()=>{console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",r.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",r.hasUnprocessedTask()),Z.setEventCallbacks({onPlanUpdate:S=>{console.log("[Direct] Plan update event received for rootPlanId:",S),ue(S)&&(console.log("[Direct] Processing plan update for current rootPlanId:",S),x.value&&typeof x.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",S),x.value.handlePlanUpdate(S)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),b.value&&typeof b.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",S),b.value.updateDisplayedPlanProgress(S)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:S=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",S),!!ue(S)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",S),x.value&&typeof x.value.handlePlanCompleted=="function"){const u=Z.getCachedPlanRecord(S);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",u),x.value.handlePlanCompleted(u??{planId:S})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");_.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:S=>{console.log("[Direct] Dialog round start event received for rootPlanId:",S),_.value=S,console.log("[Direct] Set currentRootPlanId to:",S),x.value&&typeof x.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",S),x.value.handleDialogRoundStart(S)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),g()},onChatInputUpdateState:S=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",S),!ue(S,!0))return;const u=Z.getCachedUIState(S);u&&U(u.enabled,u.placeholder)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),o.loadPlanTemplateList(),r.hasUnprocessedTask()&&r.currentTask?(C.value=r.currentTask.prompt,console.log("[Direct] Setting prompt from store:",C.value),r.markTaskAsProcessed(),console.log("[Direct] Received task from store:",C.value)):(C.value=l.query.prompt||"",console.log("[Direct] Received task from URL:",C.value),console.log("[Direct] No unprocessed task in store"));const f=localStorage.getItem("directPanelWidth");f&&(D.value=parseFloat(f)),console.log("[Direct] Final prompt value:",C.value)}),we(()=>r.currentTask,f=>{console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",f),f&&!f.processed?(C.value=f.prompt,r.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",C.value)):console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),we(()=>C.value,(f,S)=>{console.log("[Direct] prompt value changed from:",S,"to:",f)},{immediate:!1}),Ce(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),_.value=null,Z.cleanup(),document.removeEventListener("mousemove",q),document.removeEventListener("mouseup",H)});const T=f=>{Y.value=!0,d.value=f.clientX,$.value=D.value,document.addEventListener("mousemove",q),document.addEventListener("mouseup",H),document.body.style.cursor="col-resize",document.body.style.userSelect="none",f.preventDefault()},q=f=>{if(!Y.value)return;const S=window.innerWidth,E=(f.clientX-d.value)/S*100;let t=$.value+E;t=Math.max(20,Math.min(80,t)),D.value=t},H=()=>{Y.value=!1,document.removeEventListener("mousemove",q),document.removeEventListener("mouseup",H),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",D.value.toString())},K=()=>{D.value=50,localStorage.setItem("directPanelWidth","50")},ue=(f,S=!1)=>!_.value||f===_.value||S&&(f==="ui-state"||f==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",f,"current:",_.value),!1),de=f=>{console.log("[DirectView] Send message from input:",f),x.value&&typeof x.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",f),x.value.handleSendMessage(f)):console.warn("[DirectView] chatRef.handleSendMessage method not available"),console.log("[DirectView] Delegating message to planExecutionManager:",f),Z.handleUserMessageSendRequested(f)},g=()=>{console.log("[DirectView] Input cleared"),I.value&&typeof I.value.clear=="function"&&I.value.clear()},P=()=>{console.log("[DirectView] Input focused")},U=(f,S)=>{console.log("[DirectView] Input state updated:",f,S),X.value=!f},A=(f,S)=>{console.log("[DirectView] Step selected:",f,S),b.value&&typeof b.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",f,S),b.value.handleStepSelected(f,S)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},k=(f,S,u,E)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:f,subPlanId:S,stepIndex:u,subStepIndex:E}),b.value&&typeof b.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:f,subPlanId:S,stepIndex:u,subStepIndex:E}),b.value.handleSubPlanStepSelected(f,S,u,E)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},L=()=>{console.log("[DirectView] Plan mode button clicked"),o.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",o.isCollapsed)},Q=()=>{s.push("/home")},ee=()=>{s.push("/configs")},pe=async f=>{var S;if(console.log("[DirectView] Plan execution requested:",f),z.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}z.value=!0,x.value&&typeof x.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",f.title),x.value.addMessage("user",f.title)):console.warn("[DirectView] chatRef.addMessage method not available");try{const u=f.planData.planTemplateId||f.planData.planId;if(!u)throw new Error("没有找到计划模板ID");console.log("[Direct] Executing plan with templateId:",u,"params:",f.params),console.log("[Direct] About to call PlanActApiService.executePlan");let E;if((S=f.params)!=null&&S.trim()?(console.log("[Direct] Calling executePlan with params:",f.params.trim()),E=await re.executePlan(u,f.params.trim())):(console.log("[Direct] Calling executePlan without params"),E=await re.executePlan(u)),console.log("[Direct] Plan execution API response:",E),E.planId)console.log("[Direct] Got planId from response:",E.planId,"starting plan execution"),_.value=E.planId,console.log("[Direct] Set currentRootPlanId to:",E.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),Z.handlePlanExecutionRequested(E.planId,f.title);else throw console.error("[Direct] No planId in response:",E),new Error("执行计划失败：未返回有效的计划ID")}catch(u){console.error("[Direct] Plan execution failed:",u),console.error("[Direct] Error details:",{message:u.message,stack:u.stack}),_.value=null,x.value&&typeof x.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),x.value.addMessage("user",f.title),x.value.addMessage("assistant",`执行计划失败: ${u.message||"未知错误"}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`执行计划失败: ${u.message||"未知错误"}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),z.value=!1}};return(f,S)=>(v(),m("div",fa,[e("div",Pa,[y(hn,{onPlanExecutionRequested:pe}),e("div",{class:"left-panel",style:xe({width:D.value+"%"})},[e("div",_a,[e("button",{class:"back-button",onClick:Q},[y(a(w),{icon:"carbon:arrow-left"})]),e("h2",null,c(f.$t("conversation")),1),e("div",ba,[y(gt),e("button",{class:"config-button",onClick:ee,title:f.$t("direct.configuration")},[y(a(w),{icon:"carbon:settings-adjust",width:"20"})],8,Sa)])]),e("div",ka,[y(ca,{ref_key:"chatRef",ref:x,mode:"direct","initial-prompt":C.value||"",onStepSelected:A,onSubPlanStepSelected:k},null,8,["initial-prompt"])]),y(ma,{ref_key:"inputRef",ref:I,disabled:X.value,placeholder:X.value?"等待任务完成...":a(p)("input.placeholder"),onSend:de,onClear:g,onFocus:P,onUpdateState:U,onPlanModeClicked:L},null,8,["disabled","placeholder"])],4),e("div",{class:"panel-resizer",onMousedown:T,onDblclick:K,title:f.$t("direct.panelResizeHint")},S[0]||(S[0]=[e("div",{class:"resizer-line"},null,-1)]),40,Ca),y(Is,{ref_key:"rightPanelRef",ref:b,style:xe({width:100-D.value+"%"})},null,8,["style"])])]))}}),Ta=$e($a,[["__scopeId","data-v-000ff9e7"]]);export{Ta as default};
