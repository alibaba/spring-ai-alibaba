var lt=Object.defineProperty;var it=(G,o,n)=>o in G?lt(G,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):G[o]=n;var re=(G,o,n)=>it(G,typeof o!="symbol"?o+"":o,n);import{d as $e,f as Ie,g as fe,h as ye,c as f,o as p,m as ne,u as s,e,b as O,t as a,i as b,p as Q,F as ge,j as be,q as de,w as pe,v as ve,s as st,r as A,l as ie,x as Ee,a as ue,T as xe,y as De,z as Se,n as Re,A as Ae,B as ct,k as ot,C as rt}from"./index-BZm_5bjR.js";import{I as P,_ as Pe}from"./_plugin-vue_export-helper-BqR8G-pv.js";import{s as m,P as Me,u as at}from"./sidebar-CVx66jkO.js";import{L as ut}from"./index-CfDdnbuE.js";import{u as dt}from"./useToast-Kg1XiWJ3.js";const pt={class:"sidebar-content"},ht={class:"sidebar-content-header"},gt={class:"sidebar-content-title"},vt={class:"tab-switcher"},mt=["disabled"],ft={key:0,class:"tab-content"},bt={class:"new-task-section"},_t={class:"sidebar-content-list"},kt={key:0,class:"loading-state"},$t={key:1,class:"error-state"},Pt={key:2,class:"empty-state"},Ct=["onClick"],St={class:"task-icon"},yt={class:"task-details"},Et={class:"task-title"},wt={class:"task-preview"},It={class:"task-time"},Tt={class:"task-actions"},xt=["title","onClick"],Dt={key:1,class:"tab-content config-tab"},Rt={key:0,class:"config-container"},At={class:"template-info-header"},Mt={class:"template-info"},Nt={class:"template-id"},Ut={class:"config-section"},Lt={class:"section-header"},Vt={class:"generator-content"},qt=["placeholder"],Ft={class:"generator-actions"},Ot=["disabled"],Bt=["disabled"],jt={class:"config-section"},Wt={class:"section-header"},Ht={class:"section-actions"},zt=["disabled","title"],Jt=["disabled","title"],Gt=["disabled"],Xt=["placeholder"],Kt={class:"config-section"},Qt={class:"section-header"},Yt={class:"execution-content"},Zt={class:"params-input-group"},en={class:"params-help-text"},tn={class:"params-input-container"},nn=["placeholder"],sn=["title"],on={class:"api-url-display"},an={class:"api-url-label"},ln={class:"api-url"},cn={class:"api-url-display"},rn={class:"api-url-label"},un=["disabled"],dn=$e({__name:"index",emits:["planExecutionRequested"],setup(G,{expose:o,emit:n}){const{t:u}=Ie(),N=["currentPlanId","userRequest","rootPlanId"],r=fe({get(){try{if(!m.jsonContent)return"";const _={...JSON.parse(m.jsonContent)};return N.forEach(E=>{delete _[E]}),JSON.stringify(_,null,2)}catch{return m.jsonContent}},set(c){try{if(!c.trim()){m.jsonContent="";return}const _=JSON.parse(c);let E={};try{E=JSON.parse(m.jsonContent||"{}")}catch{}const X={..._};N.forEach(Y=>{E[Y]!==void 0&&(X[Y]=E[Y])}),m.jsonContent=JSON.stringify(X)}catch{m.jsonContent=c}}}),D=n,y=async()=>{try{const c=await m.saveTemplate();c!=null&&c.duplicate?alert(u("sidebar.saveCompleted",{message:c.message,versionCount:c.versionCount})):c!=null&&c.saved?alert(u("sidebar.saveSuccess",{message:c.message,versionCount:c.versionCount})):c!=null&&c.message&&alert(u("sidebar.saveStatus",{message:c.message}))}catch(c){console.error("保存计划修改失败:",c),alert(c.message||u("sidebar.saveFailed"))}},K=async()=>{var c;try{await m.generatePlan(),alert(u("sidebar.generateSuccess",{templateId:((c=m.selectedTemplate)==null?void 0:c.id)??u("sidebar.unknown")}))}catch(_){console.error("生成计划失败:",_),alert(u("sidebar.generateFailed")+": "+_.message)}},d=async()=>{try{await m.updatePlan(),alert(u("sidebar.updateSuccess"))}catch(c){console.error("更新计划失败:",c),alert(u("sidebar.updateFailed")+": "+c.message)}},w=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const c=m.preparePlanExecution();if(!c){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] 触发计划执行请求:",c),console.log("[Sidebar] Emitting planExecutionRequested event"),D("planExecutionRequested",c),console.log("[Sidebar] Event emitted")}catch(c){console.error("执行计划出错:",c),alert(u("sidebar.executeFailed")+": "+c.message)}finally{m.finishPlanExecution()}},B=c=>{const E=new Date().getTime()-c.getTime(),X=Math.floor(E/6e4),Y=Math.floor(E/36e5),F=Math.floor(E/864e5);return X<1?u("time.now"):X<60?u("time.minuteAgo",{count:X}):Y<24?u("time.hourAgo",{count:Y}):F<30?u("time.dayAgo",{count:F}):c.toLocaleDateString("zh-CN")},L=(c,_)=>!c||c.length<=_?c:c.substring(0,_)+"...";return ye(()=>{m.loadPlanTemplateList()}),o({loadPlanTemplateList:m.loadPlanTemplateList,toggleSidebar:m.toggleSidebar,currentPlanTemplateId:m.currentPlanTemplateId}),(c,_)=>(p(),f("div",{class:ne(["sidebar-wrapper",{"sidebar-wrapper-collapsed":s(m).isCollapsed}])},[e("div",pt,[e("div",ht,[e("div",gt,a(c.$t("sidebar.title")),1)]),e("div",vt,[e("button",{class:ne(["tab-button",{active:s(m).currentTab==="list"}]),onClick:_[0]||(_[0]=E=>s(m).switchToTab("list"))},[b(s(P),{icon:"carbon:list",width:"16"}),Q(" "+a(c.$t("sidebar.templateList")),1)],2),e("button",{class:ne(["tab-button",{active:s(m).currentTab==="config"}]),onClick:_[1]||(_[1]=E=>s(m).switchToTab("config")),disabled:!s(m).selectedTemplate},[b(s(P),{icon:"carbon:settings",width:"16"}),Q(" "+a(c.$t("sidebar.configuration")),1)],10,mt)]),s(m).currentTab==="list"?(p(),f("div",ft,[e("div",bt,[e("button",{class:"new-task-btn",onClick:_[2]||(_[2]=E=>s(m).createNewTemplate())},[b(s(P),{icon:"carbon:add",width:"16"}),Q(" "+a(c.$t("sidebar.newPlan"))+" ",1),_[11]||(_[11]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",_t,[s(m).isLoading?(p(),f("div",kt,[b(s(P),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,a(c.$t("sidebar.loading")),1)])):s(m).errorMessage?(p(),f("div",$t,[b(s(P),{icon:"carbon:warning",width:"20"}),e("span",null,a(s(m).errorMessage),1),e("button",{onClick:_[3]||(_[3]=(...E)=>s(m).loadPlanTemplateList&&s(m).loadPlanTemplateList(...E)),class:"retry-btn"},a(c.$t("sidebar.retry")),1)])):s(m).planTemplateList.length===0?(p(),f("div",Pt,[b(s(P),{icon:"carbon:document",width:"32"}),e("span",null,a(c.$t("sidebar.noTemplates")),1)])):(p(!0),f(ge,{key:3},be(s(m).sortedTemplates,E=>(p(),f("div",{key:E.id,class:ne(["sidebar-content-list-item",{"sidebar-content-list-item-active":E.id===s(m).currentPlanTemplateId}]),onClick:X=>s(m).selectTemplate(E)},[e("div",St,[b(s(P),{icon:"carbon:document",width:"20"})]),e("div",yt,[e("div",Et,a(E.title||c.$t("sidebar.unnamedPlan")),1),e("div",wt,a(L(E.description||c.$t("sidebar.noDescription"),40)),1)]),e("div",It,a(B(new Date(E.updateTime||E.createTime))),1),e("div",Tt,[e("button",{class:"delete-task-btn",title:c.$t("sidebar.deleteTemplate"),onClick:de(X=>s(m).deleteTemplate(E),["stop"])},[b(s(P),{icon:"carbon:close",width:"16"})],8,xt)])],10,Ct))),128))])])):s(m).currentTab==="config"?(p(),f("div",Dt,[s(m).selectedTemplate?(p(),f("div",Rt,[e("div",At,[e("div",Mt,[e("h3",null,a(s(m).selectedTemplate.title||c.$t("sidebar.unnamedPlan")),1),e("span",Nt,"ID: "+a(s(m).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:_[4]||(_[4]=E=>s(m).switchToTab("list"))},[b(s(P),{icon:"carbon:arrow-left",width:"16"})])]),e("div",Ut,[e("div",Lt,[b(s(P),{icon:"carbon:generate",width:"16"}),e("span",null,a(c.$t("sidebar.planGenerator")),1)]),e("div",Vt,[pe(e("textarea",{"onUpdate:modelValue":_[5]||(_[5]=E=>s(m).generatorPrompt=E),class:"prompt-input",placeholder:c.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,qt),[[ve,s(m).generatorPrompt]]),e("div",Ft,[e("button",{class:"btn btn-primary btn-sm",onClick:K,disabled:s(m).isGenerating||!s(m).generatorPrompt.trim()},[b(s(P),{icon:s(m).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:ne({spinning:s(m).isGenerating})},null,8,["icon","class"]),Q(" "+a(s(m).isGenerating?c.$t("sidebar.generating"):c.$t("sidebar.generatePlan")),1)],8,Ot),e("button",{class:"btn btn-secondary btn-sm",onClick:d,disabled:s(m).isGenerating||!s(m).generatorPrompt.trim()||!s(m).jsonContent.trim()},[b(s(P),{icon:"carbon:edit",width:"14"}),Q(" "+a(c.$t("sidebar.updatePlan")),1)],8,Bt)])])]),e("div",jt,[e("div",Wt,[b(s(P),{icon:"carbon:code",width:"16"}),e("span",null,a(c.$t("sidebar.jsonTemplate")),1),e("div",Ht,[e("button",{class:"btn btn-sm",onClick:_[6]||(_[6]=(...E)=>s(m).rollbackVersion&&s(m).rollbackVersion(...E)),disabled:!s(m).canRollback,title:c.$t("sidebar.rollback")},[b(s(P),{icon:"carbon:undo",width:"14"})],8,zt),e("button",{class:"btn btn-sm",onClick:_[7]||(_[7]=(...E)=>s(m).restoreVersion&&s(m).restoreVersion(...E)),disabled:!s(m).canRestore,title:c.$t("sidebar.restore")},[b(s(P),{icon:"carbon:redo",width:"14"})],8,Jt),e("button",{class:"btn btn-primary btn-sm",onClick:y,disabled:s(m).isGenerating||s(m).isExecuting},[b(s(P),{icon:"carbon:save",width:"14"})],8,Gt)])]),pe(e("textarea",{"onUpdate:modelValue":_[8]||(_[8]=E=>r.value=E),class:"json-editor",placeholder:c.$t("sidebar.jsonPlaceholder"),rows:"12"},null,8,Xt),[[ve,r.value]])]),e("div",Kt,[e("div",Qt,[b(s(P),{icon:"carbon:play",width:"16"}),e("span",null,a(c.$t("sidebar.executionController")),1)]),e("div",Yt,[e("div",Zt,[e("label",null,a(c.$t("sidebar.executionParams")),1),e("div",en,a(c.$t("sidebar.executionParamsHelp")),1),e("div",tn,[pe(e("input",{"onUpdate:modelValue":_[9]||(_[9]=E=>s(m).executionParams=E),class:"params-input",placeholder:c.$t("sidebar.executionParamsPlaceholder")},null,8,nn),[[ve,s(m).executionParams]]),e("button",{class:"clear-params-btn",onClick:_[10]||(_[10]=(...E)=>s(m).clearExecutionParams&&s(m).clearExecutionParams(...E)),title:c.$t("sidebar.clearParams")},[b(s(P),{icon:"carbon:close",width:"12"})],8,sn)])]),e("div",on,[e("span",an,a(c.$t("sidebar.apiUrl"))+":",1),e("code",ln,a(s(m).computedApiUrl),1)]),e("div",cn,[e("span",rn,a(c.$t("sidebar.statusApiUrl"))+":",1),_[12]||(_[12]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:w,disabled:s(m).isExecuting||s(m).isGenerating},[b(s(P),{icon:s(m).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:ne({spinning:s(m).isExecuting})},null,8,["icon","class"]),Q(" "+a(s(m).isExecuting?c.$t("sidebar.executing"):c.$t("sidebar.executePlan")),1)],8,un)])])])):O("",!0)])):O("",!0)])],2))}}),pn=Pe(dn,[["__scopeId","data-v-f6e5726e"]]);class Ue{static async sendMessage(o){const n=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:o})});if(!n.ok)throw new Error(`API request failed: ${n.status}`);return await n.json()}}re(Ue,"BASE_URL","/api/executor");class Le{static async getDetails(o){try{const n=await fetch(`${this.BASE_URL}/details/${o}`);if(n.status===404)return null;if(!n.ok)throw new Error(`Failed to get detailed information: ${n.status}`);const u=await n.text(),N=JSON.parse(u);return N&&typeof N=="object"&&!N.currentPlanId&&(N.currentPlanId=o),N}catch(n){return console.error("[CommonApiService] Failed to get plan details:",n),null}}static async submitFormInput(o,n){const u=await fetch(`${this.BASE_URL}/submit-input/${o}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!u.ok){let r;try{r=await u.json()}catch{r={message:`Failed to submit form input: ${u.status}`}}throw new Error(r.message||`Failed to submit form input: ${u.status}`)}const N=u.headers.get("content-type");return N&&N.indexOf("application/json")!==-1?await u.json():{success:!0}}static async getAllPrompts(){try{const o=await fetch(this.BASE_URL);return await(await this.handleResponse(o)).json()}catch(o){throw console.error("Failed to get Prompt list:",o),o}}static async handleResponse(o){if(!o.ok)try{const n=await o.json();throw new Error(n.message||`API request failed: ${o.status}`)}catch{throw new Error(`API request failed: ${o.status} ${o.statusText}`)}return o}}re(Le,"BASE_URL","/api/executor");const ke=class ke{constructor(){re(this,"POLL_INTERVAL",5e3);re(this,"state",st({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));re(this,"callbacks",{});re(this,"planExecutionCache",new Map);re(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(o){return this.planExecutionCache.get(o)}getCachedUIState(o){return this.uiStateCache.get(o)}setCachedUIState(o,n){this.uiStateCache.set(o,n),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${o}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(o){return this.planExecutionCache.has(o)}setCachedPlanRecord(o,n){this.planExecutionCache.set(o,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${o}`)}clearCachedPlanRecord(o){const n=this.planExecutionCache.delete(o);return n&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${o}`),n}clearAllCachedRecords(){const o=this.planExecutionCache.size,n=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${o}, UI States: ${n}`)}static getInstance(){return ke.instance||(ke.instance=new ke),ke.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(o){this.callbacks={...this.callbacks,...o},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(o))}async handleUserMessageSendRequested(o){if(this.validateAndPrepareUIForNewRequest(o))try{if(await this.sendUserMessageAndSetPlanId(o),this.state.activePlanId)this.initiatePlanExecutionSequence(o,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(n){console.error("[PlanExecutionManager] Failed to send user message:",n);const u=this.state.activePlanId??"error";this.setCachedUIState(u,{enabled:!0}),this.emitChatInputUpdateState(u),this.state.activePlanId=null}}handlePlanExecutionRequested(o,n){console.log("[PlanExecutionManager] Received plan execution request:",{planId:o,query:n}),o?(this.state.activePlanId=o,this.initiatePlanExecutionSequence(n??"执行计划",o)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(o,n){const u=this.getCachedPlanRecord(o);return u!=null&&u.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${o}`),this.handlePlanExecutionRequested(u.currentPlanId,n),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${o}`),!1)}validateAndPrepareUIForNewRequest(o){if(!o)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const n=this.state.activePlanId??"ui-state";return this.setCachedUIState(n,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(n),!0}async sendUserMessageAndSetPlanId(o){try{const n=await Ue.sendMessage(o);if(n!=null&&n.planId)return this.state.activePlanId=n.planId,n;if(n!=null&&n.planTemplateId)return this.state.activePlanId=n.planTemplateId,{...n,planId:n.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",n),new Error("Failed to get valid planId from API response")}catch(n){throw console.error("[PlanExecutionManager] API call failed:",n),n}}initiatePlanExecutionSequence(o,n){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${o}", planId: ${n}`);const u=n;this.emitDialogRoundStart(u),this.startPolling()}handlePlanCompletion(o){this.emitPlanCompleted(o.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await Me.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}},5e3)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}o.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(o.rootPlanId??""))}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const o=await this.getPlanDetails(this.state.activePlanId);if(!o){console.warn("[PlanExecutionManager] No details received from API");return}if(o.rootPlanId&&this.setCachedPlanRecord(o.rootPlanId,o),!o.steps||o.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(o.rootPlanId??""),this.handlePlanCompletion(o);return}this.emitPlanUpdate(o.rootPlanId??""),o.completed&&this.handlePlanCompletion(o)}catch(o){console.error("[PlanExecutionManager] Failed to poll plan status:",o)}finally{this.state.isPolling=!1}}}async getPlanDetails(o){try{const n=await Le.getDetails(o);return n!=null&&n.rootPlanId&&(this.planExecutionCache.set(n.rootPlanId,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${n.rootPlanId}`)),n}catch(n){return console.error("[PlanExecutionManager] Failed to get plan details:",n),null}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(o){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(o)}emitDialogRoundStart(o){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(o)}emitPlanUpdate(o){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(o)}emitPlanCompleted(o){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(o)}};re(ke,"instance",null);let Ne=ke;const oe=Ne.getInstance(),hn={class:"right-panel"},gn={class:"preview-header"},vn={class:"preview-tabs"},mn={class:"tab-button active"},fn={class:"preview-content"},bn={class:"step-details"},_n={key:0,class:"step-info-fixed"},kn={key:0,class:"agent-info"},$n={class:"info-item"},Pn={class:"label"},Cn={class:"value"},Sn={class:"info-item"},yn={class:"label"},En={class:"value"},wn={class:"info-item"},In={class:"label"},Tn={class:"value"},xn={class:"info-item"},Dn={class:"label"},Rn={class:"value"},An={class:"info-item"},Mn={class:"label"},Nn={class:"execution-status"},Un={class:"status-item"},Ln={class:"status-text"},Vn={key:0},qn={key:0,class:"think-act-steps"},Fn={class:"steps-container"},On={class:"step-header"},Bn={class:"step-number"},jn={class:"think-section"},Wn={class:"think-content"},Hn={class:"input"},zn={class:"label"},Jn={class:"output"},Gn={class:"label"},Xn={key:0,class:"action-section"},Kn={class:"action-content"},Qn={class:"tool-info"},Yn={class:"label"},Zn={class:"value"},es={class:"input"},ts={class:"label"},ns={class:"output"},ss={class:"label"},os={key:0,class:"sub-plan-section"},as={class:"sub-plan-content"},ls={class:"sub-plan-header"},is={class:"sub-plan-info"},cs={class:"value"},rs={key:0,class:"sub-plan-info"},us={class:"value"},ds={class:"sub-plan-status"},ps={class:"status-text"},hs={key:0,class:"no-steps-message"},gs={key:1,class:"no-execution-message"},vs={class:"step-basic-info"},ms={class:"info-item"},fs={class:"label"},bs={class:"value"},_s={key:0,class:"info-item"},ks={class:"value"},$s={class:"info-item"},Ps={class:"no-execution-hint"},Cs={key:2,class:"execution-indicator"},Ss={class:"execution-text"},ys={key:1,class:"no-selection"},Es=["title"],ws=$e({__name:"index",setup(G,{expose:o}){const{t:n}=Ie(),u=A(),N=A(),r=A(),D=A(null),y=A(!1),K=A(!0),d=A(!0),w=fe(()=>r.value?r.value.completed?n("rightPanel.status.completed"):r.value.current?n("rightPanel.status.executing"):n("rightPanel.status.waiting"):""),B=$=>{var V;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${$}`),r.value&&D.value){const M=D.value.rootPlanId??N.value;if(M&&M!==$){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${M}, Requested: ${$}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${$}`);const k=oe.getCachedPlanRecord($);if(!k){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${$}`);return}if(k.steps&&k.steps.length>0){const M=k.steps.length,S=(k.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${S} / ${M}`)}if(r.value&&N.value&&(N.value===$||((V=D.value)==null?void 0:V.rootPlanId)===$)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${$}`),D.value)){const S=D.value,x=c(S.planId,S.rootPlanId,S.subPlanId);x?(_(x,S.stepIndex,S.planId,S.isSubPlan),te()):console.warn("[RightPanel] Could not find plan record for refresh:",S)}},L=($,k,V,M,S)=>{console.log("[RightPanel] Step selected:",{planId:$,stepIndex:k,rootPlanId:V,subPlanId:M,subStepIndex:S});const x=!!(V&&M&&S!==void 0);D.value={planId:$,stepIndex:k,isSubPlan:x,...x&&{rootPlanId:V,subPlanId:M,subStepIndex:S}};const g=c($,V,M);if(!g){console.warn("[RightPanel] Plan data not found:",{planId:$,rootPlanId:V,subPlanId:M}),r.value=null,D.value=null;return}_(g,k,$,x)},c=($,k,V)=>{var x;if(!k||!V)return oe.getCachedPlanRecord($)??null;const M=oe.getCachedPlanRecord($);if(M)return M;const S=oe.getCachedPlanRecord(k);if(!(S!=null&&S.agentExecutionSequence))return null;for(const g of S.agentExecutionSequence)if(g.thinkActSteps){for(const I of g.thinkActSteps)if(((x=I.subPlanExecutionRecord)==null?void 0:x.currentPlanId)===V)return I.subPlanExecutionRecord}return null},_=($,k,V,M)=>{var v,C,q,Z,me;if(!$.steps||k>=$.steps.length){r.value=null,D.value=null,console.warn("[RightPanel] Invalid step data:",{planId:V,stepIndex:k,hasSteps:!!$.steps,stepsLength:(v=$.steps)==null?void 0:v.length,message:"Invalid step index"});return}N.value=V;const S=$.steps[k],x=(C=$.agentExecutionSequence)==null?void 0:C[k];console.log("[RightPanel] Step data details:",{planId:V,stepIndex:k,step:S,hasAgentExecutionSequence:!!$.agentExecutionSequence,agentExecutionSequenceLength:(q=$.agentExecutionSequence)==null?void 0:q.length,agentExecution:x,hasThinkActSteps:!!(x!=null&&x.thinkActSteps),thinkActStepsLength:(Z=x==null?void 0:x.thinkActSteps)==null?void 0:Z.length,isSubPlan:M});const g=(x==null?void 0:x.status)==="FINISHED",I=!g&&k===$.currentStepIndex&&!$.completed,T={planId:V,index:k,title:typeof S=="string"?S:S.title||S.description||S.name||`${M?"子":""}步骤 ${k+1}`,description:typeof S=="string"?S:S.description||S,completed:g,current:I};x&&(T.agentExecution=x),r.value=T,console.log("[RightPanel] Step details updated:",{planId:V,stepIndex:k,stepTitle:r.value.title,hasAgentExecution:!!x,hasThinkActSteps:(((me=x==null?void 0:x.thinkActSteps)==null?void 0:me.length)??0)>0,completed:g,current:I,planCurrentStep:$.currentStepIndex,planCompleted:$.completed,isSubPlan:M}),x!=null&&x.thinkActSteps&&x.thinkActSteps.forEach((l,t)=>{l.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${t}:`,l.subPlanExecutionRecord)}),setTimeout(()=>{Y()},100),te()},E=($,k,V,M)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:$,subPlanId:k,stepIndex:V,subStepIndex:M}),L(k,M,$,k,M)},X=$=>{u.value=$??void 0},Y=()=>{if(!u.value)return;const{scrollTop:$,scrollHeight:k,clientHeight:V}=u.value,M=k-$-V<50,S=k>V;K.value=M,y.value=S&&!M,M?d.value=!0:k-$-V>100&&(d.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:$,scrollHeight:k,clientHeight:V,isAtBottom:M,hasScrollableContent:S,showButton:y.value,shouldAutoScroll:d.value})},F=()=>{u.value&&(u.value.scrollTo({top:u.value.scrollHeight,behavior:"smooth"}),ie(()=>{d.value=!0,Y()}))},te=()=>{!d.value||!u.value||ie(()=>{u.value&&(u.value.scrollTop=u.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},se=$=>{if($===null||typeof $>"u"||$==="")return"N/A";try{const k=typeof $=="object"?$:JSON.parse($);return JSON.stringify(k,null,2)}catch{return String($)}},he=()=>{r.value=null,N.value=void 0,d.value=!0,u.value&&u.value.removeEventListener("scroll",Y)},_e=()=>{const $=()=>{const k=u.value;return k?(X(k),k.addEventListener("scroll",Y),d.value=!0,Y(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};ie(()=>{$()||setTimeout(()=>{$()},100)})};return ye(()=>{console.log("[RightPanel] Component mounted"),ie(()=>{_e()})}),Ee(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),D.value=null,he()}),o({updateDisplayedPlanProgress:B,handleStepSelected:L,handleSubPlanStepSelected:E}),($,k)=>{var V,M;return p(),f("div",hn,[e("div",gn,[e("div",vn,[e("button",mn,[b(s(P),{icon:"carbon:events"}),Q(" "+a(s(n)("rightPanel.stepExecutionDetails")),1)])])]),e("div",fn,[e("div",bn,[r.value?(p(),f("div",_n,[e("h3",null,a(r.value.title||r.value.description||s(n)("rightPanel.defaultStepTitle",{number:r.value.index+1})),1),r.value.agentExecution?(p(),f("div",kn,[e("div",$n,[e("span",Pn,a(s(n)("rightPanel.executingAgent"))+":",1),e("span",Cn,a(r.value.agentExecution.agentName),1)]),e("div",Sn,[e("span",yn,a(s(n)("rightPanel.description"))+":",1),e("span",En,a(r.value.agentExecution.agentDescription||""),1)]),e("div",wn,[e("span",In,a(s(n)("rightPanel.callingModel"))+":",1),e("span",Tn,a(r.value.agentExecution.modelName),1)]),e("div",xn,[e("span",Dn,a(s(n)("rightPanel.request"))+":",1),e("span",Rn,a(r.value.agentExecution.agentRequest||""),1)]),e("div",An,[e("span",Mn,a(s(n)("rightPanel.executionResult"))+":",1),e("span",{class:ne(["value",{success:r.value.agentExecution.status==="FINISHED"}])},a(r.value.agentExecution.status||s(n)("rightPanel.executing")),3)])])):O("",!0),e("div",Nn,[e("div",Un,[r.value.completed?(p(),ue(s(P),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):r.value.current?(p(),ue(s(P),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(p(),ue(s(P),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",Ln,a(w.value),1)])])])):O("",!0),e("div",{ref_key:"scrollContainer",ref:u,class:"step-details-scroll-container",onScroll:Y},[r.value?(p(),f("div",Vn,[(V=r.value.agentExecution)!=null&&V.thinkActSteps&&r.value.agentExecution.thinkActSteps.length>0?(p(),f("div",qn,[e("h4",null,a(s(n)("rightPanel.thinkAndActionSteps")),1),e("div",Fn,[(p(!0),f(ge,null,be(r.value.agentExecution.thinkActSteps,(S,x)=>(p(),f("div",{key:x,class:"think-act-step"},[e("div",On,[e("span",Bn,"#"+a(x+1),1),e("span",{class:ne(["step-status",S.status])},a(S.status||s(n)("rightPanel.executing")),3)]),e("div",jn,[e("h5",null,[b(s(P),{icon:"carbon:thinking"}),Q(" "+a(s(n)("rightPanel.thinking")),1)]),e("div",Wn,[e("div",Hn,[e("span",zn,a(s(n)("rightPanel.input"))+":",1),e("pre",null,a(se(S.thinkInput)),1)]),e("div",Jn,[e("span",Gn,a(s(n)("rightPanel.output"))+":",1),e("pre",null,a(se(S.thinkOutput)),1)])])]),S.actionNeeded?(p(),f("div",Xn,[e("h5",null,[b(s(P),{icon:"carbon:play"}),Q(" "+a(s(n)("rightPanel.action")),1)]),e("div",Kn,[(p(!0),f(ge,null,be(S.actToolInfoList,(g,I)=>(p(),f("div",{key:I},[e("div",Qn,[e("span",Yn,a(s(n)("rightPanel.tool"))+":",1),e("span",Zn,a(g.name||""),1)]),e("div",es,[e("span",ts,a(s(n)("rightPanel.toolParameters"))+":",1),e("pre",null,a(se(g.parameters)),1)]),e("div",ns,[e("span",ss,a(s(n)("rightPanel.executionResult"))+":",1),e("pre",null,a(se(g.result)),1)])]))),128))]),S.subPlanExecutionRecord?(p(),f("div",os,[e("h5",null,[b(s(P),{icon:"carbon:tree-view"}),Q(" "+a(s(n)("rightPanel.subPlan")),1)]),e("div",as,[e("div",ls,[e("div",is,[k[0]||(k[0]=e("span",{class:"label"},"子计划ID:",-1)),e("span",cs,a(S.subPlanExecutionRecord.currentPlanId),1)]),S.subPlanExecutionRecord.title?(p(),f("div",rs,[k[1]||(k[1]=e("span",{class:"label"},"标题:",-1)),e("span",us,a(S.subPlanExecutionRecord.title),1)])):O("",!0),e("div",ds,[S.subPlanExecutionRecord.completed?(p(),ue(s(P),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(p(),ue(s(P),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",ps,a(S.subPlanExecutionRecord.completed?"已完成":"执行中"),1)])])])])):O("",!0)])):O("",!0)]))),128))]),r.value.agentExecution&&!((M=r.value.agentExecution.thinkActSteps)!=null&&M.length)?(p(),f("div",hs,[e("p",null,a(s(n)("rightPanel.noStepDetails")),1)])):r.value.agentExecution?O("",!0):(p(),f("div",gs,[b(s(P),{icon:"carbon:information",class:"info-icon"}),e("h4",null,a(s(n)("rightPanel.stepInfo")),1),e("div",vs,[e("div",ms,[e("span",fs,a(s(n)("rightPanel.stepName"))+":",1),e("span",bs,a(r.value.title||r.value.description||`步骤 ${r.value.index+1}`),1)]),r.value.description?(p(),f("div",_s,[k[2]||(k[2]=e("span",{class:"label"},"描述:",-1)),e("span",ks,a(r.value.description),1)])):O("",!0),e("div",$s,[k[3]||(k[3]=e("span",{class:"label"},"状态:",-1)),e("span",{class:ne(["value",{"status-completed":r.value.completed,"status-current":r.value.current,"status-pending":!r.value.completed&&!r.value.current}])},a(r.value.completed?"已完成":r.value.current?"执行中":"待执行"),3)])]),e("p",Ps,a(s(n)("rightPanel.noExecutionInfo")),1)])),r.value.current&&!r.value.completed?(p(),f("div",Cs,[k[4]||(k[4]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",Ss,[b(s(P),{icon:"carbon:in-progress",class:"rotating-icon"}),Q(" "+a(s(n)("rightPanel.stepExecuting")),1)])])):O("",!0)])):(p(),f("div",ys,[b(s(P),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,a(s(n)("rightPanel.noStepSelected")),1),e("p",null,a(s(n)("rightPanel.selectStepHint")),1)]))])):O("",!0),b(xe,{name:"scroll-button"},{default:De(()=>[y.value?(p(),f("button",{key:0,onClick:F,class:"scroll-to-bottom-btn",title:s(n)("rightPanel.scrollToBottom")},[b(s(P),{icon:"carbon:chevron-down"})],8,Es)):O("",!0)]),_:1})],544)])])])}}}),Is=Pe(ws,[["__scopeId","data-v-e90596ce"]]);function Ts(){const G=oe,o=fe(()=>G.getActivePlanId()),n=fe(()=>G.getState()),u=fe(()=>n.value.isPolling),N=fe(()=>!!o.value),r=(d,w)=>{G.initiatePlanExecutionSequence(d,w)},D=()=>{G.stopPolling()},y=()=>{G.startPolling()},K=()=>{G.cleanup()};return Ee(()=>{K()}),{activePlanId:o,state:n,isPolling:u,hasActivePlan:N,startExecution:r,stopPolling:D,startPolling:y,cleanup:K}}const xs={class:"chat-container"},Ds={class:"message-content"},Rs={key:0,class:"user-message"},As={key:1,class:"assistant-message"},Ms={key:0,class:"thinking-section"},Ns={class:"thinking-header"},Us={class:"thinking-avatar"},Ls={class:"thinking-label"},Vs={class:"thinking-content"},qs={key:0,class:"thinking"},Fs={key:1,class:"progress"},Os={class:"progress-bar"},Bs={class:"progress-text"},js={key:2,class:"steps-container"},Ws={class:"steps-title"},Hs=["onClick"],zs={class:"section-header"},Js={class:"step-icon"},Gs={class:"step-title"},Xs={key:0,class:"step-status current"},Ks={key:1,class:"step-status completed"},Qs={key:2,class:"step-status pending"},Ys={key:0,class:"action-info"},Zs={class:"action-description"},eo={class:"action-icon"},to={key:0,class:"tool-params"},no={class:"param-label"},so={class:"param-content"},oo={key:1,class:"think-details"},ao={class:"think-header"},lo={class:"think-label"},io={class:"think-output"},co={class:"think-content"},ro={key:1,class:"sub-plan-steps"},uo={class:"sub-plan-header"},po={class:"sub-plan-step-list"},ho=["onClick"],go={class:"sub-step-indicator"},vo={class:"sub-step-icon"},mo={class:"sub-step-number"},fo={class:"sub-step-content"},bo={class:"sub-step-title"},_o={key:2,class:"user-input-form-container"},ko={class:"user-input-message"},$o={key:0,class:"form-description"},Po=["onSubmit"],Co=["for"],So=["id","name","onUpdate:modelValue"],yo={key:1,class:"form-group"},Eo={for:"form-input-genericInput"},wo=["onUpdate:modelValue"],Io={type:"submit",class:"submit-user-input-btn"},To={key:3,class:"default-processing"},xo={class:"processing-indicator"},Do={class:"response-section"},Ro={class:"response-header"},Ao={class:"response-avatar"},Mo={class:"response-name"},No={class:"response-content"},Uo={key:0,class:"final-response"},Lo=["innerHTML"],Vo={key:1,class:"response-placeholder"},qo={class:"typing-indicator"},Fo={class:"typing-text"},Oo={key:0,class:"message assistant"},Bo={class:"message-content"},jo={class:"assistant-message"},Wo={class:"thinking-section"},Ho={class:"thinking-header"},zo={class:"thinking-avatar"},Jo={class:"thinking-label"},Go={class:"thinking-content"},Xo={class:"default-processing"},Ko={class:"processing-indicator"},Qo={class:"response-section"},Yo={class:"response-header"},Zo={class:"response-avatar"},ea={class:"response-name"},ta={class:"response-content"},na={class:"response-placeholder"},sa={class:"typing-indicator"},oa={class:"typing-text"},aa=["title"],la=$e({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(G,{expose:o,emit:n}){const u=G,N=n,{t:r}=Ie(),D=Ts(),y=A(),K=A(!1),d=A([]),w=A(),B=A(!1),L=st({}),c=(l,t,i)=>{const h={id:Date.now().toString(),type:l,content:t,timestamp:new Date,...i};return l==="assistant"&&!h.thinking&&!h.content&&(h.thinking=r("chat.thinking")),d.value.push(h),h},_=l=>{const t=d.value[d.value.length-1];t.type==="assistant"&&Object.assign(t,l)},E=async l=>{try{K.value=!0;const t=c("assistant","",{thinking:"正在理解您的请求并准备回复..."}),i=await Ue.sendMessage(l);if(i.planId)console.log("[ChatComponent] Received planId from direct execution:",i.planId),t.planExecution||(t.planExecution={}),t.planExecution.currentPlanId=i.planId,oe.handlePlanExecutionRequested(i.planId,l),delete t.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete t.thinking;const h=X(i,l);t.content=h}}catch(t){console.error("Direct mode error:",t),_({content:Y(t)})}finally{K.value=!1}},X=(l,t)=>l.result??l.message??l.content??"",Y=l=>{const t=(l==null?void 0:l.message)??(l==null?void 0:l.toString())??"未知错误";return t.includes("网络")||t.includes("network")||t.includes("timeout")?"抱歉，似乎网络连接有些问题。请检查您的网络连接后再试一次，或者稍等几分钟再重新提问。":t.includes("认证")||t.includes("权限")||t.includes("auth")?"抱歉，访问权限出现了问题。这可能是系统配置的问题，请联系管理员或稍后再试。":t.includes("格式")||t.includes("参数")||t.includes("invalid")?"抱歉，您的请求格式可能有些问题。能否请您重新表述一下您的需求？我会尽力理解并帮助您。":`抱歉，处理您的请求时遇到了一些问题（${t}）。请稍后再试，或者换个方式表达您的需求，我会尽力帮助您的。`},F=(l=!1)=>{ie(()=>{if(y.value){const t=y.value;(l||t.scrollHeight-t.scrollTop-t.clientHeight<150)&&t.scrollTo({top:t.scrollHeight,behavior:l?"auto":"smooth"})}})},te=()=>{F(!0),B.value=!1},se=()=>{if(y.value){const l=y.value,t=l.scrollHeight-l.scrollTop-l.clientHeight<150;B.value=!t&&d.value.length>0}},he=()=>{y.value&&y.value.addEventListener("scroll",se)},_e=()=>{y.value&&y.value.removeEventListener("scroll",se)},$=l=>{c("user",l),u.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",l):E(l)},k=(l,t)=>{var j;const i=((j=l.planExecution)==null?void 0:j.agentExecutionSequence)??[];return t<0||t>=i.length?"IDLE":i[t].status??"IDLE"},V=(l,t)=>{var i,h;if(!((i=l.planExecution)!=null&&i.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:l.planExecution.currentPlanId,stepIndex:t,stepTitle:(h=l.planExecution.steps)==null?void 0:h[t]}),N("step-selected",l.planExecution.currentPlanId,t)},M=(l,t)=>{var i;try{const h=(i=l.planExecution)==null?void 0:i.agentExecutionSequence;if(!(h!=null&&h.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const j=h[t];if(!j)return console.log(`[ChatComponent] No agentExecution found for step ${t}`),[];if(!j.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${t}`),[];for(const U of j.thinkActSteps)if(U.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${t}:`,U.subPlanExecutionRecord),(U.subPlanExecutionRecord.steps??[]).map(W=>typeof W=="string"?W:typeof W=="object"&&W!==null&&(W.title||W.description)||"子步骤");return[]}catch(h){return console.warn("[ChatComponent] Error getting sub-plan steps:",h),[]}},S=(l,t,i)=>{var h;try{const j=(h=l.planExecution)==null?void 0:h.agentExecutionSequence;if(!(j!=null&&j.length))return"pending";const U=j[t];if(!U||!U.thinkActSteps)return"pending";let ee=null;for(const H of U.thinkActSteps)if(H.subPlanExecutionRecord){ee=H.subPlanExecutionRecord;break}if(!ee)return"pending";const W=ee.currentStepIndex;return ee.completed?"completed":W==null?i===0?"current":"pending":i<W?"completed":i===W?"current":"pending"}catch(j){return console.warn("[ChatComponent] Error getting sub-plan step status:",j),"pending"}},x=(l,t,i)=>{var h,j;try{const U=(h=l.planExecution)==null?void 0:h.agentExecutionSequence;if(!(U!=null&&U.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const ee=U[t];if(!ee){console.warn("[ChatComponent] No agentExecution found for step",t);return}if(!ee.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",t);return}let W=null;for(const H of ee.thinkActSteps)if(H.subPlanExecutionRecord){W=H.subPlanExecutionRecord;break}if(!(W!=null&&W.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}N("sub-plan-step-selected",((j=l.planExecution)==null?void 0:j.currentPlanId)??"",W.currentPlanId,t,i)}catch(U){console.error("[ChatComponent] Error handling sub-plan step click:",U)}},g=(l,t)=>{var h,j,U,ee;if(!((h=l.planExecution)!=null&&h.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",l.planExecution.steps.length,"execution sequence:",((j=t.agentExecutionSequence)==null?void 0:j.length)??0);const i=new Array(l.planExecution.steps.length).fill(null);if((U=t.agentExecutionSequence)!=null&&U.length){const W=Math.min(t.agentExecutionSequence.length,l.planExecution.steps.length);for(let H=0;H<W;H++){const R=t.agentExecutionSequence[H];if((ee=R.thinkActSteps)!=null&&ee.length){const z=R.thinkActSteps[R.thinkActSteps.length-1];z.actionDescription&&z.toolParameters?(i[H]={actionDescription:z.actionDescription,toolParameters:typeof z.toolParameters=="string"?z.toolParameters:JSON.stringify(z.toolParameters,null,2),thinkInput:z.thinkInput??"",thinkOutput:z.thinkOutput??"",status:t.currentStepIndex!==void 0&&H<t.currentStepIndex?"completed":t.currentStepIndex!==void 0&&H===t.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${H} action set: ${i[H].actionDescription}`)):(i[H]={actionDescription:"思考中",toolParameters:"等待决策",thinkInput:z.thinkInput??"",thinkOutput:z.thinkOutput??"",status:t.currentStepIndex!==void 0&&H===t.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${H} is thinking`))}else i[H]={actionDescription:t.currentStepIndex!==void 0&&H<t.currentStepIndex?"已完成":"等待中",toolParameters:"无工具参数",thinkInput:"",thinkOutput:"",status:t.currentStepIndex!==void 0&&H<t.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] 步骤 ${H} 无执行细节, 状态设为: ${i[H].status}`)}}else console.log("[ChatComponent] 没有执行序列数据");l.stepActions=[...i],console.log("[ChatComponent] 步骤动作更新完成:",JSON.stringify(i.map(W=>W==null?void 0:W.actionDescription))),ie(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},I=l=>{console.log("[ChatComponent] Starting dialog round with planId:",l),l&&(d.value.findIndex(i=>{var h;return((h=i.planExecution)==null?void 0:h.currentPlanId)===l&&i.type==="assistant"})===-1?(c("assistant","",{planExecution:{currentPlanId:l},thinking:"正在准备执行计划..."}),console.log("[ChatComponent] Created new assistant message for planId:",l)):console.log("[ChatComponent] Found existing assistant message for planId:",l))},T=l=>{var U,ee,W,H;console.log("[ChatComponent] Processing plan update with rootPlanId:",l);const t=oe.getCachedPlanRecord(l);if(!t){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",l);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",t),console.log("[ChatComponent] Plan steps:",t.steps),console.log("[ChatComponent] Plan completed:",t.completed),!t.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const i=d.value.findIndex(R=>{var z;return((z=R.planExecution)==null?void 0:z.currentPlanId)===t.currentPlanId&&R.type==="assistant"});let h;if(i!==-1)h=d.value[i],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",t.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",t.currentPlanId),console.log("[ChatComponent] Current messages:",d.value.map(z=>{var ae;return{type:z.type,planId:(ae=z.planExecution)==null?void 0:ae.currentPlanId,content:z.content.substring(0,50)}}));let R=-1;for(let z=d.value.length-1;z>=0;z--)if(d.value[z].type==="assistant"){R=z;break}if(R!==-1)h=d.value[R],h.planExecution||(h.planExecution={}),h.planExecution.currentPlanId=t.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",t.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(h.planExecution||(h.planExecution={}),h.planExecution=JSON.parse(JSON.stringify(t)),!t.steps||t.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),t.completed){delete h.thinking;const R=t.summary??t.result??t.message??"处理完成";h.content=v(R),console.log("[ChatComponent] Set simple response content:",h.content)}else t.title&&(h.thinking=`正在执行: ${t.title}`);return}delete h.thinking;const j=t.steps.map(R=>typeof R=="string"?R:typeof R=="object"&&R!==null&&(R.title||R.description)||"步骤");if(h.planExecution&&(h.planExecution.steps=j),t.agentExecutionSequence&&t.agentExecutionSequence.length>0){console.log("[ChatComponent] 发现执行序列数据，数量:",t.agentExecutionSequence.length),g(h,t);const R=t.currentStepIndex??0;if(R>=0&&R<t.agentExecutionSequence.length){const ae=t.agentExecutionSequence[R].thinkActSteps;if(ae&&ae.length>0){const Ce=ae[ae.length-1];if(Ce.thinkOutput){const Te=Ce.thinkOutput.length>150?Ce.thinkOutput.substring(0,150)+"...":Ce.thinkOutput;h.thinking=`正在思考: ${Te}`}}}}else if(h.planExecution){const R=h.planExecution.currentStepIndex??0,z=(U=h.planExecution.steps)==null?void 0:U[R],ae=typeof z=="string"?z:"";h.thinking=`正在执行: ${ae}`}if(t.userInputWaitState&&h.planExecution?(console.log("[ChatComponent] 需要用户输入:",t.userInputWaitState),h.planExecution.userInputWaitState||(h.planExecution.userInputWaitState={}),h.planExecution.userInputWaitState={message:t.userInputWaitState.message??"",formDescription:t.userInputWaitState.formDescription??"",formInputs:((ee=t.userInputWaitState.formInputs)==null?void 0:ee.map(R=>({label:R.label,value:R.value||""})))??[]},L[W=h.id]??(L[W]={}),h.thinking="等待用户输入..."):(H=h.planExecution)!=null&&H.userInputWaitState&&delete h.planExecution.userInputWaitState,t.completed??t.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete h.thinking;let R="";t.summary?R=t.summary:t.result?R=t.result:R="任务已完成",h.content=C(R),console.log("[ChatComponent] Updated completed message:",h.content)}ie(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},v=l=>l?l.includes("我")||l.includes("您")||l.includes("您好")||l.includes("可以")?l:l.length<10?`${l}！还有什么需要我帮助的吗？`:l.length<50?`好的，${l}。如果您还有其他问题，请随时告诉我。`:`${l}

希望这个回答对您有帮助！还有什么我可以为您做的吗？`:"我明白了，还有什么我可以帮您的吗？",C=l=>l?`${l}`:"任务已完成！还有什么我可以帮您的吗？",q=l=>{console.log("[ChatComponent] Plan completed with rootPlanId:",l);const t=oe.getCachedPlanRecord(l);if(!t){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",l);return}if(console.log("[ChatComponent] Plan details:",t),t.rootPlanId){const i=d.value.findIndex(h=>{var j;return((j=h.planExecution)==null?void 0:j.currentPlanId)===t.rootPlanId});if(i!==-1){const h=d.value[i];delete h.thinking;let U=t.summary??t.result??"任务已完成";!U.includes("我")&&!U.includes("您")&&(U.includes("成功")||U.includes("完成")?U=`很好！${U}。如果您还有其他需要帮助的地方，请随时告诉我。`:U=`我已经完成了您的请求：${U}`),h.content=U,console.log("[ChatComponent] Updated completed message:",h.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",t.rootPlanId)}},Z=l=>{if(!l)return"";let t=l.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return t=t.replace(/(<br><br>)/g,"</p><p>"),t.includes("</p><p>")&&(t=`<p>${t}</p>`),t},me=async l=>{var t;if(!((t=l.planExecution)!=null&&t.currentPlanId)||!l.planExecution.userInputWaitState){console.error("[ChatComponent] 缺少planExecution.currentPlanId或userInputWaitState");return}try{const i={},h=l.planExecution.userInputWaitState.formInputs;h&&h.length>0?Object.entries(L[l.id]).forEach(([U,ee])=>{var R;const W=parseInt(U,10),H=((R=h[W])==null?void 0:R.label)||`input_${U}`;i[H]=ee}):i.genericInput=l.genericInput??"",console.log("[ChatComponent] 提交用户输入:",i);const j=await Le.submitFormInput(l.planExecution.currentPlanId,i);delete l.planExecution.userInputWaitState,delete l.genericInput,delete L[l.id],D.startPolling(),console.log("[ChatComponent] 用户输入提交成功:",j)}catch(i){console.error("[ChatComponent] 用户输入提交失败:",i),alert(`提交失败: ${(i==null?void 0:i.message)||"未知错误"}`)}};return Se(()=>u.initialPrompt,(l,t)=>{console.log("[ChatComponent] initialPrompt changed from:",t,"to:",l),l&&typeof l=="string"&&l.trim()&&l!==t&&(console.log("[ChatComponent] Processing changed initial prompt:",l),ie(()=>{$(l)}))},{immediate:!1}),ye(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),oe.setEventCallbacks({onPlanUpdate:T,onPlanCompleted:q,onDialogRoundStart:I,onChatInputUpdateState:l=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",l)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")}}),ie(()=>{he()}),u.initialPrompt&&typeof u.initialPrompt=="string"&&u.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",u.initialPrompt),ie(()=>{$(u.initialPrompt)}))}),Ee(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),_e(),w.value&&clearInterval(w.value),D.cleanup(),Object.keys(L).forEach(l=>delete L[l])}),o({handleSendMessage:$,handlePlanUpdate:T,handlePlanCompleted:q,handleDialogRoundStart:I,addMessage:c}),(l,t)=>(p(),f("div",xs,[e("div",{class:"messages",ref_key:"messagesRef",ref:y},[(p(!0),f(ge,null,be(d.value,i=>{var h,j,U,ee,W,H,R,z,ae;return p(),f("div",{key:i.id,class:ne(["message",{user:i.type==="user",assistant:i.type==="assistant"}])},[e("div",Ds,[i.type==="user"?(p(),f("div",Rs,a(i.content),1)):(p(),f("div",As,[i.thinking||((h=i.planExecution)==null?void 0:h.progress)!==void 0||(((U=(j=i.planExecution)==null?void 0:j.steps)==null?void 0:U.length)??0)>0?(p(),f("div",Ms,[e("div",Ns,[e("div",Us,[b(s(P),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Ls,a(l.$t("chat.thinkingLabel")),1)]),e("div",Vs,[i.thinking?(p(),f("div",qs,[b(s(P),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,a(i.thinking),1)])):O("",!0),((ee=i.planExecution)==null?void 0:ee.progress)!==void 0?(p(),f("div",Fs,[e("div",Os,[e("div",{class:"progress-fill",style:Re({width:i.planExecution.progress+"%"})},null,4)]),e("span",Bs,a(i.planExecution.progressText??l.$t("chat.processing")+"..."),1)])):O("",!0),(((H=(W=i.planExecution)==null?void 0:W.steps)==null?void 0:H.length)??0)>0?(p(),f("div",js,[e("h4",Ws,a(l.$t("chat.stepExecutionDetails")),1),(p(!0),f(ge,null,be((R=i.planExecution)==null?void 0:R.steps,(Ce,J)=>{var Te,Ve,qe,Fe,Oe,Be,je,We,He,ze,Je,Ge,Xe,Ke,Qe,Ye,Ze,et,tt;return p(),f("div",{key:J,class:ne(["ai-section",{running:k(i,J)==="RUNNING",completed:k(i,J)==="FINISHED",pending:k(i,J)==="IDLE"}]),onClick:de(ce=>V(i,J),["stop"])},[e("div",zs,[e("span",Js,a(k(i,J)==="FINISHED"?"✓":k(i,J)==="RUNNING"?"▶":"○"),1),e("span",Gs,a(Ce||`${l.$t("chat.step")} ${J+1}`),1),k(i,J)==="RUNNING"?(p(),f("span",Xs,a(l.$t("chat.status.executing")),1)):k(i,J)==="FINISHED"?(p(),f("span",Ks,a(l.$t("chat.status.completed")),1)):(p(),f("span",Qs,a(l.$t("chat.status.pending")),1))]),i.stepActions&&i.stepActions[J]?(p(),f("div",Ys,[e("div",Zs,[e("span",eo,a(((Te=i.stepActions[J])==null?void 0:Te.status)==="current"?"🔄":((Ve=i.stepActions[J])==null?void 0:Ve.status)==="completed"?"✓":"⏳"),1),e("strong",null,a((qe=i.stepActions[J])==null?void 0:qe.actionDescription),1)]),(Fe=i.stepActions[J])!=null&&Fe.toolParameters?(p(),f("div",to,[t[0]||(t[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",no,a(l.$t("common.parameters"))+":",1),e("pre",so,a((Oe=i.stepActions[J])==null?void 0:Oe.toolParameters),1)])):O("",!0),(Be=i.stepActions[J])!=null&&Be.thinkOutput?(p(),f("div",oo,[e("div",ao,[t[1]||(t[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",lo,a(l.$t("chat.thinkingOutput"))+":",1)]),e("div",io,[e("pre",co,a((je=i.stepActions[J])==null?void 0:je.thinkOutput),1)])])):O("",!0)])):O("",!0),((We=M(i,J))==null?void 0:We.length)>0?(p(),f("div",ro,[e("div",uo,[b(s(P),{icon:"carbon:tree-view",class:"sub-plan-icon"}),t[2]||(t[2]=e("span",{class:"sub-plan-title"},"子执行计划",-1))]),e("div",po,[(p(!0),f(ge,null,be(M(i,J),(ce,le)=>(p(),f("div",{key:`sub-${J}-${le}`,class:ne(["sub-plan-step-item",{completed:S(i,J,le)==="completed",current:S(i,J,le)==="current",pending:S(i,J,le)==="pending"}]),onClick:de(nt=>x(i,J,le),["stop"])},[e("div",go,[e("span",vo,a(S(i,J,le)==="completed"?"✓":S(i,J,le)==="current"?"▶":"○"),1),e("span",mo,a(le+1),1)]),e("div",fo,[e("span",bo,a(ce),1),t[3]||(t[3]=e("span",{class:"sub-step-badge"},"子步骤",-1))])],10,ho))),128))])])):O("",!0),(He=i.planExecution)!=null&&He.userInputWaitState&&k(i,J)==="RUNNING"?(p(),f("div",_o,[e("p",ko,a(((Je=(ze=i.planExecution)==null?void 0:ze.userInputWaitState)==null?void 0:Je.message)??l.$t("chat.userInput.message")),1),(Xe=(Ge=i.planExecution)==null?void 0:Ge.userInputWaitState)!=null&&Xe.formDescription?(p(),f("p",$o,a((Qe=(Ke=i.planExecution)==null?void 0:Ke.userInputWaitState)==null?void 0:Qe.formDescription),1)):O("",!0),e("form",{onSubmit:de(ce=>me(i),["prevent"]),class:"user-input-form"},[(Ze=(Ye=i.planExecution)==null?void 0:Ye.userInputWaitState)!=null&&Ze.formInputs&&i.planExecution.userInputWaitState.formInputs.length>0?(p(!0),f(ge,{key:0},be((tt=(et=i.planExecution)==null?void 0:et.userInputWaitState)==null?void 0:tt.formInputs,(ce,le)=>(p(),f("div",{key:le,class:"form-group"},[e("label",{for:`form-input-${ce.label.replace(/\W+/g,"_")}`},a(ce.label)+": ",9,Co),pe(e("input",{type:"text",id:`form-input-${ce.label.replace(/\W+/g,"_")}`,name:ce.label,"onUpdate:modelValue":nt=>L[i.id][le]=nt,class:"form-input"},null,8,So),[[ve,L[i.id][le]]])]))),128)):(p(),f("div",yo,[e("label",Eo,a(l.$t("common.input"))+":",1),pe(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":ce=>i.genericInput=ce,class:"form-input"},null,8,wo),[[ve,i.genericInput]])])),e("button",Io,a(l.$t("chat.userInput.submit")),1)],40,Po)])):O("",!0)],10,Hs)}),128))])):!i.content&&(i.thinking||((z=i.planExecution)==null?void 0:z.progress)!==void 0&&(((ae=i.planExecution)==null?void 0:ae.progress)??0)<100)?(p(),f("div",To,[e("div",xo,[t[4]||(t[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,a(i.thinking??l.$t("chat.thinkingProcessing")),1)])])):O("",!0)])])):O("",!0),e("div",Do,[e("div",Ro,[e("div",Ao,[b(s(P),{icon:"carbon:bot",class:"bot-icon"})]),e("div",Mo,a(l.$t("chat.botName")),1)]),e("div",No,[i.content?(p(),f("div",Uo,[e("div",{class:"response-text",innerHTML:Z(i.content)},null,8,Lo)])):(p(),f("div",Vo,[e("div",qo,[t[5]||(t[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Fo,a(l.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),K.value?(p(),f("div",Oo,[e("div",Bo,[e("div",jo,[e("div",Wo,[e("div",Ho,[e("div",zo,[b(s(P),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",Jo,a(l.$t("chat.thinkingLabel")),1)]),e("div",Go,[e("div",Xo,[e("div",Ko,[t[6]||(t[6]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,a(l.$t("chat.thinking")),1)])])])]),e("div",Qo,[e("div",Yo,[e("div",Zo,[b(s(P),{icon:"carbon:bot",class:"bot-icon"})]),e("div",ea,a(l.$t("chat.botName")),1)]),e("div",ta,[e("div",na,[e("div",sa,[t[7]||(t[7]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",oa,a(l.$t("chat.thinkingResponse")),1)])])])])])])])):O("",!0)],512),B.value?(p(),f("div",{key:0,class:"scroll-to-bottom-btn",onClick:te,title:l.$t("chat.scrollToBottom")},[b(s(P),{icon:"carbon:chevron-down"})],8,aa)):O("",!0)]))}}),ia=Pe(la,[["__scopeId","data-v-d1fb4f30"]]),ca={class:"input-area"},ra={class:"input-container"},ua={class:"attach-btn",title:"附加文件"},da=["placeholder","disabled"],pa=["title"],ha=["disabled","title"],ga=$e({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1}},emits:["send","clear","update-state","plan-mode-clicked"],setup(G,{expose:o,emit:n}){const{t:u}=Ie(),N=G,r=n,D=A(),y=A(""),K=fe(()=>N.placeholder||u("input.placeholder")),d=A(K.value),w=fe(()=>!!N.disabled),B=()=>{ie(()=>{D.value&&(D.value.style.height="auto",D.value.style.height=Math.min(D.value.scrollHeight,120)+"px")})},L=F=>{F.key==="Enter"&&!F.shiftKey&&(F.preventDefault(),c())},c=()=>{if(!y.value.trim()||w.value)return;const F=y.value.trim();r("send",F),E()},_=()=>{r("plan-mode-clicked")},E=()=>{y.value="",B(),r("clear")};return o({clearInput:E,updateState:(F,te)=>{te&&(d.value=F?te:u("input.waiting")),r("update-state",F,te)},getQuery:()=>y.value.trim(),focus:()=>{var F;return(F=D.value)==null?void 0:F.focus()}}),ye(()=>{}),Ee(()=>{}),(F,te)=>(p(),f("div",ca,[e("div",ra,[e("button",ua,[b(s(P),{icon:"carbon:attachment"})]),pe(e("textarea",{"onUpdate:modelValue":te[0]||(te[0]=se=>y.value=se),ref_key:"inputRef",ref:D,class:"chat-input",placeholder:d.value,disabled:w.value,onKeydown:L,onInput:B},null,40,da),[[ve,y.value]]),e("button",{class:"plan-mode-btn",title:F.$t("input.planMode"),onClick:_},[b(s(P),{icon:"carbon:document"}),Q(" "+a(F.$t("input.planMode")),1)],8,pa),e("button",{class:"send-button",disabled:!y.value.trim()||w.value,onClick:c,title:F.$t("input.send")},[b(s(P),{icon:"carbon:send-alt"}),Q(" "+a(F.$t("input.send")),1)],8,ha)])]))}}),va=Pe(ga,[["__scopeId","data-v-c8e17afe"]]);class we{static async getAllCronTasks(){try{const o=await fetch(this.BASE_URL);return await(await this.handleResponse(o)).json()}catch(o){throw console.error("Failed to get cron tasks:",o),o}}static async getCronTaskById(o){try{const n=await fetch(`${this.BASE_URL}/${o}`);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get cron task by id:",n),n}}static async createCronTask(o){try{const n=await fetch(this.BASE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to create cron task:",n),n}}static async updateCronTask(o,n){try{const u=await fetch(`${this.BASE_URL}/${o}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});return await(await this.handleResponse(u)).json()}catch(u){throw console.error("Failed to update cron task:",u),u}}static async updateTaskStatus(o,n){try{const u=await fetch(`${this.BASE_URL}/${o}/status?status=${n}`,{method:"PUT"});await this.handleResponse(u)}catch(u){throw console.error("Failed to update task status:",u),u}}static async deleteCronTask(o){try{const n=await fetch(`${this.BASE_URL}/${o}`,{method:"DELETE"});await this.handleResponse(n)}catch(n){throw console.error("Failed to delete cron task:",n),n}}static async handleResponse(o){if(!o.ok)try{const n=await o.json();throw new Error(n.message||`API request failed: ${o.status}`)}catch{throw new Error(`API request failed: ${o.status} ${o.statusText}`)}return o}}re(we,"BASE_URL","/api/cron-tasks");const ma={class:"modal-header"},fa={class:"modal-content"},ba={class:"form-group"},_a={class:"form-label"},ka=["placeholder"],$a={class:"form-group"},Pa={class:"form-label"},Ca=["placeholder"],Sa={class:"form-help"},ya={class:"form-group"},Ea={class:"form-label"},wa=["placeholder"],Ia={class:"form-group"},Ta={class:"form-label"},xa={class:"status-toggle"},Da={key:0,class:"form-group"},Ra={class:"form-label"},Aa={class:"form-info"},Ma={key:1,class:"form-group"},Na={class:"form-label"},Ua={class:"form-info"},La={key:2,class:"form-group"},Va={class:"form-label"},qa={class:"form-info"},Fa={class:"modal-footer"},Oa=["disabled"],Ba=$e({__name:"TaskDetailModal",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","save"],setup(G,{emit:o}){const n=G,u=o,N=A(!1),r=A({cronName:"",cronTime:"",planDesc:"",status:1}),D=d=>{d.target===d.currentTarget&&u("update:modelValue",!1)},y=async()=>{var d,w,B,L;if(!(!((d=r.value.cronName)!=null&&d.trim())||!((w=r.value.cronTime)!=null&&w.trim()))){N.value=!0;try{const c={...r.value,...((B=n.task)==null?void 0:B.id)!==void 0&&{id:n.task.id},cronName:r.value.cronName.trim(),cronTime:r.value.cronTime.trim(),planDesc:((L=r.value.planDesc)==null?void 0:L.trim())||"",status:r.value.status};u("save",c)}finally{N.value=!1}}},K=d=>new Date(d).toLocaleString();return Se(()=>n.task,d=>{d&&(r.value={cronName:d.name||d.cronName||"",cronTime:d.cronExpression||d.cronTime||"",planDesc:d.description||d.planDesc||"",status:d.status??1})},{immediate:!0}),Se(()=>n.modelValue,d=>{d||(r.value={cronName:"",cronTime:"",planDesc:"",status:1})}),(d,w)=>(p(),ue(Ae,{to:"body"},[b(xe,{name:"modal"},{default:De(()=>{var B,L,c;return[d.modelValue?(p(),f("div",{key:0,class:"modal-overlay",onClick:D},[e("div",{class:"modal-container",onClick:w[7]||(w[7]=de(()=>{},["stop"]))},[e("div",ma,[e("h3",null,a(d.$t("cronTask.taskDetail")),1),e("button",{class:"close-btn",onClick:w[0]||(w[0]=_=>d.$emit("update:modelValue",!1))},[b(s(P),{icon:"carbon:close"})])]),e("div",fa,[e("form",{onSubmit:de(y,["prevent"]),class:"task-form"},[e("div",ba,[e("label",_a,a(d.$t("cronTask.taskName")),1),pe(e("input",{"onUpdate:modelValue":w[1]||(w[1]=_=>r.value.cronName=_),type:"text",class:"form-input",placeholder:d.$t("cronTask.taskNamePlaceholder"),required:""},null,8,ka),[[ve,r.value.cronName]])]),e("div",$a,[e("label",Pa,a(d.$t("cronTask.cronExpression")),1),pe(e("input",{"onUpdate:modelValue":w[2]||(w[2]=_=>r.value.cronTime=_),type:"text",class:"form-input",placeholder:d.$t("cronTask.cronExpressionPlaceholder"),required:""},null,8,Ca),[[ve,r.value.cronTime]]),e("div",Sa,a(d.$t("cronTask.cronExpressionHelp")),1)]),e("div",ya,[e("label",Ea,a(d.$t("cronTask.taskDescription")),1),pe(e("textarea",{"onUpdate:modelValue":w[3]||(w[3]=_=>r.value.planDesc=_),class:"form-textarea",placeholder:d.$t("cronTask.taskDescriptionPlaceholder"),rows:"4"},null,8,wa),[[ve,r.value.planDesc]])]),e("div",Ia,[e("label",Ta,a(d.$t("cronTask.taskStatus")),1),e("div",xa,[e("button",{type:"button",class:ne(["status-btn",r.value.status===0?"active":""]),onClick:w[4]||(w[4]=_=>r.value.status=0)},[b(s(P),{icon:"carbon:checkmark"}),Q(" "+a(d.$t("cronTask.active")),1)],2),e("button",{type:"button",class:ne(["status-btn",r.value.status===1?"active":""]),onClick:w[5]||(w[5]=_=>r.value.status=1)},[b(s(P),{icon:"carbon:close"}),Q(" "+a(d.$t("cronTask.inactive")),1)],2)])]),(B=d.task)!=null&&B.createTime?(p(),f("div",Da,[e("label",Ra,a(d.$t("cronTask.createTime")),1),e("div",Aa,a(K(d.task.createTime)),1)])):O("",!0),(L=d.task)!=null&&L.updateTime?(p(),f("div",Ma,[e("label",Na,a(d.$t("cronTask.updateTime")),1),e("div",Ua,a(K(d.task.updateTime)),1)])):O("",!0),(c=d.task)!=null&&c.nextExecutionTime?(p(),f("div",La,[e("label",Va,a(d.$t("cronTask.nextExecution")),1),e("div",qa,a(K(d.task.nextExecutionTime)),1)])):O("",!0)],32)]),e("div",Fa,[e("button",{type:"button",class:"cancel-btn",onClick:w[6]||(w[6]=_=>d.$emit("update:modelValue",!1))},a(d.$t("common.cancel")),1),e("button",{type:"button",class:"save-btn",onClick:y,disabled:N.value},[N.value?(p(),ue(s(P),{key:0,icon:"carbon:loading",class:"loading-icon"})):O("",!0),Q(" "+a(d.$t("common.save")),1)],8,Oa)])])])):O("",!0)]}),_:1})]))}}),ja=Pe(Ba,[["__scopeId","data-v-6c52f326"]]),Wa={class:"modal-header"},Ha={class:"modal-content"},za={key:0,class:"loading-container"},Ja={key:1,class:"empty-container"},Ga={key:2,class:"task-list"},Xa=["onClick"],Ka={class:"task-main"},Qa={class:"task-info"},Ya={class:"task-header"},Za={class:"task-name"},el={class:"task-description"},tl={class:"task-time"},nl=["onClick"],sl=["onClick","disabled","title"],ol=["onClick","title"],al={class:"dropdown-menu"},ll=["onClick"],il=["onClick","disabled"],cl=["onClick","disabled"],rl={class:"confirm-header"},ul={class:"confirm-content"},dl={class:"confirm-actions"},pl=["disabled"],hl=$e({__name:"index",props:{modelValue:{type:Boolean,required:!0}},emits:["update:modelValue"],setup(G,{emit:o}){const n=ot(),u=at(),N=dt(),r=G,D=o,y=A([]),K=A(!1),d=A(null),w=A(null),B=A(null),L=A(null),c=A(!1),_=A(null),E=A(!1),X=A(null),Y=g=>{g.target===g.currentTarget&&D("update:modelValue",!1)},F=async()=>{K.value=!0;try{y.value=await we.getAllCronTasks()}catch(g){console.error("Failed to load cron tasks:",g)}finally{K.value=!1}},te=async g=>{d.value=g;try{const I=y.value.find(v=>v.id===g);if(!I){console.error("Task not found:",g);return}const T=I.planDesc||I.description||I.cronName||"";if(T.trim()){u.setTask(T.trim()),D("update:modelValue",!1);const v=Date.now().toString();await n.push({name:"direct",params:{id:v}})}}catch(I){console.error("Failed to execute task:",I)}finally{d.value=null}},se=g=>{_.value={...g},c.value=!0,L.value=null},he=async g=>{try{g.id&&(await we.updateCronTask(Number(g.id),g),await F()),c.value=!1}catch(I){console.error("Failed to save task:",I)}},_e=g=>{X.value=g,E.value=!0},$=async()=>{var g;if((g=X.value)!=null&&g.id){w.value=X.value.id;try{await we.deleteCronTask(String(X.value.id)),await F(),E.value=!1,X.value=null}catch(I){console.error("Failed to delete task:",I)}finally{w.value=null}}},k=()=>{E.value=!1,X.value=null},V=g=>{L.value=L.value===g?null:g},M=async g=>{if(g.id){B.value=g.id;try{const I=g.status===0?1:0;await we.updateCronTask(Number(g.id),{...g,status:I}),await F(),L.value=null}catch(I){console.error("Failed to toggle task status:",I)}finally{B.value=null}}},S=async g=>{try{await navigator.clipboard.writeText(g),N.success("成功复制cron表达式")}catch{N.error("复制失败")}},x=g=>{const I=g.target;!I.closest(".action-dropdown")&&!I.closest(".dropdown-menu")&&(L.value=null)};return ye(()=>{document.addEventListener("click",x,!0)}),Ee(()=>{document.removeEventListener("click",x,!0)}),Se(()=>r.modelValue,g=>{g&&F()}),(g,I)=>(p(),f(ge,null,[(p(),ue(Ae,{to:"body"},[b(xe,{name:"modal"},{default:De(()=>[G.modelValue?(p(),f("div",{key:0,class:"modal-overlay",onClick:Y},[e("div",{class:"modal-container",onClick:I[2]||(I[2]=de(()=>{},["stop"]))},[e("div",Wa,[e("h3",null,a(g.$t("cronTask.title")),1),e("button",{class:"close-btn",onClick:I[0]||(I[0]=T=>g.$emit("update:modelValue",!1))},[b(s(P),{icon:"carbon:close"})])]),e("div",Ha,[K.value?(p(),f("div",za,[b(s(P),{icon:"carbon:loading",class:"loading-icon"}),e("span",null,a(g.$t("common.loading")),1)])):y.value.length===0?(p(),f("div",Ja,[b(s(P),{icon:"carbon:time",class:"empty-icon"}),e("span",null,a(g.$t("cronTask.noTasks")),1)])):(p(),f("div",Ga,[(p(!0),f(ge,null,be(y.value,T=>(p(),f("div",{key:T.id||"",class:"task-item",onClick:v=>se(T)},[e("div",Ka,[e("div",Qa,[e("div",Ya,[e("div",Za,a(T.cronName),1),e("div",{class:ne(["task-status-badge",T.status===0?"active":"inactive"])},[b(s(P),{icon:T.status===0?"carbon:checkmark-filled":"carbon:pause-filled"},null,8,["icon"]),e("span",null,a(T.status===0?g.$t("cronTask.active"):g.$t("cronTask.inactive")),1)],2)]),e("div",el,a(T.planDesc||T.description),1),e("div",tl,[b(s(P),{icon:"carbon:time"}),e("span",{class:"cron-readable",style:{cursor:"pointer"},onClick:de(v=>S(T.cronTime),["stop"])},a(T.cronTime),9,nl)])])]),e("div",{class:"task-actions",onClick:I[1]||(I[1]=de(()=>{},["stop"]))},[e("button",{class:"action-btn execute-btn",onClick:v=>te(T.id),disabled:d.value===T.id,title:g.$t("cronTask.executeOnce")},[b(s(P),{icon:d.value===T.id?"carbon:loading":"carbon:play-filled"},null,8,["icon"]),Q(" "+a(g.$t("cronTask.executeOnce")),1)],8,sl),e("div",{class:ne(["action-dropdown",{active:L.value===T.id}])},[e("button",{class:"action-btn dropdown-btn",onClick:v=>V(T.id),title:g.$t("cronTask.operations")},[b(s(P),{icon:"carbon:overflow-menu-horizontal"}),Q(" "+a(g.$t("cronTask.operations")),1)],8,ol),pe(e("div",al,[e("button",{class:"dropdown-item edit-btn",onClick:v=>se(T)},[b(s(P),{icon:"carbon:edit"}),Q(" "+a(g.$t("cronTask.edit")),1)],8,ll),e("button",{class:"dropdown-item toggle-btn",onClick:v=>M(T),disabled:B.value===T.id},[b(s(P),{icon:B.value===T.id?"carbon:loading":T.status===0?"carbon:pause-filled":"carbon:play-filled"},null,8,["icon"]),Q(" "+a(T.status===0?g.$t("cronTask.disable"):g.$t("cronTask.enable")),1)],8,il),e("button",{class:"dropdown-item delete-btn",onClick:v=>_e(T),disabled:w.value===T.id},[b(s(P),{icon:w.value===T.id?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),Q(" "+a(g.$t("cronTask.delete")),1)],8,cl)],512),[[ct,L.value===T.id]])],2)])],8,Xa))),128))]))])])])):O("",!0)]),_:1})])),b(ja,{modelValue:c.value,"onUpdate:modelValue":I[3]||(I[3]=T=>c.value=T),task:_.value,onSave:he},null,8,["modelValue","task"]),(p(),ue(Ae,{to:"body"},[b(xe,{name:"modal"},{default:De(()=>{var T,v,C,q;return[E.value?(p(),f("div",{key:0,class:"modal-overlay",onClick:k},[e("div",{class:"confirm-modal",onClick:I[4]||(I[4]=de(()=>{},["stop"]))},[e("div",rl,[b(s(P),{icon:"carbon:warning",class:"warning-icon"}),e("h3",null,a(g.$t("cronTask.deleteConfirm")),1)]),e("div",ul,[e("p",null,a(g.$t("cronTask.deleteConfirmMessage",{taskName:((T=X.value)==null?void 0:T.cronName)||((v=X.value)==null?void 0:v.planDesc)||""})),1)]),e("div",dl,[e("button",{class:"confirm-btn cancel-btn",onClick:k},a(g.$t("common.cancel")),1),e("button",{class:"confirm-btn delete-btn",onClick:$,disabled:w.value===((C=X.value)==null?void 0:C.id)},[b(s(P),{icon:w.value===((q=X.value)==null?void 0:q.id)?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),Q(" "+a(g.$t("cronTask.delete")),1)],8,pl)])])])):O("",!0)]}),_:1})]))],64))}}),gl=Pe(hl,[["__scopeId","data-v-8d431095"]]),vl={class:"direct-page"},ml={class:"direct-chat"},fl={class:"chat-header"},bl={class:"header-actions"},_l=["title"],kl=["title"],$l={class:"chat-content"},Pl=["title"],Cl=$e({__name:"index",setup(G){const o=rt(),n=ot(),u=at(),{t:N}=Ie(),r=A(""),D=A(),y=A(),K=A(),d=A(!1),w=A(!1),B=A(null),L=A(!1),c=A(50),_=A(!1),E=A(0),X=A(0);ye(()=>{console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",u.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",u.hasUnprocessedTask()),oe.setEventCallbacks({onPlanUpdate:C=>{console.log("[Direct] Plan update event received for rootPlanId:",C),he(C)&&(console.log("[Direct] Processing plan update for current rootPlanId:",C),y.value&&typeof y.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",C),y.value.handlePlanUpdate(C)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),D.value&&typeof D.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",C),D.value.updateDisplayedPlanProgress(C)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:C=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",C),!!he(C)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",C),y.value&&typeof y.value.handlePlanCompleted=="function"){const q=oe.getCachedPlanRecord(C);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",q),y.value.handlePlanCompleted(q??{planId:C})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");B.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:C=>{console.log("[Direct] Dialog round start event received for rootPlanId:",C),B.value=C,console.log("[Direct] Set currentRootPlanId to:",C),y.value&&typeof y.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",C),y.value.handleDialogRoundStart(C)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),$()},onChatInputUpdateState:C=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",C),!he(C,!0))return;const q=oe.getCachedUIState(C);q&&V(q.enabled,q.placeholder)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),m.loadPlanTemplateList(),u.hasUnprocessedTask()&&u.currentTask?(r.value=u.currentTask.prompt,console.log("[Direct] Setting prompt from store:",r.value),u.markTaskAsProcessed(),console.log("[Direct] Received task from store:",r.value)):(r.value=o.query.prompt||"",console.log("[Direct] Received task from URL:",r.value),console.log("[Direct] No unprocessed task in store"));const v=localStorage.getItem("directPanelWidth");v&&(c.value=parseFloat(v)),console.log("[Direct] Final prompt value:",r.value)}),Se(()=>u.currentTask,v=>{console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",v),v&&!v.processed?(r.value=v.prompt,u.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",r.value)):console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),Se(()=>r.value,(v,C)=>{console.log("[Direct] prompt value changed from:",C,"to:",v)},{immediate:!1}),Ee(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),B.value=null,oe.cleanup(),document.removeEventListener("mousemove",F),document.removeEventListener("mouseup",te)});const Y=v=>{_.value=!0,E.value=v.clientX,X.value=c.value,document.addEventListener("mousemove",F),document.addEventListener("mouseup",te),document.body.style.cursor="col-resize",document.body.style.userSelect="none",v.preventDefault()},F=v=>{if(!_.value)return;const C=window.innerWidth,Z=(v.clientX-E.value)/C*100;let me=X.value+Z;me=Math.max(20,Math.min(80,me)),c.value=me},te=()=>{_.value=!1,document.removeEventListener("mousemove",F),document.removeEventListener("mouseup",te),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",c.value.toString())},se=()=>{c.value=50,localStorage.setItem("directPanelWidth","50")},he=(v,C=!1)=>!B.value||v===B.value||C&&(v==="ui-state"||v==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",v,"current:",B.value),!1),_e=v=>{console.log("[DirectView] Send message from input:",v),y.value&&typeof y.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",v),y.value.handleSendMessage(v)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},$=()=>{console.log("[DirectView] Input cleared"),K.value&&typeof K.value.clear=="function"&&K.value.clear()},k=()=>{console.log("[DirectView] Input focused")},V=(v,C)=>{console.log("[DirectView] Input state updated:",v,C),w.value=!v},M=(v,C)=>{console.log("[DirectView] Step selected:",v,C),D.value&&typeof D.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",v,C),D.value.handleStepSelected(v,C)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},S=(v,C,q,Z)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:v,subPlanId:C,stepIndex:q,subStepIndex:Z}),D.value&&typeof D.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:v,subPlanId:C,stepIndex:q,subStepIndex:Z}),D.value.handleSubPlanStepSelected(v,C,q,Z)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},x=()=>{console.log("[DirectView] Plan mode button clicked"),m.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",m.isCollapsed)},g=()=>{n.push("/home")},I=()=>{n.push("/configs")},T=async v=>{var C;if(console.log("[DirectView] Plan execution requested:",v),d.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}d.value=!0,y.value&&typeof y.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",v.title),y.value.addMessage("user",v.title)):console.warn("[DirectView] chatRef.addMessage method not available");try{const q=v.planData.planTemplateId||v.planData.planId;if(!q)throw new Error("没有找到计划模板ID");console.log("[Direct] Executing plan with templateId:",q,"params:",v.params),console.log("[Direct] About to call PlanActApiService.executePlan");let Z;if((C=v.params)!=null&&C.trim()?(console.log("[Direct] Calling executePlan with params:",v.params.trim()),Z=await Me.executePlan(q,v.params.trim())):(console.log("[Direct] Calling executePlan without params"),Z=await Me.executePlan(q)),console.log("[Direct] Plan execution API response:",Z),Z.planId)console.log("[Direct] Got planId from response:",Z.planId,"starting plan execution"),B.value=Z.planId,console.log("[Direct] Set currentRootPlanId to:",Z.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),oe.handlePlanExecutionRequested(Z.planId,v.title);else throw console.error("[Direct] No planId in response:",Z),new Error("执行计划失败：未返回有效的计划ID")}catch(q){console.error("[Direct] Plan execution failed:",q),console.error("[Direct] Error details:",{message:q.message,stack:q.stack}),B.value=null,y.value&&typeof y.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),y.value.addMessage("user",v.title),y.value.addMessage("assistant",`执行计划失败: ${q.message||"未知错误"}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`执行计划失败: ${q.message||"未知错误"}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),d.value=!1}};return(v,C)=>(p(),f("div",vl,[e("div",ml,[b(pn,{onPlanExecutionRequested:T}),e("div",{class:"left-panel",style:Re({width:c.value+"%"})},[e("div",fl,[e("button",{class:"back-button",onClick:g},[b(s(P),{icon:"carbon:arrow-left"})]),e("h2",null,a(v.$t("conversation")),1),e("div",bl,[b(ut),e("button",{class:"config-button",onClick:I,title:v.$t("direct.configuration")},[b(s(P),{icon:"carbon:settings-adjust",width:"20"})],8,_l),e("button",{class:"cron-task-btn",onClick:C[0]||(C[0]=q=>L.value=!0),title:v.$t("cronTask.title")},[b(s(P),{icon:"carbon:alarm",width:"20"})],8,kl)])]),e("div",$l,[b(ia,{ref_key:"chatRef",ref:y,mode:"direct","initial-prompt":r.value||"",onStepSelected:M,onSubPlanStepSelected:S},null,8,["initial-prompt"])]),(p(),ue(va,{key:v.$i18n.locale,ref_key:"inputRef",ref:K,disabled:w.value,placeholder:w.value?s(N)("input.waiting"):s(N)("input.placeholder"),onSend:_e,onClear:$,onFocus:k,onUpdateState:V,onPlanModeClicked:x},null,8,["disabled","placeholder"]))],4),e("div",{class:"panel-resizer",onMousedown:Y,onDblclick:se,title:v.$t("direct.panelResizeHint")},C[2]||(C[2]=[e("div",{class:"resizer-line"},null,-1)]),40,Pl),b(Is,{ref_key:"rightPanelRef",ref:D,style:Re({width:100-c.value+"%"})},null,8,["style"])]),b(gl,{modelValue:L.value,"onUpdate:modelValue":C[1]||(C[1]=q=>L.value=q)},null,8,["modelValue"])]))}}),xl=Pe(Cl,[["__scopeId","data-v-cf083d3a"]]);export{xl as default};
