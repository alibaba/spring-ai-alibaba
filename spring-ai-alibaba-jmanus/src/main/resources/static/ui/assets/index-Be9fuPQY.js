var gt=Object.defineProperty;var ft=(T,t,n)=>t in T?gt(T,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):T[t]=n;var me=(T,t,n)=>ft(T,typeof t!="symbol"?t+"":t,n);import{d as Ie,u as Ae,c as we,o as xe,a as p,b as r,n as ie,i as o,e,f as F,t as s,g,h as le,F as _e,q as ke,j as re,w as pe,m as ve,A as He,r as S,l as $e,T as Le,p as qe,B as Ve,C as De,y as We,D as bt,E as Ee,z as ge,G as ht,H as $t,x as mt,I as _t}from"./index-cPqkcsGL.js";import{I as f,_ as Te}from"./_plugin-vue_export-helper-CMjwL5Wh.js";import{s as w,P as je,u as vt}from"./sidebar-TTi6ZXeG.js";import{L as yt}from"./llm-check-BVkAKrj3.js";import{L as kt}from"./index-DXNrD0WO.js";import{u as Ct,a as wt}from"./useMessage-D0fc_1G5.js";const Pt={class:"sidebar-content"},St={class:"sidebar-content-header"},Et={class:"sidebar-content-title"},It={class:"tab-switcher"},Tt=["disabled"],xt={key:0,class:"tab-content"},Dt={class:"new-task-section"},Rt={class:"sidebar-content-list"},Mt={key:0,class:"loading-state"},At={key:1,class:"error-state"},Nt={key:2,class:"empty-state"},Ft=["onClick"],Ut={class:"task-icon"},Lt={class:"task-details"},qt={class:"task-title"},Vt={class:"task-preview"},Bt={class:"task-time"},Wt={class:"task-actions"},jt=["title","onClick"],Ot={key:1,class:"tab-content config-tab"},zt={key:0,class:"config-container"},Ht={class:"template-info-header"},Jt={class:"template-info"},Gt={class:"template-id"},Kt={class:"config-section"},Xt={class:"section-header"},Qt={class:"generator-content"},Yt=["placeholder"],Zt={class:"generator-actions"},en=["disabled"],tn=["disabled"],nn={class:"config-section"},sn={class:"section-header"},on={class:"section-actions"},an=["disabled","title"],ln=["disabled","title"],cn=["disabled"],rn=["placeholder"],dn={class:"config-section"},un={class:"section-header"},pn={class:"execution-content"},hn={class:"params-input-group"},mn={class:"params-help-text"},vn={class:"params-input-container"},gn=["placeholder"],fn=["title"],bn={class:"api-url-display"},$n={class:"api-url-label"},_n={class:"api-url"},yn={class:"api-url-display"},kn={class:"api-url-label"},Cn=["disabled"],wn=Ie({__name:"index",emits:["planExecutionRequested"],setup(T,{expose:t,emit:n}){const{t:c}=Ae(),m=["currentPlanId","userRequest","rootPlanId"],b=we({get(){try{if(!w.jsonContent)return"";const $={...JSON.parse(w.jsonContent)};return m.forEach(P=>{delete $[P]}),JSON.stringify($,null,2)}catch{return w.jsonContent}},set(a){try{if(!a.trim()){w.jsonContent="";return}const $=JSON.parse(a);let P={};try{P=JSON.parse(w.jsonContent||"{}")}catch{}const K={...$};m.forEach(I=>{P[I]!==void 0&&(K[I]=P[I])}),w.jsonContent=JSON.stringify(K)}catch{w.jsonContent=a}}}),d=n,E=async()=>{try{const a=await w.saveTemplate();a!=null&&a.duplicate?alert(c("sidebar.saveCompleted",{message:a.message,versionCount:a.versionCount})):a!=null&&a.saved?alert(c("sidebar.saveSuccess",{message:a.message,versionCount:a.versionCount})):a!=null&&a.message&&alert(c("sidebar.saveStatus",{message:a.message}))}catch(a){console.error("Failed to save plan modifications:",a),alert(a.message||c("sidebar.saveFailed"))}},L=async()=>{var a;try{await w.generatePlan(),alert(c("sidebar.generateSuccess",{templateId:((a=w.selectedTemplate)==null?void 0:a.id)??c("sidebar.unknown")}))}catch($){console.error("Failed to generate plan:",$),alert(c("sidebar.generateFailed")+": "+$.message)}},y=async()=>{try{await w.updatePlan(),alert(c("sidebar.updateSuccess"))}catch(a){console.error("Failed to update plan:",a),alert(c("sidebar.updateFailed")+": "+a.message)}},M=async()=>{console.log("[Sidebar] handleExecutePlan called");try{const a=w.preparePlanExecution();if(!a){console.log("[Sidebar] No plan data available, returning");return}console.log("[Sidebar] Triggering plan execution request:",a),console.log("[Sidebar] Emitting planExecutionRequested event"),d("planExecutionRequested",a),console.log("[Sidebar] Event emitted")}catch(a){console.error("Error executing plan:",a),alert(c("sidebar.executeFailed")+": "+a.message)}finally{w.finishPlanExecution()}},G=a=>{if(isNaN(a.getTime()))return console.warn("Invalid date received:",a),c("time.unknown");const P=new Date().getTime()-a.getTime(),K=Math.floor(P/6e4),I=Math.floor(P/36e5),D=Math.floor(P/864e5);return K<1?c("time.now"):K<60?c("time.minuteAgo",{count:K}):I<24?c("time.hourAgo",{count:I}):D<30?c("time.dayAgo",{count:D}):a.toLocaleDateString("zh-CN")},q=(a,$)=>!a||a.length<=$?a:a.substring(0,$)+"...";return xe(()=>{w.loadPlanTemplateList()}),t({loadPlanTemplateList:w.loadPlanTemplateList,toggleSidebar:w.toggleSidebar,currentPlanTemplateId:w.currentPlanTemplateId}),(a,$)=>(r(),p("div",{class:ie(["sidebar-wrapper",{"sidebar-wrapper-collapsed":o(w).isCollapsed}])},[e("div",Pt,[e("div",St,[e("div",Et,s(a.$t("sidebar.title")),1)]),e("div",It,[e("button",{class:ie(["tab-button",{active:o(w).currentTab==="list"}]),onClick:$[0]||($[0]=P=>o(w).switchToTab("list"))},[g(o(f),{icon:"carbon:list",width:"16"}),le(" "+s(a.$t("sidebar.templateList")),1)],2),e("button",{class:ie(["tab-button",{active:o(w).currentTab==="config"}]),onClick:$[1]||($[1]=P=>o(w).switchToTab("config")),disabled:!o(w).selectedTemplate},[g(o(f),{icon:"carbon:settings",width:"16"}),le(" "+s(a.$t("sidebar.configuration")),1)],10,Tt)]),o(w).currentTab==="list"?(r(),p("div",xt,[e("div",Dt,[e("button",{class:"new-task-btn",onClick:$[2]||($[2]=P=>o(w).createNewTemplate())},[g(o(f),{icon:"carbon:add",width:"16"}),le(" "+s(a.$t("sidebar.newPlan"))+" ",1),$[11]||($[11]=e("span",{class:"shortcut"},"⌘ K",-1))])]),e("div",Rt,[o(w).isLoading?(r(),p("div",Mt,[g(o(f),{icon:"carbon:circle-dash",width:"20",class:"spinning"}),e("span",null,s(a.$t("sidebar.loading")),1)])):o(w).errorMessage?(r(),p("div",At,[g(o(f),{icon:"carbon:warning",width:"20"}),e("span",null,s(o(w).errorMessage),1),e("button",{onClick:$[3]||($[3]=(...P)=>o(w).loadPlanTemplateList&&o(w).loadPlanTemplateList(...P)),class:"retry-btn"},s(a.$t("sidebar.retry")),1)])):o(w).planTemplateList.length===0?(r(),p("div",Nt,[g(o(f),{icon:"carbon:document",width:"32"}),e("span",null,s(a.$t("sidebar.noTemplates")),1)])):(r(!0),p(_e,{key:3},ke(o(w).sortedTemplates,P=>(r(),p("div",{key:P.id,class:ie(["sidebar-content-list-item",{"sidebar-content-list-item-active":P.id===o(w).currentPlanTemplateId}]),onClick:K=>o(w).selectTemplate(P)},[e("div",Ut,[g(o(f),{icon:"carbon:document",width:"20"})]),e("div",Lt,[e("div",qt,s(P.title||a.$t("sidebar.unnamedPlan")),1),e("div",Vt,s(q(P.description||a.$t("sidebar.noDescription"),40)),1)]),e("div",Bt,s(G(o(w).parseDateTime(P.updateTime||P.createTime))),1),e("div",Wt,[e("button",{class:"delete-task-btn",title:a.$t("sidebar.deleteTemplate"),onClick:re(K=>o(w).deleteTemplate(P),["stop"])},[g(o(f),{icon:"carbon:close",width:"16"})],8,jt)])],10,Ft))),128))])])):o(w).currentTab==="config"?(r(),p("div",Ot,[o(w).selectedTemplate?(r(),p("div",zt,[e("div",Ht,[e("div",Jt,[e("h3",null,s(o(w).selectedTemplate.title||a.$t("sidebar.unnamedPlan")),1),e("span",Gt,"ID: "+s(o(w).selectedTemplate.id),1)]),e("button",{class:"back-to-list-btn",onClick:$[4]||($[4]=P=>o(w).switchToTab("list"))},[g(o(f),{icon:"carbon:arrow-left",width:"16"})])]),e("div",Kt,[e("div",Xt,[g(o(f),{icon:"carbon:generate",width:"16"}),e("span",null,s(a.$t("sidebar.planGenerator")),1)]),e("div",Qt,[pe(e("textarea",{"onUpdate:modelValue":$[5]||($[5]=P=>o(w).generatorPrompt=P),class:"prompt-input",placeholder:a.$t("sidebar.generatorPlaceholder"),rows:"3"},null,8,Yt),[[ve,o(w).generatorPrompt]]),e("div",Zt,[e("button",{class:"btn btn-primary btn-sm",onClick:L,disabled:o(w).isGenerating||!o(w).generatorPrompt.trim()},[g(o(f),{icon:o(w).isGenerating?"carbon:circle-dash":"carbon:generate",width:"14",class:ie({spinning:o(w).isGenerating})},null,8,["icon","class"]),le(" "+s(o(w).isGenerating?a.$t("sidebar.generating"):a.$t("sidebar.generatePlan")),1)],8,en),e("button",{class:"btn btn-secondary btn-sm",onClick:y,disabled:o(w).isGenerating||!o(w).generatorPrompt.trim()||!o(w).jsonContent.trim()},[g(o(f),{icon:"carbon:edit",width:"14"}),le(" "+s(a.$t("sidebar.updatePlan")),1)],8,tn)])])]),e("div",nn,[e("div",sn,[g(o(f),{icon:"carbon:code",width:"16"}),e("span",null,s(a.$t("sidebar.jsonTemplate")),1),e("div",on,[e("button",{class:"btn btn-sm",onClick:$[6]||($[6]=(...P)=>o(w).rollbackVersion&&o(w).rollbackVersion(...P)),disabled:!o(w).canRollback,title:a.$t("sidebar.rollback")},[g(o(f),{icon:"carbon:undo",width:"14"})],8,an),e("button",{class:"btn btn-sm",onClick:$[7]||($[7]=(...P)=>o(w).restoreVersion&&o(w).restoreVersion(...P)),disabled:!o(w).canRestore,title:a.$t("sidebar.restore")},[g(o(f),{icon:"carbon:redo",width:"14"})],8,ln),e("button",{class:"btn btn-primary btn-sm",onClick:E,disabled:o(w).isGenerating||o(w).isExecuting},[g(o(f),{icon:"carbon:save",width:"14"})],8,cn)])]),pe(e("textarea",{"onUpdate:modelValue":$[8]||($[8]=P=>b.value=P),class:"json-editor",placeholder:a.$t("sidebar.jsonPlaceholder"),rows:"12"},null,8,rn),[[ve,b.value]])]),e("div",dn,[e("div",un,[g(o(f),{icon:"carbon:play",width:"16"}),e("span",null,s(a.$t("sidebar.executionController")),1)]),e("div",pn,[e("div",hn,[e("label",null,s(a.$t("sidebar.executionParams")),1),e("div",mn,s(a.$t("sidebar.executionParamsHelp")),1),e("div",vn,[pe(e("input",{"onUpdate:modelValue":$[9]||($[9]=P=>o(w).executionParams=P),class:"params-input",placeholder:a.$t("sidebar.executionParamsPlaceholder")},null,8,gn),[[ve,o(w).executionParams]]),e("button",{class:"clear-params-btn",onClick:$[10]||($[10]=(...P)=>o(w).clearExecutionParams&&o(w).clearExecutionParams(...P)),title:a.$t("sidebar.clearParams")},[g(o(f),{icon:"carbon:close",width:"12"})],8,fn)])]),e("div",bn,[e("span",$n,s(a.$t("sidebar.apiUrl"))+":",1),e("code",_n,s(o(w).computedApiUrl),1)]),e("div",yn,[e("span",kn,s(a.$t("sidebar.statusApiUrl"))+":",1),$[12]||($[12]=e("code",{class:"api-url"},"/api/executor/details/{planId}",-1))]),e("button",{class:"btn btn-primary execute-btn",onClick:M,disabled:o(w).isExecuting||o(w).isGenerating},[g(o(f),{icon:o(w).isExecuting?"carbon:circle-dash":"carbon:play",width:"16",class:ie({spinning:o(w).isExecuting})},null,8,["icon","class"]),le(" "+s(o(w).isExecuting?a.$t("sidebar.executing"):a.$t("sidebar.executePlan")),1)],8,Cn)])])])):F("",!0)])):F("",!0)])],2))}}),Pn=Te(wn,[["__scopeId","data-v-b3ed0b42"]]);class Be{static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}static async getMemories(){try{const t=await fetch(`${this.BASE_URL}`);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get memory list:",t),t}}static async getMemory(t){try{const n=await fetch(`${this.BASE_URL}/single?memoryId=${t}`);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get memory :",n),n}}static async update(t,n){try{const c=await fetch(`${this.BASE_URL}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({memoryId:t,memoryName:n})});return await(await this.handleResponse(c)).json()}catch(c){throw console.error("Failed to update memory:",c),c}}static async delete(t){try{const n=await fetch(`${this.BASE_URL}/delete?memoryId=${t}`);await this.handleResponse(n)}catch(n){throw console.error("Failed to update memory:",n),n}}}me(Be,"BASE_URL","/api/memories");class Sn{constructor(){me(this,"isCollapsed",!1);me(this,"selectMemoryId","");me(this,"loadMessages",()=>{});me(this,"intervalId")}toggleSidebar(){this.isCollapsed=!this.isCollapsed,this.isCollapsed?(this.loadMessages(),this.intervalId=window.setInterval(()=>{this.loadMessages()},3e3)):clearInterval(this.intervalId)}selectMemory(t){this.toggleSidebar(),this.selectMemoryId=t}setMemory(t){this.selectMemoryId=t}defaultMemoryId(){this.selectMemoryId=this.generateRandomId()}clearMemoryId(){this.selectMemoryId=""}generateRandomId(){return Math.random().toString(36).substring(2,10)}setLoadMessages(t){this.loadMessages=t}}const Se=He(new Sn),En={key:0,class:"app-container"},In={class:"app-content"},Tn={class:"header"},xn={class:"relative"},Dn={class:"title-edit-group"},Rn={id:"main-title",class:"main-title"},Mn={key:0,id:"title-edit-container",class:"title-edit-container"},An={class:"search-bar"},Nn={class:"search-container"},Fn=["placeholder"],Un={class:"message-list",id:"message-list"},Ln={class:"message-header"},qn={class:"message-content"},Vn={class:"sender-info"},Bn=["onClick"],Wn={class:"sender-name"},jn=["onClick"],On={class:"action-buttons"},zn=["onClick"],Hn={class:"action-buttons"},Jn=["onClick"],Gn={class:"message-preview"},Kn={class:"preview-line"},Xn={key:0,class:"preview-line",style:{opacity:"0.8"}},Qn={class:"message-meta"},Yn={class:"message-id"},Zn={class:"meta-right"},es={key:0,class:"unread-count"},ts={class:"message-time"},ns=["id"],ss={style:{display:"flex","flex-direction":"column",gap:"0.75rem"}},os={class:"bubble-avatar"},as={class:"bubble-content"},ls={class:"bubble-text"},is={key:0,class:"empty-state"},cs={class:"modal-content"},rs={class:"modal-header"},ds={class:"modal-title"},us=["placeholder"],ps={id:"name-char-count",class:"char-count",style:{"text-align":"right",display:"block","margin-top":"0.25rem"}},hs={class:"modal-footer"},ms={class:"modal-content"},vs={class:"modal-header"},gs={class:"modal-title"},fs={class:"state-text",id:"delete-message"},bs={class:"modal-footer"},$s=Ie({__name:"index",emits:["memory-selected"],setup(T,{emit:t}){const n=S(!1),c=S(""),m=S([]),b=S([]),d=S(!1),E=S(null),L=S(""),y=S(!1),M=S(null),G=new Map,q=t;xe(()=>{Se.setLoadMessages(a)});const a=async()=>{try{const x=await Be.getMemories();m.value?m.value=x.map(V=>({...V,expanded:G.has(V.memoryId)?G.get(V.memoryId):!1})):m.value=x.map(V=>({...V,expanded:!1})),b.value=[...m.value],K()}catch(x){console.error("error:",x),m.value=[],b.value=[]}},$=x=>{Se.selectMemory(x),q("memory-selected")},P=x=>{const V=typeof x=="string"?parseInt(x,10):x;return isNaN(V)||V<=0?"unknow time":new Date(V.toString().length===13?V:V*1e3).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(","," ")},K=()=>{const x=c.value.toLowerCase().trim();if(!x){b.value=[...m.value];return}b.value=m.value.filter(V=>{const U=V.memoryName.toLowerCase().includes(x),te=V.memoryId.toLowerCase().includes(x),Pe=V.messages.some(k=>k.text.toLowerCase().includes(x));return U||te||Pe})},I=(x,V)=>{E.value=x,L.value=V,d.value=!0},D=()=>{d.value=!1,E.value=null},j=async()=>{if(!E.value)return;const x=L.value.trim()||"unknow name",V=m.value.findIndex(U=>U.memoryId===E.value);if(V!==-1){const U=m.value[V];try{const te=await Be.update(U.memoryId,x);te.messages||(te.messages=[]),m.value[V]={...te,expanded:U.expanded},K(),d.value=!1}catch(te){console.error("error:",te)}}},Q=x=>{const V=m.value.find(U=>U.memoryId===x);if(V){V.expanded=!V.expanded,G.set(x,V.expanded);const U=b.value.findIndex(te=>te.memoryId===x);U!==-1&&(b.value[U]={...V})}},A=x=>{M.value=x,y.value=!0},oe=()=>{y.value=!1,M.value=null},ce=async()=>{if(M.value)try{await Be.delete(M.value),m.value=m.value.filter(x=>x.memoryId!==M.value),K(),m.value.length===0&&Se.clearMemoryId(),y.value=!1,M.value=null}catch(x){console.error("error:",x)}};return(x,V)=>(r(),$e(Ve,{to:"body"},[g(Le,{name:"modal"},{default:qe(()=>[o(Se).isCollapsed?(r(),p("div",En,[e("div",In,[e("div",Tn,[e("div",xn,[e("div",Dn,[e("h1",Rn,[e("span",null,s(x.$t("memory.title")),1)])]),n.value?(r(),p("div",Mn)):F("",!0)]),e("button",{class:"close-btn",onClick:V[0]||(V[0]=U=>o(Se).toggleSidebar())},[g(o(f),{icon:"carbon:close"})])]),e("div",An,[e("div",Nn,[g(o(f),{class:"search-container-icon",icon:"carbon:search"}),pe(e("input",{type:"text",placeholder:x.$t("memory.searchPlaceholder"),class:"search-input","onUpdate:modelValue":V[1]||(V[1]=U=>c.value=U),onInput:K},null,40,Fn),[[ve,c.value]])])]),e("div",Un,[e("div",null,[(r(!0),p(_e,null,ke(b.value,U=>(r(),p("div",{class:ie(["message-item",{expanded:U.expanded}]),key:U.memoryId},[e("div",Ln,[e("div",qn,[e("div",Vn,[e("div",{class:"sender-div",onClick:re(te=>$(U.memoryId),["stop"])},[e("h3",Wn,s(U.memoryName),1)],8,Bn),e("div",{class:"toggle-container",onClick:re(te=>I(U.memoryId,U.memoryName),["stop"])},[g(o(f),{icon:"carbon:edit",class:"edit-btn"})],8,jn),e("div",On,[e("button",{class:"delete-btn",onClick:re(te=>Q(U.memoryId),["stop"])},[g(o(f),{id:"toggle-"+U.memoryId,icon:"carbon:chevron-down",class:"down-btn"},null,8,["id"])],8,zn)]),e("div",Hn,[e("button",{class:"delete-btn",onClick:re(te=>A(U.memoryId),["stop"])},[g(o(f),{icon:"carbon:delete"})],8,Jn)])]),e("div",Gn,[e("p",Kn,s(U.messages.length>0?U.messages[0].text:"none message"),1),U.messages.length>1?(r(),p("p",Xn,s(U.messages[1].text),1)):F("",!0)]),e("div",Qn,[e("span",Yn,"ID: "+s(U.memoryId),1),e("div",Zn,[U.messages.length>0?(r(),p("span",es,s(U.messages.length)+" "+s(x.$t("memory.size")),1)):F("",!0),e("span",ts,s(P(U.createTime)),1)])])])]),U.expanded?(r(),p("div",{key:0,id:"content-"+U.memoryId,class:"expanded-content"},[e("div",ss,[(r(!0),p(_e,null,ke(U.messages,(te,Pe)=>(r(),p("div",{class:"message-bubble",key:Pe},[e("div",os,s(te.messageType),1),e("div",as,[e("p",ls,s(te.text),1)])]))),128))])],8,ns)):F("",!0)],2))),128))]),b.value.length===0&&c.value?(r(),p("div",is,V[3]||(V[3]=[e("p",{class:"state-text"},"none message",-1)]))):F("",!0)]),d.value?(r(),p("div",{key:0,id:"name-edit-modal",class:"modal-overlay",onClick:re(D,["self"])},[e("div",cs,[e("div",rs,[e("h3",ds,s(x.$t("memory.changeName")),1),pe(e("input",{type:"text","onUpdate:modelValue":V[2]||(V[2]=U=>L.value=U),class:"edit-input",placeholder:x.$t("memory.newNamePlaceholder")},null,8,us),[[ve,L.value]]),e("span",ps,s(L.value.length),1)]),e("div",hs,[e("button",{id:"cancel-name",class:"modal-btn cancel-btn",onClick:D},s(x.$t("memory.cancel")),1),e("button",{id:"save-name",class:"modal-btn confirm-btn",onClick:j},s(x.$t("memory.save")),1)])])])):F("",!0),y.value?(r(),p("div",{key:1,id:"delete-modal",class:"modal-overlay",onClick:re(oe,["self"])},[e("div",ms,[e("div",vs,[e("h3",gs,s(x.$t("memory.deleteHint")),1),e("p",fs,s(x.$t("memory.deleteHintPrefix"))+" "+s(M.value)+" "+s(x.$t("memory.deleteHintSuffix")),1)]),e("div",bs,[e("button",{id:"cancel-delete",class:"modal-btn cancel-btn",onClick:oe},s(x.$t("memory.cancel")),1),e("button",{id:"confirm-delete",class:"modal-btn delete-btn-confirm",onClick:ce},s(x.$t("memory.delete")),1)])])])):F("",!0)])])):F("",!0)]),_:1})]))}}),_s=Te($s,[["__scopeId","data-v-51743a89"]]);class Je{static async sendMessage(t){return yt.withLlmCheck(async()=>{const n=await fetch(`${this.BASE_URL}/execute`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`API request failed: ${n.status}`);return await n.json()})}}me(Je,"BASE_URL","/api/executor");class Ge{static async getDetails(t){try{const n=await fetch(`${this.BASE_URL}/details/${t}`);if(n.status===404)return null;if(!n.ok){const b=await n.text();throw new Error(`Failed to get detailed information: ${n.status} - ${b}`)}const c=await n.text(),m=JSON.parse(c);return m&&typeof m=="object"&&!m.currentPlanId&&(m.currentPlanId=t),m}catch(n){return console.error("[CommonApiService] Failed to get plan details:",n),{currentPlanId:t,status:"failed",message:n instanceof Error?n.message:"Failed to save, please retry"}}}static async submitFormInput(t,n){const c=await fetch(`${this.BASE_URL}/submit-input/${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!c.ok){let b;try{b=await c.json()}catch{b={message:`Failed to submit form input: ${c.status}`}}throw new Error(b.message||`Failed to submit form input: ${c.status}`)}const m=c.headers.get("content-type");return m&&m.indexOf("application/json")!==-1?await c.json():{success:!0}}static async getAllPrompts(){try{const t=await fetch(this.BASE_URL);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get Prompt list:",t),t}}static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}}me(Ge,"BASE_URL","/api/executor");const Me=class Me{constructor(){me(this,"POLL_INTERVAL",5e3);me(this,"state",He({activePlanId:null,lastSequenceSize:0,isPolling:!1,pollTimer:null}));me(this,"callbacks",{});me(this,"planExecutionCache",new Map);me(this,"uiStateCache",new Map);console.log("[PlanExecutionManager] Initialized with callback-based event system")}getCachedPlanRecord(t){return this.planExecutionCache.get(t)}getCachedUIState(t){return this.uiStateCache.get(t)}setCachedUIState(t,n){this.uiStateCache.set(t,n),console.log(`[PlanExecutionManager] Cached UI state for rootPlanId: ${t}`)}getAllCachedRecords(){return new Map(this.planExecutionCache)}hasCachedPlanRecord(t){return this.planExecutionCache.has(t)}setCachedPlanRecord(t,n){this.planExecutionCache.set(t,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${t}`)}clearCachedPlanRecord(t){const n=this.planExecutionCache.delete(t);return n&&console.log(`[PlanExecutionManager] Cleared cached plan execution record for rootPlanId: ${t}`),n}clearAllCachedRecords(){const t=this.planExecutionCache.size,n=this.uiStateCache.size;this.planExecutionCache.clear(),this.uiStateCache.clear(),console.log(`[PlanExecutionManager] Cleared all caches - Plans: ${t}, UI States: ${n}`)}static getInstance(){return Me.instance||(Me.instance=new Me),Me.instance}getActivePlanId(){return this.state.activePlanId}getState(){return this.state}setEventCallbacks(t){this.callbacks={...this.callbacks,...t},console.log("[PlanExecutionManager] Event callbacks set:",Object.keys(t))}async handleUserMessageSendRequested(t){if(this.validateAndPrepareUIForNewRequest(t))try{if(await this.sendUserMessageAndSetPlanId(t),this.state.activePlanId)this.initiatePlanExecutionSequence(t,this.state.activePlanId);else throw new Error("Failed to get valid plan ID")}catch(n){console.error("[PlanExecutionManager] Failed to send user message:",n);const c=this.state.activePlanId??"error";this.setCachedUIState(c,{enabled:!0}),this.emitChatInputUpdateState(c),this.state.activePlanId=null}}handlePlanExecutionRequested(t,n){console.log("[PlanExecutionManager] Received plan execution request:",{planId:t,query:n}),t?(this.state.activePlanId=t,this.initiatePlanExecutionSequence(n??"Execute Plan",t)):console.error("[PlanExecutionManager] Invalid plan execution request: missing planId")}handleCachedPlanExecution(t,n){const c=this.getCachedPlanRecord(t);return c!=null&&c.currentPlanId?(console.log(`[PlanExecutionManager] Found cached plan execution record for rootPlanId: ${t}`),this.handlePlanExecutionRequested(c.currentPlanId,n),!0):(console.log(`[PlanExecutionManager] No cached plan execution record found for rootPlanId: ${t}`),!1)}validateAndPrepareUIForNewRequest(t){if(!t)return console.warn("[PlanExecutionManager] Query is empty"),!1;if(this.state.activePlanId)return!1;this.emitChatInputClear();const n=this.state.activePlanId??"ui-state";return this.setCachedUIState(n,{enabled:!1,placeholder:"Processing..."}),this.emitChatInputUpdateState(n),!0}async sendUserMessageAndSetPlanId(t){try{const n=await Je.sendMessage({input:t});if(n!=null&&n.planId)return this.state.activePlanId=n.planId,n;if(n!=null&&n.planTemplateId)return this.state.activePlanId=n.planTemplateId,{...n,planId:n.planTemplateId};throw console.error("[PlanExecutionManager] Failed to get planId from response:",n),new Error("Failed to get valid planId from API response")}catch(n){throw console.error("[PlanExecutionManager] API call failed:",n),n}}initiatePlanExecutionSequence(t,n){console.log(`[PlanExecutionManager] Starting plan execution sequence for query: "${t}", planId: ${n}`);const c=n;this.emitDialogRoundStart(c),this.startPolling()}handlePlanCompletion(t){this.emitPlanCompleted(t.rootPlanId??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await je.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}},5e3)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}t.completed&&(this.state.activePlanId=null,this.emitChatInputUpdateState(t.rootPlanId??""))}handlePlanError(t){this.emitPlanError(t.message??""),this.state.lastSequenceSize=0,this.stopPolling();try{setTimeout(async()=>{if(this.state.activePlanId)try{await je.deletePlanTemplate(this.state.activePlanId),console.log(`[PlanExecutionManager] Plan template ${this.state.activePlanId} deleted successfully`)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}},5e3)}catch(n){console.log(`Delete plan execution record failed: ${n.message}`)}}async pollPlanStatus(){if(this.state.activePlanId){if(this.state.isPolling){console.log("[PlanExecutionManager] Previous polling still in progress, skipping");return}try{this.state.isPolling=!0;const t=await this.getPlanDetails(this.state.activePlanId);if(!t){console.warn("[PlanExecutionManager] No details received from API");return}if(t.status&&t.status==="failed"){this.handlePlanError(t);return}if(t.rootPlanId&&this.setCachedPlanRecord(t.rootPlanId,t),!t.steps||t.steps.length===0){console.log("[PlanExecutionManager] Simple response without steps detected, handling as completed"),this.emitPlanUpdate(t.rootPlanId??""),this.handlePlanCompletion(t);return}this.emitPlanUpdate(t.rootPlanId??""),t.completed&&this.handlePlanCompletion(t)}catch(t){console.error("[PlanExecutionManager] Failed to poll plan status:",t)}finally{this.state.isPolling=!1}}}async getPlanDetails(t){try{const n=await Ge.getDetails(t);return n!=null&&n.rootPlanId&&(this.planExecutionCache.set(n.rootPlanId,n),console.log(`[PlanExecutionManager] Cached plan execution record for rootPlanId: ${n.rootPlanId}`)),n}catch(n){return console.error("[PlanExecutionManager] Failed to get plan details:",n),{currentPlanId:t,status:"failed",message:n instanceof Error?n.message:"Failed to get plan"}}}startPolling(){this.state.pollTimer&&clearInterval(this.state.pollTimer),this.state.pollTimer=window.setInterval(()=>{this.pollPlanStatus()},this.POLL_INTERVAL),console.log("[PlanExecutionManager] Started polling")}async pollPlanStatusImmediately(){console.log("[PlanExecutionManager] Polling plan status immediately"),await this.pollPlanStatus()}stopPolling(){this.state.pollTimer&&(clearInterval(this.state.pollTimer),this.state.pollTimer=null),console.log("[PlanExecutionManager] Stopped polling")}cleanup(){this.stopPolling(),this.state.activePlanId=null,this.state.lastSequenceSize=0,this.state.isPolling=!1,this.clearAllCachedRecords()}emitChatInputClear(){this.callbacks.onChatInputClear&&this.callbacks.onChatInputClear()}emitChatInputUpdateState(t){this.callbacks.onChatInputUpdateState&&this.callbacks.onChatInputUpdateState(t)}emitDialogRoundStart(t){this.callbacks.onDialogRoundStart&&this.callbacks.onDialogRoundStart(t)}emitPlanUpdate(t){this.callbacks.onPlanUpdate&&this.callbacks.onPlanUpdate(t)}emitPlanCompleted(t){this.callbacks.onPlanCompleted&&this.callbacks.onPlanCompleted(t)}emitPlanError(t){this.callbacks.onPlanError&&this.callbacks.onPlanError(t)}};me(Me,"instance",null);let ze=Me;const ye=ze.getInstance();class Re{static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}static async getFileTree(t){try{const n=await fetch(`${this.BASE_URL}/tree/${t}`),m=await(await this.handleResponse(n)).json();if(!m.success)throw new Error(m.message||"Failed to get file tree");return m.data}catch(n){throw console.error("Failed to get file tree:",n),n}}static async getFileContent(t,n){try{const c=await fetch(`${this.BASE_URL}/content/${t}?path=${encodeURIComponent(n)}`),b=await(await this.handleResponse(c)).json();if(!b.success)throw new Error(b.message||"Failed to get file content");return b.data}catch(c){throw console.error("Failed to get file content:",c),c}}static async downloadFile(t,n,c){try{const m=await fetch(`${this.BASE_URL}/download/${t}?path=${encodeURIComponent(n)}`);await this.handleResponse(m);const b=await m.blob(),d=window.URL.createObjectURL(b),E=document.createElement("a");E.href=d,E.download=c||n.split("/").pop()||"download",document.body.appendChild(E),E.click(),window.URL.revokeObjectURL(d),document.body.removeChild(E)}catch(m){throw console.error("Failed to download file:",m),m}}static isTextFile(t,n){const c=["text/","application/json","application/xml","application/javascript","application/typescript"],m=[".txt",".md",".json",".xml",".html",".css",".js",".ts",".vue",".jsx",".tsx",".py",".java",".cpp",".c",".h",".sh",".bat",".yml",".yaml",".properties",".conf",".cfg"];if(c.some(d=>t.startsWith(d)))return!0;const b=n.toLowerCase();return m.some(d=>b.endsWith(d))}static getFileIcon(t){if(t.type==="directory")return"carbon:folder";const n=t.name.toLowerCase();return n.endsWith(".js")?"vscode-icons:file-type-js":n.endsWith(".ts")?"vscode-icons:file-type-typescript":n.endsWith(".vue")?"vscode-icons:file-type-vue":n.endsWith(".java")?"vscode-icons:file-type-java":n.endsWith(".py")?"vscode-icons:file-type-python":n.endsWith(".json")?"vscode-icons:file-type-json":n.endsWith(".xml")?"vscode-icons:file-type-xml":n.endsWith(".html")?"vscode-icons:file-type-html":n.endsWith(".css")?"vscode-icons:file-type-css":n.endsWith(".md")?"vscode-icons:file-type-markdown":n.endsWith(".yml")||n.endsWith(".yaml")?"vscode-icons:file-type-yaml":n.endsWith(".pdf")?"vscode-icons:file-type-pdf2":n.endsWith(".doc")||n.endsWith(".docx")?"vscode-icons:file-type-word":n.endsWith(".xls")||n.endsWith(".xlsx")?"vscode-icons:file-type-excel":n.endsWith(".ppt")||n.endsWith(".pptx")?"vscode-icons:file-type-powerpoint":n.match(/\.(jpg|jpeg|png|gif|bmp|svg)$/)?"carbon:image":n.match(/\.(zip|rar|7z|tar|gz)$/)?"carbon:archive":"carbon:document"}}me(Re,"BASE_URL","/api/file-browser");const ys={class:"file-tree-node"},ks={class:"node-icon"},Cs={class:"node-name"},ws={key:1,class:"file-size"},Ps={key:2,class:"node-actions"},Ss={key:0,class:"children"},Es=Ie({__name:"FileTreeNode",props:{node:{},level:{}},emits:["file-selected","download-file"],setup(T,{emit:t}){const n=T,c=t,m=S(n.level===0),b=S(!1),d=S(!1),E=S({}),L=()=>{n.node.type==="directory"&&(m.value=!m.value)},y=()=>{n.node.type==="directory"?L():M()},M=()=>{n.node.type==="file"&&c("file-selected",n.node),a()},G=()=>{c("download-file",n.node),a()},q=I=>{I.preventDefault(),d.value=!0,E.value={position:"fixed",top:`${I.clientY}px`,left:`${I.clientX}px`,zIndex:1e3},setTimeout(()=>{document.addEventListener("click",a)},0)},a=()=>{d.value=!1,document.removeEventListener("click",a)},$=async()=>{try{await navigator.clipboard.writeText(n.node.path)}catch(I){console.error("Failed to copy path:",I)}a()},P=()=>n.node.type==="directory"?m.value?"carbon:folder-open":"carbon:folder":Re.getFileIcon(n.node),K=I=>{if(I===0)return"0 B";const D=1024,j=["B","KB","MB","GB"],Q=Math.floor(Math.log(I)/Math.log(D));return parseFloat((I/Math.pow(D,Q)).toFixed(1))+" "+j[Q]};return De(()=>{document.removeEventListener("click",a)}),(I,D)=>{const j=bt("FileTreeNode",!0);return r(),p("div",ys,[e("div",{class:ie(["node-content",{"is-directory":I.node.type==="directory","is-file":I.node.type==="file","is-expanded":m.value}]),style:We({paddingLeft:`${I.level*16+12}px`}),onClick:y,onContextmenu:re(q,["prevent"])},[I.node.type==="directory"?(r(),p("div",{key:0,class:"expand-icon",onClick:re(L,["stop"])},[g(o(f),{icon:m.value?"carbon:chevron-down":"carbon:chevron-right",class:"chevron-icon"},null,8,["icon"])])):F("",!0),e("div",ks,[g(o(f),{icon:P()},null,8,["icon"])]),e("span",Cs,s(I.node.name),1),I.node.type==="file"?(r(),p("span",ws,s(K(I.node.size)),1)):F("",!0),b.value?(r(),p("div",Ps,[I.node.type==="file"?(r(),p("button",{key:0,onClick:D[0]||(D[0]=re(Q=>I.$emit("download-file",I.node),["stop"])),class:"action-btn download-btn",title:"Download"},[g(o(f),{icon:"carbon:download"})])):F("",!0)])):F("",!0)],38),I.node.type==="directory"&&m.value&&I.node.children?(r(),p("div",Ss,[(r(!0),p(_e,null,ke(I.node.children,Q=>(r(),$e(j,{key:Q.path,node:Q,level:I.level+1,onFileSelected:D[1]||(D[1]=A=>I.$emit("file-selected",A)),onDownloadFile:D[2]||(D[2]=A=>I.$emit("download-file",A))},null,8,["node","level"]))),128))])):F("",!0),d.value?(r(),p("div",{key:1,class:"context-menu",style:We(E.value),onClick:D[3]||(D[3]=re(()=>{},["stop"]))},[e("div",{class:"context-menu-item",onClick:M},[g(o(f),{icon:"carbon:view"}),D[4]||(D[4]=e("span",null,"Open",-1))]),I.node.type==="file"?(r(),p("div",{key:0,class:"context-menu-item",onClick:G},[g(o(f),{icon:"carbon:download"}),D[5]||(D[5]=e("span",null,"Download",-1))])):F("",!0),D[7]||(D[7]=e("div",{class:"context-menu-divider"},null,-1)),e("div",{class:"context-menu-item",onClick:$},[g(o(f),{icon:"carbon:copy"}),D[6]||(D[6]=e("span",null,"Copy Path",-1))])],4)):F("",!0)])}}}),Is=Te(Es,[["__scopeId","data-v-4c2c30c7"]]),Ts={class:"file-browser"},xs={class:"file-browser-header"},Ds={class:"header-actions"},Rs=["disabled","title"],Ms={class:"file-browser-content"},As={class:"file-tree-panel"},Ns={key:0,class:"loading-state"},Fs={key:1,class:"error-state"},Us={key:0,class:"waiting-for-files"},Ls={class:"message-content"},qs={class:"tips"},Vs=["disabled"],Bs={key:1,class:"actual-error"},Ws={key:2,class:"empty-state"},js={key:3,class:"file-tree"},Os={key:0,class:"file-content-panel"},zs={class:"file-content-header"},Hs={class:"file-info"},Js={class:"file-name"},Gs={class:"file-size"},Ks={class:"file-actions"},Xs=["title"],Qs=["title"],Ys={class:"file-content-body"},Zs={key:0,class:"loading-content"},eo={key:1,class:"content-error"},to={key:2,class:"file-content"},no={key:0,class:"text-content"},so={key:1,class:"binary-content"},oo=Ie({__name:"index",props:{planId:{}},setup(T){const t=T,{t:n}=Ae(),c=S(!1),m=S(null),b=S(null),d=S(null),E=S(null),L=S(!1),y=S(null),M=S(null),G=we(()=>!E.value||!d.value?!1:Re.isTextFile(E.value.mimeType,d.value.name)),q=we(()=>m.value&&(m.value.includes("Plan directory not found")||m.value.includes("not found"))),a=()=>{M.value&&(clearTimeout(M.value),M.value=null)},$=()=>{a(),M.value=window.setTimeout(()=>{q.value&&P()},5e3)},P=async()=>{if(t.planId){c.value=!0,m.value=null,a();try{b.value=await Re.getFileTree(t.planId)}catch(A){m.value=A instanceof Error?A.message:n("fileBrowser.loadError"),console.error("Failed to load file tree:",A);const oe=A instanceof Error?A.message:"";(oe.includes("Plan directory not found")||oe.includes("not found"))&&$()}finally{c.value=!1}}},K=async A=>{if(A.type!=="directory"){d.value=A,E.value=null,L.value=!0,y.value=null;try{E.value=await Re.getFileContent(t.planId,A.path)}catch(oe){y.value=oe instanceof Error?oe.message:n("fileBrowser.contentLoadError"),console.error("Failed to load file content:",oe)}finally{L.value=!1}}},I=async A=>{try{await Re.downloadFile(t.planId,A.path,A.name)}catch(oe){console.error("Failed to download file:",oe)}},D=()=>{d.value=null,E.value=null,y.value=null},j=A=>Re.getFileIcon(A),Q=A=>{if(A===0)return"0 B";const oe=1024,ce=["B","KB","MB","GB"],x=Math.floor(Math.log(A)/Math.log(oe));return parseFloat((A/Math.pow(oe,x)).toFixed(1))+" "+ce[x]};return Ee(()=>t.planId,A=>{A&&(d.value=null,E.value=null,P())},{immediate:!0}),xe(()=>{t.planId&&P()}),De(()=>{a()}),(A,oe)=>(r(),p("div",Ts,[e("div",xs,[e("h3",null,s(A.$t("fileBrowser.title")),1),e("div",Ds,[e("button",{class:"refresh-btn",onClick:P,disabled:c.value,title:A.$t("fileBrowser.refresh")},[g(o(f),{icon:"carbon:refresh",class:ie({rotating:c.value}),style:{color:"#ffffff",fontSize:"18px",width:"18px",height:"18px"}},null,8,["class"])],8,Rs)])]),e("div",Ms,[e("div",As,[c.value?(r(),p("div",Ns,[g(o(f),{icon:"carbon:loading",class:"rotating"}),e("span",null,s(A.$t("fileBrowser.loading")),1)])):m.value?(r(),p("div",Fs,[q.value?(r(),p("div",Us,[g(o(f),{icon:"carbon:time",class:"rotating"}),e("div",Ls,[e("h3",null,s(A.$t("fileBrowser.waitingForGeneration")),1),e("p",null,s(A.$t("fileBrowser.planExecuting")),1),e("div",qs,[g(o(f),{icon:"carbon:information"}),e("span",null,s(A.$t("fileBrowser.filesTip")),1)])]),e("button",{onClick:P,class:"retry-btn",disabled:c.value},[g(o(f),{icon:"carbon:refresh",class:ie({rotating:c.value})},null,8,["class"]),le(" "+s(c.value?A.$t("fileBrowser.checking"):A.$t("fileBrowser.checkNow")),1)],8,Vs)])):(r(),p("div",Bs,[g(o(f),{icon:"carbon:warning"}),e("span",null,s(m.value),1),e("button",{onClick:P,class:"retry-btn"},s(A.$t("fileBrowser.retry")),1)]))])):b.value?(r(),p("div",js,[g(Is,{node:b.value,level:0,onFileSelected:K,onDownloadFile:I},null,8,["node"])])):(r(),p("div",Ws,[g(o(f),{icon:"carbon:folder-off"}),e("span",null,s(A.$t("fileBrowser.noFiles")),1)]))]),d.value?(r(),p("div",Os,[e("div",zs,[e("div",Hs,[g(o(f),{icon:j(d.value)},null,8,["icon"]),e("span",Js,s(d.value.name),1),e("span",Gs,"("+s(Q(d.value.size))+")",1)]),e("div",Ks,[e("button",{onClick:oe[0]||(oe[0]=ce=>I(d.value)),class:"download-btn",title:A.$t("fileBrowser.download")},[g(o(f),{icon:"carbon:download"})],8,Xs),e("button",{onClick:D,class:"close-btn",title:A.$t("common.close")},[g(o(f),{icon:"carbon:close"})],8,Qs)])]),e("div",Ys,[L.value?(r(),p("div",Zs,[g(o(f),{icon:"carbon:loading",class:"rotating"}),e("span",null,s(A.$t("fileBrowser.loadingContent")),1)])):y.value?(r(),p("div",eo,[g(o(f),{icon:"carbon:warning"}),e("span",null,s(y.value),1)])):E.value?(r(),p("div",to,[G.value?(r(),p("div",no,[e("pre",null,[e("code",null,s(E.value.content),1)])])):(r(),p("div",so,[g(o(f),{icon:"carbon:document-unknown"}),e("p",null,s(A.$t("fileBrowser.binaryFile")),1),e("button",{onClick:oe[1]||(oe[1]=ce=>I(d.value)),class:"download-btn-large"},[g(o(f),{icon:"carbon:download"}),le(" "+s(A.$t("fileBrowser.downloadToView")),1)])]))])):F("",!0)])])):F("",!0)])]))}}),ao=Te(oo,[["__scopeId","data-v-2a488cd0"]]),lo={class:"right-panel"},io={class:"preview-header"},co={class:"preview-tabs"},ro={class:"preview-content"},uo={key:0,class:"step-details"},po={key:0,class:"step-info-fixed"},ho={key:0,class:"agent-info"},mo={class:"info-item"},vo={class:"label"},go={class:"value"},fo={class:"info-item"},bo={class:"label"},$o={class:"value"},_o={class:"info-item"},yo={class:"label"},ko={class:"value"},Co={class:"info-item"},wo={class:"label"},Po={class:"value"},So={class:"info-item"},Eo={class:"label"},Io={class:"execution-status"},To={class:"status-item"},xo={class:"status-text"},Do={key:0},Ro={key:0,class:"think-act-steps"},Mo={class:"steps-container"},Ao={class:"step-header"},No={class:"step-number"},Fo={class:"think-section"},Uo={class:"think-content"},Lo={class:"input"},qo={class:"label"},Vo={class:"output"},Bo={class:"label"},Wo={key:0,class:"action-section"},jo={class:"action-content"},Oo={class:"tool-info"},zo={class:"label"},Ho={class:"value"},Jo={class:"input"},Go={class:"label"},Ko={class:"output"},Xo={class:"label"},Qo={key:0,class:"sub-plan-section"},Yo={class:"sub-plan-content"},Zo={class:"sub-plan-header"},ea={class:"sub-plan-info"},ta={class:"label"},na={class:"value"},sa={key:0,class:"sub-plan-info"},oa={class:"label"},aa={class:"value"},la={class:"sub-plan-status"},ia={class:"status-text"},ca={key:0,class:"no-steps-message"},ra={key:1,class:"no-execution-message"},da={class:"step-basic-info"},ua={class:"info-item"},pa={class:"label"},ha={class:"value"},ma={key:0,class:"info-item"},va={class:"label"},ga={class:"value"},fa={class:"info-item"},ba={class:"label"},$a={class:"no-execution-hint"},_a={key:2,class:"execution-indicator"},ya={class:"execution-text"},ka={key:1,class:"no-selection"},Ca=["title"],wa={key:1,class:"file-browser-container"},Pa={key:1,class:"no-plan-message"},Sa={class:"message-content"},Ea={class:"tips"},Ia=Ie({__name:"index",props:{currentRootPlanId:{}},setup(T,{expose:t}){const n=T,{t:c}=Ae(),m=S(),b=S(),d=S(),E=S("details"),L=S(localStorage.getItem("jmanus-last-plan-id")),y=S(localStorage.getItem("jmanus-has-executed-plan")==="true"),M=S(null),G=S(!1),q=S(!0),a=S(!0),$=we(()=>d.value?d.value.completed?c("rightPanel.status.completed"):d.value.current?c("rightPanel.status.executing"):c("rightPanel.status.waiting"):""),P=we(()=>n.currentRootPlanId?n.currentRootPlanId:L.value),K=we(()=>!P.value&&!y.value),I=k=>{var X;if(console.log(`[RightPanel] updateDisplayedPlanProgress called with rootPlanId: ${k}`),d.value&&M.value){const H=M.value.rootPlanId??b.value;if(H&&H!==k){console.log(`[RightPanel] Plan ID mismatch - skipping update. Current: ${H}, Requested: ${k}`);return}}console.log(`[RightPanel] Plan ID validation passed - proceeding with update for rootPlanId: ${k}`);const N=ye.getCachedPlanRecord(k);if(!N){console.warn(`[RightPanel] Plan data not found for rootPlanId: ${k}`);return}if(N.steps&&N.steps.length>0){const H=N.steps.length,R=(N.currentStepIndex??0)+1;console.log(`[RightPanel] Progress: ${R} / ${H}`)}if(d.value&&b.value&&(b.value===k||((X=M.value)==null?void 0:X.rootPlanId)===k)&&(console.log(`[RightPanel] Refreshing selected step details for plan: ${k}`),M.value)){const R=M.value,O=j(R.planId,R.rootPlanId,R.subPlanId);O?(Q(O,R.stepIndex,R.planId,R.isSubPlan),V()):console.warn("[RightPanel] Could not find plan record for refresh:",R)}},D=(k,N,X,H,R)=>{console.log("[RightPanel] Step selected:",{planId:k,stepIndex:N,rootPlanId:X,subPlanId:H,subStepIndex:R});const O=!!(X&&H&&R!==void 0);M.value={planId:k,stepIndex:N,isSubPlan:O,...O&&{rootPlanId:X,subPlanId:H,subStepIndex:R}};const _=j(k,X,H);if(!_){console.warn("[RightPanel] Plan data not found:",{planId:k,rootPlanId:X,subPlanId:H}),d.value=null,M.value=null;return}Q(_,N,k,O)},j=(k,N,X)=>{var O;if(!N||!X)return ye.getCachedPlanRecord(k)??null;const H=ye.getCachedPlanRecord(k);if(H)return H;const R=ye.getCachedPlanRecord(N);if(!(R!=null&&R.agentExecutionSequence))return null;for(const _ of R.agentExecutionSequence)if(_.thinkActSteps){for(const h of _.thinkActSteps)if(((O=h.subPlanExecutionRecord)==null?void 0:O.currentPlanId)===X)return h.subPlanExecutionRecord}return null},Q=(k,N,X,H)=>{var z,de,fe,be,i;if(!k.steps||N>=k.steps.length){d.value=null,M.value=null,console.warn("[RightPanel] Invalid step data:",{planId:X,stepIndex:N,hasSteps:!!k.steps,stepsLength:(z=k.steps)==null?void 0:z.length,message:"Invalid step index"});return}b.value=X;const R=k.steps[N],O=(de=k.agentExecutionSequence)==null?void 0:de[N];console.log("[RightPanel] Step data details:",{planId:X,stepIndex:N,step:R,hasAgentExecutionSequence:!!k.agentExecutionSequence,agentExecutionSequenceLength:(fe=k.agentExecutionSequence)==null?void 0:fe.length,agentExecution:O,hasThinkActSteps:!!(O!=null&&O.thinkActSteps),thinkActStepsLength:(be=O==null?void 0:O.thinkActSteps)==null?void 0:be.length,isSubPlan:H});const _=(O==null?void 0:O.status)==="FINISHED",h=!_&&N===k.currentStepIndex&&!k.completed,v={planId:X,index:N,title:typeof R=="string"?R:R.title||R.description||R.name||`${H?"Sub ":""}Step ${N+1}`,description:typeof R=="string"?R:R.description||R,completed:_,current:h};O&&(v.agentExecution=O),d.value=v,console.log("[RightPanel] Step details updated:",{planId:X,stepIndex:N,stepTitle:d.value.title,hasAgentExecution:!!O,hasThinkActSteps:(((i=O==null?void 0:O.thinkActSteps)==null?void 0:i.length)??0)>0,completed:_,current:h,planCurrentStep:k.currentStepIndex,planCompleted:k.completed,isSubPlan:H}),O!=null&&O.thinkActSteps&&O.thinkActSteps.forEach((l,u)=>{l.subPlanExecutionRecord&&console.log(`[RightPanel] Found sub-plan in thinkActStep ${u}:`,l.subPlanExecutionRecord)}),setTimeout(()=>{ce()},100),V()},A=(k,N,X,H)=>{console.log("[RightPanel] Sub plan step selected (delegating to unified handler):",{rootPlanId:k,subPlanId:N,stepIndex:X,subStepIndex:H}),D(N,H,k,N,H)},oe=k=>{m.value=k??void 0},ce=()=>{if(!m.value)return;const{scrollTop:k,scrollHeight:N,clientHeight:X}=m.value,H=N-k-X<50,R=N>X;q.value=H,G.value=R&&!H,H?a.value=!0:N-k-X>100&&(a.value=!1),console.log("[RightPanel] Scroll state check:",{scrollTop:k,scrollHeight:N,clientHeight:X,isAtBottom:H,hasScrollableContent:R,showButton:G.value,shouldAutoScroll:a.value})},x=()=>{m.value&&(m.value.scrollTo({top:m.value.scrollHeight,behavior:"smooth"}),ge(()=>{a.value=!0,ce()}))},V=()=>{!a.value||!m.value||ge(()=>{m.value&&(m.value.scrollTop=m.value.scrollHeight,console.log("[RightPanel] Auto scroll to bottom"))})},U=k=>{if(k===null||typeof k>"u"||k==="")return"N/A";try{const N=typeof k=="object"?k:JSON.parse(k);return JSON.stringify(N,null,2)}catch{return String(k)}},te=()=>{d.value=null,b.value=void 0,a.value=!0,m.value&&m.value.removeEventListener("scroll",ce)},Pe=()=>{const k=()=>{const N=m.value;return N?(oe(N),N.addEventListener("scroll",ce),a.value=!0,ce(),console.log("[RightPanel] Scroll listener initialized successfully"),!0):(console.log("[RightPanel] Scroll container not found, retrying..."),!1)};ge(()=>{k()||setTimeout(()=>{k()},100)})};return Ee(()=>n.currentRootPlanId,(k,N)=>{k&&k!==N?(L.value=k,y.value=!0,localStorage.setItem("jmanus-last-plan-id",k),localStorage.setItem("jmanus-has-executed-plan","true"),console.log("[RightPanel] New plan started:",k)):!k&&N&&console.log("[RightPanel] Plan execution finished, keeping last plan:",L.value)},{immediate:!0}),xe(()=>{console.log("[RightPanel] Component mounted"),ge(()=>{Pe()})}),De(()=>{console.log("[RightPanel] Component unmounting, cleaning up..."),M.value=null,te()}),t({updateDisplayedPlanProgress:I,handleStepSelected:D,handleSubPlanStepSelected:A}),(k,N)=>{var X,H;return r(),p("div",lo,[e("div",io,[e("div",co,[e("div",{class:ie(["tab-item",{active:E.value==="details"}]),onClick:N[0]||(N[0]=R=>E.value="details")},[g(o(f),{icon:"carbon:events"}),e("span",null,s(o(c)("rightPanel.stepExecutionDetails")),1)],2),e("div",{class:ie(["tab-item",{active:E.value==="files"}]),onClick:N[1]||(N[1]=R=>E.value="files")},[g(o(f),{icon:"carbon:folder"}),e("span",null,s(o(c)("fileBrowser.title")),1)],2)])]),e("div",ro,[E.value==="details"?(r(),p("div",uo,[d.value?(r(),p("div",po,[e("h3",null,s(d.value.title||d.value.description||o(c)("rightPanel.defaultStepTitle",{number:d.value.index+1})),1),d.value.agentExecution?(r(),p("div",ho,[e("div",mo,[e("span",vo,s(o(c)("rightPanel.executingAgent"))+":",1),e("span",go,s(d.value.agentExecution.agentName),1)]),e("div",fo,[e("span",bo,s(o(c)("rightPanel.description"))+":",1),e("span",$o,s(d.value.agentExecution.agentDescription||""),1)]),e("div",_o,[e("span",yo,s(o(c)("rightPanel.callingModel"))+":",1),e("span",ko,s(d.value.agentExecution.modelName),1)]),e("div",Co,[e("span",wo,s(o(c)("rightPanel.request"))+":",1),e("span",Po,s(d.value.agentExecution.agentRequest||""),1)]),e("div",So,[e("span",Eo,s(o(c)("rightPanel.executionResult"))+":",1),e("span",{class:ie(["value",{success:d.value.agentExecution.status==="FINISHED"}])},s(d.value.agentExecution.status||o(c)("rightPanel.executing")),3)])])):F("",!0),e("div",Io,[e("div",To,[d.value.completed?(r(),$e(o(f),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):d.value.current?(r(),$e(o(f),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})):(r(),$e(o(f),{key:2,icon:"carbon:time",class:"status-icon pending"})),e("span",xo,s($.value),1)])])])):F("",!0),e("div",{ref_key:"scrollContainer",ref:m,class:"step-details-scroll-container",onScroll:ce},[d.value?(r(),p("div",Do,[(X=d.value.agentExecution)!=null&&X.thinkActSteps&&d.value.agentExecution.thinkActSteps.length>0?(r(),p("div",Ro,[e("h4",null,s(o(c)("rightPanel.thinkAndActionSteps")),1),e("div",Mo,[(r(!0),p(_e,null,ke(d.value.agentExecution.thinkActSteps,(R,O)=>(r(),p("div",{key:O,class:"think-act-step"},[e("div",Ao,[e("span",No,"#"+s(O+1),1),e("span",{class:ie(["step-status",R.status])},s(R.status||o(c)("rightPanel.executing")),3)]),e("div",Fo,[e("h5",null,[g(o(f),{icon:"carbon:thinking"}),le(" "+s(o(c)("rightPanel.thinking")),1)]),e("div",Uo,[e("div",Lo,[e("span",qo,s(o(c)("rightPanel.input"))+":",1),e("pre",null,s(U(R.thinkInput)),1)]),e("div",Vo,[e("span",Bo,s(o(c)("rightPanel.output"))+":",1),e("pre",null,s(U(R.thinkOutput)),1)])])]),R.actionNeeded?(r(),p("div",Wo,[e("h5",null,[g(o(f),{icon:"carbon:play"}),le(" "+s(o(c)("rightPanel.action")),1)]),e("div",jo,[(r(!0),p(_e,null,ke(R.actToolInfoList,(_,h)=>(r(),p("div",{key:h},[e("div",Oo,[e("span",zo,s(o(c)("rightPanel.tool"))+":",1),e("span",Ho,s(_.name||""),1)]),e("div",Jo,[e("span",Go,s(o(c)("rightPanel.toolParameters"))+":",1),e("pre",null,s(U(_.parameters)),1)]),e("div",Ko,[e("span",Xo,s(o(c)("rightPanel.executionResult"))+":",1),e("pre",null,s(U(_.result)),1)])]))),128))]),R.subPlanExecutionRecord?(r(),p("div",Qo,[e("h5",null,[g(o(f),{icon:"carbon:tree-view"}),le(" "+s(o(c)("rightPanel.subPlan")),1)]),e("div",Yo,[e("div",Zo,[e("div",ea,[e("span",ta,s(k.$t("rightPanel.subPlanId"))+":",1),e("span",na,s(R.subPlanExecutionRecord.currentPlanId),1)]),R.subPlanExecutionRecord.title?(r(),p("div",sa,[e("span",oa,s(k.$t("rightPanel.title"))+":",1),e("span",aa,s(R.subPlanExecutionRecord.title),1)])):F("",!0),e("div",la,[R.subPlanExecutionRecord.completed?(r(),$e(o(f),{key:0,icon:"carbon:checkmark-filled",class:"status-icon success"})):(r(),$e(o(f),{key:1,icon:"carbon:in-progress",class:"status-icon progress"})),e("span",ia,s(R.subPlanExecutionRecord.completed?k.$t("rightPanel.status.completed"):k.$t("rightPanel.status.executing")),1)])])])])):F("",!0)])):F("",!0)]))),128))]),d.value.agentExecution&&!((H=d.value.agentExecution.thinkActSteps)!=null&&H.length)?(r(),p("div",ca,[e("p",null,s(o(c)("rightPanel.noStepDetails")),1)])):d.value.agentExecution?F("",!0):(r(),p("div",ra,[g(o(f),{icon:"carbon:information",class:"info-icon"}),e("h4",null,s(o(c)("rightPanel.stepInfo")),1),e("div",da,[e("div",ua,[e("span",pa,s(o(c)("rightPanel.stepName"))+":",1),e("span",ha,s(d.value.title||d.value.description||k.$t("rightPanel.stepNumber",{number:d.value.index+1})),1)]),d.value.description?(r(),p("div",ma,[e("span",va,s(k.$t("rightPanel.description"))+":",1),e("span",ga,s(d.value.description),1)])):F("",!0),e("div",fa,[e("span",ba,s(k.$t("rightPanel.status.label"))+":",1),e("span",{class:ie(["value",{"status-completed":d.value.completed,"status-current":d.value.current,"status-pending":!d.value.completed&&!d.value.current}])},s(d.value.completed?k.$t("rightPanel.status.completed"):d.value.current?k.$t("rightPanel.status.executing"):k.$t("rightPanel.status.pending")),3)])]),e("p",$a,s(o(c)("rightPanel.noExecutionInfo")),1)])),d.value.current&&!d.value.completed?(r(),p("div",_a,[N[2]||(N[2]=e("div",{class:"execution-waves"},[e("div",{class:"wave wave-1"}),e("div",{class:"wave wave-2"}),e("div",{class:"wave wave-3"})],-1)),e("p",ya,[g(o(f),{icon:"carbon:in-progress",class:"rotating-icon"}),le(" "+s(o(c)("rightPanel.stepExecuting")),1)])])):F("",!0)])):(r(),p("div",ka,[g(o(f),{icon:"carbon:events",class:"empty-icon"}),e("h3",null,s(o(c)("rightPanel.noStepSelected")),1),e("p",null,s(o(c)("rightPanel.selectStepHint")),1)]))])):F("",!0),g(Le,{name:"scroll-button"},{default:qe(()=>[G.value?(r(),p("button",{key:0,onClick:x,class:"scroll-to-bottom-btn",title:o(c)("rightPanel.scrollToBottom")},[g(o(f),{icon:"carbon:chevron-down"})],8,Ca)):F("",!0)]),_:1})],544)])):F("",!0),E.value==="files"?(r(),p("div",wa,[P.value?(r(),$e(ao,{key:0,"plan-id":P.value},null,8,["plan-id"])):K.value?(r(),p("div",Pa,[g(o(f),{icon:"carbon:folder-off"}),e("div",Sa,[e("h3",null,s(o(c)("fileBrowser.noFilesYet")),1),e("p",null,s(o(c)("fileBrowser.noPlanExecuting")),1),e("div",Ea,[g(o(f),{icon:"carbon:information"}),e("span",null,s(o(c)("fileBrowser.startTaskTip")),1)])])])):F("",!0)])):F("",!0)])])}}}),Ta=Te(Ia,[["__scopeId","data-v-1f1365f7"]]);function xa(){const T=ye,t=we(()=>T.getActivePlanId()),n=we(()=>T.getState()),c=we(()=>n.value.isPolling),m=we(()=>!!t.value),b=(y,M)=>{T.initiatePlanExecutionSequence(y,M)},d=()=>{T.stopPolling()},E=()=>{T.startPolling()},L=()=>{T.cleanup()};return De(()=>{L()}),{activePlanId:t,state:n,isPolling:c,hasActivePlan:m,startExecution:b,stopPolling:d,startPolling:E,cleanup:L}}const Da={class:"chat-container"},Ra={class:"message-content"},Ma={key:0,class:"user-message"},Aa={key:1,class:"assistant-message"},Na={key:0,class:"thinking-section"},Fa={class:"thinking-header"},Ua={class:"thinking-avatar"},La={class:"thinking-label"},qa={class:"thinking-content"},Va={key:0,class:"thinking"},Ba={key:1,class:"progress"},Wa={class:"progress-bar"},ja={class:"progress-text"},Oa={key:2,class:"steps-container"},za={class:"steps-title"},Ha=["onClick"],Ja={class:"section-header"},Ga={class:"step-icon"},Ka={class:"step-title"},Xa={key:0,class:"step-status current"},Qa={key:1,class:"step-status completed"},Ya={key:2,class:"step-status pending"},Za={key:0,class:"action-info"},el={class:"action-description"},tl={class:"action-icon"},nl={key:0,class:"tool-params"},sl={class:"param-label"},ol={class:"param-content"},al={key:1,class:"think-details"},ll={class:"think-header"},il={class:"think-label"},cl={class:"think-output"},rl={class:"think-content"},dl={key:1,class:"sub-plan-steps"},ul={class:"sub-plan-header"},pl={class:"sub-plan-title"},hl={class:"sub-plan-step-list"},ml=["onClick"],vl={class:"sub-step-indicator"},gl={class:"sub-step-icon"},fl={class:"sub-step-number"},bl={class:"sub-step-content"},$l={class:"sub-step-title"},_l={class:"sub-step-badge"},yl={key:2,class:"user-input-form-container"},kl={class:"user-input-message"},Cl={key:0,class:"form-description"},wl=["onSubmit"],Pl={key:0,class:"form-grid"},Sl=["for"],El=["id","name","placeholder","required","onUpdate:modelValue"],Il=["id","name","placeholder","required","onUpdate:modelValue"],Tl=["id","name","placeholder","required","onUpdate:modelValue"],xl=["id","name","placeholder","required","onUpdate:modelValue"],Dl=["id","name","placeholder","required","onUpdate:modelValue"],Rl=["id","name","required","onUpdate:modelValue"],Ml={value:""},Al=["value"],Nl=["id","name","placeholder","required","onUpdate:modelValue"],Fl={key:1,class:"form-group"},Ul={for:"form-input-genericInput"},Ll=["onUpdate:modelValue"],ql={type:"submit",class:"submit-user-input-btn"},Vl={key:3,class:"default-processing"},Bl={class:"processing-indicator"},Wl={class:"response-section"},jl={class:"response-header"},Ol={class:"response-avatar"},zl={class:"response-name"},Hl={class:"response-content"},Jl={key:0,class:"final-response"},Gl=["innerHTML"],Kl={key:1,class:"response-placeholder"},Xl={class:"typing-indicator"},Ql={class:"typing-text"},Yl={key:0,class:"message assistant"},Zl={class:"message-content"},ei={class:"assistant-message"},ti={class:"thinking-section"},ni={class:"thinking-header"},si={class:"thinking-avatar"},oi={class:"thinking-label"},ai={class:"thinking-content"},li={class:"default-processing"},ii={class:"processing-indicator"},ci={class:"response-section"},ri={class:"response-header"},di={class:"response-avatar"},ui={class:"response-name"},pi={class:"response-content"},hi={class:"response-placeholder"},mi={class:"typing-indicator"},vi={class:"typing-text"},gi=["title"],fi=Ie({__name:"index",props:{mode:{default:"plan"},initialPrompt:{default:""}},emits:["step-selected","sub-plan-step-selected"],setup(T,{expose:t,emit:n}){const c=T,m=n,{t:b}=Ae(),d=xa(),E=S(),L=S(!1),y=S([]),M=S(),G=S(!1),q=He({}),a=(i,l,u)=>{const C={id:Date.now().toString(),type:i,content:l,timestamp:new Date,...u};return i==="assistant"&&!C.thinking&&!C.content&&(C.thinking=b("chat.thinking")),y.value.push(C),C},$=i=>{const l=y.value[y.value.length-1];l.type==="assistant"&&Object.assign(l,i)},P=async i=>{try{L.value=!0;const l=a("assistant","",{thinking:b("chat.thinkingProcessing")}),u=await Je.sendMessage(i);if(u.planId)console.log("[ChatComponent] Received planId from direct execution:",u.planId),u.memoryId&&Se.setMemory(u.memoryId),l.planExecution||(l.planExecution={}),l.planExecution.currentPlanId=u.planId,ye.handlePlanExecutionRequested(u.planId,i.input),delete l.thinking,console.log("[ChatComponent] Started polling for plan execution updates");else{delete l.thinking;const C=K(u,i.input);l.content=C}}catch(l){console.error("Direct mode error:",l),$({content:I(l)})}finally{L.value=!1}},K=(i,l)=>i.result??i.message??i.content??"",I=i=>{const l=(i==null?void 0:i.message)??(i==null?void 0:i.toString())??b("chat.unknownError");return l.includes("network")||l.includes("timeout")?b("chat.networkError"):l.includes("auth")||l.includes("unauthorized")?b("chat.authError"):l.includes("invalid")||l.includes("format")||l.includes("parameter")?b("chat.formatError"):`${b("chat.unknownError")} (${l})`},D=(i=!1)=>{ge(()=>{if(E.value){const l=E.value;(i||l.scrollHeight-l.scrollTop-l.clientHeight<150)&&l.scrollTo({top:l.scrollHeight,behavior:i?"auto":"smooth"})}})},j=()=>{D(!0),G.value=!1},Q=()=>{if(E.value){const i=E.value,l=i.scrollHeight-i.scrollTop-i.clientHeight<150;G.value=!l&&y.value.length>0}},A=()=>{E.value&&E.value.addEventListener("scroll",Q)},oe=()=>{E.value&&E.value.removeEventListener("scroll",Q)},ce=i=>{a("user",i.input),c.mode==="plan"?console.log("[ChatComponent] Plan mode message sent, parent should handle:",i.input):P(i)},x=(i,l)=>{var Y;const u=((Y=i.planExecution)==null?void 0:Y.agentExecutionSequence)??[];return l<0||l>=u.length?"IDLE":u[l].status??"IDLE"},V=(i,l)=>{var u,C;if(!((u=i.planExecution)!=null&&u.currentPlanId)){console.warn("[ChatComponent] Cannot handle step click: missing currentPlanId");return}console.log("[ChatComponent] Step clicked:",{planId:i.planExecution.currentPlanId,stepIndex:l,stepTitle:(C=i.planExecution.steps)==null?void 0:C[l]}),m("step-selected",i.planExecution.currentPlanId,l)},U=(i,l)=>{var u;try{const C=(u=i.planExecution)==null?void 0:u.agentExecutionSequence;if(!(C!=null&&C.length))return console.log("[ChatComponent] No agentExecutionSequence found"),[];const Y=C[l];if(!Y)return console.log(`[ChatComponent] No agentExecution found for step ${l}`),[];if(!Y.thinkActSteps)return console.log(`[ChatComponent] No thinkActSteps found for step ${l}`),[];for(const J of Y.thinkActSteps)if(J.subPlanExecutionRecord)return console.log(`[ChatComponent] Found sub-plan for step ${l}:`,J.subPlanExecutionRecord),(J.subPlanExecutionRecord.steps??[]).map(Z=>typeof Z=="string"?Z:typeof Z=="object"&&Z!==null&&(Z.title||Z.description)||b("rightPanel.subStep"));return[]}catch(C){return console.warn("[ChatComponent] Error getting sub-plan steps:",C),[]}},te=(i,l,u)=>{var C;try{const Y=(C=i.planExecution)==null?void 0:C.agentExecutionSequence;if(!(Y!=null&&Y.length))return"pending";const J=Y[l];if(!J||!J.thinkActSteps)return"pending";let ue=null;for(const ee of J.thinkActSteps)if(ee.subPlanExecutionRecord){ue=ee.subPlanExecutionRecord;break}if(!ue)return"pending";const Z=ue.currentStepIndex;return ue.completed?"completed":Z==null?u===0?"current":"pending":u<Z?"completed":u===Z?"current":"pending"}catch(Y){return console.warn("[ChatComponent] Error getting sub-plan step status:",Y),"pending"}},Pe=(i,l,u)=>{var C,Y;try{const J=(C=i.planExecution)==null?void 0:C.agentExecutionSequence;if(!(J!=null&&J.length)){console.warn("[ChatComponent] No agentExecutionSequence data for sub-plan step click");return}const ue=J[l];if(!ue){console.warn("[ChatComponent] No agentExecution found for step",l);return}if(!ue.thinkActSteps){console.warn("[ChatComponent] No thinkActSteps found for step",l);return}let Z=null;for(const ee of ue.thinkActSteps)if(ee.subPlanExecutionRecord){Z=ee.subPlanExecutionRecord;break}if(!(Z!=null&&Z.currentPlanId)){console.warn("[ChatComponent] No sub-plan data for step click");return}m("sub-plan-step-selected",((Y=i.planExecution)==null?void 0:Y.currentPlanId)??"",Z.currentPlanId,l,u)}catch(J){console.error("[ChatComponent] Error handling sub-plan step click:",J)}},k=(i,l)=>{var C,Y,J,ue;if(!((C=i.planExecution)!=null&&C.steps))return;console.log("[ChatComponent] Starting to update step actions, steps count:",i.planExecution.steps.length,"execution sequence:",((Y=l.agentExecutionSequence)==null?void 0:Y.length)??0);const u=new Array(i.planExecution.steps.length).fill(null);if((J=l.agentExecutionSequence)!=null&&J.length){const Z=Math.min(l.agentExecutionSequence.length,i.planExecution.steps.length);for(let ee=0;ee<Z;ee++){const B=l.agentExecutionSequence[ee];if((ue=B.thinkActSteps)!=null&&ue.length){const ne=B.thinkActSteps[B.thinkActSteps.length-1];ne.actionDescription&&ne.toolParameters?(u[ee]={actionDescription:ne.actionDescription,toolParameters:typeof ne.toolParameters=="string"?ne.toolParameters:JSON.stringify(ne.toolParameters,null,2),thinkInput:ne.thinkInput??"",thinkOutput:ne.thinkOutput??"",status:l.currentStepIndex!==void 0&&ee<l.currentStepIndex?"completed":l.currentStepIndex!==void 0&&ee===l.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${ee} action set: ${u[ee].actionDescription}`)):(u[ee]={actionDescription:b("chat.thinking"),toolParameters:b("chat.waitingDecision"),thinkInput:ne.thinkInput??"",thinkOutput:ne.thinkOutput??"",status:l.currentStepIndex!==void 0&&ee===l.currentStepIndex?"current":"pending"},console.log(`[ChatComponent] Step ${ee} is thinking`))}else u[ee]={actionDescription:l.currentStepIndex!==void 0&&ee<l.currentStepIndex?b("chat.status.completed"):b("chat.status.pending"),toolParameters:b("chat.noToolParameters"),thinkInput:"",thinkOutput:"",status:l.currentStepIndex!==void 0&&ee<l.currentStepIndex?"completed":"pending"},console.log(`[ChatComponent] Step ${ee} has no execution details, status set to: ${u[ee].status}`)}}else console.log("[ChatComponent] No execution sequence data");i.stepActions=[...u],console.log("[ChatComponent] Step actions update completed:",JSON.stringify(u.map(Z=>Z==null?void 0:Z.actionDescription))),ge(()=>{console.log("[ChatComponent] UI update completed via reactivity")})},N=i=>{console.log("[ChatComponent] Starting dialog round with planId:",i),i&&(y.value.findIndex(u=>{var C;return((C=u.planExecution)==null?void 0:C.currentPlanId)===i&&u.type==="assistant"})===-1?(a("assistant","",{planExecution:{currentPlanId:i},thinking:b("chat.preparingExecution")}),console.log("[ChatComponent] Created new assistant message for planId:",i)):console.log("[ChatComponent] Found existing assistant message for planId:",i))},X=i=>{var J,ue,Z,ee;console.log("[ChatComponent] Processing plan update with rootPlanId:",i);const l=ye.getCachedPlanRecord(i);if(!l){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",i);return}if(console.log("[ChatComponent] Retrieved plan details from cache:",l),console.log("[ChatComponent] Plan steps:",l.steps),console.log("[ChatComponent] Plan completed:",l.completed),!l.currentPlanId){console.warn("[ChatComponent] Plan update missing currentPlanId");return}const u=y.value.findIndex(B=>{var ne;return((ne=B.planExecution)==null?void 0:ne.currentPlanId)===l.currentPlanId&&B.type==="assistant"});let C;if(u!==-1)C=y.value[u],console.log("[ChatComponent] Found existing assistant message for currentPlanId:",l.currentPlanId);else{console.warn("[ChatComponent] No existing assistant message found for currentPlanId:",l.currentPlanId),console.log("[ChatComponent] Current messages:",y.value.map(ne=>{var Ce;return{type:ne.type,planId:(Ce=ne.planExecution)==null?void 0:Ce.currentPlanId,content:ne.content.substring(0,50)}}));let B=-1;for(let ne=y.value.length-1;ne>=0;ne--)if(y.value[ne].type==="assistant"){B=ne;break}if(B!==-1)C=y.value[B],C.planExecution||(C.planExecution={}),C.planExecution.currentPlanId=l.currentPlanId,console.log("[ChatComponent] Using last assistant message and updating planExecution.currentPlanId to:",l.currentPlanId);else{console.error("[ChatComponent] No assistant message found at all, this should not happen");return}}if(C.planExecution||(C.planExecution={}),C.planExecution=JSON.parse(JSON.stringify(l)),!l.steps||l.steps.length===0){if(console.log("[ChatComponent] Handling simple response without steps"),l.completed){delete C.thinking;const B=l.summary??l.result??l.message??b("chat.executionCompleted");C.content=H(B),console.log("[ChatComponent] Set simple response content:",C.content)}else l.title&&(C.thinking=`${b("chat.thinkingExecuting",{title:l.title})}`);return}delete C.thinking;const Y=l.steps.map(B=>typeof B=="string"?B:typeof B=="object"&&B!==null&&(B.title||B.description)||b("chat.step"));if(C.planExecution&&(C.planExecution.steps=Y),l.agentExecutionSequence&&l.agentExecutionSequence.length>0){console.log("[ChatComponent] Found execution sequence data, count:",l.agentExecutionSequence.length),k(C,l);const B=l.currentStepIndex??0;if(B>=0&&B<l.agentExecutionSequence.length){const Ce=l.agentExecutionSequence[B].thinkActSteps;if(Ce&&Ce.length>0){const Ne=Ce[Ce.length-1];if(Ne.thinkOutput){const Oe=Ne.thinkOutput.length>150?Ne.thinkOutput.substring(0,150)+"...":Ne.thinkOutput;C.thinking=`${b("chat.thinking")}: ${Oe}`}}}}else if(C.planExecution){const B=C.planExecution.currentStepIndex??0,ne=(J=C.planExecution.steps)==null?void 0:J[B],Ce=typeof ne=="string"?ne:"";C.thinking=`${b("chat.thinkingExecuting",{title:Ce})}`}if(l.userInputWaitState&&C.planExecution?(console.log("[ChatComponent] User input required:",l.userInputWaitState),C.planExecution.userInputWaitState||(C.planExecution.userInputWaitState={}),C.planExecution.userInputWaitState={message:l.userInputWaitState.message??"",formDescription:l.userInputWaitState.formDescription??"",formInputs:((ue=l.userInputWaitState.formInputs)==null?void 0:ue.map(B=>({label:B.label,value:B.value||"",type:B.type||"text",required:B.required==="true"||B.required===!0,placeholder:B.placeholder||"",name:B.name||B.label,options:B.options||void 0})))??[]},q[Z=C.id]??(q[Z]={}),C.thinking=b("input.waiting")):(ee=C.planExecution)!=null&&ee.userInputWaitState&&delete C.planExecution.userInputWaitState,l.completed??l.status==="completed"){console.log("[ChatComponent] Plan is completed, updating final response"),delete C.thinking;let B="";l.summary?B=l.summary:l.result?B=l.result:B=b("chat.executionCompleted"),C.content=R(B),console.log("[ChatComponent] Updated completed message:",C.content)}ge(()=>{console.log("[ChatComponent] Plan update UI refresh completed via reactivity")})},H=i=>i?i.includes("I ")||i.includes("you")||i.includes("hello")||i.includes("can")||i.includes("I")||i.includes("you")||i.includes("can")?i:i.length<10?`${i}! ${b("chat.anythingElse")}`:i.length<50?`${b("chat.okayDone",{text:i})}. ${b("chat.ifOtherQuestions")}`:`${i}

${b("chat.hopeHelpful")} ${b("chat.anythingElse")}`:b("chat.defaultResponse"),R=i=>i?`${i}`:`${b("chat.executionCompleted")}! ${b("chat.anythingElse")}`,O=i=>{console.log("[ChatComponent] Plan completed with rootPlanId:",i);const l=ye.getCachedPlanRecord(i);if(!l){console.warn("[ChatComponent] No cached plan data found for rootPlanId:",i);return}if(console.log("[ChatComponent] Plan details:",l),l.rootPlanId){const u=y.value.findIndex(C=>{var Y;return((Y=C.planExecution)==null?void 0:Y.currentPlanId)===l.rootPlanId});if(u!==-1){const C=y.value[u];delete C.thinking;let J=l.summary??l.result??b("chat.executionCompleted");!J.includes("I")&&!J.includes("you")&&(J.includes("success")||J.includes("complete")||J.includes("finished")?J=`${b("chat.great")}${J}. ${b("chat.ifOtherHelp")}`:J=`${b("chat.completedRequest",{result:J})}`),C.content=J,console.log("[ChatComponent] Updated completed message:",C.content)}else console.warn("[ChatComponent] No message found for completed rootPlanId:",l.rootPlanId)}},_=i=>{L.value=!1,y.value[y.value.length-1]={id:Date.now().toString(),type:"assistant",content:i,timestamp:new Date}},h=i=>{if(!i)return"";let l=i.replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");return l=l.replace(/(<br><br>)/g,"</p><p>"),l.includes("</p><p>")&&(l=`<p>${l}</p>`),l},v=async i=>{var l;if(!((l=i.planExecution)!=null&&l.currentPlanId)||!i.planExecution.userInputWaitState){console.error("[ChatComponent] Missing planExecution.currentPlanId or userInputWaitState");return}try{const u={},C=i.planExecution.userInputWaitState.formInputs;C&&C.length>0?Object.entries(q[i.id]).forEach(([J,ue])=>{var B;const Z=parseInt(J,10),ee=((B=C[Z])==null?void 0:B.label)||`input_${J}`;u[ee]=ue}):u.genericInput=i.genericInput??"",console.log("[ChatComponent] Submitting user input:",u);const Y=await Ge.submitFormInput(i.planExecution.currentPlanId,u);delete i.planExecution.userInputWaitState,delete i.genericInput,delete q[i.id],d.startPolling(),console.log("[ChatComponent] User input submitted successfully:",Y)}catch(u){console.error("[ChatComponent] User input submission failed:",u),alert(`${b("common.submitFailed")}: ${(u==null?void 0:u.message)||b("common.unknownError")}`)}};Ee(()=>c.initialPrompt,(i,l)=>{console.log("[ChatComponent] initialPrompt changed from:",l,"to:",i),i&&typeof i=="string"&&i.trim()&&i!==l&&(console.log("[ChatComponent] Processing changed initial prompt:",i),ge(()=>{ce({input:i})}))},{immediate:!1}),xe(()=>{console.log("[ChatComponent] Mounted, setting up event listeners"),ye.setEventCallbacks({onPlanUpdate:X,onPlanCompleted:O,onDialogRoundStart:N,onChatInputUpdateState:i=>{console.log("[ChatComponent] Chat input state update for rootPlanId:",i)},onChatInputClear:()=>{console.log("[ChatComponent] Chat input clear requested")},onPlanError:_}),ge(()=>{A()}),c.initialPrompt&&typeof c.initialPrompt=="string"&&c.initialPrompt.trim()&&(console.log("[ChatComponent] Processing initial prompt:",c.initialPrompt),ge(()=>{ce({input:c.initialPrompt})}))}),De(()=>{console.log("[ChatComponent] Unmounting, cleaning up resources"),oe(),M.value&&clearInterval(M.value),d.cleanup(),Object.keys(q).forEach(i=>delete q[i])});const z=async()=>{if(Se.selectMemoryId){const i=await Be.getMemory(Se.selectMemoryId);y.value=[],i.messages.map(l=>{l.messageType.toLowerCase()==="user"&&a("user",l.text),l.messageType.toLowerCase()==="assistant"&&a("assistant",l.text)}),j()}},de=()=>{y.value=[]},fe=i=>i?Array.isArray(i)?i:typeof i=="string"?i.split(",").map(l=>l.trim()).filter(l=>l.length>0):[]:[],be=i=>typeof i=="boolean"?i:typeof i=="string"?i==="true":!1;return t({handleSendMessage:ce,handlePlanUpdate:X,handlePlanCompleted:O,handleDialogRoundStart:N,addMessage:a,handlePlanError:_,showMemory:z,newChat:de}),(i,l)=>(r(),p("div",Da,[e("div",{class:"messages",ref_key:"messagesRef",ref:E},[(r(!0),p(_e,null,ke(y.value,u=>{var C,Y,J,ue,Z,ee,B,ne,Ce;return r(),p("div",{key:u.id,class:ie(["message",{user:u.type==="user",assistant:u.type==="assistant"}])},[e("div",Ra,[u.type==="user"?(r(),p("div",Ma,s(u.content),1)):(r(),p("div",Aa,[u.thinking||((C=u.planExecution)==null?void 0:C.progress)!==void 0||(((J=(Y=u.planExecution)==null?void 0:Y.steps)==null?void 0:J.length)??0)>0?(r(),p("div",Na,[e("div",Fa,[e("div",Ua,[g(o(f),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",La,s(i.$t("chat.thinkingLabel")),1)]),e("div",qa,[u.thinking?(r(),p("div",Va,[g(o(f),{icon:"carbon:thinking",class:"thinking-icon"}),e("span",null,s(u.thinking),1)])):F("",!0),((ue=u.planExecution)==null?void 0:ue.progress)!==void 0?(r(),p("div",Ba,[e("div",Wa,[e("div",{class:"progress-fill",style:We({width:u.planExecution.progress+"%"})},null,4)]),e("span",ja,s(u.planExecution.progressText??i.$t("chat.processing")+"..."),1)])):F("",!0),(((ee=(Z=u.planExecution)==null?void 0:Z.steps)==null?void 0:ee.length)??0)>0?(r(),p("div",Oa,[e("h4",za,s(i.$t("chat.stepExecutionDetails")),1),(r(!0),p(_e,null,ke((B=u.planExecution)==null?void 0:B.steps,(Ne,se)=>{var Oe,Ke,Xe,Qe,Ye,Ze,et,tt,nt,st,ot,at,lt,it,ct,rt,dt,ut,pt;return r(),p("div",{key:se,class:ie(["ai-section",{running:x(u,se)==="RUNNING",completed:x(u,se)==="FINISHED",pending:x(u,se)==="IDLE"}]),onClick:re(W=>V(u,se),["stop"])},[e("div",Ja,[e("span",Ga,s(x(u,se)==="FINISHED"?"✓":x(u,se)==="RUNNING"?"▶":"○"),1),e("span",Ka,s(Ne||`${i.$t("chat.step")} ${se+1}`),1),x(u,se)==="RUNNING"?(r(),p("span",Xa,s(i.$t("chat.status.executing")),1)):x(u,se)==="FINISHED"?(r(),p("span",Qa,s(i.$t("chat.status.completed")),1)):(r(),p("span",Ya,s(i.$t("chat.status.pending")),1))]),u.stepActions&&u.stepActions[se]?(r(),p("div",Za,[e("div",el,[e("span",tl,s(((Oe=u.stepActions[se])==null?void 0:Oe.status)==="current"?"🔄":((Ke=u.stepActions[se])==null?void 0:Ke.status)==="completed"?"✓":"⏳"),1),e("strong",null,s((Xe=u.stepActions[se])==null?void 0:Xe.actionDescription),1)]),(Qe=u.stepActions[se])!=null&&Qe.toolParameters?(r(),p("div",nl,[l[0]||(l[0]=e("span",{class:"tool-icon"},"⚙️",-1)),e("span",sl,s(i.$t("common.parameters"))+":",1),e("pre",ol,s((Ye=u.stepActions[se])==null?void 0:Ye.toolParameters),1)])):F("",!0),(Ze=u.stepActions[se])!=null&&Ze.thinkOutput?(r(),p("div",al,[e("div",ll,[l[1]||(l[1]=e("span",{class:"think-icon"},"💭",-1)),e("span",il,s(i.$t("chat.thinkingOutput"))+":",1)]),e("div",cl,[e("pre",rl,s((et=u.stepActions[se])==null?void 0:et.thinkOutput),1)])])):F("",!0)])):F("",!0),((tt=U(u,se))==null?void 0:tt.length)>0?(r(),p("div",dl,[e("div",ul,[g(o(f),{icon:"carbon:tree-view",class:"sub-plan-icon"}),e("span",pl,s(i.$t("rightPanel.subPlan")),1)]),e("div",hl,[(r(!0),p(_e,null,ke(U(u,se),(W,ae)=>(r(),p("div",{key:`sub-${se}-${ae}`,class:ie(["sub-plan-step-item",{completed:te(u,se,ae)==="completed",current:te(u,se,ae)==="current",pending:te(u,se,ae)==="pending"}]),onClick:re(he=>Pe(u,se,ae),["stop"])},[e("div",vl,[e("span",gl,s(te(u,se,ae)==="completed"?"✓":te(u,se,ae)==="current"?"▶":"○"),1),e("span",fl,s(ae+1),1)]),e("div",bl,[e("span",$l,s(W),1),e("span",_l,s(i.$t("rightPanel.subStep")),1)])],10,ml))),128))])])):F("",!0),(nt=u.planExecution)!=null&&nt.userInputWaitState&&x(u,se)==="RUNNING"?(r(),p("div",yl,[e("p",kl,s(((ot=(st=u.planExecution)==null?void 0:st.userInputWaitState)==null?void 0:ot.message)??i.$t("chat.userInput.message")),1),(lt=(at=u.planExecution)==null?void 0:at.userInputWaitState)!=null&&lt.formDescription?(r(),p("p",Cl,s((ct=(it=u.planExecution)==null?void 0:it.userInputWaitState)==null?void 0:ct.formDescription),1)):F("",!0),e("form",{onSubmit:re(W=>v(u),["prevent"]),class:"user-input-form"},[(dt=(rt=u.planExecution)==null?void 0:rt.userInputWaitState)!=null&&dt.formInputs&&u.planExecution.userInputWaitState.formInputs.length>0?(r(),p("div",Pl,[(r(!0),p(_e,null,ke((pt=(ut=u.planExecution)==null?void 0:ut.userInputWaitState)==null?void 0:pt.formInputs,(W,ae)=>(r(),p("div",{key:ae,class:"form-group"},[e("label",{for:`form-input-${W.label.replace(/\W+/g,"_")}`},s(W.label)+s(be(W.required)?" *":"")+": ",9,Sl),!W.type||W.type==="text"?pe((r(),p("input",{key:0,type:"text",id:`form-input-${W.label.replace(/\W+/g,"_")}`,name:W.label,placeholder:W.placeholder||"",required:be(W.required),"onUpdate:modelValue":he=>q[u.id][ae]=he,class:"form-input"},null,8,El)),[[ve,q[u.id][ae]]]):W.type==="email"?pe((r(),p("input",{key:1,type:"email",id:`form-input-${W.label.replace(/\W+/g,"_")}`,name:W.label,placeholder:W.placeholder||"",required:be(W.required),"onUpdate:modelValue":he=>q[u.id][ae]=he,class:"form-input"},null,8,Il)),[[ve,q[u.id][ae]]]):W.type==="number"?pe((r(),p("input",{key:2,type:"number",id:`form-input-${W.label.replace(/\W+/g,"_")}`,name:W.label,placeholder:W.placeholder||"",required:be(W.required),"onUpdate:modelValue":he=>q[u.id][ae]=he,class:"form-input"},null,8,Tl)),[[ve,q[u.id][ae]]]):W.type==="password"?pe((r(),p("input",{key:3,type:"password",id:`form-input-${W.label.replace(/\W+/g,"_")}`,name:W.label,placeholder:W.placeholder||"",required:be(W.required),"onUpdate:modelValue":he=>q[u.id][ae]=he,class:"form-input"},null,8,xl)),[[ve,q[u.id][ae]]]):W.type==="textarea"?pe((r(),p("textarea",{key:4,id:`form-input-${W.label.replace(/\W+/g,"_")}`,name:W.label,placeholder:W.placeholder||"",required:be(W.required),"onUpdate:modelValue":he=>q[u.id][ae]=he,class:"form-input form-textarea",rows:"3"},null,8,Dl)),[[ve,q[u.id][ae]]]):W.type==="select"&&W.options?pe((r(),p("select",{key:5,id:`form-input-${W.label.replace(/\W+/g,"_")}`,name:W.label,required:be(W.required),"onUpdate:modelValue":he=>q[u.id][ae]=he,class:"form-input form-select"},[e("option",Ml,s(i.$t("selectCommon.pleaseSelect")),1),(r(!0),p(_e,null,ke(fe(W.options),he=>(r(),p("option",{key:he,value:he},s(he),9,Al))),128))],8,Rl)),[[ht,q[u.id][ae]]]):pe((r(),p("input",{key:6,type:"text",id:`form-input-${W.label.replace(/\W+/g,"_")}`,name:W.label,placeholder:W.placeholder||"",required:be(W.required),"onUpdate:modelValue":he=>q[u.id][ae]=he,class:"form-input"},null,8,Nl)),[[ve,q[u.id][ae]]])]))),128))])):(r(),p("div",Fl,[e("label",Ul,s(i.$t("common.input"))+":",1),pe(e("input",{type:"text",id:"form-input-genericInput",name:"genericInput","onUpdate:modelValue":W=>u.genericInput=W,class:"form-input"},null,8,Ll),[[ve,u.genericInput]])])),e("button",ql,s(i.$t("chat.userInput.submit")),1)],40,wl)])):F("",!0)],10,Ha)}),128))])):!u.content&&(u.thinking||((ne=u.planExecution)==null?void 0:ne.progress)!==void 0&&(((Ce=u.planExecution)==null?void 0:Ce.progress)??0)<100)?(r(),p("div",Vl,[e("div",Bl,[l[2]||(l[2]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,s(u.thinking??i.$t("chat.thinkingProcessing")),1)])])):F("",!0)])])):F("",!0),e("div",Wl,[e("div",jl,[e("div",Ol,[g(o(f),{icon:"carbon:bot",class:"bot-icon"})]),e("div",zl,s(i.$t("chat.botName")),1)]),e("div",Hl,[u.content?(r(),p("div",Jl,[e("div",{class:"response-text",innerHTML:h(u.content)},null,8,Gl)])):(r(),p("div",Kl,[e("div",Xl,[l[3]||(l[3]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",Ql,s(i.$t("chat.thinkingResponse")),1)])]))])])]))])],2)}),128)),L.value?(r(),p("div",Yl,[e("div",Zl,[e("div",ei,[e("div",ti,[e("div",ni,[e("div",si,[g(o(f),{icon:"carbon:thinking",class:"thinking-icon"})]),e("div",oi,s(i.$t("chat.thinkingLabel")),1)]),e("div",ai,[e("div",li,[e("div",ii,[l[4]||(l[4]=e("div",{class:"thinking-dots"},[e("span"),e("span"),e("span")],-1)),e("span",null,s(i.$t("chat.thinking")),1)])])])]),e("div",ci,[e("div",ri,[e("div",di,[g(o(f),{icon:"carbon:bot",class:"bot-icon"})]),e("div",ui,s(i.$t("chat.botName")),1)]),e("div",pi,[e("div",hi,[e("div",mi,[l[5]||(l[5]=e("div",{class:"typing-dots"},[e("span"),e("span"),e("span")],-1)),e("span",vi,s(i.$t("chat.thinkingResponse")),1)])])])])])])])):F("",!0)],512),G.value?(r(),p("div",{key:0,class:"scroll-to-bottom-btn",onClick:j,title:i.$t("chat.scrollToBottom")},[g(o(f),{icon:"carbon:chevron-down"})],8,gi)):F("",!0)]))}}),bi=Te(fi,[["__scopeId","data-v-d92d146c"]]),$i={class:"input-area"},_i={class:"input-container"},yi=["title"],ki=["placeholder","disabled"],Ci=["title"],wi=["disabled","title"],Pi=Ie({__name:"index",props:{placeholder:{default:""},disabled:{type:Boolean,default:!1},initialValue:{default:""}},emits:["send","clear","update-state","plan-mode-clicked"],setup(T,{expose:t,emit:n}){const{t:c}=Ae(),m=T,b=n,d=S(),E=S(""),L=we(()=>m.placeholder||c("input.placeholder")),y=S(L.value),M=we(()=>!!m.disabled),G=()=>{ge(()=>{d.value&&(d.value.style.height="auto",d.value.style.height=Math.min(d.value.scrollHeight,120)+"px")})},q=j=>{j.key==="Enter"&&!j.shiftKey&&(j.preventDefault(),a())},a=()=>{if(!E.value.trim()||M.value)return;const j={input:E.value.trim(),memoryId:Se.selectMemoryId};b("send",j),P()},$=()=>{b("plan-mode-clicked")},P=()=>{E.value="",G(),b("clear")},K=(j,Q)=>{Q&&(y.value=j?Q:c("input.waiting")),b("update-state",j,Q)},I=j=>{E.value=j,G()},D=()=>E.value.trim();return Ee(()=>m.initialValue,j=>{j&&j.trim()&&(E.value=j,G())},{immediate:!0}),t({clearInput:P,updateState:K,setInputValue:I,getQuery:D,focus:()=>{var j;return(j=d.value)==null?void 0:j.focus()}}),xe(()=>{}),De(()=>{}),(j,Q)=>(r(),p("div",$i,[e("div",_i,[e("button",{class:"attach-btn",title:j.$t("input.attachFile")},[g(o(f),{icon:"carbon:attachment"})],8,yi),pe(e("textarea",{"onUpdate:modelValue":Q[0]||(Q[0]=A=>E.value=A),ref_key:"inputRef",ref:d,class:"chat-input",placeholder:y.value,disabled:M.value,onKeydown:q,onInput:G},null,40,ki),[[ve,E.value]]),e("button",{class:"plan-mode-btn",title:j.$t("input.planMode"),onClick:$},[g(o(f),{icon:"carbon:document"}),le(" "+s(j.$t("input.planMode")),1)],8,Ci),e("button",{class:"send-button",disabled:!E.value.trim()||M.value,onClick:a,title:j.$t("input.send")},[g(o(f),{icon:"carbon:send-alt"}),le(" "+s(j.$t("input.send")),1)],8,wi)])]))}}),Si=Te(Pi,[["__scopeId","data-v-1cf73655"]]);class Fe{static async getAllCronTasks(){try{const t=await fetch(this.BASE_URL);return await(await this.handleResponse(t)).json()}catch(t){throw console.error("Failed to get cron tasks:",t),t}}static async getCronTaskById(t){try{const n=await fetch(`${this.BASE_URL}/${t}`);return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to get cron task by id:",n),n}}static async createCronTask(t){try{const n=await fetch(this.BASE_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return await(await this.handleResponse(n)).json()}catch(n){throw console.error("Failed to create cron task:",n),n}}static async updateCronTask(t,n){try{const c=await fetch(`${this.BASE_URL}/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});return await(await this.handleResponse(c)).json()}catch(c){throw console.error("Failed to update cron task:",c),c}}static async updateTaskStatus(t,n){try{const c=await fetch(`${this.BASE_URL}/${t}/status?status=${n}`,{method:"PUT"});await this.handleResponse(c)}catch(c){throw console.error("Failed to update task status:",c),c}}static async deleteCronTask(t){try{const n=await fetch(`${this.BASE_URL}/${t}`,{method:"DELETE"});await this.handleResponse(n)}catch(n){throw console.error("Failed to delete cron task:",n),n}}static async handleResponse(t){if(!t.ok)try{const n=await t.json();throw new Error(n.message||`API request failed: ${t.status}`)}catch{throw new Error(`API request failed: ${t.status} ${t.statusText}`)}return t}}me(Fe,"BASE_URL","/api/cron-tasks");const Ue={validateCronExpression(T){const t=T.trim().split(/\s+/);return t.length>=5&&t.length<=6},formatTime(T){return new Date(T).toLocaleString()},async saveTask(T){try{let t;return T.id?t=await Fe.updateCronTask(Number(T.id),T):t=await Fe.createCronTask(T),t}catch(t){throw console.error("Failed to save cron task:",t),t}},async deleteTask(T){try{await Fe.deleteCronTask(String(T))}catch(t){throw console.error("Failed to delete cron task:",t),t}},async toggleTaskStatus(T){if(!T.id)throw new Error("Task ID is required");const t=T.status===0?1:0;return await Fe.updateCronTask(Number(T.id),{...T,status:t})},prepareTaskExecution(T){return T.planTemplateId?{useTemplate:!0,planData:{title:T.cronName||"Scheduled Task Execution",planData:{id:T.planTemplateId,planTemplateId:T.planTemplateId,planId:T.planTemplateId},params:T.executionParams||void 0}}:{useTemplate:!1,taskContent:T.planDesc||T.cronName||""}}},Ei={class:"modal-header"},Ii={class:"header-actions"},Ti={class:"status-switch"},xi={class:"status-label"},Di={class:"toggle-switch"},Ri=["checked"],Mi={class:"modal-content"},Ai={class:"form-group"},Ni={class:"form-label"},Fi=["placeholder"],Ui={class:"form-group"},Li={class:"form-label"},qi=["placeholder"],Vi={class:"form-help"},Bi={class:"form-group"},Wi={class:"form-label"},ji=["placeholder"],Oi={class:"form-group"},zi={class:"form-label"},Hi={class:"template-toggle"},Ji={key:0,class:"template-selector"},Gi={value:""},Ki=["value"],Xi={class:"form-help"},Qi={key:0,class:"form-group"},Yi={class:"time-info"},Zi={class:"time-label"},ec={class:"time-value"},tc={key:1,class:"form-group"},nc={class:"time-info"},sc={class:"time-label"},oc={class:"time-value"},ac={class:"modal-footer"},lc=["disabled"],ic=Ie({__name:"TaskDetailModal",props:{modelValue:{type:Boolean},task:{}},emits:["update:modelValue","save"],setup(T,{emit:t}){const n=T,c=t,m=S(!1),b=S([]),d=S({cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""});xe(async()=>{try{const a=await je.getAllPlanTemplates();a&&a.templates&&(b.value=a.templates.map($=>({id:$.id,name:$.title||"Unnamed Template"})))}catch(a){console.error("Failed to get template list:",a)}});const L=a=>{a.target===a.currentTarget&&c("update:modelValue",!1)},y=()=>{d.value.linkTemplate=!1,d.value.templateId="",d.value.planTemplateId=""},M=()=>d.value.cronName.trim()?d.value.cronTime.trim()?Ue.validateCronExpression(d.value.cronTime)?d.value.planDesc.trim()?d.value.linkTemplate&&!d.value.templateId?(alert("Please select a plan template"),!1):!0:(alert("Task description cannot be empty"),!1):(alert("Invalid Cron expression format, should be 5-6 parts separated by spaces"),!1):(alert("Cron expression cannot be empty"),!1):(alert("Task name cannot be empty"),!1),G=a=>Ue.formatTime(a),q=async()=>{var a;if(M()){m.value=!0;try{const $={...d.value,...((a=n.task)==null?void 0:a.id)!==void 0&&{id:n.task.id},cronName:d.value.cronName.trim(),cronTime:d.value.cronTime.trim(),planDesc:d.value.planDesc.trim(),status:d.value.status,planTemplateId:d.value.linkTemplate&&d.value.templateId||""};c("save",$)}finally{m.value=!1}}};return Ee(()=>n.task,a=>{if(a){const $=a.templateId||a.planTemplateId||"";d.value={cronName:a.cronName||"",cronTime:a.cronTime||"",planDesc:a.planDesc||"",status:a.status??1,linkTemplate:!!$,templateId:$,planTemplateId:$}}else d.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""}},{immediate:!0}),Ee(()=>n.modelValue,a=>{a||(d.value={cronName:"",cronTime:"",planDesc:"",status:1,linkTemplate:!1,templateId:"",planTemplateId:""})}),(a,$)=>(r(),$e(Ve,{to:"body"},[g(Le,{name:"modal"},{default:qe(()=>{var P,K,I;return[a.modelValue?(r(),p("div",{key:0,class:"modal-overlay",onClick:L},[e("div",{class:"modal-container",onClick:$[8]||($[8]=re(()=>{},["stop"]))},[e("div",Ei,[e("h3",null,s(a.$t("cronTask.taskDetail")),1),e("div",Ii,[e("div",Ti,[e("span",xi,s(a.$t("cronTask.taskStatus")),1),e("label",Di,[e("input",{type:"checkbox",checked:d.value.status===0,onChange:$[0]||($[0]=D=>d.value.status=d.value.status===0?1:0)},null,40,Ri),$[9]||($[9]=e("span",{class:"toggle-slider"},null,-1))])]),e("button",{class:"close-btn",onClick:$[1]||($[1]=D=>a.$emit("update:modelValue",!1))},[g(o(f),{icon:"carbon:close"})])])]),e("div",Mi,[e("form",{onSubmit:re(q,["prevent"]),class:"task-form"},[e("div",Ai,[e("label",Ni,s(a.$t("cronTask.taskName")),1),pe(e("input",{"onUpdate:modelValue":$[2]||($[2]=D=>d.value.cronName=D),type:"text",class:"form-input",placeholder:a.$t("cronTask.taskNamePlaceholder"),required:""},null,8,Fi),[[ve,d.value.cronName]])]),e("div",Ui,[e("label",Li,s(a.$t("cronTask.cronExpression")),1),pe(e("input",{"onUpdate:modelValue":$[3]||($[3]=D=>d.value.cronTime=D),type:"text",class:"form-input",placeholder:a.$t("cronTask.cronExpressionPlaceholder"),required:""},null,8,qi),[[ve,d.value.cronTime]]),e("div",Vi,s(a.$t("cronTask.cronExpressionHelp")),1)]),e("div",Bi,[e("label",Wi,s(a.$t("cronTask.taskDescription")),1),pe(e("textarea",{"onUpdate:modelValue":$[4]||($[4]=D=>d.value.planDesc=D),class:"form-textarea",placeholder:a.$t("cronTask.taskDescriptionPlaceholder"),rows:"4",required:""},null,8,ji),[[ve,d.value.planDesc]])]),e("div",Oi,[e("label",zi,s(a.$t("cronTask.planTemplate")),1),e("div",Hi,[e("button",{type:"button",class:ie(["template-btn",d.value.linkTemplate?"active":""]),onClick:$[5]||($[5]=D=>d.value.linkTemplate=!0)},[g(o(f),{icon:"carbon:checkmark"}),le(" "+s(a.$t("cronTask.linkTemplate")),1)],2),e("button",{type:"button",class:ie(["template-btn",d.value.linkTemplate?"":"active"]),onClick:y},[g(o(f),{icon:"carbon:close"}),le(" "+s(a.$t("cronTask.noTemplate")),1)],2)]),d.value.linkTemplate?(r(),p("div",Ji,[pe(e("select",{"onUpdate:modelValue":$[6]||($[6]=D=>d.value.templateId=D),class:"form-select"},[e("option",Gi,s(a.$t("cronTask.selectTemplate")),1),(r(!0),p(_e,null,ke(b.value,D=>(r(),p("option",{key:D.id,value:D.id},s(D.name),9,Ki))),128))],512),[[ht,d.value.templateId]]),e("div",Xi,s(a.$t("cronTask.templateHelpText")),1)])):F("",!0)]),(P=a.task)!=null&&P.createTime?(r(),p("div",Qi,[e("div",Yi,[e("span",Zi,s(a.$t("cronTask.createTime"))+":",1),e("span",ec,s(G(a.task.createTime)),1)])])):F("",!0),(K=a.task)!=null&&K.updateTime?(r(),p("div",tc,[e("div",nc,[e("span",sc,s(a.$t("cronTask.updateTime"))+":",1),e("span",oc,s(G(a.task.updateTime)),1)])])):F("",!0)],32)]),e("div",ac,[e("button",{type:"button",class:"cancel-btn",onClick:$[7]||($[7]=D=>a.$emit("update:modelValue",!1))},s(a.$t("common.cancel")),1),e("button",{type:"button",class:"save-btn",onClick:q,disabled:m.value},[m.value?(r(),$e(o(f),{key:0,icon:"carbon:loading",class:"loading-icon"})):F("",!0),le(" "+s((I=n.task)!=null&&I.id?a.$t("common.save"):a.$t("common.create")),1)],8,lc)])])])):F("",!0)]}),_:1})]))}}),cc=Te(ic,[["__scopeId","data-v-1ac463d9"]]),rc={class:"modal-header"},dc={class:"header-actions"},uc={class:"modal-content"},pc={key:0,class:"loading-container"},hc={key:1,class:"empty-container"},mc={key:2,class:"task-list"},vc=["onClick"],gc={class:"task-main"},fc={class:"task-info"},bc={class:"task-header"},$c={class:"task-name"},_c={class:"task-description"},yc={class:"task-time"},kc=["onClick"],Cc=["onClick","disabled","title"],wc=["onClick","title"],Pc={class:"dropdown-menu"},Sc=["onClick"],Ec=["onClick","disabled"],Ic=["onClick","disabled"],Tc={class:"confirm-header"},xc={class:"confirm-content"},Dc={class:"confirm-actions"},Rc=["disabled"],Mc={class:"confirm-header"},Ac={class:"confirm-content"},Nc={class:"create-options"},Fc={class:"option-content"},Uc={class:"option-title"},Lc={class:"option-desc"},qc={class:"option-content"},Vc={class:"option-title"},Bc={class:"option-desc"},Wc={class:"confirm-actions"},jc=Ie({__name:"index",props:{modelValue:{type:Boolean,required:!0}},emits:["update:modelValue"],setup(T,{emit:t}){const n=mt(),c=vt(),m=Ct(),{t:b}=Ae(),d=T,E=t,L=S([]),y=S(!1),M=S(null),G=S(null),q=S(null),a=S(null),$=S(!1),P=S(null),K=S(!1),I=S(null),D=S(!1),j=_=>{_.target===_.currentTarget&&E("update:modelValue",!1)},Q=async()=>{y.value=!0;try{L.value=await Fe.getAllCronTasks()}catch(_){console.error("Failed to load cron tasks:",_),m.error(`Failed to load tasks: ${_ instanceof Error?_.message:String(_)}`)}finally{y.value=!1}},A=async _=>{M.value=_;try{const h=L.value.find(de=>de.id===_);if(!h){console.error("Task not found:",_);return}E("update:modelValue",!1);const v=Date.now().toString();await n.push({name:"direct",params:{id:v}}),await new Promise(de=>setTimeout(de,100));const z=Ue.prepareTaskExecution(h);z.useTemplate&&z.planData?c.emitPlanExecutionRequested(z.planData):z.taskContent&&c.setTask(z.taskContent)}catch(h){console.error("Failed to execute task:",h),m.error(`Execution failed: ${h instanceof Error?h.message:String(h)}`)}finally{M.value=null}},oe=_=>{P.value={..._},$.value=!0,a.value=null},ce=async _=>{try{await Ue.saveTask(_),await Q(),$.value=!1,m.success("Task saved successfully")}catch(h){console.error("Failed to save task:",h),m.error(`Save failed: ${h instanceof Error?h.message:String(h)}`)}},x=_=>{I.value=_,K.value=!0},V=async()=>{var _;if((_=I.value)!=null&&_.id){G.value=I.value.id;try{await Ue.deleteTask(I.value.id),await Q(),K.value=!1,I.value=null,m.success("Task deleted successfully")}catch(h){console.error("Failed to delete task:",h),m.error(`Delete failed: ${h instanceof Error?h.message:String(h)}`)}finally{G.value=null}}},U=()=>{K.value=!1,I.value=null},te=_=>{a.value=a.value===_?null:_},Pe=async _=>{if(_.id){q.value=_.id;try{await Ue.toggleTaskStatus(_),await Q(),a.value=null,m.success(`Task ${_.status===0?"disabled":"enabled"} successfully`)}catch(h){console.error("Failed to toggle task status:",h),m.error(`Status toggle failed: ${h instanceof Error?h.message:String(h)}`)}finally{q.value=null}}},k=async _=>{try{await navigator.clipboard.writeText(_),m.success("Cron expression copied successfully")}catch(h){m.error(`Copy failed: ${h instanceof Error?h.message:String(h)}`)}},N=()=>{D.value=!0},X=()=>{D.value=!1;try{E("update:modelValue",!1);const _=b("cronTask.template");c.setTaskToInput(_);const h=Date.now().toString();n.push({name:"direct",params:{id:h}})}catch(_){console.error("Error in createWithJmanus:",_),m.error(`Creation failed: ${_ instanceof Error?_.message:String(_)}`)}},H=()=>{D.value=!1,P.value={cronName:"",cronTime:"",planDesc:"",status:0,planTemplateId:""},$.value=!0},R=()=>{D.value=!1},O=_=>{const h=_.target;!h.closest(".action-dropdown")&&!h.closest(".dropdown-menu")&&(a.value=null)};return xe(()=>{document.addEventListener("click",O,!0)}),De(()=>{document.removeEventListener("click",O,!0)}),Ee(()=>d.modelValue,_=>{_&&Q()}),(_,h)=>(r(),p(_e,null,[(r(),$e(Ve,{to:"body"},[g(Le,{name:"modal"},{default:qe(()=>[T.modelValue?(r(),p("div",{key:0,class:"modal-overlay",onClick:j},[e("div",{class:"modal-container",onClick:h[3]||(h[3]=re(()=>{},["stop"]))},[e("div",rc,[e("h3",null,s(_.$t("cronTask.title")),1),e("div",dc,[e("button",{class:"add-task-btn",onClick:[N,h[0]||(h[0]=re(()=>{},["stop"]))]},[g(o(f),{icon:"carbon:add"}),le(" "+s(_.$t("cronTask.addTask")),1)]),e("button",{class:"close-btn",onClick:h[1]||(h[1]=v=>_.$emit("update:modelValue",!1))},[g(o(f),{icon:"carbon:close"})])])]),e("div",uc,[y.value?(r(),p("div",pc,[g(o(f),{icon:"carbon:loading",class:"loading-icon"}),e("span",null,s(_.$t("common.loading")),1)])):L.value.length===0?(r(),p("div",hc,[g(o(f),{icon:"carbon:time",class:"empty-icon"}),e("span",null,s(_.$t("cronTask.noTasks")),1)])):(r(),p("div",mc,[(r(!0),p(_e,null,ke(L.value,v=>(r(),p("div",{key:v.id||"",class:"task-item",onClick:z=>oe(v)},[e("div",gc,[e("div",fc,[e("div",bc,[e("div",$c,s(v.cronName),1),e("div",{class:ie(["task-status-badge",v.status===0?"active":"inactive"])},[g(o(f),{icon:v.status===0?"carbon:checkmark-filled":"carbon:pause-filled"},null,8,["icon"]),e("span",null,s(v.status===0?_.$t("cronTask.active"):_.$t("cronTask.inactive")),1)],2)]),e("div",_c,s(v.planDesc),1),e("div",yc,[g(o(f),{icon:"carbon:time"}),e("span",{class:"cron-readable",style:{cursor:"pointer"},onClick:re(z=>k(v.cronTime),["stop"])},s(v.cronTime),9,kc)])])]),e("div",{class:"task-actions",onClick:h[2]||(h[2]=re(()=>{},["stop"]))},[e("button",{class:"action-btn execute-btn",onClick:z=>A(v.id),disabled:M.value===v.id,title:_.$t("cronTask.executeOnce")},[g(o(f),{icon:M.value===v.id?"carbon:loading":"carbon:play-filled"},null,8,["icon"]),le(" "+s(_.$t("cronTask.executeOnce")),1)],8,Cc),e("div",{class:ie(["action-dropdown",{active:a.value===v.id}])},[e("button",{class:"action-btn dropdown-btn",onClick:z=>te(v.id),title:_.$t("cronTask.operations")},[g(o(f),{icon:"carbon:overflow-menu-horizontal"}),le(" "+s(_.$t("cronTask.operations")),1)],8,wc),pe(e("div",Pc,[e("button",{class:"dropdown-item edit-btn",onClick:z=>oe(v)},[g(o(f),{icon:"carbon:edit"}),le(" "+s(_.$t("cronTask.edit")),1)],8,Sc),e("button",{class:"dropdown-item toggle-btn",onClick:z=>Pe(v),disabled:q.value===v.id},[g(o(f),{icon:q.value===v.id?"carbon:loading":v.status===0?"carbon:pause-filled":"carbon:play-filled"},null,8,["icon"]),le(" "+s(v.status===0?_.$t("cronTask.disable"):_.$t("cronTask.enable")),1)],8,Ec),e("button",{class:"dropdown-item delete-btn",onClick:z=>x(v),disabled:G.value===v.id},[g(o(f),{icon:G.value===v.id?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),le(" "+s(_.$t("cronTask.delete")),1)],8,Ic)],512),[[$t,a.value===v.id]])],2)])],8,vc))),128))]))])])])):F("",!0)]),_:1})])),g(cc,{modelValue:$.value,"onUpdate:modelValue":h[4]||(h[4]=v=>$.value=v),task:P.value,onSave:ce},null,8,["modelValue","task"]),(r(),$e(Ve,{to:"body"},[g(Le,{name:"modal"},{default:qe(()=>{var v,z,de,fe;return[K.value?(r(),p("div",{key:0,class:"modal-overlay",onClick:U},[e("div",{class:"confirm-modal",onClick:h[5]||(h[5]=re(()=>{},["stop"]))},[e("div",Tc,[g(o(f),{icon:"carbon:warning",class:"warning-icon"}),e("h3",null,s(_.$t("cronTask.deleteConfirm")),1)]),e("div",xc,[e("p",null,s(_.$t("cronTask.deleteConfirmMessage",{taskName:((v=I.value)==null?void 0:v.cronName)||((z=I.value)==null?void 0:z.planDesc)||""})),1)]),e("div",Dc,[e("button",{class:"confirm-btn cancel-btn",onClick:U},s(_.$t("common.cancel")),1),e("button",{class:"confirm-btn delete-btn",onClick:V,disabled:G.value===((de=I.value)==null?void 0:de.id)},[g(o(f),{icon:G.value===((fe=I.value)==null?void 0:fe.id)?"carbon:loading":"carbon:trash-can"},null,8,["icon"]),le(" "+s(_.$t("cronTask.delete")),1)],8,Rc)])])])):F("",!0)]}),_:1})])),(r(),$e(Ve,{to:"body"},[g(Le,{name:"modal"},{default:qe(()=>[D.value?(r(),p("div",{key:0,class:"modal-overlay",onClick:R},[e("div",{class:"confirm-modal create-options-modal",onClick:h[6]||(h[6]=re(()=>{},["stop"]))},[e("div",Mc,[g(o(f),{icon:"carbon:time",class:"create-icon"}),e("h3",null,s(_.$t("cronTask.createTask")),1)]),e("div",Ac,[e("p",null,s(_.$t("cronTask.selectCreateMethod")),1),e("div",Nc,[e("button",{class:"create-option-btn jmanus-btn",onClick:X},[g(o(f),{icon:"carbon:ai-status"}),e("div",Fc,[e("span",Uc,s(_.$t("cronTask.createWithJmanus")),1),e("span",Lc,s(_.$t("cronTask.createWithJmanusDesc")),1)])]),e("button",{class:"create-option-btn manual-btn",onClick:H},[g(o(f),{icon:"carbon:edit"}),e("div",qc,[e("span",Vc,s(_.$t("cronTask.createManually")),1),e("span",Bc,s(_.$t("cronTask.createManuallyDesc")),1)])])])]),e("div",Wc,[e("button",{class:"confirm-btn cancel-btn",onClick:R},s(_.$t("common.cancel")),1)])])])):F("",!0)]),_:1})]))],64))}}),Oc=Te(jc,[["__scopeId","data-v-848c7703"]]),zc={class:"direct-page"},Hc={class:"direct-chat"},Jc={class:"chat-header"},Gc={class:"header-actions"},Kc=["title"],Xc=["title"],Qc=["title"],Yc=["title"],Zc={class:"chat-content"},er=["title"],tr={class:"message-content"},nr=Ie({__name:"index",setup(T){const t=_t(),n=mt(),c=vt(),{t:m}=Ae(),{message:b}=wt(),d=S(""),E=S(""),L=S(),y=S(),M=S(),G=S(!1),q=S(!1),a=S(null),$=S(!1),P=S(50),K=S(!1),I=S(0),D=S(0);xe(()=>{if(console.log("[Direct] onMounted called"),console.log("[Direct] taskStore.currentTask:",c.currentTask),console.log("[Direct] taskStore.hasUnprocessedTask():",c.hasUnprocessedTask()),ye.setEventCallbacks({onPlanUpdate:v=>{console.log("[Direct] Plan update event received for rootPlanId:",v),ce(v)&&(console.log("[Direct] Processing plan update for current rootPlanId:",v),y.value&&typeof y.value.handlePlanUpdate=="function"?(console.log("[Direct] Calling chatRef.handlePlanUpdate with rootPlanId:",v),y.value.handlePlanUpdate(v)):console.warn("[Direct] chatRef.handlePlanUpdate method not available"),L.value&&typeof L.value.updateDisplayedPlanProgress=="function"?(console.log("[Direct] Calling rightPanelRef.updateDisplayedPlanProgress with rootPlanId:",v),L.value.updateDisplayedPlanProgress(v)):console.warn("[Direct] rightPanelRef.updateDisplayedPlanProgress method not available"))},onPlanCompleted:v=>{if(console.log("[Direct] Plan completed event received for rootPlanId:",v),!!ce(v)){if(console.log("[Direct] Processing plan completion for current rootPlanId:",v),y.value&&typeof y.value.handlePlanCompleted=="function"){const z=ye.getCachedPlanRecord(v);console.log("[Direct] Calling chatRef.handlePlanCompleted with details:",z),y.value.handlePlanCompleted(z??{planId:v})}else console.warn("[Direct] chatRef.handlePlanCompleted method not available");a.value=null,console.log("[Direct] Cleared currentRootPlanId after plan completion")}},onDialogRoundStart:v=>{console.log("[Direct] Dialog round start event received for rootPlanId:",v),a.value=v,console.log("[Direct] Set currentRootPlanId to:",v),y.value&&typeof y.value.handleDialogRoundStart=="function"?(console.log("[Direct] Calling chatRef.handleDialogRoundStart with planId:",v),y.value.handleDialogRoundStart(v)):console.warn("[Direct] chatRef.handleDialogRoundStart method not available")},onChatInputClear:()=>{console.log("[Direct] Chat input clear event received"),V()},onChatInputUpdateState:v=>{if(console.log("[Direct] Chat input update state event received for rootPlanId:",v),!ce(v,!0))return;const z=ye.getCachedUIState(v);z&&te(z.enabled,z.placeholder)},onPlanError:v=>{y.value.handlePlanError(v)}}),console.log("[Direct] Event callbacks registered to planExecutionManager"),w.loadPlanTemplateList(),c.hasUnprocessedTask()&&c.currentTask){const v=c.currentTask.prompt;console.log("[Direct] Found unprocessed task from store:",v),c.markTaskAsProcessed(),ge(()=>{y.value&&typeof y.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing task via chatRef.handleSendMessage:",v),y.value.handleSendMessage({input:v})):(console.warn("[Direct] chatRef.handleSendMessage method not available, falling back to prompt"),d.value=v)})}else{const v=c.getAndClearTaskToInput();v?(E.value=v,console.log("[Direct] Setting inputOnlyContent for input only:",E.value)):(d.value=t.query.prompt||"",console.log("[Direct] Received task from URL:",d.value),console.log("[Direct] No unprocessed task in store"))}const h=localStorage.getItem("directPanelWidth");h&&(P.value=parseFloat(h)),console.log("[Direct] Final prompt value:",d.value),E.value&&ge(()=>{M.value&&typeof M.value.setInputValue=="function"&&(M.value.setInputValue(E.value),console.log("[Direct] Set input value:",E.value),E.value="")}),window.addEventListener("plan-execution-requested",v=>{console.log("[DirectView] Received plan-execution-requested event:",v.detail),R(v.detail)})}),Ee(()=>c.currentTask,h=>{if(console.log("[Direct] Watch taskStore.currentTask triggered, newTask:",h),h&&!h.processed){const v=h.prompt;c.markTaskAsProcessed(),console.log("[Direct] Received new task from store:",v),ge(()=>{y.value&&typeof y.value.handleSendMessage=="function"?(console.log("[Direct] Directly executing new task via chatRef.handleSendMessage:",v),y.value.handleSendMessage(v)):console.warn("[Direct] chatRef.handleSendMessage method not available for new task")})}else console.log("[Direct] Task is null or already processed, ignoring")},{immediate:!1}),Ee(()=>d.value,(h,v)=>{console.log("[Direct] prompt value changed from:",v,"to:",h)},{immediate:!1}),Ee(()=>c.taskToInput,h=>{console.log("[Direct] Watch taskStore.taskToInput triggered, newTaskToInput:",h),h&&h.trim()&&(console.log("[Direct] Setting input value from taskToInput:",h),ge(()=>{M.value&&typeof M.value.setInputValue=="function"&&(M.value.setInputValue(h.trim()),console.log("[Direct] Input value set from taskToInput watch:",h.trim()),c.getAndClearTaskToInput())}))},{immediate:!1}),De(()=>{console.log("[Direct] onUnmounted called, cleaning up resources"),a.value=null,ye.cleanup(),document.removeEventListener("mousemove",Q),document.removeEventListener("mouseup",A),window.removeEventListener("plan-execution-requested",h=>{R(h.detail)})});const j=h=>{K.value=!0,I.value=h.clientX,D.value=P.value,document.addEventListener("mousemove",Q),document.addEventListener("mouseup",A),document.body.style.cursor="col-resize",document.body.style.userSelect="none",h.preventDefault()},Q=h=>{if(!K.value)return;const v=window.innerWidth,de=(h.clientX-I.value)/v*100;let fe=D.value+de;fe=Math.max(20,Math.min(80,fe)),P.value=fe},A=()=>{K.value=!1,document.removeEventListener("mousemove",Q),document.removeEventListener("mouseup",A),document.body.style.cursor="",document.body.style.userSelect="",localStorage.setItem("directPanelWidth",P.value.toString())},oe=()=>{P.value=50,localStorage.setItem("directPanelWidth","50")},ce=(h,v=!1)=>!a.value||h===a.value||v&&(h==="ui-state"||h==="error")?!0:(console.log("[Direct] Ignoring event for non-current rootPlanId:",h,"current:",a.value),!1),x=h=>{console.log("[DirectView] Send message from input:",JSON.stringify(h)),y.value&&typeof y.value.handleSendMessage=="function"?(console.log("[DirectView] Calling chatRef.handleSendMessage:",JSON.stringify(h)),y.value.handleSendMessage(h)):console.warn("[DirectView] chatRef.handleSendMessage method not available")},V=()=>{console.log("[DirectView] Input cleared"),M.value&&typeof M.value.clear=="function"&&M.value.clear()},U=()=>{console.log("[DirectView] Input focused")},te=(h,v)=>{console.log("[DirectView] Input state updated:",h,v),q.value=!h},Pe=(h,v)=>{console.log("[DirectView] Step selected:",h,v),L.value&&typeof L.value.handleStepSelected=="function"?(console.log("[DirectView] Forwarding step selection to right panel:",h,v),L.value.handleStepSelected(h,v)):console.warn("[DirectView] rightPanelRef.handleStepSelected method not available")},k=(h,v,z,de)=>{console.log("[DirectView] Sub plan step selected:",{parentPlanId:h,subPlanId:v,stepIndex:z,subStepIndex:de}),L.value&&typeof L.value.handleSubPlanStepSelected=="function"?(console.log("[DirectView] Forwarding sub plan step selection to right panel:",{parentPlanId:h,subPlanId:v,stepIndex:z,subStepIndex:de}),L.value.handleSubPlanStepSelected(h,v,z,de)):console.warn("[DirectView] rightPanelRef.handleSubPlanStepSelected method not available")},N=()=>{console.log("[DirectView] Plan mode button clicked"),w.toggleSidebar(),console.log("[DirectView] Sidebar toggled, isCollapsed:",w.isCollapsed)},X=()=>{n.push("/home")},H=()=>{n.push("/configs")},R=async h=>{var z,de,fe,be;if(console.log("[DirectView] Plan execution requested:",h),G.value){console.log("[DirectView] Plan execution already in progress, ignoring request");return}G.value=!0;let v=!1;y.value&&typeof y.value.addMessage=="function"?(console.log("[DirectView] Calling chatRef.addMessage for plan execution:",h.title),y.value.addMessage("user",h.title),v=!0):console.warn("[DirectView] chatRef.addMessage method not available");try{const i=((z=h.planData)==null?void 0:z.planTemplateId)||((de=h.planData)==null?void 0:de.id)||((fe=h.planData)==null?void 0:fe.planId);if(!i)throw new Error(m("direct.planTemplateIdNotFound"));console.log("[Direct] Executing plan with templateId:",i,"params:",h.params),console.log("[Direct] About to call PlanActApiService.executePlan");let l;if((be=h.params)!=null&&be.trim()?(console.log("[Direct] Calling executePlan with params:",h.params.trim()),l=await je.executePlan(i,h.params.trim())):(console.log("[Direct] Calling executePlan without params"),l=await je.executePlan(i)),console.log("[Direct] Plan execution API response:",l),l.planId)console.log("[Direct] Got planId from response:",l.planId,"starting plan execution"),a.value=l.planId,console.log("[Direct] Set currentRootPlanId to:",l.planId),console.log("[Direct] Delegating plan execution to planExecutionManager"),ye.handlePlanExecutionRequested(l.planId,h.title);else throw console.error("[Direct] No planId in response:",l),new Error(m("direct.executionFailedNoPlanId"))}catch(i){console.error("[Direct] Plan execution failed:",i),console.error("[Direct] Error details:",{message:i.message,stack:i.stack}),a.value=null,y.value&&typeof y.value.addMessage=="function"?(console.log("[Direct] Adding error messages to chat"),v||y.value.addMessage("user",h.title),y.value.addMessage("assistant",`${m("direct.executionFailed")}: ${i.message||m("common.unknownError")}`,{thinking:void 0})):(console.error("[Direct] Chat ref not available, showing alert"),alert(`${m("direct.executionFailed")}: ${i.message||m("common.unknownError")}`))}finally{console.log("[Direct] Plan execution finished, resetting isExecutingPlan flag"),G.value=!1}},O=()=>{y.value.showMemory()},_=()=>{Se.clearMemoryId(),y.value.newChat()};return(h,v)=>(r(),p("div",zc,[e("div",Hc,[g(Pn,{onPlanExecutionRequested:R}),e("div",{class:"left-panel",style:We({width:P.value+"%"})},[e("div",Jc,[e("button",{class:"back-button",onClick:X},[g(o(f),{icon:"carbon:arrow-left"})]),e("h2",null,s(h.$t("conversation")),1),e("div",Gc,[g(kt),e("button",{class:"config-button",onClick:_,title:h.$t("memory.newChat")},[g(o(f),{icon:"carbon:add",width:"20"})],8,Kc),e("button",{class:"config-button",onClick:H,title:h.$t("direct.configuration")},[g(o(f),{icon:"carbon:settings-adjust",width:"20"})],8,Xc),e("button",{class:"cron-task-btn",onClick:v[0]||(v[0]=z=>$.value=!0),title:h.$t("cronTask.title")},[g(o(f),{icon:"carbon:alarm",width:"20"})],8,Qc),e("button",{class:"cron-task-btn",onClick:v[1]||(v[1]=z=>o(Se).toggleSidebar()),title:h.$t("memory.selectMemory")},[g(o(f),{icon:"carbon:calendar",width:"20"})],8,Yc)])]),e("div",Zc,[g(bi,{ref_key:"chatRef",ref:y,mode:"direct","initial-prompt":d.value||"",onStepSelected:Pe,onSubPlanStepSelected:k},null,8,["initial-prompt"])]),(r(),$e(Si,{key:h.$i18n.locale,ref_key:"inputRef",ref:M,disabled:q.value,placeholder:q.value?o(m)("input.waiting"):o(m)("input.placeholder"),"initial-value":d.value,onSend:x,onClear:V,onFocus:U,onUpdateState:te,onPlanModeClicked:N},null,8,["disabled","placeholder","initial-value"]))],4),e("div",{class:"panel-resizer",onMousedown:j,onDblclick:oe,title:h.$t("direct.panelResizeHint")},v[3]||(v[3]=[e("div",{class:"resizer-line"},null,-1)]),40,er),g(Ta,{ref_key:"rightPanelRef",ref:L,style:We({width:100-P.value+"%"}),"current-root-plan-id":a.value},null,8,["style","current-root-plan-id"])]),g(Oc,{modelValue:$.value,"onUpdate:modelValue":v[2]||(v[2]=z=>$.value=z)},null,8,["modelValue"]),g(_s,{onMemorySelected:O}),o(b).show?(r(),p("div",{key:0,class:ie(["message-toast",o(b).type])},[e("div",tr,[e("span",null,s(o(b).text),1)])],2)):F("",!0)]))}}),dr=Te(nr,[["__scopeId","data-v-f8c58ba6"]]);export{dr as default};
