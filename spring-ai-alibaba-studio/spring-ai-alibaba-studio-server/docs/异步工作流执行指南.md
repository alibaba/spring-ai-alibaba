# 异步工作流执行指南

## 概述

本文档介绍了基于 RocketMQ 的异步工作流执行功能，该功能通过消息队列实现节点间的通知机制，有效减少线程损耗，提高系统性能。

## 架构设计

### 核心组件

1. **AsyncWorkflowExecuteManager**: 异步工作流执行管理器
2. **WorkflowExecuteManager**: 原有同步执行管理器（已扩展异步方法）
3. **RocketMQ**: 消息队列中间件
4. **ApplicationContextProvider**: Spring上下文提供者

### 消息流程

```
工作流启动 → 发送节点执行消息 → 消费者处理节点 → 节点完成 → 发送下一个节点消息 → 任务完成
```

## 使用方法

### 1. 基本异步执行

```java
@Autowired
private WorkflowExecuteManager workflowExecuteManager;

// 异步执行工作流
public String executeWorkflowAsync(WorkflowContext context) {
    return workflowExecuteManager.asyncExecute(context);
}
```

### 2. 多种执行方式

```java
// 方式1: 使用WorkflowContext
String taskId1 = workflowExecuteManager.asyncExecute(workflowContext);

// 方式2: 使用WorkflowConfig
String taskId2 = workflowExecuteManager.asyncExecute(workflowConfig, workflowContext);

// 方式3: 使用JSON配置字符串
String taskId3 = workflowExecuteManager.asyncExecute(configJson, workflowContext);

// 方式4: 使用ApplicationVersion
String taskId4 = workflowExecuteManager.asyncExecute(applicationVersion, workflowContext);
```

### 3. 直接使用异步执行管理器

```java
@Autowired
private AsyncWorkflowExecuteManager asyncWorkflowExecuteManager;

public String executeWorkflowAsync(WorkflowConfig config, WorkflowContext context) {
    return asyncWorkflowExecuteManager.asyncExecute(config, context);
}
```

## 配置说明

### RocketMQ 配置

在 `application.yml` 中配置 RocketMQ：

```yaml
rocketmq:
  endpoints: 127.0.0.1:18080
  max-attempts: 1
  send-message-timeout-ms: 3000
  max-cache-message-count: 1024
  max-cache-message-size-in-bytes: 67108864
  consumption-thread-count: 20
```

### 消息主题配置

系统会自动创建以下消息主题：

- `workflow_node_execution`: 节点执行消息主题
- `workflow_task_monitor`: 任务监控消息主题

## 核心特性

### 1. 消息驱动的节点执行

- 节点执行通过 RocketMQ 消息触发
- 支持节点间的依赖关系检查
- 自动处理节点执行顺序

### 2. 任务状态管理

- 实时跟踪任务执行状态
- 支持任务超时和错误处理
- 自动清理已完成的任务状态

### 3. 流式输出支持

- 支持 LLM 和 Component 节点的流式输出
- 实时更新节点执行结果
- 保持与同步执行相同的功能

### 4. 错误处理

- 节点执行失败时自动标记任务状态
- 支持任务手动终止
- 详细的错误日志记录

## 性能优势

### 1. 减少线程损耗

- 使用消息队列替代线程池轮询
- 节点执行按需触发，避免空闲线程
- 更好的资源利用率

### 2. 提高并发能力

- 支持更多并发任务
- 节点执行解耦，提高系统稳定性
- 更好的扩展性

### 3. 降低系统负载

- 减少 CPU 和内存占用
- 避免线程竞争和锁等待
- 更平滑的性能表现

## 监控和调试

### 1. 日志监控

```java
// 节点执行日志
log.info("Executing node: taskId={}, nodeId={}, nodeType={}", 
        context.getTaskId(), nodeId, nodeResult.getNodeType());

// 消息发送日志
log.info("Sent node execution message: taskId={}, nodeId={}, action={}, messageId={}", 
        taskId, nodeId, action, result.getMessageId());
```

### 2. 任务状态查询

```java
// 获取任务状态
WorkflowContext context = redisManager.get(
    WORKFLOW_TASK_CONTEXT_PREFIX + workspaceId + "_" + taskId
);
String taskStatus = context.getTaskStatus();
```

### 3. 性能监控

系统会自动记录以下监控指标：

- 任务执行时间
- 节点执行成功率
- 消息处理延迟
- 系统资源使用情况

## 注意事项

### 1. 依赖要求

- 确保 RocketMQ 服务正常运行
- 检查网络连接和端口配置
- 验证消息主题和消费者组配置

### 2. 错误处理

- 消息发送失败时会记录错误日志
- 节点执行异常会标记任务为失败状态
- 建议实现重试机制处理临时错误

### 3. 资源管理

- 定期清理过期的任务状态
- 监控消息队列的积压情况
- 合理配置消费者线程数

## 迁移指南

### 从同步执行迁移到异步执行

1. **代码修改**

```java
// 原有同步执行
String taskId = workflowExecuteManager.execute(context);

// 修改为异步执行
String taskId = workflowExecuteManager.asyncExecute(context);
```

2. **配置更新**

- 添加 RocketMQ 配置
- 确保消息主题可用
- 验证消费者组配置

3. **测试验证**

- 执行功能测试
- 验证性能提升
- 检查错误处理

## 故障排除

### 常见问题

1. **消息发送失败**
   - 检查 RocketMQ 连接
   - 验证主题配置
   - 查看网络状态

2. **节点执行卡住**
   - 检查节点依赖关系
   - 验证前置节点状态
   - 查看错误日志

3. **任务状态异常**
   - 检查 Redis 连接
   - 验证缓存配置
   - 查看任务日志

### 调试工具

1. **RocketMQ 控制台**
   - 查看消息发送状态
   - 监控消费者状态
   - 检查主题配置

2. **Redis 监控**
   - 查看任务状态缓存
   - 监控内存使用
   - 检查连接状态

3. **应用日志**
   - 查看详细执行日志
   - 监控错误信息
   - 分析性能指标

## 总结

异步工作流执行功能通过 RocketMQ 消息队列实现了节点间的解耦，显著提升了系统性能和并发能力。该功能保持了与原有同步执行相同的功能特性，同时提供了更好的资源利用率和扩展性。

建议在生产环境中逐步迁移到异步执行模式，并根据实际负载情况调整配置参数。 